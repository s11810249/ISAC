<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>網站後台管理系統 | 東海大學實習中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002147',
                        thuLightBlue: '#eef6fc',
                        thuGold: '#997933',
                        darkBg: '#0f172a',
                        btnGreen: '#219653',
                        btnGreenHover: '#1e874b',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #002147 0%, #001a35 100%); position: relative; overflow: hidden; }
        .login-bg::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px); background-size: 30px 30px; z-index: 1; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        .animate-fade-out { animation: fadeOut 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; pointer-events: none; } }
        .sortable-ghost { opacity: 0.4; background: #eef6fc; border: 2px dashed #002147; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        .sidebar-btn { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 8px; transition: all 0.2s; cursor: pointer; color: #4b5563; font-weight: 500; }
        .sidebar-btn:hover { background-color: #f3f4f6; color: #002147; }
        .sidebar-btn.active { background-color: #002147; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .sidebar-btn.active i { color: #997933; }
        .color-preview-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .file-upload-label { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; border-radius: 0.375rem; background-color: #f3f4f6; color: #6b7280; transition: all 0.2s; border: 1px solid #e5e7eb; }
        .file-upload-label:hover { background-color: #e5e7eb; color: #002147; border-color: #d1d5db; }
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; opacity: 0; overflow: hidden; }
        .accordion-content.open { max-height: 2000px; opacity: 1; }
        .accordion-arrow { transition: transform 0.3s ease; }
        .accordion-arrow.rotate { transform: rotate(180deg); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-700 font-sans">

    <input type="file" id="global-file-input" class="hidden" onchange="handleFileUpload(this)">

    <div id="msg-modal" class="fixed inset-0 z-[200] flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative z-10 mx-4 transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="text-center mb-6">
                <div id="msg-icon" class="w-14 h-14 rounded-full flex items-center justify-center text-2xl mx-auto mb-4"></div>
                <h3 id="msg-title" class="text-lg font-bold text-gray-800 mb-2"></h3>
                <p id="msg-body" class="text-gray-600 text-sm leading-relaxed"></p>
                <div id="msg-input-container" class="hidden mt-4">
                    <input type="text" id="msg-input" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-thuBlue outline-none" placeholder="">
                </div>
            </div>
            <div class="flex flex-col gap-2" id="msg-actions"></div>
        </div>
    </div>

    <div id="create-page-modal" class="fixed inset-0 z-[150] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-gray-900/60 backdrop-blur-sm"></div>
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full relative z-10 mx-4 animate-fade-in-up">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-thuBlue"><i class="fas fa-plus-circle mr-2"></i>新增分頁</h3>
                <button onclick="closeCreatePageModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="space-y-5">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">分頁名稱 (Title)</label>
                    <input type="text" id="new-page-title" class="w-full border border-gray-300 rounded p-3 text-sm focus:ring-2 focus:ring-thuBlue outline-none" placeholder="例如：實習相關法規">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">網址路徑 (Filename)</label>
                    <div class="flex items-center">
                        <input type="text" id="new-page-id" class="flex-grow border border-gray-300 rounded-l p-3 text-sm focus:ring-2 focus:ring-thuBlue outline-none font-mono" placeholder="laws">
                        <span class="bg-gray-100 border border-l-0 border-gray-300 text-gray-500 p-3 rounded-r text-sm font-mono">.html</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">系統將自動產生同名的 .html 檔案與 pages/data_{name}.json 資料檔。</p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">選擇模板 (Template)</label>
                    <div id="template-options" class="grid grid-cols-1 gap-3 max-h-60 overflow-y-auto pr-1">
                        </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button onclick="confirmCreatePage()" class="flex-1 bg-thuBlue hover:bg-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition-all">建立頁面</button>
                    <button onclick="closeCreatePageModal()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-lg transition-all">取消</button>
                </div>
            </div>
        </div>
    </div>

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl shadow-2xl relative z-10 animate-fade-in-up">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-thuBlue text-white rounded-xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg"><i class="fas fa-tools"></i></div>
                <h1 class="text-2xl font-bold text-thuBlue tracking-wide">後台管理系統</h1>
                <p class="text-gray-500 text-sm mt-1">實習業務協作平台 | GitHub CMS</p>
            </div>
            <div class="space-y-5">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">GitHub Username</label><input type="text" id="gh-owner" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-thuBlue outline-none transition text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Repository Name</label><input type="text" id="gh-repo" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-thuBlue outline-none transition text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 ml-1">Access Token</label><div class="relative"><input type="password" id="gh-token" class="w-full pl-10 pr-10 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-thuBlue outline-none transition text-sm"><button onclick="toggleTokenVisibility()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none"><i class="fas fa-eye" id="token-eye-icon"></i></button></div></div>
                <div class="pt-2"><button onclick="loadData()" id="load-btn" class="w-full bg-thuBlue hover:bg-blue-800 text-white font-bold py-3.5 rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 transform active:scale-95 flex justify-center items-center gap-2 group"><span>登入並讀取資料</span><i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i></button><div id="login-msg" class="text-center mt-3 h-5 text-sm font-medium text-red-500"></div></div>
            </div>
        </div>
        <div class="absolute bottom-4 text-white/30 text-xs">Powered by GitHub API | Secure Connection</div>
    </div>

    <div id="dashboard-ui" class="hidden min-h-screen flex flex-col transition-opacity duration-500 opacity-0">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-thuBlue text-white rounded flex items-center justify-center text-sm"><i class="fas fa-tools"></i></div>
                        <span class="font-bold text-gray-800 text-lg tracking-wide">後台管理系統</span>
                        <span class="hidden sm:inline-block px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-500 border border-gray-200" id="current-repo-label">載入中...</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <div id="save-status" class="text-sm font-bold text-gray-600 transition-opacity opacity-0 mr-2"></div>
                        <button onclick="saveData()" id="save-btn" class="bg-thuBlue hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 transform active:scale-95 transition-all text-sm">
                            <i class="fas fa-cloud-upload-alt"></i> 儲存並發布
                        </button>
                        <div class="h-6 w-px bg-gray-300 mx-1"></div>
                        <button onclick="logout()" class="text-sm text-red-500 hover:text-red-700 font-medium transition flex items-center gap-1 border border-red-100 bg-red-50 px-3 py-2 rounded-lg hover:bg-red-100"><i class="fas fa-sign-out-alt"></i> 登出</button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow bg-gray-50/50 pb-20">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden min-h-[600px] flex flex-col">
                    <div class="flex border-b border-gray-200 bg-gray-50/80 overflow-x-auto">
                        <button onclick="switchTab('cards')" class="tab-btn px-6 py-4 text-sm font-bold text-thuBlue border-b-2 border-thuBlue bg-white focus:outline-none whitespace-nowrap transition-colors" data-tab="cards"><i class="fas fa-th-large mr-2"></i>首頁卡片</button>
                        <button onclick="switchTab('contacts')" class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-100 focus:outline-none whitespace-nowrap transition-colors" data-tab="contacts"><i class="fas fa-address-book mr-2"></i>聯絡資訊</button>
                        <button onclick="switchTab('pages')" class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-100 focus:outline-none whitespace-nowrap transition-colors" data-tab="pages"><i class="fas fa-file-alt mr-2"></i>分頁內容</button>
                        <button onclick="switchTab('news')" class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-100 focus:outline-none whitespace-nowrap transition-colors" data-tab="news"><i class="fas fa-bullhorn mr-2"></i>最新公告</button>
                        <button onclick="switchTab('colors')" class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-100 focus:outline-none whitespace-nowrap transition-colors" data-tab="colors"><i class="fas fa-palette mr-2"></i>顏色管理</button>
                        <button onclick="switchTab('settings')" class="tab-btn px-6 py-4 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:bg-gray-100 focus:outline-none whitespace-nowrap transition-colors" data-tab="settings"><i class="fas fa-sliders-h mr-2"></i>網站設定</button>
                    </div>

                    <div class="p-6 md:p-8 flex-grow relative">
                        <div id="tab-cards" class="tab-content block animate-fade-in-up">
                            <div class="flex items-center justify-between mb-6 pb-2 border-b border-gray-100">
                                <div><h3 class="text-lg font-bold text-gray-800">首頁功能卡片管理</h3><p class="text-sm text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i> 按住卡片上方標題列（握把）即可拖曳。</p></div>
                                <button onclick="addCardItem()" class="bg-btnGreen text-white border border-btnGreen hover:bg-btnGreenHover hover:border-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 text-sm tracking-wide"><i class="fas fa-plus"></i> 新增卡片</button>
                            </div>
                            <div id="cards-list-editor" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                        </div>

                        <div id="tab-contacts" class="tab-content hidden animate-fade-in-up">
                            <div class="mb-10">
                                <div class="flex items-center gap-2 mb-4"><div class="w-1 h-6 bg-green-500 rounded-full"></div><h3 class="text-lg font-bold text-gray-800">單位基本資料 (固定)</h3></div>
                                <div id="office-contact-editor" class="grid grid-cols-1 lg:grid-cols-1 gap-6"></div>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4 border-b border-gray-100 pb-2">
                                    <div class="flex items-center gap-2"><div class="w-1 h-6 bg-blue-500 rounded-full"></div><h3 class="text-lg font-bold text-gray-800">團隊成員管理</h3></div>
                                    <div class="flex gap-2">
                                        <button onclick="addContactItem()" class="bg-thuBlue text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-blue-800 shadow-md transition flex items-center"><i class="fas fa-user-plus mr-1.5"></i> 新增人員</button>
                                    </div>
                                </div>
                                <div id="staff-contacts-editor" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[100px]"></div>
                            </div>
                        </div>

                        <div id="tab-colors" class="tab-content hidden animate-fade-in-up">
                             <div class="flex items-center justify-between mb-6 pb-2 border-b border-gray-100">
                                <div><h3 class="text-lg font-bold text-gray-800">網站主題顏色管理</h3><p class="text-sm text-gray-500 mt-1">在此新增或修改顏色，儲存後會同步更新至卡片與聯絡人的選項中。</p></div>
                                <button onclick="addColorItem()" class="bg-btnGreen text-white hover:bg-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 flex items-center justify-center gap-2 text-sm"><i class="fas fa-plus"></i> 新增顏色</button>
                            </div>
                            <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 mb-6">
                                <h4 class="font-bold text-thuBlue text-sm mb-2"><i class="fas fa-info-circle mr-1"></i> 使用說明</h4>
                                <ul class="list-disc list-inside text-xs text-blue-800 space-y-1">
                                    <li><strong>識別碼 (ID)：</strong> 系統內部使用的唯一代碼 (如: thu, gold)，請勿使用特殊符號或空格。</li>
                                    <li><strong>顯示名稱：</strong> 在後台選單中看到的中文名稱。</li>
                                    <li><strong>Hex 色碼：</strong> 顏色的十六進位代碼 (如: #002147)。</li>
                                </ul>
                            </div>
                            <div id="colors-list-header" class="grid grid-cols-12 gap-4 px-4 py-2 bg-gray-100 rounded-t-lg text-xs font-bold text-gray-500 uppercase tracking-wider">
                                <div class="col-span-1 text-center">預覽</div>
                                <div class="col-span-3">顯示名稱</div>
                                <div class="col-span-3">識別碼 (ID)</div>
                                <div class="col-span-3">Hex 色碼</div>
                                <div class="col-span-2 text-right">操作</div>
                            </div>
                            <div id="colors-list-editor" class="space-y-2"></div>
                        </div>

                        <div id="tab-pages" class="tab-content hidden animate-fade-in-up">
                            <div class="flex flex-col md:flex-row gap-6 h-full">
                                <div class="w-full md:w-64 shrink-0 space-y-1">
                                    <div class="flex justify-between items-center mb-2 px-1">
                                        <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">選擇編輯頁面</div>
                                    </div>
                                    <button onclick="openCreatePageModal()" class="w-full mb-3 bg-btnGreen text-white hover:bg-btnGreenHover border border-transparent rounded-lg py-2 px-3 text-sm font-bold shadow-sm flex items-center justify-center gap-2 transition-all"><i class="fas fa-plus"></i> 新增頁面</button>
                                    <div id="pages-sidebar" class="space-y-1"></div>
                                    <div class="mt-6 pt-4 border-t border-gray-100">
                                        <div class="bg-blue-50 p-4 rounded-lg"><p class="text-xs text-blue-800 font-medium mb-1"><i class="fas fa-info-circle mr-1"></i> 提示</p><p class="text-xs text-blue-600 leading-relaxed">新增頁面後，系統會自動在 pages 資料夾中建立對應的 json 檔。</p></div>
                                    </div>
                                </div>
                                <div class="flex-grow bg-white rounded-xl border border-gray-200 flex flex-col">
                                    <div class="border-b border-gray-200 bg-gray-50">
                                        <div class="p-4 px-6 flex justify-between items-center cursor-pointer hover:bg-gray-100 transition" onclick="togglePageSettings()">
                                            <h3 class="text-lg font-bold text-thuBlue flex items-center gap-2">
                                                <span id="current-page-title-display">頁面設定</span>
                                                <span id="external-badge" class="hidden text-[10px] bg-purple-100 text-purple-700 border border-purple-200 px-2 py-0.5 rounded ml-2">獨立檔案</span>
                                            </h3>
                                            <button class="text-gray-500 hover:text-thuBlue transition-colors flex items-center gap-2 bg-white border border-gray-300 px-3 py-1.5 rounded shadow-sm text-sm">
                                                設定 <i class="fas fa-chevron-down transform transition-transform duration-300" id="page-settings-arrow"></i>
                                            </button>
                                        </div>
                                        <div id="page-settings-panel" class="hidden border-t border-gray-200 p-6 bg-white animate-fade-in-up">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <div class="space-y-4">
                                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1 mb-2">基本資訊</h4>
                                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">主標題</label><input type="text" id="page-setting-title" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-thuBlue outline-none font-bold text-gray-800"></div>
                                                    <div class="flex items-end gap-2">
                                                        <div class="flex-grow"><label class="block text-xs font-bold text-gray-500 mb-1">圖示</label><input type="text" id="page-setting-icon" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-thuBlue outline-none font-mono"></div>
                                                        <div class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-thuBlue border border-gray-200 mb-0.5"><i id="page-icon-preview" class="fas fa-question"></i></div>
                                                    </div>
                                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">標籤</label><input type="text" id="page-setting-tag" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-thuBlue outline-none"></div>
                                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">副標題</label><input type="text" id="page-setting-desc" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-2 focus:ring-thuBlue outline-none"></div>
                                                    
                                                    <div class="mt-4 pt-4 border-t border-red-100">
                                                        <h4 class="text-xs font-bold text-red-400 uppercase tracking-wider mb-2">危險操作區域</h4>
                                                        <div class="flex gap-2">
                                                            <button onclick="promptRenamePage()" class="flex-1 bg-white border border-gray-300 text-gray-600 hover:text-thuBlue hover:border-thuBlue py-2 px-3 rounded text-xs font-bold transition flex items-center justify-center gap-1"><i class="fas fa-edit"></i> 變更路徑</button>
                                                            <button onclick="promptDeletePage()" class="flex-1 bg-white border border-red-200 text-red-500 hover:bg-red-50 hover:text-red-600 py-2 px-3 rounded text-xs font-bold transition flex items-center justify-center gap-1"><i class="fas fa-trash-alt"></i> 刪除此頁</button>
                                                        </div>
                                                    </div>

                                                    <div class="flex justify-end gap-2 pt-2 border-t border-gray-100 mt-2">
                                                        <button onclick="savePageHeaderSettings()" class="bg-thuBlue text-white border-2 border-thuBlue hover:bg-blue-800 hover:border-blue-800 font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 text-sm">暫存設定</button>
                                                    </div>
                                                </div>
                                                <div class="space-y-4 border-l pl-6 border-gray-100">
                                                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider border-b pb-1 mb-2">進階設定</h4>
                                                    <div id="custom-labels-config" class="mb-4">
                                                        <label class="block text-xs font-bold text-gray-500 mb-1">列表欄位名稱</label>
                                                        <div class="flex gap-2 mb-2">
                                                            <input type="text" id="page-label-title" class="w-1/2 border border-gray-300 rounded p-2 text-sm" placeholder="標題欄位">
                                                            <input type="text" id="page-label-title-en" class="w-1/2 border border-gray-300 rounded p-2 text-sm" placeholder="副標題欄位">
                                                        </div>
                                                    </div>
                                                    <div id="category-manager" class="hidden mb-4">
                                                        <label class="block text-xs font-bold text-gray-500 mb-2">分類篩選管理</label>
                                                        <div class="bg-gray-50 rounded-lg border border-gray-200 p-3">
                                                            <div id="cat-list" class="space-y-2 mb-3 max-h-[150px] overflow-y-auto"></div>
                                                            <div class="flex gap-2 border-t border-gray-200 pt-2">
                                                                <input type="text" id="new-cat-name" class="flex-grow border border-gray-300 rounded p-1.5 text-sm" placeholder="新分類...">
                                                                <button onclick="addNewCategory()" class="bg-btnGreen text-white border border-btnGreen hover:bg-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm text-sm">新增</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="file-fields-config" class="hidden">
                                                        <label class="block text-xs font-bold text-gray-500 mb-2">下載按鈕設定</label>
                                                        <div class="space-y-2 bg-gray-50 p-2 rounded border border-gray-200 text-xs">
                                                            <div id="file-config-list" class="space-y-2"></div>
                                                            <div class="flex justify-end pt-1">
                                                                <button onclick="saveFileConfigSettings()" class="bg-btnGreen text-white border border-btnGreen hover:bg-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm text-sm">更新設定</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center p-4 px-6 border-b border-gray-100 bg-white sticky top-0 z-10">
                                        <div><h3 class="text-base font-bold text-gray-800">內容列表管理</h3></div>
                                        <div class="flex gap-2 items-center">
                                            <button id="page-add-item-btn" onclick="addPageItem()" class="bg-btnGreen text-white border border-btnGreen hover:bg-btnGreenHover hover:border-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 text-sm tracking-wide"><i class="fas fa-plus"></i> 新增項目</button>
                                        </div>
                                    </div>
                                    <div id="page-items-editor" class="p-6 space-y-4 bg-gray-50/50 flex-grow overflow-y-auto max-h-[600px]"></div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-news" class="tab-content hidden animate-fade-in-up">
                            <div class="flex items-center justify-between mb-6 pb-2 border-b border-gray-100">
                                <div><h3 class="text-lg font-bold text-gray-800">公告管理</h3></div>
                                <button onclick="addNewsItem()" class="bg-btnGreen text-white border border-btnGreen hover:bg-btnGreenHover hover:border-btnGreenHover font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 flex items-center justify-center gap-2 active:scale-95 text-sm tracking-wide"><i class="fas fa-plus"></i> 新增公告</button>
                            </div>
                            <div id="news-list-editor" class="space-y-4"></div>
                        </div>

                        <div id="tab-settings" class="tab-content hidden animate-fade-in-up">
                            <div class="flex items-end justify-between mb-6 pb-2 border-b border-gray-100">
                                <div><h3 class="text-lg font-bold text-gray-800">基本資訊設定</h3><p class="text-sm text-gray-500 mt-1">此處可以修改網站標題與Logo。</p></div>
                            </div>
                            <div class="grid grid-cols-1 gap-6 pb-20 max-w-4xl">
                                <div id="settings-form" class="space-y-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Global Variables ---
        let currentData = null;
        let fileSha = null;
        const DATA_FILE = 'data.json';
        let sortableCards, sortableStaff, sortablePageItems;
        let sessionToken = ''; 
        let activePageId = 'laws'; 
        let currentUploadTargetInput = null;
        let confirmCallback = null; 

        // --- Templates Configuration ---
        const PAGE_TEMPLATES = {
            'documents_list': {
                name: '通用文件列表 (Universal Document List)',
                desc: '專為文件彙整設計的列表版型。支援多附件下載與分類篩選。',
                jsonPath: 'page_template/documents_list.json',
                htmlPath: 'page_template/documents_list.html'
            },
            'general': {
                name: '一般連結列表 (General Link List)',
                desc: '基礎列表版型，適合相關連結、課程列表等條列式內容。',
                jsonPath: 'page_template/general.json',
                htmlPath: 'page_template/general.html'
            }
        };

        const defaultColors = [
            { name: "預設藍 (Unified)", id: "thu", hex: "#002147" },
            { name: "榮耀金 (Glory Gold)", id: "glorygold", hex: "#997933" },
            { name: "東海藍 (New)", id: "thubluenew", hex: "#002147" }
        ];
        
        const settingFieldsMap = { 'SiteTitle': { label: '網站主標題 (中文)', type: 'text' }, 'SiteEngTitle': { label: '網站副標題 (英文)', type: 'text' }, 'HeroSubtitle': { label: '首頁歡迎詞', type: 'textarea' }, 'LogoUrl': { label: 'Logo 圖片連結', type: 'text' }, 'OriginTitle': { label: '計畫緣起 - 標題', type: 'text' }, 'OriginContent': { label: '計畫緣起 - 內容 (HTML)', type: 'textarea' } };

        // --- Core Functions ---
        async function loadData() {
            const owner = document.getElementById('gh-owner').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const tokenInput = document.getElementById('gh-token').value.trim();
            const msg = document.getElementById('login-msg');
            const btn = document.getElementById('load-btn');

            if (!owner || !repo || !tokenInput) { msg.innerText = "請填寫完整的連線資訊"; return; }

            sessionToken = tokenInput; 
            msg.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 連線中...'; msg.className = "text-center mt-3 h-5 text-sm font-medium text-thuBlue";
            btn.disabled = true; btn.classList.add('opacity-75', 'cursor-wait');

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/${DATA_FILE}`;
                const response = await fetch(url, { headers: { 'Authorization': `token ${sessionToken}`, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store' });
                if (!response.ok) throw new Error(response.status === 404 ? "找不到 data.json" : "連線失敗");

                const result = await response.json();
                fileSha = result.sha; 
                const decodedContent = decodeURIComponent(escape(window.atob(result.content.replace(/\n/g, ''))));
                currentData = JSON.parse(decodedContent);
                
                // Initialize checks
                if (!currentData.pages) currentData.pages = {};
                if (!currentData.colors) currentData.colors = JSON.parse(JSON.stringify(defaultColors));

                localStorage.setItem('gh_owner', owner);
                localStorage.setItem('gh_repo', repo);

                document.getElementById('current-repo-label').innerText = `${owner}/${repo}`;
                
                renderTemplateOptions(); 
                renderEditors(); 
                
                document.getElementById('login-screen').classList.add('animate-fade-out');
                const dashboard = document.getElementById('dashboard-ui');
                dashboard.classList.remove('hidden');
                setTimeout(() => { dashboard.classList.remove('opacity-0'); document.getElementById('login-screen').classList.add('hidden'); }, 400);

            } catch (error) {
                console.error(error); msg.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${error.message}`; msg.className = "text-center mt-3 h-5 text-sm font-medium text-red-500"; btn.disabled = false; btn.classList.remove('opacity-75', 'cursor-wait');
            }
        }
        
        async function fetchRepoFile(path) {
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
            
            const res = await fetch(url, { headers: { 'Authorization': `token ${sessionToken}`, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store' });
            if(!res.ok) throw new Error(`找不到檔案：${path}，請確認該檔案已存在。`);
            
            const data = await res.json();
            // 修正: 確保 UTF-8 中文解碼正確
            return decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ''))));
        }

        function renderEditors() {
            const settingsContainer = document.getElementById('settings-form');
            settingsContainer.innerHTML = '';
            for (const [key, config] of Object.entries(settingFieldsMap)) {
                let value = currentData.settings[key] || ''; 
                if (key === 'HeroSubtitle') value = value.replace(/<br\s*\/?>/gi, '\n');
                let inputHtml = config.type === 'textarea' ? 
                    `<textarea data-key="${key}" rows="3" class="setting-input w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-thuBlue outline-none text-sm font-mono">${value}</textarea>` : 
                    `<input type="text" data-key="${key}" value="${value.replace(/"/g, '&quot;')}" class="setting-input w-full border border-gray-300 rounded p-3 text-sm focus:ring-2 focus:ring-thuBlue outline-none" />`;
                settingsContainer.innerHTML += `<div class="bg-white p-5 rounded-lg border border-gray-100 shadow-sm"><label class="block text-sm font-bold text-gray-700 mb-2">${config.label}</label>${inputHtml}</div>`;
            }

            renderColorManager();
            renderCardsList();
            renderContactsList();
            renderNewsList();
            
            if (activePageId && currentData.pages[activePageId]) {
                switchPageEditor(activePageId);
            } else {
                const firstPage = Object.keys(currentData.pages)[0];
                if (firstPage) switchPageEditor(firstPage);
            }
        }

        // --- Page Management: Create, Rename, Delete ---
        function openCreatePageModal() {
            document.getElementById('new-page-title').value = '';
            document.getElementById('new-page-id').value = '';
            const radio = document.querySelector('input[name="page-template"]');
            if(radio) radio.checked = true;
            document.getElementById('create-page-modal').classList.remove('hidden');
        }
        function closeCreatePageModal() { document.getElementById('create-page-modal').classList.add('hidden'); }

        function renderTemplateOptions() {
            const container = document.getElementById('template-options');
            container.innerHTML = '';
            for (const [key, tpl] of Object.entries(PAGE_TEMPLATES)) {
                container.innerHTML += `<label class="block relative border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-thuBlue hover:bg-blue-50 transition-colors"><input type="radio" name="page-template" value="${key}" class="absolute top-4 right-4 text-thuBlue focus:ring-thuBlue"><h4 class="font-bold text-gray-800 mb-1">${tpl.name}</h4><p class="text-xs text-gray-500 leading-relaxed">${tpl.desc}</p></label>`;
            }
        }

        async function confirmCreatePage() {
            const title = document.getElementById('new-page-title').value.trim();
            let id = document.getElementById('new-page-id').value.trim().toLowerCase();
            const templateKey = document.querySelector('input[name="page-template"]:checked')?.value;

            if (!title || !id || !templateKey) { showMsg("錯誤", "請填寫完整資訊", "error"); return; }
            if (!/^[a-z0-9_]+$/.test(id)) { showMsg("錯誤", "網址路徑只能包含小寫英文、數字與底線", "error"); return; }
            if (currentData.pages[id]) { showMsg("錯誤", "此網址路徑已存在", "error"); return; }

            closeCreatePageModal();
            showMsg("處理中", "正在建立頁面，請稍候...", "info");

            const tplConfig = PAGE_TEMPLATES[templateKey];
            let newPageData, htmlContent;

            try {
                const jsonStr = await fetchRepoFile(tplConfig.jsonPath);
                newPageData = JSON.parse(jsonStr);
                newPageData.title = title;
                const htmlStr = await fetchRepoFile(tplConfig.htmlPath);
                htmlContent = htmlStr.replace(/{{PAGE_ID}}/g, id);
            } catch(e) {
                showMsg("錯誤", "讀取模板失敗: " + e.message, "error");
                return;
            }

            currentData.pages[id] = { title: title, source: `pages/data_${id}.json`, template: templateKey, tag: newPageData.tag, icon: newPageData.icon };

            try {
                await uploadFileToGitHub(`${id}.html`, htmlContent);
                await uploadFileToGitHub(`pages/data_${id}.json`, JSON.stringify(newPageData, null, 4));
                await uploadFileToGitHub(DATA_FILE, JSON.stringify(currentData, null, 4), fileSha);
                showMsg("成功", `頁面 ${title} 已建立！`, "success", () => location.reload());
            } catch (e) {
                showMsg("失敗", "建立頁面失敗: " + e.message, "error");
            }
        }

        function promptDeletePage() {
            showMsg("刪除確認", `確定要刪除 ${activePageId} 頁面嗎？這將會刪除 ${activePageId}.html 與資料檔，此操作無法復原。`, "confirm", async () => {
                showMsg("處理中", "正在刪除頁面檔案...", "info");
                try {
                    // Delete HTML & JSON
                    await deleteFileFromGitHub(`${activePageId}.html`);
                    await deleteFileFromGitHub(`pages/data_${activePageId}.json`);
                    // Update Registry
                    delete currentData.pages[activePageId];
                    await uploadFileToGitHub(DATA_FILE, JSON.stringify(currentData, null, 4), fileSha);
                    showMsg("成功", "頁面已刪除", "success", () => location.reload());
                } catch(e) {
                    showMsg("失敗", "刪除失敗: " + e.message, "error");
                }
            });
        }

        function promptRenamePage() {
            document.getElementById('msg-input-container').classList.remove('hidden');
            const input = document.getElementById('msg-input');
            input.value = activePageId;
            
            showMsg("變更路徑", "請輸入新的網址路徑 (不含 .html)：", "confirm", async () => {
                const newId = input.value.trim().toLowerCase();
                if(!newId || !/^[a-z0-9_]+$/.test(newId)) { showMsg("錯誤", "無效的路徑格式", "error"); return; }
                if(currentData.pages[newId]) { showMsg("錯誤", "此路徑已存在", "error"); return; }
                if(newId === activePageId) return;

                showMsg("處理中", "正在搬移檔案...", "info");
                try {
                    // 1. Read old contents
                    const pageConfig = currentData.pages[activePageId];
                    const oldHtml = await fetchRepoFile(`${activePageId}.html`);
                    const oldJson = await fetchRepoFile(pageConfig.source); // Should use stored source path
                    
                    // 2. Modify content for new ID
                    const newHtml = oldHtml.replace(new RegExp(`pages/data_${activePageId}.json`, 'g'), `pages/data_${newId}.json`)
                                           .replace(new RegExp(`const PAGE_ID = '${activePageId}'`, 'g'), `const PAGE_ID = '${newId}'`); // Fix HTML var if exists
                    
                    // 3. Create new files
                    await uploadFileToGitHub(`${newId}.html`, newHtml);
                    await uploadFileToGitHub(`pages/data_${newId}.json`, oldJson); // JSON content is same
                    
                    // 4. Update Registry
                    currentData.pages[newId] = JSON.parse(JSON.stringify(pageConfig));
                    currentData.pages[newId].source = `pages/data_${newId}.json`;
                    delete currentData.pages[activePageId];
                    
                    // 5. Delete old files
                    await deleteFileFromGitHub(`${activePageId}.html`);
                    await deleteFileFromGitHub(pageConfig.source); // Delete old json using stored path
                    
                    // 6. Save Registry
                    await uploadFileToGitHub(DATA_FILE, JSON.stringify(currentData, null, 4), fileSha);
                    
                    showMsg("成功", "頁面路徑已變更", "success", () => location.reload());
                } catch(e) {
                    showMsg("失敗", "變更失敗: " + e.message, "error");
                }
            });
        }

        async function uploadFileToGitHub(path, content, existingSha = null) {
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            if (!existingSha) {
                try {
                    const check = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers: { 'Authorization': `token ${sessionToken}` } });
                    if (check.ok) existingSha = (await check.json()).sha;
                } catch(e) {}
            }
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${sessionToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Update ${path}`, content: btoa(unescape(encodeURIComponent(content))), branch: 'main', sha: existingSha })
            });
            if (!res.ok) throw new Error(`Upload ${path} failed`);
            if (path === DATA_FILE) fileSha = (await res.json()).content.sha;
        }

        async function deleteFileFromGitHub(path) {
            const owner = localStorage.getItem('gh_owner');
            const repo = localStorage.getItem('gh_repo');
            let sha = null;
            try {
                const check = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers: { 'Authorization': `token ${sessionToken}` } });
                if (check.ok) sha = (await check.json()).sha;
            } catch(e) {}
            if(sha) {
                await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `token ${sessionToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: `Delete ${path}`, branch: 'main', sha: sha })
                });
            }
        }

        // --- Page Switching & Logic (FIXED: Await Fetch) ---
        async function switchPageEditor(pageId) {
            activePageId = pageId;
            const pageConfig = currentData.pages[pageId];
            
            const sidebar = document.getElementById('pages-sidebar');
            sidebar.innerHTML = '';
            for(const [pid, p] of Object.entries(currentData.pages)) {
                sidebar.innerHTML += `<div onclick="switchPageEditor('${pid}')" class="sidebar-btn ${pid===activePageId ? 'active' : ''}"><i class="fas ${p.icon||'fa-file'} w-5 text-center"></i><span>${p.title}</span></div>`;
            }

            if (pageConfig.source && !pageConfig.loaded) {
                document.getElementById('page-items-editor').innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-thuBlue text-2xl"></i><p class="mt-2 text-gray-500">正在讀取外部資料檔...</p></div>';
                try {
                    const content = await fetchRepoFile(pageConfig.source);
                    Object.assign(pageConfig, JSON.parse(content));
                    pageConfig.loaded = true;
                    document.getElementById('external-badge').classList.remove('hidden');
                } catch(e) {
                    showMsg("錯誤", "無法讀取頁面資料: " + e.message, "error");
                    return;
                }
            } else {
                document.getElementById('external-badge').classList.add('hidden');
            }
            renderPageEditorUI();
        }

        function renderPageEditorUI() {
            const cp = currentData.pages[activePageId];
            document.getElementById('page-setting-title').value = cp.title || '';
            document.getElementById('page-setting-tag').value = cp.tag || '';
            document.getElementById('page-setting-desc').value = cp.description || '';
            document.getElementById('page-setting-icon').value = cp.icon || '';
            document.getElementById('page-icon-preview').className = `fas ${cp.icon || 'fa-question'}`;
            document.getElementById('current-page-title-display').innerText = `${cp.title} - 設定`;

            const labels = cp.labels || {};
            document.getElementById('page-label-title').value = labels.title || '標題';
            document.getElementById('page-label-title-en').value = labels.title_en || '備註';

            const catManager = document.getElementById('category-manager');
            const fileConfig = document.getElementById('file-fields-config');
            
            if(cp.fileFields) { fileConfig.classList.remove('hidden'); renderFileConfigList(); } else { fileConfig.classList.add('hidden'); }
            if(cp.categories) { catManager.classList.remove('hidden'); renderCategoryList(); } else { catManager.classList.add('hidden'); }

            renderGenericList(document.getElementById('page-items-editor'), cp.items);
        }

        // --- Renderers ---
        function renderGenericList(container, items) {
            container.innerHTML = '';
            if (!items || items.length === 0) { container.innerHTML = '<div class="text-center py-20 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">尚無資料，請新增項目</div>'; return; }
            
            const cp = currentData.pages[activePageId];
            let catOptions = '<option value="">未分類</option>';
            if(cp.categories) cp.categories.forEach(c => { catOptions += `<option value="${c.id}">${c.name}</option>`; });
            
            const titleLabel = cp.labels?.title || '標題';
            const titleEnLabel = cp.labels?.title_en || '備註';
            const isResources = !!cp.fileFields;

            items.forEach((item, index) => {
                const checked = (item.visible !== false) ? 'checked' : '';
                let contentHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label class="block text-xs font-bold text-gray-400 mb-1">${titleLabel}</label><input type="text" class="p-title w-full border rounded p-2 text-sm" value="${item.title||''}"></div><div><label class="block text-xs font-bold text-gray-400 mb-1">${titleEnLabel}</label><input type="text" class="p-title-en w-full border rounded p-2 text-sm" value="${item.title_en||''}"></div></div>`;
                contentHtml += `<div class="grid grid-cols-3 gap-4 mb-4"><div><label class="block text-xs font-bold text-gray-400 mb-1">發布單位</label><input type="text" class="p-issuer w-full border rounded p-2 text-sm" value="${item.issuer||''}"></div><div><label class="block text-xs font-bold text-gray-400 mb-1">日期</label><input type="date" class="p-date w-full border rounded p-2 text-sm" value="${item.date||''}"></div><div><label class="block text-xs font-bold text-gray-400 mb-1">分類</label><select class="p-cat-select w-full border rounded p-2 text-sm">${catOptions.replace(`value="${item.category||''}"`, `value="${item.category||''}" selected`)}</select></div></div>`;

                if (isResources) {
                    let fileInputsHtml = '';
                    cp.fileFields.forEach(f => {
                        fileInputsHtml += `<div class="flex gap-2 items-center mb-2"><div class="w-24 flex-shrink-0 text-xs font-bold text-gray-500 flex items-center gap-1"><i class="fas ${f.icon}"></i> ${f.label}</div><div class="flex-grow flex gap-1 relative"><input type="text" id="input-${index}-${f.key}" class="p-file-field flex-grow border rounded p-1.5 text-sm text-blue-600 font-mono" data-key="${f.key}" value="${item[f.key]||''}"><button onclick="openFileSelector(${index}, '${f.key}')" class="file-upload-label" title="上傳檔案"><i class="fas fa-cloud-upload-alt"></i></button></div></div>`;
                    });
                    contentHtml += `<div class="bg-gray-50 p-4 rounded border border-gray-200"><label class="block text-xs font-bold text-gray-400 mb-2">檔案下載設定</label>${fileInputsHtml}</div>`;
                } else {
                     contentHtml += `<div><label class="block text-xs font-bold text-gray-400 mb-1">連結 URL</label><input type="text" class="p-url w-full border rounded p-2 text-sm text-blue-600 font-mono" value="${item.url||''}"></div>`;
                }

                container.innerHTML += `<div class="page-item bg-white rounded-xl border border-gray-200 shadow-sm mb-3 overflow-hidden" data-index="${index}"><div class="drag-handle bg-gray-50 p-3 px-4 flex justify-between items-center cursor-move hover:bg-gray-100 transition-colors"><div class="flex items-center gap-3 overflow-hidden" onclick="toggleAccordion(${index})"><div class="cursor-pointer text-gray-400 hover:text-thuBlue w-6 text-center"><i class="fas fa-grip-vertical"></i></div><span class="font-bold text-gray-700 truncate select-none">#${index+1} ${item.title || '(無標題)'}</span></div><div class="flex items-center gap-3"><label class="flex items-center cursor-pointer select-none" title="顯示/隱藏"><div class="relative"><input type="checkbox" class="sr-only peer p-visible" ${checked}><div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div></div></label><div class="h-4 w-px bg-gray-300 mx-1"></div><button onclick="deletePageItem(${index})" class="text-gray-400 hover:text-red-600 p-2 transition"><i class="fas fa-trash-alt"></i></button><button onclick="toggleAccordion(${index})" class="text-gray-400 hover:text-thuBlue p-2 transition"><i id="accordion-arrow-${index}" class="fas fa-chevron-down accordion-arrow"></i></button></div></div><div id="accordion-content-${index}" class="accordion-content bg-white"><div class="p-5">${contentHtml}<div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-100"><button onclick="saveSingleItem()" class="bg-blue-600 text-white border border-blue-700 hover:bg-blue-700 font-bold py-2 px-5 rounded-lg shadow-sm transition-all duration-200 text-sm">確認暫存</button></div></div></div></div>`;
            });
            if (sortablePageItems) sortablePageItems.destroy(); sortablePageItems = new Sortable(container, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: () => collectDataFromEditors() });
        }

        // --- Other Renderers ---
        function renderCardsList() { const c = document.getElementById('cards-list-editor'); c.innerHTML=''; currentData.cards.forEach((x,i)=>{ c.innerHTML+=`<div class="card-item bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative group" data-index="${i}"><div class="drag-handle absolute top-0 left-0 right-0 h-6 bg-gray-100 rounded-t-xl cursor-grab flex justify-center hover:bg-gray-200"><i class="fas fa-grip-lines text-gray-400"></i></div><div class="mt-4 grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-400">標題</label><input type="text" class="card-title w-full border rounded p-2 font-bold text-thuBlue" value="${x.Title}"></div><div><label class="text-xs font-bold text-gray-400">標籤</label><input type="text" class="card-badge w-full border rounded p-2 text-thuGold" value="${x.Badge||''}"></div><div class="col-span-2"><label class="text-xs font-bold text-gray-400">描述</label><input type="text" class="card-desc w-full border rounded p-2" value="${x.Description}"></div><div><label class="text-xs font-bold text-gray-400">Icon</label><input type="text" class="card-icon w-full border rounded p-2 font-mono" value="${x.Icon}"></div><div><label class="text-xs font-bold text-gray-400">顏色</label><select class="card-type w-full border rounded p-2">${getColorOptions(x.Type)}</select></div><div class="col-span-2"><label class="text-xs font-bold text-gray-400">連結</label><input type="text" class="card-link w-full border rounded p-2 font-mono text-blue-600" value="${x.Link}"></div></div><button onclick="deleteCardItem(${i})" class="absolute top-2 right-2 text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div>`}); if(sortableCards) sortableCards.destroy(); sortableCards = Sortable.create(c, {handle:'.drag-handle', onEnd:()=>collectDataFromEditors()}); }
        function renderContactsList() { 
            const oc=document.getElementById('office-contact-editor'); const sc=document.getElementById('staff-contacts-editor'); oc.innerHTML=''; sc.innerHTML='';
            const off = currentData.contacts.find(c=>c.Type==='office')||{Name:'中心',Title:'Office',Email:'',Description:''};
            oc.innerHTML=`<div class="office-item bg-blue-50 p-6 rounded-xl border border-blue-100"><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-400">名稱</label><input class="contact-name w-full border rounded p-2 font-bold" value="${off.Name}"></div><div><label class="text-xs font-bold text-gray-400">Email</label><input class="contact-email w-full border rounded p-2 font-mono" value="${off.Email}"></div><div class="col-span-2"><label class="text-xs font-bold text-gray-400">描述</label><input class="contact-desc w-full border rounded p-2" value="${off.Description}"></div><input type="hidden" class="contact-type" value="office"><input type="hidden" class="contact-title" value="Office"></div></div>`;
            currentData.contacts.filter(c=>c.Type!=='office').forEach((c,i)=>{ sc.innerHTML+=`<div class="staff-item bg-white p-5 rounded-xl border border-gray-200 shadow-sm relative group" data-index="${i}"><div class="drag-handle absolute top-0 left-0 right-0 h-6 cursor-grab flex justify-center hover:bg-gray-50"><i class="fas fa-grip-lines text-gray-300"></i></div><div class="mt-4 space-y-2"><div class="flex gap-2"><div class="w-2/3"><input class="contact-name w-full border rounded p-1.5 font-bold" value="${c.Name}" placeholder="姓名"></div><div class="w-1/3"><input class="contact-title w-full border rounded p-1.5 text-center" value="${c.Title}" placeholder="職稱"></div></div><input class="contact-email w-full border rounded p-1.5 text-xs font-mono" value="${c.Email}" placeholder="Email"><div class="flex gap-2"><input class="contact-phone w-1/2 border rounded p-1.5 text-xs" value="${c.Phone||''}" placeholder="分機"><select class="contact-type w-1/2 border rounded p-1.5 text-xs">${getColorOptions(c.Type)}</select></div><div class="mt-2"><label class="text-[10px] font-bold text-gray-400 block mb-1">負責業務 (職掌)</label><textarea class="contact-desc w-full border rounded p-1.5 text-xs text-gray-600 h-16 resize-y" placeholder="請輸入負責業務...">${c.Description||''}</textarea></div></div><button onclick="deleteContactItem(${i})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><i class="fas fa-times-circle"></i></button></div>`;});
            if(sortableStaff) sortableStaff.destroy(); sortableStaff = Sortable.create(sc, {handle:'.drag-handle', onEnd:()=>collectDataFromEditors()});
        }
        function renderNewsList() { const c=document.getElementById('news-list-editor'); c.innerHTML=''; currentData.news.forEach((n,i)=>{ c.innerHTML+=`<div class="news-item bg-white p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3"><div class="flex gap-3"><input type="date" class="news-date border rounded p-2 text-sm w-40" value="${n.Date}"><select class="news-type border rounded p-2 text-sm w-32"><option value="公告" ${n.Type==='公告'?'selected':''}>公告</option><option value="活動" ${n.Type==='活動'?'selected':''}>活動</option></select><div class="flex items-center gap-2"><input type="checkbox" class="news-isnew" ${n.IsNew?'checked':''}><label class="text-sm">NEW</label></div><button onclick="deleteNewsItem(${i})" class="ml-auto text-red-400"><i class="fas fa-trash"></i></button></div><input class="news-title w-full border rounded p-2 font-bold" value="${n.Title}"><input class="news-link w-full border rounded p-2 text-sm font-mono text-blue-600" value="${n.Link}"><textarea class="news-content w-full border rounded p-2 text-sm h-20">${n.Content}</textarea></div>`; }); }
        function renderColorManager() {
            const container = document.getElementById('colors-list-editor'); container.innerHTML = '';
            const colors = currentData.colors || [];
            colors.forEach((color, index) => {
                container.innerHTML += `<div class="grid grid-cols-12 gap-4 px-4 py-3 bg-white border border-gray-200 items-center color-item" data-index="${index}"><div class="col-span-1 flex justify-center"><div class="color-preview-circle" style="background-color: ${color.hex};"></div></div><div class="col-span-3"><input type="text" class="c-name w-full border rounded p-1.5 text-sm" value="${color.name}"></div><div class="col-span-3"><input type="text" class="c-id w-full border rounded p-1.5 text-sm font-mono" value="${color.id}"></div><div class="col-span-3"><div class="flex items-center gap-2"><input type="color" class="w-8 h-8 p-0 border-0 rounded cursor-pointer" value="${color.hex}" onchange="this.parentElement.nextElementSibling.value=this.value;this.closest('.color-item').querySelector('.color-preview-circle').style.backgroundColor=this.value;"><input type="text" class="c-hex w-full border rounded p-1.5 text-sm font-mono uppercase" value="${color.hex}" onchange="this.previousElementSibling.value=this.value;this.closest('.color-item').querySelector('.color-preview-circle').style.backgroundColor=this.value;"></div></div><div class="col-span-2 text-right"><button onclick="deleteColorItem(${index})" class="text-red-400 hover:text-red-600 p-2"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }
        
        // --- Message Modal Logic ---
        function showMsg(title, body, type = 'info', onConfirm = null) {
            const modal = document.getElementById('msg-modal');
            const panel = document.getElementById('msg-panel');
            const inputContainer = document.getElementById('msg-input-container');
            const input = document.getElementById('msg-input');
            
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-body').innerText = body;
            inputContainer.classList.add('hidden'); // Reset input visibility
            
            // Icon
            const iconDiv = document.getElementById('msg-icon');
            if(type==='error') { iconDiv.className='w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center text-2xl mx-auto mb-4'; iconDiv.innerHTML='<i class="fas fa-exclamation"></i>'; }
            else if(type==='success') { iconDiv.className='w-14 h-14 bg-green-100 text-green-500 rounded-full flex items-center justify-center text-2xl mx-auto mb-4'; iconDiv.innerHTML='<i class="fas fa-check"></i>'; }
            else { iconDiv.className='w-14 h-14 bg-blue-100 text-thuBlue rounded-full flex items-center justify-center text-2xl mx-auto mb-4'; iconDiv.innerHTML='<i class="fas fa-info"></i>'; }

            // Actions
            const actions = document.getElementById('msg-actions');
            actions.innerHTML = '';
            if(type==='confirm') {
                // If title indicates input needed (hacky but works for now) or called from promptRenamePage
                if(body.includes('請輸入')) inputContainer.classList.remove('hidden');
                confirmCallback = onConfirm;
                actions.innerHTML = `<button onclick="executeConfirm()" class="w-full bg-thuBlue text-white font-bold py-2.5 rounded-lg hover:bg-blue-800 transition shadow-md">確定</button><button onclick="closeMsg()" class="w-full bg-white text-gray-500 border border-gray-300 font-bold py-2.5 rounded-lg hover:bg-gray-50 transition">取消</button>`;
            } else {
                actions.innerHTML = `<button onclick="closeMsg()" class="w-full bg-gray-100 text-gray-700 font-bold py-2.5 rounded-lg hover:bg-gray-200 transition">確定</button>`;
            }

            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); panel.classList.remove('scale-95'); panel.classList.add('scale-100'); }, 10);
        }
        function closeMsg() { const m=document.getElementById('msg-modal'); const p=document.getElementById('msg-panel'); m.classList.add('opacity-0'); p.classList.remove('scale-100'); p.classList.add('scale-95'); setTimeout(()=>{m.classList.add('hidden');confirmCallback=null},300); }
        function executeConfirm() { if(confirmCallback) confirmCallback(); closeMsg(); }

        // --- Helpers ---
        function getColorOptions(sel) { let h=''; (currentData.colors||defaultColors).forEach(c=>{ h+=`<option value="${c.id}" ${c.id===sel?'selected':''} style="color:${c.hex};font-weight:bold">${c.name}</option>`}); return h; }
        
        // --- Save Data Logic ---
        async function saveData() {
            collectDataFromEditors();
            if (!sessionToken) { showMsg("錯誤", "請先登入", "error"); return; }

            const changedPages = [];
            for (const [id, page] of Object.entries(currentData.pages)) {
                if (page.source && page.loaded) {
                    const { loaded, sha, source, template, ...contentToSave } = page;
                    changedPages.push({ path: page.source, content: contentToSave, sha: page.sha });
                }
            }

            showMsg("確認", `確定要儲存變更嗎？`, "confirm", async () => {
                const btn = document.getElementById('save-btn'); 
                const status = document.getElementById('save-status');
                btn.disabled = true; 
                status.innerText = '儲存中...'; status.className = 'text-thuBlue font-bold text-sm mr-2';

                try {
                    await Promise.all(changedPages.map(p => uploadFileToGitHub(p.path, JSON.stringify(p.content, null, 4), p.sha)));
                    
                    const cleanData = JSON.parse(JSON.stringify(currentData));
                    for(const key in cleanData.pages) {
                        if(cleanData.pages[key].source) {
                            delete cleanData.pages[key].items;
                            delete cleanData.pages[key].categories;
                            delete cleanData.pages[key].fileFields;
                            delete cleanData.pages[key].loaded;
                            delete cleanData.pages[key].sha;
                        }
                    }

                    await uploadFileToGitHub(DATA_FILE, JSON.stringify(cleanData, null, 4), fileSha);
                    
                    status.innerText = '儲存成功'; status.className = 'text-green-600 font-bold text-sm mr-2';
                    setTimeout(() => status.classList.add('opacity-0'), 3000);
                    showMsg("成功", "所有變更已同步至 GitHub！", "success");
                } catch(e) {
                    showMsg("失敗", e.message, "error");
                    status.innerText = '儲存失敗'; status.className = 'text-red-600 font-bold text-sm mr-2';
                } finally {
                    btn.disabled = false;
                }
            });
        }

        function collectDataFromEditors() {
            if(!currentData) return;
            document.querySelectorAll('.setting-input').forEach(i => { const k=i.getAttribute('data-key'); let v=i.value; if(k==='HeroSubtitle') v=v.replace(/\n/g,'<br>'); currentData.settings[k]=v; });
            const cols = []; document.querySelectorAll('.color-item').forEach(d => cols.push({name:d.querySelector('.c-name').value, id:d.querySelector('.c-id').value, hex:d.querySelector('.c-hex').value})); currentData.colors = cols;
            const cards=[]; document.querySelectorAll('.card-item').forEach(d => cards.push({Title:d.querySelector('.card-title').value, Badge:d.querySelector('.card-badge').value, Description:d.querySelector('.card-desc').value, Icon:d.querySelector('.card-icon').value, Type:d.querySelector('.card-type').value, Link:d.querySelector('.card-link').value})); currentData.cards = cards;
            const news=[]; document.querySelectorAll('.news-item').forEach(d => news.push({Date:d.querySelector('.news-date').value, Type:d.querySelector('.news-type').value, Title:d.querySelector('.news-title').value, Link:d.querySelector('.news-link').value, Content:d.querySelector('.news-content').value, IsNew:d.querySelector('.news-isnew').checked})); currentData.news = news;
            const contacts=[]; 
            const od=document.querySelector('.office-item'); if(od) contacts.push({Name:od.querySelector('.contact-name').value, Title:'Office', Email:od.querySelector('.contact-email').value, Phone:'', Description:od.querySelector('.contact-desc').value, Type:'office'});
            document.querySelectorAll('.staff-item').forEach(d => contacts.push({Name:d.querySelector('.contact-name').value, Title:d.querySelector('.contact-title').value, Email:d.querySelector('.contact-email').value, Phone:d.querySelector('.contact-phone').value, Description:d.querySelector('.contact-desc').value, Type:d.querySelector('.contact-type').value}));
            currentData.contacts = contacts;
            
            if(currentData.pages && currentData.pages[activePageId]) {
                const page = currentData.pages[activePageId];
                page.title = document.getElementById('page-setting-title').value;
                page.tag = document.getElementById('page-setting-tag').value;
                page.description = document.getElementById('page-setting-desc').value;
                page.icon = document.getElementById('page-setting-icon').value;
                if(!page.labels) page.labels={};
                page.labels.title = document.getElementById('page-label-title').value;
                page.labels.title_en = document.getElementById('page-label-title-en').value;
                
                const items = [];
                document.querySelectorAll('.page-item').forEach(d => {
                    const item = {
                        title: d.querySelector('.p-title').value,
                        title_en: d.querySelector('.p-title-en').value,
                        issuer: d.querySelector('.p-issuer').value,
                        date: d.querySelector('.p-date').value,
                        category: d.querySelector('.p-cat-select').value,
                        visible: d.querySelector('.p-visible').checked
                    };
                    if(page.fileFields) {
                        d.querySelectorAll('.p-file-field').forEach(fi => item[fi.getAttribute('data-key')] = fi.value);
                    } else {
                        item.url = d.querySelector('.p-url').value;
                    }
                    items.push(item);
                });
                page.items = items;
            }
        }

        // --- File Upload Logic ---
        function openFileSelector(index, key) {
            currentUploadTargetInput = document.getElementById(`input-${index}-${key}`);
            document.getElementById('global-file-input').click();
        }

        async function handleFileUpload(input) {
            if (!input.files || input.files.length === 0) return;
            const file = input.files[0];
            const originalText = currentUploadTargetInput.value;
            currentUploadTargetInput.value = "上傳中..."; 
            currentUploadTargetInput.disabled = true;

            try {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async function () {
                    const base64Content = reader.result.split(',')[1];
                    const path = `files/${file.name}`;
                    await uploadFileToGitHub(path, atob(base64Content));
                    currentUploadTargetInput.value = path;
                    currentUploadTargetInput.disabled = false;
                    showMsg("上傳成功", `檔案已上傳至 ${path}`, "success");
                    collectDataFromEditors();
                };
            } catch (e) {
                showMsg("上傳失敗", e.message, "error");
                currentUploadTargetInput.value = originalText;
                currentUploadTargetInput.disabled = false;
            }
            input.value = '';
        }

        // --- Standard UI Actions (Now using showMsg) ---
        function switchTab(id) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.add('hidden')); document.querySelectorAll('.tab-btn').forEach(b=>{b.classList.remove('border-thuBlue','text-thuBlue');b.classList.add('border-transparent')}); document.getElementById('tab-'+id).classList.remove('hidden'); document.querySelector(`.tab-btn[data-tab="${id}"]`).classList.add('border-thuBlue','text-thuBlue'); if(id==='raw') document.getElementById('raw-json').value=JSON.stringify(currentData,null,4); if(id==='cards') renderCardsList(); if(id==='contacts') renderContactsList(); if(id==='colors') renderColorManager(); if(id==='news') renderNewsList(); if(id==='pages') switchPageEditor(activePageId); }
        
        function addCardItem() { collectDataFromEditors(); currentData.cards.push({Title:"新卡片",Badge:"",Description:"",Icon:"fa-star",Type:"thu",Link:"#"}); renderCardsList(); }
        function deleteCardItem(i) { showMsg("確認", "確定刪除此卡片？", "confirm", () => { collectDataFromEditors(); currentData.cards.splice(i,1); renderCardsList(); }); }
        
        function addContactItem() { collectDataFromEditors(); currentData.contacts.push({Name:"姓名",Title:"職稱",Email:"",Phone:"",Type:"thu"}); renderContactsList(); }
        function deleteContactItem(i) { showMsg("確認", "確定刪除此聯絡人？", "confirm", () => { collectDataFromEditors(); const realIdx = currentData.contacts.findIndex(c=>c.Type==='office') > -1 ? i+1 : i; currentData.contacts.splice(realIdx,1); renderContactsList(); }); }
        
        function addColorItem() { collectDataFromEditors(); currentData.colors.push({name:"新顏色",id:"new",hex:"#000000"}); renderColorManager(); }
        function deleteColorItem(i) { showMsg("確認", "確定刪除此顏色？", "confirm", () => { collectDataFromEditors(); currentData.colors.splice(i,1); renderColorManager(); }); }
        
        function addNewsItem() { collectDataFromEditors(); currentData.news.unshift({Date:new Date().toISOString().split('T')[0],Type:"公告",Title:"",Link:"",Content:"",IsNew:true}); renderNewsList(); }
        function deleteNewsItem(i) { showMsg("確認", "確定刪除此公告？", "confirm", () => { collectDataFromEditors(); currentData.news.splice(i,1); renderNewsList(); }); }
        
        function addPageItem() { collectDataFromEditors(); currentData.pages[activePageId].items.push({title:"",visible:true}); renderPageEditorUI(); }
        function deletePageItem(i) { showMsg("確認", "確定刪除此項目？", "confirm", () => { collectDataFromEditors(); currentData.pages[activePageId].items.splice(i,1); renderPageEditorUI(); }); }
        
        function addNewCategory() { const n = document.getElementById('new-cat-name').value.trim(); if(!n)return; if(!currentData.pages[activePageId].categories) currentData.pages[activePageId].categories=[]; currentData.pages[activePageId].categories.push({id:'cat_'+Date.now(), name:n}); document.getElementById('new-cat-name').value=''; renderCategoryList(); }
        function renderCategoryList() { const l = document.getElementById('cat-list'); l.innerHTML=''; currentData.pages[activePageId].categories.forEach((c,i)=>{ l.innerHTML+=`<div class="flex justify-between p-2 border-b"><span class="font-bold">${c.name}</span><button onclick="deleteCategory(${i})" class="text-red-400"><i class="fas fa-trash"></i></button></div>`}); }
        function deleteCategory(i) { showMsg("確認", "確定刪除此分類？", "confirm", () => { currentData.pages[activePageId].categories.splice(i,1); renderCategoryList(); }); }
        
        function renderFileConfigList() { const l=document.getElementById('file-config-list'); l.innerHTML=''; currentData.pages[activePageId].fileFields.forEach((f,i)=>{l.innerHTML+=`<div class="flex gap-2 mb-1"><input value="${f.label}" id="ff-l-${i}" class="border rounded p-1 text-xs w-1/2"><input value="${f.icon}" id="ff-i-${i}" class="border rounded p-1 text-xs w-1/3"><i class="fas ${f.icon}"></i></div>`}); }
        function saveFileConfigSettings() { currentData.pages[activePageId].fileFields.forEach((f,i)=>{ f.label=document.getElementById('ff-l-'+i).value; f.icon=document.getElementById('ff-i-'+i).value; }); showMsg("成功", "設定已更新", "success"); }
        function saveSingleItem() { collectDataFromEditors(); renderPageEditorUI(); showMsg("暫存", "項目已暫存，請記得按儲存並發布", "info"); }
        function toggleAccordion(i) { document.getElementById('accordion-content-'+i).classList.toggle('open'); document.getElementById('accordion-arrow-'+i).classList.toggle('rotate'); }
        function togglePageSettings() { document.getElementById('page-settings-panel').classList.toggle('hidden'); document.getElementById('page-settings-arrow').classList.toggle('rotate-180'); }
        function savePageHeaderSettings() { collectDataFromEditors(); showMsg("暫存", "設定已暫存", "info"); }
        function toggleTokenVisibility() { const t=document.getElementById('gh-token'); const i=document.getElementById('token-eye-icon'); if(t.type==='password'){t.type='text';i.className='fas fa-eye-slash'}else{t.type='password';i.className='fas fa-eye'} }
        
        function logout() { 
            showMsg("登出確認", "確定要登出嗎？資料將不會保留。", "confirm", () => location.reload()); 
        }

        window.addEventListener('beforeunload', function (e) { 
            if (currentData) { e.preventDefault(); e.returnValue = ''; } 
        });

        document.addEventListener('DOMContentLoaded', () => { 
            document.getElementById('gh-owner').value = localStorage.getItem('gh_owner') || ''; 
            document.getElementById('gh-repo').value = localStorage.getItem('gh_repo') || ''; 
        });
    </script>
</body>
</html>
