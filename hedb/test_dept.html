<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海大學學生校外實習校庫填報輔助系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SheetJS for Excel Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS (用於高階讀寫與樣式控制) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC',
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        :root {
            --base-size: 14px; 
        }
        
        html { font-size: var(--base-size); }
        body { font-size: 1rem; } 
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .input-stylish { width: 100%; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.4rem 0.75rem; font-size: 1em; transition: all 0.2s; background-color: #fff; line-height: 1.5; min-height: 2.5em; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .input-stylish:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
        
        textarea.input-stylish { height: auto; min-height: 2.5em; padding-top: 0.4rem; padding-bottom: 0.4rem; }

        /* Sidebar Transition */
        aside { transition: width 0.3s ease; position: relative; }
        aside.collapsed { width: 0 !important; overflow: hidden; }
        
        /* New Full-Height Sidebar Toggle */
        #sidebar-toggle-strip {
            position: absolute;
            left: 20rem; /* Matches sidebar width */
            top: 0;
            bottom: 0;
            width: 12px;
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            border-left: 1px solid #fff;
            cursor: pointer;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease, background-color 0.2s;
        }
        #sidebar-toggle-strip:hover { background-color: #e2e8f0; }
        #sidebar-toggle-strip i { font-size: 10px; color: #94a3b8; transition: transform 0.3s; }
        
        /* When collapsed */
        aside.collapsed + #sidebar-toggle-strip { left: 0; border-left: none; }
        aside.collapsed + #sidebar-toggle-strip i { transform: rotate(180deg); }

        /* Left Sidebar Items */
        .student-item { cursor: pointer; border-left: 3px solid transparent; transition: all 0.2s; }
        .student-item:hover { background-color: #f8fafc; }
        .student-item.active { background-color: #eff6ff; border-left-color: #002E5D; }
        .student-item.active .student-name { color: #002E5D; font-weight: bold; }

        /* Import Button (Admin Style) */
        .import-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9em; width: 100%; }
        .import-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Course Card in Settings Tab */
        .course-card { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; 
            transition: all 0.2s; position: relative; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .course-card:hover { border-color: #002E5D; background-color: #f0f9ff; }
        .course-card.selected { border-color: #002E5D; background-color: #eff6ff; }

        .field-group { transition: all 0.3s ease; margin-bottom: 0.5rem; }
        /* 鎖定時的視覺樣式 (取代原本的 hidden) */
        .field-locked label { color: #94a3b8; }
        .field-locked .input-stylish { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; }
        .field-locked select.date-select { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; pointer-events: none; }
        .field-locked .date-toggle-btn { display: none; } /* Hide toggle button when locked */
        
        .spinner { border: 3px solid rgba(0,46,93,0.1); border-radius: 50%; border-top: 3px solid #002E5D; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tab System */
        .tab-btn { 
            padding: 0.75rem 1.5rem; font-size: 1em; font-weight: 600; color: #64748b; 
            border-bottom: 3px solid transparent; transition: all 0.2s; cursor: pointer; 
            display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;
        }
        .tab-btn:hover { color: #002E5D; background-color: #f8fafc; }
        .tab-btn.active { color: #002E5D; border-bottom-color: #002E5D; background-color: #fff; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Excel Preview Table */
        .excel-table { border-collapse: collapse; width: 100%; font-size: 0.9em; }
        .excel-table th, .excel-table td { border: 1px solid #e2e8f0; padding: 6px 10px; white-space: nowrap; }
        .excel-table th { background-color: #f8fafc; color: #64748b; font-weight: bold; text-align: left; }
        
        /* Form Section Title */
        .form-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #002E5D;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-section-title:first-child { margin-top: 0; }
        .form-section-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 1.2em;
            background-color: #C6A87C;
            border-radius: 2px;
        }

        /* Tooltip Style */
        .tooltip-container { position: relative; display: inline-block; margin-left: 0.5rem; }
        .tooltip-icon { color: #94a3b8; cursor: help; transition: color 0.2s; }
        .tooltip-icon:hover { color: #002E5D; }
        .tooltip-text { 
            visibility: hidden; width: 200px; background-color: #334155; color: #fff; text-align: left; 
            border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; 
            margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.85em; font-weight: normal; line-height: 1.4;
            pointer-events: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }

        /* Custom ROC Date Picker Styles */
        .date-picker-wrapper { position: relative; width: 100%; }
        .date-input-group { position: relative; display: flex; align-items: center; }
        .date-picker-trigger {
            position: absolute; right: 8px; color: #64748b; cursor: pointer; padding: 4px;
            border-radius: 4px; transition: color 0.2s;
        }
        .date-picker-trigger:hover { color: #002E5D; background-color: #f1f5f9; }
        
        .calendar-popover {
            position: absolute; top: 100%; left: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 280px; z-index: 50; display: none; padding: 12px; font-size: 0.9em;
        }
        .calendar-popover.active { display: block; animation: fadeIn 0.1s ease-out; }
        
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-btn { padding: 4px 8px; border-radius: 4px; hover: bg-slate-100; cursor: pointer; color: #64748b; }
        .cal-btn:hover { background-color: #f1f5f9; color: #002E5D; }
        .cal-title { font-weight: bold; color: #334155; cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-header { font-size: 0.75em; color: #94a3b8; padding: 4px 0; }
        .cal-day { 
            padding: 6px 0; cursor: pointer; border-radius: 4px; color: #334155; 
        }
        .cal-day:hover:not(.empty) { background-color: #f1f5f9; color: #002E5D; }
        .cal-day.selected { background-color: #002E5D; color: #fff; }
        .cal-day.empty { pointer-events: none; }
        .cal-day.today { border: 1px solid #002E5D; font-weight: bold; }

        /* Filter Styles */
        .filter-select { font-size: 0.85em; padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0; background-color: #fff; width: 100%; }
        
        /* Toast Animation */
        .toast-enter { transform: translateY(20px); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(20px); opacity: 0; transition: all 0.3s ease-in; }
        
        /* Confirmation Modal */
        .confirm-modal-content { 
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
        }

        /* Grid View & Modal Styles */
        .sortable-header { cursor: pointer; user-select: none; transition: background 0.2s; }
        .sortable-header:hover { background-color: #e2e8f0; }
        .sort-icon { margin-left: 4px; color: #94a3b8; font-size: 0.8em; }
        .sort-icon.active { color: #002E5D; }
        
        /* Grid Input Styles */
        .grid-input { 
            width: 100%; border: 1px solid transparent; background: transparent; 
            padding: 4px; font-size: 14px; border-radius: 2px;
        }
        .grid-input:focus { border-color: #002E5D; background: white; outline: none; }
        .grid-input:disabled { background-color: #f1f5f9; color: #cbd5e1; cursor: not-allowed; }
        
        /* Linked Data Indicator */
        .is-linked { background-color: #eff6ff !important; color: #1e40af; } /* Light Blue for consolidated */
        .is-raw { background-color: #fff !important; }
        
        /* Toggle Checkbox Label */
        .col-toggle-label { 
            display: inline-flex; items-center; gap: 4px; background: white; padding: 2px 8px; 
            border: 1px solid #cbd5e1; rounded: 4px; cursor: pointer; user-select: none;
        }
        .col-toggle-label:hover { border-color: #64748b; }
        .col-toggle-label input:checked + span { color: #002E5D; font-weight: bold; }
        
        /* Grid View Compact Styles */
        /* 讓表格行高變小，更像 Excel */
        .excel-table td { padding: 4px 6px; height: 32px; } 
        
        /* 修正輸入框高度與內距 */
        .grid-input { 
            width: 100%; 
            height: 100%;
            border: 1px solid transparent; 
            background: transparent; 
            padding: 0 4px; 
            font-size: 13px; 
            border-radius: 0;
            line-height: 24px;
        }
        .grid-input:focus { border: 1px solid #002E5D; background: white; outline: none; box-shadow: none; }
        .grid-input:disabled { background-color: #f8fafc; color: #cbd5e1; cursor: not-allowed; }

        /* 讓選單更緊湊 */
        select.grid-input { padding-right: 0; }
    
    </style>
</head>
<body class="h-screen flex flex-col bg-background text-slate-700 overflow-hidden">

    <!-- Header -->
    <header class="h-16 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm z-30 flex-shrink-0 justify-between">
        <div class="flex items-center gap-4">
            <div class="bg-primary p-1.5 rounded-lg shadow-sm">
                <img src="files/svg/THU-Logo.svg" class="h-8 w-auto" alt="Logo">
            </div>
            <div>
                <h1 class="font-bold text-lg text-primary tracking-wide">東海大學學生校外實習校庫填報輔助系統</h1>
                <p class="text-[10px] text-slate-400">Department Data Entry System</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            
            <!-- Font Size Toggle -->
            <div class="relative group">
                <select id="font-size-select" onchange="setFontSize(this.value)" class="pl-3 pr-8 py-2 bg-slate-100 border-none rounded-lg text-sm font-bold text-slate-700 cursor-pointer focus:ring-2 focus:ring-primary outline-none appearance-none hover:bg-slate-200 transition">
                    <option value="14px">字體: 標準 (A)</option>
                    <option value="16px">字體: 加大 (A+)</option>
                    <option value="18px">字體: 特大 (A++)</option>
                    <option value="24px">字體: 超大 (A++++)</option>
                </select>
                <i class="fas fa-text-height absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
            </div>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>

            <!-- Year Selector -->
            <div class="relative group">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-calendar-alt text-slate-400"></i>
                </div>
                <select id="year-select" onchange="changeYear(this.value)" class="pl-9 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold text-slate-700 cursor-pointer focus:ring-2 focus:ring-primary focus:border-primary outline-none appearance-none hover:bg-white transition shadow-sm">
                    <option value="">請選擇學年度...</option>
                </select>
                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                    <i class="fas fa-chevron-down text-slate-400 text-xs"></i>
                </div>
            </div>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>

            <div class="flex bg-slate-100 p-1 rounded-lg mr-3">
                <button onclick="switchViewMode('app')" id="btn-view-app" class="px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary">
                    <i class="fas fa-layer-group"></i> 歸戶填報
                </button>
                <button onclick="switchViewMode('grid')" id="btn-view-grid" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition">
                    <i class="fas fa-th"></i> 傳統總表
                </button>
            </div>
            
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <button onclick="exportData()" class="bg-success text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm flex items-center gap-2">
                <i class="fas fa-file-export"></i> 匯出結果
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-grow flex overflow-hidden relative">
        
        <!-- Sidebar: Student List -->
        <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm flex-shrink-0 relative">
            <!-- Import Button -->
            <div class="p-4 pb-0 bg-slate-50">
                <label class="import-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                    <i class="fas fa-file-import text-lg"></i> 匯入學生名單 (Excel)
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .csv" onchange="handleFileUpload(event)">
                </label>
            </div>

            <div class="p-4 border-b border-slate-100 bg-slate-50 space-y-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterStudentList()" placeholder="搜尋姓名或學號..." class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-2 gap-2">
                    <select id="filter-course-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部開課系</option>
                    </select>
                    <select id="filter-student-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部學生系</option>
                    </select>
                    <select id="filter-status" onchange="filterStudentList()" class="filter-select col-span-2">
                        <option value="">全部填報進度</option>
                        <option value="pending">未開始</option>
                        <option value="completed">已填報</option>
                    </select>
                </div>

                <div class="flex justify-between items-center text-xs text-slate-500">
                    <div>總計: <span id="student-count" class="font-bold text-slate-700">0</span> 人</div>
                    <div class="flex gap-1">
                        <button onclick="toggleSort('id')" class="hover:text-primary p-1 rounded transition" title="依學號排序" id="sort-id-btn">
                            <i class="fas fa-sort-numeric-down"></i>
                        </button>
                        <button onclick="toggleSort('name')" class="hover:text-primary p-1 rounded transition" title="依姓名排序" id="sort-name-btn">
                            <i class="fas fa-sort-alpha-down"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="student-list" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-1">
                <div class="p-8 text-center text-slate-400 text-sm">
                    <i class="fas fa-arrow-up mb-2 text-xl block"></i>
                    請先從上方匯入 Excel 名單
                </div>
            </div>
        </aside>

        <!-- Sidebar Toggle Strip -->
        <div id="sidebar-toggle-strip" onclick="toggleSidebar()" title="收合/展開側邊欄">
            <i class="fas fa-chevron-left text-slate-400"></i>
        </div>

        <!-- Right Side: Workspace -->
        <main class="flex-grow bg-slate-50 overflow-hidden relative flex flex-col" id="main-content">
            
            <!-- Empty State -->
            <div id="form-empty-state" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-50 text-slate-400">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 text-3xl shadow-sm border border-slate-100">
                    <i class="fas fa-user-edit text-slate-300"></i>
                </div>
                <p>請從左側選擇一位學生開始填報</p>
            </div>

            <!-- Content Area (Visible when student selected) -->
            <div id="form-container" class="hidden flex flex-col h-full w-full">
                
                <!-- Student Header Panel -->
                <div class="bg-white px-6 py-4 border-b border-slate-200 shadow-sm flex-shrink-0 flex justify-between items-center z-20">
                    <div class="flex gap-4 items-center">
                        <div class="w-12 h-12 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xl font-bold">
                            <span id="header-avatar">?</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <span id="header-name">學生姓名</span>
                                <span id="header-id" class="text-sm font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded">ID</span>
                            </h2>
                            <p class="text-sm text-slate-500 flex gap-3 mt-0.5">
                                <span id="header-dept"><i class="fas fa-graduation-cap mr-1"></i>系所</span>
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="openPreviewModal()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-3 py-1.5 rounded-lg text-xs font-bold shadow-sm transition flex items-center gap-2">
                            <i class="fas fa-table"></i> 資料預覽
                        </button>
                        <span id="header-status" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500">未填報</span>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="bg-white border-b border-slate-200 px-6 flex gap-2 z-10 overflow-x-auto custom-scroll flex-shrink-0" id="tabs-container">
                    <button class="tab-btn active" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 歸戶設定</button>
                </div>

                <!-- Tab Contents Scrollable Area -->
                <div class="flex-grow overflow-y-auto custom-scroll p-6 pb-24 relative">
                    
                    <!-- Tab: Settings (Consolidation) -->
                    <div id="tab-settings" class="tab-content active max-w-7xl mx-auto">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                            <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-indigo-800 text-lg flex items-center gap-2"><i class="fas fa-layer-group"></i> 實習歸戶設定</h3>
                                    <p class="text-xs text-indigo-600 mt-1">請勾選同一實習機構的課程，合併建立為一份填報單。</p>
                                </div>
                                <button onclick="createApplication()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                                    <i class="fas fa-plus"></i> 建立實習填報單
                                </button>
                            </div>
                            
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Left Column: Unassigned Courses -->
                                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2 pb-2 border-b border-slate-200">
                                        <span class="w-2 h-2 rounded-full bg-slate-400"></span> 尚未歸戶的課程 (請勾選)
                                    </h4>
                                    <div id="settings-course-list" class="space-y-2"></div>
                                </div>
                                
                                <!-- Right Column: Existing Applications -->
                                <div class="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100">
                                    <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2 pb-2 border-b border-indigo-200">
                                        <span class="w-2 h-2 rounded-full bg-success"></span> 已建立的填報單
                                    </h4>
                                    <div id="app-management-list" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Tabs will be injected here -->
                    <div id="dynamic-tabs-area"></div>

                </div>
        </main>
    </div> <div id="grid-view-container" class="hidden absolute inset-0 top-16 z-10 bg-white flex flex-col">
        <div class="px-6 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
            <div class="flex items-center gap-4">
                <h2 class="font-bold text-slate-700"><i class="fas fa-th text-primary"></i> 全校課程總表 (傳統模式)</h2>
                <div class="text-xs text-slate-500 bg-yellow-50 text-yellow-700 px-2 py-1 rounded border border-yellow-200">
                    <i class="fas fa-link"></i> 資料與歸戶系統連動中：修改已歸戶的課程，將同步更新其所屬的填報單。
                </div>
            </div>
            <div class="flex gap-2">
                 <input type="text" id="grid-search" placeholder="篩選學號/姓名/課程..." class="px-3 py-1.5 border border-slate-300 rounded text-sm w-64" oninput="renderGlobalGrid()">
            </div>
        </div>
        <div class="flex-grow overflow-auto custom-scroll relative">
            <table class="excel-table w-full relative">
                <thead class="sticky top-0 z-20 bg-slate-100 shadow-sm" id="grid-thead"></thead>
                <tbody id="grid-tbody"></tbody>
            </table>
        </div>
    </div>
    <!-- Preview Modal -->
        <div id="preview-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-table text-primary"></i> 學生資料預覽</h3>
                    <p class="text-xs text-slate-500 mt-1">包含所有課程（已歸戶與未歸戶）的完整資料</p>
                </div>
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>

            <div class="px-6 py-2 bg-slate-100 border-b border-slate-200 flex flex-wrap gap-2 text-xs" id="preview-column-toggles">
                </div>

            <div class="flex-grow overflow-auto custom-scroll p-0 relative">
                <table class="excel-table w-full relative">
                    <thead class="sticky top-0 z-10"><tr id="modal-preview-head"></tr></thead>
                    <tbody id="modal-preview-body"></tbody>
                </table>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm bg-slate-800 text-white shadow hover:bg-slate-900">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center modal-overlay p-4">
        <div class="confirm-modal-content">
            <div class="mb-4 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">確認刪除？</h3>
            <p class="text-sm text-slate-600 mb-6" id="confirm-message">此操作無法復原。</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-cancel-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-slate-500 bg-slate-100 hover:bg-slate-200 transition">取消</button>
                <button id="confirm-ok-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-white bg-red-600 hover:bg-red-700 shadow transition">確認</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification (Fixed) -->
    <div id="toast" class="fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 text-white translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <i id="toast-icon" class="fas fa-info-circle"></i>
        <span id="toast-msg">Notification</span>
        <button onclick="hideToast(event)" class="ml-auto hover:text-slate-200 focus:outline-none p-1"><i class="fas fa-times"></i></button>
    </div>

    <!-- 修正 1: 加入 Footer 版權宣告 -->
    <footer class="bg-white border-t border-slate-200 py-3 px-6 text-center text-[10px] text-slate-400 flex-shrink-0 z-30 relative">
        <p class="font-bold">Copyright © <span id="copyright-year">2025</span> 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p>
        <p class="mt-0.5 font-medium opacity-80">網頁製作：張博堯 | Assisted by Google Gemini</p>
    </footer>

    <script>
        // --- Global State ---
        let globalConfig = {};       
        let currentYearConfig = {};  
        let departmentData = [];     
        let deptMasterData = {};     
        
        let allRawData = [];         
        let groupedStudents = {};    
        let currentStudentId = null; 
        let activeYear = "";         
        let hasUnsavedChanges = false; // Flag for unsaved changes

        // Change Log Store
        let changeLogs = []; // { time, field, oldVal, newVal, student, app }

        let sortConfig = { key: 'id', direction: 'asc' }; 

        const CORE_FIELDS = ['school_year', 'semester', 'student_id', 'student_name', 'student_dept', 'course_name', 'course_id'];

        // Custom Confirm Helper
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const okBtn = document.getElementById('confirm-ok-btn');

                titleEl.innerText = title;
                msgEl.innerText = message;
                modal.classList.remove('hidden');

                const close = (result) => {
                    modal.classList.add('hidden');
                    // Remove listeners to prevent duplicates
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                    resolve(result);
                };

                cancelBtn.onclick = () => close(false);
                okBtn.onclick = () => close(true);
            });
        }
        
        // --- 預覽視窗增強 (排序/開關) ---
        let previewState = {
            hiddenCols: [],
            sortKey: null,
            sortDir: 'asc'
        };

        function openPreviewModal() {
            if (!currentStudentId) return;
            document.getElementById('preview-modal').classList.remove('hidden');
            renderPreviewControls();
            renderPreviewTable();
        }

        function renderPreviewControls() {
            const container = document.getElementById('preview-column-toggles');
            container.innerHTML = '<span class="text-slate-500 py-1">顯示欄位:</span>';
            
            const fields = getAllExportFields();
            fields.forEach(f => {
                const lbl = document.createElement('label');
                lbl.className = 'col-toggle-label';
                const checked = !previewState.hiddenCols.includes(f.id);
                lbl.innerHTML = `
                    <input type="checkbox" onchange="togglePreviewCol('${f.id}')" ${checked ? 'checked' : ''}>
                    <span>${f.label}</span>
                `;
                container.appendChild(lbl);
            });
        }

        function togglePreviewCol(fieldId) {
            if (previewState.hiddenCols.includes(fieldId)) {
                previewState.hiddenCols = previewState.hiddenCols.filter(id => id !== fieldId);
            } else {
                previewState.hiddenCols.push(fieldId);
            }
            renderPreviewTable();
        }

        function setPreviewSort(key) {
            if (previewState.sortKey === key) {
                previewState.sortDir = previewState.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                previewState.sortKey = key;
                previewState.sortDir = 'asc';
            }
            renderPreviewTable();
        }

        function renderPreviewTable() {
            const student = groupedStudents[currentStudentId];
            const thead = document.getElementById('modal-preview-head');
            const tbody = document.getElementById('modal-preview-body');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const allFields = getAllExportFields();
            const visibleFields = allFields.filter(f => !previewState.hiddenCols.includes(f.id));

            // Render Header
            visibleFields.forEach(h => {
                const th = document.createElement('th');
                th.className = 'sortable-header';
                th.onclick = () => setPreviewSort(h.id);
                let icon = '';
                if (previewState.sortKey === h.id) {
                    icon = previewState.sortDir === 'asc' ? '<i class="fas fa-sort-up sort-icon active"></i>' : '<i class="fas fa-sort-down sort-icon active"></i>';
                } else {
                    icon = '<i class="fas fa-sort sort-icon"></i>';
                }
                th.innerHTML = `${h.label} ${icon}`;
                thead.appendChild(th);
            });

            // Prepare Data Rows
            let rows = [];
            // 1. Consolidated Rows
            student.applications.forEach(app => {
                const courses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
                courses.forEach(c => {
                    let rowData = { ...c, _source: 'app', _appData: app.formData };
                    // Merge app data
                    allFields.forEach(f => {
                        if (app.formData[f.id] !== undefined && app.formData[f.id] !== "") {
                            rowData[f.id] = app.formData[f.id];
                        }
                    });
                    rows.push(rowData);
                });
            });
            // 2. Unassigned Rows
            student.courses.filter(c => !c._app_id).forEach(c => {
                rows.push({ ...c, _source: 'raw' });
            });

            // Sort
            if (previewState.sortKey) {
                rows.sort((a, b) => {
                    const valA = (a[previewState.sortKey] || '').toString();
                    const valB = (b[previewState.sortKey] || '').toString();
                    return previewState.sortDir === 'asc' ? valA.localeCompare(valB, 'zh-Hant') : -valB.localeCompare(valA, 'zh-Hant');
                });
            }

            // Render Body
            rows.forEach(r => {
                const tr = document.createElement('tr');
                visibleFields.forEach(h => {
                    const td = document.createElement('td');
                    let val = r[h.id];
                    // Handle specific logic like Average calculation (simplified for preview)
                    if (val === undefined || val === null) val = "";
                    
                    if (r._source === 'app' && r._appData[h.id]) {
                        td.className = "text-indigo-600 font-bold bg-indigo-50";
                    }
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function getAllExportFields() {
            let headers = [];
            if (currentYearConfig.fields) {
                currentYearConfig.fields.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(f => headers.push({id: f.id, label: f.label}));
            }
            if(headers.length === 0) CORE_FIELDS.forEach(k => headers.push({id:k, label:k}));
            return headers;
        }

        // --- 傳統填報模式 (Grid View) ---
        
        function switchViewMode(mode) {
            const appView = document.getElementById('sidebar').parentElement; // Main layout
            const gridView = document.getElementById('grid-view-container');
            const btnApp = document.getElementById('btn-view-app');
            const btnGrid = document.getElementById('btn-view-grid');

            if (mode === 'grid') {
                document.getElementById('sidebar').style.display = 'none';
                document.getElementById('main-content').style.display = 'none';
                document.getElementById('sidebar-toggle-strip').style.display = 'none';
                gridView.classList.remove('hidden');
                
                btnApp.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition";
                btnGrid.className = "px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary";
                
                renderGlobalGrid();
            } else {
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'flex';
                document.getElementById('sidebar-toggle-strip').style.display = 'flex';
                gridView.classList.add('hidden');
                
                btnApp.className = "px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary";
                btnGrid.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition";
                
                // Refresh current view in case data changed
                if(currentStudentId) selectStudent(currentStudentId);
            }
        }

// --- 傳統填報模式 (Grid View) 核心邏輯 ---

        function renderGlobalGrid() {
            const thead = document.getElementById('grid-thead');
            const tbody = document.getElementById('grid-tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('grid-search').value.toLowerCase();
            const fields = currentYearConfig.fields || [];
            
            // 1. Build Header
            const fixedCols = [
                { id: 'student_id', label: '學號', width: '90px' },
                { id: 'student_name', label: '姓名', width: '80px' },
                { id: 'course_name', label: '課程名稱', width: '180px' }
            ];
            const dynamicCols = fields.filter(f => !f.isSystem && !CORE_FIELDS.includes(f.id));

            let trHead = document.createElement('tr');
            [...fixedCols, ...dynamicCols].forEach(col => {
                const th = document.createElement('th');
                th.innerText = col.label;
                th.style.minWidth = col.width || '100px';
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // 2. Build Rows
            Object.values(groupedStudents).forEach(student => {
                student.courses.forEach(course => {
                    const searchText = `${student.id} ${student.name} ${course.course_name||''} ${course.course_code||''}`.toLowerCase();
                    if (searchTerm && !searchText.includes(searchTerm)) return;

                    const tr = document.createElement('tr');
                    tr.dataset.sid = student.id;
                    tr.dataset.cid = course._internal_id; // Store IDs for easy lookup

                    const appId = course._app_id;
                    let appData = {};
                    if (appId) {
                        const app = student.applications.find(a => a.id === appId);
                        if (app) appData = app.formData;
                    }

                    // Fixed Columns
                    fixedCols.forEach(col => {
                        const td = document.createElement('td');
                        td.innerText = course[col.id] || student[col.id === 'student_id' ? 'id' : 'name'] || '';
                        td.className = "bg-slate-50 font-medium text-slate-600 select-none";
                        tr.appendChild(td);
                    });

                    // Input Columns
                    dynamicCols.forEach(f => {
                        const td = document.createElement('td');
                        
                        let val = "";
                        if (appId) {
                            val = appData[f.id] || "";
                            td.className = "is-linked"; 
                        } else {
                            val = course[f.id] || ""; 
                            td.className = "is-raw";
                        }
                        
                        let input;
                        if (f.type === 'single_select' || f.type === 'list') {
                            input = document.createElement('select');
                            input.innerHTML = `<option value="">-</option>` + (f.options||[]).map(o => `<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                        } else {
                            input = document.createElement('input');
                            input.type = "text";
                            input.value = val;
                        }

                        input.className = "grid-input";
                        
                        // 標記 class 方便連動更新找到它
                        if(appId) input.classList.add(`app-input-${appId}-${f.id}`);
                        
                        // 邏輯鎖定檢查 (Visibility)
                        // 使用 helper 檢查是否應該 disable
                        checkGridInputVisibility(input, f, appId ? appData : course);

                        // Event Handler: 使用 handleGridChange 處理邏輯
                        input.onchange = (e) => handleGridChange(e.target, student, course, f);

                        td.appendChild(input);
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            });
        }

        // 檢查單一格子的顯示邏輯
        function checkGridInputVisibility(input, fieldDef, dataContext) {
            if (fieldDef.visibilityRule) {
                const depVal = dataContext[fieldDef.visibilityRule.dep];
                let show = fieldDef.visibilityRule.action === 'show' ? depVal === fieldDef.visibilityRule.val : depVal !== fieldDef.visibilityRule.val;
                if (!show) {
                    input.disabled = true;
                    input.value = ""; 
                    input.style.opacity = "0.3";
                } else {
                    input.disabled = false;
                    input.style.opacity = "1";
                }
            }
        }

        // ★★★ 核心：處理格子變更 (不隨意 Re-render) ★★★
        function handleGridChange(inputEl, student, course, fieldDef) {
            const newVal = inputEl.value;
            const appId = course._app_id;
            hasUnsavedChanges = true;

            // 定義哪些欄位「不需要」觸發自動歸戶 (例如成績、學分、時數)
            // 這裡使用簡單的關鍵字排除法，您可以根據 config id 調整
            const isScoreField = ['score', 'grade', 'credit', 'hours', 'point', '成績', '學分', '時數'].some(k => fieldDef.id.toLowerCase().includes(k) || fieldDef.label.includes(k));

            if (appId) {
                // --- 情境 A: 已歸戶 (Linked) ---
                // 更新 App Data
                const app = student.applications.find(a => a.id === appId);
                if (app) {
                    const oldVal = app.formData[fieldDef.id];
                    app.formData[fieldDef.id] = newVal;
                    logChange(fieldDef.id, appId, oldVal, newVal, student.id);

                    // 同步更新畫面上所有連結到此 App 的格子
                    document.querySelectorAll(`.app-input-${appId}-${fieldDef.id}`).forEach(el => {
                        if (el !== inputEl) el.value = newVal; // 不要更新自己以免斷掉輸入體驗
                    });

                    // 觸發相依欄位的邏輯檢查 (例如改了"有實習"，"機構"要解鎖)
                    // 這裡簡單做：如果是有 visibilityRule 依賴此欄位的，重新檢查全表 (或是該 App 的 row)
                    // 為了效能與焦點，我們只重新 render 或是遍歷 DOM 檢查
                    // 簡單解法：如果修改的欄位是別人的依賴條件，才需要大動作，否則不用
                    const isDependency = (currentYearConfig.fields||[]).some(f => f.visibilityRule && f.visibilityRule.dep === fieldDef.id);
                    if(isDependency) {
                         // 只有當影響結構邏輯時，才不得已 Re-render，但會盡量避免
                         renderGlobalGrid();
                    }
                }
            } else {
                // --- 情境 B: 未歸戶 (Raw) ---
                
                // ★★★ 自動歸戶邏輯 ★★★
                // 如果填寫的不是成績欄位，且有值，就自動建立歸戶
                if (!isScoreField && newVal && newVal.trim() !== "") {
                    // 1. 建立新 App
                    const newAppId = 'app_auto_' + Date.now();
                    const initData = {};
                    
                    // 把目前這格的值放進去
                    initData[fieldDef.id] = newVal;
                    
                    // 把課程身上已有的其他 Raw Data 也搬進去 (如果有的話)
                    (currentYearConfig.fields||[]).forEach(f => {
                         if(course[f.id] && !initData[f.id]) initData[f.id] = course[f.id];
                    });

                    const newApp = { 
                        id: newAppId, 
                        courseIds: [course._internal_id], 
                        formData: initData 
                    };
                    
                    // 2. 綁定
                    student.applications.push(newApp);
                    course._app_id = newAppId;

                    // 3. 必須 Re-render 才能將此列變色 (變為藍色) 並綁定 class
                    // 這是狀態改變 (Raw -> Linked)，所以失去焦點是可接受的代價
                    renderGlobalGrid();
                    showToast('success', '已自動建立歸戶');
                    
                    logChange('AutoCreate', newAppId, '', 'Created from Grid', student.id);

                } else {
                    // 只是成績或清空資料，維持 Raw 狀態
                    course[fieldDef.id] = newVal;
                    
                    // 檢查 Raw 狀態下的邏輯鎖定 (針對該 Row)
                    const isDependency = (currentYearConfig.fields||[]).some(f => f.visibilityRule && f.visibilityRule.dep === fieldDef.id);
                    if(isDependency) renderGlobalGrid();
                }
            }
        }

        // --- Initialization ---
        window.onload = async function() {
            try {
                // 5. F5/Close Protection
                window.onbeforeunload = function (e) {
                    // If we have data loaded or changes made
                    if (allRawData.length > 0 || hasUnsavedChanges) {
                        const msg = "您有未儲存的資料，確定要離開嗎？";
                        e.returnValue = msg;
                        return msg;
                    }
                };

                // Load static configs
                const [cfgRes, deptRes, masterRes] = await Promise.all([
                    fetch('config.json').then(r => r.ok ? r.json() : {}),
                    fetch('data_departments.json').then(r => r.ok ? r.json() : []),
                    fetch('data_dept_master.json').then(r => r.ok ? r.json() : {})
                ]);

                globalConfig = cfgRes;
                departmentData = deptRes;
                deptMasterData = masterRes;

                const yearSelect = document.getElementById('year-select');
                yearSelect.innerHTML = '<option value="">請選擇學年度...</option>';
                
                if (globalConfig.academicYears && globalConfig.academicYears.length > 0) {
                    globalConfig.academicYears.sort((a,b) => b.year.localeCompare(a.year));
                    globalConfig.academicYears.forEach(y => {
                        const opt = document.createElement('option');
                        opt.value = y.year;
                        opt.innerText = `${y.year} 學年度`;
                        yearSelect.appendChild(opt);
                    });
                } else {
                    yearSelect.innerHTML = '<option value="">無設定</option>';
                }

                updateFooterYear();

            } catch (e) {
                console.error("Init failed", e);
                showToast('error', '系統初始化失敗');
            }
        };

        function updateFooterYear() {
            const startYear = 2025;
            const currentYear = new Date().getFullYear();
            const yearSpan = document.getElementById('copyright-year');
            if (yearSpan) {
                yearSpan.innerText = currentYear > startYear ? `${startYear}-${currentYear}` : `${startYear}`;
            }
        }

        // --- Font Size & Sidebar Toggle ---
        // 修正 2: 同步修改 html 根元素字體大小
        function setFontSize(size) {
            document.documentElement.style.setProperty('--base-size', size);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // --- Logic: Year Template ---
        async function changeYear(year) {
            if(!year) return;
            activeYear = year;
            showToast('info', `載入 ${year} 學年度設定...`);
            
            try {
                const res = await fetch(`year_templates/year_${year}_templates.json?t=${Date.now()}`);
                if (!res.ok) throw new Error("Template not found");
                currentYearConfig = await res.json();
                
                // If we have data, re-render current view
                if (currentStudentId) {
                    selectStudent(currentStudentId); 
                }
                showToast('success', `已切換至 ${year} 學年度`);
            } catch (e) {
                console.error(e);
                showToast('error', `無法讀取 ${year} 學年度模板`);
            }
        }

        // --- Logic: File Import (Using ExcelJS for hidden sheet support) ---
        async function handleFileUpload(event) {
            // 2. Alert on file overwrite (Using Custom Modal)
            if(allRawData.length > 0) {
                const confirmOverwrite = await showConfirm('確認覆蓋？', '確定要匯入新檔案嗎？這將會清除目前的資料與歸戶設定。');
                if(!confirmOverwrite) {
                    event.target.value = '';
                    return;
                }
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);

                    // 1. Read Metadata (ID Mapping)
                    let fieldMap = {}; // Label -> ID
                    const metaSheet = workbook.getWorksheet('_System_Metadata');
                    if (metaSheet) {
                        metaSheet.eachRow((row, rowNumber) => {
                            if (rowNumber > 1) { // Skip header
                                const id = row.getCell(1).value;
                                const label = row.getCell(2).value;
                                if (id && label) fieldMap[label] = id;
                            }
                        });
                        console.log("Loaded Metadata:", fieldMap);
                    }

                    // 2. Read Main Data
                    // Usually first visible sheet
                    let mainSheet = null;
                    workbook.eachSheet((sheet) => {
                        if (!mainSheet && sheet.state === 'visible') mainSheet = sheet;
                    });
                    if (!mainSheet) mainSheet = workbook.getWorksheet(1); // Fallback

                    const jsonData = [];
                    const headers = [];
                    mainSheet.getRow(1).eachCell((cell, colNumber) => {
                        headers[colNumber] = cell.value;
                    });

                    mainSheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const rowData = {};
                            row.eachCell((cell, colNumber) => {
                                let header = headers[colNumber];
                                // Apply ID mapping
                                if (fieldMap[header]) header = fieldMap[header];
                                rowData[header] = cell.value;
                            });
                            if(Object.keys(rowData).length > 0) jsonData.push(rowData);
                        }
                    });

                    // 3. Read Consolidation Data
                    let savedApps = [];
                    const conSheet = workbook.getWorksheet('_Consolidation_Data');
                    if (conSheet) {
                        const conHeaders = [];
                        conSheet.getRow(1).eachCell((cell, colNumber) => {
                            conHeaders[colNumber] = cell.value;
                        });
                        conSheet.eachRow((row, rowNumber) => {
                            if (rowNumber > 1) {
                                const rowData = {};
                                row.eachCell((cell, colNumber) => {
                                    rowData[conHeaders[colNumber]] = cell.value;
                                });
                                savedApps.push({
                                    id: rowData['App_ID'],
                                    studentId: rowData['Student_ID'],
                                    courseIds: rowData['Course_IDs'] ? rowData['Course_IDs'].toString().split(',') : [],
                                    formData: rowData['Form_Data'] ? JSON.parse(rowData['Form_Data']) : {}
                                });
                            }
                        });
                        console.log("Restored Apps:", savedApps);
                    }
                    
                    // 4. Read Audit Log
                    const logSheet = workbook.getWorksheet('_Audit_Log');
                    if (logSheet) {
                        const logHeaders = [];
                        logSheet.getRow(1).eachCell((c, i) => logHeaders[i] = c.value);
                        logSheet.eachRow((r, i) => {
                            if(i > 1) {
                                const l = {};
                                r.eachCell((c, idx) => l[logHeaders[idx]] = c.value);
                                changeLogs.push(l);
                            }
                        });
                    }

                    if (jsonData.length === 0) throw new Error("檔案無內容");
                    
                    // 關鍵修正 1：使用 await 確保 changeYear 完成後才呼叫 processUploadedData
                    await processUploadedData(jsonData, savedApps);
                    
                    event.target.value = ''; 
                } catch (err) {
                    console.error(err);
                    showToast('error', `讀取失敗: ${err.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processUploadedData(data, savedApps = []) {
            allRawData = data;
            groupedStudents = {};
            
            let detectedYear = null;

            if (data.length > 0) {
                // 優先從 common ID 取得，如果沒有則從中文 Label 取得
                const firstRow = data[0];
                detectedYear = firstRow['school_year'] || firstRow['academic_year'] || firstRow['學年'] || null;

                if (detectedYear) {
                    detectedYear = detectedYear.toString().trim();
                    const yearSelect = document.getElementById('year-select');
                    const opt = Array.from(yearSelect.options).find(o => o.value === detectedYear);
                    if (opt) {
                        yearSelect.value = detectedYear;
                        // 必須使用 await 確保配置檔載入完畢，否則後續 ID 命名會使用舊的配置
                        await changeYear(detectedYear); 
                        showToast('info', `已自動切換至 ${detectedYear} 學年度`);
                    }
                }
            }

            const courseDepts = new Set();
            const studentDepts = new Set();
            
            // Pre-scan to build course counters per student for stable IDs
            const courseCounters = {}; // { "sid_year_sem_code": count }

            allRawData.forEach((row, idx) => {
                const sid = row['student_id'] || row['學號'] || row['id'];
                const sname = row['student_name'] || row['姓名'] || row['name'];
                const sdept = row['student_dept'] || row['系所'] || row['department'];
                const cdept = row['course_dept'] || row['開課系所'];
                
                if (sdept) studentDepts.add(sdept);
                if (cdept) courseDepts.add(cdept);

                if (!sid) return;

                if (!groupedStudents[sid]) {
                    let deptDisplay = sdept;
                    if (deptMasterData && deptMasterData[sdept]) {
                        const y = activeYear || '114';
                        const master = deptMasterData[sdept];
                        deptDisplay = (master.historical_names && master.historical_names[y]) || master.short_name || master.name || sdept;
                    }

                    groupedStudents[sid] = {
                        id: sid,
                        name: sname || '未知',
                        dept: deptDisplay || '',
                        courses: [],
                        applications: [] 
                    };
                }
                
                // 3. 核心修正：Course_IDs 改用 {學年}{學期}_{選課代號}
                // 這將作為歸戶的穩定 Key，不受 Excel 欄位順序影響
                const rYear = row['school_year'] || row['學年'] || row['academic_year'];
                const rSem = row['semester'] || row['學期'];
                const rCode = row['course_code'] || row['選課代號'];
                
                if (rYear && rSem && rCode) {
                     // 移除空白並確保格式
                     const safeYear = rYear.toString().trim();
                     const safeSem = rSem.toString().trim();
                     const safeCode = rCode.toString().trim();
                     
                     // 生成 Course ID: {學年}{學期}_{選課代號}
                     // 例如: 1141_1363
                     // 若同一學生修了同一門課兩次(極少見)，則加上計數器
                     const baseKey = `${sid}_${safeYear}${safeSem}_${safeCode}`;
                     if (!courseCounters[baseKey]) courseCounters[baseKey] = 0;
                     courseCounters[baseKey]++;
                     
                     let stableId = `${safeYear}${safeSem}_${safeCode}`;
                     
                     // 如果發現重複 (同一個學生修同一門課多次)，才加上後綴
                     if (courseCounters[baseKey] > 1) {
                         stableId += `_${courseCounters[baseKey]}`;
                     }
                     
                     row._internal_id = stableId;
                } else {
                     // Fallback: 如果缺資料，使用索引，但會標記警告
                     // console.warn('缺少關鍵課程欄位 (學年/學期/選課代號)，使用臨時 ID');
                     row._internal_id = `temp_c_${idx}`;
                }

                row._app_id = null; 
                groupedStudents[sid].courses.push(row);
            });

            // Restore Apps Logic
            if (savedApps && savedApps.length > 0) {
                savedApps.forEach(app => {
                    const student = groupedStudents[app.studentId];
                    if (student) {
                        const validCourseIds = [];
                        app.courseIds.forEach(cid => {
                             // 關鍵修正 4: 使用更寬鬆的 matching 邏輯
                             const exists = student.courses.find(c => c._internal_id === cid);
                             if(exists) {
                                 validCourseIds.push(cid);
                                 exists._app_id = app.id;
                             }
                        });

                        if(validCourseIds.length > 0) {
                             student.applications.push({
                                 id: app.id,
                                 courseIds: validCourseIds,
                                 formData: app.formData
                             });
                        }
                    }
                });
                showToast('success', `已還原 ${savedApps.length} 筆歸戶設定`);
            }

            const renderOpts = (elId, set) => {
                const el = document.getElementById(elId);
                const current = el.value;
                el.innerHTML = el.options[0].outerHTML; 
                Array.from(set).sort().forEach(v => {
                    el.innerHTML += `<option value="${v}">${v}</option>`;
                });
                el.value = current;
            };
            renderOpts('filter-course-dept', courseDepts);
            renderOpts('filter-student-dept', studentDepts);

            renderStudentList();
            
            // Reset unsaved changes flag after load
            hasUnsavedChanges = false;
        }

        function renderStudentList() {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            const term = document.getElementById('search-input').value.toLowerCase();
            const fCourseDept = document.getElementById('filter-course-dept').value;
            const fStudentDept = document.getElementById('filter-student-dept').value;
            const fStatus = document.getElementById('filter-status').value;

            let students = Object.values(groupedStudents);
            
            students = students.filter(s => {
                const matchText = s.id.toLowerCase().includes(term) || s.name.toLowerCase().includes(term);
                if (!matchText) return false;

                const hasStudentDept = !fStudentDept || s.courses.some(c => (c['student_dept'] || c['系所']) === fStudentDept);
                if(!hasStudentDept) return false;

                const hasCourseDept = !fCourseDept || s.courses.some(c => (c['course_dept'] || c['開課系所']) === fCourseDept);
                if(!hasCourseDept) return false;

                if (fStatus === 'completed' && s.applications.length === 0) return false;
                if (fStatus === 'pending' && s.applications.length > 0) return false;

                return true;
            });
            
            students.sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                const comp = valA.localeCompare(valB, undefined, {numeric: true, sensitivity: 'base'});
                return sortConfig.direction === 'asc' ? comp : -comp;
            });

            document.getElementById('student-count').innerText = students.length;

            if (students.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400 text-sm">無符合資料</div>';
                return;
            }

            students.forEach(s => {
                const el = document.createElement('div');
                el.className = `student-item p-3 pl-4 border-b border-slate-100 ${currentStudentId === s.id ? 'active' : ''}`;
                el.onclick = () => selectStudent(s.id);
                
                const appCount = s.applications.length;
                const totalCourses = s.courses.length;
                const statusHtml = appCount > 0 
                    ? `<span class="bg-green-100 text-success text-[10px] px-1.5 py-0.5 rounded font-bold">${appCount} 筆填報</span>` 
                    : `<span class="bg-slate-100 text-slate-400 text-[10px] px-1.5 py-0.5 rounded">未開始</span>`;

                el.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-slate-700 text-sm student-name">${s.name}</div>
                            <div class="text-xs text-slate-500 font-mono">${s.id}</div>
                        </div>
                        <div class="text-right">
                            ${statusHtml}
                            <div class="text-[10px] text-slate-400 mt-1">${totalCourses} 門課</div>
                        </div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        function filterStudentList() { renderStudentList(); }
        
        function toggleSort(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            
            const iconClass = sortConfig.direction === 'asc' ? 
                (key === 'id' ? 'fa-sort-numeric-down' : 'fa-sort-alpha-down') : 
                (key === 'id' ? 'fa-sort-numeric-up' : 'fa-sort-alpha-up');
            
            document.querySelectorAll('#sort-id-btn i, #sort-name-btn i').forEach(i => {
                if (i.parentElement.id === `sort-${key}-btn`) {
                    i.className = `fas ${iconClass}`;
                    i.parentElement.classList.add('text-primary', 'bg-slate-100');
                } else {
                    const otherKey = key === 'id' ? 'name' : 'id';
                    const defaultIcon = otherKey === 'id' ? 'fa-sort-numeric-down' : 'fa-sort-alpha-down';
                    i.className = `fas ${defaultIcon} opacity-50`;
                    i.parentElement.classList.remove('text-primary', 'bg-slate-100');
                }
            });

            renderStudentList();
        }

        function selectStudent(sid) {
            currentStudentId = sid;
            renderStudentList(); 
            
            const student = groupedStudents[sid];
            document.getElementById('form-empty-state').classList.add('hidden');
            document.getElementById('form-container').classList.remove('hidden');
            
            document.getElementById('header-name').innerText = student.name;
            document.getElementById('header-id').innerText = student.id;
            document.getElementById('header-dept').innerHTML = `<i class="fas fa-graduation-cap mr-1"></i>${student.dept}`;
            document.getElementById('header-avatar').innerText = student.name[0] || '?';
            
            const appCount = student.applications.length;
            const statusEl = document.getElementById('header-status');
            statusEl.innerText = appCount > 0 ? `已建立 ${appCount} 筆歸戶` : '未填報';
            statusEl.className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${appCount > 0 ? 'bg-green-100 text-success' : 'bg-slate-100 text-slate-500'}`;

            renderTabs(student);
            
            if (appCount > 0) switchTab(student.applications[0].id);
            else switchTab('settings');
            
            renderSettingsTab(student);
        }

        function renderTabs(student) {
            const container = document.getElementById('tabs-container');
            // Reset contents but keep the Settings tab button
            container.innerHTML = `<button class="tab-btn active" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 歸戶設定</button>`;
            
            student.applications.forEach((app, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.dataset.tab = app.id;
                btn.onclick = () => switchTab(app.id);
                
                // 修改: 頁籤名稱統一為 "實習紀錄{流水號}"
                let label = `實習紀錄${idx+1}`;
                
                btn.innerHTML = `<i class="fas fa-file-alt text-slate-400 mr-1"></i> ${label}`;
                container.appendChild(btn);
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if(btn) btn.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('dynamic-tabs-area').style.display = 'none';

            if (tabId === 'settings') {
                document.getElementById('tab-settings').classList.add('active');
                if(currentStudentId) renderSettingsTab(groupedStudents[currentStudentId]);
            } else {
                document.getElementById('dynamic-tabs-area').style.display = 'block';
                let content = document.getElementById(`content-${tabId}`);
                if (!content) {
                    content = createApplicationContent(tabId);
                    document.getElementById('dynamic-tabs-area').appendChild(content);
                }
                document.querySelectorAll('.dynamic-tab-content').forEach(d => d.style.display = 'none');
                content.style.display = 'block';
            }
        }

        function renderSettingsTab(student) {
            const listContainer = document.getElementById('settings-course-list');
            const appsContainer = document.getElementById('app-management-list');
            listContainer.innerHTML = '';
            appsContainer.innerHTML = '';

            // --- 左側：未歸戶課程列表 ---
            const unassigned = student.courses.filter(c => !c._app_id);
            if (unassigned.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-slate-400 py-3 text-sm bg-white rounded border border-dashed">所有課程皆已歸戶</div>';
            } else {
                unassigned.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'course-card';
                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-sm text-slate-700">${c['course_name'] || c['課程名稱']}</div>
                            <div class="text-xs text-slate-500">${c['semester'] ? `第${c['semester']}學期` : ''} <span class="mx-1">|</span> ${c['course_code'] || c['選課代號'] || '無代號'}</div>
                        </div>
                        <input type="checkbox" class="course-select-check w-5 h-5 text-primary rounded focus:ring-primary cursor-pointer" value="${c._internal_id}">
                    `;
                    el.onclick = (e) => {
                        if(e.target.type !== 'checkbox') {
                            const cb = el.querySelector('input');
                            cb.checked = !cb.checked;
                            el.classList.toggle('selected', cb.checked);
                        }
                    };
                    el.querySelector('input').onclick = (e) => {
                        e.target.parentElement.classList.toggle('selected', e.target.checked);
                        e.stopPropagation();
                    };
                    listContainer.appendChild(el);
                });
            }

            // --- 右側：已建立的填報單 ---
            if (student.applications.length === 0) {
                appsContainer.innerHTML = '<div class="text-center text-slate-400 py-3 text-sm bg-white rounded border border-dashed">尚未建立任何實習填報單</div>';
            } else {
                student.applications.forEach((app, idx) => {
                    const el = document.createElement('div');
                    el.className = 'bg-white border border-slate-200 rounded-lg p-4 shadow-sm flex flex-col gap-3';
                    
                    // 標題邏輯
                    const instName = app.formData['internship_institution_name'];
                    const titleText = instName ? `實習紀錄${idx+1}：${instName}` : `實習紀錄${idx+1}`;
                    
                    // 產生課程表格 Row (使用 Helper 抓取欄位)
                    const courseRows = app.courseIds.map(cid => {
                        const c = student.courses.find(x => x._internal_id === cid);
                        if (!c) return '';
                        
                        const sem = getCourseValue(c, ['semester', '學期']);
                        const code = getCourseValue(c, ['course_code', '選課代號']);
                        const name = getCourseValue(c, ['course_name', '課程名稱', '科目名稱']);
                        // 增加多種關鍵字偵測
                        const type = getCourseValue(c, ['course_type', '修別', '選必修', '必選修', '部別']); 
                        const credits = getCourseValue(c, ['credits', '學分', '學分數']);

                        return `
                            <tr class="border-t border-slate-100 hover:bg-slate-50">
                                <td class="px-2 py-1.5 text-center">${sem}</td>
                                <td class="px-2 py-1.5 font-mono text-slate-600">${code}</td>
                                <td class="px-2 py-1.5 font-medium text-slate-800">${name}</td>
                                <td class="px-2 py-1.5 text-center text-slate-500">${type}</td>
                                <td class="px-2 py-1.5 text-center text-slate-500">${credits}</td>
                            </tr>
                        `;
                    }).join('');

                    const tableHtml = `
                        <div class="overflow-x-auto border border-slate-200 rounded-md">
                            <table class="w-full text-xs text-left">
                                <thead class="bg-slate-50 text-slate-500 font-medium">
                                    <tr>
                                        <th class="px-2 py-1.5 text-center w-12">學期</th>
                                        <th class="px-2 py-1.5 w-20">代號</th>
                                        <th class="px-2 py-1.5">課程名稱</th>
                                        <th class="px-2 py-1.5 text-center w-16">屬性</th>
                                        <th class="px-2 py-1.5 text-center w-12">學分</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    ${courseRows}
                                </tbody>
                            </table>
                        </div>
                    `;

                    el.innerHTML = `
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-primary text-sm flex items-center gap-2">
                                <i class="fas fa-folder-open text-indigo-200"></i> ${titleText}
                            </h4>
                            <div class="flex gap-2">
                                <button onclick="switchTab('${app.id}')" class="text-xs font-bold text-indigo-600 hover:bg-indigo-50 px-2 py-1.5 rounded transition"><i class="fas fa-edit"></i> 編輯</button>
                                <button onclick="deleteApplication('${app.id}')" class="text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1.5 rounded transition"><i class="fas fa-trash-alt"></i> 解除</button>
                            </div>
                        </div>
                        ${tableHtml}
                    `;
                    appsContainer.appendChild(el);
                });
            }
        }

        function createApplication() {
            const student = groupedStudents[currentStudentId];
            const checkboxes = document.querySelectorAll('.course-select-check:checked');
            if (checkboxes.length === 0) return showToast('error', '請先勾選至少一門課程');

            const ids = Array.from(checkboxes).map(cb => cb.value);
            const appId = 'app_' + Date.now();
            
            const firstC = student.courses.find(c => c._internal_id === ids[0]);
            const initData = {};
            
            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach(f => {
                    if (!CORE_FIELDS.includes(f.id) && !f.isSystem) {
                        const val = firstC[f.id] || firstC[f.label];
                        if (val) initData[f.id] = val;
                    }
                });
            }

            const newApp = { id: appId, courseIds: ids, formData: initData };
            ids.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = appId;
            });

            student.applications.push(newApp);
            
            hasUnsavedChanges = true; // Mark changes
            
            renderTabs(student);
            renderSettingsTab(student);
            renderStudentList(); 
            showToast('success', '已建立填報單');
            
            logChange('CreateApp', appId, '', 'Created', student.id);
        }

        async function deleteApplication(appId) {
            // 4. 詢問是否要刪除紀錄的時候，要改用內建提示框 (Custom Modal)
            // Used custom showConfirm instead of window.confirm
            const confirmed = await showConfirm('確認刪除？', '確定要解除此歸戶嗎？填寫的資料將會遺失。');
            if (!confirmed) return;
            
            const student = groupedStudents[currentStudentId];
            const idx = student.applications.findIndex(a => a.id === appId);
            if (idx === -1) return;

            const app = student.applications[idx];
            app.courseIds.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = null;
            });

            student.applications.splice(idx, 1);
            
            hasUnsavedChanges = true; // Mark changes

            const dom = document.getElementById(`content-${appId}`);
            if(dom) dom.remove();

            renderTabs(student);
            renderSettingsTab(student);
            renderStudentList();
            showToast('success', '歸戶已解除');
            
            logChange('DeleteApp', appId, 'Existing', 'Deleted', student.id);
        }

        function createApplicationContent(appId) {
            const student = groupedStudents[currentStudentId];
            const app = student.applications.find(a => a.id === appId);
            
            const div = document.createElement('div');
            div.id = `content-${appId}`;
            div.className = 'dynamic-tab-content max-w-5xl mx-auto space-y-6';
            
            // --- 課程資訊區塊 (可收合) ---
            // 使用 <details> 標籤實現收合，預設 open
            const details = document.createElement('details');
            details.className = 'group bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden';
            details.open = true; // 預設展開
            
            // Summary (標題列)
            // list-none 用於隱藏預設的三角形 (某些瀏覽器需要 CSS 輔助)
            const summary = document.createElement('summary');
            summary.className = 'flex items-center justify-between px-6 py-4 cursor-pointer bg-slate-50 hover:bg-slate-100 transition select-none list-none';
            summary.style.listStyle = 'none'; // 強制隱藏預設 marker
            summary.innerHTML = `
                <h3 class="font-bold text-sm text-slate-700 flex items-center gap-2">
                    <i class="fas fa-info-circle text-primary"></i> 此紀錄包含之課程資訊
                </h3>
                <span class="transition-transform duration-300 group-open:rotate-180 text-slate-400">
                    <i class="fas fa-chevron-down"></i>
                </span>
            `;
            
            // 隱藏 Chrome 預設的 details marker
            const style = document.createElement('style');
            style.innerHTML = 'summary::-webkit-details-marker { display: none; }';
            details.appendChild(style);
            details.appendChild(summary);

            // Table Content
            const tableContainer = document.createElement('div');
            tableContainer.className = 'p-0 border-t border-slate-200';

            const courseRows = app.courseIds.map(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if (!c) return '';
                
                // 使用 Helper 抓取值
                const sem = getCourseValue(c, ['semester', '學期']);
                const code = getCourseValue(c, ['course_code', '選課代號']);
                const name = getCourseValue(c, ['course_name', '課程名稱', '科目名稱']);
                const type = getCourseValue(c, ['course_type', '修別', '選必修', '必選修']);
                const credits = getCourseValue(c, ['credits', '學分', '學分數']);

                return `
                    <tr class="border-t border-slate-100 hover:bg-slate-50">
                        <td class="px-4 py-2 text-center text-slate-600">${sem}</td>
                        <td class="px-4 py-2 font-mono text-slate-600">${code}</td>
                        <td class="px-4 py-2 font-bold text-slate-800">${name}</td>
                        <td class="px-4 py-2 text-center text-slate-600">${type}</td>
                        <td class="px-4 py-2 text-center text-slate-600">${credits}</td>
                    </tr>
                `;
            }).join('');

            tableContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 font-bold">
                            <tr>
                                <th class="px-4 py-2 text-center w-20">學期</th>
                                <th class="px-4 py-2 w-28">選課代號</th>
                                <th class="px-4 py-2">課程名稱</th>
                                <th class="px-4 py-2 text-center w-24">課程屬性</th>
                                <th class="px-4 py-2 text-center w-20">學分</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white">
                            ${courseRows}
                        </tbody>
                    </table>
                </div>
            `;
            details.appendChild(tableContainer);
            div.appendChild(details);

            // --- 表單區塊 (恢復舊版全寬樣式) ---
            const formContainer = document.createElement('div');
            // 移除 bg-white, shadow, border 等樣式，只保留 layout 必要的
            formContainer.className = 'form-body pt-2'; 
            
            renderFields(formContainer, app);
            div.appendChild(formContainer);

            return div;
        }

        function createRocDatePicker(appId, fieldId, initialValue, onChange) {
            const wrapper = document.createElement('div');
            wrapper.className = 'date-picker-wrapper';
            wrapper.id = `roc-container-${appId}-${fieldId}`;

            const inputGroup = document.createElement('div');
            inputGroup.className = 'date-input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-stylish';
            input.placeholder = '例: 114/01/01';
            input.maxLength = 10; 
            input.style.flex = "1";
            input.style.paddingRight = "35px"; 

            const trigger = document.createElement('div');
            trigger.className = 'date-picker-trigger';
            trigger.innerHTML = '<i class="fas fa-calendar-alt"></i>';
            trigger.onclick = (e) => {
                e.stopPropagation();
                toggleCalendar();
            };

            inputGroup.appendChild(input);
            inputGroup.appendChild(trigger);

            const popover = document.createElement('div');
            popover.className = 'calendar-popover';
            
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth(); 
            let selectedDate = null; 

            const renderCalendar = () => {
                const rocYear = currentYear - 1911;
                const monthName = currentMonth + 1;
                
                let html = `
                    <div class="cal-header">
                        <div class="cal-btn" id="prev-month"><i class="fas fa-chevron-left"></i></div>
                        <div class="cal-title">${rocYear}年 ${monthName}月</div>
                        <div class="cal-btn" id="next-month"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="cal-grid">
                        <div class="cal-day-header">日</div><div class="cal-day-header">一</div><div class="cal-day-header">二</div><div class="cal-day-header">三</div><div class="cal-day-header">四</div><div class="cal-day-header">五</div><div class="cal-day-header">六</div>
                `;

                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date();

                for(let i=0; i<firstDay; i++) html += `<div class="cal-day empty"></div>`;

                for(let d=1; d<=daysInMonth; d++) {
                    let classes = 'cal-day';
                    if(currentYear === today.getFullYear() && currentMonth === today.getMonth() && d === today.getDate()) classes += ' today';
                    if(selectedDate && currentYear === selectedDate.getFullYear() && currentMonth === selectedDate.getMonth() && d === selectedDate.getDate()) classes += ' selected';
                    html += `<div class="${classes}" data-day="${d}">${d}</div>`;
                }

                html += `</div>`; 
                popover.innerHTML = html;

                popover.querySelector('#prev-month').onclick = (e) => { e.stopPropagation(); currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); };
                popover.querySelector('#next-month').onclick = (e) => { e.stopPropagation(); currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); };
                popover.querySelectorAll('.cal-day:not(.empty)').forEach(el => {
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const d = parseInt(el.dataset.day);
                        selectedDate = new Date(currentYear, currentMonth, d);
                        const rocY = currentYear - 1911;
                        const mm = String(currentMonth + 1).padStart(2, '0');
                        const dd = String(d).padStart(2, '0');
                        const formatted = `${rocY}/${mm}/${dd}`;
                        input.value = formatted;
                        const stdVal = `${currentYear}-${mm}-${dd}`;
                        onChange(stdVal); 
                        popover.classList.remove('active');
                    };
                });
            };

            const toggleCalendar = () => {
                const isActive = popover.classList.contains('active');
                document.querySelectorAll('.calendar-popover.active').forEach(p => p.classList.remove('active')); 
                if(!isActive) {
                    if(input.value) {
                        let y, m, d;
                        const val = input.value.replace(/\//g, '');
                        if(val.length >= 6) { 
                            if(val.includes('-')) {
                                const p = val.split('-');
                                y = parseInt(p[0]); m = parseInt(p[1])-1; d = parseInt(p[2]);
                            } else {
                                if(val.length === 7) {
                                    y = parseInt(val.substring(0,3)) + 1911;
                                    m = parseInt(val.substring(3,5)) - 1;
                                    d = parseInt(val.substring(5,7));
                                } else if (val.length === 6) { 
                                    y = parseInt(val.substring(0,2)) + 1911;
                                    m = parseInt(val.substring(2,4)) - 1;
                                    d = parseInt(val.substring(4,6));
                                }
                            }
                            if(y && !isNaN(m) && d) {
                                currentYear = y;
                                currentMonth = m;
                                selectedDate = new Date(y, m, d);
                            }
                        }
                    }
                    renderCalendar();
                    popover.classList.add('active');
                }
            };

            input.onchange = (e) => {
                const val = e.target.value.trim();
                const cleanVal = val.replace(/\//g, '');
                if (cleanVal.length >= 6 && !isNaN(cleanVal)) {
                    let rocY, mm, dd;
                    if(cleanVal.length === 7) {
                        rocY = parseInt(cleanVal.substring(0,3));
                        mm = cleanVal.substring(3,5);
                        dd = cleanVal.substring(5,7);
                    } else if (cleanVal.length === 6) {
                         rocY = parseInt(cleanVal.substring(0,2));
                         mm = cleanVal.substring(2,4);
                         dd = cleanVal.substring(4,6);
                    }
                    if (rocY && mm && dd) {
                        input.value = `${rocY}/${mm}/${dd}`;
                        const westY = rocY + 1911;
                        onChange(`${westY}-${mm}-${dd}`);
                    } else {
                        onChange(val); 
                    }
                } else if (val === "") {
                    onChange("");
                } else {
                    onChange(val); 
                }
            };

            if(initialValue) {
                if(initialValue.includes('-')) {
                    const p = initialValue.split('-');
                    if(p.length === 3) {
                        const roc = parseInt(p[0]) - 1911;
                        input.value = `${roc}/${p[1]}/${p[2]}`;
                    } else {
                        input.value = initialValue;
                    }
                } else {
                    input.value = initialValue;
                }
            }

            document.addEventListener('click', (e) => {
                if(!wrapper.contains(e.target)) {
                    popover.classList.remove('active');
                }
            });

            wrapper.appendChild(inputGroup);
            wrapper.appendChild(popover);
            return wrapper;
        }

        function cnToNum(cnStr) {
            const units = { '': 1, '十': 10 };
            const nums = { '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9, '零': 0 };
            let result = 0;
            let temp = 0;

            for (let i = 0; i < cnStr.length; i++) {
                const char = cnStr[i];
                if (nums[char] !== undefined) {
                    temp = nums[char];
                } else if (units[char] === 10) {
                    result += (temp || 1) * units[char];
                    temp = 0;
                }
            }
            result += temp;
            return result;
        }

        function processAddress(inputEl, settings) {
            let val = inputEl.value;
            if(!val) return;

            if(settings.toHalf) {
                val = val.replace(/[\uff01-\uff5e]/g, function(ch) { return String.fromCharCode(ch.charCodeAt(0) - 0xfee0); }).replace(/　/g, " ");
            }

            if(settings.forceTai) {
                val = val.replace(/台/g, '臺'); 
            }

            if(settings.latinToEng) {
                val = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            if(settings.smartFormat) {
                const cnNumsPattern = '(一|二|三|四|五|六|七|八|九|十|零)+';
                const keywords = (globalConfig.addressRules && globalConfig.addressRules.keywords) ? globalConfig.addressRules.keywords : ['段', '路', '街', '巷', '弄', '號', '樓'];
                
                keywords.forEach(k => {
                    const regex = new RegExp(`(${cnNumsPattern})${k}`, 'g');
                    val = val.replace(regex, (match, p1) => {
                        let num = 0;
                        const isLiteral = p1.includes('零') || (p1.length >= 2 && !p1.includes('十'));
                        if (isLiteral) {
                             let tempStr = "";
                             const literalMap = { '一': '1', '二': '2', '三': '3', '四': '4', '五': '5', '六': '6', '七': '7', '八': '8', '九': '9', '零': '0', '十': '10' }; 
                             for (let char of p1) if (literalMap[char]) tempStr += literalMap[char];
                             num = parseInt(tempStr);
                        } else {
                             num = cnToNum(p1);
                        }
                        const isProtected = (globalConfig.addressRules && globalConfig.addressRules.protected) ? globalConfig.addressRules.protected.includes(match.replace(p1, '').trim()) : false;
                        if (num > 0 && !isProtected) return `${num}${k}`;
                        return match;
                    });
                });
            }

            if(val !== inputEl.value) {
                inputEl.value = val;
                inputEl.dispatchEvent(new Event('change'));
            }
        }

        function renderFields(container, app) {
            const fields = currentYearConfig.fields || [];
            
            const visibleFields = fields.filter(f => 
                !f.isSystem && !CORE_FIELDS.includes(f.id) && f.category !== 'sys_course_info' && f.category !== 'sys_student_info'
            );

            if (visibleFields.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400">無須填報欄位</div>';
                return;
            }

            const categories = globalConfig.templateCategories || [];
            const fieldsByCat = {};
            const sortedFields = [...visibleFields].sort((a,b) => (a.order||0) - (b.order||0));

            sortedFields.forEach(f => {
                const cat = f.category || 'uncategorized';
                if(!fieldsByCat[cat]) fieldsByCat[cat] = [];
                fieldsByCat[cat].push(f);
            });

            const sortedCats = [...categories].sort((a,b) => a.order - b.order);
            if(fieldsByCat['uncategorized']) sortedCats.push({id: 'uncategorized', name: '其他資訊'});

            sortedCats.forEach(catDef => {
                const catFields = fieldsByCat[catDef.id];
                if(!catFields || catFields.length === 0) return;

                const title = document.createElement('h4');
                title.className = 'form-section-title';
                title.innerText = catDef.name;
                container.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-6'; 

                catFields.forEach(f => {
                    const wrapper = document.createElement('div');
                    wrapper.className = `field-group ${f.id}-wrapper`; 
                    wrapper.id = `wrapper-${app.id}-${f.id}`;
                    
                    const label = document.createElement('label');
                    label.className = "block text-sm font-bold text-slate-700 mb-1 flex items-center";
                    label.innerHTML = `${f.label} ${f.required ? '<span class="text-red-500">*</span>' : ''}`;
                    
                    if(f.description) {
                        label.innerHTML += `<div class="tooltip-container"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">${f.description}</span></div>`;
                    }
                    wrapper.appendChild(label);

                    const val = app.formData[f.id] || '';
                    let input;

                    if (f.type === 'date' && f.inputFormat === 'ROC') {
                        input = createRocDatePicker(app.id, f.id, val, (newValue) => {
                            const oldVal = app.formData[f.id];
                            app.formData[f.id] = newValue;
                            evaluateLogic(app);
                            hasUnsavedChanges = true;
                            logChange(f.id, appId, oldVal, newValue, groupedStudents[currentStudentId].id);
                        });
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.id = `input-${app.id}-${f.id}`;
                        wrapper.appendChild(hidden);
                    } else {
                        if (f.type === 'single_select' || f.type === 'list') {
                            input = document.createElement('select');
                            input.className = "input-stylish cursor-pointer";
                            input.innerHTML = `<option value="">請選擇...</option>` + (f.options||[]).map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
                        } else if (f.type === 'date') {
                            input = document.createElement('input');
                            input.type = 'date';
                            input.className = "input-stylish";
                            input.value = val;
                        } else if (f.type === 'number') {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.className = "input-stylish";
                            input.step = f.decimal ? '0.01' : '1';
                            input.value = val;
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.className = "input-stylish";
                            input.value = val;
                        }

                        input.id = `input-${app.id}-${f.id}`; 

                        if (f.type === 'address') {
                            input.addEventListener('blur', (e) => {
                                const oldVal = input.value;
                                processAddress(e.target, f);
                                const newVal = e.target.value;
                                if(oldVal !== newVal) {
                                    app.formData[f.id] = newVal;
                                    evaluateLogic(app);
                                    hasUnsavedChanges = true;
                                    logChange(f.id, appId, oldVal, newVal, groupedStudents[currentStudentId].id);
                                }
                            });
                        }

                        input.addEventListener('change', (e) => {
                            let newVal = e.target.value;
                            const oldVal = app.formData[f.id];
                            if (f.type === 'address') {
                                processAddress(e.target, f);
                                newVal = e.target.value;
                            }
                            app.formData[f.id] = newVal;
                            evaluateLogic(app);
                            hasUnsavedChanges = true;
                            
                            if (f.id === 'internship_institution_name') {
                                const tabBtn = document.querySelector(`.tab-btn[data-tab="${app.id}"]`);
                                if(tabBtn) {
                                    // 2. 不要叫做實習填報清單x，改叫{學號}+實習紀錄+{流水號}
                                    // Don't auto update here to keep naming consistent unless we want dynamic renaming.
                                    // Keeping it simple as per request 2
                                }
                            }

                            logChange(f.id, appId, oldVal, newVal, groupedStudents[currentStudentId].id);
                        });
                    }

                    wrapper.appendChild(input);
                    grid.appendChild(wrapper);
                });
                container.appendChild(grid);
            });

            setTimeout(() => evaluateLogic(app), 0);
        }

        function evaluateLogic(app) {
            const fields = currentYearConfig.fields || [];
            
            fields.forEach(f => {
                if (f.visibilityRule && f.visibilityRule.dep) {
                    const depVal = app.formData[f.visibilityRule.dep];
                    const wrapper = document.getElementById(`wrapper-${app.id}-${f.id}`);
                    const inputEl = document.getElementById(`input-${app.id}-${f.id}`);
                    const rocContainer = document.getElementById(`roc-container-${app.id}-${f.id}`);
                    
                    if (wrapper) {
                        let shouldEnable = f.visibilityRule.action === 'show' 
                            ? depVal === f.visibilityRule.val 
                            : depVal !== f.visibilityRule.val;
                        
                        if (inputEl && inputEl.type !== 'hidden') inputEl.disabled = !shouldEnable;
                        
                        if (rocContainer) {
                            rocContainer.querySelector('input').disabled = !shouldEnable;
                            const btn = rocContainer.querySelector('.date-toggle-btn');
                            if(btn) {
                                btn.style.pointerEvents = shouldEnable ? 'auto' : 'none';
                                btn.style.opacity = shouldEnable ? '1' : '0.5';
                            }
                        }
                        
                        if (!shouldEnable) {
                            wrapper.classList.add('field-locked');
                            if (inputEl && inputEl.type !== 'hidden') inputEl.value = "";
                            if (rocContainer) rocContainer.querySelector('input').value = "";
                            app.formData[f.id] = "";
                        } else {
                            wrapper.classList.remove('field-locked');
                        }
                    }
                }
                
                if (f.filterRules && f.filterRules.length > 0) {
                    const input = document.getElementById(`input-${app.id}-${f.id}`);
                    if (input && input.tagName === 'SELECT') {
                        const rule = f.filterRules.find(r => app.formData[r.dep] === r.val);
                        Array.from(input.options).forEach(opt => {
                            if (opt.value === "") return;
                            if (rule && rule.limitTo) {
                                opt.hidden = !rule.limitTo.includes(opt.value);
                            } else {
                                opt.hidden = false;
                            }
                        });
                        if (input.selectedOptions[0]?.hidden) {
                            input.value = "";
                            app.formData[f.id] = "";
                        }
                    }
                }
            });
        }

        function openPreviewModal() {
            if (!currentStudentId) return;
            const student = groupedStudents[currentStudentId];
            const thead = document.getElementById('modal-preview-head');
            const tbody = document.getElementById('modal-preview-body');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const headers = [];
            (currentYearConfig.fields || []).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(f => {
                headers.push({id: f.id, label: f.label});
            });
            if(headers.length === 0) CORE_FIELDS.forEach(k => headers.push({id:k, label:k}));

            headers.forEach(h => {
                const th = document.createElement('th');
                th.innerText = h.label;
                thead.appendChild(th);
            });

            student.applications.forEach(app => {
                const courses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
                const courseCount = courses.length;

                courses.forEach((c, idx) => {
                    const tr = document.createElement('tr');
                    headers.forEach(h => {
                        const td = document.createElement('td');
                        let val = app.formData[h.id];
                        
                        const fieldDef = currentYearConfig.fields?.find(f => f.id === h.id);
                        if (fieldDef && fieldDef.calcMode === 'average' && val && !isNaN(val)) {
                            const totalVal = parseFloat(val);
                            const baseVal = Math.floor(totalVal / courseCount);
                            const remainder = totalVal % courseCount;
                            
                            if (idx === courses.length - 1) {
                                val = (baseVal + remainder).toFixed(fieldDef.decimal || 0);
                            } else {
                                val = baseVal.toFixed(fieldDef.decimal || 0);
                            }
                        }

                        if (val === undefined || val === "") {
                            val = c[h.id] || c[h.label] || "";
                        } else {
                            td.className = "text-indigo-600 font-bold bg-indigo-50"; 
                        }
                        
                        if (fieldDef && fieldDef.type === 'date' && fieldDef.inputFormat === 'ROC' && val && val.includes('-')) {
                             const parts = val.split('-');
                             if (parts.length === 3) {
                                 const roc = parseInt(parts[0]) - 1911;
                                 val = `${roc}/${parts[1]}/${parts[2]}`;
                             }
                        }

                        td.innerText = val;
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });
            });

            const unassigned = student.courses.filter(c => !c._app_id);
            unassigned.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = "opacity-50"; 
                headers.forEach(h => {
                    const td = document.createElement('td');
                    let val = c[h.id] || c[h.label] || "";
                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });

            document.getElementById('preview-modal').classList.remove('hidden');
        }

        async function exportData() {
            if(Object.keys(groupedStudents).length === 0) return showToast('error', '無資料可匯出');

            const workbook = new ExcelJS.Workbook();
            const ws = workbook.addWorksheet('填報資料');

            const headers = [];
            if (currentYearConfig.fields) {
                currentYearConfig.fields.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(f => headers.push({key: f.id, header: f.label}));
            }
            ws.columns = headers;

            const headerRow = ws.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002E5D' } };

            Object.values(groupedStudents).forEach(s => {
                s.applications.forEach(app => {
                    const courses = s.courses.filter(c => app.courseIds.includes(c._internal_id));
                    const courseCount = courses.length;

                    courses.forEach((c, idx) => {
                        const row = {};
                        headers.forEach(h => {
                            let val = app.formData[h.key];
                            const fieldDef = currentYearConfig.fields?.find(f => f.id === h.key);
                            
                            if (fieldDef && fieldDef.calcMode === 'average' && val && !isNaN(val)) {
                                const totalVal = parseFloat(val);
                                const baseVal = Math.floor(totalVal / courseCount);
                                const remainder = totalVal % courseCount;
                                if (idx === courses.length - 1) val = (baseVal + remainder).toFixed(fieldDef.decimal || 0);
                                else val = baseVal.toFixed(fieldDef.decimal || 0);
                            }

                            if (val === undefined || val === "") val = c[h.key] || c[h.header] || "";
                            
                            if (fieldDef && fieldDef.type === 'date' && fieldDef.outputFormat === 'ROC' && val && val.includes('-')) {
                                 const parts = val.split('-');
                                 if (parts.length === 3) {
                                     const roc = parseInt(parts[0]) - 1911;
                                     val = `${roc}${parts[1]}${parts[2]}`; 
                                 }
                            }

                            row[h.key] = val;
                        });
                        ws.addRow(row);
                    });
                });

                const unassigned = s.courses.filter(c => !c._app_id);
                unassigned.forEach(c => {
                    const row = {};
                    headers.forEach(h => row[h.key] = c[h.key] || c[h.header] || "");
                    ws.addRow(row);
                });
            });

            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach((f, i) => {
                    const col = ws.getColumn(i + 1);
                    if (f.excelWidth) col.width = f.excelWidth;
                    
                    if (f.type === 'single_select' && f.options && f.options.length > 0) {
                         const char = col.letter;
                         const listStr = f.options.join(',');
                         if(listStr.length < 255) {
                             ws.dataValidations.add(`${char}2:${char}9999`, {
                                 type: 'list',
                                 allowBlank: true,
                                 formulae: [`"${listStr}"`]
                             });
                         }
                    }
                });
            }

            // --- 新增邏輯：備份課程核心欄位 ---
            const courseDataSheet = workbook.addWorksheet('_Course_Data', {state: 'hidden'});
            
            // 找出所有屬於 'sys_course_info' 的欄位
            const sysCourseFields = (currentYearConfig.fields || [])
                .filter(f => f.category === 'sys_course_info')
                .map(f => ({ id: f.id, label: f.label }));
                
            // 定義固定欄位
            const courseDataHeaders = [
                { header: 'Course_Internal_ID', key: '_internal_id' },
                { header: 'Student_ID', key: 'student_id' },
                ...sysCourseFields.map(f => ({ header: f.id, key: f.id }))
            ];
            courseDataSheet.columns = courseDataHeaders;

            // 填入資料
            Object.values(groupedStudents).forEach(s => {
                s.courses.forEach(c => {
                    const rowData = {
                        _internal_id: c._internal_id,
                        student_id: s.id
                    };
                    sysCourseFields.forEach(f => {
                        rowData[f.id] = c[f.id] || '';
                    });
                    courseDataSheet.addRow(rowData);
                });
            });
            // --- 結束新增邏輯 ---

            const conSheet = workbook.addWorksheet('_Consolidation_Data', {state: 'hidden'});
            conSheet.columns = [{header: 'App_ID', key: 'id'}, {header: 'Student_ID', key: 'sid'}, {header: 'Course_IDs', key: 'cids'}, {header: 'Form_Data', key: 'data'}];
            Object.values(groupedStudents).forEach(s => {
                s.applications.forEach(app => {
                    conSheet.addRow({ id: app.id, sid: s.id, cids: app.courseIds.join(','), data: JSON.stringify(app.formData) });
                });
            });

            const logSheet = workbook.addWorksheet('_Audit_Log', {state: 'hidden'});
            logSheet.columns = [
                {header: 'Time', key: 'time'}, {header: 'Field', key: 'field'}, 
                {header: 'Old_Value', key: 'old'}, {header: 'New_Value', key: 'new'}, 
                {header: 'Student', key: 'student'}, {header: 'App_ID', key: 'app'}
            ];
            changeLogs.forEach(l => logSheet.addRow(l));

            const metaSheet = workbook.addWorksheet('_System_Metadata', {state: 'hidden'});
            metaSheet.columns = [{header:'Field_ID', key:'id'}, {header:'Field_Label', key:'label'}];
            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach(f => metaSheet.addRow({id: f.id, label: f.label}));
            }

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `實習填報_${activeYear}_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('success', '匯出成功 (包含隱藏設定)');
            
            hasUnsavedChanges = false;
        }

        function logChange(field, appId, oldVal, newVal, studentId) {
            if(oldVal === newVal) return;
            changeLogs.push({
                time: new Date().toISOString(),
                field: field,
                old: oldVal,
                new: newVal,
                student: studentId,
                app: appId
            });
        }

        let toastTimeout;
        function showToast(type, msg) {
            const el = document.getElementById('toast');
            el.classList.remove('pointer-events-none');
            el.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':'exclamation-circle'}"></i> <span>${msg}</span><button onclick="hideToast(event)" class="ml-auto hover:text-slate-200 focus:outline-none p-1"><i class="fas fa-times"></i></button>`;
            el.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-3 text-white ${type==='success'?'bg-emerald-600':'bg-red-600'} toast-enter-active`;
            if(toastTimeout) clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => hideToast(), 3000);
        }

        function hideToast(e) {
            if(e) e.stopPropagation();
            const el = document.getElementById('toast');
            el.classList.replace('toast-enter-active', 'toast-exit-active');
            el.classList.add('pointer-events-none');
        }

        // --- Helper: 寬鬆搜尋課程欄位值 ---
        function getCourseValue(courseObj, keys) {
            // 優先找完全符合的 key
            for (const k of keys) {
                if (courseObj[k] !== undefined && courseObj[k] !== null && courseObj[k] !== "") 
                    return courseObj[k];
            }
            // 若找不到，嘗試模糊比對 (忽略大小寫與空白)
            const rowKeys = Object.keys(courseObj);
            for (const k of keys) {
                const target = k.toLowerCase();
                const foundKey = rowKeys.find(rk => rk.toLowerCase().includes(target) || rk.replace(/\s/g,'') === target);
                if (foundKey && courseObj[foundKey]) return courseObj[foundKey];
            }
            return '-';
        }

    </script>
</body>
</html>
