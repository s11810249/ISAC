<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海大學學生校外實習校庫填報輔助系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- SheetJS for Excel Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- ExcelJS (用於高階讀寫與樣式控制) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC',
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        :root {
            --base-size: 16px; 
        }
        
        html { font-size: var(--base-size); }
        body { font-size: 1rem; } 
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .input-stylish { 
            width: 100%; 
            border: 1px solid #e2e8f0; 
            border-radius: 0.375rem; 
            padding: 0.4rem 0.75rem; 
            font-size: 1em; 
            transition: all 0.2s; 
            background-color: #fff; 
            line-height: 1.5; 
            height: 42px !important; /* ★ 加入 !important 強制高度 */
            box-sizing: border-box;  /* 確保 padding 不會撐大高度 */
        }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .input-stylish:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
        
        textarea.input-stylish { height: auto; min-height: 2.5em; padding-top: 0.4rem; padding-bottom: 0.4rem; }

        /* Sidebar Transition */
        aside { transition: width 0.3s ease; position: relative; }
        aside.collapsed { width: 0 !important; overflow: hidden; }
        
        /* New Full-Height Sidebar Toggle */
        #sidebar-toggle-strip {
            position: absolute;
            left: 20rem; 
            top: 0;
            bottom: 0;
            width: 16px; /* ★ 修改：加寬至 16px */
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            border-left: 1px solid #fff;
            cursor: pointer;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease, background-color 0.2s;
        }
        #student-grid-wrapper { padding-left: 16px; /* ★ 新增：對應開合條的寬度，避免第一欄被蓋住 */ }
        #sidebar-toggle-strip:hover { background-color: #e2e8f0; }
        #sidebar-toggle-strip i { font-size: 10px; color: #94a3b8; transition: transform 0.3s; }
        
        /* When collapsed */
        aside.collapsed + #sidebar-toggle-strip { left: 0; border-left: none; }
        aside.collapsed + #sidebar-toggle-strip i { transform: rotate(180deg); }

        /* Left Sidebar Items */
        .student-item { cursor: pointer; border-left: 3px solid transparent; transition: all 0.2s; }
        .student-item:hover { background-color: #f8fafc; }
        .student-item.active { background-color: #eff6ff; border-left-color: #002E5D; }
        .student-item.active .student-name { color: #002E5D; font-weight: bold; }

        /* Import Button (Admin Style) */
        .import-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9em; width: 100%; }
        .import-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Course Card in Settings Tab */
        .course-card { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; 
            transition: all 0.2s; position: relative; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .course-card:hover { border-color: #002E5D; background-color: #f0f9ff; }
        .course-card.selected { border-color: #002E5D; background-color: #eff6ff; }

        .field-group { transition: all 0.3s ease; margin-bottom: 0.5rem; }
        /* 鎖定時的視覺樣式 (取代原本的 hidden) */
        .field-locked label { color: #94a3b8; }
        .field-locked .input-stylish { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; }
        .field-locked select.date-select { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; pointer-events: none; }
        .field-locked .date-toggle-btn { display: none; } /* Hide toggle button when locked */
        
        .spinner { border: 3px solid rgba(0,46,93,0.1); border-radius: 50%; border-top: 3px solid #002E5D; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tab System */
        .tab-btn { 
            padding: 0.75rem 1.5rem; 
            font-size: 1em; 
            font-weight: 600; 
            color: #64748b; 
            border-bottom: 3px solid transparent; /* ★ 關鍵：預設佔位，避免切換時高度跳動 */
            transition: all 0.2s; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            white-space: nowrap;
        }

        .tab-btn:hover { 
            color: #002E5D; 
            background-color: #f8fafc; 
        }

        /* 選取狀態 (明確設定藍色底線) */
        .tab-btn.active { 
            color: #002E5D; 
            background-color: #eff6ff; /* 淺藍色背景 */
            border-bottom: 3px solid #002E5D !important; /* ★ 關鍵：設定 3px 粗藍底 #002E5D */
            border-radius: 6px 6px 0 0; /* 上方圓角 */
        }
       
        .tab-btn:hover { color: #002E5D; background-color: #f8fafc; }
        .tab-btn.active { 
            color: #002E5D; 
            border-bottom-color: #002E5D; 
            background-color: #eff6ff; /* ★ 修改：加入淺藍色背景，讓選取狀態更明顯 */
            border-radius: 6px 6px 0 0; /* (選用) 加一點上方圓角，更有頁籤的感覺 */
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Excel Preview Table */
        .excel-table { border-collapse: collapse; width: 100%; font-size: 0.9em; }
        .excel-table th, .excel-table td { border: 1px solid #e2e8f0; padding: 6px 10px; white-space: nowrap; }
        .excel-table th { background-color: #f8fafc; color: #64748b; font-weight: bold; text-align: left; }
        
        /* Form Section Title */
        .form-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #002E5D;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-section-title:first-child { margin-top: 0; }
        .form-section-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 1.2em;
            background-color: #C6A87C;
            border-radius: 2px;
        }

        /* Tooltip Style */
        .tooltip-container { position: relative; display: inline-block; margin-left: 0.5rem; }
        .tooltip-icon { color: #94a3b8; cursor: help; transition: color 0.2s; }
        .tooltip-icon:hover { color: #002E5D; }
        .tooltip-text { 
            visibility: hidden; width: max-content; max-width: 280px; background-color: #334155; color: #fff; text-align: left; 
            border-radius: 6px; padding: 8px 12px; position: absolute; z-index: 50; bottom: 125%; left: 50%; 
            transform: translateX(-50%); opacity: 0; transition: opacity 0.3s; font-size: 0.85em; font-weight: normal; line-height: 1.5;
            pointer-events: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            white-space: pre-wrap; /* ★ 支援換行與自動折行 */
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }

        /* Custom ROC Date Picker Styles */
        .date-picker-wrapper { 
            position: relative; 
            width: 100%; 
            display: flex;       /* ★ 關鍵：消除 block 元素間隙 */
            align-items: center; /* 垂直置中 */
            margin: 0;           /* 確保無外距 */
        }
        .date-input-group { 
            position: relative; 
            display: flex; 
            align-items: center; 
        }

        /* 3. 新增錯誤提示樣式 (給需求3使用) */
        .field-error .input-stylish {
            border-color: #ef4444 !important;
            background-color: #fef2f2 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
        }
        
        .field-error label {
            color: #ef4444 !important;
        }
        
        .date-picker-trigger {
            position: absolute; right: 8px; color: #64748b; cursor: pointer; padding: 4px;
            border-radius: 4px; transition: color 0.2s;
        }
        .date-picker-trigger:hover { color: #002E5D; background-color: #f1f5f9; }
        
        .calendar-popover {
            position: absolute; top: 100%; left: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 280px; z-index: 50; display: none; padding: 12px; font-size: 0.9em;
        }
        .calendar-popover.active { display: block; animation: fadeIn 0.1s ease-out; }
        
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-btn { padding: 4px 8px; border-radius: 4px; hover: bg-slate-100; cursor: pointer; color: #64748b; }
        .cal-btn:hover { background-color: #f1f5f9; color: #002E5D; }
        .cal-title { font-weight: bold; color: #334155; cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-header { font-size: 0.75em; color: #94a3b8; padding: 4px 0; }
        .cal-day { 
            padding: 6px 0; cursor: pointer; border-radius: 4px; color: #334155; 
        }
        .cal-day:hover:not(.empty) { background-color: #f1f5f9; color: #002E5D; }
        .cal-day.selected { background-color: #002E5D; color: #fff; }
        .cal-day.empty { pointer-events: none; }
        .cal-day.today { border: 1px solid #002E5D; font-weight: bold; }

        /* Filter Styles */
        .filter-select { font-size: 0.85em; padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0; background-color: #fff; width: 100%; }
        
        /* Toast Animation */
        .toast-enter { transform: translateY(20px); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s ease-out; }
        .toast-exit { transform: translateY(0); opacity: 1; }
        .toast-exit-active { transform: translateY(20px); opacity: 0; transition: all 0.3s ease-in; }
        
        /* Confirmation Modal */
        .confirm-modal-content { 
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
        }

        /* Grid View & Modal Styles */
        .sortable-header { cursor: pointer; user-select: none; transition: background 0.2s; }
        .sortable-header:hover { background-color: #e2e8f0; }
        .sort-icon { margin-left: 4px; color: #94a3b8; font-size: 0.8em; }
        .sort-icon.active { color: #002E5D; }
        
        /* Grid Input Styles */
        .grid-input { 
            width: 100%; border: 1px solid transparent; background: transparent; 
            padding: 4px; font-size: 14px; border-radius: 2px;
        }
        .grid-input:focus { border-color: #002E5D; background: white; outline: none; }
        .grid-input:disabled { background-color: #f1f5f9; color: #cbd5e1; cursor: not-allowed; }
        
        /* Linked Data Indicator */
        /* 1. 移除歸戶連結色 */
        .is-linked { background-color: transparent !important; color: inherit; } 
        
        /* 2. 表格儲存格：回復標準 Table-Cell */
        .excel-table td { 
            padding: 0 !important; 
            height: 1px;           /* ★ 關鍵技巧：設定極小高度，強迫瀏覽器將實際高度分配給子元素的 height: 100% */
            min-height: 34px;      
            border-right: 1px solid #f1f5f9; 
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;   /* 內容靠上對齊，適合多行文字 */
            
            /* ★ 移除 display: flex，解決"格子變一列"的破圖問題 */
        }

        /* 3. 輸入框設定：填滿儲存格 */
        .grid-input { 
            width: 100%; 
            height: 100%;          /* ★ 自動填滿父層 TD 的高度 */
            min-height: 34px;
            border: none; 
            background: transparent;
            padding: 4px 8px; 
            font-size: 14px;  
            line-height: 1.5;
            color: #334155;
            transition: all 0.2s;
            box-sizing: border-box;
            vertical-align: top;
            display: block;        /* 確保是區塊元素 */
        }
        
        /* 文字區域專用：允許換行 */
        textarea.grid-input {
            white-space: pre-wrap; 
            word-break: break-all; 
            overflow: hidden;      
            resize: none;
        }

        /* 鎖定狀態：背景透明 (顏色由 TD 負責)，文字變淡 */
        .grid-input:disabled {
            color: #cbd5e1; 
            cursor: not-allowed;
            background-color: transparent !important; 
        }

        .grid-input:focus { 
            outline: none; box-shadow: inset 0 0 0 2px #002E5D; background-color: #ffffff; z-index: 10;
        }

        /* 4. 唯讀儲存格內容容器 */
        .cell-read-only {
            width: 100%; 
            height: 100%;          /* ★ 填滿高度 */
            min-height: 34px;
            display: flex;         /* 內部維持 Flex 以便置中 */
            align-items: center;   /* 垂直置中 (唯讀欄位通常單行居多) */
            justify-content: center; /* 水平置中 */
            padding: 4px 8px; 
            color: #64748b; 
            white-space: nowrap;   /* 唯讀不換行 */
            text-align: center;
        }
        
        /* 5. 日期選擇器容器修正 (確保填滿) */
        .date-picker-wrapper, .date-input-group {
            width: 100%;
        }
        .date-input-group {
            display: flex;
            align-items: center;
        }

        /* 6. 背景色設定 */
        tr.row-group-normal { background-color: #ffffff; }
        tr.row-group-alt { background-color: #f8fafc; }
        tr.row-group-normal:hover, tr.row-group-alt:hover { background-color: #eff6ff !important; }
        tr.row-group-normal:hover td, tr.row-group-alt:hover td { background-color: #eff6ff !important; }
        
        /* =========================================
           ★★★ Grid View 極致美化 (V2: 字體加大版) ★★★
           ========================================= */
        
        /* 1. 表格儲存格：高度加大，字體加大 */
        .excel-table td { 
            padding: 0 !important; 
            height: 40px; /* 從 34px 加大到 40px */
            position: relative;
            border-color: #cbd5e1; 
        }
        
        /* 表頭也同步加大 */
        .excel-table th {
            padding: 8px 10px;
            font-size: 0.95em; /* 表頭字體加大 */
        }

        /* 2. 輸入框與選單：字體加大 */
        .grid-input { 
            width: 100%; 
            height: 100%;          
            min-height: 34px;
            border: none; 
            background: transparent;
            padding: 4px 8px; 
            font-size: 14px;  
            line-height: 1.25;
            color: #334155;
            
            /* ★★★ 關鍵修正：只對顏色和陰影做動畫，防止背景圖示位移 ★★★ */
            transition: background-color 0.2s, box-shadow 0.2s;
            
            box-sizing: border-box;
            vertical-align: top;
            display: block;        
        }
        
        /* 文字區域專用 */
        textarea.grid-input {
            white-space: pre-wrap; 
            word-break: break-all; 
            overflow: hidden;      
            resize: none;
            padding-top: 6px;      /* 微調內距，讓第一行文字位置更好看 */
        }
        
        /* 4. 下拉選單美化 (V2: 按鈕固定右側 + 防重疊) */
        select.grid-input { 
            appearance: none; 
            -webkit-appearance: none;
            width: 100%;             
            height: 100%;            
            border: none;
            
            /* ★ 修正：明確指定 background-color，避免覆蓋 image */
            background-color: transparent; 
            
            cursor: pointer;
            
            /* 自定義箭頭圖示 */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: 16px;
            
            /* 固定按鈕位置 */
            background-position: right 8px center; 
            
            /* 右側內距 */
            padding-right: 30px !important; 
            padding-left: 8px;
            
            /* 文字置中 */
            text-align: center;
            text-align-last: center; 
            
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            
            font-size: 14px;
            color: #334155;
        }
        
        /* Firefox 修正 */
        select.grid-input:-moz-focusring { color: transparent; text-shadow: 0 0 0 #000; }

        .grid-input:disabled {
            color: #cbd5e1; 
            cursor: not-allowed;
            background-color: transparent !important; 
        }

        .grid-input:focus { 
            outline: none; box-shadow: inset 0 0 0 2px #002E5D; background-color: #ffffff; z-index: 10;
        }

        /* 3. 表格儲存格 */
        .excel-table td { 
            padding: 0 !important; 
            height: 1px;           
            min-height: 34px;      
            border-right: 1px solid #f1f5f9; 
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;   
        }

        /* 4. 唯讀儲存格內容容器 */
        .cell-read-only {
            width: 100%; 
            height: 100%;          
            min-height: 34px;
            display: flex;         
            align-items: center;   
            justify-content: center; 
            padding: 4px 8px; 
            color: #64748b; 
            white-space: nowrap;   
            text-align: center;
            line-height: 1.25;     /* ★ 修改：唯讀欄位也同步調降行高 */
        }
        
        select.grid-input:-moz-focusring { color: transparent; text-shadow: 0 0 0 #000; }
        
        /* 5. Grid Sidebar Styles (側欄) - 樣式同步修正 */
        #grid-sidebar { 
            transition: width 0.3s ease; 
            width: 20rem; /* 與歸戶模式 w-80 (20rem) 一致 */
            flex-shrink: 0; 
            border-right: 1px solid #e2e8f0; 
            background: white; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* 新增: shadow-sm */
            z-index: 20; /* 提高層級 */
            position: relative;
        }
        #grid-sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        
        /* 6. Grid Toggle Strip (開合按鈕) - 顏色同步修正 */
        #grid-sidebar-toggle {
            width: 16px; /* 稍微加寬 */
            background: #f1f5f9; 
            border-right: 1px solid #e2e8f0; 
            border-left: 1px solid #fff; /* 增加左側邊線，提升立體感 */
            cursor: pointer;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; /* 提高層級，確保不被蓋住 */
            flex-shrink: 0; /* ★★★ 關鍵：防止被壓縮 ★★★ */
            transition: background 0.2s;
            position: relative;
        }
        #grid-sidebar-toggle:hover { background: #e2e8f0; }
        #grid-sidebar-toggle i { 
            color: #94a3b8; /* 修改: 由 #64748b 改為 #94a3b8 (Slate-400) */
            font-size: 10px; /* 修改: 由 12px 改為 10px */
            transition: transform 0.3s;
        }

        /* Selected Item Chip */
        .selected-item-chip {
            background: #f0f9ff; border: 1px solid #bae6fd; padding: 8px; border-radius: 6px;
            font-size: 0.9em; /* 字體微調 */
            margin-bottom: 8px; position: relative;
        }
        .selected-item-chip .remove-btn {
            position: absolute; top: 4px; right: 4px; color: #94a3b8; cursor: pointer; padding: 2px;
        }
        .selected-item-chip .remove-btn:hover { color: #ef4444; }
        
        /* Toggle Checkbox Label & Chip Style */
        .col-toggle-label, .toggle-chip { 
            display: inline-flex; align-items: center; gap: 4px; 
            background: white; padding: 2px 8px; 
            border: 1px solid #cbd5e1; border-radius: 4px; 
            cursor: pointer; user-select: none; font-size: 12px;
            transition: all 0.2s;
        }
        .col-toggle-label:hover, .toggle-chip:hover { border-color: #64748b; background-color: #f8fafc; }
        .col-toggle-label input:checked + span, .toggle-chip input:checked + span { color: #002E5D; font-weight: bold; }
        
        /* 隱藏預設 Checkbox 改用自定義顏色 (選用，讓介面更統一) */
        .toggle-chip input[type="checkbox"] { accent-color: #002E5D; }
    /* --- 欄位篩選器美化 (New Column Picker Styles) --- */
        
        /* 去除 summary 預設的三角形 */
        summary.custom-picker-trigger {
            list-style: none;
        }
        summary.custom-picker-trigger::-webkit-details-marker {
            display: none;
        }

        /* 下拉選單容器動畫 */
        /* 1. 下拉選單容器：更柔和的陰影與圓角 */
        .picker-dropdown {
            border: 1px solid rgba(226, 232, 240, 0.8); /* Slate-200 */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        /* 2. 選項按鈕 (Chip) - 預設狀態 (未選取) */
        .field-chip-label {
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            background-color: #f8fafc; /* Slate-50 */
            border: 1px solid transparent; /* 隱形邊框 */
            color: #64748b; /* Slate-500 */
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .field-chip-label:hover {
            background-color: #f1f5f9; /* Slate-100 */
            color: #334155;
            transform: translateY(-1px);
        }

        /* 3. 選項按鈕 - 選中狀態 (Checked) */
        /* 使用品牌色 (Primary) 的淺色背景與深色文字，去除厚重邊框 */
        .field-chip-label:has(input:checked) {
            background-color: #eff6ff; /* Blue-50 */
            color: #1e40af; /* Blue-800 */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            border-color: #dbeafe; /* Blue-100 */
        }

        /* 隱藏原生 Checkbox */
        .field-chip-label input[type="checkbox"] {
            appearance: none;
            position: absolute;
            opacity: 0;
        }
        
        /* 4. 自定義 Checkbox icon (圓形設計) */
        .chip-check-icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #cbd5e1; /* 預設灰 */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
            font-size: 10px;
            flex-shrink: 0;
        }
        
        /* 選中時的 Icon 變化 */
        .field-chip-label input:checked + .chip-check-icon {
            background-color: #2563eb; /* Blue-600 */
            transform: scale(1.1);
        }
        .field-chip-label input:checked + .chip-check-icon::after {
            content: '\f00c'; /* FontAwesome Check */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }

        /* 底部確認區塊 */
        .picker-footer-action {
            background: linear-gradient(to bottom, #ffffff, #f8fafc);
        }
        
        /* --- Grid 優化 (表格線條與對齊) --- */

        /* 1. 表格基礎設定 (線條變細) */
        .excel-table { 
            border-collapse: separate; 
            border-spacing: 0;
        }
        
        /* 手動繪製格線：顏色變淡 (#e2e8f0 -> #f1f5f9)，寬度保持 1px */
        .excel-table th, .excel-table td { 
            border-right: 1px solid #e2e8f0; 
            border-bottom: 1px solid #e2e8f0; 
            box-sizing: border-box;
        }

        /* 2. 對齊設定 (唯讀欄位一律置中) */
        .cell-multiline {
            white-space: normal !important;
            word-break: break-all;
            line-height: 1.4;
            padding: 4px 8px !important;
            height: auto !important;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center; /* 強制水平置中 */
            text-align: center;      /* 強制文字置中 */
        }
        
        /* 移除 .cell-left, .cell-center 區分，統一使用上方設定 */
        
        /* --- Grid 視覺與層級最終修正 (V10: 絕對層級版) --- */

        /* 1. 表格基礎設定 */
        .excel-table { 
            border-collapse: separate; 
            border-spacing: 0;
            table-layout: fixed; /* ★ 新增：固定表格佈局，確保欄位寬度強制生效以產生捲軸 */
            width: auto;         /* ★ 修改：由 JS 動態控制寬度，不強迫 100% */
            min-width: 100%;     /* 確保至少填滿畫面 */
        }
        
        .excel-table th, .excel-table td { 
            border-right: 1px solid #f1f5f9; 
            border-bottom: 1px solid #f1f5f9; 
            box-sizing: border-box;
            background-clip: padding-box;
        }

        /* 2. 層級設定 (Z-Index Hierarchy) - 修正版 */
        /* 層級邏輯：左上角凍結頭(50) > 一般表頭(40) > 內容凍結欄(30) > 一般內容(auto) */

        /* 強制提升 thead 層級，並覆蓋 HTML 中的 class="z-20" */
        thead {
            position: sticky;
            top: 0;
            z-index: 40 !important; 
        }

        /* 一般表頭 */
        thead th {
            position: sticky;
            top: 0;
            background-color: #f8fafc;
            color: #475569;
            border-bottom: 2px solid #94a3b8 !important; 
            z-index: 40 !important; 
        }
        
        /* 表頭的凍結欄位 (左上角) - 最高層級，確保不被捲動蓋住 */
        th.sticky-col {
            position: sticky;
            left: 0;
            background-color: #f8fafc !important;
            z-index: 50 !important; 
            border-bottom: 2px solid #94a3b8 !important;
        }

        /* 內容的凍結欄位 (左側) - 比表頭低，但比一般內容高 */
        td.sticky-col {
            position: sticky;
            left: 0;
            background-color: #fff !important;
            z-index: 30 !important; 
        }

        /* 3. 凍結列最右邊加粗陰影 */
        .sticky-border-right {
            border-right: 2px solid #94a3b8 !important;
            box-shadow: 4px 0 6px -3px rgba(0,0,0,0.1);
            clip-path: inset(0 -15px 0 0);
        }

        /* 4. 欄位說明圖示 */
        .header-info-icon {
            color: #cbd5e1;
            margin-left: 6px;
            cursor: help;
            font-size: 13px;
            transition: color 0.2s;
        }
        .header-info-icon:hover { color: #002E5D; }

        /* 5. 內容對齊 */
        .cell-multiline {
            white-space: normal !important;
            word-break: break-all;
            line-height: 1.5;
            padding: 4px 8px !important;
            height: auto !important;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center; /* 統一置中 */
            text-align: center;
        }

        /* 輸入框微調 */
        .excel-table textarea, .excel-table input {
            font-size: 0.9em;
            color: #334155;
        }

        .cell-multiline textarea {
            resize: none;
            overflow: hidden;
            min-height: 32px;
            padding: 4px;
            line-height: 1.5;
        }

        .excel-table td { vertical-align: middle; }

        /* --- 新增：機構版本選擇器樣式 --- */
        .version-select-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        .version-select {
            width: 100%;
            padding: 0.5rem 1rem;
            padding-right: 2.5rem;
            font-size: 0.95rem;
            font-weight: bold;
            color: #1e293b;
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            appearance: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .version-select:hover { border-color: #94a3b8; background-color: #e2e8f0; }
        .version-select:focus { border-color: #002E5D; outline: none; ring: 2px solid rgba(0,46,93,0.1); }
        .version-select-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            pointer-events: none;
        }

        /* --- 新增：表單欄位旁的查詢按鈕 --- */
        .input-group-append-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.75rem;
            background-color: #eff6ff;
            border: 1px solid #e2e8f0;
            border-left: none;
            border-radius: 0 0.375rem 0.375rem 0;
            color: #002E5D;
            cursor: pointer;
            transition: all 0.2s;
        }
        .input-group-append-btn:hover {
            background-color: #dbeafe;
            color: #1e40af;
        }

        /* 隱藏 Chrome/Edge 瀏覽器 datalist 的倒三角形圖示 */
        input::-webkit-calendar-picker-indicator {
            display: none !important;
        }
        
        /* 確保選取時的藍色外框不會被裁切 */
        .inst-child-container {
            overflow: visible !important;
        }

        /* ★ 新增：隱藏所有數字輸入框的上下箭頭 (避免滾輪或點擊誤觸) ★ */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield; /* 針對 Firefox 瀏覽器的設定 */
        }
        
        /* --- style結尾 --- */
    </style> 
</head>
<body class="h-screen flex flex-col bg-background text-slate-700 overflow-hidden">

    <!-- Header -->
    
    <header class="h-16 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm z-30 flex-shrink-0 justify-between">
        <div class="flex items-center gap-4 min-w-0">
            <div class="flex items-center gap-3 flex-shrink-0"> 
                <div class="bg-primary p-1.5 rounded-lg shadow-sm flex-shrink-0">
                    <img src="files/svg/THU-Logo.svg" class="h-8 w-auto" alt="Logo">
                </div>
                
                <div class="flex flex-col">
                    <h1 class="font-bold text-lg tracking-wide text-primary flex items-center gap-2 whitespace-nowrap">
                        東海大學學生校外實習校庫填報輔助系統
                        <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-lg text-sm border border-amber-200 shadow-sm flex-shrink-0">
                            系所填報
                    </h1>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-3 flex-shrink-0">
            <button id="btn-local-storage" onclick="toggleLocalStorage()" class="text-slate-500 hover:text-primary font-bold text-sm px-3 py-2 rounded-lg hover:bg-slate-100 transition whitespace-nowrap flex items-center gap-2 mr-2">
                <i class="fas fa-cloud-upload-alt"></i> 啟用暫存保護
            </button>
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <div class="relative group mr-2">
                <button class="flex items-center gap-2 text-slate-600 hover:text-primary font-bold text-sm px-3 py-2 rounded-lg hover:bg-slate-100 transition whitespace-nowrap">
                    <i class="fas fa-toolbox"></i> 輔助工具 <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                </button>
                <div class="absolute right-0 top-full mt-1 w-56 bg-white border border-slate-200 rounded-xl shadow-xl hidden group-hover:block z-50 p-1">
                    <div class="text-[10px] font-bold text-slate-400 px-3 py-2 uppercase tracking-wider">機構管理</div>
                    
                    <button onclick="openInstitutionList()" class="w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary rounded-lg transition flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center"><i class="fas fa-building"></i></div>
                        <span>機構清單與關聯查詢</span>
                    </button>
                </div>
            </div>

            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            
            <button onclick="exportData()" class="bg-success text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm flex items-center gap-2 whitespace-nowrap">
                <i class="fas fa-file-export"></i> 匯出結果
            </button>
            <button onclick="document.getElementById('info-modal').classList.remove('hidden')" class="ml-3 text-slate-400 hover:text-primary transition" title="系統與隱私聲明">
                <i class="fas fa-info-circle text-xl"></i>
            </button>
            <button class="ml-3 text-slate-400 hover:text-primary transition" 
                    title="版權宣告" 
                    onclick="document.getElementById('copyright-modal').classList.remove('hidden')">
                <i class="fas fa-copyright text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex-grow flex overflow-hidden relative">
        
        <!-- Sidebar: Student List -->
        <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm flex-shrink-0 relative">
            <!-- Import Button -->
            <div class="p-4 pb-0 bg-slate-50">
                <label class="import-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                    <i class="fas fa-file-import text-lg"></i> 匯入學生名單 (Excel)
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .csv" onchange="handleFileUpload(event)">
                </label>
            </div>

            <div class="p-4 border-b border-slate-100 bg-slate-50 space-y-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterStudentList()" placeholder="搜尋姓名或學號..." class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                
                <!-- Filters -->
                <div class="grid grid-cols-2 gap-2">
                    <select id="filter-course-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部開課系</option>
                    </select>
                    <select id="filter-student-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部學生系</option>
                    </select>
                    <select id="filter-status" onchange="filterStudentList()" class="filter-select col-span-2">
                        <option value="">全部填報進度</option>
                        <option value="not_started">未開始 (皆未歸戶)</option>
                        <option value="in_progress">填報中 (含未歸戶)</option>
                        <option value="completed">已填報 (完全完成)</option>
                    </select>
                </div>

                <div class="flex justify-between items-center text-xs text-slate-500">
                    <div>總計: <span id="student-count" class="font-bold text-slate-700">0</span> 人</div>
                    <div class="flex gap-1">
                        <button onclick="toggleSort('id')" class="hover:text-primary p-1 rounded transition" title="依學號排序" id="sort-id-btn">
                            <i class="fas fa-sort-numeric-down"></i>
                        </button>
                        <button onclick="toggleSort('name')" class="hover:text-primary p-1 rounded transition" title="依姓名排序" id="sort-name-btn">
                            <i class="fas fa-sort-alpha-down"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="student-list" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-0">
                <div class="p-8 text-center text-slate-400 text-sm">
                    <i class="fas fa-arrow-up mb-2 text-xl block"></i>
                    請先從上方匯入 Excel 名單
                </div>
            </div>
        </aside>

        <!-- Sidebar Toggle Strip -->
        <div id="sidebar-toggle-strip" onclick="toggleSidebar()" title="收合/展開側邊欄">
            <i class="fas fa-chevron-left text-slate-400"></i>
        </div>

        <!-- Right Side: Workspace -->
        <main class="flex-grow bg-slate-50 overflow-hidden relative flex flex-col" id="main-content">
            
            <!-- Empty State -->
            <div id="form-empty-state" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-50 text-slate-400">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 text-3xl shadow-sm border border-slate-100">
                    <i class="fas fa-user-edit text-slate-300"></i>
                </div>
                <p>請從左側選擇一位學生開始填報</p>
            </div>

            <!-- Content Area (Visible when student selected) -->
            <div id="form-container" class="hidden flex flex-col h-full w-full">
                
                <div class="bg-white px-6 py-4 border-b border-slate-200 shadow-sm flex-shrink-0 flex justify-between items-center z-20">
                    <div class="flex gap-4 items-start min-w-0 mr-4 flex-grow">
                        <div class="w-12 h-12 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xl font-bold flex-shrink-0 mt-1">
                            <span id="header-avatar">?</span>
                        </div>
                        
                        <div class="flex flex-col gap-1.5 w-full min-w-0">
                            <div class="flex items-center gap-3 flex-wrap">
                                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <span id="header-name" class="truncate">學生姓名</span>
                                    <span id="header-id" class="text-sm font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded flex-shrink-0">ID</span>
                                </h2>
                                <span id="header-dept" class="text-sm text-slate-500 flex items-center gap-1 truncate border-l border-slate-300 pl-3">
                                    <i class="fas fa-graduation-cap"></i> 系所
                                </span>
                            </div>

                            <div class="flex items-center gap-3">
                                <button onclick="handleSettingsClick()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-3 py-1 rounded-md text-xs font-bold shadow-sm transition flex items-center gap-2 whitespace-nowrap">
                                    <i class="fas fa-cog"></i> 歸戶設定
                                </button>
                                <span id="header-status-text" class="text-xs text-slate-500 truncate">
                                    讀取中...
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 flex-shrink-0">
                        <div class="flex bg-slate-100 p-1 rounded-lg mr-2 flex-shrink-0">
                            <button onclick="setStudentViewMode('form')" id="btn-std-view-form" class="px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary flex items-center gap-1 whitespace-nowrap">
                                <i class="fas fa-file-alt"></i> 表單模式
                            </button>
                            <button onclick="setStudentViewMode('grid')" id="btn-std-view-grid" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition flex items-center gap-1 whitespace-nowrap">
                                <i class="fas fa-th"></i> 列表模式
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white border-b border-slate-200 px-6 flex gap-2 z-10 overflow-x-auto custom-scroll flex-shrink-0" id="tabs-container">
                </div>
                <div id="sticky-progress-header" class="hidden bg-white border-b border-slate-200 px-6 py-3 shadow-sm z-20 flex-shrink-0">
                    </div>
                <div class="flex-grow relative overflow-hidden bg-slate-50">
                    
                    <div id="student-grid-wrapper" class="hidden absolute inset-x-0 top-0 bottom-10 flex flex-col bg-white z-20 border-b border-slate-200">
                        
                        <div id="local-grid-header" class="px-6 py-2 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                            <h2 class="font-bold text-slate-700 text-sm flex items-center gap-2">
                                <i class="fas fa-list-ul text-primary"></i> 列表檢視
                            </h2>
                            <div id="local-grid-column-picker">
                                 </div>
                        </div>

                        <div class="flex-grow overflow-auto custom-scroll relative p-0">
                            <table class="excel-table w-full relative">
                                <thead class="sticky top-0 z-20 bg-slate-100 shadow-sm" id="local-grid-thead"></thead>
                                <tbody id="local-grid-tbody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="form-content-area" class="absolute inset-0 overflow-y-auto custom-scroll p-6 pb-24">

                        <div id="dynamic-tabs-area"></div>
                    </div>
                </div>
        </main>
    <!-- Preview Modal -->
        <div id="preview-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-table text-primary"></i> 學生資料預覽</h3>
                    <p class="text-xs text-slate-500 mt-1">包含所有課程（已歸戶與未歸戶）的完整資料</p>
                </div>
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>

            <div class="px-6 py-2 bg-slate-100 border-b border-slate-200 flex flex-wrap gap-2 text-xs" id="preview-column-toggles">
                </div>

            <div class="flex-grow overflow-auto custom-scroll p-0 relative">
                <table class="excel-table w-full relative">
                    <thead class="sticky top-0 z-10"><tr id="modal-preview-head"></tr></thead>
                    <tbody id="modal-preview-body"></tbody>
                </table>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm bg-slate-800 text-white shadow hover:bg-slate-900">關閉</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center modal-overlay p-4">
        <div class="confirm-modal-content">
            <div class="mb-4 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">確認刪除？</h3>
            <p class="text-sm text-slate-600 mb-6" id="confirm-message">此操作無法復原。</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-cancel-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-slate-500 bg-slate-100 hover:bg-slate-200 transition">取消</button>
                <button id="confirm-ok-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-white bg-red-600 hover:bg-red-700 shadow transition">確認</button>
            </div>
        </div>
    </div>
    
    <div id="student-settings-modal" class="fixed inset-0 z-[130] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fas fa-cog text-primary"></i> <span id="modal-student-name">歸戶設定</span>
                </h3>
                <button onclick="document.getElementById('student-settings-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-6 bg-white">
                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center rounded-t-lg mb-4">
                    <div>
                        <h3 class="font-bold text-indigo-800 text-lg">實習歸戶設定</h3>
                        <p class="text-xs text-indigo-600 mt-1">請勾選同一實習紀錄的課程，合併建立為一份填報單。</p>
                    </div>
                    <button onclick="createApplicationFromModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                        <i class="fas fa-plus"></i> 建立歸戶
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 border-b border-slate-200 pb-2">尚未歸戶的課程</h4>
                        <div id="modal-settings-course-list" class="space-y-2"></div>
                    </div>
                    <div class="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100">
                        <h4 class="text-sm font-bold text-slate-700 mb-3 border-b border-indigo-200 pb-2">已建立的填報單</h4>
                        <div id="modal-app-management-list" class="space-y-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification (Fixed) -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[200] flex flex-col gap-3 pointer-events-none transition-all duration-300">
        </div>
    
    <div id="info-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 bg-primary text-white flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-shield-alt"></i> 系統使用與隱私聲明
                </h3>
            </div>
            
            <div class="p-6 space-y-4 text-sm text-slate-700 overflow-y-auto custom-scroll">
                
                <div class="flex gap-3">
                    <div class="text-2xl text-blue-500"><i class="fas fa-laptop-code"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800">純前端運作</h4>
                        <p class="text-slate-500 mt-1">本系統所有運算皆在您的瀏覽器內完成，<span class="text-red-500 font-bold">不會</span>將任何學生個資上傳至外部伺服器或資料庫，請安心使用。</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <div class="text-2xl text-orange-500"><i class="fas fa-hdd"></i></div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800">資料暫存機制</h4>
                        <p class="text-slate-500 mt-1 mb-2">
                            預設為記憶體暫存（關閉即消失）。若啟用<span class="font-bold text-primary">「暫存保護」</span>，資料將儲存於瀏覽器中。
                            <span class="text-red-500 font-bold block mt-1"><i class="fas fa-exclamation-triangle"></i> 請勿在公用電腦啟用此功能，以免個資外洩。</span>
                        </p>
                        
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-600">
                            <strong class="block mb-2 text-slate-700 border-b border-slate-200 pb-1">⚠️ 注意：在以下情形，暫存資料將會遺失</strong>
                            <ul class="list-disc pl-4 space-y-1.5">
                                <li>
                                    <span class="font-bold text-slate-700">手動清除：</span>點擊系統內的紅色「清除暫存資料」按鈕，或在瀏覽器設定中清除「Cookie 與其他網站資料」。
                                </li>
                                <li>
                                    <span class="font-bold text-slate-700">無痕模式：</span>若在無痕視窗中使用，關閉視窗後瀏覽器會強制刪除所有資料。
                                </li>
                                <li>
                                    <span class="font-bold text-slate-700">資料覆蓋：</span>當您匯入新的 Excel 檔案時，系統會重置結構，舊的暫存檔將被新資料覆蓋。
                                </li>
                                <li>
                                    <span class="font-bold text-slate-700">瀏覽器重設：</span>重設瀏覽器設定或解除安裝瀏覽器。
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="text-2xl text-emerald-500"><i class="fas fa-file-excel"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800">資料保管責任</h4>
                        <p class="text-slate-500 mt-1">匯出的 Excel 檔案包含敏感個資，請妥善保管。若使用公用電腦，請務必在使用後刪除下載的檔案。</p>
                    </div>
                </div>

                <div class="p-3 bg-yellow-50 text-yellow-800 rounded-lg text-xs border border-yellow-200 flex items-start gap-2">
                    <i class="fas fa-info-circle mt-0.5"></i>
                    <span>此聲明預設每次開啟系統時皆會顯示，以確保您了解資料安全規範。</span>
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex-shrink-0">
                <label class="flex items-center mb-4 cursor-pointer group select-none">
                    <input type="checkbox" id="chk-info-agree" class="w-4 h-4 text-primary border-slate-300 rounded focus:ring-primary transition">
                    <span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-primary transition">
                        我同意啟用「暫存保護」，且未來不再顯示此聲明
                    </span>
                </label>
                <div class="flex justify-end">
                    <button onclick="handleInfoModalClose()" class="bg-primary hover:bg-sky-900 text-white px-6 py-2 rounded-lg font-bold shadow transition">
                        進入系統
                    </button>
                </div>
            </div>
        </div>
    </div>

   <div id="copyright-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col">
            <div class="px-6 py-4 bg-primary text-white flex justify-between items-center flex-shrink-0">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-copyright"></i> 版權宣告
                </h3>
                <button onclick="document.getElementById('copyright-modal').classList.add('hidden')" class="text-white hover:text-slate-200 w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-8 text-center space-y-4 bg-white">
                <div class="w-20 h-20 mx-auto bg-primary rounded-full flex items-center justify-center mb-4 shadow-md border-4 border-indigo-50/50">
                    <img src="files/svg/THU-Logo.svg" class="h-10 w-auto" alt="THU Logo">
                </div>
                <div class="text-sm text-slate-600 leading-relaxed">
                    Copyright &copy; 2025-2026<br>
                    <span class="font-bold text-lg text-slate-800 block mt-3 mb-1">東海大學實習與學生成就中心</span>
                    Internship and Student Achievement Center,<br>
                    Tunghai University.<br>
                    All Rights Reserved.
                </div>
            </div>

            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-center flex-shrink-0">
                <button onclick="document.getElementById('copyright-modal').classList.add('hidden')" class="bg-primary hover:bg-sky-900 text-white px-10 py-2 rounded-lg font-bold shadow transition">
                    確定
                </button>
            </div>
        </div>
    </div>     
    
    <div id="distribute-modal" class="fixed inset-0 z-[160] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-slate-100 bg-indigo-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                    <i class="fas fa-calculator"></i> <span id="dist-modal-title">自動分配總時數</span>
                </h3>
                <button onclick="document.getElementById('distribute-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 text-blue-800 text-sm p-3 rounded-lg border border-blue-100 mb-4">
                    <i class="fas fa-info-circle mr-1"></i> 請輸入此歸戶的「總數」，系統將依據課程權重（如學分）自動換算並填入。
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">請輸入總數 (Total)</label>
                    <div class="flex gap-2">
                        <input type="number" id="dist-total-input" class="input-stylish text-lg font-bold text-indigo-600" placeholder="例如: 500">
                        <div class="flex items-center text-sm text-slate-500 bg-slate-100 px-3 rounded border border-slate-200" id="dist-weight-info">
                            總權重: 0
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-3 py-2 text-xs font-bold text-slate-500 border-b border-slate-200">分配預覽</div>
                    <div id="dist-preview-list" class="max-h-40 overflow-y-auto p-0 text-sm divide-y divide-slate-100">
                        </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="document.getElementById('distribute-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg font-bold text-sm text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="confirmDistribution()" class="px-6 py-2 rounded-lg font-bold text-sm text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg transition">
                    確認套用
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Local Storage Manager (暫存管理系統) ---
        const STORAGE_KEY = 'thu_isac_hedb_temp_v1';
        const LIB_STORAGE_KEY = 'thu_isac_inst_lib_v1'; // ★ 新增：補齊缺失的常數
        const REL_STORAGE_KEY = 'thu_isac_inst_rels_v1'; // (原本在下方，統一移到這裡比較好)

        // 1. 切換暫存狀態 (按鈕點擊事件)
        function toggleLocalStorage() {
            const isEnabled = localStorage.getItem(STORAGE_KEY + '_enabled') === 'true';

            if (isEnabled) {
                showConfirm('清除暫存？', '確定要關閉暫存功能並清除本機的備份資料嗎？\n(清除後若未匯出，重新整理將遺失資料)').then(yes => {
                    if(yes) {
                        localStorage.removeItem(STORAGE_KEY);
                        localStorage.removeItem(STORAGE_KEY + '_enabled');
                        // ★ 新增：同步移除機構庫暫存
                        localStorage.removeItem(LIB_STORAGE_KEY);
                        
                        updateStorageBtn(false);
                        showToast('info', '已清除本機暫存資料');
                    }
                });
            } else {
                showConfirm('啟用暫存保護', '同意將填報資料暫存在您的瀏覽器(Local Storage)中嗎？\n\n注意：\n1. 資料僅儲存於此電腦，不會上傳伺服器。\n2. 請勿在公用電腦使用此功能，以免個資外洩。').then(yes => {
                    if(yes) {
                        localStorage.setItem(STORAGE_KEY + '_enabled', 'true');
                        saveToLocal(); // 立即存檔
                        updateStorageBtn(true);
                        showToast('success', '已啟用暫存保護，資料將自動保存');
                    }
                });
            }
        }

        // ★★★ 新增：處理聲明視窗關閉與同意邏輯 ★★★
        function handleInfoModalClose() {
            const chk = document.getElementById('chk-info-agree');
            const modal = document.getElementById('info-modal');
            
            if (chk && chk.checked) {
                // 1. 使用者同意：啟用暫存
                localStorage.setItem(STORAGE_KEY + '_enabled', 'true');
                updateStorageBtn(true);
                saveToLocal(); // 立即存檔
                
                // 2. 設定 Flag：下次不再顯示
                localStorage.setItem('thu_isac_hide_intro', 'true');
                
                showToast('success', '已啟用暫存保護，下次將不再顯示聲明');
            }
            
            // 關閉視窗
            modal.classList.add('hidden');
        }
        
        // 2. 更新按鈕樣式
        function updateStorageBtn(isEnabled) {
            const btn = document.getElementById('btn-local-storage');
            if(!btn) return;
            
            if(isEnabled) {
                btn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> 清除暫存資料';
                btn.className = "text-red-500 hover:text-red-700 font-bold text-sm px-3 py-2 rounded-lg hover:bg-red-50 transition whitespace-nowrap flex items-center gap-2 mr-2 border border-red-200";
                btn.title = "資料保護中 (點擊以清除)";
            } else {
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 啟用暫存保護';
                btn.className = "text-slate-500 hover:text-primary font-bold text-sm px-3 py-2 rounded-lg hover:bg-slate-100 transition whitespace-nowrap flex items-center gap-2 mr-2";
                btn.title = "開啟後可避免意外關閉導致資料遺失";
            }
        }

        // 3. 執行存檔 (將被各個修改函式呼叫)
        function saveToLocal() {
            // 檢查是否啟用
            if (localStorage.getItem(STORAGE_KEY + '_enabled') !== 'true') return;
            if (!allRawData || allRawData.length === 0) return;

            // 提取所有歸戶資料
            const allApps = [];
            Object.values(groupedStudents).forEach(s => {
                if(s.applications) {
                    s.applications.forEach(app => {
                        allApps.push({
                            id: app.id,
                            studentId: s.id,
                            courseIds: app.courseIds,
                            formData: app.formData
                        });
                    });
                }
            });

            const state = {
                rawData: allRawData,
                apps: allApps,
                year: activeYear,
                studentId: currentStudentId,
                mode: currentViewMode,
                timestamp: Date.now()
            };
            
            try {
                // ★ 關鍵修正：改用 compressToUTF16，完美貼合 localStorage 編碼，大幅減少體積
                const compressedState = LZString.compressToUTF16(JSON.stringify(state));
                const compressedLib = LZString.compressToUTF16(JSON.stringify(institutionLibrary));
                const compressedRels = LZString.compressToUTF16(JSON.stringify(institutionRelations));
        
                localStorage.setItem(STORAGE_KEY, compressedState);
                localStorage.setItem(LIB_STORAGE_KEY, compressedLib);
                localStorage.setItem(REL_STORAGE_KEY, compressedRels);
                
            } catch (e) {
                console.error("Storage full or error", e);
                // ★ 新增防呆：若空間依然不足，自動關閉暫存並跳出紅色警告
                showToast('error', '暫存失敗：資料量過大，瀏覽器可用空間不足。已暫時關閉暫存保護。');
                localStorage.setItem(STORAGE_KEY + '_enabled', 'false');
                updateStorageBtn(false);
            }
        }

        // 4. 檢查並還原 (OnInit 呼叫)
        async function checkAndRestore() {
            const saved = localStorage.getItem(STORAGE_KEY);
            const isEnabled = localStorage.getItem(STORAGE_KEY + '_enabled') === 'true'; // 檢查暫存狀態
            
            if (isEnabled) {
                try {
                    const savedLib = localStorage.getItem(LIB_STORAGE_KEY);
                    if(savedLib) {
                        // ★ 修正：優先嘗試新版 UTF16 解碼，失敗再用舊版解碼相容
                        let decompressed = LZString.decompressFromUTF16(savedLib) || LZString.decompress(savedLib);
                        institutionLibrary = JSON.parse(decompressed || savedLib);
                    }
        
                    const savedRels = localStorage.getItem(REL_STORAGE_KEY);
                    if(savedRels) {
                        let decompressed = LZString.decompressFromUTF16(savedRels) || LZString.decompress(savedRels);
                        institutionRelations = JSON.parse(decompressed || savedRels);
                    }
                } catch(e) { 
                    console.error("Library load error", e); 
                    institutionLibrary = {}; // 載入失敗就清空
                }
            }

            if (saved) {
                const yes = await showConfirm('發現未完成的暫存', '系統發現您上次有未儲存的填報進度，是否還原？');
                if (yes) {
                    try {
                        // ★ 修正：相容解碼
                        let decompressedState = LZString.decompressFromUTF16(saved) || LZString.decompress(saved);
                        const state = JSON.parse(decompressedState || saved); 
                        
                        // 1. 還原資料 (使用既有的處理函式)
                        await processUploadedData(state.rawData, state.apps);
                        
                        // 2. 還原視圖狀態
                        if(state.mode) currentViewMode = state.mode;
                        if(state.studentId) {
                            selectStudent(state.studentId);
                        }
                        
                        // 3. 確保狀態為啟用
                        localStorage.setItem(STORAGE_KEY + '_enabled', 'true');
                        updateStorageBtn(true);
                        showToast('success', '已成功還原暫存資料');
                    } catch (e) {
                        console.error(e);
                        showToast('error', '還原失敗：暫存資料可能已損毀');
                    }
                } else {
                    updateStorageBtn(true); 
                }
            } else {
                updateStorageBtn(isEnabled);
            }
        }
        
        // --- Global State ---
        let globalConfig = {};       
        let currentYearConfig = {};  
        let departmentData = [];     
        let deptMasterData = {};     
        
        let allRawData = [];         
        let groupedStudents = {};    
        let currentStudentId = null;
        let currentActiveAppId = null; // ★★★ 新增這一行：用來記錄目前選中的填報單 ID
        let activeYear = "";         
        let hasUnsavedChanges = false;

        // Change Log Store
        let changeLogs = []; // { time, field, oldVal, newVal, student, app }

        let institutionLibrary = {}; // 結構: { "機構名稱": [ {data_v1}, {data_v2} ] }
        let institutionRelations = {};
        
        let sortConfig = { key: 'id', direction: 'asc' };

        const CORE_FIELDS = ['school_year', 'semester', 'student_id', 'student_name', 'student_dept', 'course_name', 'course_id'];

        // Custom Confirm Helper
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const okBtn = document.getElementById('confirm-ok-btn');

                titleEl.innerText = title;
                msgEl.innerText = message;
                modal.classList.remove('hidden');

                const close = (result) => {
                    modal.classList.add('hidden');
                    // Remove listeners to prevent duplicates
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                    resolve(result);
                };

                cancelBtn.onclick = () => close(false);
                okBtn.onclick = () => close(true);
            });
        }
        
        // --- 預覽視窗增強 (排序/開關) ---
        let previewState = {
            hiddenCols: [],
            sortKey: null,
            sortDir: 'asc'
        };

        function openPreviewModal() {
            if (!currentStudentId) return;
            document.getElementById('preview-modal').classList.remove('hidden');
            renderPreviewControls(); 
            renderPreviewTable();    
        }

        function renderPreviewControls() {
            const container = document.getElementById('preview-column-toggles');
            const allFields = getAllExportFields();
            const total = allFields.length;
            const currentHiddenCount = previewState.hiddenCols.length;
            const currentVisible = total - currentHiddenCount;

            container.innerHTML = '';

            // ★ 建立暫存狀態 (避免即時刷新)
            let tempHiddenCols = [...previewState.hiddenCols];

            const details = document.createElement('details');
            details.className = "column-picker w-full group relative";
            
            // 1. 觸發按鈕
            const summary = document.createElement('summary');
            summary.className = "custom-picker-trigger flex items-center justify-between cursor-pointer px-4 py-2 bg-white border border-slate-300 rounded-lg hover:border-primary hover:text-primary transition shadow-sm select-none text-slate-600";
            summary.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="bg-primary/10 text-primary w-8 h-8 rounded-full flex items-center justify-center">
                        <i class="fas fa-sliders-h"></i>
                    </div>
                    <div class="flex flex-col items-start leading-tight">
                        <span class="font-bold text-sm">顯示欄位設定</span>
                        <span class="text-[10px] text-slate-400">目前顯示 ${currentVisible} / ${total} 個欄位</span>
                    </div>
                </div>
                <i class="fas fa-chevron-down text-xs text-slate-400 group-open:rotate-180 transition-transform duration-300"></i>
            `;
            
            // 2. 下拉內容
            const content = document.createElement('div');
            content.className = "picker-dropdown absolute top-full left-0 mt-2 w-full max-w-4xl bg-white border border-slate-200 rounded-xl shadow-2xl z-50 flex flex-col overflow-hidden";
            
            // 2.1 頂部全選區
            const actions = document.createElement('div');
            actions.className = "flex justify-between items-center px-5 py-3 border-b border-slate-100 bg-white";
            actions.innerHTML = `
                <span class="text-xs font-bold text-slate-500">勾選以顯示</span>
                <div class="flex gap-2">
                    <button type="button" id="btn-show-all" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-blue-50 hover:text-blue-600 font-bold transition">全選</button>
                    <button type="button" id="btn-hide-all" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 transition">全隱藏</button>
                </div>
            `;
            content.appendChild(actions);

            // 2.2 選項區 (Grid) - 每次重新開啟時會根據 tempHiddenCols 渲染
            const renderChips = () => {
                tagsContainer.innerHTML = '';
                allFields.forEach(f => {
                    const lbl = document.createElement('label');
                    lbl.className = 'field-chip-label'; 
                    // 注意：這裡根據 tempHiddenCols 判斷
                    const isVisible = !tempHiddenCols.includes(f.id);
                    
                    lbl.innerHTML = `
                        <input type="checkbox" value="${f.id}" ${isVisible ? 'checked' : ''}>
                        <div class="chip-check-icon"></div>
                        <span class="truncate" title="${f.label}">${f.label}</span>
                    `;
                    
                    // ★ 綁定 Checkbox 事件：只更新暫存，不刷新表格
                    lbl.querySelector('input').onchange = (e) => {
                        if (e.target.checked) {
                            // 顯示：從隱藏名單移除
                            tempHiddenCols = tempHiddenCols.filter(id => id !== f.id);
                        } else {
                            // 隱藏：加入隱藏名單
                            tempHiddenCols.push(f.id);
                        }
                    };
                    tagsContainer.appendChild(lbl);
                });
            };

            const tagsContainer = document.createElement('div');
            tagsContainer.className = "p-5 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-[300px] overflow-y-auto custom-scroll bg-white";
            renderChips();
            content.appendChild(tagsContainer);

            // 2.3 底部確認區
            const footer = document.createElement('div');
            footer.className = "picker-footer-action px-5 py-3 border-t border-slate-100 flex justify-between items-center";
            footer.innerHTML = `
                <span class="text-xs text-slate-400">更動將在選單關閉後套用</span>
                <button type="button" id="btn-apply" class="px-6 py-2 bg-primary hover:bg-indigo-900 text-white text-sm font-bold rounded-lg shadow-md transition transform hover:scale-[1.02]">
                    套用變更 <i class="fas fa-check ml-1"></i>
                </button>
            `;
            content.appendChild(footer);

            details.appendChild(summary);
            details.appendChild(content);
            container.appendChild(details);

            // --- 事件綁定 ---

            // 全選
            content.querySelector('#btn-show-all').onclick = (e) => {
                e.preventDefault();
                tempHiddenCols = [];
                renderChips(); // 只重繪按鈕狀態
            };

            // 全隱藏
            content.querySelector('#btn-hide-all').onclick = (e) => {
                e.preventDefault();
                tempHiddenCols = allFields.map(f => f.id);
                renderChips();
            };

            // 套用按鈕 (關閉選單，邏輯在 toggle 處理)
            content.querySelector('#btn-apply').onclick = () => {
                details.removeAttribute('open');
            };

            // ★ 監聽 <details> 開關事件：關閉時才真正觸發重繪
            details.addEventListener('toggle', () => {
                if (!details.open) {
                    // 檢查是否有變更
                    const isChanged = 
                        tempHiddenCols.length !== previewState.hiddenCols.length || 
                        !tempHiddenCols.every(id => previewState.hiddenCols.includes(id));

                    if (isChanged) {
                        previewState.hiddenCols = [...tempHiddenCols]; // 更新真實狀態
                        renderPreviewTable(); // 重繪表格
                        renderPreviewControls(); // 重繪控制器(更新計數)
                    }
                } else {
                    // 開啟時，重置暫存為目前真實狀態
                    tempHiddenCols = [...previewState.hiddenCols];
                    renderChips();
                }
            });
            
            // 點擊外部關閉
            document.addEventListener('click', function closeMenu(e) {
                if (!details.contains(e.target) && details.hasAttribute('open')) {
                    details.removeAttribute('open');
                }
            });
        }

        function togglePreviewCol(fieldId) {
            if (previewState.hiddenCols.includes(fieldId)) {
                previewState.hiddenCols = previewState.hiddenCols.filter(id => id !== fieldId);
            } else {
                previewState.hiddenCols.push(fieldId);
            }
            renderPreviewTable();
        }

        function setPreviewSort(key) {
            if (previewState.sortKey === key) {
                previewState.sortDir = previewState.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                previewState.sortKey = key;
                previewState.sortDir = 'asc';
            }
            renderPreviewTable();
        }

        function renderPreviewTable() {
            const student = groupedStudents[currentStudentId];
            const thead = document.getElementById('modal-preview-head');
            const tbody = document.getElementById('modal-preview-body');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const allFields = getAllExportFields();
            const visibleFields = allFields.filter(f => !previewState.hiddenCols.includes(f.id));

            visibleFields.forEach(h => {
                const th = document.createElement('th');
                th.className = 'sortable-header';
                th.onclick = () => setPreviewSort(h.id);
                let icon = '';
                if (previewState.sortKey === h.id) {
                    icon = previewState.sortDir === 'asc' ? '<i class="fas fa-sort-up sort-icon active"></i>' : '<i class="fas fa-sort-down sort-icon active"></i>';
                } else {
                    icon = '<i class="fas fa-sort sort-icon"></i>';
                }
                th.innerHTML = `${h.label} ${icon}`;
                thead.appendChild(th);
            });

            let rows = [];
            
            student.applications.forEach(app => {
                const courses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
                courses.forEach(c => {
                    let rowData = { ...c, _source: 'app', _appData: app.formData };
                    allFields.forEach(f => {
                        if (app.formData[f.id] !== undefined && app.formData[f.id] !== "") {
                            rowData[f.id] = app.formData[f.id];
                        }
                    });
                    rows.push(rowData);
                });
            });
            
            student.courses.filter(c => !c._app_id).forEach(c => {
                rows.push({ ...c, _source: 'raw' });
            });

            if (previewState.sortKey) {
                rows.sort((a, b) => {
                    const valA = (a[previewState.sortKey] || '').toString();
                    const valB = (b[previewState.sortKey] || '').toString();
                    return previewState.sortDir === 'asc' ? valA.localeCompare(valB, 'zh-Hant') : -valB.localeCompare(valA, 'zh-Hant');
                });
            }

            rows.forEach(r => {
                const tr = document.createElement('tr');
                visibleFields.forEach(h => {
                    const td = document.createElement('td');
                    let val = r[h.id];
                    if (val === undefined || val === null) val = "";
                    
                    if (r._source === 'app' && r._appData[h.id]) {
                        td.className = "text-indigo-600 font-bold bg-indigo-50";
                    }
                    
                    const fieldDef = currentYearConfig.fields?.find(f => f.id === h.id);
                    if (fieldDef && fieldDef.type === 'date' && fieldDef.inputFormat === 'ROC' && val && val.includes('-')) {
                        const parts = val.split('-');
                        if (parts.length === 3) {
                            const roc = parseInt(parts[0]) - 1911;
                            val = `${roc}/${parts[1]}/${parts[2]}`;
                        }
                    }

                    td.innerText = val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function getAllExportFields() {
            let headers = [];
            if (currentYearConfig.fields) {
                currentYearConfig.fields.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(f => headers.push({id: f.id, label: f.label}));
            }
            if(headers.length === 0) CORE_FIELDS.forEach(k => headers.push({id:k, label:k}));
            return headers;
        }

        // --- Helper: List 欄位自動編號邏輯 (增強防刪與智慧空行處理) ---
        function handleListKeydown(e) {
            const el = e.target;
            const start = el.selectionStart;
            const end = el.selectionEnd;
            const val = el.value;

            // 1. 智慧 Backspace 處理
            if (e.key === 'Backspace' && start === end) {
                const textBefore = val.substring(0, start);
                const textAfter = val.substring(end);
                const lastNewlineIdx = textBefore.lastIndexOf('\n');
                const lineStartIdx = lastNewlineIdx === -1 ? 0 : lastNewlineIdx + 1;
                
                const currentLineText = val.substring(lineStartIdx).split('\n')[0];
                const prefixMatch = currentLineText.match(/^(\d+\.\s)/);

                if (prefixMatch) {
                    const prefix = prefixMatch[1];
                    const content = currentLineText.substring(prefix.length);
                    const cursorPositionInLine = start - lineStartIdx;

                    if (content.length > 0) {
                        // 有內容：保護編號不被刪除
                        if (cursorPositionInLine <= prefix.length) {
                            e.preventDefault();
                            return;
                        }
                    } else {
                        // 無內容 (空編號)：智慧刪除整個編號
                        if (cursorPositionInLine === prefix.length) {
                            e.preventDefault();
                            let newTextBefore = val.substring(0, lineStartIdx);
                            // 若不是第一行，連同前面的換行符號一起刪除，退回上一行
                            if (lineStartIdx > 0) {
                                newTextBefore = val.substring(0, lastNewlineIdx); 
                            }
                            el.value = newTextBefore + textAfter;
                            el.selectionStart = el.selectionEnd = newTextBefore.length;
                            el.dispatchEvent(new Event('input')); // 觸發高度縮減
                            return;
                        }
                    }
                }
            }

            // 2. 防止 Delete 誤刪編號
            if (e.key === 'Delete' && start === end) {
                const lastNewlineIdx = val.lastIndexOf('\n', start - 1);
                const lineStartIdx = lastNewlineIdx === -1 ? 0 : lastNewlineIdx + 1;
                const currentLineText = val.substring(lineStartIdx).split('\n')[0];
                const prefixMatch = currentLineText.match(/^(\d+\.\s)/);

                if (prefixMatch) {
                    const prefix = prefixMatch[1];
                    const content = currentLineText.substring(prefix.length);
                    const cursorPositionInLine = start - lineStartIdx;

                    // 只要有內容，就不准往後刪除到編號區塊
                    if (content.length > 0 && cursorPositionInLine < prefix.length) {
                        e.preventDefault();
                        return;
                    }
                }
            }

            // 3. Enter 鍵處理 (自動編號與結束清單)
            if (e.key === 'Enter') {
                if (e.shiftKey) return; // Shift+Enter: 一般換行

                e.preventDefault();
                const textBefore = val.substring(0, start);
                const textAfter = val.substring(end);
                const lines = textBefore.split('\n');
                const currentLine = lines[lines.length - 1];

                const match = currentLine.match(/^(\d+)\.\s*/);
                let insertText = '';
                let newTextBefore = textBefore;

                if (match) {
                    if (currentLine.trim() === match[0].trim()) {
                        // 該行只有編號，按下 Enter 代表結束清單 (清除編號)
                        newTextBefore = textBefore.substring(0, textBefore.length - currentLine.length);
                        insertText = '\n'; 
                    } else {
                        // 繼續下一個編號
                        const nextNum = parseInt(match[1], 10) + 1;
                        insertText = `\n${nextNum}. `;
                    }
                } else {
                    if (lines.length === 1 && currentLine.trim() !== '') {
                        newTextBefore = `1. ${currentLine}`;
                        insertText = `\n2. `;
                    } else {
                        let lastNum = 0;
                        for (let i = lines.length - 1; i >= 0; i--) {
                            const m = lines[i].match(/^(\d+)\.\s*/);
                            if (m) { lastNum = parseInt(m[1], 10); break; }
                        }
                        insertText = lastNum > 0 ? `\n${lastNum + 1}. ` : `\n1. `;
                    }
                }
                
                el.value = newTextBefore + insertText + textAfter;
                el.selectionStart = el.selectionEnd = newTextBefore.length + insertText.length;
                el.dispatchEvent(new Event('input'));
                hasUnsavedChanges = true;
            }
        }

        // --- Helper: 同步調整列表模式單列(Row)所有 Textarea 的高度 ---
        function autoResizeGridRow(tr) {
            if (!tr) return;
            const textareas = tr.querySelectorAll('textarea.grid-input');
            if (textareas.length === 0) return;

            // 1. 先全部強制釋放為 1px，讓 TR 能縮減高度
            textareas.forEach(ta => {
                ta.style.setProperty('height', '1px', 'important');
            });

            // 2. ★ 關鍵修正：不強制統一高度，而是讓每個 textarea 只長到「剛好包覆自己內容」的高度。
            // 由於外層的 <td> 預設是 vertical-align: middle，
            // 這樣高度較短的 textarea 就會被表格自動推到「完美垂直置中」的位置！
            textareas.forEach(ta => {
                ta.style.setProperty('height', ta.scrollHeight + 'px', 'important');
                
                // 確保文字是靠左對齊
                ta.style.textAlign = 'left';
            });
        }
        
        // --- Helper: 計算文字寬度 ---
        function getTextWidth(text, font = "bold 14px 'Noto Sans TC'") {
            // 使用 Canvas 測量文字實際渲染寬度
            const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");
            context.font = font;
            const metrics = context.measureText(text);
            return metrics.width;
        }

        // 檢查單一格子的顯示邏輯
        function checkGridInputVisibility(input, fieldDef, dataContext) {
            if (fieldDef.visibilityRule) {
                const depVal = dataContext[fieldDef.visibilityRule.dep];
                let show = fieldDef.visibilityRule.action === 'show' ? depVal === fieldDef.visibilityRule.val : depVal !== fieldDef.visibilityRule.val;
                if (!show) {
                    input.disabled = true;
                    input.value = ""; 
                    input.style.opacity = "0.3";
                } else {
                    input.disabled = false;
                    input.style.opacity = "1";
                }
            }
        }

        // --- 處理格子變更 (修正版：同步觸發表單與列表邏輯) ---
        function handleGridChange(inputEl, student, course, fieldDef) {
            
            // 1. 地址/文字格式化
            if (fieldDef.type === 'address') {
                if (fieldDef.toHalf || fieldDef.forceTai || fieldDef.latinToEng || fieldDef.smartFormat) {
                    processAddress(inputEl, fieldDef);
                }
            }

            // 判斷是否為 checkbox
            let newVal;
            if (inputEl.type === 'checkbox') {
                newVal = inputEl.checked;
            } else {
                newVal = inputEl.value;
            }
            
            inputEl.title = newVal;
            
            const appId = course._app_id;
            hasUnsavedChanges = true;

            if (appId) {
                // === 情境 A: 已歸戶 (App Context) ===
                const app = student.applications.find(a => a.id === appId);
                if (app) {
                    const linkedCourses = student.courses.filter(c => app.courseIds.includes(c._internal_id));

                    if (fieldDef.calcMode === 'average' || fieldDef.calcMode === 'weighted') {
                        // 數值運算模式 (平均/加權) - 保持原有邏輯
                        course[fieldDef.id] = newVal; 

                        let finalValue = 0;
                        if (fieldDef.calcMode === 'weighted') {
                            let currentTotalValue = 0;
                            let totalWeight = 0;
                            const weightKey = fieldDef.weightField; 

                            linkedCourses.forEach(c => {
                                const v = parseFloat(c[fieldDef.id]) || 0;
                                const w = parseFloat(getCourseValue(c, [weightKey])) || 0;
                                currentTotalValue += v;
                                totalWeight += w;
                            });
                            finalValue = currentTotalValue;

                            if (totalWeight > 0) {
                                linkedCourses.forEach(c => {
                                    const w = parseFloat(getCourseValue(c, [weightKey])) || 0;
                                    const ratio = w / totalWeight;
                                    const distributedVal = currentTotalValue * ratio;
                                    const formattedVal = fieldDef.decimal ? distributedVal.toFixed(fieldDef.decimal) : Math.round(distributedVal).toString();
                                    
                                    c[fieldDef.id] = formattedVal;
                                    syncValueToViews(c._internal_id, student.id, fieldDef.id, formattedVal, inputEl);
                                });
                            }
                        } else {
                            // 平均/加總模式
                            let sum = 0;
                            linkedCourses.forEach(c => {
                                const v = parseFloat(c[fieldDef.id]);
                                if (!isNaN(v)) sum += v;
                            });
                            finalValue = sum; 
                        }

                        app.formData[fieldDef.id] = fieldDef.decimal ? finalValue.toFixed(fieldDef.decimal) : Math.round(finalValue).toString();
                        logChange(fieldDef.id, appId, app.formData[fieldDef.id], finalValue, student.id);

                    } else {
                        // 一般共用欄位：更新 App Data
                        const oldVal = app.formData[fieldDef.id];
                        app.formData[fieldDef.id] = newVal;
                        logChange(fieldDef.id, appId, oldVal, newVal, student.id);

                        // 1. 同步數值到所有視圖
                        const allRelatedInputs = document.querySelectorAll(`.app-input-${appId}-${fieldDef.id}`);
                        allRelatedInputs.forEach(el => {
                            if (el !== inputEl) {
                                if (el.type === 'checkbox') el.checked = newVal;
                                else { 
                                    el.value = newVal; 
                                    el.title = newVal; 
                                    
                                    // ★ 修正：同步資料時，若為多行文字則觸發高度重算
                                    if (el.tagName === 'TEXTAREA') {
                                        const tr = el.closest('tr');
                                        if (tr) autoResizeGridRow(tr);
                                    }
                                }
                            }
                        });

                        // ★★★ 關鍵修正：同時觸發「表單邏輯」與「列表邏輯」 ★★★
                        
                        // A. 觸發表單模式的邏輯檢查 (確保切換回去時狀態正確)
                        evaluateLogic(app);

                        // B. 觸發列表模式的邏輯檢查 (針對該歸戶下的所有課程列)
                        // 找出所有屬於此 App 的課程列，並更新它們的鎖定/解鎖狀態
                        const gridRows = document.querySelectorAll(`tr[data-sid="${student.id}"]`);
                        gridRows.forEach(tr => {
                             const cid = tr.dataset.cid;
                             const rowCourse = student.courses.find(c => c._internal_id === cid);
                             if (rowCourse && rowCourse._app_id === appId) {
                                 // 使用最新的 app.formData 更新該列的邏輯
                                 updateRowLogic(tr, app.formData, false);
                             }
                        });

                        // 機構資訊收集
                        if (fieldDef.category === 'internship_institution_info') {
                            if (typeof collectInstitutionData === 'function') {
                                collectInstitutionData(app.formData);
                            }
                        }
                    }
                }
            } else {
                // === 情境 B: 未歸戶 (Course Context) ===
                course[fieldDef.id] = newVal;
                
                // 更新該行邏輯
                const relevantRows = document.querySelectorAll(`tr[data-cid="${course._internal_id}"][data-sid="${student.id}"]`);
                relevantRows.forEach(tr => updateRowLogic(tr, course, true));
                
                syncValueToViews(course._internal_id, student.id, fieldDef.id, newVal, inputEl);

                if (newVal && newVal !== "" && newVal !== false) {
                    tryAutoMerge(student, course);
                }
            }
            saveToLocal();
        }
        
        // ★ 輔助：同步數值到所有視圖的函式
        function syncValueToViews(cid, sid, fieldId, value, sourceInput) {
            const rows = document.querySelectorAll(`tr[data-cid="${cid}"][data-sid="${sid}"]`);
            rows.forEach(row => {
                const targetInput = row.querySelector(`[data-field="${fieldId}"]`);
                if (targetInput && targetInput !== sourceInput) {
                    targetInput.value = value;
                    targetInput.title = value;
                    // 視覺回饋
                    targetInput.style.transition = 'background-color 0.3s';
                    targetInput.style.backgroundColor = '#fff7ed'; // 淡橘色
                    setTimeout(() => targetInput.style.backgroundColor = '', 400);
                    
                    // ★ 修正：同步資料時觸發高度重算
                    if (targetInput.tagName === 'TEXTAREA') {
                        autoResizeGridRow(row);
                    }
                }
            });
        }

        document.addEventListener('change', (e) => {
            // 確保只有在表單區域或列表區域的變更才觸發
            if (e.target.closest('#form-container') || e.target.closest('#local-grid-tbody')) {
                setTimeout(() => {
                    renderStudentList();
                }, 150);
            }
        });

        // --- 新增: 顯示課程資訊的專屬彈跳視窗 ---
        window.showCourseInfo = function(studentId, appId) {
            const student = groupedStudents[studentId];
            if (!student) return;
            const app = student.applications.find(a => a.id === appId);
            if (!app || !app.courseIds || app.courseIds.length === 0) return;
            
            // 抓取該紀錄的課程資料
            const appCourses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
            
            // 渲染精美的表格 HTML
            const tableHtml = `
                <div class="overflow-x-auto rounded-lg border border-slate-200 mt-2">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead class="bg-slate-50 text-slate-600">
                            <tr>
                                <th class="py-3 px-4 text-center font-semibold border-b border-slate-200">學期</th>
                                <th class="py-3 px-4 text-center font-semibold border-b border-slate-200">選課代號</th>
                                <th class="py-3 px-4 font-semibold border-b border-slate-200">課程名稱</th>
                                <th class="py-3 px-4 text-center font-semibold border-b border-slate-200">課程屬性</th>
                                <th class="py-3 px-4 text-center font-semibold border-b border-slate-200">學分</th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-700 divide-y divide-slate-100">
                            ${appCourses.map(c => `
                                <tr class="hover:bg-slate-50 transition-colors">
                                    <td class="py-3 px-4 text-center">${getCourseValue(c, ['semester', '學期'])}</td>
                                    <td class="py-3 px-4 text-center font-mono">${getCourseValue(c, ['course_code', '選課代號'])}</td>
                                    <td class="py-3 px-4 font-bold text-slate-800">${getCourseValue(c, ['course_name', '課程名稱', '科目名稱'])}</td>
                                    <td class="py-3 px-4 text-center">${getCourseValue(c, ['course_type', '修別', '選必修', '必選修'])}</td>
                                    <td class="py-3 px-4 text-center">${getCourseValue(c, ['credits', '學分', '學分數'])}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // 呼叫 SweetAlert 彈出視窗
            Swal.fire({
                title: '<div class="text-primary font-bold flex items-center gap-3"><i class="fas fa-book-open text-xl"></i> 歸戶課程清單</div>',
                html: tableHtml,
                width: '700px', // 加寬以容納表格
                showCloseButton: true,
                showConfirmButton: false, // 隱藏 OK 按鈕保持乾淨
                customClass: { popup: 'rounded-xl shadow-2xl border border-slate-100' }
            });
        };
        
        // --- Initialization ---
        window.onload = async function() {
            try {
                // 5. F5/Close Protection
                window.onbeforeunload = function (e) {
                    // If we have data loaded or changes made
                    if (allRawData.length > 0 || hasUnsavedChanges) {
                        const msg = "您有未儲存的資料，確定要離開嗎？";
                        e.returnValue = msg;
                        return msg;
                    }
                };

                const [cfgRes, deptRes, masterRes] = await Promise.all([
                    fetch('config.json').then(r => r.ok ? r.json() : {}),
                    fetch('data_departments.json').then(r => r.ok ? r.json() : []),
                    fetch('data_dept_master.json').then(r => r.ok ? r.json() : {})
                ]);

                globalConfig = cfgRes;
                departmentData = deptRes;
                deptMasterData = masterRes;

                updateFooterYear();
                
                // 1. 檢查並還原暫存資料
                await checkAndRestore();
                
                // 2. ★★★ 判斷是否顯示聲明視窗 ★★★
                const hideIntro = localStorage.getItem('thu_isac_hide_intro') === 'true';
                if (!hideIntro) {
                    document.getElementById('info-modal').classList.remove('hidden');
                }
                
            } catch (e) {
                console.error("Init failed", e);
                showToast('error', '系統初始化失敗');
            }
        };

        function updateFooterYear() {
            const startYear = 2025;
            const currentYear = new Date().getFullYear();
            const yearSpan = document.getElementById('copyright-year');
            if (yearSpan) {
                yearSpan.innerText = currentYear > startYear ? `${startYear}-${currentYear}` : `${startYear}`;
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        // --- Logic: Year Template ---
        async function changeYear(year) {
            if(!year) return;
            activeYear = year;
            showToast('info', `載入 ${year} 學年度設定...`);
            
            try {
                const res = await fetch(`year_templates/year_${year}_templates.json?t=${Date.now()}`);
                if (!res.ok) throw new Error("Template not found");
                currentYearConfig = await res.json();
                
                // If we have data, re-render current view
                if (currentStudentId) {
                    selectStudent(currentStudentId); 
                }
                showToast('success', `已切換至 ${year} 學年度`);
            } catch (e) {
                console.error(e);
                showToast('error', `無法讀取 ${year} 學年度模板`);
            }
        }

        // --- Logic: File Import (Using ExcelJS for hidden sheet support) ---
        async function handleFileUpload(event) {
            // 2. Alert on file overwrite
            if(allRawData.length > 0) {
                const confirmOverwrite = await showConfirm('確認覆蓋？', '確定要匯入新檔案嗎？這將會清除目前的資料與歸戶設定。');
                if(!confirmOverwrite) {
                    event.target.value = '';
                    return;
                }
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const arrayBuffer = e.target.result;
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);

                    // 1. Read Metadata
                    let fieldMap = {}; 
                    const metaSheet = workbook.getWorksheet('_System_Metadata');
                    if (metaSheet) {
                        metaSheet.eachRow((row, rowNumber) => {
                            if (rowNumber > 1) { 
                                const id = row.getCell(1).value;
                                const label = row.getCell(2).value;
                                if (id && label) fieldMap[label] = id;
                            }
                        });
                    }

                    // 2. Read Main Data
                    let mainSheet = null;
                    workbook.eachSheet((sheet) => {
                        if (!mainSheet && sheet.state === 'visible') mainSheet = sheet;
                    });
                    if (!mainSheet) mainSheet = workbook.getWorksheet(1); 

                    const jsonData = [];
                    const headers = [];
                    
                    // ★★★ 核心修正：純文字安全過濾器 ★★★
                    // 防止 Excel 的 RichText (粗體/顏色樣式) 或公式物件被轉成巨大 JSON 塞爆暫存
                    const getSafeValue = (cell) => {
                        const val = cell.value;
                        if (val === null || val === undefined) return '';
                        
                        if (typeof val === 'object') {
                            if (val.richText) return val.richText.map(rt => rt.text).join(''); // 剝除格式，只留文字
                            if (val.result !== undefined) return val.result; // 如果是公式，只取計算結果
                            if (val.text !== undefined) return val.text;     // 如果是超連結，只取顯示文字
                            if (val instanceof Date) {
                                // 安全處理日期格式，避免時區偏移
                                const y = val.getFullYear();
                                const m = String(val.getMonth() + 1).padStart(2, '0');
                                const d = String(val.getDate()).padStart(2, '0');
                                return `${y}-${m}-${d}`;
                            }
                            return String(val); // 其他未知物件強制轉字串
                        }
                        return String(val).trim();
                    };

                    // 讀取表頭 (同樣套用安全過濾)
                    mainSheet.getRow(1).eachCell((cell, colNumber) => {
                        headers[colNumber] = getSafeValue(cell);
                    });

                    // 讀取資料內容
                    mainSheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const rowData = {};
                            row.eachCell((cell, colNumber) => {
                                let header = headers[colNumber];
                                if (fieldMap[header]) header = fieldMap[header];
                                
                                // ★ 套用安全讀取，將乾淨的字串存入
                                rowData[header] = getSafeValue(cell); 
                            });
                            if(Object.keys(rowData).length > 0) jsonData.push(rowData);
                        }
                    });

                    // 3. Read Consolidation Data
                    let savedApps = [];
                    const conSheet = workbook.getWorksheet('_Consolidation_Data');
                    if (conSheet) {
                        const conHeaders = [];
                        conSheet.getRow(1).eachCell((cell, colNumber) => {
                            conHeaders[colNumber] = cell.value;
                        });
                        conSheet.eachRow((row, rowNumber) => {
                            if (rowNumber > 1) {
                                const rowData = {};
                                row.eachCell((cell, colNumber) => {
                                    rowData[conHeaders[colNumber]] = cell.value;
                                });
                                savedApps.push({
                                    id: rowData['App_ID'],
                                    studentId: rowData['Student_ID'],
                                    courseIds: rowData['Course_IDs'] ? rowData['Course_IDs'].toString().split(',') : [],
                                    formData: rowData['Form_Data'] ? JSON.parse(rowData['Form_Data']) : {}
                                });
                            }
                        });
                    }
                    
                    // 4. Read Audit Log
                    const logSheet = workbook.getWorksheet('_Audit_Log');
                    if (logSheet) {
                        const logHeaders = [];
                        logSheet.getRow(1).eachCell((c, i) => logHeaders[i] = c.value);
                        logSheet.eachRow((r, i) => {
                            if(i > 1) {
                                const l = {};
                                r.eachCell((c, idx) => l[logHeaders[idx]] = c.value);
                                changeLogs.push(l);
                            }
                        });
                    }

                    // 5. ★★★ Read Institution Library (還原機構庫) ★★★
                    const libSheet = workbook.getWorksheet('_Institution_Library');
                    if (libSheet) {
                        libSheet.eachRow((row, rowNumber) => {
                            if (rowNumber > 1) {
                                const name = row.getCell(1).value;
                                const jsonStr = row.getCell(2).value; // 注意欄位索引要對應 export
                                
                                if (name && jsonStr) {
                                    try {
                                        const entry = JSON.parse(jsonStr);
                                        
                                        if (!institutionLibrary[name]) {
                                            institutionLibrary[name] = [];
                                        }
                                        
                                        // 指紋檢查 (避免重複)
                                        const generateFingerprint = (e) => {
                                            const keys = Object.keys(e).filter(k => !k.startsWith('_')).sort();
                                            const clean = {};
                                            keys.forEach(k => clean[k] = e[k]);
                                            return JSON.stringify(clean);
                                        };
                                        const newFingerprint = generateFingerprint(entry);
                                        
                                        const exists = institutionLibrary[name].some(e => generateFingerprint(e) === newFingerprint);
                                        
                                        if (!exists) {
                                            institutionLibrary[name].push(entry);
                                        }
                                    } catch (e) { console.error("Lib entry parse error", e); }
                                }
                            }
                        });
                        
                        // 若啟用暫存則同步寫入
                        if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                            // ★ 修正：加入 compressToUTF16 壓縮
                            localStorage.setItem(LIB_STORAGE_KEY, LZString.compressToUTF16(JSON.stringify(institutionLibrary)));
                        }
                    }

                    if (jsonData.length === 0) throw new Error("檔案無內容");
                    
                    await processUploadedData(jsonData, savedApps);
                    
                    event.target.value = ''; 
                } catch (err) {
                    console.error(err);
                    showToast('error', `讀取失敗: ${err.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processUploadedData(data, savedApps = []) {
            allRawData = data;
            groupedStudents = {};
            
            // A. 偵測學年度
            let detectedYear = null;
            if (data.length > 0) {
                const yKeys = ['school_year', 'academic_year', '學年', '學年度'];
                const firstRow = data[0];
                const rowKeys = Object.keys(firstRow);
                for (const key of yKeys) {
                    const target = key.toLowerCase();
                    const foundKey = rowKeys.find(k => k.trim().toLowerCase() === target);
                    if (foundKey && firstRow[foundKey]) {
                        detectedYear = firstRow[foundKey];
                        break;
                    }
                }
                if (detectedYear) {
                    detectedYear = detectedYear.toString().trim();
                    await changeYear(detectedYear); 
                    showToast('info', `已自動辨識並切換至 ${detectedYear} 學年度`);
                }
            }
            
            const currentY = activeYear || '114';

            // B. 輔助函式：強力讀值
            const getValue = (row, possibleKeys) => {
                const rowKeys = Object.keys(row);
                for (const key of possibleKeys) {
                    const target = key.toLowerCase();
                    if (row[key] !== undefined && row[key] !== null && String(row[key]).trim() !== '') {
                        return String(row[key]).trim();
                    }
                    const foundKey = rowKeys.find(k => k.trim().toLowerCase() === target);
                    if (foundKey && row[foundKey] !== undefined && row[foundKey] !== null && String(row[foundKey]).trim() !== '') {
                        return String(row[foundKey]).trim();
                    }
                }
                return '';
            };

            // C. 輔助函式：系所 Master Data 搜尋
            const findDeptMaster = (query) => {
                if (!deptMasterData || !query) return null;
                const q = query.toString().trim();
                
                if (deptMasterData[q]) return deptMasterData[q];

                for (const key in deptMasterData) {
                    const m = deptMasterData[key];
                    if (m.code == q || m.name === q || m.short_name === q) return m;
                    if (m.historical_names && Object.values(m.historical_names).includes(q)) return m;
                }
                return null;
            };

            const courseDepts = new Set();
            const studentDepts = new Set();
            const courseCounters = {}; 

            // D. 遍歷資料
            allRawData.forEach((row, idx) => {
                const sid = getValue(row, ['student_id', '學號', 'id', 'std_no']);
                const sname = getValue(row, ['student_name', '姓名', 'name']);
                const rawDept = getValue(row, ['student_department', 'student_dept', '系所', 'department', 'dept']);
                const sgrade = getValue(row, ['student_grade', 'grade', '年級', 'level']);
                const cdept = getValue(row, ['course_dept', '開課系所']);
                
                if (rawDept) studentDepts.add(rawDept);
                if (cdept) {
                    courseDepts.add(cdept);
                    row.course_dept = cdept; 
                }

                if (!sid) return;

                // 建立或更新學生
                if (!groupedStudents[sid]) {
                    let deptDisplay = rawDept;
                    const master = findDeptMaster(rawDept);
                    
                    if (master) {
                        deptDisplay = master.short_name || 
                                      (master.historical_names && master.historical_names[currentY]) || 
                                      master.name || 
                                      rawDept;
                    }
                    if (!deptDisplay || deptDisplay === 'undefined') deptDisplay = '未分系';

                    groupedStudents[sid] = {
                        id: sid,
                        name: sname || '未知',
                        dept: deptDisplay, 
                        grade: sgrade, 
                        courses: [],
                        applications: [] 
                    };
                } else {
                    // 資料互補
                    const existing = groupedStudents[sid];
                    if (!existing.grade && sgrade) existing.grade = sgrade;
                    if ((!existing.dept || existing.dept === '未分系') && rawDept) {
                        let newDisplay = rawDept;
                        const master = findDeptMaster(rawDept);
                        if (master) newDisplay = master.short_name || master.name || rawDept;
                        existing.dept = newDisplay;
                    }
                }
                
                // 課程 ID 生成
                const rYear = getValue(row, ['school_year', '學年', 'academic_year']);
                const rSem = getValue(row, ['semester', '學期']);
                const rCode = getValue(row, ['course_code', '選課代號']);
                
                if (rYear && rSem && rCode) {
                     const baseKey = `${sid}_${rYear}${rSem}_${rCode}`;
                     if (!courseCounters[baseKey]) courseCounters[baseKey] = 0;
                     courseCounters[baseKey]++;
                     let stableId = `${rYear}${rSem}_${rCode}`;
                     if (courseCounters[baseKey] > 1) stableId += `_${courseCounters[baseKey]}`;
                     row._internal_id = stableId;
                } else {
                     row._internal_id = `temp_c_${idx}`;
                }
                row._app_id = null; 
                groupedStudents[sid].courses.push(row);
            });

            // E. 還原設定
            if (savedApps && savedApps.length > 0) {
                savedApps.forEach(app => {
                    const student = groupedStudents[app.studentId];
                    if (student) {
                        const validCourseIds = [];
                        app.courseIds.forEach(cid => {
                             const exists = student.courses.find(c => c._internal_id === cid);
                             if(exists) { validCourseIds.push(cid); exists._app_id = app.id; }
                        });
                        if(validCourseIds.length > 0) {
                             student.applications.push({ id: app.id, courseIds: validCourseIds, formData: app.formData });
                        }
                    }
                });
                showToast('success', `已還原 ${savedApps.length} 筆歸戶設定`);
            }

            // F. 自動歸戶偵測
            const singleCourseStudents = Object.values(groupedStudents).filter(s => 
                s.courses.length === 1 && !s.courses[0]._app_id
            );

            if (singleCourseStudents.length > 0) {
                const confirmAuto = await showConfirm('自動歸戶偵測', `偵測到有 ${singleCourseStudents.length} 位學生僅有一門課程。\n是否要直接為他們建立歸戶？`);
                if (confirmAuto) {
                    let autoSingleCount = 0;
                    const fields = currentYearConfig.fields || [];
                    const writableFields = fields.filter(f => !f.isSystem && !CORE_FIELDS.includes(f.id) && f.category !== 'sys_course_info');

                    singleCourseStudents.forEach(student => {
                        const course = student.courses[0];
                        const appId = 'app_auto_imp_' + Date.now() + Math.random().toString(36).substr(2, 5);
                        const initData = {};
                        writableFields.forEach(f => {
                            const val = course[f.id];
                            if (val !== undefined && val !== null && String(val).trim() !== "") initData[f.id] = val;
                        });
                        
                        const instName = getValue(course, ['internship_institution_name', '實習機構', '機構名稱']);
                        if (instName) initData['internship_institution_name'] = instName;

                        const newApp = { id: appId, courseIds: [course._internal_id], formData: initData };
                        student.applications.push(newApp);
                        course._app_id = appId;
                        autoSingleCount++;
                    });
                    setTimeout(() => showToast('success', `已自動歸戶 ${autoSingleCount} 筆單一課程資料`), 500);
                }
            }
            
            updateSidebarFilters();
            renderStudentList();
            hasUnsavedChanges = false;
            

            // ★★★ 4. 新增：匯入檔案後，強制重置主畫面回空狀態 ★★★
            currentStudentId = null; 
            document.getElementById('form-container').classList.add('hidden'); 
            document.getElementById('form-empty-state').classList.remove('hidden'); 
            
            // 清除 Header 殘留資訊
            document.getElementById('header-name').innerText = '學生姓名';
            document.getElementById('header-id').innerText = 'ID';
            document.getElementById('header-dept').innerHTML = '<i class="fas fa-graduation-cap mr-1"></i>系所';
            document.getElementById('header-avatar').innerText = '?';
            saveToLocal();
        }

        function getAppFillStatus(app) {
            if (!currentYearConfig || !currentYearConfig.fields) return false;
            let isComplete = true;
            
            for (let f of currentYearConfig.fields) {
                // 只檢查後台被勾選為「必填」的欄位
                if (!f.required) continue;
                
                // 檢查該欄位目前是否因為「顯示條件(Visibility)」邏輯而被隱藏
                // 如果被隱藏了，就算沒填也算是完整
                let isVisible = true;
                if (f.visibilityRule && f.visibilityRule.dep) {
                    let depVal = app.formData[f.visibilityRule.dep];
                    if (depVal === undefined) depVal = '';
                    
                    let targetVal = f.visibilityRule.val;
                    if (typeof targetVal === 'boolean') {
                        depVal = (depVal === 'true' || depVal === true);
                    }
                    
                    let conditionMet = (String(depVal) === String(targetVal));
                    if (f.visibilityRule.action === 'hide') {
                        isVisible = !conditionMet;
                    } else {
                        isVisible = conditionMet;
                    }
                }
                
                // 如果欄位可見且必填，但完全沒有值，則視為未完成 (填報中)
                if (isVisible) {
                    let val = app.formData[f.id];
                    if (val === undefined || val === null || String(val).trim() === '') {
                        isComplete = false;
                        break;
                    }
                }
            }
            return isComplete;
        }
        
        function updateSidebarFilters() {
            const courseDepts = new Set();
            const studentDepts = new Set();
            
            Object.values(groupedStudents).forEach(s => {
                // 1. 學生系所：去除多餘空白防呆
                if (s.dept && s.dept !== '未分系') studentDepts.add(s.dept.trim()); 
                
                if (s.courses) {
                    s.courses.forEach(c => {
                        // 2. 開課系所：★ 更強大的防呆抓取 (涵蓋多種可能屬性名稱，並去除空白)
                        const cd = c.course_dept || c['開課學系'] || c.offering_department || c['開課系所'] || c['開課系'] || c['course_department'];
                        if (cd) courseDepts.add(cd.trim());
                    });
                }
            });

            const courseSel = document.getElementById('filter-course-dept');
            const studentSel = document.getElementById('filter-student-dept');

            if (courseSel) {
                const curr = courseSel.value;
                courseSel.innerHTML = '<option value="">全部開課系</option>' + 
                    Array.from(courseDepts).sort().map(d => `<option value="${d}">${d}</option>`).join('');
                courseSel.value = courseDepts.has(curr) ? curr : "";
                courseSel.onchange = renderStudentList;
            }

            if (studentSel) {
                const curr = studentSel.value;
                studentSel.innerHTML = '<option value="">全部學生系</option>' + 
                    Array.from(studentDepts).sort().map(d => `<option value="${d}">${d}</option>`).join('');
                studentSel.value = studentDepts.has(curr) ? curr : "";
                studentSel.onchange = renderStudentList;
            }
            
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.oninput = renderStudentList;
        }
        
        // --- 修正: 渲染左側名單 (修復系所顯示、卡片式排版、選取高亮) ---
        function renderStudentList() {
            const listEl = document.getElementById('student-list');
            const countEl = document.getElementById('student-count');
            if (!listEl) return;
            
            // ★ 取值時統一加上 trim() 消除看不見的空白
            const filterCourseDept = document.getElementById('filter-course-dept')?.value.trim() || '';
            const filterStudentDept = document.getElementById('filter-student-dept')?.value.trim() || '';
            const filterStatus = document.getElementById('filter-status')?.value || '';
            const searchKw = document.getElementById('search-input')?.value.toLowerCase() || '';

            listEl.innerHTML = '';
            
            // 1. 將物件轉為陣列並執行「篩選」
            const studentsArr = Object.values(groupedStudents);
            const filtered = studentsArr.filter(s => {
                
                // A. 開課系篩選 (★ 強力防呆：支援多種屬性與去空白比對)
                if (filterCourseDept !== '') {
                    const hasCourse = s.courses.some(c => {
                        const cd = c.course_dept || c['開課學系'] || c.offering_department || c['開課系所'] || c['開課系'] || c['course_department'] || '';
                        return cd.trim() === filterCourseDept;
                    });
                    if (!hasCourse) return false;
                }

                // B. 學生系篩選 (★ 加上 trim 防呆)
                if (filterStudentDept !== '' && s.dept?.trim() !== filterStudentDept) return false;
                
                // C. 關鍵字搜尋
                if (searchKw !== '' && !(s.id.toLowerCase().includes(searchKw) || (s.name && s.name.toLowerCase().includes(searchKw)))) return false;
                
                // D. 填報進度細分篩選
                const apps = s.applications || [];
                const assignedIds = new Set();
                apps.forEach(app => { (app.courseIds || []).forEach(id => assignedIds.add(id)); });
                const unassignedCount = (s.courses || []).filter(c => !assignedIds.has(c._internal_id)).length;
                let completeCount = 0;
                apps.forEach(app => { if (getAppFillStatus(app)) completeCount++; });

                const isFullyCompleted = (apps.length > 0 && completeCount === apps.length && unassignedCount === 0);
                const isNotStarted = (apps.length === 0);

                if (filterStatus === 'completed' && !isFullyCompleted) return false;
                if (filterStatus === 'not_started' && !isNotStarted) return false;
                if (filterStatus === 'in_progress' && (isFullyCompleted || isNotStarted)) return false;
                
                return true;
            });

            // 2. 執行「排序」
            filtered.sort((a, b) => {
                const valA = String(a[sortConfig.key] || '');
                const valB = String(b[sortConfig.key] || '');
                const res = valA.localeCompare(valB, 'zh-Hant', { numeric: true });
                return sortConfig.direction === 'asc' ? res : -res;
            });

            // 3. 更新總計人數
            if (countEl) countEl.innerText = filtered.length;

            // 4. 渲染結果
            filtered.forEach(s => {
                const apps = s.applications || [];
                const assignedIds = new Set();
                apps.forEach(app => { (app.courseIds || []).forEach(id => assignedIds.add(id)); });
                const unassignedCount = (s.courses || []).filter(c => !assignedIds.has(c._internal_id)).length;
                
                let completeCount = 0;
                let inProgressCount = 0;
                apps.forEach(app => {
                    if (getAppFillStatus(app)) completeCount++;
                    else inProgressCount++;
                });

                let statusText = '';
                let statusColor = '';
                if (apps.length === 0) {
                    statusText = '未開始';
                    statusColor = 'bg-slate-100 text-slate-500';
                } else if (completeCount === apps.length && unassignedCount === 0) {
                    statusText = `${completeCount}筆已填報`;
                    statusColor = 'bg-emerald-100 text-emerald-700';
                } else {
                    let parts = [];
                    if (completeCount > 0) parts.push(`${completeCount}已填報`);
                    if (inProgressCount > 0) parts.push(`${inProgressCount}填報中`);
                    if (unassignedCount > 0) parts.push(`${unassignedCount}未歸戶`);
                    statusText = parts.join('，');
                    statusColor = 'bg-amber-100 text-amber-700'; 
                }

                let displayDept = s.dept || '未知學系';
                if (typeof departmentData !== 'undefined' && Array.isArray(departmentData)) {
                    let foundShortName = null;
                    for (let college of departmentData) {
                        if (college.departments && Array.isArray(college.departments)) {
                            for (let dept of college.departments) {
                                if (dept.name === displayDept || dept.fullName === displayDept) {
                                    foundShortName = dept.shortName || dept.name;
                                    break;
                                }
                            }
                        }
                        if (foundShortName) break;
                    }
                    if (foundShortName) displayDept = foundShortName;
                }

                let rawGrade = s.grade || s.student_grade;
                if (!rawGrade && s.courses && s.courses.length > 0) {
                    rawGrade = s.courses[0].grade || s.courses[0].student_grade || s.courses[0]['學生年級'] || s.courses[0]['年級'];
                }
                
                let gradeLine = displayDept;
                if (rawGrade) {
                    let cleanGrade = String(rawGrade).replace(/年級/g, '').trim();
                    gradeLine += ` ｜ ${cleanGrade}年級`;
                }

                const isActive = s.id === currentStudentId ? 'active' : '';
                const html = `
                    <div class="student-item p-3 border-b border-slate-100 ${isActive}" 
                         style="box-shadow: inset 0 -1px 0 0 #e2e8f0;"
                         onclick="selectStudent('${s.id}')">
                        <div class="flex justify-between items-center mb-1">
                            <div class="student-name font-bold text-slate-800 text-sm truncate pr-2">
                                ${s.name || '未知姓名'} (${s.id})
                            </div>
                            <div class="shrink-0 text-[10px] font-bold px-2 py-0.5 rounded ${statusColor}">
                                ${statusText}
                            </div>
                        </div>
                        <div class="text-xs text-slate-500 truncate">
                            ${gradeLine}
                        </div>
                    </div>
                `;
                listEl.insertAdjacentHTML('beforeend', html);
            });

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs">沒有符合的學生名單</div>';
            }
        }
        
        function filterStudentList() { renderStudentList(); }
        
        function toggleSort(key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            
            const iconClass = sortConfig.direction === 'asc' ? 
                (key === 'id' ? 'fa-sort-numeric-down' : 'fa-sort-alpha-down') : 
                (key === 'id' ? 'fa-sort-numeric-up' : 'fa-sort-alpha-up');
            
            document.querySelectorAll('#sort-id-btn i, #sort-name-btn i').forEach(i => {
                if (i.parentElement.id === `sort-${key}-btn`) {
                    i.className = `fas ${iconClass}`;
                    i.parentElement.classList.add('text-primary', 'bg-slate-100');
                } else {
                    const otherKey = key === 'id' ? 'name' : 'id';
                    const defaultIcon = otherKey === 'id' ? 'fa-sort-numeric-down' : 'fa-sort-alpha-down';
                    i.className = `fas ${defaultIcon} opacity-50`;
                    i.parentElement.classList.remove('text-primary', 'bg-slate-100');
                }
            });

            renderStudentList();
        }

        function renderEmptyState() {
            const container = document.getElementById('dynamic-tabs-area');
            if(!container) return;
            
            // 清空內容並顯示提示
            // 修改：使用 absolute inset-0 強制填滿容器並置中，確保與列表模式位置完全一致
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center absolute top-0 bottom-10 right-0 left-4 bg-white z-20 border-b border-slate-200 animate-fade-in">
                    <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                        <i class="fas fa-folder-plus text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-600 mb-2">尚無實習紀錄</h3>
                    <p class="text-sm text-slate-500 mb-6">請先進行歸戶設定以開始填報</p>
                    <button onclick="openStudentSettingsModal(currentStudentId)" class="px-6 py-2 bg-primary text-white rounded-lg font-bold shadow-md hover:bg-sky-700 transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-cog"></i> 開啟歸戶設定
                    </button>
                </div>
            `;
            container.style.display = 'block';
            
            // 隱藏所有 tab content
            document.querySelectorAll('.dynamic-tab-content').forEach(d => d.style.display = 'none');
        }
        
        function selectStudent(sid) {
            currentStudentId = sid;
            currentActiveAppId = null; // ★★★ 新增：切換學生時，先重置選中的填報單
            renderStudentList();
            
            const student = groupedStudents[sid];
            document.getElementById('form-empty-state').classList.add('hidden');
            document.getElementById('form-container').classList.remove('hidden');
            
            // --- 1. 基本資訊 ---
            document.getElementById('header-name').innerText = student.name;
            document.getElementById('header-id').innerText = student.id;
            document.getElementById('header-avatar').innerText = student.name[0] || '?';
            
            // --- 2. 系級 (位於學號右邊) ---
            let deptText = (student.dept && student.dept !== 'undefined') ? student.dept : '系所未知';
            let gradeText = student.grade ? `${student.grade}年級` : '';
            let deptHtml = `<i class="fas fa-graduation-cap mr-1"></i>${deptText}`;
            if (gradeText) {
                deptHtml += ` <span class="mx-2 text-slate-300">|</span> ${gradeText}`;
            }
            document.getElementById('header-dept').innerHTML = deptHtml;

            // --- 3. 狀態統計 (位於歸戶按鈕右邊) ---
            const totalCourses = student.courses.length;
            const appCount = student.applications.length;
            const unassignedCount = student.courses.filter(c => !c._app_id).length;

            let statusHtml = "";
            if (appCount === 0) {
                statusHtml = `<span class="text-slate-400">共修習 ${totalCourses} 門課程，尚未建立任何實習紀錄</span>`;
            } else if (unassignedCount > 0) {
                statusHtml = `<span class="text-blue-600 font-bold">共修習 ${totalCourses} 門課程，已建立 ${appCount} 筆實習紀錄，未歸戶課程共 ${unassignedCount} 門</span>`;
            } else {
                statusHtml = `<span class="text-emerald-600 font-bold"><i class="fas fa-check-circle mr-1"></i>共修習 ${totalCourses} 門課程，已建立 ${appCount} 筆實習紀錄，無未歸戶的實習課程</span>`;
            }
            document.getElementById('header-status-text').innerHTML = statusHtml;

            // --- 4. 視圖與內容切換 ---
            setStudentViewMode(currentViewMode); 
            renderTabs(student);
            
            const dynamicArea = document.getElementById('dynamic-tabs-area');

            if (appCount > 0) {
                dynamicArea.innerHTML = '';
                // switchTab 會自動設定 currentActiveAppId
                switchTab(student.applications[0].id);
            } else {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
                renderEmptyState();
            }
        }
        
        function handleSettingsClick() {
            if (!currentStudentId) return;
            openStudentSettingsModal(currentStudentId);
        }
        
        function renderTabs(student) {
            const container = document.getElementById('tabs-container');
            container.innerHTML = '';
            
            student.applications.forEach((app, idx) => {
                const btn = document.createElement('button');
                
                // 1. 判斷是否為當前選中的頁籤，加上 active class
                const isActive = (app.id === currentActiveAppId);
                btn.className = isActive ? 'tab-btn active' : 'tab-btn';
                
                btn.dataset.tab = app.id;
                btn.onclick = () => switchTab(app.id);
                
                let label = `實習紀錄${idx+1}`;
                
                // 2. 計算填報率
                const stats = calculateAppStats(app);
                let statusHtml = '';
                
                // 3. 讀取 ineligible_reporting_check 欄位
                const isNotRequired = (app.formData['ineligible_reporting_check'] === true || app.formData['ineligible_reporting_check'] === 'true');
        
                if (isNotRequired) {
                    statusHtml = '<span class="w-2 h-2 rounded-full bg-red-500"></span><span class="text-xs text-red-600">無須填報</span>';
                } else if (stats.percent === 100) {
                    statusHtml = '<span class="w-2 h-2 rounded-full bg-emerald-500"></span><span class="text-xs text-emerald-600">完成填報</span>';
                } else if (stats.percent === 0) {
                    statusHtml = '<span class="w-2 h-2 rounded-full bg-slate-300"></span><span class="text-xs text-slate-400">尚未填報</span>';
                } else {
                    statusHtml = '<span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span><span class="text-xs text-blue-600">填報中</span>';
                }
                
                const courseCount = app.courseIds ? app.courseIds.length : 0;
                const courseBtnHtml = (isActive && courseCount > 0) 
                    ? `<span onclick="event.stopPropagation(); showCourseInfo('${student.id}', '${app.id}')" class="ml-2 px-2 py-0.5 rounded bg-white text-slate-500 border border-slate-200 hover:text-primary hover:border-primary hover:bg-slate-50 text-[11px] font-bold transition flex items-center gap-1.5 shadow-sm" title="點擊查看歸戶課程資訊">
                           <i class="fas fa-book-open"></i> ${courseCount} 門
                       </span>` 
                    : (courseCount > 0 ? `<span class="ml-2 text-[10px] text-slate-400 font-normal">(${courseCount}門)</span>` : '');

                btn.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="flex items-center gap-2 text-sm">
                            <i class="fas fa-file-alt text-slate-400"></i> ${label} ${courseBtnHtml}
                        </div>
                        <div class="flex items-center gap-1.5 opacity-90">
                            ${statusHtml}
                        </div>
                    </div>
                `;
                container.appendChild(btn);
            });
        }
        
        // ★ 新增：計算單一歸戶的填報數據 (供頁籤與進度條共用)
        function calculateAppStats(app) {
            const fields = currentYearConfig.fields || [];
            let required = 0;
            let filled = 0;
        
            fields.forEach(f => {
                if(f.isSystem || !f.required || f.category === 'sys_course_info') return;
        
                // 檢查 Visibility
                let isVisible = true;
                if (f.visibilityRule) {
                    const depId = f.visibilityRule.dep;
                    const depVal = app.formData[depId];
                    const currentValStr = (depVal !== undefined && depVal !== null) ? String(depVal).trim() : "";
                    
                    // 判斷依賴欄位是否為 Checkbox
                    const depFieldDef = fields.find(field => field.id === depId);
                    const isDepCheckbox = (depFieldDef && depFieldDef.type === 'checkbox');

                    // 規則 A: 非 Checkbox 且為空值 -> 視為隱藏 (與 evaluateLogic 同步)
                    if (!isDepCheckbox && currentValStr === "") {
                        isVisible = false;
                    } 
                    // 規則 B: 正常比對
                    else {
                        const ruleValStr = String(f.visibilityRule.val).trim();
                        if (f.visibilityRule.action === 'show') {
                            isVisible = (currentValStr === ruleValStr);
                        } else {
                            isVisible = (currentValStr !== ruleValStr);
                        }
                    }
                }
        
                if (isVisible) {
                    required++;
                    const val = app.formData[f.id];
                    // 修正：嚴謹判斷空值 (0 或 false 視為有效值)
                    if (val !== undefined && val !== null && String(val).trim() !== "") {
                        filled++;
                    }
                }
            });
        
            return { required, filled, percent: required > 0 ? Math.round((filled/required)*100) : 0 };
        }
        
        // ★ 新增：高亮未填欄位
        function highlightUnfilled(appId) {
            const student = groupedStudents[currentStudentId];
            if(!student) return;
            const app = student.applications.find(a => a.id === appId);
            if(!app) return;
        
            const fields = currentYearConfig.fields || [];
            let firstErrorId = null;
            let errorCount = 0;
        
            // 先清除所有舊的錯誤標記
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
        
            fields.forEach(f => {
                if(f.isSystem || !f.required || f.category === 'sys_course_info') return;
        
                // Visibility Check (與 calculateAppStats 邏輯保持一致)
                let isVisible = true;
                if (f.visibilityRule) {
                    const depId = f.visibilityRule.dep;
                    const depVal = app.formData[depId];
                    const currentValStr = (depVal !== undefined && depVal !== null) ? String(depVal).trim() : "";
                    
                    const depFieldDef = fields.find(field => field.id === depId);
                    const isDepCheckbox = (depFieldDef && depFieldDef.type === 'checkbox');

                    if (!isDepCheckbox && currentValStr === "") {
                        isVisible = false;
                    } else {
                        const ruleValStr = String(f.visibilityRule.val).trim();
                        if (f.visibilityRule.action === 'show') {
                            isVisible = (currentValStr === ruleValStr);
                        } else {
                            isVisible = (currentValStr !== ruleValStr);
                        }
                    }
                }
        
                if (isVisible) {
                    const val = app.formData[f.id];
                    const isUnfilled = (val === undefined || val === null || String(val).trim() === "");
                    
                    if (isUnfilled) {
                        // 標記錯誤
                        const wrapper = document.getElementById(`wrapper-${appId}-${f.id}`);
                        if(wrapper) {
                            wrapper.classList.add('field-error');
                            // 紀錄第一個錯誤的 ID (優先找 wrapper，視覺上比較準)
                            if(!firstErrorId) firstErrorId = `wrapper-${appId}-${f.id}`;
                            errorCount++;
                        }
                    }
                }
            });
        
            if(errorCount > 0) {
                showToast('warning', `共有 ${errorCount} 個必填欄位未完成，已用紅色標示`);
                
                // 捲動邏輯 (保持不變)
                if(firstErrorId) {
                    const el = document.getElementById(firstErrorId);
                    const container = document.getElementById('form-content-area');
                    const header = document.getElementById('sticky-progress-header');
                    
                    if (el && container) {
                        const headerHeight = (header && !header.classList.contains('hidden')) ? header.offsetHeight : 0;
                        const paddingBuffer = 20; 
                        
                        const elRect = el.getBoundingClientRect();
                        const containerRect = container.getBoundingClientRect();
                        const absoluteElTop = elRect.top - containerRect.top + container.scrollTop;
                        
                        const targetScroll = absoluteElTop - headerHeight - paddingBuffer;

                        container.scrollTo({
                            top: targetScroll,
                            behavior: 'smooth'
                        });
                    }
                }
            } else {
                showToast('success', '太棒了！所有必填欄位皆已完成');
            }
        }
        
        function switchTab(tabId) {
            currentActiveAppId = tabId;
            // 更新按鈕狀態
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if(btn) btn.classList.add('active');
            
            // 顯示動態內容區域
            const container = document.getElementById('dynamic-tabs-area');
            container.style.display = 'block';

            // 嘗試取得或建立內容
            let content = document.getElementById(`content-${tabId}`);
            if (!content) {
                content = createApplicationContent(tabId);
                container.appendChild(content);
            }
            
            // 切換顯示
            document.querySelectorAll('.dynamic-tab-content').forEach(d => d.style.display = 'none');
            content.style.display = 'block';
            updateAppProgress(tabId); 

            // ★ 新增：切換頁籤後，確保 Textarea 高度正確展開 (解決同步資料後 scrollHeight 為 0 的問題)
            setTimeout(() => {
                content.querySelectorAll('textarea.input-stylish').forEach(ta => {
                    ta.style.setProperty('height', '1px', 'important');
                    ta.style.setProperty('height', (ta.scrollHeight + 2) + 'px', 'important');
                });
            }, 50);
        }

        function createApplication() {
            const student = groupedStudents[currentStudentId];
            const checkboxes = document.querySelectorAll('.course-select-check:checked');
            if (checkboxes.length === 0) return showToast('error', '請先勾選至少一門課程');

            const ids = Array.from(checkboxes).map(cb => cb.value);
            const appId = 'app_' + Date.now();
            
            const firstC = student.courses.find(c => c._internal_id === ids[0]);
            const initData = {};
            
            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach(f => {
                    if (!CORE_FIELDS.includes(f.id) && !f.isSystem) {
                        const val = firstC[f.id] || firstC[f.label];
                        if (val) initData[f.id] = val;
                    }
                });
            }

            const newApp = { id: appId, courseIds: ids, formData: initData };
            ids.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = appId;
            });

            student.applications.push(newApp);
            
            hasUnsavedChanges = true; // Mark changes
            
            renderTabs(student);
            renderSettingsTab(student);
            renderStudentList(); 
            showToast('success', '已建立填報單');
            
            logChange('CreateApp', appId, '', 'Created', student.id);
        }

        async function deleteApplication(appId) {
            const confirmed = await showConfirm('確認刪除？', '確定要解除此歸戶嗎？填寫的資料將會遺失。');
            if (!confirmed) return;
            
            const student = groupedStudents[currentStudentId];
            const idx = student.applications.findIndex(a => a.id === appId);
            if (idx === -1) return;

            const app = student.applications[idx];
            app.courseIds.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = null;
            });

            student.applications.splice(idx, 1);
            hasUnsavedChanges = true;

            const dom = document.getElementById(`content-${appId}`);
            if(dom) dom.remove();

            // ★ 修改：使用 selectStudent 重新判斷狀態
            // 如果刪光了，selectStudent 會自動呼叫 renderEmptyState
            selectStudent(currentStudentId);
            
            showToast('success', '歸戶已解除');
            logChange('DeleteApp', appId, 'Existing', 'Deleted', student.id);
            saveToLocal();    
        }
        
        function createApplicationContent(appId) {
            const student = groupedStudents[currentStudentId];
            const app = student.applications.find(a => a.id === appId);
            
            const div = document.createElement('div');
            div.id = `content-${appId}`;
            div.className = 'dynamic-tab-content w-[95%] mx-auto space-y-6';
            
            const formContainer = document.createElement('div');
            formContainer.className = 'form-body pt-2'; 
            
            renderFields(formContainer, app);
            div.appendChild(formContainer);

            return div;
        }

        function createRocDatePicker(appId, fieldId, initialValue, onChange) {
            const wrapper = document.createElement('div');
            wrapper.className = 'date-picker-wrapper';
            wrapper.id = `roc-container-${appId}-${fieldId}`;

            const inputGroup = document.createElement('div');
            inputGroup.className = 'date-input-group';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'input-stylish';
            input.placeholder = '例: 114/01/01';
            input.maxLength = 10; 
            input.style.flex = "1";
            input.style.paddingRight = "35px"; 

            const trigger = document.createElement('div');
            trigger.className = 'date-picker-trigger';
            trigger.innerHTML = '<i class="fas fa-calendar-alt"></i>';
            trigger.onclick = (e) => {
                e.stopPropagation();
                toggleCalendar();
            };

            inputGroup.appendChild(input);
            inputGroup.appendChild(trigger);

            const popover = document.createElement('div');
            popover.className = 'calendar-popover';
            
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth(); 
            let selectedDate = null; 

            const renderCalendar = () => {
                const rocYear = currentYear - 1911;
                const monthName = currentMonth + 1;
                
                let html = `
                    <div class="cal-header">
                        <div class="cal-btn" id="prev-month"><i class="fas fa-chevron-left"></i></div>
                        <div class="cal-title">${rocYear}年 ${monthName}月</div>
                        <div class="cal-btn" id="next-month"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="cal-grid">
                        <div class="cal-day-header">日</div><div class="cal-day-header">一</div><div class="cal-day-header">二</div><div class="cal-day-header">三</div><div class="cal-day-header">四</div><div class="cal-day-header">五</div><div class="cal-day-header">六</div>
                `;

                const firstDay = new Date(currentYear, currentMonth, 1).getDay();
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                const today = new Date();

                for(let i=0; i<firstDay; i++) html += `<div class="cal-day empty"></div>`;

                for(let d=1; d<=daysInMonth; d++) {
                    let classes = 'cal-day';
                    if(currentYear === today.getFullYear() && currentMonth === today.getMonth() && d === today.getDate()) classes += ' today';
                    if(selectedDate && currentYear === selectedDate.getFullYear() && currentMonth === selectedDate.getMonth() && d === selectedDate.getDate()) classes += ' selected';
                    html += `<div class="${classes}" data-day="${d}">${d}</div>`;
                }

                html += `</div>`; 
                popover.innerHTML = html;

                popover.querySelector('#prev-month').onclick = (e) => { e.stopPropagation(); currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); };
                popover.querySelector('#next-month').onclick = (e) => { e.stopPropagation(); currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); };
                popover.querySelectorAll('.cal-day:not(.empty)').forEach(el => {
                    el.onclick = (e) => {
                        e.stopPropagation();
                        const d = parseInt(el.dataset.day);
                        selectedDate = new Date(currentYear, currentMonth, d);
                        const rocY = currentYear - 1911;
                        const mm = String(currentMonth + 1).padStart(2, '0');
                        const dd = String(d).padStart(2, '0');
                        const formatted = `${rocY}/${mm}/${dd}`;
                        input.value = formatted;
                        const stdVal = `${currentYear}-${mm}-${dd}`;
                        onChange(stdVal); 
                        popover.classList.remove('active');
                    };
                });
            };

            const toggleCalendar = () => {
                const isActive = popover.classList.contains('active');
                document.querySelectorAll('.calendar-popover.active').forEach(p => p.classList.remove('active')); 
                if(!isActive) {
                    if(input.value) {
                        let y, m, d;
                        const val = input.value.replace(/\//g, '');
                        if(val.length >= 6) { 
                            if(val.includes('-')) {
                                const p = val.split('-');
                                y = parseInt(p[0]); m = parseInt(p[1])-1; d = parseInt(p[2]);
                            } else {
                                if(val.length === 7) {
                                    y = parseInt(val.substring(0,3)) + 1911;
                                    m = parseInt(val.substring(3,5)) - 1;
                                    d = parseInt(val.substring(5,7));
                                } else if (val.length === 6) { 
                                    y = parseInt(val.substring(0,2)) + 1911;
                                    m = parseInt(val.substring(2,4)) - 1;
                                    d = parseInt(val.substring(4,6));
                                }
                            }
                            if(y && !isNaN(m) && d) {
                                currentYear = y;
                                currentMonth = m;
                                selectedDate = new Date(y, m, d);
                            }
                        }
                    }
                    renderCalendar();
                    popover.classList.add('active');
                }
            };

            input.onchange = (e) => {
                const val = e.target.value.trim();
                const cleanVal = val.replace(/\//g, '');
                if (cleanVal.length >= 6 && !isNaN(cleanVal)) {
                    let rocY, mm, dd;
                    if(cleanVal.length === 7) {
                        rocY = parseInt(cleanVal.substring(0,3));
                        mm = cleanVal.substring(3,5);
                        dd = cleanVal.substring(5,7);
                    } else if (cleanVal.length === 6) {
                         rocY = parseInt(cleanVal.substring(0,2));
                         mm = cleanVal.substring(2,4);
                         dd = cleanVal.substring(4,6);
                    }
                    if (rocY && mm && dd) {
                        input.value = `${rocY}/${mm}/${dd}`;
                        const westY = rocY + 1911;
                        onChange(`${westY}-${mm}-${dd}`);
                    } else {
                        onChange(val); 
                    }
                } else if (val === "") {
                    onChange("");
                } else {
                    onChange(val); 
                }
            };

            if(initialValue) {
                if(initialValue.includes('-')) {
                    const p = initialValue.split('-');
                    if(p.length === 3) {
                        const roc = parseInt(p[0]) - 1911;
                        input.value = `${roc}/${p[1]}/${p[2]}`;
                    } else {
                        input.value = initialValue;
                    }
                } else {
                    input.value = initialValue;
                }
            }

            document.addEventListener('click', (e) => {
                if(!wrapper.contains(e.target)) {
                    popover.classList.remove('active');
                }
            });

            wrapper.appendChild(inputGroup);
            wrapper.appendChild(popover);
            return wrapper;
        }

        function cnToNum(cnStr) {
            const units = { '': 1, '十': 10 };
            const nums = { '一': 1, '二': 2, '三': 3, '四': 4, '五': 5, '六': 6, '七': 7, '八': 8, '九': 9, '零': 0 };
            let result = 0;
            let temp = 0;

            for (let i = 0; i < cnStr.length; i++) {
                const char = cnStr[i];
                if (nums[char] !== undefined) {
                    temp = nums[char];
                } else if (units[char] === 10) {
                    result += (temp || 1) * units[char];
                    temp = 0;
                }
            }
            result += temp;
            return result;
        }

        function processAddress(inputEl, settings) {
            let val = inputEl.value;
            if(!val) return;

            if(settings.toHalf) {
                val = val.replace(/[\uff01-\uff5e]/g, function(ch) { return String.fromCharCode(ch.charCodeAt(0) - 0xfee0); }).replace(/　/g, " ");
            }

            if(settings.forceTai) {
                val = val.replace(/台/g, '臺'); 
            }

            if(settings.latinToEng) {
                val = val.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            if(settings.smartFormat) {
                const cnNumsPattern = '(一|二|三|四|五|六|七|八|九|十|零)+';
                const keywords = (globalConfig.addressRules && globalConfig.addressRules.keywords) ? globalConfig.addressRules.keywords : ['段', '路', '街', '巷', '弄', '號', '樓'];
                
                keywords.forEach(k => {
                    const regex = new RegExp(`(${cnNumsPattern})${k}`, 'g');
                    val = val.replace(regex, (match, p1) => {
                        let num = 0;
                        const isLiteral = p1.includes('零') || (p1.length >= 2 && !p1.includes('十'));
                        if (isLiteral) {
                             let tempStr = "";
                             const literalMap = { '一': '1', '二': '2', '三': '3', '四': '4', '五': '5', '六': '6', '七': '7', '八': '8', '九': '9', '零': '0', '十': '10' }; 
                             for (let char of p1) if (literalMap[char]) tempStr += literalMap[char];
                             num = parseInt(tempStr);
                        } else {
                             num = cnToNum(p1);
                        }
                        const isProtected = (globalConfig.addressRules && globalConfig.addressRules.protected) ? globalConfig.addressRules.protected.includes(match.replace(p1, '').trim()) : false;
                        if (num > 0 && !isProtected) return `${num}${k}`;
                        return match;
                    });
                });
            }

            if(val !== inputEl.value) {
                inputEl.value = val;
                inputEl.dispatchEvent(new Event('change'));
            }
        }

        function renderFields(container, app) {
            const fields = currentYearConfig.fields || [];
            
            const visibleFields = fields.filter(f => 
                !f.isSystem && !CORE_FIELDS.includes(f.id) && f.category !== 'sys_course_info' && f.category !== 'sys_student_info'
            );

            if (visibleFields.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400">無須填報欄位</div>';
                return;
            }

            const categories = globalConfig.templateCategories || [];
            const fieldsByCat = {};
            const sortedFields = [...visibleFields].sort((a,b) => (a.order||0) - (b.order||0));

            sortedFields.forEach(f => {
                const cat = f.category || 'uncategorized';
                if(!fieldsByCat[cat]) fieldsByCat[cat] = [];
                fieldsByCat[cat].push(f);
            });

            const sortedCats = [...categories].sort((a,b) => a.order - b.order);
            if(fieldsByCat['uncategorized']) sortedCats.push({id: 'uncategorized', name: '其他資訊'});

            sortedCats.forEach(catDef => {
                const catFields = fieldsByCat[catDef.id];
                if(!catFields || catFields.length === 0) return;

                const title = document.createElement('h4');
                title.className = 'form-section-title';
                title.innerText = catDef.name;
                container.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-6';

                catFields.forEach(f => {
                    const wrapper = document.createElement('div');
                    const span = f.colSpan || 1; 
                    wrapper.className = `field-group ${f.id}-wrapper md:col-span-${span}`;
                    wrapper.id = `wrapper-${app.id}-${f.id}`;
                    
                    const label = document.createElement('label');
                    label.className = "block text-sm font-bold text-slate-700 mb-1 flex items-center";
                    label.innerHTML = `${f.label} ${f.required ? '<span class="text-red-500">*</span>' : ''}`;
                    
                    if(f.description) {
                        // ★ 將設定檔中可能出現的 \n 替換為網頁的 <br> 換行標籤
                        const formattedDesc = f.description.replace(/\\n|\n/g, '<br>');
                        label.innerHTML += `<div class="tooltip-container"><i class="fas fa-info-circle tooltip-icon"></i><span class="tooltip-text">${formattedDesc}</span></div>`;
                    }
                    wrapper.appendChild(label);

                    const val = app.formData[f.id];
                    let input;
                    
                    // ★★★ 定義更新資料的函式 (包含機構收集與 Checkbox 支援) ★★★
                    const updateData = (e) => {
                        let newVal;
                        // 修正：依據類型取值
                        if (e.target.type === 'checkbox') {
                            newVal = e.target.checked;
                        } else {
                            newVal = e.target.value;
                        }

                        const oldVal = app.formData[f.id];
                        if (f.type === 'address' && e.type === 'change') {
                            processAddress(e.target, f);
                            newVal = e.target.value;
                        }
                        
                        if (oldVal !== newVal) {
                            app.formData[f.id] = newVal;
                            
                            // 機構資訊收集
                            if (f.category === 'internship_institution_info' && typeof collectInstitutionData === 'function') {
                                collectInstitutionData(app.formData);
                            }

                            evaluateLogic(app);
                            hasUnsavedChanges = true;
                            logChange(f.id, app.id, oldVal, newVal, groupedStudents[currentStudentId].id); 
                        }
                    };

                    // --- 處理 ROC 日期 ---
                    if (f.type === 'date' && f.inputFormat === 'ROC') {
                        input = createRocDatePicker(app.id, f.id, val || '', (newValue) => {
                            const tempEvent = { target: { value: newValue, type: 'change' } };
                            updateData(tempEvent);
                        });
                        
                        const visInput = input.querySelector('input');
                        if(visInput) visInput.classList.add(`app-input-${app.id}-${f.id}`);
                        const hidden = document.createElement('input');
                        hidden.type = 'hidden';
                        hidden.id = `input-${app.id}-${f.id}`;
                        wrapper.appendChild(hidden);
                        wrapper.appendChild(input);
                        
                    } 
                    // --- 處理機構名稱 ---
                    else if (f.id === 'internship_institution_name') {
                        const inputGroup = document.createElement('div');
                        inputGroup.className = 'flex w-full';

                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = "input-stylish w-full rounded-r-none border-r-0";
                        input.value = val || '';
                        input.id = `input-${app.id}-${f.id}`; 
                        input.classList.add(`app-input-${app.id}-${f.id}`);

                        const viewBtn = document.createElement('div');
                        viewBtn.className = 'input-group-append-btn';
                        viewBtn.title = '開啟機構管理視窗';
                        viewBtn.innerHTML = '<i class="fas fa-building"></i>';
                        
                        viewBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (typeof openInstitutionList === 'function') {
                                openInstitutionList(); 
                            } else {
                                showToast('error', '系統錯誤：機構查詢功能尚未載入');
                            }
                        };

                        inputGroup.appendChild(input);
                        inputGroup.appendChild(viewBtn);
                        wrapper.appendChild(inputGroup);
                        
                        input.addEventListener('change', updateData);
                        input.addEventListener('input', (e) => {
                            app.formData[f.id] = e.target.value;
                            hasUnsavedChanges = true;
                        });
                    } 
                    // --- 【新增】處理 Checkbox 類型 ---
                    else if (f.type === 'checkbox') {
                        const boxWrapper = document.createElement('div');
                        boxWrapper.className = "flex items-center h-[42px] mt-0"; 

                        input = document.createElement('input');
                        input.type = 'checkbox';
                        input.className = "w-5 h-5 text-primary border-slate-300 rounded focus:ring-primary cursor-pointer transition";
                        
                        // 支援存成 boolean 或 'true' 字串
                        input.checked = (val === true || val === 'true');
                        
                        const textSpan = document.createElement('span');
                        textSpan.className = "ml-2 text-sm text-slate-600 cursor-pointer select-none";
                        textSpan.innerText = f.placeholder || "是"; 
                        textSpan.onclick = () => input.click();

                        input.id = `input-${app.id}-${f.id}`;
                        input.classList.add(`app-input-${app.id}-${f.id}`);
                        input.addEventListener('change', updateData);

                        boxWrapper.appendChild(input);
                        boxWrapper.appendChild(textSpan);
                        wrapper.appendChild(boxWrapper);
                    }
                    // --- 處理其他一般欄位 ---
                    else {
                        if (f.type === 'single_select') { // ★ 移除了 list
                            input = document.createElement('select');
                            input.className = "input-stylish cursor-pointer";
                            input.innerHTML = `<option value="">請選擇...</option>` + (f.options||[]).map(o => `<option value="${o}" ${o===val?'selected':''}>${o}</option>`).join('');
                        } else if (f.type === 'list') { 
                            input = document.createElement('textarea');
                            input.className = "input-stylish custom-scroll";
                            input.rows = 1;
                            input.style.minHeight = "42px"; 
                            input.style.resize = "none";
                            input.style.overflow = "hidden"; 
                            input.value = val || '';
                            
                            const autoResize = (el) => {
                                // ★ 關鍵：先設定為 auto 釋放高度，讓欄位可以「縮小」
                                el.style.setProperty('height', 'auto', 'important');
                                el.style.setProperty('height', el.scrollHeight + 'px', 'important');
                            };
                            
                            input.addEventListener('input', function() {
                                // 允許使用者完全清空欄位
                                if (this.value === '') {
                                    // 保持空白不強制補 1.
                                } else if (!/^\d+\.\s/.test(this.value)) {
                                    // 若打字但沒有編號開頭，自動補 1.
                                    this.value = '1. ' + this.value.replace(/^\d*\.?\s*/, '');
                                }
                                autoResize(this);
                            });
                            
                            input.addEventListener('keydown', handleListKeydown); 
                            
                            // 延遲初始化高度
                            setTimeout(() => autoResize(input), 0);
                            
                        } else if (f.type === 'date') {
                            input = document.createElement('input');
                            input.type = 'date';
                            input.className = "input-stylish";
                            input.value = val || '';
                        } else if (f.type === 'number') {
                            input = document.createElement('input');
                            input.type = 'number';
                            input.className = "input-stylish";
                            input.step = f.decimal ? '0.01' : '1';
                            input.value = val || '';
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.className = "input-stylish";
                            input.value = val || '';
                        }

                        input.id = `input-${app.id}-${f.id}`;
                        input.classList.add(`app-input-${app.id}-${f.id}`);
            
                        if (f.type === 'address') {
                            input.addEventListener('blur', (e) => {
                                const oldVal = input.value;
                                processAddress(e.target, f);
                                const newVal = e.target.value;
                                if(oldVal !== newVal) {
                                    app.formData[f.id] = newVal;
                                    updateData(e); 
                                }
                            });
                        }

                        input.addEventListener('change', updateData);
                        
                        if (f.type === 'text' || f.type === 'number' || f.type === 'address') {
                            input.addEventListener('input', (e) => {
                                hasUnsavedChanges = true;
                            });
                        }
                        
                        wrapper.appendChild(input);
                    }

                    grid.appendChild(wrapper);
                });
                container.appendChild(grid);
            });

            setTimeout(() => evaluateLogic(app), 0);
        }

        function updateAppProgress(appId) {
            const student = groupedStudents[currentStudentId];
            if(!student) return;
            const app = student.applications.find(a => a.id === appId);
            if(!app) return;
        
            const container = document.getElementById('sticky-progress-header');
            if(!container) return;
        
            const stats = calculateAppStats(app);
            const { required, filled, percent } = stats;
        
            const isComplete = percent === 100;
            const colorClass = isComplete ? 'text-emerald-600' : 'text-orange-500';
            const barColor = isComplete ? 'bg-emerald-500' : 'bg-orange-400';
            const btnClass = isComplete 
                ? 'hidden' 
                : 'px-3 py-1.5 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 rounded text-xs font-bold transition flex items-center gap-1 cursor-pointer';
        
            container.innerHTML = `
                <div class="flex items-center gap-4 w-full">
                    <div class="w-10 h-10 rounded-full bg-slate-50 flex-shrink-0 flex items-center justify-center text-primary border border-slate-100 shadow-sm">
                        <i class="fas fa-clipboard-check text-lg"></i>
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-center">
                        <div class="flex justify-between items-center mb-1">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">填報進度</div>
                            <div class="font-bold text-slate-700 text-xs">
                                已填 ${filled} / 應填 ${required}
                            </div>
                        </div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full ${barColor} transition-all duration-500 shadow-sm" style="width: ${percent}%"></div>
                        </div>
                    </div>
        
                    <div class="flex items-center gap-3 pl-4 border-l border-slate-100 h-full flex-shrink-0">
                        <span class="font-bold text-xl ${colorClass} w-12 text-right">${percent}%</span>
                        <button onclick="highlightUnfilled('${appId}')" class="${btnClass}">
                            <i class="fas fa-exclamation-circle"></i> 未填提示
                        </button>
                    </div>
                </div>
            `;
            
            // 【修正】: 只有在表單模式 (form) 下才顯示進度框，避免列表模式點擊側邊欄時跳出
            if (currentViewMode === 'form') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            
            renderTabs(student);
        }
        
        function evaluateLogic(app) {
            const fields = currentYearConfig.fields || [];
            
            fields.forEach(f => {
                const wrapper = document.getElementById(`wrapper-${app.id}-${f.id}`);
                let inputEl = document.getElementById(`input-${app.id}-${f.id}`);
                const rocContainer = document.getElementById(`roc-container-${app.id}-${f.id}`);
                
                if (!wrapper) return;

                let isLocked = false;

                // --- 1. Visibility 檢查 (修正：區分 Checkbox 與一般欄位的空值邏輯) ---
                if (f.visibilityRule && f.visibilityRule.dep) {
                    const depId = f.visibilityRule.dep;
                    const depVal = app.formData[depId];
                    const currentValStr = (depVal !== undefined && depVal !== null) ? String(depVal).trim() : "";
                    
                    // 判斷依賴欄位是否為 Checkbox (透過設定檔查找)
                    const depFieldDef = fields.find(field => field.id === depId);
                    const isDepCheckbox = (depFieldDef && depFieldDef.type === 'checkbox');

                    // 規則 A: 如果依賴欄位「不是」Checkbox 且值為空 (例如 Select 被鎖定清空時)，強制鎖定子欄位
                    // 這解決了「給付類型」被鎖定變成空值時，「給付金額」卻因為 "" !== "無" 而沒被鎖定的問題
                    if (!isDepCheckbox && currentValStr === "") {
                        isLocked = true;
                    } 
                    // 規則 B: 正常比對邏輯 (支援 Checkbox 的空值/False 視為 Show)
                    else {
                        const ruleValStr = String(f.visibilityRule.val).trim();
                        let shouldShow = true;
                        
                        if (f.visibilityRule.action === 'show') {
                            shouldShow = (currentValStr === ruleValStr);
                        } else {
                            shouldShow = (currentValStr !== ruleValStr);
                        }
                        
                        if (!shouldShow) isLocked = true;
                    }
                }

                // --- 2. Filter Rules 檢查 (選項連動) ---
                if (!isLocked && f.filterRules && f.filterRules.length > 0) {
                    const parentId = f.filterRules[0].dep;
                    const parentVal = app.formData[parentId];

                    if (!parentVal || parentVal === "") {
                        isLocked = true;
                    } else {
                        const rule = f.filterRules.find(r => r.val === parentVal);
                        if (!rule) {
                            isLocked = true;
                        } else if (inputEl && inputEl.tagName === 'SELECT') {
                            let isValid = false;
                            Array.from(inputEl.options).forEach(opt => {
                                if (opt.value === "") { isValid = true; return; }
                                const show = rule.limitTo && rule.limitTo.includes(opt.value);
                                opt.hidden = !show;
                                opt.disabled = !show;
                                if(inputEl.value === opt.value && show) isValid = true;
                            });
                            if (inputEl.value && !isValid) {
                                inputEl.value = "";
                                app.formData[f.id] = "";
                            }
                        }
                    }
                }

                // --- 3. UI 更新 ---
                if (isLocked) {
                    wrapper.classList.add('field-locked');
                    if (inputEl && inputEl.type !== 'hidden') {
                        inputEl.disabled = true;
                        if(inputEl.value !== "") {
                            inputEl.value = "";
                            app.formData[f.id] = "";
                        }
                        if(inputEl.type === 'checkbox') inputEl.checked = false;
                    }
                    if (rocContainer) {
                        const ri = rocContainer.querySelector('input');
                        if(ri) { ri.value = ""; ri.disabled = true; }
                        const btn = rocContainer.querySelector('.date-picker-trigger');
                        if(btn) btn.style.pointerEvents = 'none';
                    }
                    const btn = wrapper.querySelector('.input-group-append-btn');
                    if(btn) {
                        btn.style.pointerEvents = 'none';
                        btn.style.opacity = '0.5';
                    }
                } else {
                    wrapper.classList.remove('field-locked');
                    if (inputEl) inputEl.disabled = false;
                    if (rocContainer) {
                        rocContainer.querySelector('input').disabled = false;
                        const btn = rocContainer.querySelector('.date-picker-trigger');
                        if(btn) btn.style.pointerEvents = 'auto';
                    }
                    const btn = wrapper.querySelector('.input-group-append-btn');
                    if(btn) {
                        btn.style.pointerEvents = 'auto';
                        btn.style.opacity = '1';
                    }
                }
            });
            updateAppProgress(app.id);
        }
        
        async function exportData() {
            if(Object.keys(groupedStudents).length === 0) return showToast('error', '無資料可匯出');

            const workbook = new ExcelJS.Workbook();
            const ws = workbook.addWorksheet('填報資料');

            // 統一取得並「確保排序」的欄位定義
            let outputFields = [];
            if (currentYearConfig.fields) {
                outputFields = [...currentYearConfig.fields].sort((a,b) => (a.order||0) - (b.order||0));
            } else {
                outputFields = CORE_FIELDS.map(id => ({ id: id, label: id }));
            }

            const headers = outputFields.map(f => ({ key: f.id, header: f.label.replace(/\s*\(必填\)/g, '') }));
            ws.columns = headers;

            // --- 寫入資料邏輯 ---
            Object.values(groupedStudents).forEach(s => {
                s.applications.forEach(app => {
                    const courses = s.courses.filter(c => app.courseIds.includes(c._internal_id));
                    const courseCount = courses.length;

                    courses.forEach((c, idx) => {
                        const row = {};
                        headers.forEach(h => {
                            let val = app.formData[h.key];
                            const fieldDef = outputFields.find(f => f.id === h.key);
                            
                            if (fieldDef && fieldDef.calcMode === 'average' && val && !isNaN(val)) {
                                const totalVal = parseFloat(val);
                                const baseVal = Math.floor(totalVal / courseCount);
                                const remainder = totalVal % courseCount;
                                if (idx === courses.length - 1) val = (baseVal + remainder).toFixed(fieldDef.decimal || 0);
                                else val = baseVal.toFixed(fieldDef.decimal || 0);
                            }

                            if (val === undefined || val === "") val = c[h.key] || c[h.header] || "";
                            
                            if (fieldDef && fieldDef.type === 'date' && fieldDef.outputFormat === 'ROC' && val && val.includes('-')) {
                                 const parts = val.split('-');
                                 if (parts.length === 3) {
                                     const roc = parseInt(parts[0]) - 1911;
                                     val = `${roc}${parts[1]}${parts[2]}`; 
                                 }
                            }

                            row[h.key] = val;
                        });
                        ws.addRow(row);
                    });
                });

                const unassigned = s.courses.filter(c => !c._app_id);
                unassigned.forEach(c => {
                    const row = {};
                    headers.forEach(h => row[h.key] = c[h.key] || c[h.header] || "");
                    ws.addRow(row);
                });
            });

            // ★★★ 完全比照後台：樣式美化、顏色與唯讀鎖定設定 ★★★
            const fontStyle = { name: 'Microsoft JhengHei', size: 11 };
            const headerFont = { name: 'Microsoft JhengHei', size: 12, bold: true, color: { argb: 'FFFFFFFF' } }; // 後台標題字體大小為 12
            const thinBorder = { style: 'thin', color: { argb: 'FFB2B2B2' } };
            const borderStyle = { top: thinBorder, left: thinBorder, bottom: thinBorder, right: thinBorder };

            // ★ 修正 1：動態讀取 currentYearConfig 內的設定顏色 (完全比照 admin.html)
            const getCategoryColor = (catId) => {
                if (currentYearConfig.categoryColors && currentYearConfig.categoryColors[catId]) {
                    return currentYearConfig.categoryColors[catId].replace('#', '');
                }
                const defaults = {
                    'sys_course_info': '4F46E5', 
                    'sys_student_info': '219653',
                    'uncategorized': '94A3B8'
                };
                return defaults[catId] || '64748B'; 
            };

            const rowCount = ws.rowCount;
            const safeEndRow = Math.max(rowCount + 100, 100); // 確保樣式涵蓋到下方 100 列空白區
            
            // 1. 套用所有儲存格的框線、字體與背景色
            for (let r = 1; r <= safeEndRow; r++) {
                const row = ws.getRow(r);
                outputFields.forEach((field, idx) => {
                    const cell = row.getCell(idx + 1);
                    
                    cell.border = borderStyle;
                    cell.alignment = { vertical: 'middle', wrapText: true };
                    
                    let isLocked = false;

                    if (r === 1) {
                        cell.font = headerFont;
                        // 表頭套用後台設定顏色
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + getCategoryColor(field.category) } };
                        cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
                        isLocked = true; // 標題列永遠鎖定
                    } else {
                        cell.font = fontStyle;
                        isLocked = !!field.excelLocked; // 讀取設定檔的鎖定狀態

                        // ★ 唯讀(鎖定)欄位給予淺灰底色，可編輯欄位維持白底
                        if (isLocked) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
                        } else {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        }
                    }
                    
                    // ★ 寫入保護屬性
                    cell.protection = { locked: isLocked };
                });
            }

            // 2. 獨立套用欄寬與下拉選單驗證
            outputFields.forEach((f, i) => {
                const col = ws.getColumn(i + 1);
                
                let len = 0;
                for (let k = 0; k < f.label.length; k++) {
                    len += (f.label.charCodeAt(k) > 255) ? 2 : 1;
                }
                const minWidth = Math.max(len + 2, 12);
                col.width = f.excelWidth ? parseInt(f.excelWidth) : Math.min(minWidth, 50);
                
                // 下拉選單驗證 (延伸到 safeEndRow 範圍)
                if (f.type === 'single_select' && f.options && f.options.length > 0) {
                     const char = col.letter;
                     const listStr = f.options.join(',');
                     if(listStr.length < 255) {
                         ws.dataValidations.add(`${char}2:${char}${safeEndRow}`, {
                             type: 'list',
                             allowBlank: true,
                             showErrorMessage: true,
                             errorTitle: '輸入限制',
                             error: '請從下拉選單中選擇有效項目',
                             formulae: [`"${listStr}"`]
                         });
                     }
                }
            });

            // ★ 修正 2：啟用工作表保護 (沒有這段程式，上述的 locked 不會生效)
            await ws.protect('', {
                selectLockedCells: true,
                selectUnlockedCells: true,
                formatCells: true,     
                formatColumns: true,   
                formatRows: true,      
                insertRows: false,     
                deleteRows: false,     
                autoFilter: true,      
                sort: true             
            });

            // --- 隱藏工作表備份邏輯 (保持不變) ---
            const courseDataSheet = workbook.addWorksheet('_Course_Data', {state: 'hidden'});
            const sysCourseFields = (currentYearConfig.fields || []).filter(f => f.category === 'sys_course_info').map(f => ({ id: f.id, label: f.label }));
            const courseDataHeaders = [{ header: 'Course_Internal_ID', key: '_internal_id' }, { header: 'Student_ID', key: 'student_id' }, ...sysCourseFields.map(f => ({ header: f.id, key: f.id }))];
            courseDataSheet.columns = courseDataHeaders;
            Object.values(groupedStudents).forEach(s => { s.courses.forEach(c => { const rowData = { _internal_id: c._internal_id, student_id: s.id }; sysCourseFields.forEach(f => { rowData[f.id] = c[f.id] || ''; }); courseDataSheet.addRow(rowData); }); });

            const conSheet = workbook.addWorksheet('_Consolidation_Data', {state: 'hidden'});
            conSheet.columns = [{header: 'App_ID', key: 'id'}, {header: 'Student_ID', key: 'sid'}, {header: 'Course_IDs', key: 'cids'}, {header: 'Form_Data', key: 'data'}];
            Object.values(groupedStudents).forEach(s => { s.applications.forEach(app => { conSheet.addRow({ id: app.id, sid: s.id, cids: app.courseIds.join(','), data: JSON.stringify(app.formData) }); }); });

            const logSheet = workbook.addWorksheet('_Audit_Log', {state: 'hidden'});
            logSheet.columns = [{header: 'Time', key: 'time'}, {header: 'Field', key: 'field'}, {header: 'Old_Value', key: 'old'}, {header: 'New_Value', key: 'new'}, {header: 'Student', key: 'student'}, {header: 'App_ID', key: 'app'}];
            changeLogs.forEach(l => logSheet.addRow(l));

            const libSheet = workbook.addWorksheet('_Institution_Library', {state: 'hidden'});
            libSheet.columns = [{ header: 'Institution_Name', key: 'name' }, { header: 'Data_JSON', key: 'json' }];
            Object.keys(institutionLibrary).forEach(name => {
                const entries = institutionLibrary[name];
                if (Array.isArray(entries)) { entries.forEach(entry => { libSheet.addRow({ name: name, json: JSON.stringify(entry) }); }); }
            });

            const metaSheet = workbook.addWorksheet('_System_Metadata', {state: 'hidden'});
            metaSheet.columns = [{header:'Field_ID', key:'id'}, {header:'Field_Label', key:'label'}];
            if (currentYearConfig.fields) { currentYearConfig.fields.forEach(f => metaSheet.addRow({id: f.id, label: f.label})); }

            // 產生並下載
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `實習填報_${activeYear}_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('success', '匯出成功');
            
            hasUnsavedChanges = false;
        }

        function logChange(field, appId, oldVal, newVal, studentId) {
            if(oldVal === newVal) return;
            changeLogs.push({
                time: new Date().toISOString(),
                field: field,
                old: oldVal,
                new: newVal,
                student: studentId,
                app: appId
            });
        }

        let toastTimeout;
        function showToast(type, msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            // 1. 建立新的 Toast 元素
            const el = document.createElement('div');
            
            // 設定顏色
            let colorClass = 'bg-slate-800'; // 預設
            let iconClass = 'fa-info-circle';
            
            if (type === 'success') {
                colorClass = 'bg-emerald-600';
                iconClass = 'fa-check-circle';
            } else if (type === 'error') {
                colorClass = 'bg-red-600';
                iconClass = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                colorClass = 'bg-orange-500';
                iconClass = 'fa-exclamation-triangle';
            } else if (type === 'info') {
                colorClass = 'bg-sky-600';
                iconClass = 'fa-info-circle';
            }

            // 2. 設定樣式 (初始狀態: 透明 + 位移)
            // pointer-events-auto 確保訊息本身可以被點擊或選取
            el.className = `${colorClass} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto`;
            
            el.innerHTML = `
                <i class="fas ${iconClass} text-lg"></i> 
                <span class="font-bold text-sm tracking-wide">${msg}</span>
                <button class="ml-auto hover:text-slate-200 focus:outline-none p-1 transition-colors"><i class="fas fa-times"></i></button>
            `;

            // 3. 定義關閉函式
            const close = () => {
                // 執行動畫 (淡出 + 向下位移)
                el.classList.add('opacity-0', 'translate-y-10');
                el.classList.remove('mb-2'); // 移除間距讓動畫更順暢
                
                // 等待動畫結束後移除 DOM
                setTimeout(() => {
                    if (el.parentElement) el.remove();
                }, 300);
            };

            // 綁定關閉按鈕事件
            el.querySelector('button').onclick = close;

            // 4. 將元素加入容器
            // appendChild 會將新訊息加在最下方 (堆疊向上長)
            container.appendChild(el);

            // 5. 觸發進場動畫 (下一幀執行，讓 transition 生效)
            requestAnimationFrame(() => {
                el.classList.remove('translate-y-10', 'opacity-0');
            });

            // 6. 設定 3 秒後自動關閉
            setTimeout(close, 3000);
        }
        
        // 為了相容性保留 hideToast 函式名 (雖然現在邏輯都在 showToast 內處理了)
        function hideToast() {
            // 空函式，避免舊代碼呼叫報錯
        }

        // --- Helper: 寬鬆搜尋課程欄位值 ---
        function getCourseValue(courseObj, keys) {
            // 優先找完全符合的 key
            for (const k of keys) {
                if (courseObj[k] !== undefined && courseObj[k] !== null && courseObj[k] !== "") 
                    return courseObj[k];
            }
            // 若找不到，嘗試模糊比對 (忽略大小寫與空白)
            const rowKeys = Object.keys(courseObj);
            for (const k of keys) {
                const target = k.toLowerCase();
                const foundKey = rowKeys.find(rk => rk.toLowerCase().includes(target) || rk.replace(/\s/g,'') === target);
                if (foundKey && courseObj[foundKey]) return courseObj[foundKey];
            }
            return '-';
        }
        // --- 智慧自動歸戶邏輯 ---
        function tryAutoMerge(student, currentCourse) {
            // 1. 取得所有需要比對的欄位定義
            // 排除系統資訊、排除不須填寫的欄位
            const allFields = currentYearConfig.fields || [];
            const dataFields = allFields.filter(f => 
                !f.isSystem && 
                !CORE_FIELDS.includes(f.id) && 
                f.category !== 'sys_course_info' && 
                f.category !== 'sys_student_info'
            );

            // 2. 檢查目前這門課是否「填寫完成」
            // 定義：所有「當下可見」且「必填」的欄位都有值
            const isComplete = (course) => {
                for (const f of dataFields) {
                    // A. 檢查是否被鎖定 (Visibility)
                    let isVisible = true;
                    if (f.visibilityRule) {
                        const depVal = course[f.visibilityRule.dep];
                        isVisible = f.visibilityRule.action === 'show' ? depVal === f.visibilityRule.val : depVal !== f.visibilityRule.val;
                    }
                    if (!isVisible) continue; // 鎖定的欄位忽略，不算未填

                    // B. 檢查必填
                    if (f.required) {
                        const val = course[f.id];
                        if (val === undefined || val === null || String(val).trim() === "") {
                            return false; // 還有必填沒填
                        }
                    }
                }
                return true; // 所有該填的都填了
            };

            if (!isComplete(currentCourse)) return; // 自己都沒填完，不動作

            // 3. 尋找其他「也填寫完成」且「尚未歸戶」的課程
            const candidates = student.courses.filter(c => 
                !c._app_id && // 未歸戶
                c._internal_id !== currentCourse._internal_id && // 不是自己
                isComplete(c) // 也填完了
            );

            if (candidates.length === 0) return; // 沒人可以配對

            // 4. 比對邏輯
            const matchedCourses = [currentCourse];

            candidates.forEach(otherC => {
                let isMatch = true;
                for (const f of dataFields) {
                    // 忽略「平均型」數值欄位 (這些允許不同，因為要加總)
                    if (f.type === 'number' && f.calcMode === 'average') continue;

                    // 忽略鎖定的欄位 (假設鎖定欄位值為空或無意義)
                    let isVisible = true;
                    if (f.visibilityRule) {
                        const depVal = currentCourse[f.visibilityRule.dep];
                        isVisible = f.visibilityRule.action === 'show' ? depVal === f.visibilityRule.val : depVal !== f.visibilityRule.val;
                    }
                    if (!isVisible) continue;

                    // 比對值是否相同
                    const valA = String(currentCourse[f.id] || "").trim();
                    const valB = String(otherC[f.id] || "").trim();
                    if (valA !== valB) {
                        isMatch = false;
                        break;
                    }
                }

                if (isMatch) matchedCourses.push(otherC);
            });

            // 5. 如果找到匹配 (至少 2 門課一樣) -> 執行合併
            if (matchedCourses.length >= 2) {
                const newAppId = 'app_merge_' + Date.now();
                const initData = {};

                // A. 填入一般欄位 (取第一門課的值，因為大家都一樣)
                dataFields.forEach(f => {
                    if (f.type === 'number' && f.calcMode === 'average') return; // 先跳過平均欄位
                    
                    const val = currentCourse[f.id];
                    if (val !== undefined && val !== "") {
                        initData[f.id] = val;
                    }
                });

                // B. ★★★ 處理加總欄位 ★★★
                dataFields.filter(f => f.type === 'number' && f.calcMode === 'average').forEach(f => {
                    let sum = 0;
                    let hasVal = false;
                    matchedCourses.forEach(c => {
                        const v = parseFloat(c[f.id]);
                        if (!isNaN(v)) {
                            sum += v;
                            hasVal = true;
                        }
                    });
                    if (hasVal) {
                        // 依照小數點設定格式化
                        initData[f.id] = f.decimal ? sum.toFixed(2) : String(sum);
                    }
                });

                // C. 建立 Application 物件
                const newApp = {
                    id: newAppId,
                    courseIds: matchedCourses.map(c => c._internal_id),
                    formData: initData
                };

                // D. 綁定並更新狀態
                student.applications.push(newApp);
                matchedCourses.forEach(c => {
                    c._app_id = newAppId;
                });

                // E. 重新渲染
                renderGlobalGrid();
                
                // 顯示提示
                const names = matchedCourses.map(c => getCourseValue(c, ['course_name', '課程名稱'])).join('、');
                showToast('success', `已自動合併歸戶：${names} (數值已加總)`);
                
                logChange('AutoMerge', newAppId, '', 'Merged based on matching content', student.id);
            }
        }

        // --- 輔助：將 Raw Data 轉換為 Application (1對1轉換以保留資料) ---
        function convertRawToApps() {
            const fields = currentYearConfig.fields || [];
            const writableFields = fields
                .filter(f => !f.isSystem && !CORE_FIELDS.includes(f.id))
                .map(f => f.id);

            let changeCount = 0;

            Object.values(groupedStudents).forEach(student => {
                student.courses.forEach(course => {
                    if (!course._app_id) {
                        // 檢查這門課是否有資料
                        const initData = {};
                        let hasData = false;
                        
                        writableFields.forEach(fid => {
                            const val = course[fid];
                            if (val !== undefined && val !== null && String(val).trim() !== "") {
                                initData[fid] = val;
                                hasData = true;
                            }
                        });

                        if (hasData) {
                            // 建立新歸戶
                            const newAppId = 'app_saved_' + Date.now() + Math.random().toString(36).substr(2, 5);
                            const newApp = {
                                id: newAppId,
                                courseIds: [course._internal_id], // 1對1
                                formData: initData
                            };

                            student.applications.push(newApp);
                            course._app_id = newAppId;
                            changeCount++;
                        }
                    }
                });
            });

            if (changeCount > 0) {
                hasUnsavedChanges = true;
                logChange('BatchConvert', '', 'Raw', 'Converted to Apps', 'System');
            }
        }

        // --- 輔助：清除未歸戶的暫存資料 ---
        function clearRawData() {
            const fields = currentYearConfig.fields || [];
            const writableFields = fields
                .filter(f => !f.isSystem && !CORE_FIELDS.includes(f.id))
                .map(f => f.id);

            let changeCount = 0;

            Object.values(groupedStudents).forEach(student => {
                student.courses.forEach(course => {
                    if (!course._app_id) {
                        writableFields.forEach(fid => {
                            if (course[fid] !== undefined && course[fid] !== "") {
                                course[fid] = ""; // 清空
                                changeCount++;
                            }
                        });
                    }
                });
            });
            
            if (changeCount > 0) {
                hasUnsavedChanges = true; // 雖然清空了，但也算是一種變更（回復原狀）
            }
        }
        
        function autoGroupCourses() {
            if (!currentStudentId) return;
            const student = groupedStudents[currentStudentId];
            const unassigned = student.courses.filter(c => !c._app_id);

            if (unassigned.length === 0) {
                return showToast('info', '沒有尚未歸戶的課程');
            }

            const groups = {};
            unassigned.forEach(c => {
                let key = getCourseValue(c, ['course_name', '課程名稱', '科目名稱']);
                if (!key || key === '-') key = 'unknown_' + c._internal_id;
                if (!groups[key]) groups[key] = [];
                groups[key].push(c);
            });

            let createdCount = 0;
            Object.keys(groups).forEach(key => {
                const groupCourses = groups[key];
                if (groupCourses.length > 0) { 
                    const appId = 'app_auto_' + Date.now() + Math.random().toString(36).substr(2, 5);
                    const ids = groupCourses.map(c => c._internal_id);
                    
                    const firstC = groupCourses[0];
                    const initData = {};
                    const instName = getCourseValue(firstC, ['internship_institution_name', '實習機構', '機構名稱']);
                    if (instName && instName !== '-') {
                        initData['internship_institution_name'] = instName;
                    }
                    if (currentYearConfig.fields) {
                        currentYearConfig.fields.forEach(f => {
                             const val = getCourseValue(firstC, [f.id, f.label]);
                             if(val && val !== '-') initData[f.id] = val;
                        });
                    }

                    const newApp = { id: appId, courseIds: ids, formData: initData };
                    ids.forEach(cid => {
                        const c = student.courses.find(x => x._internal_id === cid);
                        if(c) c._app_id = appId;
                    });

                    student.applications.push(newApp);
                    logChange('AutoGroup', appId, '', `Grouped by ${key}`, student.id);
                    createdCount++;
                }
            });

            if (createdCount > 0) {
                hasUnsavedChanges = true;
                renderTabs(student);
                renderSettingsTab(student);
                renderStudentList();
                showToast('success', `已自動建立 ${createdCount} 筆歸戶紀錄`);
            } else {
                showToast('info', '沒有符合自動分組條件的課程');
            }
        }
        
        // ★★★ 核心輔助：更新單一列的邏輯 (鎖定狀態 & 下拉連動) ★★★
        function updateRowLogic(tr, dataContext, isUnassigned = false) {
            
            if (isUnassigned) return;
            
            const fields = currentYearConfig.fields || [];
            fields.forEach(f => {
                const input = tr.querySelector(`[data-field="${f.id}"]`);
                if (!input) return;
                
                let td = input.closest('td');
                if (!td) return;

                let isLocked = false;
                let lockReason = "";

                // --- 1. Visibility 檢查 (修正：區分 Checkbox 與一般欄位的空值邏輯) ---
                if (f.visibilityRule && f.visibilityRule.dep) {
                    const depId = f.visibilityRule.dep;
                    const depVal = dataContext[depId];
                    const currentValStr = (depVal !== undefined && depVal !== null) ? String(depVal).trim() : "";

                    // 判斷依賴欄位是否為 Checkbox
                    const depFieldDef = fields.find(field => field.id === depId);
                    const isDepCheckbox = (depFieldDef && depFieldDef.type === 'checkbox');

                    // 規則 A: 非 Checkbox 且為空值 -> 強制鎖定
                    if (!isDepCheckbox && currentValStr === "") {
                        isLocked = true;
                    } 
                    // 規則 B: 正常比對
                    else {
                        const ruleValStr = String(f.visibilityRule.val).trim();
                        let shouldShow = true;
                        if (f.visibilityRule.action === 'show') {
                            shouldShow = (currentValStr === ruleValStr);
                        } else {
                            shouldShow = (currentValStr !== ruleValStr);
                        }
                        if (!shouldShow) isLocked = true;
                    }
                }

                // --- 2. Option Logic 檢查 ---
                if (!isLocked && f.filterRules && f.filterRules.length > 0 && input.tagName === 'SELECT') {
                    const parentId = f.filterRules[0].dep;
                    const parentVal = dataContext[parentId];

                    if (!parentVal || parentVal === "") {
                        isLocked = true;
                        lockReason = "請先選擇關聯欄位";
                    } else {
                        const rule = f.filterRules.find(r => r.val === parentVal);
                        if (!rule) {
                            isLocked = true;
                        } else {
                            const currentVal = input.value;
                            let isValid = false;
                            
                            Array.from(input.options).forEach(opt => {
                                if (opt.value === "") { isValid = true; return; }
                                const show = rule.limitTo && rule.limitTo.includes(opt.value);
                                opt.hidden = !show;
                                opt.disabled = !show;
                                if(opt.value === currentVal && show) isValid = true;
                            });
                            
                            if (!isValid && currentVal !== "") {
                                input.value = "";
                                dataContext[f.id] = "";
                            }
                        }
                    }
                }

                // --- 3. 執行 UI 更新 ---
                if (isLocked) {
                    input.disabled = true;
                    if (lockReason) input.title = lockReason;
                    
                    if (input.type === 'checkbox') {
                         input.checked = false;
                    } else if (input.value !== "") {
                        input.value = "";
                        if (dataContext[f.id] !== "") dataContext[f.id] = "";
                    }
                    
                    td.style.backgroundColor = "#f1f5f9"; 
                    td.style.color = "#cbd5e1"; 
                    input.style.backgroundColor = "transparent";
                    
                } else {
                    input.disabled = false;
                    input.title = input.value; 
                    td.style.color = ""; 
                    
                    if (td.classList.contains('sticky-col')) {
                        const isAlt = tr.classList.contains('row-group-alt');
                        td.style.backgroundColor = isAlt ? '#f8fafc' : '#ffffff';
                    } else {
                        td.style.backgroundColor = ""; 
                    }
                }
            });
        }       

        // 2. 開啟學生歸戶設定視窗
        function openStudentSettingsModal(sid) {
            currentStudentId = sid; 
            const student = groupedStudents[sid];
            if(!student) return;
            document.getElementById('modal-student-name').innerText = `${student.name} (${student.id})`;           
            renderModalSettingsTab(student);
            document.getElementById('student-settings-modal').classList.remove('hidden');
        }

        // 3. 渲染視窗內的歸戶設定內容
        function renderModalSettingsTab(student) {
            const listContainer = document.getElementById('modal-settings-course-list');
            const appsContainer = document.getElementById('modal-app-management-list');
            listContainer.innerHTML = '';
            appsContainer.innerHTML = '';

            // 左側：尚未歸戶課程
            const unassigned = student.courses.filter(c => !c._app_id);
            if (unassigned.length === 0) {
                listContainer.innerHTML = '<div class="text-center text-slate-400 py-3 text-sm bg-white rounded border border-dashed">所有課程皆已歸戶</div>';
            } else {
                unassigned.forEach(c => {
                    const el = document.createElement('div');
                    el.className = 'course-card flex justify-between items-center p-3 border border-slate-200 rounded mb-2 hover:bg-slate-50 cursor-pointer';
                    
                    // 1. 抓取各項課程數值
                    const name = getCourseValue(c, ['course_name', '課程名稱', '科目名稱']) || '未知課程';
                    const year = getCourseValue(c, ['school_year', '學年', 'academic_year']) || '';
                    const sem = getCourseValue(c, ['semester', '學期']) || '';
                    const code = getCourseValue(c, ['course_code', '選課代號']) || '無代號';
                    const rawDept = c.course_dept || getCourseValue(c, ['開課學系', 'offering_department', '開課系所', '開課系', 'course_department']) || '';

                    // 2. 轉換系所簡稱
                    let shortDept = rawDept;
                    if (rawDept && typeof departmentData !== 'undefined' && Array.isArray(departmentData)) {
                        let foundShort = null;
                        for (let college of departmentData) {
                            if (college.departments && Array.isArray(college.departments)) {
                                for (let d of college.departments) {
                                    if (d.name === rawDept || d.fullName === rawDept) {
                                        foundShort = d.shortName || d.name;
                                        break;
                                    }
                                }
                            }
                            if (foundShort) break;
                        }
                        if (foundShort) shortDept = foundShort;
                    }
                    // 備用簡化：如果沒抓到內建簡稱，但結尾有「學系」，自動縮短為「系」
                    if (shortDept && shortDept.endsWith('學系')) {
                        shortDept = shortDept.replace('學系', '系');
                    }

                    // 3. 組合顯示字串 (例如：114-1 | 0002 | 中文系開)
                    const yearSem = (year && sem) ? `${year}-${sem}` : (year || sem || '');
                    const deptStr = shortDept ? `${shortDept}開` : '';
                    const subInfo = [yearSem, code, deptStr].filter(Boolean).join(' | ');

                    el.innerHTML = `
                        <div>
                            <div class="font-bold text-sm text-slate-700">${name}</div>
                            <div class="text-xs text-slate-500 mt-0.5">${subInfo}</div>
                        </div>
                        <input type="checkbox" class="modal-course-select-check w-5 h-5 text-primary rounded focus:ring-primary cursor-pointer" value="${c._internal_id}">
                    `;
                    
                    el.onclick = (e) => { 
                        if(e.target.type !== 'checkbox') { 
                            const cb = el.querySelector('input'); 
                            cb.checked = !cb.checked; 
                            el.classList.toggle('selected', cb.checked); 
                        } 
                    };
                    el.querySelector('input').onclick = (e) => {
                        e.target.parentElement.classList.toggle('selected', e.target.checked);
                        e.stopPropagation();
                    };
                    listContainer.appendChild(el);
                });
            }
            
            // 右側：已建立的填報單
            if (student.applications.length === 0) {
                appsContainer.innerHTML = '<div class="text-center text-slate-400 py-3 text-sm bg-white rounded border border-dashed">尚未建立任何實習填報單</div>';
            } else {
                student.applications.forEach((app, idx) => {
                   const el = document.createElement('div');
                   el.className = 'bg-white border border-slate-200 rounded-lg p-4 shadow-sm flex flex-col gap-3 mb-2';
                   
                   // 1. 處理標題：等待機構名稱輸入後才加上「：機構名稱」
                   let label = `實習紀錄${idx+1}`;
                   const instName = app.formData['internship_institution_name'];
                   if (instName && String(instName).trim() !== '') {
                       label += `：${instName}`;
                   }
                   
                   // 2. 處理課程資訊字串 (例：114-1 | 0002 | 企業實習1、114-1 | 0003 | 企業實習2)
                   const courseInfos = app.courseIds.map(cid => {
                        const c = student.courses.find(x => x._internal_id === cid);
                        if (!c) return '';
                        const name = getCourseValue(c, ['course_name', '課程名稱', '科目名稱']) || '未知課程';
                        const year = getCourseValue(c, ['school_year', '學年', 'academic_year']) || '';
                        const sem = getCourseValue(c, ['semester', '學期']) || '';
                        const code = getCourseValue(c, ['course_code', '選課代號']) || '無代號';
                        
                        const yearSem = (year && sem) ? `${year}-${sem}` : (year || sem || '');
                        return [yearSem, code, name].filter(Boolean).join(' | ');
                   }).filter(Boolean);
                   
                   const coursesHtml = `<div class="text-xs text-slate-500 mt-1 leading-relaxed">${courseInfos.join('、')}</div>`;

                   el.innerHTML = `
                       <div class="flex justify-between items-start">
                           <div class="flex-grow pr-4">
                               <h4 class="font-bold text-primary text-sm">${label}</h4>
                               ${coursesHtml}
                           </div>
                           <button onclick="deleteApplicationFromModal('${app.id}', '${student.id}')" class="flex-shrink-0 text-xs font-bold text-red-500 hover:bg-red-50 px-2 py-1 rounded transition">
                               <i class="fas fa-trash-alt"></i> 解除
                           </button>
                       </div>
                   `;
                   appsContainer.appendChild(el);
                });
            }
        }

        // 4. 從視窗建立歸戶 (實作邏輯)
        function createApplicationFromModal() {
            const student = groupedStudents[currentStudentId];
            const checkboxes = document.querySelectorAll('.modal-course-select-check:checked');
            if (checkboxes.length === 0) return showToast('error', '請先勾選至少一門課程');

            const ids = Array.from(checkboxes).map(cb => cb.value);
            const appId = 'app_' + Date.now();
            
            const firstC = student.courses.find(c => c._internal_id === ids[0]);
            const initData = {};
            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach(f => {
                    if (!CORE_FIELDS.includes(f.id) && !f.isSystem) {
                        const val = firstC[f.id] || firstC[f.label];
                        if (val) initData[f.id] = val;
                    }
                });
            }

            const newApp = { id: appId, courseIds: ids, formData: initData };
            ids.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = appId;
            });

            student.applications.push(newApp);
            hasUnsavedChanges = true;
            
            // 更新 Modal 內部介面
            renderModalSettingsTab(student);
            
            // ★ 新增：同步刷新外部介面 (側邊欄狀態 + 右側內容)
            renderStudentList(); 
            selectStudent(currentStudentId); 
            
            // 如果在 Grid 模式，也刷新 Grid
            const gridWrapper = document.getElementById('student-grid-wrapper');
            if (gridWrapper && !gridWrapper.classList.contains('hidden')) {
                renderStudentLocalGrid(currentStudentId);
            }
            
            showToast('success', '已建立填報單');
            logChange('CreateApp', appId, '', 'Created from Grid Modal', student.id);
            saveToLocal();
        }

        // 5. 從視窗刪除歸戶 (Wrapper)
        async function deleteApplicationFromModal(appId, studentId) {
            const confirmed = await showConfirm('確認刪除？', '確定要解除此歸戶嗎？填寫的資料將會遺失。');
            if (!confirmed) return;

            const student = groupedStudents[studentId];
            const idx = student.applications.findIndex(a => a.id === appId);
            if (idx === -1) return;

            const app = student.applications[idx];
            app.courseIds.forEach(cid => {
                const c = student.courses.find(x => x._internal_id === cid);
                if(c) c._app_id = null;
            });

            student.applications.splice(idx, 1);
            hasUnsavedChanges = true;

            // 更新 Modal 內部介面
            renderModalSettingsTab(student);
            
            // ★ 新增：同步刷新外部介面
            renderStudentList(); // 讓側邊欄的 "N 筆歸戶" 變回 "未填報"
            selectStudent(studentId); // 讓右側面板顯示 "請先進行歸戶設定"
            
            // 如果在 Grid 模式，也刷新 Grid
            const gridWrapper = document.getElementById('student-grid-wrapper');
            if (gridWrapper && !gridWrapper.classList.contains('hidden')) {
                renderStudentLocalGrid(studentId);
            }
            
            showToast('success', '歸戶已解除');
            logChange('DeleteApp', appId, 'Existing', 'Deleted from Grid Modal', studentId);
            saveToLocal();
        }
        
    // --- Weighted Distribution Logic (總數分配邏輯) ---
        
        let distContext = null; // 暫存目前的分配上下文

        function openDistributionModal(studentId, appId, fieldId) {
            const student = groupedStudents[studentId];
            const app = student.applications.find(a => a.id === appId);
            const fieldDef = currentYearConfig.fields.find(f => f.id === fieldId);
            
            if (!student || !app || !fieldDef) return;

            // 1. 找出相關課程與總權重
            const linkedCourses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
            const weightKey = fieldDef.weightField;
            
            let totalWeight = 0;
            const courseWeights = linkedCourses.map(c => {
                const w = parseFloat(getCourseValue(c, [weightKey])) || 0;
                totalWeight += w;
                return { 
                    course: c, 
                    weight: w,
                    name: getCourseValue(c, ['course_name', '課程名稱'])
                };
            });

            // 2. 設定 Modal 內容
            distContext = { student, app, fieldDef, linkedCourses, totalWeight, courseWeights };
            
            document.getElementById('dist-modal-title').innerText = `分配：${fieldDef.label}`;
            document.getElementById('dist-weight-info').innerText = `總權重: ${totalWeight}`;
            
            // 預設填入目前的總和值
            const currentTotal = app.formData[fieldId] || "";
            const inputEl = document.getElementById('dist-total-input');
            inputEl.value = currentTotal;
            inputEl.oninput = updateDistPreview; // 綁定即時預覽

            // 重置預覽
            updateDistPreview();

            // 3. 顯示 Modal
            document.getElementById('distribute-modal').classList.remove('hidden');
            setTimeout(() => inputEl.focus(), 100);
        }

        function updateDistPreview() {
            if (!distContext) return;
            const totalVal = parseFloat(document.getElementById('dist-total-input').value) || 0;
            const listEl = document.getElementById('dist-preview-list');
            listEl.innerHTML = '';

            const { totalWeight, courseWeights, fieldDef } = distContext;

            if (totalWeight <= 0) {
                listEl.innerHTML = '<div class="p-3 text-red-500 text-center">無法計算：總權重為 0</div>';
                return;
            }

            courseWeights.forEach(item => {
                const ratio = item.weight / totalWeight;
                const distVal = totalVal * ratio;
                const displayVal = fieldDef.decimal ? distVal.toFixed(fieldDef.decimal) : Math.round(distVal);

                const div = document.createElement('div');
                div.className = "px-3 py-2 flex justify-between items-center hover:bg-slate-50";
                div.innerHTML = `
                    <div class="truncate w-2/3">
                        <span class="font-bold text-slate-700">${item.name}</span>
                        <span class="text-xs text-slate-400 ml-1">(權重 ${item.weight})</span>
                    </div>
                    <div class="font-mono font-bold text-indigo-600">${displayVal}</div>
                `;
                listEl.appendChild(div);
            });
        }

        function confirmDistribution() {
            if (!distContext) return;
            const { student, app, fieldDef, linkedCourses, totalWeight, courseWeights } = distContext;
            const totalVal = parseFloat(document.getElementById('dist-total-input').value) || 0;

            if (totalWeight <= 0) {
                showToast('error', '權重總和為 0，無法分配');
                return;
            }

            // 1. 更新資料庫
            courseWeights.forEach(item => {
                const ratio = item.weight / totalWeight;
                const distVal = totalVal * ratio;
                const finalVal = fieldDef.decimal ? distVal.toFixed(fieldDef.decimal) : Math.round(distVal).toString();
                
                // 更新 Course Data
                item.course[fieldDef.id] = finalVal;

                // ★ 修正：使用 syncValueToViews 更新所有視圖
                syncValueToViews(item.course._internal_id, student.id, fieldDef.id, finalVal);
            });

            // 3. 更新 App Data (總和)
            const formattedTotal = fieldDef.decimal ? totalVal.toFixed(fieldDef.decimal) : totalVal.toString();
            app.formData[fieldDef.id] = formattedTotal;
            
            logChange(fieldDef.id, app.id, 'Batch Distribute', formattedTotal, student.id);
            hasUnsavedChanges = true;

            showToast('success', `已將 ${formattedTotal} 分配至 ${linkedCourses.length} 門課程`);
            saveToLocal();
            document.getElementById('distribute-modal').classList.add('hidden');
        }

        // 1. 擴充狀態定義 (加入 sortKey, sortDir, frozenCount)
        let localGridState = {
            hiddenCols: [],
            columnOrder: [],
            sortKey: null,      // 新增：排序欄位
            sortDir: 'asc',     // 新增：排序方向
            frozenCount: 0      // 新增：凍結欄位數 (預設 0)
        };

        // 2. 新增：設定排序的輔助函式 (供表頭點擊使用)
        function setLocalSort(key) {
            if (localGridState.sortKey === key) {
                // 如果按同一欄，切換方向
                localGridState.sortDir = localGridState.sortDir === 'asc' ? 'desc' : 'asc';
            } else {
                // 如果按不同欄，重置為升冪
                localGridState.sortKey = key;
                localGridState.sortDir = 'asc';
            }
            // 重繪表格與選單 (更新排序圖示)
            renderStudentLocalGrid(currentStudentId);
            renderLocalGridPicker(); 
        }

        let currentViewMode = 'form';

        // 1. 切換視圖模式 (修正版：加入模式記憶功能)
        function setStudentViewMode(mode) {
            currentViewMode = mode;
        
            const formContainer = document.getElementById('form-content-area');
            const tabsContainer = document.getElementById('tabs-container');
            const gridWrapper = document.getElementById('student-grid-wrapper');
            const stickyHeader = document.getElementById('sticky-progress-header'); 
            
            const btnForm = document.getElementById('btn-std-view-form');
            const btnGrid = document.getElementById('btn-std-view-grid');
        
            if(!formContainer || !gridWrapper) return;
        
            if (mode === 'grid') {
                // 切換到【列表模式】
                formContainer.classList.add('hidden');
                tabsContainer.classList.add('hidden'); 
                gridWrapper.classList.remove('hidden');
        
                // 強制隱藏表單專用的進度條
                if(stickyHeader) stickyHeader.classList.add('hidden');
        
                if(btnForm) btnForm.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition flex items-center gap-1 whitespace-nowrap";
                if(btnGrid) btnGrid.className = "px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary flex items-center gap-1 whitespace-nowrap";
        
                if(currentStudentId) {
                    renderStudentLocalGrid(currentStudentId); 
                    setTimeout(() => {
                        if(typeof renderLocalGridPicker === 'function') renderLocalGridPicker(); 
                    }, 0);
                }
        
            } else {
                // 切換回【表單模式】
                formContainer.classList.remove('hidden');
                tabsContainer.classList.remove('hidden');
                gridWrapper.classList.add('hidden');
        
                if(btnForm) btnForm.className = "px-3 py-1.5 rounded-md text-xs font-bold transition shadow-sm bg-white text-primary flex items-center gap-1 whitespace-nowrap";
                if(btnGrid) btnGrid.className = "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500 hover:text-slate-700 transition flex items-center gap-1 whitespace-nowrap";
                
                if (currentActiveAppId) {
                     updateAppProgress(currentActiveAppId);
                } else {
                    const activeTab = document.querySelector('.tab-btn.active');
                    if(activeTab) {
                        switchTab(activeTab.dataset.tab); 
                    } else {
                        if(stickyHeader) stickyHeader.classList.add('hidden');
                    }
                }

                // ★ 新增：切換回表單模式時，因為 display:none 會導致高度歸零，需強制重新計算
                setTimeout(() => {
                    const activeContent = document.querySelector('.dynamic-tab-content[style*="display: block"]');
                    if (activeContent) {
                        activeContent.querySelectorAll('textarea.input-stylish').forEach(ta => {
                            ta.style.setProperty('height', '1px', 'important');
                            ta.style.setProperty('height', (ta.scrollHeight + 2) + 'px', 'important');
                        });
                    }
                }, 50);
            }
        }
        // 2. 渲染單人列表表格
        function renderStudentLocalGrid(sid) {
            const student = groupedStudents[sid];
            if (!student) return;

            const table = document.querySelector('#student-grid-wrapper table');
            const scrollContainer = table ? table.parentElement : null;
            const thead = document.getElementById('local-grid-thead');
            const tbody = document.getElementById('local-grid-tbody');
            const searchTerm = document.getElementById('local-grid-search')?.value.toLowerCase() || "";

            if(!table || !scrollContainer || !thead || !tbody) return;

            // --- 空狀態 (Empty State) ---
            let emptyState = document.getElementById('local-grid-empty-state');
            if (!emptyState) {
                emptyState = document.createElement('div');
                emptyState.id = 'local-grid-empty-state';
                emptyState.className = 'hidden flex-col items-center justify-center h-full w-full absolute top-0 left-0 bg-white z-20';
                emptyState.innerHTML = `
                    <div class="w-24 h-24 bg-slate-100 rounded-full flex items-center justify-center mb-4 shadow-inner">
                        <i class="fas fa-folder-plus text-4xl text-slate-300"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-600 mb-2">尚無實習紀錄</h3>
                    <p class="text-sm text-slate-500 mb-6">請先進行歸戶設定以開始填報</p>
                    <button onclick="openStudentSettingsModal('${sid}')" class="px-6 py-2 bg-primary text-white rounded-lg font-bold shadow-md hover:bg-sky-700 transition transform hover:scale-105 flex items-center gap-2">
                        <i class="fas fa-cog"></i> 開啟歸戶設定
                    </button>
                `;
                scrollContainer.appendChild(emptyState);
            }

            if(window.getComputedStyle(scrollContainer).position === 'static') {
                scrollContainer.style.position = 'relative';
            }

            const gridHeader = document.getElementById('local-grid-header'); 
            
            if (student.applications.length === 0) {
                table.style.display = 'none'; 
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                if(gridHeader) gridHeader.style.display = 'none'; 
                scrollContainer.style.height = '100%';
                scrollContainer.style.maxHeight = 'none';
                scrollContainer.style.overflow = 'hidden';
                return; 
            } else {
                table.style.display = ''; 
                table.style.visibility = 'visible';
                emptyState.classList.add('hidden');
                emptyState.classList.remove('flex');
                if(gridHeader) gridHeader.style.display = 'flex'; 
            }

            // --- 標準表格渲染 ---
            scrollContainer.classList.remove('flex-grow', 'h-full');
            scrollContainer.style.height = 'auto';
            scrollContainer.style.maxHeight = 'calc(100% - 60px)'; 
            scrollContainer.style.overflow = 'auto';

            thead.innerHTML = '';
            tbody.innerHTML = '';
            const oldColgroup = table.querySelector('colgroup');
            if(oldColgroup) table.removeChild(oldColgroup);

            const fields = currentYearConfig.fields || [];
            
            // 欄位排序
            let allColumns = fields
                .filter(f => !['course_id', '_internal_id'].includes(f.id)) 
                .filter(f => !localGridState.hiddenCols.includes(f.id));

            const getOrder = (col) => (col.order !== undefined && col.order !== null) ? col.order : 999;
            if (localGridState.columnOrder.length > 0) {
                allColumns.sort((a, b) => {
                    const idxA = localGridState.columnOrder.indexOf(a.id);
                    const idxB = localGridState.columnOrder.indexOf(b.id);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    return getOrder(a) - getOrder(b);
                });
            } else {
                allColumns.sort((a,b) => getOrder(a) - getOrder(b));
            }

            // 資料準備
            let rowsData = [];
            student.courses.forEach(c => {
                if (searchTerm) {
                    const fullText = Object.values(c).join(' ').toLowerCase();
                    if (!fullText.includes(searchTerm)) return;
                }
                let appData = {};
                if(c._app_id) {
                    const app = student.applications.find(a => a.id === c._app_id);
                    if(app) appData = app.formData;
                }
                rowsData.push({ course: c, appData: appData, student: student, appId: c._app_id });
            });

            // 資料排序
            if (localGridState.sortKey) {
                rowsData.sort((a, b) => {
                    const getVal = (row, key) => {
                        let v = row.appId && row.appData[key] ? row.appData[key] : row.course[key];
                        if (!v && key === 'student_id') v = row.student.id;
                        if (!v && key === 'student_name') v = row.student.name;
                        return v || "";
                    };
                    const valA = String(getVal(a, localGridState.sortKey));
                    const valB = String(getVal(b, localGridState.sortKey));
                    const numA = parseFloat(valA.replace(/,/g, ''));
                    const numB = parseFloat(valB.replace(/,/g, ''));
                    if (!isNaN(numA) && !isNaN(numB) && valA.trim() !== '' && valB.trim() !== '') {
                        return localGridState.sortDir === 'asc' ? numA - numB : numB - numA;
                    }
                    return localGridState.sortDir === 'asc' ? valA.localeCompare(valB, 'zh-Hant') : -valA.localeCompare(valB, 'zh-Hant');
                });
            }

            // 計算欄寬
            const colgroup = document.createElement('colgroup');
            const columnWidths = {};
            let totalTableWidth = 0; 

            allColumns.forEach(f => {
                const iconWidth = f.description ? 20 : 0;
                let baseHeaderWidth = getTextWidth(f.label, "bold 14px 'Noto Sans TC'") + 24 + iconWidth;
                
                let maxContentWidth = 0;
                
                // ★ 修正：若是 list 類型，不進行內容寬度計算，避免被超長內容撐爆
                if (f.type !== 'list') {
                    if (f.type === 'single_select' && f.options) {
                        f.options.forEach(opt => {
                            const w = getTextWidth(opt, "14px 'Noto Sans TC'") + 50;
                            if (w > maxContentWidth) maxContentWidth = w;
                        });
                    }

                    rowsData.forEach(row => {
                        let val = "";
                        if (f.calcMode === 'average' || f.calcMode === 'weighted') {
                            val = row.course[f.id]; 
                        } else if (row.appId && row.appData[f.id] !== undefined) {
                            val = row.appData[f.id]; 
                        } else {
                            val = row.course[f.id];
                            if ((val === undefined || val === "") && f.id === 'student_id') val = row.student.id;
                            if ((val === undefined || val === "") && f.id === 'student_name') val = row.student.name;
                            if ((val === undefined || val === "") && f.id === 'student_dept') val = row.student.dept;
                        }

                        if (val) {
                            let padding = 24; 
                            if (f.type === 'single_select') padding = 50; 
                            const w = getTextWidth(String(val), "14px 'Noto Sans TC'") + padding;
                            if (w > maxContentWidth) maxContentWidth = w;
                        }
                    });
                }
                
                let finalWidth = Math.max(baseHeaderWidth, maxContentWidth);
                
                // ★ 修正：給予 list 一個固定適中的預設寬度 (250px)
                if (f.type === 'list') {
                    finalWidth = Math.max(baseHeaderWidth, 250); 
                } else {
                    finalWidth = Math.max(finalWidth, 80); 
                    if(f.type === 'text' || f.type === 'address') finalWidth = Math.min(finalWidth, 300);
                }

                columnWidths[f.id] = finalWidth;
                totalTableWidth += finalWidth;
                
                const col = document.createElement('col');
                col.style.width = finalWidth + "px";
                colgroup.appendChild(col);
            });
            table.insertBefore(colgroup, thead);

            table.classList.remove('w-full');
            table.style.tableLayout = 'fixed';
            table.style.width = totalTableWidth + 'px';
            table.style.minWidth = totalTableWidth + 'px';

            // 渲染表頭
            const freezeLimit = localGridState.frozenCount;
            let currentStickyLeft = 0; 
            let trHead = document.createElement('tr');

            allColumns.forEach((col, index) => {
                const th = document.createElement('th');
                th.className = "bg-slate-100 text-slate-600 border-r border-slate-200 px-2 py-2 text-sm font-bold select-none";
                th.style.whiteSpace = 'nowrap';
                th.style.overflow = 'hidden';
                th.style.textOverflow = 'ellipsis';
                th.style.cursor = 'default';

                if (index < freezeLimit) {
                    th.classList.add('sticky-col');
                    th.style.left = currentStickyLeft + "px";
                    currentStickyLeft += columnWidths[col.id];
                    if (index === freezeLimit - 1) th.classList.add('sticky-border-right');
                }

                let infoIcon = col.description ? `<i class="fas fa-info-circle header-info-icon" title="${col.description}"></i>` : '';
                th.innerHTML = `<div class="flex items-center justify-center gap-1">${col.label}${infoIcon}</div>`;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // 渲染內容 (Rows)
            rowsData.forEach((row, rowIndex) => {
                const { student, course, appData, appId } = row;

                // 【修正】移除單雙行變色邏輯，統一固定顏色
                const bgBase = '#ffffff'; 
                const bgReadOnly = '#f8fafc'; 

                const tr = document.createElement('tr');
                tr.className = "transition border-b border-slate-100 hover:bg-slate-50"; 
                tr.dataset.cid = course._internal_id; 
                tr.dataset.sid = student.id; 
                
                // 仍保留 class 標記供 updateRowLogic 使用，但不影響顏色
                tr.classList.add('row-group-normal');

                currentStickyLeft = 0;

                allColumns.forEach((f, index) => {
                    const td = document.createElement('td');
                    td.className = "border-r border-slate-200 p-0 relative";
                    
                    const isReadOnly = f.isSystem || f.readOnly === true || f.category === 'sys_student_info' || f.category === 'sys_course_info';
                    
                    let cellBgColor = isReadOnly ? bgReadOnly : bgBase;
                    td.style.backgroundColor = cellBgColor;
                    td.style.whiteSpace = 'nowrap'; 
                    td.style.verticalAlign = 'top'; 

                    if (index < freezeLimit) {
                        td.classList.add('sticky-col');
                        td.style.left = currentStickyLeft + "px";
                        currentStickyLeft += columnWidths[f.id];
                        if (index === freezeLimit - 1) td.classList.add('sticky-border-right');
                    }

                    let val = "";
                    if (f.calcMode === 'average' || f.calcMode === 'weighted') {
                        val = course[f.id]; 
                    } else if (appId && appData[f.id] !== undefined) {
                        val = appData[f.id]; 
                    } else {
                        val = course[f.id];
                        if ((val === undefined || val === "") && f.id === 'student_id') val = student.id;
                        if ((val === undefined || val === "") && f.id === 'student_name') val = student.name;
                        if ((val === undefined || val === "") && f.id === 'student_dept') val = student.dept;
                    }

                    if (f.type === 'date' && val) {
                        let displayVal = val.replace(/-/g, '/'); 
                        if (f.inputFormat === 'ROC') {
                            const parts = displayVal.split('/');
                            if (parts.length === 3) {
                                const rocY = parseInt(parts[0]) - 1911;
                                displayVal = `${rocY}/${parts[1]}/${parts[2]}`;
                            }
                        }
                        val = displayVal;
                    }

                    if (isReadOnly) {
                        const div = document.createElement('div');
                        div.className = "cell-read-only"; 
                        div.innerText = val || '';
                        div.title = val || '';
                        div.style.height = '100%';
                        div.style.display = 'flex';
                        div.style.alignItems = 'center';
                        div.style.justifyContent = 'center';
                        td.appendChild(div);
                    } else {
                        let input;
                        let wrapperDiv = null; // ★ 新增：用於置中的容器

                        if (f.type === 'text' || f.type === 'address' || f.type === 'list') { 
                            input = document.createElement('textarea');
                            input.rows = 1; 
                            input.className = "grid-input custom-scroll";
                            input.style.resize = "none";
                            input.style.textAlign = 'left';
                            input.style.whiteSpace = 'pre-wrap'; 
                            input.style.overflow = 'hidden';     
                            input.style.wordBreak = 'break-all'; 
                            input.style.lineHeight = '1.5';
                            input.style.padding = '6px 8px';     
                            
                            // ★ 修改：加入允許空白的防呆檢查
                            input.addEventListener('input', function() { 
                                if (f.type === 'list') {
                                    if (this.value === '') {
                                        // 保持空白
                                    } else if (!/^\d+\.\s/.test(this.value)) {
                                        this.value = '1. ' + this.value.replace(/^\d*\.?\s*/, '');
                                    }
                                }
                                autoResizeGridRow(tr); // 觸發整列縮放
                            });
                            
                            // 綁定智慧編號事件
                            if (f.type === 'list') {
                                input.addEventListener('keydown', handleListKeydown);
                            }

                        } else if (f.type === 'single_select') {
                            input = document.createElement('select');
                            input.innerHTML = `<option value=""></option>` + (f.options||[]).map(o => `<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                            input.className = "grid-input";
                            input.style.textAlign = 'center';
                            input.style.textAlignLast = 'center';
                        }
                        // --- 【修改】列表模式的 Checkbox (美化 + 絕對置中) ---
                        else if (f.type === 'checkbox') {
                            // 1. 建立彈性容器，確保水平與垂直都完美置中
                            wrapperDiv = document.createElement('div');
                            wrapperDiv.className = "flex items-center justify-center w-full h-full";

                            // 2. 建立 Checkbox 本體
                            input = document.createElement('input');
                            input.type = 'checkbox';
                            // 樣式優化：w-5 h-5(加大), text-primary(品牌色), rounded(圓角), border-slate-300(邊框)
                            input.className = "w-5 h-5 text-primary border-slate-300 rounded focus:ring-primary focus:ring-offset-0 cursor-pointer transition-all duration-200 ease-in-out"; 
                            input.checked = (val === true || val === 'true');
                            
                            // 綁定變更事件
                            input.onchange = (e) => handleGridChange(e.target, student, course, f);

                            // 將 input 放入容器
                            wrapperDiv.appendChild(input);
                        } 
                        else {
                            input = document.createElement('input');
                            input.type = "text";
                            input.className = "grid-input";
                            input.style.textAlign = 'center';
                            if (f.type === 'date') {
                                input.placeholder = f.inputFormat === 'ROC' ? "yyy/mm/dd" : "yyyy/mm/dd";
                            }
                        }

                        if (!appId) {
                            input.readOnly = true;
                            input.style.cursor = 'pointer';
                            input.title = "尚未歸戶 (點擊以建立)";
                            const triggerConsolidate = (e) => {
                                e.preventDefault(); e.stopPropagation();
                                showToast('info', '請使用上方「歸戶設定」頁籤進行歸戶操作');
                            };
                            if (input.tagName === 'SELECT') input.addEventListener('mousedown', triggerConsolidate);
                            else input.onclick = triggerConsolidate;
                        } else if (f.calcMode === 'weighted') {
                            input.readOnly = true;
                            input.style.cursor = 'pointer';
                            input.onclick = (e) => { 
                                e.stopPropagation(); e.preventDefault(); 
                                openDistributionModal(student.id, appId, f.id); 
                            };
                        }

                        // 如果不是 checkbox，才設定 value (避免覆蓋 checked 狀態)
                        if (f.type !== 'checkbox') {
                            input.value = val || "";
                        }
                        
                        input.dataset.field = f.id;
                        if(appId) input.classList.add(`app-input-${appId}-${f.id}`);

                        // 事件綁定 (排除 checkbox，因為上面已經綁定了)
                        if (f.type !== 'checkbox') {
                            if (f.type !== 'date') {
                                input.onchange = (e) => handleGridChange(e.target, student, course, f);
                            } else {
                                input.addEventListener('change', (e) => {
                                    let v = e.target.value.trim().replace(/[^\d]/g, '');
                                    if (f.inputFormat === 'ROC' && v.length >= 6) {
                                         if (v.length === 7) e.target.value = `${v.substring(0,3)}/${v.substring(3,5)}/${v.substring(5,7)}`;
                                         else if (v.length === 6) e.target.value = `${v.substring(0,2)}/${v.substring(2,4)}/${v.substring(4,6)}`;
                                    }
                                    handleGridChange(e.target, student, course, f);
                                });
                            }
                        }

                        // ★ 關鍵：如果有 wrapperDiv (Checkbox)，則加入 wrapper，否則加入 input
                        if (wrapperDiv) {
                            td.appendChild(wrapperDiv);
                        } else {
                            td.appendChild(input);
                        }
                    }
                    // ★ 貼在這裡：點擊 TD 空白處自動 Focus 輸入框 (讓 UX 更順暢)
                    td.onclick = (e) => {
                        if (e.target === td) {
                            const innerInput = td.querySelector('.grid-input');
                            if (innerInput && !innerInput.disabled && !innerInput.readOnly) innerInput.focus();
                        }
                    };

                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
                
                updateRowLogic(tr, appId ? appData : course, !appId);
            });
            
            setTimeout(() => {
                const rows = document.querySelectorAll('#local-grid-tbody tr');
                rows.forEach(tr => autoResizeGridRow(tr));
            }, 0);
        }
        
        function renderLocalGridPicker() {
            const container = document.getElementById('local-grid-column-picker');
            if(!container) {
                console.error("找不到欄位設定容器 #local-grid-column-picker");
                return;
            }
            
            const fields = currentYearConfig.fields || [];
            let allCols = fields.filter(f => !['course_id', '_internal_id'].includes(f.id));
            
            // 初始化排序
            if (!localGridState.columnOrder || localGridState.columnOrder.length === 0) {
                const getOrder = (col) => (col.order !== undefined && col.order !== null) ? col.order : 999;
                const sortedDefault = [...allCols].sort((a,b) => getOrder(a) - getOrder(b));
                localGridState.columnOrder = sortedDefault.map(f => f.id);
            }

            allCols.sort((a, b) => {
                const idxA = localGridState.columnOrder.indexOf(a.id);
                const idxB = localGridState.columnOrder.indexOf(b.id);
                if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                return (a.order||999) - (b.order||999);
            });
            localGridState.columnOrder = allCols.map(f => f.id);

            const total = allCols.length;
            const currentHiddenCount = localGridState.hiddenCols.length;
            const currentVisible = total - currentHiddenCount;

            container.innerHTML = '';
            
            // 暫存變數
            let tempHiddenCols = [...localGridState.hiddenCols];
            let tempColumnOrder = [...localGridState.columnOrder];
            let tempSortKey = localGridState.sortKey || '';
            let tempSortDir = localGridState.sortDir || 'asc';

            const details = document.createElement('details');
            details.className = "group relative"; 
            
            const summary = document.createElement('summary');
            summary.className = "custom-picker-trigger flex items-center gap-2 cursor-pointer px-3 py-1.5 bg-white border border-slate-300 rounded-lg hover:border-primary hover:text-primary transition select-none text-slate-600 shadow-sm";
            summary.innerHTML = `
                <div class="flex items-center gap-2 font-bold text-xs">
                    <i class="fas fa-sliders-h"></i>
                    <span>欄位設定</span>
                    <span class="bg-slate-100 text-slate-600 text-[10px] px-1.5 py-0.5 rounded-full border border-slate-200 group-open:bg-primary group-open:text-white group-open:border-primary transition">
                        ${currentVisible}
                    </span>
                </div>
                <i class="fas fa-chevron-down text-[10px] text-slate-400 group-open:rotate-180 transition-transform duration-300"></i>
            `;
            
            const dropdown = document.createElement('div');
            dropdown.className = "picker-dropdown absolute right-0 top-full mt-2 w-[550px] bg-white border border-slate-200 rounded-xl shadow-2xl z-[100] flex flex-col overflow-hidden";
            
            // ★★★ 頂部操作區 (新增排序與凍結) ★★★
            const actions = document.createElement('div');
            actions.className = "flex flex-col gap-2 px-4 py-3 border-b border-slate-100 bg-slate-50";
            
            const sortOptions = allCols.map(c => `<option value="${c.id}" ${c.id === tempSortKey ? 'selected' : ''}>${c.label}</option>`).join('');

            actions.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-xs">
                        <span class="font-bold text-slate-600"><i class="fas fa-sort mr-1"></i>排序:</span>
                        <select id="local-sort-select" class="px-2 py-1 border border-slate-300 rounded focus:ring-1 focus:ring-primary outline-none bg-white cursor-pointer w-32" onclick="event.stopPropagation()">
                            <option value="">(無)</option>
                            ${sortOptions}
                        </select>
                        <button type="button" id="local-sort-dir-btn" class="px-2 py-1 border border-slate-300 rounded bg-white hover:bg-slate-50 transition w-8 text-center font-bold text-primary" onclick="event.stopPropagation()">
                            ${tempSortDir === 'asc' ? '<i class="fas fa-sort-amount-down-alt"></i>' : '<i class="fas fa-sort-amount-up"></i>'}
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-2 border-l border-slate-200 pl-4">
                        <label class="text-xs font-bold text-slate-600">凍結左側:</label>
                        <input type="number" id="local-freeze-input" min="0" max="5" value="${localGridState.frozenCount}" 
                            class="w-12 px-1 py-0.5 text-center text-xs border border-slate-300 rounded focus:ring-1 focus:ring-primary outline-none" onclick="event.stopPropagation()">
                        <span class="text-xs text-slate-400">欄</span>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t border-slate-200 pt-2 mt-1">
                    <div class="text-[10px] text-slate-400"><i class="fas fa-grip-vertical mr-1"></i>拖曳可調整順序</div>
                    <div class="flex gap-2">
                        <button type="button" id="local-show-all" class="text-[10px] px-2 py-1 rounded bg-white border border-slate-200 hover:border-primary hover:text-primary shadow-sm transition">全選</button>
                        <button type="button" id="local-hide-all" class="text-[10px] px-2 py-1 rounded bg-white border border-slate-200 hover:border-slate-400 hover:text-slate-600 shadow-sm transition">全隱藏</button>
                    </div>
                </div>
            `;
            dropdown.appendChild(actions);

            // 中間選項區 (Grid)
            const tagsContainer = document.createElement('div');
            tagsContainer.className = "p-4 grid grid-cols-3 gap-2 max-h-[250px] overflow-y-auto custom-scroll bg-white";
            
            const renderChips = () => {
                tagsContainer.innerHTML = '';
                tempColumnOrder.forEach((fieldId, index) => {
                    const f = allCols.find(c => c.id === fieldId);
                    if (!f) return;

                    const lbl = document.createElement('label');
                    lbl.className = 'field-chip-label cursor-move flex items-center p-2 rounded border border-transparent hover:bg-slate-50 transition select-none'; 
                    lbl.draggable = true; 
                    lbl.dataset.index = index;

                    const isVisible = !tempHiddenCols.includes(f.id);
                    lbl.innerHTML = `
                        <i class="fas fa-grip-vertical text-slate-300 text-xs mr-2 cursor-move"></i>
                        <input type="checkbox" class="mr-2 accent-primary" value="${f.id}" ${isVisible ? 'checked' : ''}>
                        <span class="truncate font-medium text-xs text-slate-700" title="${f.label}">${f.label}</span>
                    `;

                    lbl.querySelector('input').onchange = (e) => {
                        if (e.target.checked) tempHiddenCols = tempHiddenCols.filter(id => id !== f.id);
                        else tempHiddenCols.push(f.id);
                    };

                    lbl.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', index);
                        lbl.style.opacity = '0.5';
                    });
                    lbl.addEventListener('dragend', () => { lbl.style.opacity = '1'; });
                    lbl.addEventListener('dragover', (e) => { e.preventDefault(); });
                    lbl.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                        const toIndex = index;
                        if (fromIndex !== toIndex && !isNaN(fromIndex)) {
                            const item = tempColumnOrder.splice(fromIndex, 1)[0];
                            tempColumnOrder.splice(toIndex, 0, item);
                            renderChips();
                        }
                    });
                    tagsContainer.appendChild(lbl);
                });
            };
            
            renderChips();
            dropdown.appendChild(tagsContainer);

            // 底部套用
            const footer = document.createElement('div');
            footer.className = "picker-footer-action px-4 py-2 border-t border-slate-100 flex justify-end bg-slate-50";
            footer.innerHTML = `
                <button type="button" id="local-apply" class="px-4 py-1.5 bg-primary hover:bg-indigo-900 text-white text-xs font-bold rounded-lg shadow-md transition">
                    套用設定
                </button>
            `;
            dropdown.appendChild(footer);

            details.appendChild(summary);
            details.appendChild(dropdown);
            container.appendChild(details);

            // --- 事件綁定 ---
            
            // 排序按鈕
            const sortBtn = dropdown.querySelector('#local-sort-dir-btn');
            sortBtn.onclick = (e) => {
                e.preventDefault(); e.stopPropagation(); 
                tempSortDir = tempSortDir === 'asc' ? 'desc' : 'asc';
                sortBtn.innerHTML = tempSortDir === 'asc' ? '<i class="fas fa-sort-amount-down-alt"></i>' : '<i class="fas fa-sort-amount-up"></i>';
            };
            
            // 排序下拉
            const sortSelect = dropdown.querySelector('#local-sort-select');
            sortSelect.onchange = (e) => { e.stopPropagation(); tempSortKey = e.target.value; };
            sortSelect.onclick = (e) => e.stopPropagation(); 

            // 凍結輸入框
            dropdown.querySelector('#local-freeze-input').onclick = (e) => e.stopPropagation();

            // 按鈕事件
            dropdown.querySelector('#local-show-all').onclick = (e) => {
                e.preventDefault();
                tempHiddenCols = [];
                renderChips();
            };
            dropdown.querySelector('#local-hide-all').onclick = (e) => {
                e.preventDefault();
                tempHiddenCols = tempColumnOrder.map(id => id);
                renderChips();
            };
            dropdown.querySelector('#local-apply').onclick = () => details.removeAttribute('open');
            
            // 監聽關閉事件 (執行儲存與重繪)
            details.addEventListener('toggle', () => {
                if (!details.open) {
                    const newFreeze = parseInt(document.getElementById('local-freeze-input').value) || 0;
                    
                    const isChanged = 
                        newFreeze !== localGridState.frozenCount ||
                        tempSortKey !== localGridState.sortKey ||
                        tempSortDir !== localGridState.sortDir ||
                        JSON.stringify(tempHiddenCols.sort()) !== JSON.stringify(localGridState.hiddenCols.sort()) ||
                        JSON.stringify(tempColumnOrder) !== JSON.stringify(localGridState.columnOrder);

                    if (isChanged) {
                        localGridState.hiddenCols = [...tempHiddenCols];
                        localGridState.columnOrder = [...tempColumnOrder];
                        localGridState.frozenCount = newFreeze;
                        localGridState.sortKey = tempSortKey;
                        localGridState.sortDir = tempSortDir;
                        
                        renderStudentLocalGrid(currentStudentId);
                        renderLocalGridPicker(); 
                    }
                } else {
                    // 開啟時重置暫存
                    tempHiddenCols = [...localGridState.hiddenCols];
                    tempColumnOrder = [...localGridState.columnOrder];
                    tempSortKey = localGridState.sortKey;
                    tempSortDir = localGridState.sortDir;
                    
                    sortSelect.value = tempSortKey;
                    document.getElementById('local-freeze-input').value = localGridState.frozenCount;
                    sortBtn.innerHTML = tempSortDir === 'asc' ? '<i class="fas fa-sort-amount-down-alt"></i>' : '<i class="fas fa-sort-amount-up"></i>';
                    renderChips();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!details.contains(e.target) && details.hasAttribute('open')) {
                    details.removeAttribute('open');
                }
            });
        }

        // 1. 自動收集機構資訊 (支援同名多版本比對)
        function collectInstitutionData(formData) {
            const INST_CATEGORY = 'internship_institution_info';
            const allConfigFields = currentYearConfig.fields || [];
            
            // 1. 取得該分類下的所有欄位定義
            let instFields = [];
            if (allConfigFields.length > 0) {
                instFields = allConfigFields.filter(f => f.category === INST_CATEGORY);
            }

            if (instFields.length === 0) return;

            // 2. 尋找機構名稱欄位 Key
            let nameFieldId = 'internship_institution_name';
            const foundNameField = instFields.find(f => f.id === 'internship_institution_name' || f.id.includes('name'));
            if (foundNameField) nameFieldId = foundNameField.id;

            // 3. 核心檢查：確認所有「可見且必填」的欄位都已填寫
            let isComplete = true;
            
            for (const f of instFields) {
                if (!f.required) continue;

                // 檢查 Visibility
                let isVisible = true;
                if (f.visibilityRule) {
                    const { dep, action, val: ruleValue } = f.visibilityRule;
                    const depVal = formData[dep];
                    const depValStr = (depVal !== undefined && depVal !== null) ? String(depVal).trim() : "";
                    const ruleValStr = (ruleValue !== undefined && ruleValue !== null) ? String(ruleValue).trim() : "";
                    const ruleMet = (depValStr === ruleValStr); 

                    if (action === 'show') isVisible = ruleMet;
                    else if (action === 'hide') isVisible = !ruleMet;
                }
                
                if (isVisible) {
                    const val = formData[f.id];
                    if (val === undefined || val === null || String(val).trim() === "") {
                        isComplete = false;
                        break; 
                    }
                }
            }

            if (!isComplete) return; 

            // 4. 取得機構名稱
            const name = formData[nameFieldId];
            if (!name || typeof name !== 'string' || name.trim() === '') return;
            const safeName = name.trim();

            // 5. 準備要儲存的資料
            const newEntry = {};
            instFields.forEach(f => {
                let val = formData[f.id];
                if (val !== undefined && val !== null) val = String(val).trim();
                else val = "";
                if (val !== "") newEntry[f.id] = val;
            });

            // 6. 檢查與儲存
            if (!institutionLibrary[safeName]) {
                institutionLibrary[safeName] = [];
            }
            const existingEntries = institutionLibrary[safeName];

            const generateFingerprint = (entry) => {
                const keys = Object.keys(entry).filter(k => !k.startsWith('_')).sort();
                const cleanObj = {};
                keys.forEach(k => cleanObj[k] = entry[k]);
                return JSON.stringify(cleanObj);
            };

            const newFingerprint = generateFingerprint(newEntry);
            const isDuplicate = existingEntries.some(entry => generateFingerprint(entry) === newFingerprint);

            if (!isDuplicate) {
                newEntry._last_updated = Date.now();
                existingEntries.push(newEntry);
                
                const verCount = existingEntries.length;
                if (verCount > 1) {
                    showToast('success', `機構「${safeName}」資料變更，已建立為版本 ${verCount}`);
                } else {
                    showToast('success', `已新增機構「${safeName}」至資料庫`);
                }

                // 刷新介面
                if (typeof renderInstitutionListItems === 'function' && document.getElementById('inst-list-container')) {
                    filterInstList();
                }
                
                const detailHeader = document.getElementById('inst-detail-title'); 
                if (detailHeader && detailHeader.innerText.trim().startsWith(safeName)) {
                    showInstitutionDetail(safeName); 
                }
                
                if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                    saveToLocal();
                }
            }
        }
        
        // 4. 開啟「機構清單與關聯查詢」視窗 (含手動新增功能)
        function openInstitutionList(preSelectName = null) {
            const modalId = 'inst-list-modal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-[160] flex items-center justify-center modal-overlay p-6';
            
            modal.innerHTML = `
                <div class="bg-white w-full max-w-6xl rounded-xl shadow-2xl flex flex-col h-[85vh] overflow-hidden animate-fade-in">
                    <div class="px-6 py-4 bg-primary text-white flex justify-between items-center flex-shrink-0">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-building"></i> 機構清單與關聯查詢
                        </h3>
                        <button onclick="document.getElementById('${modalId}').remove()" class="text-white hover:text-slate-200 w-8 h-8 rounded-full hover:bg-white/20 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="flex flex-grow overflow-hidden">
                        <div class="w-1/3 border-r border-slate-200 bg-slate-50 flex flex-col min-w-[300px]">
                            <div class="p-3 border-b border-slate-200 flex gap-2 items-center">
                                <div class="relative flex-grow">
                                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                                    <input type="text" id="inst-list-search" placeholder="搜尋機構..." 
                                        class="w-full pl-9 pr-3 text-sm border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition" 
                                        style="height: 42px;" oninput="filterInstList()">
                                </div>
                                <button onclick="openAddInstitutionModal()" 
                                    class="flex-shrink-0 w-10 bg-white border border-slate-300 rounded-lg text-slate-500 hover:text-indigo-600 hover:border-indigo-300 transition shadow-sm flex items-center justify-center"
                                    style="height: 42px;" 
                                    title="手動新增機構 (例如:總公司)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="inst-list-container" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-1"></div>
                        </div>

                        <div class="w-2/3 bg-white flex flex-col relative" id="inst-detail-panel">
                            <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                                <i class="fas fa-mouse-pointer text-4xl mb-4 opacity-30"></i>
                                <p>請從左側選擇一個機構</p>
                            </div>
                        </div>
                    </div>
                </div>`;
            
            document.body.appendChild(modal);
            
            filterInstList(); 

            if (preSelectName) {
                setTimeout(() => {
                    const searchInput = document.getElementById('inst-list-search');
                    if(searchInput) {
                        searchInput.value = preSelectName;
                        filterInstList();
                    }
                    const items = document.querySelectorAll('.inst-list-item-title');
                    for (let item of items) {
                        if (item.innerText.trim() === preSelectName.trim()) {
                            item.click();
                            break;
                        }
                    }
                }, 50);
            }
        }

        // 渲染可收合的機構樹狀列表
        function renderInstitutionListItems(names) {
            const container = document.getElementById('inst-list-container');
            container.innerHTML = '';
            
            if (names.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-slate-400 text-sm">無符合資料</div>';
                return;
            }

            const tree = {}; 
            const roots = []; 

            names.forEach(name => {
                const parent = institutionRelations[name];
                if (parent && names.includes(parent)) {
                    if (!tree[parent]) tree[parent] = [];
                    tree[parent].push(name);
                } else {
                    roots.push(name);
                }
            });

            const renderNode = (name, level = 0) => {
                const children = tree[name] || [];
                const hasChildren = children.length > 0;
                const paddingLeft = level * 1.5 + 0.5;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-0.5 select-none relative'; 

                const bgClass = level === 0 ? 'hover:bg-slate-50' : 'bg-slate-50 hover:bg-indigo-50/50';
                
                const el = document.createElement('div');
                el.className = `inst-list-item flex items-center justify-between p-2 rounded-lg cursor-pointer border border-transparent hover:border-slate-200 transition duration-150 ${bgClass}`;
                el.style.paddingLeft = `${paddingLeft}rem`;
                
                const isEmpty = (institutionLibrary[name] || []).length === 0;
                const emptyTag = isEmpty ? `<span class="ml-2 text-[10px] text-slate-400 border border-slate-200 px-1 rounded flex-shrink-0">純架構</span>` : '';
                
                const childCountBadge = hasChildren 
                    ? `<span class="ml-auto bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-full font-bold group-hover:bg-indigo-100 group-hover:text-indigo-600 transition">${children.length}</span>` 
                    : '';

                let iconHtml = '';
                if (hasChildren) {
                    iconHtml = `<div class="w-5 h-5 flex items-center justify-center mr-1 transition-transform duration-200 caret-icon"><i class="fas fa-caret-right text-slate-400"></i></div>`;
                } else {
                    iconHtml = level > 0 
                        ? `<div class="w-5 h-5 flex items-center justify-center mr-1"><i class="fas fa-level-up-alt rotate-90 text-slate-200 text-xs"></i></div>`
                        : `<div class="w-5 h-5 flex items-center justify-center mr-1"><i class="fas fa-circle text-[4px] text-slate-300"></i></div>`;
                }

                el.innerHTML = `
                    <div class="flex items-center min-w-0 flex-grow">
                        ${iconHtml}
                        <span class="inst-list-item-title font-bold text-slate-700 text-sm truncate mr-2">${name}</span>
                        ${emptyTag}
                    </div>
                    ${childCountBadge}
                `;
                
                wrapper.appendChild(el);

                let childContainer = null;
                if (hasChildren) {
                    childContainer = document.createElement('div');
                    // ★ 修正：移除 overflow-hidden，確保外框不被切掉
                    childContainer.className = 'hidden transition-all duration-300 ease-in-out border-l border-slate-200 ml-4 pl-1 inst-child-container'; 
                    children.forEach(child => {
                        childContainer.appendChild(renderNode(child, level + 1));
                    });
                    wrapper.appendChild(childContainer);
                }

                el.onclick = (e) => {
                    e.stopPropagation();
                    showInstitutionDetail(name);
                    
                    // 重置選取狀態
                    document.querySelectorAll('.inst-list-item').forEach(i => {
                        i.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50', 'text-indigo-700', 'z-20', 'relative');
                        const title = i.querySelector('.inst-list-item-title');
                        if(title) title.classList.remove('text-indigo-800');
                    });
                    
                    // 設定選取狀態 (加入 z-20 確保浮在上方)
                    el.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50', 'z-20', 'relative');
                    el.querySelector('.inst-list-item-title').classList.add('text-indigo-800');

                    if (childContainer) {
                        const isHidden = childContainer.classList.contains('hidden');
                        const icon = el.querySelector('.caret-icon');
                        if (isHidden) {
                            childContainer.classList.remove('hidden');
                            if(icon) icon.style.transform = 'rotate(90deg)'; 
                        } else {
                            childContainer.classList.add('hidden');
                            if(icon) icon.style.transform = 'rotate(0deg)'; 
                        }
                    }
                };
                return wrapper;
            };

            roots.sort().forEach(rootName => {
                container.appendChild(renderNode(rootName));
            });
        }

        // 搜尋過濾 (含父子層級顯示邏輯)
        function filterInstList() {
            const searchInput = document.getElementById('inst-list-search');
            if (!searchInput) return;
            
            const term = searchInput.value.toLowerCase();
            const allNames = Object.keys(institutionLibrary).sort();
            
            let matchedNames = new Set();
            
            allNames.forEach(name => {
                if (name.toLowerCase().includes(term)) {
                    matchedNames.add(name);
                    // 顯示父層
                    let parent = institutionRelations[name];
                    while (parent) {
                        matchedNames.add(parent);
                        parent = institutionRelations[parent];
                    }
                }
            });
            
            renderInstitutionListItems(Array.from(matchedNames));
        }

        // 手動建立機構
        function openAddInstitutionModal() {
            const modalId = 'add-inst-modal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-[180] flex items-center justify-center modal-overlay p-4';
            
            modal.innerHTML = `
                <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100 animate-fade-in">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-plus-circle text-primary"></i> 新增機構
                        </h3>
                        <button onclick="document.getElementById('${modalId}').remove()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="bg-indigo-50 text-indigo-800 text-sm p-3 rounded-lg border border-indigo-100">
                            <i class="fas fa-info-circle mr-1"></i> 此功能用於手動建立機構 (例如：建立一個沒有實習生的總公司，以便將分公司歸戶)。
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">機構名稱</label>
                            <input type="text" id="new-inst-name" class="input-stylish" placeholder="請輸入完整機構名稱...">
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                        <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 rounded-lg font-bold text-sm text-slate-500 hover:bg-slate-200 transition">取消</button>
                        <button id="btn-confirm-add-inst" class="px-6 py-2 rounded-lg font-bold text-sm text-white bg-primary hover:bg-sky-900 shadow-md transition">確認新增</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const input = document.getElementById('new-inst-name');
            setTimeout(() => input.focus(), 100);

            document.getElementById('btn-confirm-add-inst').onclick = () => {
                const name = input.value.trim();
                if (!name) {
                    showToast('warning', '請輸入機構名稱');
                    return;
                }
                
                if (institutionLibrary[name]) {
                    showToast('warning', '該機構已存在');
                    return;
                }
                
                // 建立空機構
                institutionLibrary[name] = [];
                
                if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                    saveToLocal();
                }
                
                showToast('success', `已建立機構：${name}`);
                document.getElementById(modalId).remove();
                
                // 刷新列表並選中
                filterInstList();
                showInstitutionDetail(name);
            };
        }

        function getCurrentApplication() {
            if (!currentStudentId) return null;
            if (!currentActiveAppId) return null;

            const student = groupedStudents[currentStudentId];
            if (!student || !student.applications) return null;
            
            return student.applications.find(a => a.id === currentActiveAppId);
        }

        // 跳轉輔助函式
        function jumpToStudent(sid, appId) {
            const modal = document.getElementById('inst-list-modal');
            if (modal) modal.remove();

            selectStudent(sid);

            if (appId) {
                setTimeout(() => {
                    switchTab(appId);
                    const contentArea = document.getElementById('form-content-area');
                    if(contentArea) contentArea.scrollTop = 0;
                }, 50);
            }
        }

        // 自訂設定總公司視窗
        function openSetParentModal(childName, currentParent) {
            const modalId = 'set-parent-modal';
            if(document.getElementById(modalId)) document.getElementById(modalId).remove();

            const modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 z-[180] flex items-center justify-center modal-overlay p-4';
            
            modal.innerHTML = `
                <div class="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden transform transition-all scale-100 animate-fade-in">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i class="fas fa-sitemap text-indigo-500"></i> 設定總公司
                        </h3>
                        <button onclick="document.getElementById('${modalId}').remove()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="bg-blue-50 text-blue-800 text-sm p-3 rounded-lg border border-blue-100">
                            正在為 <strong>${childName}</strong> 設定上層機構。
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">總公司 / 上層機構名稱</label>
                            <input type="text" id="parent-name-input" class="input-stylish" 
                                placeholder="請輸入機構名稱..." value="${currentParent || ''}" list="inst-names-list">
                            <datalist id="inst-names-list">
                                ${Object.keys(institutionLibrary).sort().map(n => `<option value="${n}">`).join('')}
                            </datalist>
                            <p class="text-xs text-slate-400 mt-1">※ 若該機構不存在，系統將自動建立一個架構用的空機構。</p>
                        </div>
                    </div>

                    <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center">
                        <button id="btn-clear-parent" class="text-red-500 hover:text-red-700 text-sm font-bold px-3 py-2 rounded hover:bg-red-50 transition ${!currentParent ? 'hidden' : ''}">
                            <i class="fas fa-unlink mr-1"></i> 解除關係
                        </button>
                        <div class="flex gap-2 ml-auto">
                            <button onclick="document.getElementById('${modalId}').remove()" class="px-4 py-2 rounded-lg font-bold text-sm text-slate-500 hover:bg-slate-200 transition">取消</button>
                            <button id="btn-save-parent" class="px-6 py-2 rounded-lg font-bold text-sm text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition">確認設定</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const input = document.getElementById('parent-name-input');
            setTimeout(() => input.focus(), 100);

            // ★ 修改：加入 async 以便使用 await showConfirm
            document.getElementById('btn-save-parent').onclick = async () => {
                const newParent = input.value.trim();
                
                if (newParent === "") {
                    showToast('warning', '請輸入名稱，或點擊左下角解除關係');
                    return;
                }
                if (newParent === childName) {
                    showToast('error', '不能設定自己為總公司/機構');
                    return;
                }
                // 簡易循環檢查
                if (institutionRelations[newParent] === childName) {
                    showToast('error', '無法設定：會造成循環參照');
                    return;
                }

                // ★ 修改：使用 showConfirm 取代原生 confirm，並更新文字
                if (!institutionLibrary[newParent]) {
                    const yes = await showConfirm(
                        '建立新機構？', 
                        `總公司/機構「${newParent}」不存在，是否立即建立？`
                    );
                    
                    if (yes) {
                        institutionLibrary[newParent] = [];
                    } else {
                        return; // 使用者取消
                    }
                }
                
                institutionRelations[childName] = newParent;
                finishUpdate(`已設定 ${newParent} 為總公司/機構`);
            };

            const clearBtn = document.getElementById('btn-clear-parent');
            if (clearBtn) {
                // ★ 修改：解除關係也改用 showConfirm
                clearBtn.onclick = async () => {
                    const yes = await showConfirm('確認解除？', '確定要解除目前的總公司/機構關係嗎？');
                    if (yes) {
                        delete institutionRelations[childName];
                        finishUpdate('已解除總公司/機構關係');
                    }
                };
            }

            function finishUpdate(msg) {
                if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                    saveToLocal();
                }
                showToast('success', msg);
                filterInstList(); 
                showInstitutionDetail(childName);
                document.getElementById(modalId).remove();
            }
        }

        // 套用機構版本 (正確邏輯版)
        async function applyInstitutionVersion(name, index) {
            const entries = institutionLibrary[name];
            
            if (!entries || index < 0 || index >= entries.length) {
                showToast('error', '機構版本資料錯誤或找不到');
                return;
            }

            const versionData = entries[index];
            const currentApp = getCurrentApplication();

            if (!currentApp) {
                showToast('error', '請先點擊上方的「實習紀錄」頁籤，打開您要填寫的表單');
                return;
            }
            
            const formId = currentApp.id;

            const yes = await showConfirm('確認套用機構版本', `您確定要將「${name}」的版本 ${index + 1} 資料套用到目前的實習紀錄嗎？\n這將會覆蓋現有的機構相關欄位。`);
            
            if (yes) {
                let changesCount = 0;
                
                Object.keys(versionData).forEach(fieldId => {
                    if (fieldId.startsWith('_')) return; 

                    let rawValue = versionData[fieldId];     
                    let displayValue = rawValue;             

                    // ROC 日期轉換
                    if (currentYearConfig && currentYearConfig.fields) {
                        const fDef = currentYearConfig.fields.find(f => f.id === fieldId);
                        if (fDef && fDef.type === 'date' && fDef.inputFormat === 'ROC' && rawValue.includes('-')) {
                            const p = rawValue.split('-');
                            if (p.length === 3) {
                                const rocY = parseInt(p[0]) - 1911;
                                displayValue = `${rocY}/${p[1]}/${p[2]}`;
                            }
                        }
                    }

                    if (currentApp.formData[fieldId] !== rawValue) {
                        currentApp.formData[fieldId] = rawValue;
                        changesCount++;
                    }

                    // UI 更新
                    let inputElement = document.querySelector(`.app-input-${formId}-${fieldId}`);
                    if (!inputElement) {
                        inputElement = document.getElementById(`input-${formId}-${fieldId}`);
                    }
                    
                    if (inputElement) {
                        inputElement.value = displayValue;
                        
                        inputElement.style.transition = 'background-color 0.3s';
                        inputElement.style.backgroundColor = '#dcfce7';
                        setTimeout(() => inputElement.style.backgroundColor = '', 500);
                        
                        if(inputElement.tagName === 'TEXTAREA') {
                            inputElement.style.height = 'auto';
                            inputElement.style.height = inputElement.scrollHeight + 'px';
                        }
                    }
                });

                evaluateLogic(currentApp);

                const modal = document.getElementById('inst-list-modal');
                if(modal) modal.remove();
                
                if (currentViewMode === 'grid') renderStudentLocalGrid(currentStudentId);
                
                if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                    saveToLocal();
                }

                showToast('success', `已成功套用機構版本 ${index + 1}，更新了 ${changesCount} 個欄位！`);
            }
        }
        
        // 刪除機構版本 (含防呆)
        async function deleteInstitutionVersion(name, index) {
            const entries = institutionLibrary[name];
            if (!entries || !entries[index]) return;

            const yes = await showConfirm('刪除版本？', `確定要刪除「${name}」的版本 ${index + 1} 嗎？\n此動作無法復原。`);
            if (yes) {
                // 指紋檢查 (防呆)
                const entry = entries[index];
                const { _last_updated, ...entryData } = entry;
                
                const generateFingerprint = (e) => {
                    const keys = Object.keys(e).filter(k => !k.startsWith('_')).sort();
                    const values = keys.map(k => e[k]);
                    return JSON.stringify(values);
                };
                const targetFP = generateFingerprint(entryData);
                
                let isUsed = false;
                Object.values(groupedStudents).forEach(s => {
                    s.applications.forEach(app => {
                        if (app.formData['internship_institution_name'] === name) {
                            const appInstData = {};
                            Object.keys(entryData).forEach(k => appInstData[k] = app.formData[k]);
                            if (generateFingerprint(appInstData) === targetFP) isUsed = true;
                        }
                    });
                });

                if (isUsed) {
                    showToast('error', '刪除失敗：資料正在使用中');
                    return;
                }

                entries.splice(index, 1);
                
                if (entries.length === 0) {
                    delete institutionLibrary[name];
                    // 若有設為總公司，也應移除其父子關係 (選擇性)
                    if (institutionRelations[name]) delete institutionRelations[name];
                    
                    document.getElementById('inst-detail-panel').innerHTML = `
                        <div class="absolute inset-0 flex flex-col items-center justify-center text-slate-400">
                            <i class="fas fa-trash-alt text-4xl mb-4 opacity-30"></i>
                            <p>機構已刪除</p>
                        </div>`;
                }

                if (localStorage.getItem(STORAGE_KEY + '_enabled') === 'true') {
                    saveToLocal();
                }

                filterInstList();

                if (institutionLibrary[name]) {
                    showInstitutionDetail(name);
                }

                showToast('success', '已刪除該版本');
            }
        }
        
        // 顯示機構詳情 (最終整合版)
        function showInstitutionDetail(name) {
            const panel = document.getElementById('inst-detail-panel');
            const entries = institutionLibrary[name] || [];
            
            // Highlight 同步邏輯 (保持不變)
            document.querySelectorAll('.inst-list-item').forEach(el => {
                const title = el.querySelector('.inst-list-item-title');
                const text = title ? title.innerText : el.innerText;
                if(text.trim() === name) {
                    el.classList.remove('border-transparent', 'hover:border-slate-200');
                    el.classList.add('ring-2', 'ring-indigo-500', 'bg-indigo-50', 'z-20', 'relative');
                    if(title) title.classList.add('text-indigo-800');
                } else {
                    el.classList.add('border-transparent', 'hover:border-slate-200');
                    el.classList.remove('ring-2', 'ring-indigo-500', 'bg-indigo-50', 'z-20', 'relative');
                    if(title) title.classList.remove('text-indigo-800');
                }
            });

            const parentName = institutionRelations[name] || null;
            const parentHtml = parentName 
                ? `<div class="mb-2 text-xs text-indigo-600 bg-indigo-50 inline-block px-2 py-1 rounded cursor-pointer hover:bg-indigo-100" onclick="showInstitutionDetail('${parentName}')"><i class="fas fa-level-up-alt rotate-90 mr-1"></i>隸屬於: <strong>${parentName}</strong></div>`
                : `<div class="mb-2 text-xs text-slate-400"><i class="fas fa-building mr-1"></i>獨立機構 / 總公司</div>`;

            panel.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="px-8 py-6 pb-2">
                        ${parentHtml}
                        <div class="flex justify-between items-start mb-4">
                            <h2 id="inst-detail-title" class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                ${name}
                                <span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full">共 ${entries.length} 個版本</span>
                            </h2>
                            <button id="set-parent-btn" class="text-xs bg-white border border-slate-300 text-slate-600 px-3 py-1.5 rounded hover:bg-slate-50 hover:text-primary transition" title="設定此機構的總公司">
                                <i class="fas fa-sitemap mr-1"></i> 設定總公司
                            </button>
                        </div>
                        
                        <div class="flex items-stretch gap-3 h-[42px]">
                            <div class="version-select-wrapper flex-grow relative h-full">
                                <select id="inst-version-select" class="version-select w-full h-full border border-slate-300 rounded-lg px-4 pl-4 pr-10 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-f1f5f9 appearance-none leading-[40px] py-0">
                                    ${entries.length === 0 ? '<option>無資料 (純架構)</option>' : ''}
                                    ${entries.map((entry, idx) => {
                                        const info = entry.internship_address || entry.internship_internship_address || '無詳細地址';
                                        const tax = entry.company_tax_id ? `(統編:${entry.company_tax_id})` : '';
                                        const isSelected = idx === entries.length - 1 ? 'selected' : '';
                                        return `<option value="${entries.length - 1 - idx}" ${isSelected}>版本 ${entries.length - idx} - ${info} ${tax}</option>`;
                                    }).reverse().join('')} 
                                </select>
                                <i class="fas fa-chevron-down version-select-icon absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                            </div>
                            
                            <button id="del-inst-version-btn" class="flex-shrink-0 w-12 h-full flex items-center justify-center bg-red-50 hover:bg-red-100 text-red-500 border border-red-200 rounded-lg transition shadow-sm" title="刪除此版本">
                                <i class="fas fa-trash-alt"></i>
                            </button>

                            <button id="apply-inst-version-btn" 
                                class="flex-shrink-0 h-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-5 rounded-lg transition shadow-md text-sm whitespace-nowrap flex items-center">
                                <i class="fas fa-download mr-2"></i> 套用此版本
                            </button>
                        </div>
                        </div>
                    <div class="flex-grow overflow-y-auto custom-scroll px-8 pb-8 space-y-6">
                        <div id="inst-version-content" class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm space-y-3"></div>
                        <div>
                            <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
                                <i class="fas fa-users text-indigo-500"></i> 使用此版本的學生
                                <span id="inst-student-count" class="bg-indigo-100 text-indigo-700 text-xs px-2 py-0.5 rounded-full">0</span>
                            </h4>
                            <div id="inst-student-list" class="border border-slate-200 rounded-lg overflow-hidden divide-y divide-slate-100"></div>
                        </div>
                    </div>
                </div>
            `;

            const setParentBtn = document.getElementById('set-parent-btn');
            if(setParentBtn) {
                setParentBtn.onclick = () => {
                    openSetParentModal(name, parentName);
                };
            }

            const updateContent = () => {
                const select = document.getElementById('inst-version-select');
                if(!select) return;
                
                if (entries.length === 0) {
                    document.getElementById('inst-version-content').innerHTML = '<div class="text-center text-slate-400 py-4">此機構目前僅作為分類架構使用，尚無詳細資料版本。</div>';
                    const applyBtn = document.getElementById('apply-inst-version-btn');
                    if(applyBtn) { applyBtn.disabled = true; applyBtn.classList.add('opacity-50', 'cursor-not-allowed'); }
                    const delBtn = document.getElementById('del-inst-version-btn');
                    if(delBtn) { delBtn.disabled = true; delBtn.classList.add('opacity-50', 'cursor-not-allowed'); }
                    return;
                }

                const reversedIndex = parseInt(select.value);
                const originalIndex = entries.length - 1 - reversedIndex; 
                const entry = entries[originalIndex];
                
                const contentDiv = document.getElementById('inst-version-content');
                const studentListDiv = document.getElementById('inst-student-list');
                const countBadge = document.getElementById('inst-student-count');

                const displayFields = Object.keys(entry).filter(k => !k.startsWith('_') && k !== 'internship_institution_name');
                const labelMap = { 'company_tax_id': '統一編號', 'internship_address': '地址', 'internship_city': '縣市', 'internship_country': '國別', 'industry_category': '行業別', 'internship_location': '實習場所' };

                let fieldsHtml = displayFields.map(key => {
                    let finalLabel = labelMap[key] || key;
                    if (currentYearConfig && currentYearConfig.fields) {
                        const f = currentYearConfig.fields.find(field => field.id === key);
                        if(f) finalLabel = f.label;
                    }
                    return `
                        <div class="flex flex-col pb-2 border-b border-slate-50 last:border-0 last:pb-0">
                            <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">${finalLabel}</span>
                            <span class="text-slate-700 font-medium break-all">${entry[key] || '-'}</span>
                        </div>
                    `;
                }).join('');
                
                contentDiv.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldsHtml || '無詳細資料'}</div>`;

                const matchedStudents = [];
                const { _last_updated, ...entryData } = entry;
                const generateFingerprint = (e) => {
                    const keys = Object.keys(e).filter(k => !k.startsWith('_')).sort();
                    const clean = {};
                    keys.forEach(k => clean[k] = e[k]);
                    return JSON.stringify(clean);
                };
                const entryFP = generateFingerprint(entryData);

                Object.values(groupedStudents).forEach(student => {
                    student.applications.forEach(app => {
                        if (app.formData['internship_institution_name'] === name) {
                            const appInstData = {};
                            Object.keys(entryData).forEach(k => appInstData[k] = app.formData[k]);
                            if (generateFingerprint(appInstData) === entryFP) {
                                const appIndex = student.applications.findIndex(a => a.id === app.id);
                                matchedStudents.push({ 
                                    student: student, 
                                    appId: app.id,
                                    appLabel: appIndex !== -1 ? `實習紀錄 ${appIndex + 1}` : '未知紀錄'
                                });
                            }
                        }
                    });
                });

                countBadge.innerText = matchedStudents.length;
                
                const delBtn = document.getElementById('del-inst-version-btn');
                if(delBtn) {
                    delBtn.dataset.usageCount = matchedStudents.length;
                    delBtn.className = matchedStudents.length > 0 
                        ? "flex-shrink-0 w-12 h-full flex items-center justify-center bg-slate-100 text-slate-300 border border-slate-200 rounded-lg cursor-not-allowed"
                        : "flex-shrink-0 w-12 h-full flex items-center justify-center bg-red-50 hover:bg-red-100 text-red-500 border border-red-200 rounded-lg transition shadow-sm cursor-pointer";
                    delBtn.title = matchedStudents.length > 0 ? "無法刪除：有學生正在使用此版本" : "刪除此版本";
                }

                if (matchedStudents.length === 0) {
                    studentListDiv.innerHTML = `<div class="p-8 text-center bg-slate-50 text-slate-500">沒有學生完全符合此版本資料</div>`;
                } else {
                    studentListDiv.innerHTML = matchedStudents.map(item => `
                        <div class="flex items-center justify-between p-3 hover:bg-indigo-50/50 transition cursor-pointer" 
                             onclick="jumpToStudent('${item.student.id}', '${item.appId}')">
                            <div class="flex flex-col items-start">
                                <div class="font-bold text-slate-700 text-sm">${item.student.name} (${item.student.id})</div>
                                <div class="text-xs text-indigo-600 font-bold mt-0.5">${item.appLabel}</div>
                            </div>
                            <button class="text-xs font-bold text-indigo-600 bg-white border border-indigo-200 px-3 py-1 rounded-full hover:bg-indigo-600 hover:text-white transition">
                                查看 <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    `).join('');
                }
            };

            const select = document.getElementById('inst-version-select');
            const applyBtn = document.getElementById('apply-inst-version-btn');
            const delBtn = document.getElementById('del-inst-version-btn');
            
            select.onchange = updateContent;

            applyBtn.onclick = () => {
                if (entries.length === 0) return;
                const reversedIndex = parseInt(select.value); 
                const originalIndex = entries.length - 1 - reversedIndex;
                applyInstitutionVersion(name, originalIndex);
            };

            delBtn.onclick = () => {
                if (entries.length === 0) return;
                const usage = parseInt(delBtn.dataset.usageCount || 0);
                if (usage > 0) {
                    showToast('warning', '無法刪除：目前有學生正在使用此版本的機構資料');
                    return;
                }
                const reversedIndex = parseInt(select.value);
                const originalIndex = entries.length - 1 - reversedIndex;
                deleteInstitutionVersion(name, originalIndex);
            };
            
            updateContent();
        }
    </script>
</body>
</html>
