container-${i}`, r.limitTo || [])); }
        }

        window.addRule = function() { window.currentRules.push({ dep: "", val: "", limitTo: [] }); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.removeRule = function(idx) { window.currentRules.splice(idx, 1); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.updateRule = function(idx, key, val) { window.currentRules[idx][key] = val; };
        window.updateRuleLimit = function(idx, opt, checked) { let arr = window.currentRules[idx].limitTo || []; if(checked) { if(!arr.includes(opt)) arr.push(opt); } else { arr = arr.filter(x => x !== opt); } window.currentRules[idx].limitTo = arr; };

        function saveField() {
            const id = document.getElementById('ed-field-id').value.trim(); const label = document.getElementById('ed-label').value.trim();
            if(!id || !label) return showMsg('error','錯誤','ID 與名稱為必填');
            
            let f = {};
            if(isEditMode) f = (targetList==='global'?configData.globalFields:yearTemplateData.fields).find(x=>x.id===document.getElementById('ed-orig-id').value);
            
            f.id = id; f.label = label; f.type = document.getElementById('ed-type').value; f.category = document.getElementById('ed-category').value;
            f.description = document.getElementById('ed-desc').value.trim(); 
            f.required = document.getElementById('ed-required').checked; f.isSystem = document.getElementById('ed-system').checked;

            if(document.getElementById('vis-toggle').checked) { f.visibilityRule = { dep: document.getElementById('ed-vis-dep').value, val: document.getElementById('ed-vis-val').value, action: document.getElementById('ed-vis-action').value }; } else { delete f.visibilityRule; }

            if(f.type === 'single_select') {
                f.options = window.currentOptions;
                if(Object.keys(window.currentOptionDescs).length > 0) f.optionDescriptions = window.currentOptionDescs; else delete f.optionDescriptions;

                if(document.getElementById('adv-logic-toggle').checked && window.currentRules.length > 0) {
                    const validRules = window.currentRules.filter(r => r.dep && r.val);
                    if(validRules.length === 1) { f.filterRule = validRules[0]; delete f.filterRules; } 
                    else if(validRules.length > 1) { f.filterRules = validRules; delete f.filterRule; } 
                    else { delete f.filterRule; delete f.filterRules; }
                } else { delete f.filterRule; delete f.filterRules; }
            }
            
            if(f.type === 'number') { if(document.getElementById('adv-num-toggle').checked) { f.calcMode=document.getElementById('ed-mode').value; f.decimal=parseInt(document.getElementById('ed-dec').value)||0; f.keepZero=document.getElementById('ed-keepZero').checked; } else { delete f.calcMode; delete f.decimal; delete f.keepZero; } }
            if(f.type === 'date') { if(document.getElementById('adv-date-toggle').checked) { f.inputFormat = document.getElementById('ed-date-in').value; f.outputFormat = document.getElementById('ed-date-out').value; f.precision = document.getElementById('ed-date-prec').value; } else { delete f.inputFormat; delete f.outputFormat; delete f.precision; } delete f.dateFormat; }
            if(f.type === 'text') { 
                if(document.getElementById('adv-text-toggle').checked) { 
                    f.maxLen = parseInt(document.getElementById('ed-maxlen').value) || 0; 
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                } else { delete f.maxLen; delete f.forceTai; } 
            }
            if(f.type === 'address') { // v30.0 Address
                if(document.getElementById('adv-addr-toggle').checked) {
                    f.blockJa = document.getElementById('ed-block-ja').checked;
                    f.toHalf = document.getElementById('ed-to-half').checked;
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                    f.smartFormat = document.getElementById('ed-smart-fmt').checked;
                } else { delete f.blockJa; delete f.toHalf; delete f.forceTai; delete f.smartFormat; }
            }

            if(!isEditMode && targetList==='global') { f.order = configData.globalFields.length+1; configData.globalFields.push(f); }

            document.getElementById('editor-modal').classList.add('hidden');
            targetList==='global'?renderGlobalList():renderYearFields(); setUnsaved(true);
            showMsg('info', '暫存成功', '設定已暫存，請記得按「儲存設定」發布。');
        }

        // --- Picker, Types, Save Config ---
        function openFieldPicker() {
            const list = document.getElementById('picker-list'); list.innerHTML = ''; document.getElementById('picker-select-all').checked=false;
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));
            if(available.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400">已加入所有模板欄位</div>';
            else available.forEach(f => list.innerHTML += `<label class="flex items-center p-3 border rounded-lg hover:border-primary cursor-pointer hover:bg-indigo-50 mb-2"><input type="checkbox" value="${f.id}" class="picker-checkbox custom-checkbox mr-3"><div class="flex-grow flex justify-between"><span class="font-bold text-sm text-slate-700">${f.label}</span><span class="text-xs text-slate-400 font-mono">${f.id}</span></div></label>`);
            document.getElementById('picker-modal').classList.remove('hidden');
        }
        function togglePickerAll(cb) { document.querySelectorAll('.picker-checkbox').forEach(c => c.checked = cb.checked); }
        function addSelectedFields() {
            const ids = Array.from(document.querySelectorAll('.picker-checkbox:checked')).map(c=>c.value);
            const map = {}; configData.globalFields.forEach(f=>map[f.id]=f.order); ids.sort((a,b)=>map[a]-map[b]);
            ids.forEach(id=>{ const t=configData.globalFields.find(x=>x.id===id); if(t) yearTemplateData.fields.push(JSON.parse(JSON.stringify(t))); });
            renderYearFields(); setUnsaved(true); document.getElementById('picker-modal').classList.add('hidden');
            showMsg('success', '成功', '欄位已加入');
        }
        
        function openTypeManager(){switchView('types');renderTypeManagerPage();}
        function renderTypeManagerPage(){const el=document.getElementById('type-list-page');el.innerHTML='';configData.fieldTypes.forEach(t=>el.innerHTML+=`<tr class="hover:bg-slate-50"><td class="px-6 py-3 font-mono text-xs text-primary font-bold">${t.key}</td><td class="px-6 py-3 text-xs font-bold">${t.label}</td><td class="px-6 py-3 text-right"><button onclick="editCustomTypePage('${t.key}')" class="text-slate-300 hover:text-primary mr-2"><i class="fas fa-pen"></i></button><button onclick="delCustomTypePage('${t.key}')" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`);}
        
        function editCustomTypePage(key) {
            const t = configData.fieldTypes.find(x => x.key === key); if(!t) return;
            showMsg('prompt', '編輯類型', '請輸入新的顯示名稱', {label: '顯示名稱', value: t.label}, (newLabel) => {
                if(newLabel && newLabel !== t.label) { t.label = newLabel; setUnsaved(true); renderTypeManagerPage(); showMsg('success', '成功', '類型名稱已更新'); }
            });
        }

        function addCustomTypePage(){const k=document.getElementById('new-type-key-page').value.trim(),l=document.getElementById('new-type-label-page').value.trim();if(!k||!l)return;if(configData.fieldTypes.some(t=>t.key===k))return showMsg('error','錯誤','Key 已存在');configData.fieldTypes.push({key:k,label:l});setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已新增'); }
        function delCustomTypePage(k){showMsg('confirm', '刪除類型？', '已使用此類型的欄位可能會顯示異常。', null,()=>{configData.fieldTypes=configData.fieldTypes.filter(t=>t.key!==k);setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已刪除'); });}

        async function saveConfig() { configSha = await uploadFile(ghConfig.path, configData, configSha); }
        async function saveAll() {
            const btn=document.getElementById('btn-save');btn.disabled=true;btn.innerHTML='<div class="spinner"></div>';
            try { await saveConfig(); if(activeYearId){const p=`hedb/year_templates/year_${activeYearId}_templates.json`;const c=await apiFetch(p);await uploadFile(p,yearTemplateData,c.status===200?c.sha:null);} setUnsaved(false); showMsg('success', '儲存成功', '所有設定已更新至 GitHub'); }
            catch(e){showMsg('error', '儲存失敗', e.message);} finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-upload-alt"></i> 儲存設定';}
        }

        async function apiFetch(path){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}?t=${Date.now()}`,{headers:{'Authorization':`token ${ghConfig.token}`,'Accept':'application/vnd.github.v3+json'}});if(r.status===404)return{status:404};const d=await r.json();if(Array.isArray(d))return{status:200,data:d};const c=decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));return{status:200,data:JSON.parse(c),sha:d.sha};}
        async function uploadFile(path,data,sha){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'PUT',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Update',content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),sha:sha})});if(!r.ok)throw new Error(r.status);const d=await r.json();return d.content.sha;}
        async function deleteFile(path,sha){await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'DELETE',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Del',sha:sha})});}

        function switchView(v) {
            ['years','fields','types'].forEach(x => { document.getElementById(`view-${x}`).classList.toggle('hidden', v!==x); document.getElementById(`view-${x}`).classList.toggle(x==='types'||x==='fields'?'flex':'flex', v===x); document.getElementById(`nav-${x}`).classList.toggle('active', v===x); });
            if(v==='fields')renderGlobalList(); if(v==='types')renderTypeManagerPage();
        }
        window.onload = init;
    </script>
</body>
</html>
