<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理後台 (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- 載入 Tailwind 設定與核心樣式 -->
    <script type="module">
        import { tailwindConfig } from './core/constants.js';
        tailwind.config = tailwindConfig;
    </script>

    <style>
        .login-bg { background: linear-gradient(135deg, #002E5D 0%, #0f172a 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-stylish { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); background: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .nav-btn.active { border-bottom: 3px solid #002E5D; color: #002E5D; font-weight: bold; background: #f1f5f9; }
        .nav-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover:not(.active) { color: #002E5D; background: #f8fafc; }

        .year-add-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; }
        .year-add-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .list-item { padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; background-color: #ffffff; color: #64748b; border: 1px solid transparent; }
        .list-item:hover { background-color: #f1f5f9; }
        .list-item.active { background-color: #EEF2FF; color: #002E5D; font-weight: bold; border: 1px solid #e0e7ff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        .btn-manage { background-color: #002E5D; color: white; }
        .btn-manage:hover { background-color: #001e3d; }
        .btn-create { background-color: #219653; color: white; }
        .btn-create:hover { background-color: #1e874b; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-warning:hover { background-color: D97706; }

        .data-table th { 
            background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 0.75rem 1rem; 
            font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        
        #results-table-container .data-table th {
            position: sticky; 
            top: 58px; 
            z-index: 20; 
        }
        
        .data-table td { 
            padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; 
            vertical-align: middle;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #f8fafc; }
        
        .action-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem; 
            height: 100%;
        }

        .custom-checkbox { height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #cbd5e1; color: #002E5D; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox:focus { ring: 2px solid #002E5D; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .logic-card { background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 0.75rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .logic-card:hover { border-color: #94A3B8; box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.08); transform: translateY(-1px); }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .opt-table th { background-color: #f1f5f9; padding: 8px 12px; font-size: 11px; color: #64748b; font-weight: bold; text-align: left; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; letter-spacing: 0.05em; }
        .opt-table td { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid #f8fafc; vertical-align: middle; }
        .opt-table tr:last-child td { border-bottom: none; }
        .opt-table tr:hover td { background-color: #f8fafc; }
        .sortable-ghost { opacity: 0.4; background-color: #e2e8f0; }
        
        .badge-warning { display: inline-block; padding: 2px 8px; background-color: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; color: #94a3b8; font-size: 11px; font-weight: bold; white-space: nowrap; }

        /* Custom style for tighter mapping UI */
        .mapping-container {
             display: grid;
             grid-template-columns: repeat(2, 1fr); /* Two columns */
             gap: 0.75rem; /* Gap between columns */
        }
        .mapping-group {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #fff;
            transition: all 0.2s;
        }
        .mapping-group:hover {
            border-color: #002E5D;
            background-color: #f8fafc;
        }
        .mapping-group select {
            padding: 0.5rem;
            font-size: 0.875rem;
        }
        /* Q2 Styling for CODE in left sidebar */
        .code-badge {
            display: inline-block;
            padding: 2px 6px;
            background-color: #002E5D;
            color: white;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-right: 0.5rem;
        }
        /* Q2 FIX: Style for historical name editor entry */
        .hist-editor-item {
            display: grid;
            grid-template-columns: 80px 1fr 100px; 
            gap: 1rem;
            align-items: center;
            padding: 0.5rem 0;
            /* Q2 Fix: Apply to direct items, not the container */
            border: 1px solid #e2e8f0; 
            border-radius: 0.5rem; 
            padding: 1rem;
            margin-bottom: 0.5rem;
            background-color: #f9fafb;
        }

    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-background">

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg"><i class="fas fa-university"></i></div>
                <h1 class="text-2xl font-bold text-primary tracking-wide">東海大學實習平台</h1>
                <p class="text-slate-500 text-sm mt-2 font-medium">系統管理後台 (System Admin)</p>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                <div class="relative"><i class="fas fa-key input-icon"></i><input type="password" id="gh-token" class="input-stylish" placeholder="Access Token"><button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary p-1"><i class="fas fa-eye" id="token-eye"></i></button></div>
                <div class="pt-4"><button onclick="connectGitHub()" id="btn-connect" class="w-full btn-manage font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><span>登入系統</span><i class="fas fa-arrow-right"></i></button><div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div></div>
            </div>
        </div>
    </div>

    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <div class="flex items-center gap-3"><div class="w-8 h-8 bg-primary text-white rounded flex items-center justify-center text-sm shadow"><i class="fas fa-tools"></i></div><h1 class="font-bold text-lg tracking-wide text-primary">系統配置中心</h1></div>
            <div class="flex items-center gap-3">
                <div id="unsaved-badge" class="hidden px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold border border-amber-200 flex items-center gap-1 animate-pulse"><i class="fas fa-pen"></i> 未儲存</div>
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100"><i class="fas fa-check-circle mr-1"></i> 儲存成功</span>
                <button onclick="saveAll()" id="btn-save" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all"><i class="fas fa-cloud-upload-alt"></i> 儲存設定</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> 登出</button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200 px-6 flex-shrink-0 z-20">
            <div class="flex gap-6">
                <button onclick="switchView('years')" id="nav-years" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 active"><i class="fas fa-calendar-alt"></i> 學年度模組配置</button>
                <button onclick="switchView('fields')" id="nav-fields" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-layer-group"></i> 欄位模板庫</button>
                <button onclick="switchView('departments')" id="nav-departments" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-school"></i> 系所清單管理</button>
                <button onclick="switchView('types')" id="nav-types" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-tags"></i> 欄位類型管理</button>
                <button onclick="switchView('internship')" id="nav-internship" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-users"></i> 實習學生名單彙整</button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden bg-slate-50">
            <!-- 學年度模組配置 -->
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openYearModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-plus text-lg"></i> 新增學年度</div></div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">學年度列表</div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-year-title">...</span><span id="default-badge" class="hidden text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">預設年度</span></h2><p class="text-xs text-slate-400 mt-1">此學年度的欄位配置 (獨立模組)</p></div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-white transition select-none mr-2"><input type="checkbox" id="is-default-year" class="custom-checkbox" onchange="toggleDefaultYear()"> 設為預設</label>
                                <button onclick="renameCurrentYear()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2.5 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentYear()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2.5 rounded-lg transition" title="刪除學年度"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ul text-primary"></i> 欄位列表</h3>
                                    <div class="flex items-center gap-2 ml-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm"><i class="fas fa-filter text-slate-400 text-xs"></i><select id="year-filter-cat" onchange="renderYearFields()" class="text-sm text-slate-600 outline-none bg-transparent cursor-pointer hover:text-primary"><option value="all">顯示所有分類</option></select></div>
                                    <button onclick="openLogicSummary('year')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                                    <div id="year-batch-controls" class="hidden">
                                        <button onclick="openBatchModal('year')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="year-batch-count">0</span>)</button>
                                    </div>
                                </div>
                                <button onclick="openFieldPicker()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> 從模板複製加入</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleYearAll(this); updateBatchControlVisibility('year')" class="custom-checkbox"></th><th class="w-16 text-center">排序</th><th class="w-1/4 text-center">欄位名稱 (ID)</th><th class="w-24 text-center">分類</th><th class="w-24 text-center">類型</th><th class="w-24 text-center">屬性</th><th class="w-40 text-center">操作</th></tr></thead><tbody id="year-field-list"></tbody></table></div></div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-calendar-alt"></i></div><p>請從左側選擇或新增一個學年度模組</p></div>
                </section>
            </div>

            <!-- 欄位模板庫 -->
            <div id="view-fields" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openCategoryModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-folder-plus text-lg"></i> 新增模板分類</div></div>
                    <div id="template-cat-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50 list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                        <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-cat-title">全部欄位</span></h2><p class="text-xs text-slate-400 mt-1">管理可供學年度引用的欄位原型。</p></div>
                        <div class="flex items-center gap-3">
                            <button onclick="openLogicSummary('global')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold mr-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                            <div id="global-batch-controls" class="hidden">
                                <button onclick="openBatchModal('global')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="global-batch-count">0</span>)</button>
                            </div>
                            <div id="cat-actions" class="hidden border-r border-slate-200 pr-3 mr-1 flex gap-1"><button onclick="renameCurrentCat()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button><button onclick="deleteCurrentCat()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2 rounded-lg transition" title="刪除"><i class="fas fa-trash-alt"></i></button></div>
                            <button onclick="addNewGlobalField()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 建立新模板</button>
                        </div>
                    </div>
                    <div class="flex-grow p-8 overflow-hidden flex flex-col"><div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleGlobalAll(this); updateBatchControlVisibility('global')" class="custom-checkbox"></th><th class="w-16 text-center">序號</th><th class="w-1/4 text-center">欄位名稱 (ID)</th><th class="w-24 text-center">類型</th><th class="w-48 text-center">屬性</th><th class="w-40 text-center">操作</th></tr></thead><tbody id="global-field-list"></tbody></table></div></div></div>
                </section>
            </div>

            <!-- 系所清單管理 (New View) -->
            <div id="view-departments" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openCollegeConfigModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-plus-square text-lg"></i> 新增學院</div></div>
                    <div id="college-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50 list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="dept-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-college-title">...</span></h2><p class="text-xs text-slate-400 mt-1">此學院下的所有系所清單。</p></div>
                            <div class="flex items-center gap-3">
                                <button onclick="openCollegeConfigModal(activeCollegeId)" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2.5 rounded-lg transition" title="編輯學院設定"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentCollege()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2.5 rounded-lg transition" title="刪除學院"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-end items-center mb-4">
                                <button onclick="openDepartmentConfigModal()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 新增系所</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                                <div class="overflow-y-auto custom-scroll flex-grow">
                                    <table class="w-full data-table">
                                        <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                                            <tr>
                                                <th class="w-16 text-center">排序</th>
                                                <th class="w-1/2 text-left">系所名稱 (ID/CODE)</th>
                                                <th class="w-40 text-center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="department-list-body">
                                            <!-- Department items rendered here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="dept-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-school"></i></div><p>請從左側選擇或新增一個學院</p></div>
                </section>
            </div>


            <!-- 欄位類型管理 -->
            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:col-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>

            <!-- 實習學生名單彙整 -->
            <div id="view-internship" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <label for="student-list-file" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-file-upload text-lg"></i> 上傳註課組清單
                        </label>
                        <input type="file" id="student-list-file" onchange="handleFileUpload(event)" class="hidden">
                        <p id="file-status" class="text-xs text-slate-400 mt-2 text-center">請上傳 .xlsx 或 .csv</p>
                    </div>
                    
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">名單分組列表</div>
                    <div id="internship-group-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none">
                         <div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup('all')"><span class="font-bold text-sm">全部</span></div>
                         <div class="p-8 text-center text-slate-400 text-xs hidden" id="group-list-empty-state">請先上傳名單並完成彙整</div>
                    </div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="internship-config-panel" class="flex flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center flex-shrink-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <span id="current-internship-group-title">實習學生名單彙整</span>
                                </h2>
                                <p class="text-xs text-slate-400 mt-1">
                                    <span id="group-detail-subtitle">請上傳名單並進行匹配</span>
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="reopenMappingModal()" id="btn-reopen-mapping" class="btn-warning font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all hidden"><i class="fas fa-wrench"></i> 重新匹配欄位</button>
                                <button onclick="downloadAllGroupsZip()" id="btn-batch-download-all-results-main" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all hidden"><i class="fas fa-file-archive"></i> 全系批次下載 (打包ZIP)</button>
                                <button onclick="openAllianceModal()" id="btn-alliance-config" disabled class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-sitemap"></i> 設定系所分組/聯盟</button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            
                            <div id="results-display-area" class="flex-grow bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                                <div id="results-empty-state" class="p-8 text-center text-slate-400">
                                    <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl mx-auto"><i class="fas fa-table"></i></div>
                                    請上傳名單，並在彈出視窗中完成欄位匹配。
                                </div>
                                <div id="results-table-container" class="hidden flex-grow overflow-y-auto custom-scroll">
                                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center sticky top-0 z-30">
                                        <h4 class="text-sm font-bold text-slate-700">共 <span id="current-group-record-count">0</span> 筆紀錄</h4>
                                        <button onclick="downloadBatch(currentSelectedGroup)" class="btn-create py-1.5 px-4 rounded-lg text-xs font-bold shadow-sm"><i class="fas fa-file-excel mr-1"></i> 下載此分組名單</button>
                                    </div>
                                    <table class="w-full data-table">
                                        <thead class="sticky top-0 bg-white">
                                            <tr id="results-table-headers"></tr>
                                        </thead>
                                        <tbody id="results-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:col-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="mapping-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-primary/5 flex-shrink-0">
                <h3 class="text-lg font-bold text-primary flex items-center gap-2"><i class="fas fa-random text-primary"></i> 欄位匹配與匯出清單設定</h3>
                <button onclick="closeMappingModal(true)" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-white flex flex-col">
                <div class="mb-6 bg-white rounded-xl shadow-md border border-slate-200 p-6 flex-shrink-0">
                    <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="fas fa-calendar-alt text-primary"></i> 選擇學年度模組</label> 
                    <select id="consolidation-year-select" onchange="fetchCurrentTemplateFields(true)" class="w-full border border-slate-300 rounded-lg p-3 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl flex-shrink-0">
                    <h4 class="text-sm font-bold text-blue-700 flex items-center gap-2 mb-2"><i class="fas fa-info-circle"></i> 彙整欄位與匹配原則</h4>
                    <p class="text-xs text-blue-600 leading-relaxed">
                        系統將自動納入學年度模組中【系統】開課資訊與【系統】學生資訊兩分類下的所有欄位進行彙整。您只需在下方將**模組欄位**對應到上傳清單中的**正確 Excel 欄位**即可。
                        <span class="font-bold text-red-700">（注意：匹配設定為非必填，但若未匹配，該欄位資料將為空白。）</span>
                    </p>
                </div>

                <div class="flex gap-6 mt-6 flex-grow overflow-hidden h-full">
                    <!-- NEW SINGLE PANEL STRUCTURE: Tighter UI -->
                    <div id="excel-mapping-panel" class="w-full p-4 bg-white border border-slate-200 rounded-xl shadow-lg flex flex-col overflow-hidden h-full">
                        <div class="flex-shrink-0 mb-3 border-b border-slate-200 pb-2 flex items-center justify-between">
                            <span class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-map-marked-alt text-primary"></i> 欄位匹配設定區 (<span id="total-module-fields">0</span> 個系統欄位)</span>
                            <span class="text-xs text-slate-500 font-normal">已匹配 <span id="selected-mapping-count" class="font-bold text-primary">0</span> 個 Excel 欄位</span>
                        </div>
                        <!-- UI Redesign: Horizontal two-column grid -->
                        <div id="mapping-dropdown-container" class="mapping-container overflow-y-auto custom-scroll p-1 flex-grow">
                            <!-- Dropdowns render here -->
                        </div>
                        <div id="mapping-panel-empty-state" class="text-center text-slate-400 text-xs py-12 hidden flex-grow justify-center items-center">請先選定學年度模組</div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-primary/5 flex justify-end gap-3 flex-shrink-0">
                <button onclick="closeMappingModal(true)" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="processUploadedFile()" id="btn-process-list" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition flex items-center gap-2"><i class="fas fa-cogs"></i> 開始彙整名單</button>
            </div>
        </div>
    </div>

    <div id="msg-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4 transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm" id="msg-icon"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="msg-title"></h3><p class="text-sm text-slate-500 mb-6 leading-relaxed" id="msg-desc"></p>
            <div id="msg-input-area" class="hidden mb-6 text-left"><label class="block text-xs font-bold text-slate-400 uppercase mb-1" id="msg-input-label"></label><input type="text" id="msg-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none text-slate-700"><div id="msg-select-area" class="hidden mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">複製來源</label><select id="msg-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select></div></div>
            <div class="flex gap-3 justify-center" id="msg-btns"></div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> <span id="editor-title">編輯欄位屬性</span></h3>
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="flex flex-grow overflow-hidden">
                <div class="w-80 bg-slate-50 border-r border-slate-200 flex-shrink-0 overflow-y-auto custom-scroll p-6 space-y-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">基本設定</h4>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位 ID <span class="text-red-500">*</span></label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono text-blue-600 focus:ring-primary outline-none" placeholder="e.g. f_name"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">顯示名稱 <span class="text-red-500">*</span></label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. 學生姓名"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位說明 (Help Text)</label><textarea id="ed-desc" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none resize-none h-20" placeholder="例如: 請填寫學生所屬學院..."></textarea><p class="text-[10px] text-slate-400 mt-1">此說明僅顯示於填報介面提示，不會匯出至 Excel。</p></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">所屬分類</label><select id="ed-category" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none"></select></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位類型</label><select id="ed-type" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none" onchange="renderOpts()"></select></div>
                    <div class="pt-2 space-y-3">
                        <div>
                            <label class="flex items-center text-sm cursor-pointer mb-1"><input type="checkbox" id="ed-system" class="custom-checkbox mr-2" onchange="toggleSystemHint(this.checked)"> <span class="font-bold text-slate-700">系統自動帶入 (唯讀/匯入)</span></label>
                            <p id="sys-hint" class="text-[10px] text-amber-600 pl-6 leading-tight">此欄位對應匯入檔案，使用者無法編輯。建議勾選『必填』確保資料完整。</p>
                        </div>
                        <label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="ed-required" class="custom-checkbox mr-2"> <span class="font-bold text-slate-700">必填項目</span></label>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll bg-white">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-eye"></i> 欄位顯示控制 (Visibility)</h4><p class="text-[11px] text-slate-400 mt-1">控制此欄位在什麼情況下才顯示。</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="vis-toggle" class="sr-only peer" onchange="toggleVisSettings(this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600" id="vis-label">總是顯示</span></label>
                        </div>
                        <div id="vis-settings" class="hidden bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex items-center gap-2 text-xs text-slate-500 mb-2"><i class="fas fa-info-circle"></i> 當以下條件成立時，執行動作：</div>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">依賴對象 (決定者)</label><select id="ed-vis-dep" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"></select></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">當內容是 (條件值)</label><input id="ed-vis-val" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="輸入觸發值"></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">動作 (Action)</label><select id="ed-vis-action" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="show">顯示 (Show)</option><option value="hide">隱藏 (Hide)</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div id="ed-opts-container" class="p-8"></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="saveField()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition">確認暫存</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[80vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-project-diagram text-primary"></i> 邏輯總覽與衝突檢測</h3>
                <button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-slate-50">
                <div id="logic-conflicts" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="text-red-700 font-bold flex items-center gap-2 mb-2"><i class="fas fa-exclamation-triangle"></i> 發現邏輯問題</h4><ul id="conflict-list" class="list-disc list-inside text-sm text-red-600 space-y-2"></ul></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-eye text-indigo-500 mr-2"></i> 顯示條件 (Visibility)</span><span id="vis-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="vis-list" class="space-y-4"></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-list-ul text-emerald-500 mr-2"></i> 選項連動 (Option Logic)</span><span id="opt-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="opt-list" class="space-y-4"></div></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end"><button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm shadow">關閉視窗</button></div>
        </div>
    </div>

    <div id="addr-rules-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-map-marker-alt text-primary"></i> 地址正規化規則設定</h3>
                <button onclick="document.getElementById('addr-rules-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">保護名單 (Whitelist)</label>
                    <p class="text-xs text-slate-500 mb-2">下列詞彙中的中文數字不會被轉換 (例如：五權路)。請用逗號分隔。</p>
                    <textarea id="addr-protected" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">識別關鍵字 (Keywords)</label>
                    <p class="text-xs text-slate-500 mb-2">當中文數字出現在這些字之前，將強制轉為阿拉伯數字 (例如：五段 -> 5段)。</p>
                    <textarea id="addr-keywords" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">特定路名模式 (Specific Patterns)</label>
                    <p class="text-xs text-slate-500 mb-2">遇到這些詞（如：東南西北、區、道）開頭或接續的數字，將強制轉為阿拉伯數字。</p>
                    <textarea id="addr-specials" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAddrRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存規則</button>
            </div>
        </div>
    </div>

    <div id="choice-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-tools"></i></div><h3 class="text-lg font-bold text-slate-800 mb-2">請選擇修正方式</h3><p class="text-sm text-slate-500 mb-6">您想要修改目前的「規則設定」，還是補齊「源頭選項」？</p><div class="flex flex-col gap-3"><button id="btn-edit-self" class="w-full py-3 rounded-lg border border-indigo-200 text-indigo-700 font-bold hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i class="fas fa-sliders-h"></i> 修改規則設定</button><button id="btn-fix-source" class="w-full py-3 rounded-lg border border-emerald-200 text-emerald-700 font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> 補齊源頭選項 (自動修復)</button></div><button onclick="document.getElementById('choice-modal').classList.add('hidden')" class="mt-4 text-xs text-slate-400 hover:text-slate-600 underline">取消</button></div></div>
    <div id="impact-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="flex items-center gap-3 mb-4 text-amber-600"><i class="fas fa-exclamation-triangle text-2xl"></i><h3 class="text-lg font-bold text-slate-800">確認變更源頭結構</h3></div><p class="text-sm text-slate-600 mb-4 leading-relaxed">您即將在源頭欄位 <span id="imp-dep-name" class="font-bold text-primary"></span> 中新增選項 <span id="imp-val" class="font-bold text-emerald-600 bg-emerald-50 px-1 rounded"></span>。</p><div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-500 mb-6"><p class="font-bold mb-1">影響範圍評估：</p><p>此欄位目前被 <span id="imp-count" class="font-bold text-primary">0</span> 個規則引用。新增選項通常是安全的，但請確保這符合您的資料定義。</p></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('impact-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button id="btn-confirm-fix" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 text-sm">確認新增並修復</button></div></div></div>
    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="text-lg font-bold text-slate-800">從模板複製欄位</h3><button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button></div><div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200"><label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer"><input type="checkbox" id="picker-select-all" class="custom-checkbox mr-2" onchange="togglePickerAll(this)"> 全選 / 取消全選</label></div><div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div><div class="mt-4 pt-2 border-t border-slate-100 flex justify-end"><button onclick="addSelectedFields()" class="w-full btn-create font-bold py-2.5 rounded-lg shadow">確認複製選取欄位</button></div></div></div>
    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800">移動順序</h3><p class="text-sm text-slate-500 mt-1">將 <span id="move-target-name" class="font-bold text-primary"></span> 移動至：</p></div><div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-h-60 overflow-y-auto custom-scroll"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('move-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button onclick="saveMove()" class="px-4 py-2 btn-manage rounded-lg font-bold shadow-md text-sm">確認移動</button></div></div></div>
    <div id="batch-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-tasks text-indigo-600"></i> 欄位批次處理</h3>
                <button onclick="document.getElementById('batch-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-600">您已選取 <span id="batch-count" class="font-bold text-primary">0</span> 個欄位進行批次處理。</p>
                
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 mb-1 block">請選擇要執行的動作</label>
                    <select id="batch-action-select" onchange="toggleBatchActionSettings(this.value)" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none">
                        <option value="">請選擇...</option>
                        <option value="category">變更所屬分類</option>
                        <option value="delete">刪除選取項目</option>
                    </select>
                </div>
                
                <div id="batch-category-group" class="hidden space-y-3">
                    <label class="text-sm font-bold text-slate-700 block">新分類</label>
                    <select id="batch-category-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div id="batch-delete-confirm" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-700 font-bold flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> 確認刪除</p>
                    <p class="text-xs text-red-600 mt-1">此操作不可復原，請謹慎確認。</p>
                </div>
            </div>
            <div class="mt-6 pt-3 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="executeBatchAction()" id="btn-execute-batch" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-md hover:bg-indigo-700 text-sm flex items-center gap-2" disabled><i class="fas fa-check"></i> 確認執行</button>
            </div>
        </div>
    </div>
    <div id="alliance-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sitemap text-primary"></i> 系所分組/聯盟設定</h3>
                <button onclick="document.getElementById('alliance-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                
                <!-- ALLIANCE CONTROL PANEL -->
                <div class="p-4 bg-primary/5 border border-primary/20 rounded-xl space-y-4">
                    <p class="text-sm text-slate-600 font-bold mb-2 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> 聯盟邏輯設定</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">主要分組依據 (Primary Basis)</label>
                            <select id="alliance-grouping-basis" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                                <option value="course_dept">依開課學系 (course_dept)</option>
                                <option value="student_dept">依學生所屬學系 (student_dept)</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">聯盟判斷與預設分組的首要依據。</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">遺珠處理方式 (Unmatched Handling)</label>
                            <select id="alliance-unmatched-handling" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                                <option value="use_primary">保留原始分組依據 (預設: course_dept 或 student_dept)</option>
                                <option value="use_secondary">使用次要系所分組 (如：學生所屬學系)</option>
                                <option value="use_alliance_only">僅聯盟內系所可結盟分組，其餘皆獨立分組</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">當兩方系所不完全在同一個聯盟時的最終分組策略。</p>
                        </div>
                    </div>
                </div>
                <!-- END ALLIANCE CONTROL PANEL -->

                <div id="alliance-rules-container" class="space-y-4">
                    <p class="text-sm text-slate-600 mt-4">在此定義多組聯盟。聯盟間的系所不應重複。</p>
                    </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAllianceRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存聯盟設定</button>
            </div>
        </div>
    </div>
    <script type="module" src="./core/constants.js"></script>
    <script type="module" src="./core/api.js"></script>
    <script type="module" src="./core/utils.js"></script>
    <script type="module" src="./core/app.js"></script>
</body>
</html>
