<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理後台 (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC',
                        indigo: { 600: '#4F46E5', 700: '#4338CA' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #F3E8FF 0%, #E0F2FE 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-stylish { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); background: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .nav-btn.active { border-bottom: 3px solid #002E5D; color: #002E5D; font-weight: bold; background: #f1f5f9; }
        .nav-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover:not(.active) { color: #002E5D; background: #f8fafc; }

        .year-add-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; }
        .year-add-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .list-item { padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; background-color: #ffffff; color: #64748b; border: 1px solid transparent; }
        .list-item:hover { background-color: #f1f5f9; }
        .list-item.active { background-color: #EEF2FF; color: #002E5D; font-weight: bold; border: 1px solid #e0e7ff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        .btn-manage { background-color: #002E5D; color: white; }
        .btn-manage:hover { background-color: #001e3d; }
        .btn-create { background-color: #219653; color: white; }
        .btn-create:hover { background-color: #1e874b; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-warning:hover { background-color: #D97706; }

        .data-table th { 
            background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 0.75rem 1rem; 
            font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        
        #results-table-container .data-table th {
            position: sticky; 
            top: 58px; 
            z-index: 20; 
        }
        
        .data-table td { 
            padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; 
            vertical-align: middle;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #f8fafc; }
        
        .action-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            /* Added gap for better spacing */
            gap: 0.5rem; 
            height: 100%;
        }

        .custom-checkbox { height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #cbd5e1; color: #002E5D; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox:focus { ring: 2px solid #002E5D; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .logic-card { background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 0.75rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .logic-card:hover { border-color: #94A3B8; box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.08); transform: translateY(-1px); }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .opt-table th { background-color: #f1f5f9; padding: 8px 12px; font-size: 11px; color: #64748b; font-weight: bold; text-align: left; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; letter-spacing: 0.05em; }
        .opt-table td { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid #f8fafc; vertical-align: middle; }
        .opt-table tr:last-child td { border-bottom: none; }
        .opt-table tr:hover td { background-color: #f8fafc; }
        .sortable-ghost { opacity: 0.4; background-color: #e2e8f0; }
        
        .badge-warning { display: inline-block; padding: 2px 8px; background-color: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; color: #94a3b8; font-size: 11px; font-weight: bold; white-space: nowrap; }

        /* Custom style for tighter mapping UI (Point 3) */
        .mapping-container {
             display: grid;
             grid-template-columns: repeat(2, 1fr); /* Two columns */
             gap: 0.75rem; /* Gap between columns */
        }
        .mapping-group {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            background-color: #fff;
            transition: all 0.2s;
        }
        .mapping-group:hover {
            border-color: #002E5D;
            background-color: #f8fafc;
        }
        .mapping-group select {
            padding: 0.5rem;
            font-size: 0.875rem;
        }

    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-background">

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="bg-primary p-4 rounded-xl mx-auto mb-6 w-fit shadow-lg">
                    <img src="files/svg/THU-Logo.svg" class="h-16 w-auto block" alt="東海大學 Logo">
                </div>
                
                <h1 class="text-2xl font-bold text-primary tracking-wide">東海大學<br>學生校外實習校庫填報輔助系統</h1>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                
                <div class="relative">
                    <i class="fas fa-key input-icon"></i>
                    <input type="password" id="gh-token" class="input-stylish pr-10" placeholder="Access Token">
                    <button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary p-1"><i class="fas fa-eye" id="token-eye"></i></button>
                </div>
                
                <div class="pt-4"><button onclick="connectGitHub()" id="btn-connect" class="w-full btn-manage font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><span>登入系統</span><i class="fas fa-arrow-right"></i></button><div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div></div>
            </div>
        </div>
    </div>

    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm z-30 gap-4">
            <div class="flex items-center gap-3 flex-shrink-0">
                <div class="bg-primary p-1.5 rounded-lg shadow-sm">
                    <img src="files/svg/THU-Logo.svg" class="h-8 w-auto block" alt="Logo">
                </div>
                
                <h1 class="font-bold text-lg tracking-wide text-primary flex items-center gap-2">
                    東海大學學生校外實習校庫填報輔助系統
                    <span class="bg-sky-100 text-sky-700 px-3 py-1 rounded-lg text-sm border border-sky-200 shadow-sm">後台管理</span>
                </h1>
            </div>

            <div class="flex-grow"></div>

            <div class="flex items-center gap-3 flex-shrink-0">
                <div id="unsaved-badge" class="hidden px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold border border-amber-200 flex items-center gap-1 animate-pulse">
                    <i class="fas fa-pen"></i> 未儲存
                </div>
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">
                    <i class="fas fa-check-circle mr-1"></i> 儲存成功
                </span>
                <button onclick="saveAll()" id="btn-save" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all">
                    <i class="fas fa-cloud-upload-alt"></i> 儲存設定
                </button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200 px-6 flex-shrink-0 z-20">
            <div class="flex gap-6">
                <button onclick="switchView('years')" id="nav-years" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 active"><i class="fas fa-calendar-alt"></i> 學年度模組配置</button>
                <button onclick="switchView('fields')" id="nav-fields" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-layer-group"></i> 欄位模板庫</button>
                <button onclick="switchView('departments')" id="nav-departments" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-school"></i> 系所清單管理</button>
                <button onclick="switchView('internship')" id="nav-internship" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-users"></i> 實習學生名單彙整</button>
                <button onclick="switchView('types')" id="nav-types" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-tags"></i> 欄位類型管理</button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden bg-slate-50">
            <!-- 學年度模組配置 -->
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openYearModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-calendar-plus text-lg"></i> 新增學年度</div></div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">學年度列表</div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <div class="flex items-center gap-3">
                                    <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                        <span id="current-year-title">...</span>
                                        <span id="default-badge" class="hidden text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">預設年度</span>
                                    </h2>
                                    <button onclick="renameCurrentYear()" class="text-slate-400 hover:text-primary hover:bg-slate-100 p-1.5 rounded-lg transition" title="重新命名"><i class="fas fa-pen text-sm"></i></button>
                                    <button onclick="deleteCurrentYear()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-1.5 rounded-lg transition" title="刪除學年度"><i class="fas fa-trash-alt text-sm"></i></button>
                                </div>
                                <p class="text-xs text-slate-400 mt-1">此學年度的欄位配置 (獨立模組)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-white transition select-none mr-2"><input type="checkbox" id="is-default-year" class="custom-checkbox" onchange="toggleDefaultYear()"> 設為預設</label>
                                </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ul text-primary"></i> 欄位列表</h3>
                                    <div class="flex items-center gap-2 ml-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm"><i class="fas fa-filter text-slate-400 text-xs"></i><select id="year-filter-cat" onchange="renderYearFields()" class="text-sm text-slate-600 outline-none bg-transparent cursor-pointer hover:text-primary"><option value="all">顯示所有分類</option></select></div>
                                    <button onclick="openLogicSummary('year')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                                    <div id="year-batch-controls" class="hidden">
                                        <button onclick="openBatchModal('year')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="year-batch-count">0</span>)</button>
                                    </div>
                                </div>
                                <button onclick="openFieldPicker()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> 從模板複製加入</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleYearAll(this); updateBatchControlVisibility('year')" class="custom-checkbox"></th><th class="w-16 text-center">排序</th><th class="w-1/4 text-center">欄位名稱 (ID)</th><th class="w-24 text-center">分類</th><th class="w-24 text-center">類型</th><th class="w-24 text-center">屬性</th><th class="w-40 text-center">操作</th></tr></thead><tbody id="year-field-list"></tbody></table></div></div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-calendar-alt"></i></div><p>請從左側選擇或新增一個學年度模組</p></div>
                </section>
            </div>

            <!-- 欄位模板庫 -->
            <div id="view-fields" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <div onclick="openCategoryModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-folder-plus text-lg"></i> 新增模板分類
                        </div>
                    </div>
                    <div id="template-cat-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50 list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                        <div>
                            <div class="flex items-center gap-3">
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-cat-title">全部欄位</span></h2>
                                <div id="cat-actions" class="hidden flex gap-1">
                                    <button onclick="renameCurrentCat()" class="text-slate-400 hover:text-primary hover:bg-slate-100 p-1.5 rounded-lg transition" title="重新命名"><i class="fas fa-pen text-sm"></i></button>
                                    <button onclick="deleteCurrentCat()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-1.5 rounded-lg transition" title="刪除"><i class="fas fa-trash-alt text-sm"></i></button>
                                </div>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">管理可供學年度引用的欄位原型。</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openLogicSummary('global')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold mr-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                            <div id="global-batch-controls" class="hidden">
                                <button onclick="openBatchModal('global')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="global-batch-count">0</span>)</button>
                            </div>
                            <button onclick="addNewGlobalField()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 建立新模板</button>
                        </div>
                    </div>
                    
                    <div class="flex-grow p-8 overflow-hidden flex flex-col">
                        <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                            <div class="overflow-y-auto custom-scroll flex-grow">
                                <table class="w-full data-table">
                                    <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                                        <tr>
                                            <th class="w-12 text-center"><input type="checkbox" onchange="toggleGlobalAll(this); updateBatchControlVisibility('global')" class="custom-checkbox"></th>
                                            <th class="w-16 text-center">序號</th>
                                            <th class="w-1/4 text-center">欄位名稱 (ID)</th>
                                            <th class="w-24 text-center">類型</th>
                                            <th class="w-48 text-center">屬性</th>
                                            <th class="w-40 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="global-field-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- 系所清單管理 (New View) -->
            <div id="view-departments" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openCollegeModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-plus-square text-lg"></i> 新增學院</div></div>
                    <div id="college-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50 list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="dept-config-panel" class="hidden flex-col h-full">
                    <!-- 修正：將新增系所按鈕移到頂部標頭右側 -->
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center flex-shrink-0">
                        <div>
                            <div class="flex items-center gap-3">
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-college-title">...</span></h2>
                                <button onclick="renameCurrentCollege()" class="text-slate-400 hover:text-primary hover:bg-slate-100 p-1.5 rounded-lg transition" title="編輯學院基本資訊"><i class="fas fa-pen text-sm"></i></button>
                                <button onclick="deleteCurrentCollege()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-1.5 rounded-lg transition" title="刪除學院"><i class="fas fa-trash-alt text-sm"></i></button>
                            </div>
                            <p class="text-xs text-slate-400 mt-1">此學院下的所有系所清單。</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="openDeptModal()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 新增系所</button>
                            </div>
                    </div>
                    <!-- 修正：移除舊有的按鈕容器 -->
                    <div class="flex-grow p-8 overflow-hidden flex flex-col">
                        <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                            <div class="overflow-y-auto custom-scroll flex-grow">
                                <table class="w-full data-table">
                                    <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                                        <tr>
                                            <th class="w-16 text-center">排序</th>
                                            <th class="w-1/2 text-left">系所名稱 (ID/CODE)</th>
                                            <th class="w-40 text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="department-list-body">
                                        <!-- Department items rendered here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                    <div id="dept-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-school"></i></div><p>請從左側選擇或新增一個學院</p></div>
                </section>
            </div>


            <!-- 欄位類型管理 -->
            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>

            <!-- 實習學生名單彙整 -->
            <div id="view-internship" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <label for="student-list-file" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-file-upload text-lg"></i> 上傳註課組清單
                        </label>
                        <input type="file" id="student-list-file" onchange="handleFileUpload(event)" class="hidden">
                        <p id="file-status" class="text-xs text-slate-400 mt-2 text-center">請上傳 .xlsx 或 .csv</p>
                    </div>
                    <div class="p-3 border-b border-slate-100 bg-slate-50/50">
                        <select id="internship-sidebar-college-filter" onchange="renderInternshipSidebar()" class="w-full border border-slate-300 rounded-lg p-2 text-sm outline-none focus:ring-2 focus:ring-primary text-slate-700 font-bold">
                            <option value="">全部學院</option>
                        </select>
                    </div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">名單分組列表</div>
                    <div id="internship-group-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none">
                         <div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup('all')"><span class="font-bold text-sm">全部</span></div>
                         <div class="p-8 text-center text-slate-400 text-xs hidden" id="group-list-empty-state">請先上傳名單並完成彙整</div>
                    </div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="internship-config-panel" class="flex flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center flex-shrink-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <span id="current-internship-group-title">實習學生名單彙整</span>
                                </h2>
                                <p class="text-xs text-slate-400 mt-1">
                                    <span id="group-detail-subtitle">請上傳名單並進行匹配</span>
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="reopenMappingModal()" id="btn-reopen-mapping" class="btn-warning font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all hidden"><i class="fas fa-wrench"></i> 重新匹配欄位</button>
                                <button onclick="downloadAllGroupsZip()" id="btn-batch-download-all-results-main" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all hidden"><i class="fas fa-file-archive"></i> 全系批次下載 (打包ZIP)</button>
                                <button onclick="openAllianceModal()" id="btn-alliance-config" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-sitemap"></i> 設定系所分組/聯盟</button>
                                <button onclick="openExportConfigModal()" id="btn-export-config" class="hidden bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2 transition"><i class="fas fa-file-excel"></i> 設定匯出樣式</button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            
                            <div id="results-display-area" class="flex-grow bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                                <div id="results-empty-state" class="p-8 text-center text-slate-400">
                                    <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl mx-auto"><i class="fas fa-table"></i></div>
                                    請上傳名單，並在彈出視窗中完成欄位匹配。
                                </div>
                                <div id="results-table-container" class="hidden flex-grow overflow-y-auto custom-scroll">
                                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center sticky top-0 z-30">
                                        <h4 class="text-sm font-bold text-slate-700">共 <span id="current-group-record-count">0</span> 筆紀錄</h4>
                                        <button onclick="downloadBatch(currentSelectedGroup)" class="btn-create py-1.5 px-4 rounded-lg text-xs font-bold shadow-sm"><i class="fas fa-file-excel mr-1"></i> 下載此分組名單</button>
                                    </div>
                                    <table class="w-full data-table">
                                        <thead class="sticky top-0 bg-white">
                                            <tr id="results-table-headers"></tr>
                                        </thead>
                                        <tbody id="results-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:col-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="bg-white border-t border-slate-200 py-3 px-6 text-center text-[10px] text-slate-400 flex-shrink-0 z-20">
            <p class="font-bold">Copyright © <span id="copyright-year">2025</span> 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p>
            <p class="mt-0.5 font-medium opacity-80">網頁製作：張博堯 | Assisted by Google Gemini</p>
        </footer>
    </div>

    <!-- Dept/College Editor Modal (Q1, Q2) -->
    <div id="dept-editor-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-university text-primary"></i> <span id="dept-editor-title">編輯學院/系所屬性</span></h3>
                <button onclick="document.getElementById('dept-editor-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex flex-grow overflow-hidden relative"> <!-- <-- 新增 relative -->
                <!-- Left Panel: General Info (Q1) -->
                <div class="w-80 bg-slate-50 border-r border-slate-200 flex-shrink-0 overflow-y-auto custom-scroll p-6 space-y-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">基本資訊</h4>
                    
                    <!-- 修正點 2: 學院/系所的主名稱/簡稱 (唯一保留的名稱欄位) -->
                    <!-- 對於學院，這是簡稱。對於系所，這是簡稱。 -->
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block" id="ed-dept-name-label">簡稱 (介面顯示) <span class="text-red-500">*</span></label><input type="text" id="ed-dept-name" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. 資管系"></div>
                    
                    <!-- 修正點 1/2: 移除原來的 short_name / 預設全稱 欄位 -->
                    <!-- 為了保留原始的 ID，我們將原來的 ed-dept-name 用於簡稱，並將ed-dept-shortname刪除 -->
                    
                    <!-- ID -->
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">ID <span class="text-red-500">*</span></label><input type="text" id="ed-dept-id" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono text-blue-600 focus:ring-primary outline-none" placeholder="e.g. cis_dept" oninput="validateDeptModalID()"></div>
                    <!-- Code -->
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">代碼 (Code)</label><input type="text" id="ed-dept-code" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. C0003"></div>
                    
                    <!-- 必須保留這個 hidden input，因為它被 saveDeptMasterFromModal 引用，用於儲存系所的 name (匯出全稱的 fallback) -->
                    <input type="hidden" id="ed-dept-shortname" value="">
                </div>
                <!-- Right Panel: Historical Names (New Table Structure for Q2) -->
                <div id="dept-year-name-panel" class="flex-grow overflow-hidden bg-white flex flex-col">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30 flex justify-between items-center flex-shrink-0 sticky top-0 z-10">
                        <h4 class="text-sm font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-history text-indigo-500"></i> 各學年度全稱設定 (歷史名稱)</h4>
                        <!-- 依據需求，移除「複製當前名稱至所有學年」按鈕 -->
                    </div>
                    <div class="flex-grow overflow-y-auto custom-scroll">
                        <table class="w-full data-table">
                            <thead class="sticky top-0 bg-white shadow-sm">
                                <tr>
                                    <th class="w-24 text-center">學年度</th>
                                    <th class="w-1/2 text-left">系所全稱</th>
                                    <th class="w-32 text-center">操作</th>
                                </tr>
                            </thead>
                            <tbody id="year-name-list">
                                <!-- Academic Year Name Table Rows Rendered Here -->
                            </tbody>
                        </table>
                        <div id="year-name-empty-state" class="p-8 text-center text-slate-400 hidden">請先建立學年度模組</div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('dept-editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="saveDeptMasterFromModal()" id="btn-save-dept-master" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition">確認保存</button>
            </div>
        </div>
    </div>


    <!-- 匹配彈窗 (Point 3: Increased width for horizontal two-column layout) -->
    <div id="mapping-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-primary/5 flex-shrink-0">
                <h3 class="text-lg font-bold text-primary flex items-center gap-2"><i class="fas fa-random text-primary"></i> 欄位匹配與匯出清單設定</h3>
                <button onclick="closeMappingModal(true)" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-white flex flex-col">
                <div class="mb-6 bg-white rounded-xl shadow-md border border-slate-200 p-6 flex-shrink-0">
                    <label class="block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="fas fa-calendar-alt text-primary"></i> 選擇學年度模組</label> 
                    <select id="consolidation-year-select" onchange="fetchCurrentTemplateFields(true)" class="w-full border border-slate-300 rounded-lg p-3 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl flex-shrink-0">
                    <h4 class="text-sm font-bold text-blue-700 flex items-center gap-2 mb-2"><i class="fas fa-info-circle"></i> 彙整欄位與匹配原則</h4>
                    <p class="text-xs text-blue-600 leading-relaxed">
                        系統將自動納入學年度模組中【系統】開課資訊與【系統】學生資訊兩分類下的所有欄位進行彙整。您只需在下方將**模組欄位**對應到上傳清單中的**正確 Excel 欄位**即可。
                        <span class="font-bold text-red-700">（注意：匹配設定為非必填，但若未匹配，該欄位資料將為空白。）</span>
                    </p>
                </div>

                <div class="flex gap-6 mt-6"> <!-- Point 3: Removed flex-grow overflow-hidden h-full to simplify container -->
                    <!-- NEW SINGLE PANEL STRUCTURE: Tighter UI -->
                    <div id="excel-mapping-panel" class="w-full p-4 bg-white border border-slate-200 rounded-xl shadow-lg flex flex-col overflow-hidden"> <!-- Point 3: Removed h-full -->
                        <div class="flex-shrink-0 mb-3 border-b border-slate-200 pb-2 flex items-center justify-between">
                            <span class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-map-marked-alt text-primary"></i> 欄位匹配設定區 (<span id="total-module-fields">0</span> 個系統欄位)</span>
                            <span class="text-xs text-slate-500 font-normal">已匹配 <span id="selected-mapping-count" class="font-bold text-primary">0</span> 個 Excel 欄位</span>
                        </div>
                        <!-- UI Redesign: Horizontal two-column grid (Point 3) -->
                        <div id="mapping-dropdown-container" class="mapping-container overflow-y-auto custom-scroll p-1 flex-grow">
                            <!-- Dropdowns render here -->
                        </div>
                        <div id="mapping-panel-empty-state" class="text-center text-slate-400 text-xs py-12 hidden flex-grow justify-center items-center">請先選定學年度模組</div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-primary/5 flex justify-end gap-3 flex-shrink-0">
                <button onclick="closeMappingModal(true)" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="processUploadedFile()" id="btn-process-list" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition flex items-center gap-2"><i class="fas fa-cogs"></i> 開始彙整名單</button>
            </div>
        </div>
    </div>

    <div id="msg-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4 transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm" id="msg-icon"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="msg-title"></h3><p class="text-sm text-slate-500 mb-6 leading-relaxed" id="msg-desc"></p>
            <div id="msg-input-area" class="hidden mb-6 text-left"><label class="block text-xs font-bold text-slate-400 uppercase mb-1" id="msg-input-label"></label><input type="text" id="msg-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none text-slate-700"><div id="msg-select-area" class="hidden mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">複製來源</label><select id="msg-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select></div></div>
            <div class="flex gap-3 justify-center" id="msg-btns"></div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> <span id="editor-title">編輯欄位屬性</span></h3>
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="flex flex-grow overflow-hidden">
                <div class="w-80 bg-slate-50 border-r border-slate-200 flex-shrink-0 overflow-y-auto custom-scroll p-6 space-y-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">基本設定</h4>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位 ID <span class="text-red-500">*</span></label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono text-blue-600 focus:ring-primary outline-none" placeholder="e.g. f_name"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">顯示名稱 <span class="text-red-500">*</span></label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. 學生姓名"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位說明 (Help Text)</label><textarea id="ed-desc" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none resize-none h-20" placeholder="例如: 請填寫學生所屬學院..."></textarea><p class="text-[10px] text-slate-400 mt-1">此說明僅顯示於填報介面提示，不會匯出至 Excel。</p></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">所屬分類</label><select id="ed-category" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none"></select></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位類型</label><select id="ed-type" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none" onchange="renderOpts()"></select></div>
                    <div class="pt-2 space-y-3">
                        <div>
                            <label class="flex items-center text-sm cursor-pointer mb-1"><input type="checkbox" id="ed-system" class="custom-checkbox mr-2" onchange="toggleSystemHint(this.checked)"> <span class="font-bold text-slate-700">系統自動帶入 (唯讀/匯入)</span></label>
                            <p id="sys-hint" class="text-[10px] text-amber-600 pl-6 leading-tight">此欄位對應匯入檔案，使用者無法編輯。建議勾選『必填』確保資料完整。</p>
                        </div>
                        <label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="ed-required" class="custom-checkbox mr-2"> <span class="font-bold text-slate-700">必填項目</span></label>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll bg-white">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-eye"></i> 欄位顯示控制 (Visibility)</h4><p class="text-[11px] text-slate-400 mt-1">控制此欄位在什麼情況下才顯示。</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="vis-toggle" class="sr-only peer" onchange="toggleVisSettings(this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600" id="vis-label">總是顯示</span></label>
                        </div>
                        <div id="vis-settings" class="hidden bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex items-center gap-2 text-xs text-slate-500 mb-2"><i class="fas fa-info-circle"></i> 當以下條件成立時，執行動作：</div>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">依賴對象 (決定者)</label><select id="ed-vis-dep" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"></select></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">當內容是 (條件值)</label><input id="ed-vis-val" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="輸入觸發值"></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">動作 (Action)</label><select id="ed-vis-action" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="show">顯示 (Show)</option><option value="hide">隱藏 (Hide)</option></select></div>
                            </div>
                        </div>
                    </div>
                  
                    <div id="ed-opts-container" class="p-8"></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="saveField()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition">確認暫存</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[80vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-project-diagram text-primary"></i> 邏輯總覽與衝突檢測</h3>
                <button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-slate-50">
                <div id="logic-conflicts" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="text-red-700 font-bold flex items-center gap-2 mb-2"><i class="fas fa-exclamation-triangle"></i> 發現邏輯問題</h4><ul id="conflict-list" class="list-disc list-inside text-sm text-red-600 space-y-2"></ul></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-eye text-indigo-500 mr-2"></i> 顯示條件 (Visibility)</span><span id="vis-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="vis-list" class="space-y-4"></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-list-ul text-emerald-500 mr-2"></i> 選項連動 (Option Logic)</span><span id="opt-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="opt-list" class="space-y-4"></div></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end"><button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm shadow">關閉視窗</button></div>
        </div>
    </div>

    <div id="addr-rules-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-map-marker-alt text-primary"></i> 地址正規化規則設定</h3>
                <button onclick="document.getElementById('addr-rules-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">保護名單 (Whitelist)</label>
                    <p class="text-xs text-slate-500 mb-2">下列詞彙中的中文數字不會被轉換 (例如：五權路)。請用逗號分隔。</p>
                    <textarea id="addr-protected" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">識別關鍵字 (Keywords)</label>
                    <p class="text-xs text-slate-500 mb-2">當中文數字出現在這些字之前，將強制轉為阿拉伯數字 (例如：五段 -> 5段)。</p>
                    <textarea id="addr-keywords" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">特定路名模式 (Specific Patterns)</label>
                    <p class="text-xs text-slate-500 mb-2">遇到這些詞（如：東南西北、區、道）開頭或接續的數字，將強制轉為阿拉伯數字。</p>
                    <textarea id="addr-specials" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAddrRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存規則</button>
            </div>
        </div>
    </div>

    <div id="choice-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-tools"></i></div><h3 class="text-lg font-bold text-slate-800 mb-2">請選擇修正方式</h3><p class="text-sm text-slate-500 mb-6">您想要修改目前的「規則設定」，還是補齊「源頭選項」？</p><div class="flex flex-col gap-3"><button id="btn-edit-self" class="w-full py-3 rounded-lg border border-indigo-200 text-indigo-700 font-bold hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i class="fas fa-sliders-h"></i> 修改規則設定</button><button id="btn-fix-source" class="w-full py-3 rounded-lg border border-emerald-200 text-emerald-700 font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> 補齊源頭選項 (自動修復)</button></div><button onclick="document.getElementById('choice-modal').classList.add('hidden')" class="mt-4 text-xs text-slate-400 hover:text-slate-600 underline">取消</button></div></div>
    <div id="impact-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="flex items-center gap-3 mb-4 text-amber-600"><i class="fas fa-exclamation-triangle text-2xl"></i><h3 class="text-lg font-bold text-slate-800">確認變更源頭結構</h3></div><p class="text-sm text-slate-600 mb-4 leading-relaxed">您即將在源頭欄位 <span id="imp-dep-name" class="font-bold text-primary"></span> 中新增選項 <span id="imp-val" class="font-bold text-emerald-600 bg-emerald-50 px-1 rounded"></span>。</p><div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-500 mb-6"><p class="font-bold mb-1">影響範圍評估：</p><p>此欄位目前被 <span id="imp-count" class="font-bold text-primary">0</span> 個規則引用。新增選項通常是安全的，但請確保這符合您的資料定義。</p></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('impact-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button id="btn-confirm-fix" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 text-sm">確認新增並修復</button></div></div></div>
    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="text-lg font-bold text-slate-800">從模板複製欄位</h3><button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button></div><div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200"><label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer"><input type="checkbox" id="picker-select-all" class="custom-checkbox mr-2" onchange="togglePickerAll(this)"> 全選 / 取消全選</label></div><div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div><div class="mt-4 pt-2 border-t border-slate-100 flex justify-end"><button onclick="addSelectedFields()" class="w-full btn-create font-bold py-2.5 rounded-lg shadow">確認複製選取欄位</button></div></div></div>
    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800">移動順序</h3><p class="text-sm text-slate-500 mt-1">將 <span id="move-target-name" class="font-bold text-primary"></span> 移動至：</p></div><div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-h-60 overflow-y-auto custom-scroll"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('move-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button onclick="saveMove()" class="px-4 py-2 btn-manage rounded-lg font-bold shadow-md text-sm">確認移動</button></div></div></div>
    <div id="batch-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-tasks text-indigo-600"></i> 欄位批次處理</h3>
                <button onclick="document.getElementById('batch-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-600">您已選取 <span id="batch-count" class="font-bold text-primary">0</span> 個欄位進行批次處理。</p>
                
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 mb-1 block">請選擇要執行的動作</label>
                    <select id="batch-action-select" onchange="toggleBatchActionSettings(this.value)" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none">
                        <option value="">請選擇...</option>
                        <option value="category">變更所屬分類</option>
                        <option value="delete">刪除選取項目</option>
                    </select>
                </div>
                
                <div id="batch-category-group" class="hidden space-y-3">
                    <label class="text-sm font-bold text-slate-700 block">新分類</label>
                    <select id="batch-category-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div id="batch-delete-confirm" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-700 font-bold flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> 確認刪除</p>
                    <p class="text-xs text-red-600 mt-1">此操作不可復原，請謹慎確認。</p>
                </div>
            </div>
            <div class="mt-6 pt-3 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="executeBatchAction()" id="btn-execute-batch" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-md hover:bg-indigo-700 text-sm flex items-center gap-2" disabled><i class="fas fa-check"></i> 確認執行</button>
            </div>
        </div>
    </div>
    <div id="alliance-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sitemap text-primary"></i> 系所分組/聯盟設定</h3>
                <button onclick="document.getElementById('alliance-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                
                <!-- ALLIANCE CONTROL PANEL -->
                <div class="p-4 bg-primary/5 border border-primary/20 rounded-xl space-y-4">
                    <p class="text-sm text-slate-600 font-bold mb-2 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> 聯盟邏輯設定</p>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">主要分組依據 (Primary Basis)</label>
                            <select id="alliance-grouping-basis" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                                <option value="course_dept">依開課學系 (course_dept)</option>
                                <option value="student_dept">依學生所屬學系 (student_dept)</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">聯盟判斷與預設分組的首要依據。</p>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-1">遺珠處理方式 (Unmatched Handling)</label>
                            <select id="alliance-unmatched-handling" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm">
                                <option value="use_primary">保留原始分組依據 (預設: course_dept 或 student_dept)</option>
                                <option value="use_secondary">使用次要系所分組 (如：學生所屬學系)</option>
                                <option value="use_alliance_only">僅聯盟內系所可結盟分組，其餘皆獨立分組</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">當兩方系所不完全在同一個聯盟時的最終分組策略。</p>
                        </div>
                    </div>
                </div>
                <!-- END ALLIANCE CONTROL PANEL -->

                <div id="alliance-rules-container" class="space-y-4">
                    <p class="text-sm text-slate-600 mt-4">在此定義多組聯盟。聯盟間的系所不應重複。</p>
                    </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAllianceRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存聯盟設定</button>
            </div>
        </div>
    </div>

    <div id="conflict-modal" class="fixed inset-0 z-[95] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl flex flex-col max-h-[85vh] overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-amber-50">
                <h3 class="text-lg font-bold text-amber-800 flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> 資料選項衝突檢測</h3>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll flex-grow">
                <p class="text-sm text-slate-600 mb-4">以下欄位的資料內容不在系統設定的選項清單中，請選擇處理方式：</p>
                <table class="w-full text-sm text-left border border-slate-200 rounded-lg overflow-hidden">
                    <thead class="bg-slate-100 text-slate-700 font-bold">
                        <tr>
                            <th class="p-3 border-b">欄位名稱</th>
                            <th class="p-3 border-b">衝突數值</th>
                            <th class="p-3 border-b">影響筆數</th>
                            <th class="p-3 border-b">處理方式</th>
                        </tr>
                    </thead>
                    <tbody id="conflict-list-body"></tbody>
                </table>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="cancelProcessing()" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg text-sm">取消彙整</button>
                <button onclick="resolveConflictsAndContinue()" class="px-6 py-2 bg-amber-600 text-white rounded-lg font-bold text-sm shadow hover:bg-amber-700">確認並繼續</button>
            </div>
        </div>
    </div>
    
    <div id="export-config-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 w-full max-w-4xl flex flex-col max-h-[85vh]">
                
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-teal-50 flex-shrink-0">
                    <h3 class="text-lg font-bold text-teal-800 flex items-center gap-2">
                        <i class="fas fa-sliders-h"></i> Excel 匯出欄位屬性設定
                    </h3>
                    <button onclick="document.getElementById('export-config-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-teal-100/50 transition">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="px-6 py-3 bg-slate-50 border-b border-slate-100 flex-shrink-0">
                    <p class="text-sm text-slate-600 flex items-center gap-2">
                        <i class="fas fa-info-circle text-teal-500"></i>
                        在此設定匯出 Excel 時的欄位表現。設定將儲存於學年度模組中。
                    </p>
                </div>

                <div class="flex-grow overflow-y-auto custom-scroll p-0 bg-white">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100 text-slate-700 font-bold sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 border-b w-16 text-center">序</th>
                                <th class="px-6 py-3 border-b">欄位名稱 (ID)</th>
                                <th class="px-6 py-3 border-b w-48">分類</th>
                                <th class="px-6 py-3 border-b w-40">預設欄寬</th>
                                <th class="px-6 py-3 border-b w-24 text-center">鎖定(唯讀)</th>
                            </tr>
                        </thead>
                        <tbody id="export-config-list" class="divide-y divide-slate-100">
                            </tbody>
                    </table>
                </div>

                <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 flex-shrink-0">
                    <button onclick="document.getElementById('export-config-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-200 rounded-lg text-sm transition">取消</button>
                    <button onclick="saveExportConfig()" class="px-6 py-2 bg-teal-600 text-white rounded-lg font-bold text-sm shadow hover:bg-teal-700 transition">儲存設定</button>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        let ghConfig = { user: '', repo: '', path: 'hedb/config.json', token: '' };
        let configData = { 
            globalFields: [], 
            academicYears: [], 
            templateCategories: [], 
            fieldTypes: [], 
            addressRules: { protected: [], keywords: [], specials: [] }, 
            // allianceModeDepts is now managed per year in year_templates/
            allianceModeDepts: {} // Global placeholder for easy access/initialization
        }; 
        let yearTemplateData = { fields: [] }; 
        let activeYearId = null, activeCatId = 'all', isEditMode = false, moveSrcIndex = -1, moveType = '', targetList = 'global', unsavedChanges = false, configSha = null, activeLogicEdit = null;
        let currentOptions = [], currentRules = [], currentOptionDescs = {};
        let editingOptionIdx = -1; let isOptionBatchMode = false;
        let activeBatchListType = '';

        // NEW: Department Management Data
        let departmentData = []; // Corresponds to data_departments.json (College grouping/ordering)
        let deptMasterData = {}; // Corresponds to data_dept_master.json (Dept details, names, codes, historical)
        let activeCollegeId = null;
        const DEPT_DATA_PATH = 'hedb/data_departments.json';
        const DEPT_MASTER_PATH = 'hedb/data_dept_master.json'; // New Master Dept file path
        let deptDataSha = null;
        let deptMasterSha = null;
        let editingDeptEntityType = null; 
        let currentEditingMaster = null; // NEW GLOBAL STATE FOR DEPT MODAL (Fix 4)


        // NEW: Internship Consolidation Data
        let currentConsolidationYear = null;
        let currentFileHeaders = [];
        let currentMapping = {}; 
        let currentStudentData = null; 
        let currentConsolidatedResults = null;
        let uniqueCourseDepts = []; 
        let currentTemplateFields = [];
        let currentSelectedGroup = null; 
        
        // R3: Define SYSTEM_FIELDS (Used for internal grouping/sorting keys and fallbacks)
        const SYSTEM_FIELDS = [
            { id: 'school_year', label: '學年', required: false, isSystem: true, order: 1, example: '114' },
            { id: 'semester', label: '學期', required: false, isSystem: true, order: 2, example: '1' },
            { id: 'student_id', label: '學號', required: true, isSystem: true, order: 3, example: '12345678' }, // Core ID
            { id: 'student_name', label: '姓名', required: false, isSystem: true, order: 4, example: '王小明' },
            { id: 'student_college', label: '學院', required: false, isSystem: true, order: 5, example: '管理學院' }, 
            { id: 'student_dept', label: '學生所屬學系', required: true, isSystem: true, order: 6, example: '資管系' }, // Core Logic
            { id: 'course_id', label: '選課代號', required: false, isSystem: true, order: 7, example: '8099' },
            { id: 'course_name', label: '課程名稱', required: false, isSystem: true, order: 8, example: '校外實習' }, 
            { id: 'internship_attr', label: '實習課程屬性', required: false, isSystem: true, order: 9, example: '必選' },
            { id: 'internship_credit', label: '實習學分數', required: false, isSystem: true, order: 10, example: '3' }, 
            { id: 'course_system', label: '開課學制', required: false, isSystem: true, order: 11, example: '日間部' }, 
            { id: 'course_college', label: '開課學院', required: false, isSystem: true, order: 12, example: '管理學院' }, 
            { id: 'course_dept', label: '開課學系', required: true, isSystem: true, order: 13, example: '國貿系' }, // Core Grouping
            { id: 'student_grade', label: '學生年級', required: false, isSystem: true, order: 14, example: '四年級' },
            { id: 'student_gender', label: '性別', required: false, isSystem: true, order: 15, example: '男' },
            { id: 'student_nationality', label: '實習生國籍', required: false, isSystem: true, order: 16, example: '中華民國' }
        ];

        // Define explicit MANDATORY LOGIC IDS (used for required mapping check)
        const MANDATORY_LOGIC_IDS = ['course_dept', 'student_dept', 'student_id'];

        // NEW: Define System Categories and their IDs for Filtering/Locking
        const SYSTEM_CATEGORY_DEFS = [
            { id: 'sys_course_info', name: '【系統】開課資訊', isLocked: true, order: -2 },
            { id: 'sys_student_info', name: '【系統】學生資訊', isLocked: true, order: -1 }
        ];
        // Only allow fields from these categories for matching
        const ALLOWED_MAPPING_CATEGORY_IDS = SYSTEM_CATEGORY_DEFS.map(c => c.id);

        // Fields used for the display table columns (UI/Aesthetics requirement)
        const OUTPUT_DISPLAY_FIELDS = [
            { id: 'semester', label: '學期' },
                { id: 'course_dept', label: '開課學系' }, // 注意：若模組用 offering_department，系統會自動 mapping
                { id: 'course_id', label: '選課代號' },   // 注意：若模組用 course_code，系統會自動 mapping
                { id: 'course_name', label: '課程名稱' },
                { id: 'internship_attr', label: '實習課程屬性' },
                { id: 'internship_credit', label: '實習學分數' },
                { id: 'student_dept', label: '學系' },
                { id: 'student_id', label: '學號' },
                { id: 'student_name', label: '姓名' },
                { id: 'student_grade', label: '學生年級' }
        ];
        
        // END NEW: Internship Consolidation Data

        // FIXED: Added 'college' and 'department' types
        const SYSTEM_DEFAULT_TYPES = [
            {key:'text', label:'文字'}, 
            {key:'number', label:'數字'}, 
            {key:'date', label:'日期'}, 
            {key:'single_select', label:'單選'}, 
            {key:'list', label:'條列式'},
            {key:'address', label:'地址'},
            {key:'college', label:'學院'}, // NEW Type
            {key:'department', label:'學系'} // NEW Type
        ];

        function init() {
            if(localStorage.getItem('gh_creds_v10')) localStorage.removeItem('gh_creds_v10');
            const saved = localStorage.getItem('gh_creds_safe');
            if(saved) { const c = JSON.parse(saved); document.getElementById('gh-user').value = c.user || ''; document.getElementById('gh-repo').value = c.repo || ''; }
            window.addEventListener('beforeunload', (e) => { if (unsavedChanges) { e.preventDefault(); e.returnValue = ''; } });
            document.getElementById('student-list-file').addEventListener('change', handleFileUpload);
            // [新增] 頁尾年份自動計算邏輯
            updateFooterYear();
        }
        
        function updateFooterYear() {
            const startYear = 2025;
            const currentYear = new Date().getFullYear();
            const yearSpan = document.getElementById('copyright-year');
            if (yearSpan) {
                yearSpan.innerText = currentYear > startYear ? `${startYear}-${currentYear}` : `${startYear}`;
            }
        }

        function setUnsaved(val) { unsavedChanges = val; document.getElementById('unsaved-badge').classList.toggle('hidden', !val); }
        
        // --- Utility to remove dynamically added inputs ---
        function cleanupDynamicInputs() {
            if (document.getElementById('msg-secondary-input')) {
                document.getElementById('msg-secondary-input').closest('div').remove();
            }
            if (document.getElementById('msg-tertiary-input')) {
                document.getElementById('msg-tertiary-input').closest('div').remove();
            }
            if (document.getElementById('msg-fourth-input')) {
                document.getElementById('msg-fourth-input').closest('div').remove();
            }
            // Remove the select box if present
            if (document.getElementById('msg-select-area')) {
                 document.getElementById('msg-select-area').classList.add('hidden');
            }
            // NEW: Remove custom temporary select area for historical name copy
            const tempSelectArea = document.getElementById('temp-select-area');
            if (tempSelectArea) {
                 tempSelectArea.remove();
                 // Restore default input area (just in case it was hidden)
                 document.getElementById('msg-input-area').classList.remove('hidden');
            }
        }
        // --- END Utility ---


        // --- FIXED/REINFORCED connectGitHub function (Critical for Q1) ---
        async function connectGitHub() {
            const btn = document.getElementById('btn-connect'), msg = document.getElementById('login-msg');
            const user = document.getElementById('gh-user').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();

            if (!user || !repo || !token) { 
                msg.style.opacity = '1'; 
                msg.innerText = '請填寫完整資訊 (Username, Repository, Token)'; 
                return; 
            }

            // ★★★ [修正重點] 強制清除舊的 Session Token ★★★
            // 這確保了 apiFetch 會使用 ghConfig 中的新 Token (當下輸入的) 進行驗證，
            // 而不是偷用上次登入成功的舊 Token。
            sessionStorage.removeItem('gh_token'); 
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            btn.innerHTML = '<div class="spinner"></div> 連線中...'; 
            btn.disabled = true;
            msg.style.opacity = '0'; // Hide previous error message
            
            ghConfig = { user, repo, path: 'hedb/config.json', token };

            try {
                // 1. Load Main Config (This also acts as a connectivity/auth check)
                const res = await apiFetch(ghConfig.path);

                if(res.status === 404) { 
                    configData = { 
                        globalFields: [], 
                        academicYears: [], 
                        templateCategories: [], 
                        fieldTypes: [], 
                        addressRules: { protected: [], keywords: [], specials: [] }, 
                        allianceModeDepts: {}
                    }; 
                    configSha = null; 
                } else if (res.status === 200) { 
                    configData = res.data; 
                    configSha = res.sha; 
                    
                    // Initialization logic for missing fields...
                    if(!configData.templateCategories) configData.templateCategories = []; 
                    if(!configData.fieldTypes) configData.fieldTypes = []; 
                    if(!configData.addressRules) configData.addressRules = { protected: ['五權', '三民', '三多', '一心', '二聖', '七賢', '八德', '九如', '十全'], keywords: ['段', '路', '街', '巷', '弄', '號', '樓', '鄰', '之'], specials: ['東', '南', '西', '北', '區', '道'] };
                    if(!configData.addressRules.specials) configData.addressRules.specials = ['東', '南', '西', '北', '區', '道'];
                    
                    configData.allianceModeDepts = {}; 

                    const uniqueTypes = new Map(); 
                    [...SYSTEM_DEFAULT_TYPES, ...configData.fieldTypes].forEach(t => uniqueTypes.set(t.key, t)); 
                    configData.fieldTypes = Array.from(uniqueTypes.values()); 
                } else {
                    throw new Error(`GitHub API 錯誤碼: ${res.status}`);
                }
                
                // Ensure system categories exist...
                SYSTEM_CATEGORY_DEFS.forEach(sysCat => {
                    const existingCat = configData.templateCategories.find(c => c.id === sysCat.id);
                    if (!existingCat) { configData.templateCategories.push(sysCat); } 
                    else { existingCat.name = sysCat.name; existingCat.isLocked = true; }
                });
                configData.templateCategories.forEach((c, i) => { if (c.order === undefined) c.order = i; });

                localStorage.setItem('gh_creds_safe', JSON.stringify({ user, repo })); 
                sessionStorage.setItem('gh_token', token);
                
                // 2. Fetch Dept Master Data
                try {
                    const deptMasterRes = await apiFetch(DEPT_MASTER_PATH);
                    deptMasterData = deptMasterRes.status === 200 ? deptMasterRes.data : {};
                    deptMasterSha = deptMasterRes.sha || null;
                } catch(e) {
                    console.error("Failed to load department master data:", e);
                    deptMasterData = {};
                    deptMasterSha = null;
                }
                
                // 3. Fetch Dept Grouping Data
                try {
                    const deptRes = await apiFetch(DEPT_DATA_PATH);
                    departmentData = deptRes.status === 200 ? (Array.isArray(deptRes.data) ? deptRes.data : []) : [];
                    departmentData = departmentData.map(c => ({
                        ...c,
                        id: c.id || ('col_' + Date.now() + Math.random()),
                        departments: Array.isArray(c.departments) ? c.departments : []
                    }));
                    deptDataSha = deptRes.sha || null;
                } catch(e) {
                    console.error("Failed to load department data:", e);
                    departmentData = [];
                    deptDataSha = null;
                }

                // UI Initialization
                document.getElementById('login-screen').classList.add('hidden'); 
                document.getElementById('admin-interface').classList.remove('hidden'); 
                document.getElementById('admin-interface').style.opacity = '1';
                
                await syncYearsFromFiles(); 
                renderYearList(); 
                if(configData.academicYears.length > 0) selectYear(configData.academicYears[0].year); 
                renderTemplateCats(); 
                renderTypeManagerPage(); 
                renderInternshipView(); 
                renderDepartmentView(); 
                
            } catch (err) { 
                console.error("Login Error:", err); 
                msg.style.opacity = '1'; 
                
                // 錯誤訊息處理
                if (err.message && err.message.includes('401')) {
                    msg.innerText = '登入失敗：Access Token 錯誤或權限不足';
                } else if (err.message && err.message.includes('404')) {
                    msg.innerText = '登入失敗：找不到 Repository 或 Config 檔案';
                } else if (err.message && err.message.includes('網路連線錯誤')) {
                     msg.innerText = `連線失敗：請檢查網路連線或 CORS 設定。`;
                } else {
                    msg.innerText = `連線失敗 (詳情請看 Console) - ${err.message || '未知錯誤'}`;
                }
                
            } finally { 
                btn.innerHTML = '<span>登入系統</span><i class="fas fa-arrow-right"></i>';
                btn.disabled = false; 
            }
        }
        // --- END FIXED/REINFORCED connectGitHub function ---


        async function syncYearsFromFiles() { try { const dirRes = await apiFetch('hedb/year_templates'); if(dirRes.status !== 200 || !Array.isArray(dirRes.data)) return; const fileYears = dirRes.data.filter(f => f.name.match(/^year_(.+)_templates\.json$/)).map(f => f.name.match(/^year_(.+)_templates\.json$/)[1]); let changed = false; fileYears.forEach(y => { if(!configData.academicYears.some(cy => cy.year === y)) { configData.academicYears.push({ year: y, isDefault: false }); changed = true; } }); if(changed) { configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); setUnsaved(true); showMsg('info', '同步完成', '系統已自動偵測到檔案庫中的學年度模組。'); } } catch(e) {} }
        function toggleToken() { const t = document.getElementById('gh-token'), i = document.getElementById('token-eye'); t.type = t.type === 'password' ? 'text' : 'password'; i.className = t.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash'; }
        function logout() { showMsg('confirm', '確定登出？', '未儲存的變更將會遺失。', null, () => { localStorage.removeItem('gh_creds_safe'); sessionStorage.removeItem('gh_token'); location.reload(); }); }

        function showMsg(type, title, desc, inputConfig = null, onConfirm = null) {
            const modal = document.getElementById('msg-modal'), icon = document.getElementById('msg-icon'), btns = document.getElementById('msg-btns'), inputArea = document.getElementById('msg-input-area');
            const descEl = document.getElementById('msg-desc');
            
            // --- FIX 3: Cleanup previous dynamic inputs (Crucial for copyYearNamePrompt) ---
            cleanupDynamicInputs();
            // --- END FIX 3 ---
            
            document.getElementById('msg-title').innerText = title; 
            
            // 修正點 8: 判斷 desc 是否為包含 HTML 的字串 (這裡我們假設如果字串開頭是 <，就是 HTML)
            if (desc.trim().startsWith('<') || desc.includes('<strong>') || desc.includes('<b>')) {
                 descEl.innerHTML = desc; // 渲染 HTML
            } else {
                 descEl.innerText = desc; // 渲染純文字
            }

            inputArea.classList.add('hidden'); document.getElementById('msg-select-area').classList.add('hidden');
            let iconClass = '', iconHtml = '';
            if(type === 'success') { iconClass = 'bg-emerald-100 text-emerald-600'; iconHtml = '<i class="fas fa-check"></i>'; }
            else if(type === 'error') { iconClass = 'bg-red-100 text-red-600'; iconHtml = '<i class="fas fa-times"></i>'; }
            else if(type === 'info') { iconClass = 'bg-blue-100 text-blue-600'; iconHtml = '<i class="fas fa-info"></i>'; }
            else if(type === 'confirm' || type === 'prompt') { iconClass = 'bg-amber-100 text-amber-600'; iconHtml = '<i class="fas fa-question"></i>'; }
            icon.className = `w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm ${iconClass}`; icon.innerHTML = iconHtml;
            
            if(type === 'prompt' && inputConfig) { 
                inputArea.classList.remove('hidden'); 
                document.getElementById('msg-input-label').innerText = inputConfig.label || '名稱'; 
                const inp = document.getElementById('msg-input'); inp.value = inputConfig.value || ''; 
                
                // Handle secondary input for ID
                if(inputConfig.secondaryLabel) {
                    const secondaryInputHtml = `<div class="mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">${inputConfig.secondaryLabel}</label><input type="text" id="msg-secondary-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none text-slate-700" value="${inputConfig.secondaryValue || ''}"></div>`;
                    // Check if element already exists before adding
                    if (!document.getElementById('msg-secondary-input')) {
                        inp.parentElement.insertAdjacentHTML('afterend', secondaryInputHtml);
                    } else {
                        document.getElementById('msg-secondary-input').value = inputConfig.secondaryValue || '';
                        document.getElementById('msg-secondary-input').previousElementSibling.innerText = inputConfig.secondaryLabel;
                    }
                }

                // Handle tertiary input for Short Name/Code (used by Department functions)
                if(inputConfig.tertiaryLabel) {
                    const tertiaryInputHtml = `<div class="mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">${inputConfig.tertiaryLabel}</label><input type="text" id="msg-tertiary-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none text-slate-700" value="${inputConfig.tertiaryValue || ''}"></div>`;
                    
                    const referenceEl = document.getElementById('msg-secondary-input') || inp;
                    referenceEl.closest('div').insertAdjacentHTML('afterend', tertiaryInputHtml);
                }

                // Handle fourth input for Code (used by Department functions)
                if(inputConfig.fourthLabel) {
                    const fourthInputHtml = `<div class="mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">${inputConfig.fourthLabel}</label><input type="text" id="msg-fourth-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none text-slate-700" value="${inputConfig.fourthValue || ''}"></div>`;
                    
                    const referenceEl = document.getElementById('msg-tertiary-input') || document.getElementById('msg-secondary-input') || inp;
                    referenceEl.closest('div').insertAdjacentHTML('afterend', fourthInputHtml);
                }


                if(inputConfig.showSelect) { 
                    document.getElementById('msg-select-area').classList.remove('hidden'); 
                    const sel = document.getElementById('msg-select'); sel.innerHTML = '<option value="">不複製 (空白)</option>'; 
                    configData.academicYears.forEach(y => sel.innerHTML += `<option value="${y.year}">複製 ${y.year}</option>`); 
                } 
                setTimeout(() => inp.focus(), 50); 
            }
            
            btns.innerHTML = '';
            const cancelBtn = document.createElement('button'); cancelBtn.className = 'px-5 py-2.5 rounded-lg border border-slate-300 font-bold text-slate-600 hover:bg-slate-50 transition text-sm'; cancelBtn.innerText = type === 'success' || type === 'info' ? '關閉' : '取消'; cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); }; btns.appendChild(cancelBtn);
            if(type === 'confirm' || type === 'prompt') { const okBtn = document.createElement('button'); okBtn.className = `px-5 py-2.5 rounded-lg font-bold text-white shadow-md transition text-sm ${type==='prompt' ? 'bg-primary' : 'bg-danger'}`; okBtn.innerText = '確認'; okBtn.onclick = async () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); if(onConfirm) { 
                const primaryValue = document.getElementById('msg-input').value.trim();
                const secondaryValue = document.getElementById('msg-secondary-input')?.value.trim();
                const tertiaryValue = document.getElementById('msg-tertiary-input')?.value.trim();
                const fourthValue = document.getElementById('msg-fourth-input')?.value.trim();
                const selectValue = document.getElementById('msg-select')?.value;
                if(type === 'prompt') await onConfirm(primaryValue, secondaryValue, tertiaryValue, fourthValue, selectValue); 
                else await onConfirm(); 
            } }; btns.appendChild(okBtn); }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.add('opacity-100'); document.getElementById('msg-panel').classList.remove('scale-95'); document.getElementById('msg-panel').classList.add('scale-100'); }, 10);
        }

        // --- Utility function for Batch Controls visibility ---
        function updateBatchControlVisibility(type) {
            const checkboxClass = type === 'global' ? '.global-check' : '.year-check';
            const controlContainer = document.getElementById(type + '-batch-controls');
            const countSpan = document.getElementById(type + '-batch-count');
            const checkedCount = document.querySelectorAll(checkboxClass + ':checked').length;

            if (checkedCount > 0) {
                controlContainer.classList.remove('hidden');
                if (countSpan) countSpan.innerText = checkedCount;
            } else {
                controlContainer.classList.add('hidden');
            }
        }

        // --- Core Functions ---
        function renderYearList() { const el = document.getElementById('year-list'); el.innerHTML = ''; configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); configData.academicYears.forEach(y => { const div = document.createElement('div'); div.className = `list-item ${activeYearId===y.year?'active':''}`; div.onclick = () => selectYear(y.year); div.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold text-sm">${y.year} 學年度</span>${y.isDefault?'<span class="text-[10px] bg-secondary text-white px-1.5 py-0.5 rounded font-bold ml-2">Def</span>':''}</div>`; el.appendChild(div); }); }
        function openYearModal() { showMsg('prompt', '新增學年度', '請輸入學年度並選擇是否複製模板', {label: '學年度 (如: 114)', showSelect: true}, async (year, secondary, copyFrom) => { if(!year || configData.academicYears.some(y => y.year === year)) return showMsg('error','錯誤','學年度已存在'); try { let initialData = { fields: [] }; if (copyFrom) { const res = await apiFetch(`hedb/year_templates/year_${copyFrom}_templates.json`); if (res.status === 200) initialData = res.data; } const path = `hedb/year_templates/year_${year}_templates.json`; const check = await apiFetch(path); await uploadFile(path, initialData, check.status===200?check.sha:null); configData.academicYears.push({ year, isDefault: false }); await saveConfig(); setUnsaved(false); renderYearList(); selectYear(year); showMsg('success', '成功', '學年度模組已建立'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        function renameCurrentYear() { if(!activeYearId) return; showMsg('prompt', '重新命名學年度', '請輸入新名稱，這將會搬移設定檔。', {label: '新名稱', value: activeYearId}, async (newYear) => { if(!newYear || newYear === activeYearId || configData.academicYears.some(y=>y.year===newYear)) return; try { const oldPath = `hedb/year_templates/year_${activeYearId}_templates.json`; const newPath = `hedb/year_templates/year_${newYear}_templates.json`; const res = await apiFetch(oldPath); const checkNew = await apiFetch(newPath); await uploadFile(newPath, res.status===200?res.data:{fields:[]}, checkNew.status===200?checkNew.sha:null); if(res.status===200) await deleteFile(oldPath, res.sha); const y = configData.academicYears.find(y=>y.year===activeYearId); y.year = newYear; await saveConfig(); activeYearId = newYear; renderYearList(); selectYear(newYear); showMsg('success','成功','學年度已重新命名'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        async function selectYear(year) { 
            activeYearId = year; 
            renderYearList(); 
            // Q2: Keep title update logic for the main YEAR config view
            document.getElementById('current-year-title').innerText = `${year} 學年度`; 
            
            const yConf = configData.academicYears.find(y => y.year === year); document.getElementById('is-default-year').checked = yConf.isDefault || false; document.getElementById('default-badge').classList.toggle('hidden', !yConf.isDefault); document.getElementById('year-empty-state').classList.add('hidden'); document.getElementById('year-config-panel').classList.remove('hidden'); document.getElementById('year-config-panel').classList.add('flex'); updateYearFilterOptions(); document.getElementById('year-filter-cat').value = 'all'; document.getElementById('year-field-list').innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>讀取設定中...</td></tr>`; try { const res = await apiFetch(`hedb/year_templates/year_${year}_templates.json`); yearTemplateData = res.status===404?{fields:[]}:res.data; // Alliance data is now within yearTemplateData
            if (!yearTemplateData.allianceModeDepts) { yearTemplateData.allianceModeDepts = { groups: [], groupingBasis: 'course_dept', unmatchedHandling: 'use_primary' }; setUnsaved(true); } 
            
            renderYearFields(); } catch(e) { document.getElementById('year-field-list').innerHTML = `<tr><td colspan="7" class="p-4 text-red-500 text-center">讀取失敗: ${e.message}</td></tr>`; } }
        function updateYearFilterOptions() { const sel = document.getElementById('year-filter-cat'), val = sel.value; sel.innerHTML = '<option value="all">所有分類</option>'; configData.templateCategories.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`); sel.innerHTML += '<option value="uncategorized">未分類</option>'; sel.value = val; }
        function deleteCurrentYear() { showMsg('confirm', '確認刪除學年度？', `這將會刪除 ${activeYearId} 學年度，無法復原。`, null, async () => { try { const path = `hedb/year_templates/year_${activeYearId}_templates.json`; const check = await apiFetch(path); if(check.status===200) await deleteFile(path, check.sha); configData.academicYears = configData.academicYears.filter(y => y.year !== activeYearId); await saveConfig(); activeYearId = null; setUnsaved(false); document.getElementById('year-config-panel').classList.add('hidden'); document.getElementById('year-empty-state').classList.remove('hidden'); renderYearList(); showMsg('success','成功','學年度已刪除'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        
        function renderYearFields() { 
            const listEl = document.getElementById('year-field-list'), filter = document.getElementById('year-filter-cat')?.value || 'all'; 
            listEl.innerHTML = ''; 
            yearTemplateData.fields.forEach((f, idx) => { 
                if(filter !== 'all' && ((filter==='uncategorized'&&f.category) || (filter!=='uncategorized'&&f.category!==filter))) return; 
                const catName = configData.templateCategories.find(c => c.id === f.category)?.name || '未分類'; 
                const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; 
                
                let attributes = [];
                if (f.required) attributes.push('<span class="text-red-500 bg-red-50 px-1 rounded text-[10px] font-bold">必填</span>');
                // The `f.isSystem` flag is inherited from globalFields or explicitly set in the module.
                if (f.isSystem || SYSTEM_FIELDS.some(sf => sf.id === f.id && sf.isSystem)) attributes.push('<span class="text-blue-500 bg-blue-50 px-1 rounded text-[10px] font-bold">系統</span>');

                // Check if this field is one of the MANDATORY_LOGIC_IDS
                if (MANDATORY_LOGIC_IDS.includes(f.id)) {
                    attributes.push('<span class="text-indigo-500 bg-indigo-50/10 px-1 rounded text-[10px] font-bold">核心邏輯</span>');
                }

                const attributeText = attributes.join(' ');
                
                const isFiltered = filter !== 'all';
                // Point 4: Adjusted move button padding and added gap
                const btns = !isFiltered 
                    ? `<button onclick="moveField(${idx},-1,'year')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${idx},1,'year')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="openMoveModal(${idx},'year')" class="p-1 hover:bg-indigo-100 rounded text-slate-400 text-primary mr-1" title="移動至..."><i class="fas fa-exchange-alt"></i></button>` 
                    : '';
                
                const actionBtns = `<button onclick="editField('${f.id}','year')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="編輯"><i class="fas fa-pen"></i></button><button onclick="removeYearField(${idx})" class="p-1 hover:bg-red-100 rounded text-slate-400 text-danger" title="刪除"><i class="fas fa-trash-alt"></i></button>`; 
                
                listEl.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="w-12 text-center py-3"><input type="checkbox" onchange="updateBatchControlVisibility('year')" class="year-check custom-checkbox" value="${idx}"></td>
                    <td class="w-16 text-center font-mono text-xs text-slate-400 py-3">${idx+1}</td>
                    <td class="w-1/4 text-left font-bold text-slate-700 text-sm py-3">
                        <div class="flex flex-col items-start justify-center h-full gap-0.5">
                            <div class="flex items-center gap-2"><span>${f.label}</span>${f.description ? `<i class="fas fa-info-circle text-slate-300 hover:text-primary" title="${f.description}"></i>` : ''}</div>
                            <span class="text-[10px] text-slate-400 font-mono block">${f.id}</span>
                        </div>
                    </td>
                    <td class="w-24 text-center text-xs text-slate-500 py-3">${catName}</td>
                    <td class="w-24 text-center text-xs text-slate-500 py-3">${typeName}</td>
                    <td class="w-24 text-center text-xs text-slate-400 py-3">${attributeText}</td>
                    <td class="w-40 text-center py-3">
                        <div class="action-cell-content">
                            ${btns}${actionBtns}
                        </div>
                    </td>
                </tr>`; 
            }); 
            if(listEl.innerHTML==='') listEl.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">尚未加入欄位</td></tr>'; 
            const emptyRow = document.querySelector('#year-field-list tr td[colspan]');
            if (emptyRow) emptyRow.setAttribute('colspan', '7');
            updateBatchControlVisibility('year'); 
        }
        function removeYearField(idx) { showMsg('confirm', '移除欄位？', '確定要從此學年度移除此欄位？', null, () => { yearTemplateData.fields.splice(idx, 1); renderYearFields(); setUnsaved(true); showMsg('success', '成功', '欄位已移除'); }); }
        function toggleYearAll(el) { document.querySelectorAll('.year-check').forEach(c => c.checked = el.checked); }
        function deleteSelectedYearFields() { const chk = Array.from(document.querySelectorAll('.year-check:checked')).map(c=>parseInt(c.value)); if(chk.length) showMsg('confirm', '批次刪除', `確定移除選取的 ${chk.length} 個欄位？`, null, () => { chk.sort((a,b)=>b-a).forEach(i => yearTemplateData.fields.splice(i,1)); renderYearFields(); setUnsaved(true); showMsg('success', '成功', '已移除選取項目'); }); }
        function toggleDefaultYear() { const chk = document.getElementById('is-default-year').checked; configData.academicYears.forEach(y => y.isDefault = false); const curr = configData.academicYears.find(y => y.year === activeYearId); if(curr) curr.isDefault = chk; document.getElementById('default-badge').classList.toggle('hidden', !chk); setUnsaved(true); showMsg('success', '成功', '預設學年度已更新'); }

        function moveCategory(id, dir) {
            const list = configData.templateCategories;
            const idx = list.findIndex(c => c.id === id);
            if (idx === -1 || idx + dir < 0 || idx + dir >= list.length) return;
            
            [list[idx], list[idx + dir]] = [list[idx + dir], list[idx]];
            
            list.forEach((c, i) => c.order = i);
            
            renderTemplateCats();
            setUnsaved(true);
        }

        function renderTemplateCats() { 
            const el = document.getElementById('template-cat-list'); 
            configData.templateCategories.sort((a,b) => a.order - b.order);
            
            el.innerHTML = `<div class="list-item ${activeCatId==='all'?'active':''}" onclick="selectCat('all')"><span class="font-bold text-sm">全部欄位</span></div>`; 
            
            configData.templateCategories.forEach(c => {
                const isActive = activeCatId===c.id;
                const isLocked = SYSTEM_CATEGORY_DEFS.some(def => def.id === c.id && def.isLocked);
                
                // Only allow movement for non-locked categories
                const lockIcon = isLocked ? `<i class="fas fa-lock text-red-400 p-1.5" title="核心分類，無法刪除/更名"></i>` : '';
                const upBtn = isLocked ? '' : `<button onclick="moveCategory('${c.id}', -1); event.stopPropagation();" class="text-slate-400 hover:text-primary p-1.5 rounded-lg transition" title="上移"><i class="fas fa-arrow-up text-xs"></i></button>`;
                const downBtn = isLocked ? '' : `<button onclick="moveCategory('${c.id}', 1); event.stopPropagation();" class="text-slate-400 hover:text-primary p-1.5 rounded-lg transition" title="下移"><i class="fas fa-arrow-down text-xs"></i></button>`;

                // FIX 1: Lock icon moved to right and aligned with move buttons
                const actionsHtml = `<div class="flex-shrink-0 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition duration-150 ${isActive ? '!opacity-100' : ''}">${upBtn}${downBtn}${lockIcon}</div>`;

                el.innerHTML += `
                    <div class="list-item group ${isActive?'active':''}" onclick="selectCat('${c.id}')" data-id="${c.id}">
                        <div class="flex items-center justify-between w-full">
                            <span class="font-bold text-sm flex-grow truncate">${c.name}</span>
                            ${actionsHtml}
                        </div>
                    </div>
                `;
            }); 
            
            el.innerHTML += `<div class="list-item ${activeCatId==='uncategorized'?'active':''}" onclick="selectCat('uncategorized')"><span class="text-sm">未分類</span></div>`; 
            
            updateYearFilterOptions(); 
        }
        
        function openCategoryModal() { showMsg('prompt', '新增模板分類', '請輸入分類名稱', {label: '名稱'}, (v)=>{if(v){configData.templateCategories.push({id:'cat_'+Date.now(),name:v, order: configData.templateCategories.length});renderTemplateCats();setUnsaved(true); showMsg('success', '成功', '分類已建立'); }}); }
        function renameCurrentCat() { 
            const c = configData.templateCategories.find(x => x.id === activeCatId); 
            if(!c) return; 
            if (SYSTEM_CATEGORY_DEFS.some(def => def.id === c.id && def.isLocked)) {
                 return showMsg('error', '鎖定錯誤', '此為系統核心分類，無法重新命名。');
            }

            showMsg('prompt', '重新命名分類', '請輸入新的分類名稱。', {label: '名稱', value: c.name}, (v) => {
                if (v && v !== c.name) {
                    const existingCat = configData.templateCategories.find(x => x.id === activeCatId);
                    if (existingCat) {
                        existingCat.name = v;
                        renderTemplateCats(); 
                        setUnsaved(true);
                        document.getElementById('current-cat-title').innerText = v; 
                        showMsg('success', '成功', '分類已重新命名'); 
                    }
                }
            }); 
        }
        function deleteCurrentCat() { 
            const c = configData.templateCategories.find(x => x.id === activeCatId);
            if (SYSTEM_CATEGORY_DEFS.some(def => def.id === c.id && def.isLocked)) {
                 return showMsg('error', '鎖定錯誤', '此為系統核心分類，無法刪除。');
            }
            showMsg('confirm', '刪除分類？', '分類下的欄位將變為「未分類」。', null,()=>{configData.templateCategories=configData.templateCategories.filter(c=>c.id!==activeCatId); configData.globalFields.forEach(f=>{if(f.category===activeCatId)delete f.category}); selectCat('all'); setUnsaved(true); showMsg('success', '成功', '分類已刪除'); }); 
        }
        function selectCat(id) { activeCatId=id; renderTemplateCats(); document.getElementById('current-cat-title').innerText=id==='all'?'全部欄位':id==='uncategorized'?'未分類':configData.templateCategories.find(c=>c.id===id)?.name || '錯誤分類'; 
        
            const isLocked = configData.templateCategories.find(c => c.id === id)?.isLocked;
            // Only hide actions if it's 'all', 'uncategorized', or a system locked category
            document.getElementById('cat-actions').classList.toggle('hidden', id==='all'||id==='uncategorized' || isLocked);
            renderGlobalList(); 
        }
        
        function renderGlobalList() { 
            const el = document.getElementById('global-field-list'); 
            let list = configData.globalFields; 
            
            if(activeCatId==='uncategorized') list=list.filter(f=>!f.category); 
            else if(activeCatId!=='all') list=list.filter(f=>f.category===activeCatId); 
            
            list.sort((a,b)=>a.order-b.order); 
            
            el.innerHTML = list.map((f,i)=> { 
                const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; 
                
                const isFiltered = activeCatId !== 'all'; 
                // Point 4: Adjusted move button padding and added gap
                const btns = !isFiltered 
                    ? `<button onclick="moveField(${i},-1,'global')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${i},1,'global')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="openMoveModal(${i},'global')" class="p-1 hover:bg-indigo-100 rounded text-slate-400 text-primary mr-1" title="移動至..."><i class="fas fa-exchange-alt"></i></button>` 
                    : ''; 
                
                const actionBtns = `<button onclick="editField('${f.id}','global')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="編輯"><i class="fas fa-pen"></i></button><button onclick="delGlobalField('${f.id}')" class="p-1 hover:bg-red-100 rounded text-slate-400 text-danger" title="刪除"><i class="fas fa-trash-alt"></i></button>`;
                
                let attributes = [];
                if (f.required) attributes.push('<span class="text-red-500 bg-red-50 px-1 rounded text-[10px] font-bold">必填</span>');
                if (f.isSystem) attributes.push('<span class="text-blue-500 bg-blue-50 px-1 rounded text-[10px] font-bold">系統</span>');
                const attributeText = attributes.join(' ');

                return `<tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="w-12 text-center py-3"><input type="checkbox" onchange="updateBatchControlVisibility('global')" class="global-check custom-checkbox" value="${f.id}"></td>
                    <td class="w-16 text-center font-mono text-xs text-slate-400 py-3">${i+1}</td>
                    <td class="w-1/4 text-left font-bold text-slate-700 text-sm py-3">
                        <div class="flex flex-col items-start justify-center h-full gap-0.5">
                            <div class="flex items-center gap-2"><span>${f.label}</span>${f.description ? `<i class="fas fa-info-circle text-slate-300 hover:text-primary" title="${f.description}"></i>` : ''}</div>
                            <span class="text-[10px] text-slate-400 font-mono block">${f.id}</span>
                        </div>
                    </td>
                    <td class="w-24 text-center text-xs text-primary font-mono py-3">${typeName}</td>
                    <td class="w-48 text-center text-xs text-slate-400 py-3">${attributeText}</td>
                    <td class="w-40 text-center py-3">
                        <div class="action-cell-content">
                            ${btns}${actionBtns}
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
            updateBatchControlVisibility('global'); 
        }
        function addNewGlobalField() { isEditMode=false;targetList='global';prepEditor(); }
        function editField(id, type) { isEditMode=true;targetList=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; prepEditor(list.find(f=>f.id===id)); }
        function delGlobalField(id) { showMsg('confirm', '刪除模板？', '確定刪除此模板？', null,()=>{configData.globalFields=configData.globalFields.filter(f=>f.id!==id);renderGlobalList();setUnsaved(true); showMsg('success', '成功', '模板已刪除'); }); }
        
        function moveField(idx,dir,type) { const list=type==='global'?configData.globalFields:yearTemplateData.fields; if(list[idx+dir]){[list[idx],list[idx+dir]]=[list[idx+dir],list[idx]]; if(type==='global')list.forEach((f,i)=>f.order=i); type==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); /* Silent Sort */ } }
        function openMoveModal(idx,type) { moveSrcIndex=idx;moveType=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; const sel=document.getElementById('move-select'); sel.innerHTML=''; list.forEach((f,i)=>sel.innerHTML+=`<option value="${i}" ${i===idx?'selected':''}>${i+1}. ${f.label}</option>`); document.getElementById('move-target-name').innerText=list[idx].label; document.getElementById('move-modal').classList.remove('hidden'); }
        function saveMove() { const t=parseInt(document.getElementById('move-select').value); if(t!==moveSrcIndex){ const list=moveType==='global'?configData.globalFields:yearTemplateData.fields; list.splice(t,0,list.splice(moveSrcIndex,1)[0]); if(moveType==='global')list.forEach((f,i)=>f.order=i); moveType==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); /* Silent Sort */ } document.getElementById('move-modal').classList.add('hidden'); }

        // --- Department Management Logic (New) ---
        
        // Helper to get Dept Full Name for a given year 
        function getDeptFullName(deptId, year) {
            const master = deptMasterData[deptId];
            if (!master) return deptId;
            const historicalName = master.historical_names?.[year];
            if (historicalName) return historicalName;
            return master.name || deptId;
        }

        // Helper to get Dept Display Name (Short or Full) (Q3)
        function getDeptDisplayName(deptId, useShort = true, specificYear = null) {
            const master = deptMasterData[deptId];
            if (!master) return deptId;

            // Use Short Name for Display (Q3: 預覽時使用簡稱)
            if (useShort && master.short_name) return master.short_name;
            
            // Use Full Name based on consolidation year or active year
            const targetYear = specificYear || currentConsolidationYear || activeYearId || (configData.academicYears.find(y => y.isDefault)?.year);
            return getDeptFullName(deptId, targetYear);
        }
        
        // Helper to get College Display Name (Short or Full) (Q3)
        function getCollegeDisplayName(colId, useShort = true) {
            const college = departmentData.find(c => c.id === colId);
            if (!college) return colId;
            // For simplicity, we assume College name changes less often, defaulting to current full name for export
            if (useShort && college.short_name) return college.short_name;
            return college.name || colId;
        }
        
        function renderDepartmentView() {
            if (departmentData.length > 0 && !activeCollegeId) {
                activeCollegeId = departmentData[0].id;
            }
            renderCollegeList();
            if (activeCollegeId) {
                selectCollege(activeCollegeId);
            } else {
                document.getElementById('dept-config-panel').classList.add('hidden');
                document.getElementById('dept-empty-state').classList.remove('hidden');
            }
        }
        
        // Q3: Implemented blue-on-blue code display and new layout
        function renderCollegeList() {
            const el = document.getElementById('college-list');
            el.innerHTML = '';
            departmentData.forEach((c, idx) => {
                const isActive = activeCollegeId === c.id;
                const div = document.createElement('div');
                div.className = `list-item group ${isActive ? 'active' : ''}`; 
                div.onclick = () => selectCollege(c.id);
                
                const displayName = getCollegeDisplayName(c.id, true);
                const collegeCode = c.code || '-';
                
                // [修改] 移除 "ID:" 字樣，只保留 ID 本身
                const idDisplay = c.id; 

                const codeBadge = `<span class="bg-primary/10 text-primary px-1.5 py-0.5 rounded-full text-[10px] font-bold tracking-wider flex-shrink-0">${collegeCode}</span>`;
                
                const moveControls = `<div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition duration-150 ${isActive ? '!opacity-100' : ''} flex-shrink-0 ml-2">
                        <button onclick="moveCollege(${idx},-1); event.stopPropagation();" class="text-slate-400 hover:text-primary p-1.5 rounded-lg transition" title="上移"><i class="fas fa-arrow-up text-xs"></i></button>
                        <button onclick="moveCollege(${idx},1); event.stopPropagation();" class="text-slate-400 hover:text-primary p-1.5 rounded-lg transition" title="下移"><i class="fas fa-arrow-down text-xs"></i></button>
                    </div>`;

                // [修改] 優化排版結構以支援長字串截斷
                // 1. 父容器加入 min-w-0 flex-1: 讓文字區塊能正確縮小
                // 2. ID span 加入 truncate: 超出範圍顯示 ...
                // 3. ID span 加入 title: 滑鼠懸停顯示完整 ID
                div.innerHTML = `<div class="flex items-center justify-between w-full overflow-hidden">
                                    <div class="flex items-center gap-2 min-w-0 flex-1">
                                        ${codeBadge}
                                        <div class="flex flex-col items-start min-w-0 flex-1">
                                            <span class="font-bold text-sm truncate w-full" title="${displayName}">${displayName}</span>
                                            <span class="text-[10px] text-slate-400 font-mono block truncate w-full" title="${idDisplay}">${idDisplay}</span>
                                        </div>
                                    </div>
                                    ${moveControls}
                                </div>`;
                el.appendChild(div);
            });
        }
        
        function selectCollege(id) {
            activeCollegeId = id;
            renderCollegeList();
            const college = departmentData.find(c => c.id === id);
            if (college) {
                document.getElementById('current-college-title').innerText = getCollegeDisplayName(college.id, false);
                document.getElementById('dept-empty-state').classList.add('hidden');
                document.getElementById('dept-config-panel').classList.remove('hidden');
                document.getElementById('dept-config-panel').classList.add('flex');
                renderDepartmentList();
            }
        }
        
        function renderDepartmentList() {
            const listEl = document.getElementById('department-list-body');
            listEl.innerHTML = '';
            const college = departmentData.find(c => c.id === activeCollegeId);
            if (!college || !college.departments) return;

            // departments array now stores only department IDs
            college.departments.forEach((deptId, idx) => {
                const master = deptMasterData[deptId] || {};
                
                // Get the current view's full name based on the active year ID
                const deptFullName = getDeptDisplayName(deptId, false, activeYearId); 
                // Get the short display name
                const deptDisplayName = getDeptDisplayName(deptId, true); 
                
                const deptCode = master.code || '-';

                // Point 4 (and 1) fix: Reduced button padding from p-1.5 to p-1
                const actionBtns = `<button onclick="openDeptModal('${deptId}')" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="編輯"><i class="fas fa-pen"></i></button><button onclick="removeDepartment('${deptId}')" class="p-1 hover:bg-red-100 rounded text-slate-400 text-danger" title="移除分組"><i class="fas fa-trash-alt"></i></button>`;
                const moveBtns = `<button onclick="moveDepartment('${deptId}', -1)" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveDepartment('${deptId}', 1)" class="p-1 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button>`;

                listEl.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100 transition group"> <!-- Added group class -->
                    <td class="w-16 text-center font-mono text-xs text-slate-400 py-3">${idx+1}</td>
                    <td class="w-1/2 text-left font-bold text-slate-700 text-sm py-3">
                        <div class="flex flex-col items-start justify-center h-full gap-0.5">
                            <!-- FIX 1.1: 移除全稱顯示 -->
                            <span>${deptDisplayName}</span>
                            <span class="text-[10px] text-slate-400 font-mono block">${deptId} / CODE: ${deptCode}</span>
                        </div>
                    </td>
                    <td class="w-40 text-center py-3">
                        <!-- FIX 1.2: 移除 opacity 控制，保持按鈕常態顯示 -->
                        <div class="action-cell-content gap-1">${moveBtns}${actionBtns}</div>
                    </td>
                </tr>`;
            });

            if(listEl.innerHTML === '') listEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400">尚未新增系所</td></tr>';
        }
        
        function moveCollege(idx, dir) {
            if (departmentData[idx + dir]) {
                [departmentData[idx], departmentData[idx + dir]] = [departmentData[idx + dir], departmentData[idx]];
                renderCollegeList();
                setUnsaved(true);
            }
        }
        function moveDepartment(id, dir) {
            const college = departmentData.find(c => c.id === activeCollegeId);
            if (!college || !college.departments) return;
            const idx = college.departments.findIndex(dId => dId === id);
            if (idx === -1 || !college.departments[idx + dir]) return;
            [college.departments[idx], college.departments[idx + dir]] = [college.departments[idx + dir], college.departments[idx]];
            renderDepartmentList();
            setUnsaved(true);
        }

        // 修正點 2: 學院只保留簡稱，並啟用右側面板
        // 修正點 3, 4: College - ID 留空，控制 ID 輸入框的唯讀屬性，並初始化驗證
        function openCollegeModal(id = null) {
            const isEdit = !!id;
            const college = isEdit ? departmentData.find(c => c.id === id) : { historical_names: {} };
            editingDeptEntityType = 'college';
            
            // Set global master object reference (Fix 4)
            currentEditingMaster = college; 

            document.getElementById('dept-editor-title').innerText = isEdit ? '編輯學院詳細資訊' : '新增學院';
            
            // Left Panel Setup
            document.getElementById('ed-dept-name-label').innerText = '簡稱 (介面顯示) *'; 
            document.getElementById('ed-dept-name').value = college.short_name || college.name || ''; 
            document.getElementById('ed-dept-shortname').value = college.name || '';

            const idInput = document.getElementById('ed-dept-id');
            // 修正點 3: 新增時 ID 留空
            idInput.value = isEdit ? id : '';
            // 修正點 4: 編輯時唯讀，新增時可輸入
            idInput.readOnly = isEdit; 
            
            document.getElementById('ed-dept-code').value = college.code || '';
            
            // 學院也需要歷史名稱管理 (啟用右側面板)
            document.getElementById('dept-year-name-panel').classList.remove('hidden');
            
            // 修正 4: 傳入當前編輯的物件
            renderYearNameList(currentEditingMaster, 'college');

            // 修正點 4: 初始化驗證 (新增時 ID 為空會禁用右側操作)
            validateDeptModalID();
            
            document.getElementById('dept-editor-modal').classList.remove('hidden');
        }
        
        // 修正點 3, 4: Department - ID 留空，控制 ID 輸入框的唯讀屬性，並初始化驗證
        function openDeptModal(id = null) {
            const isEdit = !!id;
            const college = departmentData.find(c => c.id === activeCollegeId);
            if (!college) return showMsg('error', '錯誤', '請先選擇或新增一個學院。');
            
            const master = isEdit ? deptMasterData[id] || { historical_names: {} } : { historical_names: {} };
            editingDeptEntityType = 'department';
            
            // Set global master object reference (Fix 4)
            currentEditingMaster = master; 

            document.getElementById('dept-editor-title').innerText = isEdit ? '編輯系所詳細資訊' : '新增系所';
            
            // --- Left Panel Setup (簡稱/ID/CODE) ---
            document.getElementById('ed-dept-name-label').innerText = `簡稱 (介面顯示) *`;
            document.getElementById('ed-dept-name').value = master.short_name || ''; 
            document.getElementById('ed-dept-shortname').value = master.name || ''; 

            const idInput = document.getElementById('ed-dept-id');
            // 修正點 3: 新增時 ID 留空
            idInput.value = isEdit ? id : '';
            // 修正點 4: 編輯時唯讀，新增時可輸入
            idInput.readOnly = isEdit; 
            
            document.getElementById('ed-dept-code').value = master.code || '';
            
            // --- Right Panel Control ---
            document.getElementById('dept-year-name-panel').classList.remove('hidden');
            
            // 修正 4: 傳入當前編輯的物件
            renderYearNameList(currentEditingMaster, 'department');
            
            // 修正點 4: 初始化驗證 (新增時 ID 為空會禁用右側操作)
            validateDeptModalID();

            document.getElementById('dept-editor-modal').classList.remove('hidden');
        }

        // 修正點 2: 歷史名稱面板樣式優化 (類似選項管理列表 - 灰色按鈕)
        function renderYearNameList(masterData, entityType) {
            const yearListEl = document.getElementById('year-name-list');
            const emptyStateEl = document.getElementById('year-name-empty-state');
            yearListEl.innerHTML = '';
            
            const defaultYear = configData.academicYears.find(y => y.isDefault)?.year;
            
            // Sort years descending
            configData.academicYears.sort((a,b) => b.year.localeCompare(a.year));
            
            if (configData.academicYears.length === 0) {
                emptyStateEl.classList.remove('hidden');
                return;
            } else {
                emptyStateEl.classList.add('hidden');
            }
            
            let listHtml = '';
            configData.academicYears.forEach(y => {
                // Fix 4: Use the masterData object passed in (which is currentEditingMaster)
                const historicalName = masterData.historical_names?.[y.year] || masterData.name || '';
                
                const isDefault = y.year === defaultYear;
                const yearStatus = isDefault ? '<span class="text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">當前</span>' : '';
                
                // FIX 2: 採用類似 Options List 的卡片風格
                listHtml += `
                    <tr data-year="${y.year}" class="hover:bg-slate-50 transition border-b border-slate-100 last:border-b-0">
                        <td class="w-24 text-center font-bold text-sm py-3 px-2">
                            <div class="flex flex-col items-center">
                                ${y.year} 
                                <div class="mt-1">${yearStatus}</div>
                            </div>
                        </td>
                        <td class="w-1/2 text-left text-slate-700 text-sm py-3 px-2">
                            <!-- FIX 2.3: Name Display (The "card" look) -->
                            <div class="flex items-center justify-between p-2 bg-white border border-slate-200 rounded-lg shadow-sm">
                                <span id="name-display-${y.year}" class="font-medium">${historicalName || '<span class="text-slate-400">未設定全稱</span>'}</span>
                            </div>
                        </td>
                        <td class="w-32 text-center py-3 px-2">
                            <div class="flex justify-center items-center gap-1">
                                <!-- FIX 2.4: Gray Buttons -->
                                <button onclick="copyYearNamePrompt('${y.year}', '${entityType}')" class="w-8 h-8 flex items-center justify-center hover:bg-slate-200 rounded-full text-slate-500 hover:text-primary transition" title="複製至其他學年"><i class="fas fa-copy text-sm"></i></button>
                                <button onclick="renameYearNamePrompt('${y.year}', '${entityType}')" class="w-8 h-8 flex items-center justify-center hover:bg-slate-200 rounded-full text-slate-500 hover:text-primary transition" title="變更名稱"><i class="fas fa-pen text-sm"></i></button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            yearListEl.innerHTML = listHtml;

            if (configData.academicYears.length === 0) {
                yearListEl.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-slate-400">請先建立學年度模組</td></tr>';
            }
            
            // 新增或編輯時，確保按鈕狀態正確
            validateDeptModalID();
        }
        
        // 修正點 3/4: 複製學年度名稱 (使用 currentEditingMaster)
        function copyYearNamePrompt(sourceYear, entityType) {
            // const id = document.getElementById('ed-dept-id').value.trim(); // 修正 4: 移除查找
            const master = currentEditingMaster; // 修正 4: 使用全域暫存
            if (!master) return showMsg('error', '錯誤', '找不到要編輯的資料。');
            
            const sourceName = master.historical_names?.[sourceYear] || master.name || '';
            
            // 修正點 7: 取得簡稱和 CODE 進行顯示，並簡化提示
            const displayName = master.short_name || master.name || document.getElementById('ed-dept-id').value.trim(); // Fallback to current ID if names are empty
            const displayCode = master.code ? ` (${master.code})` : '';
            
            // 修正點 7: 使用 HTML 粗體標籤，並將提示語簡化
            const promptDesc = `
                將 <strong>${displayName}${displayCode}</strong> 在 <strong>${sourceYear}</strong> 學年的全稱「<strong>${sourceName}</strong>」複製到：
            `;

            if (!sourceName) {
                return showMsg('info', '無來源名稱', '該學年度尚未設定全稱，無法複製。');
            }

            const yearOptions = configData.academicYears
                .filter(y => y.year !== sourceYear)
                .sort((a,b) => b.year.localeCompare(a.year));
                
            if (yearOptions.length === 0) {
                 return showMsg('info', '無可複製目標', '目前沒有其他學年度可以複製。');
            }

            let selectHtml = '<select id="msg-select-target" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none">';
            yearOptions.forEach(y => {
                const currentName = master.historical_names?.[y.year] || '';
                selectHtml += `<option value="${y.year}">${y.year} (${currentName ? '已設定' : '未設定'})</option>`;
            });
            selectHtml += '</select>';

            // 傳遞 HTML 提示
            showMsg('prompt', '複製學年全稱', promptDesc, 
                { 
                    label: '複製目標學年 (請勿填寫)', 
                }, 
                async (input, secondary, tertiary, fourth, select) => {
                    // 修正點 9 (關鍵): 在執行任何 DOM 清理之前，立即再次嘗試獲取目標學年。
                    const targetYear = window.__copyTargetYear;
                    
                    if (!targetYear) {
                         return showMsg('error', '複製失敗', '無法取得目標學年度，請重試。');
                    }

                    const targetMaster = currentEditingMaster; // 修正 4: 使用全域暫存
                    
                    if (!targetMaster.historical_names) targetMaster.historical_names = {};
                    targetMaster.historical_names[targetYear] = sourceName;
                    
                    // Update the UI row for the target year
                    const targetRow = document.querySelector(`#year-name-list tr[data-year="${targetYear}"] #name-display-${targetYear}`);
                    if (targetRow) {
                         targetRow.innerHTML = sourceName || `<span class="text-slate-400">未設定全稱</span>`;
                    }
                    
                    setUnsaved(true);
                    showMsg('success', '複製成功', `已將全稱複製到 ${targetYear} 學年度。`);
                }
            );
            
            // Custom logic to replace the generic prompt input with the year select
            const msgInputArea = document.getElementById('msg-input-area');
            msgInputArea.classList.add('hidden'); // Hide default input area

            // 修正點 7: 移除來源全稱的顯示，只保留目標學年選單
            msgInputArea.insertAdjacentHTML('beforebegin', `<div id="temp-select-area" class="mb-6 text-left p-4 bg-slate-100 rounded-lg border border-slate-200">
                <label class="block text-xs font-bold text-slate-700 uppercase mb-1">請選擇目標學年</label>
                ${selectHtml}
            </div>`);
            
            // 修正點 9 (關鍵): 在 showMsg 執行後，但在用戶點擊確認之前，將選擇值暫存到全域變數
            window.__copyTargetYear = document.getElementById('temp-select-area')?.querySelector('#msg-select-target')?.value;

            // 監聽選擇變化，確保 __copyTargetYear 隨時更新
            document.getElementById('temp-select-area')?.querySelector('#msg-select-target')?.addEventListener('change', function() {
                window.__copyTargetYear = this.value;
            });
        }

        // 修正點 3/4: 變更學年度名稱 (使用 currentEditingMaster)
        function renameYearNamePrompt(targetYear, entityType) {
            // const id = document.getElementById('ed-dept-id').value.trim(); // 修正 4: 移除查找
            const master = currentEditingMaster; // 修正 4: 使用全域暫存
            
            if (!master) return showMsg('error', '錯誤', '找不到要編輯的資料。');

            // 從 historical_names 獲取名稱，如果沒有則使用 master.name
            const currentName = master.historical_names?.[targetYear] || master.name || '';

            showMsg('prompt', `變更 ${targetYear} 學年全稱`, '請輸入該學年度系所使用的完整名稱。', 
                {
                    label: `${entityType === 'college' ? '學院' : '系所'}全稱 (${targetYear}學年) *`, 
                    value: currentName 
                }, 
                async (newName) => {
                    if (!newName) {
                        return showMsg('error', '儲存失敗', '全稱不可為空白。');
                    }
                    
                    saveNewYearName(document.getElementById('ed-dept-id').value.trim(), targetYear, newName, entityType);
                }
            );
        }

        // 實際儲存學年度名稱 (Helper) (使用 currentEditingMaster)
        function saveNewYearName(entityId, year, newName, entityType) {
             const master = currentEditingMaster; // 修正 4: 使用全域暫存
             
             if (!master) return;
             
             if (!master.historical_names) master.historical_names = {};
             
             // 儲存新的名稱
             master.historical_names[year] = newName;
             
             // 更新 UI (因為是在 modal 裡操作，直接操作 DOM)
             const displayEl = document.querySelector(`#year-name-list tr[data-year="${year}"] #name-display-${year}`);
             if (displayEl) {
                 displayEl.innerHTML = newName; // 使用 innerHTML 來處理可能被清空的 span
             }

             setUnsaved(true);
             showMsg('success', '變更成功', `${year} 學年度全稱已更新。`);
        }
        
        // 修正點 4: 驗證 ID 是否已輸入，並控制右側按鈕和保存按鈕狀態
        function validateDeptModalID() {
            const id = document.getElementById('ed-dept-id').value.trim();
            // 修正點 3: 確保 ID 欄位的唯讀屬性在 openModal 中被正確設置
            const idInput = document.getElementById('ed-dept-id');
            const isEdit = idInput.readOnly; 
            
            let isValid = isEdit; // 編輯狀態下，ID 已經存在，視為有效

            if (!isEdit) {
                // 新增狀態下，ID 必須非空
                isValid = id !== '';
                if (id !== '') {
                    // 檢查 ID 唯一性
                    isValid = editingDeptEntityType === 'college' 
                              ? !departmentData.some(c => c.id === id) 
                              : !deptMasterData.hasOwnProperty(id);
                }
            }
            
            const saveBtn = document.getElementById('btn-save-dept-master');
            // 只有 ID 有效且不重複，才能保存
            saveBtn.disabled = !isValid;
            saveBtn.classList.toggle('btn-manage', isValid);
            saveBtn.classList.toggle('bg-slate-300', !isValid);

            // 禁用右側所有操作按鈕 (鉛筆/複製)，直到 ID 有效
            const rightPanelActionBtns = document.querySelectorAll('#dept-year-name-panel button');
            rightPanelActionBtns.forEach(btn => {
                btn.disabled = !isValid;
            });
            
            // 顯示覆蓋層和提示 (Fix 3: Overlay adjustment)
            const overlayContainer = document.querySelector('#dept-editor-modal .flex-grow.relative'); 
            const overlayId = 'dept-id-lock-overlay';
            let overlay = document.getElementById(overlayId);

            if (!isValid) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = overlayId;
                    // FIX 3: Overlay must cover the right panel only
                    overlay.className = 'absolute inset-0 z-20 flex items-center justify-center pointer-events-none';
                    
                    let message = '請先在左側填寫 ID 以啟用右側操作。';
                    if (id !== '' && !isEdit) {
                         message = 'ID 重複或格式無效，請修正 ID 以啟用右側操作。';
                    }

                    // FIX 3: Use a message box positioned over the right panel's area
                    // The left panel is w-80 (20rem), so the right panel starts at 20rem.
                    overlay.innerHTML = `
                         <div class="absolute inset-y-0 right-0 left-[20rem] bg-white/70 backdrop-blur-[1px] rounded-r-xl flex items-center justify-center">
                             <div class="p-4 bg-amber-50 border border-amber-200 rounded-lg text-amber-700 font-bold text-sm shadow-md pointer-events-auto">${message}</div>
                         </div>
                    `;
                    
                    overlayContainer.appendChild(overlay);

                } else {
                    let message = '請先在左側填寫 ID 以啟用右側操作。';
                    if (id !== '' && !isEdit) {
                         message = 'ID 重複或格式無效，請修正 ID 以啟用右側操作。';
                    }
                    // Update message and show
                    const msgBox = overlay.querySelector('div.bg-amber-50');
                    if (msgBox) msgBox.innerText = message;
                    overlay.classList.remove('hidden');
                }
            } else if (overlay) {
                // 有效時隱藏覆蓋層
                overlay.classList.add('hidden');
            }
        }

        // Q1, Q2: Function to save data from the modal
        // 修正點 1, 2: Function to save data from the modal (Updated field mapping)
        async function saveDeptMasterFromModal() {
            const isCollege = editingDeptEntityType === 'college';
            const id = document.getElementById('ed-dept-id').value.trim();
            
            // Primary Input (ed-dept-name) -> 統一作為 Short Name
            const shortName = document.getElementById('ed-dept-name').value.trim(); 
            
            // Secondary Hidden Input (ed-dept-shortname) -> 用於暫存原有的 master.name
            const originalName = document.getElementById('ed-dept-shortname').value.trim();
            const code = document.getElementById('ed-dept-code').value.trim();
            
            if (!shortName || !id) {
                 // 檢查主要必填欄位
                 return showMsg('error', '儲存失敗', `簡稱和 ID 為必填項目。`);
            }
            
            const isNew = isCollege ? !departmentData.find(c => c.id === id) : !deptMasterData[id];
            
            if (isCollege) {
                // --- COLLEGE Logic (修正點 2) ---
                // name 和 short_name 都使用主輸入框的值 (簡化學院設定)
                if (isNew) {
                    if (departmentData.some(c => c.id === id)) return showMsg('error', '錯誤', '學院 ID 已存在');
                    // Fix 4: Use the data from currentEditingMaster
                    departmentData.push({ id, name: shortName, short_name: shortName, code, departments: [], historical_names: currentEditingMaster.historical_names || {} });
                } else {
                    const existingCollege = departmentData.find(c => c.id === id);
                    if (existingCollege) {
                        existingCollege.name = shortName;
                        existingCollege.short_name = shortName;
                        existingCollege.code = code;
                        // historical_names 已經在 modal 中被 saveNewYearName 更新
                    }
                }
            } else {
                // --- DEPARTMENT Logic (修正點 1) ---
                
                let newMasterEntry = deptMasterData[id] || { historical_names: {} };
                
                // 2. Update Dept Master Data
                // master.name (預設全稱) 保持為原值 (匯出基準)，如果是新建則使用 ID 作為 fallback
                // 這樣匯出時如果 historical_names 找不到對應學年，就會使用這個 name。
                newMasterEntry.name = originalName || id; 
                newMasterEntry.code = code || id;
                newMasterEntry.short_name = shortName; // 簡稱
                // Fix 4: Merge historical names from currentEditingMaster
                newMasterEntry.historical_names = currentEditingMaster.historical_names || newMasterEntry.historical_names;

                deptMasterData[id] = newMasterEntry;
                
                // 3. Update College Grouping Data
                if (isNew) {
                    const college = departmentData.find(c => c.id === activeCollegeId);
                    if (college && !college.departments.includes(id)) {
                         college.departments.push(id);
                    } else if (!college) {
                         return showMsg('error', '錯誤', '無法找到所屬學院');
                    }
                }
            }
            
            // Final UI Updates
            document.getElementById('dept-editor-modal').classList.add('hidden');
            setUnsaved(true);
            renderCollegeList();
            if (!isCollege) renderDepartmentList();
            
            currentEditingMaster = null; // Fix 4 Cleanup: Reset global state
            showMsg('success', '儲存成功', `${isCollege ? '學院' : '系所'}資訊已更新`);
        }

        function renameCurrentCollege() { openCollegeModal(activeCollegeId); }

        function deleteCurrentCollege() {
            showMsg('confirm', '確認刪除學院？', '這將刪除此學院及其下的所有系所分組關係，無法復原。請先確認該學院下的所有系所是否已移出。', null, () => {
                departmentData = departmentData.filter(c => c.id !== activeCollegeId);
                activeCollegeId = null;
                renderDepartmentView();
                setUnsaved(true);
                showMsg('success', '成功', '學院已刪除');
            });
        }

        function removeDepartment(id) {
            const college = departmentData.find(c => c.id === activeCollegeId);
            if (!college) return;

            showMsg('confirm', '確認移除系所？', '確定要從此學院分組中移除此系所嗎？它將不再顯示於此列表中，但其主資料仍會保留在系統中。', null, () => {
                college.departments = college.departments.filter(dId => dId !== id);
                renderDepartmentList();
                setUnsaved(true);
                showMsg('success', '成功', '系所已從學院中移除');
            });
        }
        
        async function saveDeptMasterData() {
            deptMasterSha = await uploadFile(DEPT_MASTER_PATH, deptMasterData, deptMasterSha);
        }
        
        async function saveDepartmentData() {
            deptDataSha = await uploadFile(DEPT_DATA_PATH, departmentData, deptDataSha);
        }


        // --- Batch Modal Logic ---
        function toggleGlobalAll(el) { document.querySelectorAll('.global-check').forEach(c => c.checked = el.checked); }
        
        function openBatchModal(type) {
            activeBatchListType = type;
            const checkboxClass = type === 'global' ? '.global-check' : '.year-check';
            const checkedElements = Array.from(document.querySelectorAll(checkboxClass + ':checked'));
            
            if (checkedElements.length === 0) return;

            document.getElementById('batch-count').innerText = checkedElements.length;
            
            const catSelect = document.getElementById('batch-category-select');
            catSelect.innerHTML = '<option value="">請選擇新分類 (維持不變)</option><option value="uncategorized">未分類</option>';
            configData.templateCategories.sort((a,b) => a.order - b.order).forEach(c => {
                catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            document.getElementById('batch-action-select').value = '';
            toggleBatchActionSettings('');
            document.getElementById('batch-modal').classList.remove('hidden');
        }
        
        function toggleBatchActionSettings(action) {
            const catGroup = document.getElementById('batch-category-group');
            const deleteConfirm = document.getElementById('batch-delete-confirm');
            const executeBtn = document.getElementById('btn-execute-batch');
            
            catGroup.classList.add('hidden');
            deleteConfirm.classList.add('hidden');
            executeBtn.disabled = true;

            if (action === 'category') {
                catGroup.classList.remove('hidden');
                document.getElementById('batch-category-select').onchange = (e) => {
                    executeBtn.disabled = !e.target.value;
                };
                document.getElementById('batch-category-select').onchange();
            } else if (action === 'delete') {
                deleteConfirm.classList.remove('hidden');
                executeBtn.disabled = false;
            }
        }

        function executeBatchAction() {
            const action = document.getElementById('batch-action-select').value;
            const list = activeBatchListType === 'global' ? configData.globalFields : yearTemplateData.fields;
            const checkboxClass = activeBatchListType === 'global' ? '.global-check' : '.year-check';
            const checkedElements = Array.from(document.querySelectorAll(checkboxClass + ':checked'));
            const checkedValues = checkedElements.map(c => activeBatchListType === 'global' ? c.value : parseInt(c.value)); 

            if (checkedElements.length === 0 || !action || (action === 'category' && !document.getElementById('batch-category-select').value)) {
                document.getElementById('batch-modal').classList.add('hidden');
                return;
            }
            
            let successMsg = '';

            if (action === 'category') {
                const newCatId = document.getElementById('batch-category-select').value;
                const newCatText = document.getElementById('batch-category-select').options[document.getElementById('batch-category-select').selectedIndex].text;
                
                checkedElements.forEach(c => {
                    const item = activeBatchListType === 'global' 
                        ? list.find(f => f.id === c.value) 
                        : list[parseInt(c.value)];
                    
                    if (item) {
                        if (newCatId === 'uncategorized') {
                            delete item.category;
                        } else if (newCatId) { 
                            item.category = newCatId;
                        }
                    }
                });

                successMsg = `已將選取的 ${checkedElements.length} 個欄位變更/設定為 ${newCatText}。`;

            } else if (action === 'delete') {
                if (activeBatchListType === 'global') {
                    configData.globalFields = configData.globalFields.filter(f => !checkedValues.includes(f.id));
                    configData.globalFields.sort((a,b) => a.order - b.order).forEach((f,i) => f.order = i);
                } else { 
                    checkedValues.sort((a,b) => b - a).forEach(index => {
                        yearTemplateData.fields.splice(index, 1);
                    });
                }
                successMsg = `已成功刪除選取的 ${checkedElements.length} 個欄位。`;
            }

            document.querySelectorAll(checkboxClass).forEach(c => c.checked = false);
            
            setUnsaved(true);
            activeBatchListType === 'global' ? renderGlobalList() : renderYearFields();
            updateBatchControlVisibility(activeBatchListType);
            
            document.getElementById('batch-modal').classList.add('hidden');
            showMsg('success', action === 'delete' ? '刪除成功' : '批次成功', successMsg);
        }
        
        // --- Output Field Helper for Export (SOURCE OF TRUTH is the Module Fields) ---
        function getOrderedModuleFields() {
            // Get all fields from the template (selected or not)
            const allModuleFields = currentTemplateFields;

            // Return all module fields sorted by their original order in the module
            return allModuleFields.sort((a, b) => (a.order || 999) - (b.order || 999)).map(f => ({
                ...f,
                dataKey: f.id 
            }));
        }


        // --- Internship Consolidation Logic (Updated) ---
        
        // Function to close mapping modal safely
        function closeMappingModal(userCancelled = false) {
            document.getElementById('mapping-modal').classList.add('hidden');
            // Re-enable the re-open button if we have data
            if (currentStudentData) {
                document.getElementById('btn-reopen-mapping').classList.remove('hidden');
            }
            if (userCancelled) {
                 showMsg('info', '操作取消', '欄位匹配已取消，請確認是否需要重新匹配。');
            }
        }
        
        // ★★★ 補上遺漏的函式：取得需要匹配的欄位 (含排序與核心檢查) ★★★
        function getFieldsToProcess() {
            const fieldsToMap = new Map();
            
            // 1. 篩選模組欄位
            currentTemplateFields.sort((a, b) => {
                // 強制將「學年」相關欄位排在最前面，方便匹配
                const isYearA = a.label.includes('學年') || a.id === 'school_year' || a.id === 'academic_year';
                const isYearB = b.label.includes('學年') || b.id === 'school_year' || b.id === 'academic_year';
                
                if (isYearA && !isYearB) return -1;
                if (!isYearA && isYearB) return 1;
                
                return (a.order || 999) - (b.order || 999);
            }).forEach(f => {
                // 判斷是否為「系統」分類 (開課資訊/學生資訊)
                const isSystemCat = ALLOWED_MAPPING_CATEGORY_IDS.includes(f.category);
                // 判斷是否為「強制核心邏輯」欄位 (如 student_id, course_dept)
                const isMandatory = MANDATORY_LOGIC_IDS.includes(f.id);

                // 只要符合其中一個條件，就加入匹配清單
                if (isSystemCat || isMandatory) {
                    fieldsToMap.set(f.id, {
                        ...f,
                        isMandatoryLogic: isMandatory
                    });
                }
            });
            
            return Array.from(fieldsToMap.values());
        }

        // Function to re-open mapping modal when data is loaded
        function reopenMappingModal() {
            if (!currentStudentData) {
                 return showMsg('info', '請先上傳檔案', '請先上傳註課組清單檔案，才能進行欄位匹配。');
            }
            
            const selectEl = document.getElementById('consolidation-year-select');
            
            // Re-render year options and select the current year
            selectEl.innerHTML = configData.academicYears.map(y => `<option value="${y.year}">${y.year} 學年度模組</option>`).join('');
            if (currentConsolidationYear) {
                selectEl.value = currentConsolidationYear;
            }
            
            renderMappingPanel(); // Render using existing state/fileHeaders
            document.getElementById('mapping-modal').classList.remove('hidden');
        }
        
        async function fetchCurrentTemplateFields(shouldRenderMapping = false) {
            currentConsolidationYear = document.getElementById('consolidation-year-select').value;
            if (!currentConsolidationYear) return;
            
            const res = await apiFetch(`hedb/year_templates/year_${currentConsolidationYear}_templates.json`);
            yearTemplateData = res.status===404 ? {fields:[]} : res.data;
            currentTemplateFields = yearTemplateData.fields || [];

            if (!yearTemplateData.categoryColors) yearTemplateData.categoryColors = {};
            if (!yearTemplateData.allianceModeDepts) { yearTemplateData.allianceModeDepts = { groups: [], groupingBasis: 'course_dept', unmatchedHandling: 'use_primary' }; }
            
            const btnExport = document.getElementById('btn-export-config');
            if (btnExport) {
                if (currentStudentData) btnExport.classList.remove('hidden');
                else btnExport.classList.add('hidden');
            }

            if (shouldRenderMapping) {
                // [修改] 重置並執行「一次性」自動匹配
                // 這樣之後使用者手動清除時，就不會被這裡的邏輯覆蓋
                currentMapping = {};
                
                const fieldsToMap = getFieldsToProcess();
                fieldsToMap.forEach(f => {
                    // 初始化狀態
                    currentMapping[f.id] = { excelHeader: '', isSelected: true };
                    
                    // 執行自動匹配 (僅限完全名稱相同)
                    const exactMatch = currentFileHeaders.find(h => h.trim() === f.label.trim());
                    if (exactMatch) {
                        currentMapping[f.id].excelHeader = exactMatch;
                    }
                });

                renderMappingPanel();
            }
        }

        function renderInternshipView() {
            const selectEl = document.getElementById('consolidation-year-select');
            selectEl.innerHTML = configData.academicYears.map(y => `<option value="${y.year}">${y.year} 學年度模組</option>`).join(''); 
            
            currentSelectedGroup = null; 

            if (configData.academicYears.length > 0) {
                currentConsolidationYear = selectEl.value;
                // fetchCurrentTemplateFields(); // 保持您註解掉的狀態
            } 

            // [新增] 初始化側邊欄學院篩選
            const colFilter = document.getElementById('internship-sidebar-college-filter');
            if (colFilter) {
                const collegeOptions = departmentData.map(c => 
                    `<option value="${c.id}">${getCollegeDisplayName(c.id, true)}</option>`
                ).join('');
                colFilter.innerHTML = '<option value="">顯示所有學院</option>' + collegeOptions;
            }
            // [結束新增]

            document.getElementById('current-internship-group-title').innerText = '實習學生名單彙整';
            document.getElementById('group-detail-subtitle').innerText = '請上傳名單並進行匹配';
            document.getElementById('results-table-container').classList.add('hidden');
            document.getElementById('results-empty-state').classList.remove('hidden');
            document.getElementById('btn-batch-download-all-results-main').classList.add('hidden');
            document.getElementById('btn-reopen-mapping').classList.add('hidden');
            
            // ★★★ 新增：進入此頁面時，強制隱藏匯出設定按鈕 (確保乾淨的初始狀態) ★★★
            document.getElementById('btn-export-config').classList.add('hidden');
            
            document.getElementById('internship-group-list').innerHTML = '<div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup(\'all\')"><span class="font-bold text-sm">全部</span></div>' + 
                                                                         '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state">無可彙整名單</div>';
            document.getElementById('group-all-item').classList.add('active');
        }
        
        // 開啟匯出設定視窗
        // 開啟匯出設定視窗 (含顏色選擇器)
        // 開啟匯出設定視窗 (修正變數 field -> f 以及顏色邏輯)
        function openExportConfigModal() {
            if (!yearTemplateData || !yearTemplateData.fields) return showMsg('error', '錯誤', '請先選擇學年度模組');
            
            const tbody = document.getElementById('export-config-list');
            tbody.innerHTML = '';
            
            // ★★★ 修正排序邏輯：學年優先 ★★★
            yearTemplateData.fields.sort((a,b) => {
                const isYearA = a.label.includes('學年') || a.id === 'school_year' || a.id === 'academic_year';
                const isYearB = b.label.includes('學年') || b.id === 'school_year' || b.id === 'academic_year';
                
                if (isYearA && !isYearB) return -1;
                if (!isYearA && isYearB) return 1;

                const orderA = (a.order !== undefined && a.order !== null) ? a.order : 999;
                const orderB = (b.order !== undefined && b.order !== null) ? b.order : 999;
                
                return orderA - orderB;
            }).forEach((f, idx) => {
                const catId = f.category || 'uncategorized';
                const catName = configData.templateCategories.find(c => c.id === catId)?.name || '未分類';
                const isLocked = f.excelLocked ? 'checked' : '';
                const widthVal = f.excelWidth || '';
                
                // ★★★ 修正點：使用 f.category (原本誤寫為 field.category) ★★★
                const rawColor = getCategoryColor(f.category);
                const hashColor = '#' + rawColor; 
                
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 hover:bg-slate-50 transition">
                        <td class="p-3 text-center text-slate-400 font-mono text-xs">${idx + 1}</td>
                        <td class="p-3">
                            <div class="font-bold text-slate-700">${f.label}</div>
                            <div class="text-[10px] text-slate-400 font-mono">${f.id}</div>
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <input type="color" 
                                       value="${hashColor}" 
                                       class="w-6 h-6 p-0 border-0 rounded cursor-pointer cat-color-picker" 
                                       data-cat-id="${catId}"
                                       onchange="updateCategoryColorBatch('${catId}', this.value)"
                                       title="點擊修改此分類的背景色">
                                <span class="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded truncate max-w-[10rem]">${catName}</span>
                            </div>
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-1">
                                <input type="number" id="exp-w-${f.id}" value="${widthVal}" class="w-full border border-slate-300 rounded p-1.5 text-sm focus:ring-2 focus:ring-teal-500 outline-none" placeholder="Auto">
                            </div>
                        </td>
                        <td class="p-3 text-center">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="exp-l-${f.id}" class="w-5 h-5 text-teal-600 rounded border-gray-300 focus:ring-teal-500 transition" ${isLocked}>
                            </label>
                        </td>
                    </tr>
                `;
            });
            
            document.getElementById('export-config-modal').classList.remove('hidden');
        }

        // 新增：連動更新所有相同分類的顏色選擇器 (UI UX 優化)
        function updateCategoryColorBatch(catId, newColor) {
            // 找出所有屬於此分類的選擇器並同步更新顏色
            const pickers = document.querySelectorAll(`.cat-color-picker[data-cat-id="${catId}"]`);
            pickers.forEach(p => p.value = newColor);
        }

        // 儲存匯出設定
        function saveExportConfig() {
            let changed = false;
            
            // 1. 儲存欄寬與鎖定狀態
            yearTemplateData.fields.forEach(f => {
                const wInput = document.getElementById(`exp-w-${f.id}`);
                const lInput = document.getElementById(`exp-l-${f.id}`);
                
                if (wInput && lInput) {
                    const newW = parseInt(wInput.value);
                    const newL = lInput.checked;
                    
                    if (f.excelWidth !== newW || f.excelLocked !== newL) {
                        if (newW > 0) f.excelWidth = newW; else delete f.excelWidth;
                        f.excelLocked = newL;
                        changed = true;
                    }
                }
            });

            // 2. ★★★ 新增：儲存分類顏色 ★★★
            // 遍歷所有分類選擇器 (使用 Map 去重)
            const colorPickers = document.querySelectorAll('.cat-color-picker');
            const newColors = yearTemplateData.categoryColors || {};
            
            colorPickers.forEach(picker => {
                const catId = picker.dataset.catId;
                const color = picker.value; // e.g. #002E5D
                
                // 如果顏色跟預設不同，或原本就有設定，則更新
                if (newColors[catId] !== color) {
                    newColors[catId] = color;
                    changed = true;
                }
            });
            yearTemplateData.categoryColors = newColors;
            
            if (changed) {
                setUnsaved(true);
                showMsg('success', '設定已更新', 'Excel 匯出屬性與分類顏色已更新，請記得點擊右上角「儲存設定」以永久保存。');
            } else {
                showMsg('info', '無變更', '設定未發生變化。');
            }
            document.getElementById('export-config-modal').classList.add('hidden');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // **NEW: Prompt warning if data is already loaded**
            if (currentStudentData) {
                 showMsg('confirm', '確認覆蓋舊資料？', '上傳新檔案將覆蓋現有名單和匹配設定，確定要繼續嗎？', null, async () => {
                    await processFileLoad(file);
                 });
            } else {
                 await processFileLoad(file);
            }
            
             // Clear file input to allow selecting the same file again if needed
            event.target.value = null; 
        }
        
        async function processFileLoad(file) {
            document.getElementById('file-status').innerText = '檔案讀取中...';
            // No need to update module-checklist-container as it's now removed from UI
            document.getElementById('mapping-dropdown-container').innerHTML = '';
            document.getElementById('mapping-panel-empty-state').classList.remove('hidden');
            document.getElementById('results-empty-state').classList.remove('hidden');
            document.getElementById('results-table-container').classList.add('hidden');
            document.getElementById('btn-batch-download-all-results-main').classList.add('hidden');
            document.getElementById('btn-reopen-mapping').classList.add('hidden');
            
            currentStudentData = null;
            currentFileHeaders = [];
            uniqueCourseDepts = [];
            currentSelectedGroup = null;
            currentMapping = {}; // Reset mapping state on new file upload

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = e.target.result;
                    if (typeof XLSX === 'undefined') throw new Error("XLSX 函式庫未定義。"); 
                    const workbook = XLSX.read(data, { type: 'array' }); 
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: "" });
                    if (sheetData.length === 0) throw new Error("檔案內容為空");
                    
                    currentFileHeaders = sheetData[0].filter(h => h !== undefined && h !== null && h.toString().trim() !== ""); 

                    currentStudentData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: "" });
                    currentStudentData = currentStudentData.filter(row => Object.keys(row).length > 0); 
                    
                    document.getElementById('file-status').innerText = `已讀取檔案: ${file.name} (${currentFileHeaders.length} 欄, ${currentStudentData.length} 筆資料). 請進行匹配。`;
                    
                    // File upload successful: Trigger mapping setup
                    promptMappingSetup();
                } catch (e) {
                    showMsg('error', '檔案讀取失敗', `請確認檔案格式為有效的 XLSX/CSV。錯誤: ${e.message}`);
                    document.getElementById('file-status').innerText = '讀取失敗，請重新上傳。';
                }
            };
            reader.onerror = function(e) {
                 showMsg('error', '檔案讀取錯誤', '無法讀取檔案內容。');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function promptMappingSetup() {
            const selectEl = document.getElementById('consolidation-year-select');
            
            // Re-render year options
            selectEl.innerHTML = configData.academicYears.map(y => `<option value="${y.year}">${y.year} 學年度模組</option>`).join('');
            
            // Auto-select current year if available
            const defaultYear = currentConsolidationYear || configData.academicYears.find(y => y.isDefault)?.year || configData.academicYears[0]?.year;
            if (defaultYear) {
                selectEl.value = defaultYear;
                currentConsolidationYear = defaultYear;
                // Fetch fields and render mapping panel (shouldRenderMapping = true)
                fetchCurrentTemplateFields(true); 
            }

            document.getElementById('mapping-modal').classList.remove('hidden');
            
            document.getElementById('btn-alliance-config').disabled = false;
            document.getElementById('btn-alliance-config').className = "btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all";
            
            const btnProcessList = document.getElementById('btn-process-list');
            if (btnProcessList) btnProcessList.disabled = false;
        }
        
        // Updates the excelHeader mapping and triggers UI refresh (optional for performance)
        function updateMappingHeader(fieldId, excelHeader) {
            if (!currentMapping[fieldId]) {
                currentMapping[fieldId] = { excelHeader: '', isSelected: true }; 
            }
            currentMapping[fieldId].excelHeader = excelHeader;
            renderMappingDropdowns(); // Rerender to disable selected option in other dropdowns
        }

        // ★★★ 補上遺失的顏色取得函式 ★★★
        function getCategoryColor(catId) {
            // 1. 優先使用學年度模組內儲存的顏色
            if (yearTemplateData.categoryColors && yearTemplateData.categoryColors[catId]) {
                return yearTemplateData.categoryColors[catId].replace('#', '');
            }
            // 2. 系統預設顏色對照表 (不含 #)
            const defaults = {
                'sys_course_info': '4F46E5', // Indigo
                'sys_student_info': '219653', // Success Green
                'uncategorized': '94A3B8'     // Slate
            };
            // 3. 回傳預設值或深灰色
            return defaults[catId] || '64748B'; 
        }

        // The list of all fields to be exported (which is now the entire module template)
        function getFieldsToExport() {
            // 複製一份欄位設定
            const allModuleFields = currentTemplateFields.map(f => ({
                ...f,
                dataKey: f.id 
            }));

            // 排序邏輯
            return allModuleFields.sort((a, b) => {
                // 1. 強制將「學年」、「學期」相關欄位排在最前面
                const isYearA = a.label.includes('學年') || a.id === 'school_year' || a.id === 'academic_year';
                const isYearB = b.label.includes('學年') || b.id === 'school_year' || b.id === 'academic_year';
                const isSemA = a.label.includes('學期') || a.id === 'semester';
                const isSemB = b.label.includes('學期') || b.id === 'semester';

                if (isYearA && !isYearB) return -1;
                if (!isYearA && isYearB) return 1;
                if (isSemA && !isSemB) return -1;
                if (!isSemA && isSemB) return 1;

                // 2. Order 排序
                const orderA = (a.order !== undefined && a.order !== null) ? a.order : 999;
                const orderB = (b.order !== undefined && b.order !== null) ? b.order : 999;
                
                return orderA - orderB;
            });
        }

        // ★★★ 補上遺失的 renderMappingPanel 函式 (作為 renderMappingDropdowns 的別名) ★★★
        function renderMappingPanel() {
            renderMappingDropdowns();
        }

        function renderMappingDropdowns() {
            const container = document.getElementById('mapping-dropdown-container');
            const emptyState = document.getElementById('mapping-panel-empty-state');
            const selectedCountEl = document.getElementById('selected-mapping-count');
            const totalFieldsEl = document.getElementById('total-module-fields'); // [Fix] 取得計數元素
            
            const fieldsToMap = getFieldsToProcess(); 

            // [Fix] 更新系統欄位總數顯示
            if (totalFieldsEl) totalFieldsEl.innerText = fieldsToMap.length;

            if (fieldsToMap.length === 0) {
                 container.innerHTML = '';
                 emptyState.classList.remove('hidden');
                 selectedCountEl.innerText = 0;
                 return;
            }
            emptyState.classList.add('hidden');
            
            // 1. 識別已選取的 Headers (用於 Disable 其他欄位已選的選項)
            const selectedHeaders = new Map();
            
            fieldsToMap.forEach(f => {
                // [Fix] 這裡不再執行自動匹配，僅讀取現有狀態
                if (!currentMapping[f.id]) {
                     currentMapping[f.id] = { excelHeader: '', isSelected: true };
                }
                
                if (currentMapping[f.id].excelHeader) {
                    selectedHeaders.set(f.id, currentMapping[f.id].excelHeader);
                }
            });

            let dropdownsHtml = '';
            let matchedCount = 0;
            
            fieldsToMap.forEach(modField => {
                const mapState = currentMapping[modField.id];
                const isCoreLogic = modField.isMandatoryLogic;
                const requiredMark = isCoreLogic ? '<span class="text-red-500 font-bold">*</span>' : '';
                
                if (mapState.excelHeader) matchedCount++;

                // 2. Generate Options
                const baseExcelHeaderOptions = ['<option value="">-- 請選擇 Excel 欄位 --</option>', ...currentFileHeaders.map(h => `<option value="${h}">${h}</option>`)];
                const optionsHtml = baseExcelHeaderOptions.map(optHtml => {
                    const valueMatch = optHtml.match(/value="([^"]*)"/);
                    const headerValue = valueMatch ? valueMatch[1] : '';
                    let attributes = '';
                    
                    if (headerValue) {
                        // 檢查是否被其他欄位選用
                        for (const [fieldId, header] of selectedHeaders) {
                             if (header === headerValue && fieldId !== modField.id) {
                                attributes += ' disabled class="text-slate-400"';
                                break;
                             }
                        }
                    }
                    
                    if (headerValue === mapState.excelHeader) attributes += ' selected';
                    
                    // 取得選項文字 (處理第一個空選項的顯示文字)
                    let label = headerValue;
                    if (!label) {
                        const textMatch = optHtml.match(/>(.*)</);
                        label = textMatch ? textMatch[1] : '-- 請選擇 Excel 欄位 --';
                    }
                    
                    return `<option value="${headerValue}"${attributes}>${label}</option>`;
                }).join('');

                dropdownsHtml += `
                    <div class="mapping-group">
                        <div class="flex flex-col mb-1.5">
                             <span class="font-bold text-slate-800 text-sm">${modField.label} ${requiredMark}</span>
                             <span class="text-[10px] text-slate-400 font-mono block">${modField.id}</span>
                        </div>
                        <select data-field-id="${modField.id}" onchange="updateMappingHeader(this.dataset.fieldId, this.value)" class="w-full border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-primary outline-none">
                            ${optionsHtml}
                        </select>
                    </div>
                `;
            });
            
            container.innerHTML = dropdownsHtml;
            selectedCountEl.innerText = matchedCount;
        }

        async function processUploadedFile() {
            if (!currentStudentData) return showMsg('error', '錯誤', '請先上傳名單檔案。');
            currentConsolidationYear = document.getElementById('consolidation-year-select').value;
            if (!currentConsolidationYear) return showMsg('error', '錯誤', '請先選擇要套用的學年度模組。');
            
            await fetchCurrentTemplateFields(); // Ensure latest fields are loaded
            
            // --- NEW LOGIC FOR VALIDATION AND PROCESSING ---
            // 1. Get the list of fields displayed for matching (sys_course/student info)
            const fieldsToProcess = getFieldsToProcess();

            // 2. Validate core logic fields: Check if they are matched. If not, inform user, but DON'T FAIL the process.
            const unmappedCoreFields = fieldsToProcess
                .filter(f => f.isMandatoryLogic) 
                .filter(f => !currentMapping[f.id].excelHeader); 
                
            if (unmappedCoreFields.length > 0) {
                 showMsg('confirm', '核心欄位未匹配', `以下核心邏輯欄位未匹配到 Excel 欄位：${unmappedCoreFields.map(f => f.label).join('、')}。
                 如果繼續，這些欄位在彙整資料中將會是空白，可能影響分組結果。是否確定繼續？`, null, async () => {
                    // User confirmed, continue with processing
                    await executeFileProcessing(fieldsToProcess);
                 });
                 // Stop initial execution, waiting for confirm
                 return;
            }
            
            // If all core fields are matched, proceed directly
            await executeFileProcessing(fieldsToProcess);
        }

        // 全域變數暫存衝突狀態
        let pendingConflicts = [];
        let pendingFieldsToProcess = [];

        // 步驟 1: 觸發處理，先進行檢測
        async function executeFileProcessing(fieldsToProcess) {
            document.getElementById('mapping-modal').classList.add('hidden');
            
            // ==========================================
            // [修正] 直接操作父容器，避免找不到子元素導致錯誤
            // ==========================================
            const sidebarList = document.getElementById('internship-group-list');
            sidebarList.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>檢查資料中...</div>';
            // ==========================================
            
            pendingFieldsToProcess = fieldsToProcess;
            const conflicts = checkDataConflicts(fieldsToProcess);
            
            if (conflicts.length > 0) {
                pendingConflicts = conflicts;
                showConflictModal(conflicts);
            } else {
                finalizeProcessing(fieldsToProcess, []);
            }
        }

        // 檢測資料衝突 (Single Select / List)
        function checkDataConflicts(fieldsToProcess) {
            const conflictMap = new Map(); // Key: fieldId_value

            currentStudentData.forEach(row => {
                fieldsToProcess.forEach(modField => {
                    if (modField.type !== 'single_select' && modField.type !== 'list') return;
                    if (!modField.options || modField.options.length === 0) return;

                    const mapping = currentMapping[modField.id];
                    if (!mapping || !mapping.excelHeader) return;

                    const val = (row[mapping.excelHeader] || '').toString().trim();
                    if (!val) return;

                    // 檢查是否存在於選項中
                    if (!modField.options.includes(val)) {
                        const key = `${modField.id}:::${val}`;
                        if (!conflictMap.has(key)) {
                            conflictMap.set(key, {
                                fieldId: modField.id,
                                fieldLabel: modField.label,
                                value: val,
                                count: 0
                            });
                        }
                        conflictMap.get(key).count++;
                    }
                });
            });
            return Array.from(conflictMap.values());
        }

        // 顯示衝突視窗
        function showConflictModal(conflicts) {
            const tbody = document.getElementById('conflict-list-body');
            tbody.innerHTML = '';
            
            conflicts.forEach((c, idx) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-slate-100 hover:bg-slate-50';
                tr.innerHTML = `
                    <td class="p-3 font-bold text-slate-700">${c.fieldLabel}</td>
                    <td class="p-3"><span class="bg-red-50 text-red-600 px-2 py-1 rounded font-mono text-xs">${c.value}</span></td>
                    <td class="p-3 text-slate-500">${c.count}</td>
                    <td class="p-3">
                        <select id="conflict-action-${idx}" class="border border-slate-300 rounded p-1 text-sm outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="skip">略過含此值的資料 (Skip)</option>
                            <option value="clear">保留資料但清空此欄 (Clear)</option>
                            <option value="add">新增選項並保留 (Add Option)</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('conflict-modal').classList.remove('hidden');
        }

        function cancelProcessing() {
            document.getElementById('conflict-modal').classList.add('hidden');
            document.getElementById('mapping-modal').classList.remove('hidden'); // 回到匹配
            showMsg('info', '已取消', '請重新確認匹配或資料。');
        }

        // 解決衝突並繼續
        async function resolveConflictsAndContinue() {
            const resolutions = [];
            let optionsUpdated = false;

            pendingConflicts.forEach((c, idx) => {
                const action = document.getElementById(`conflict-action-${idx}`).value;
                resolutions.push({ ...c, action });

                if (action === 'add') {
                    // 更新模組設定 (記憶體中)
                    const field = yearTemplateData.fields.find(f => f.id === c.fieldId);
                    if (field) {
                        if (!field.options) field.options = [];
                        if (!field.options.includes(c.value)) {
                            field.options.push(c.value);
                            optionsUpdated = true;
                        }
                    }
                }
            });

            if (optionsUpdated) {
                setUnsaved(true); // 標記為未儲存，提示使用者記得存檔
                // 這裡選擇不立即存到 GitHub，避免誤操作，讓使用者最後統一存
                showMsg('info', '選項已更新', '新增的選項已暫存，請記得稍後點擊右上角「儲存設定」。');
            }

            document.getElementById('conflict-modal').classList.add('hidden');
            finalizeProcessing(pendingFieldsToProcess, resolutions);
        }

        // 步驟 2: 最終執行資料處理 (包含排序、分組)
        async function finalizeProcessing(fieldsToProcess, resolutions) {
            // 更新側邊欄狀態
            const sidebarList = document.getElementById('internship-group-list');
            if (sidebarList) {
                sidebarList.innerHTML = '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>彙整中...</div>';
            }

            // 1. 建立「名稱 -> ID」的反向對照表 (用於將 "外國語文學系" 轉為 "foreign_lang")
            const deptNameToIdMap = new Map();
            const targetYear = currentConsolidationYear || activeYearId; 

            // 遍歷所有系所主檔
            for (const [deptId, master] of Object.entries(deptMasterData)) {
                if (master.historical_names?.[targetYear]) deptNameToIdMap.set(master.historical_names[targetYear].trim(), deptId);
                if (master.name) deptNameToIdMap.set(master.name.trim(), deptId);
                if (master.short_name) deptNameToIdMap.set(master.short_name.trim(), deptId);
                if (master.code) deptNameToIdMap.set(master.code.trim(), deptId);
            }
            
            const collegeNameToIdMap = new Map();
            departmentData.forEach(col => {
                const yearName = col.historical_names?.[targetYear] || col.name;
                if (yearName) collegeNameToIdMap.set(yearName.trim(), col.id);
                if (col.name) collegeNameToIdMap.set(col.name.trim(), col.id);
            });

            const mappedData = [];
            
            // ★★★★★ [修正重點：補上這兩行] ★★★★★
            // 建立快速查詢衝突處理方式的 Map (解決 resolutionMap is not defined 錯誤)
            const resolutionMap = new Map(); 
            resolutions.forEach(r => resolutionMap.set(`${r.fieldId}:::${r.value}`, r.action));
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            // Data Mapping Loop
            for (let i = 0; i < currentStudentData.length; i++) {
                const row = currentStudentData[i];
                const newRow = {};
                let skipRow = false;

                fieldsToProcess.forEach(modField => {
                    if (skipRow) return;

                    const mapping = currentMapping[modField.id];
                    const fileHeader = mapping ? mapping.excelHeader : null;
                    let value = fileHeader ? (row[fileHeader] || '').toString().trim() : '';

                    // 衝突處理
                    if ((modField.type === 'single_select' || modField.type === 'list') && modField.options && value) {
                        if (!modField.options.includes(value)) {
                            // 這裡會用到 resolutionMap
                            const action = resolutionMap.get(`${modField.id}:::${value}`);
                            if (action === 'skip') skipRow = true;
                            else if (action === 'clear') value = '';
                            // action === 'add' 時保留原值
                        }
                    }

                    // 系所/學院 名稱轉 ID
                    const isDeptField = modField.type === 'department' || ['student_dept', 'course_dept', 'student_department', 'offering_department'].includes(modField.id);
                    const isCollegeField = !isDeptField && (modField.type === 'college' || ['student_college', 'course_college'].includes(modField.id));

                    if (isDeptField && value) {
                        const foundId = deptNameToIdMap.get(value);
                        if (foundId) value = foundId; 
                    } else if (isCollegeField && value) {
                        const foundId = collegeNameToIdMap.get(value);
                        if (foundId) value = foundId;
                    }

                    newRow[modField.id] = value;
                });

                if (skipRow) continue;

                // Alias Mapping
                const aliases = [
                    { sys: 'course_dept', alt: 'offering_department' },
                    { sys: 'course_id', alt: 'course_code' },
                    { sys: 'internship_attr', alt: 'internship_course_type' },
                    { sys: 'internship_credit', alt: 'internship_credits' },
                    { sys: 'student_dept', alt: 'student_department' }
                ];
                
                aliases.forEach(pair => {
                    if (!newRow[pair.sys] && newRow[pair.alt]) {
                        newRow[pair.sys] = newRow[pair.alt];
                    }
                });

                // 補齊欄位
                const allExportFields = getFieldsToExport(); 
                allExportFields.forEach(expField => {
                    if (!newRow.hasOwnProperty(expField.id)) newRow[expField.id] = '';
                });

                newRow.course_dept = newRow.course_dept || '';
                newRow.student_dept = newRow.student_dept || '';
                newRow.student_id = newRow.student_id || '';

                if (newRow.student_id && newRow.course_dept) {
                    mappedData.push(newRow);
                }
            }
            
            // ... (後續的分組與渲染邏輯保持不變) ...
            // 3. Dept Uniqueness Check
            const departments = mappedData.map(row => row.course_dept).filter(d => d);
            uniqueCourseDepts = [...new Set(departments)].sort();

            // 4. Sorting and Grouping
            const allianceConfig = yearTemplateData.allianceModeDepts || { groups: [], groupingBasis: 'course_dept', unmatchedHandling: 'use_primary' };
            const allianceGroups = allianceConfig.groups || [];
            const basis = allianceConfig.groupingBasis || 'course_dept';
            const unmatchedHandling = allianceConfig.unmatchedHandling || 'use_primary';

            let groupedData = {}; 
            mappedData.forEach(record => {
                const primaryDept = record[basis]; 
                const secondaryKey = basis === 'course_dept' ? 'student_dept' : 'course_dept';
                const secondaryDept = record[secondaryKey];

                let finalGroupingKey = primaryDept; 
                let foundAlliance = allianceGroups.find(group => group.depts.includes(primaryDept));

                if (foundAlliance) {
                    if (foundAlliance.depts.includes(secondaryDept)) {
                        finalGroupingKey = foundAlliance.name;
                    } else {
                        if (unmatchedHandling === 'use_primary') finalGroupingKey = primaryDept;
                        else if (unmatchedHandling === 'use_secondary') finalGroupingKey = secondaryDept; 
                        else if (unmatchedHandling === 'use_alliance_only') finalGroupingKey = primaryDept; 
                    }
                }
                if (!groupedData[finalGroupingKey]) groupedData[finalGroupingKey] = [];
                groupedData[finalGroupingKey].push(record);
            });

            currentConsolidatedResults = {};
            for (const groupName in groupedData) {
                // [排序邏輯] Code -> 學號 -> 學期
                groupedData[groupName].sort((a, b) => {
                    const deptIdA = a.course_dept || '';
                    const deptIdB = b.course_dept || '';
                    const codeA = deptMasterData[deptIdA]?.code || 'ZZZZ';
                    const codeB = deptMasterData[deptIdB]?.code || 'ZZZZ';
                    
                    if (codeA !== codeB) return codeA.toString().localeCompare(codeB.toString());

                    const idA = a.student_id || ''; const idB = b.student_id || '';
                    if (idA !== idB) return idA.localeCompare(idB);
                    
                    const semA = a.semester || ''; const semB = b.semester || '';
                    return semA.localeCompare(semB);
                });
                currentConsolidatedResults[groupName] = groupedData[groupName];
            }
            
            document.getElementById('btn-batch-download-all-results-main').classList.remove('hidden');
            document.getElementById('btn-reopen-mapping').classList.remove('hidden');
            renderInternshipSidebar();
            selectConsolidatedGroup('all'); 

            showMsg('success', '彙整完成', '名單已成功分組與排序，請查看側邊欄結果。');
        }
        
        function renderInternshipSidebar() {
            const el = document.getElementById('internship-group-list');
            el.innerHTML = ''; 
            
            if (!currentConsolidatedResults) return;

            // 1. 取得目前的篩選值
            const filterColId = document.getElementById('internship-sidebar-college-filter')?.value;
            
            // 2. 取得所有分組名稱並先按 Code 排序 (修正：移除 window.)
            let groupNames = Object.keys(currentConsolidatedResults).sort((a, b) => {
                const codeA = (deptMasterData && deptMasterData[a]?.code) || 'ZZZZ'; 
                const codeB = (deptMasterData && deptMasterData[b]?.code) || 'ZZZZ';
                return codeA.toString().localeCompare(codeB.toString());
            });

            // 3. 執行篩選 (找出符合學院的分組)
            let filteredGroupNames = groupNames;
            if (filterColId) {
                // (修正：移除 window.)
                const col = departmentData.find(c => c.id === filterColId);
                if (col) {
                    filteredGroupNames = groupNames.filter(gName => {
                        const gRows = currentConsolidatedResults[gName];
                        const colDepts = col.departments || [];
                        
                        // 判斷依據 A: 分組 ID 本身就在該學院的 departments 清單中
                        if (colDepts.includes(gName)) return true;
                        // 判斷依據 B: 分組內的第一筆資料的 course_dept 屬於該學院 (針對聯盟分組)
                        if (gRows && gRows.length > 0 && colDepts.includes(gRows[0].course_dept)) return true;
                        
                        return false;
                    });
                }
            }

            // 4. 計算篩選後的總筆數
            const totalRecords = filteredGroupNames.reduce((sum, gName) => sum + (currentConsolidatedResults[gName]?.length || 0), 0);
            
            // 5. 渲染「全部」按鈕
            const allLabel = filterColId ? '全部 (篩選後)' : '全部';
            const allActive = currentSelectedGroup === 'all';
            
            el.innerHTML += `<div class="list-item ${allActive ? 'active' : ''}" id="group-all-item" onclick="selectConsolidatedGroup('all')">
                <div class="flex items-center justify-between">
                    <span class="font-bold text-sm">${allLabel}</span>
                    <span class="text-xs bg-primary/10 text-primary px-1.5 py-0.5 rounded ml-2">${totalRecords}</span>
                </div>
            </div>`;
            
            // 空狀態處理
            if (totalRecords === 0) {
                 const msg = filterColId ? '此學院無相關資料' : '無可彙整名單';
                 el.innerHTML += `<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state">${msg}</div>`;
            }

            // 6. 渲染分組列表
            filteredGroupNames.forEach(groupName => {
                const count = (currentConsolidatedResults[groupName] || []).length;
                const isActive = currentSelectedGroup === groupName;
                
                let displayName = groupName;
                const deptName = getDeptDisplayName(groupName, true); 
                if (deptName !== groupName) displayName = deptName;
                else {
                    const colName = getCollegeDisplayName(groupName, true);
                    if (colName !== groupName) displayName = colName;
                }

                const div = document.createElement('div');
                div.className = `list-item ${isActive ? 'active' : ''}`;
                div.onclick = () => selectConsolidatedGroup(groupName);
                div.innerHTML = `<div class="flex items-center justify-between"><span class="font-bold text-sm truncate">${displayName}</span><span class="text-xs bg-primary/10 text-primary px-1.5 py-0.5 rounded">${count}</span></div>`;
                el.appendChild(div);
            });
        }
        
        function selectConsolidatedGroup(groupName) {
            currentSelectedGroup = groupName;
            renderInternshipSidebar(); // 更新側邊欄選取狀態
            
            const filterColId = document.getElementById('internship-sidebar-college-filter')?.value;
            let dataToShow = [];

            if (groupName === 'all') {
                // 1. 取得排序後的分組清單 (修正：移除 window.)
                const sortedKeys = Object.keys(currentConsolidatedResults || {}).sort((a, b) => {
                    const codeA = (deptMasterData && deptMasterData[a]?.code) || 'ZZZZ'; 
                    const codeB = (deptMasterData && deptMasterData[b]?.code) || 'ZZZZ';
                    return codeA.toString().localeCompare(codeB.toString());
                });

                // 2. 遍歷並執行「篩選」
                sortedKeys.forEach(gName => {
                     let include = true;
                     
                     // 如果有設定學院篩選
                     if (filterColId) {
                        // (修正：移除 window.)
                        const col = departmentData.find(c => c.id === filterColId);
                        if (col) {
                            const gRows = currentConsolidatedResults[gName] || [];
                            const colDepts = col.departments || [];
                            
                            // 判斷依據：分組ID符合 OR 資料內容的開課系符合
                            const belongs = colDepts.includes(gName) || 
                                          (gRows.length > 0 && colDepts.includes(gRows[0].course_dept));
                            
                            if (!belongs) include = false;
                        }
                     }
                     
                     if (include) {
                         dataToShow = dataToShow.concat(currentConsolidatedResults[gName] || []);
                     }
                });

                // 更新標題
                const titleSuffix = filterColId ? ' (篩選後)' : '';
                document.getElementById('current-internship-group-title').innerText = `實習學生名單彙整：【全部${titleSuffix}】`;

            } else {
                // 單一分組顯示
                dataToShow = currentConsolidatedResults[groupName] || [];
                
                // 嘗試轉全稱
                let displayName = groupName;
                const deptName = getDeptDisplayName(groupName, false); 
                if (deptName !== groupName) displayName = deptName;
                else {
                    const colName = getCollegeDisplayName(groupName, false);
                    if (colName !== groupName) displayName = colName;
                }
                document.getElementById('current-internship-group-title').innerText = `實習學生名單彙整：【${displayName}】`;
            }
            
            document.getElementById('group-detail-subtitle').innerText = `共 ${dataToShow.length} 筆紀錄`;
            
            // 呼叫渲染表格 (這裡會處理 0 筆資料時顯示 Empty State 的邏輯)
            renderConsolidatedTable(dataToShow);
        }
        
        // Q3: Updated to show Short Name in Preview (Fixed: Strict Column Limit)
        function renderConsolidatedTable(dataToShow) {
            const tableContainer = document.getElementById('results-table-container');
            const emptyState = document.getElementById('results-empty-state');
            const headersRow = document.getElementById('results-table-headers');
            const tbody = document.getElementById('results-table-body');
            
            if (!dataToShow || dataToShow.length === 0) {
                 tableContainer.classList.add('hidden');
                 emptyState.classList.remove('hidden');
                 document.getElementById('current-group-record-count').innerText = 0;
                 
                 // 動態切換空狀態訊息
                 if (currentStudentData && currentStudentData.length > 0) {
                     emptyState.innerHTML = `
                        <div class="w-16 h-16 bg-slate-100 text-slate-400 rounded-full flex items-center justify-center mb-4 text-2xl mx-auto">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 class="font-bold text-slate-600 mb-1">查無符合資料</h4>
                        <p class="text-xs text-slate-400">目前的篩選條件下沒有任何學生紀錄。</p>
                     `;
                 } else {
                     emptyState.innerHTML = `
                        <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl mx-auto">
                            <i class="fas fa-table"></i>
                        </div>
                        請上傳名單，並在彈出視窗中完成欄位匹配。
                     `;
                 }
                 return;
            }

            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            // 1. 取得完整的欄位定義
            const allOutputFields = getFieldsToExport(); 
            const fieldMap = new Map(allOutputFields.map(f => [f.id, f]));
            
            // 2. 嚴格依據 OUTPUT_DISPLAY_FIELDS 產生欄位
            const uiOutputFields = OUTPUT_DISPLAY_FIELDS.map(displayDef => {
                const moduleDef = fieldMap.get(displayDef.id) || {};
                
                // ★★★ [修正重點] 強制指定類型，確保 ID 會被轉譯為簡稱 ★★★
                let effectiveType = moduleDef.type;
                if (['student_dept', 'course_dept'].includes(displayDef.id)) effectiveType = 'department';
                if (['student_college', 'course_college'].includes(displayDef.id)) effectiveType = 'college';
                // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

                return {
                    ...moduleDef,       
                    ...displayDef,      
                    type: effectiveType, // 使用強制修正後的類型
                    dataKey: displayDef.id 
                };
            });

            // 3. 產生標題
            const headers = uiOutputFields.map(f => `<th class="text-center whitespace-nowrap">${f.label.replace(/\s*\(必填\)/g, '')}</th>`).join('');
            headersRow.innerHTML = `<th class="w-12 text-center">#</th>${headers}`;
            document.getElementById('current-group-record-count').innerText = dataToShow.length;
            
            // 4. 產生內容
            const rows = dataToShow.map((row, idx) => {
                const cells = uiOutputFields.map(f => {
                    let displayValue = row[f.dataKey] || '<span class="text-slate-300">-</span>'; 
                    
                    // 預覽時使用簡稱 (useShort = true)
                    if (f.type === 'department') {
                        const deptId = row[f.dataKey];
                        if (deptId) displayValue = getDeptDisplayName(deptId, true) || deptId;
                    } else if (f.type === 'college') {
                         const collegeId = row[f.dataKey];
                         if (collegeId) displayValue = getCollegeDisplayName(collegeId, true) || collegeId;
                    }
                    
                    return `<td class="text-center py-2 text-xs border-b border-slate-50">${displayValue}</td>`;
                }).join('');
                
                return `<tr class="hover:bg-slate-50 transition"><td class="text-center py-3 text-xs font-mono text-slate-400 border-b border-slate-50">${idx + 1}</td>${cells}</tr>`;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        // ✅ 獨立出來的 Dropdown 設定函式 (優先執行)
        function applyDropdown(ws, outputFields, safeEndRow) {
            const validations = [];

            outputFields.forEach((field, colIdx) => {
                // 支援 single_select 與 list 兩種類型
                if ((field.type === "single_select" || field.type === "list") &&
                    field.options && field.options.length) {

                    const colLetter = XLSX.utils.encode_col(colIdx);
                    
                    // 處理選項字串: 轉字串 -> Escape 雙引號 -> 逗號連接
                    const safeOptions = field.options
                        .map(v => v.toString().replace(/"/g, '""'))
                        .join(',');

                    // Excel 限制內嵌清單不可超過 255 字元
                    if (safeOptions.length >= 255) {
                        console.warn("Dropdown too long (skip):", field.label);
                        return;
                    }

                    validations.push({
                        sqref: `${colLetter}2:${colLetter}${safeEndRow}`,
                        type: "list",
                        allowBlank: true,
                        showErrorMessage: true, // 強制顯示錯誤訊息，有助於啟用驗證UI
                        errorTitle: '輸入限制',
                        error: '請從下拉選單中選擇有效的選項',
                        formulas: [`"${safeOptions}"`]
                    });

                    console.log("✅ dropdown ready:", field.label);
                }
            });

            if (validations.length) {
                ws["!dataValidation"] = validations;
            }
        }

        // ★★★ 核心引擎：ExcelJS 範圍批次設定版 (強制生效) ★★★
        async function createExcelBuffer(groupName, groupData, outputFields, outputYear) {
            const workbook = new ExcelJS.Workbook();
            const worksheet = workbook.addWorksheet(groupName === 'all' ? '總表' : groupName);

            // 1. 設定欄位標頭 (Columns)
            const columns = outputFields.map(f => {
                let len = 0;
                for (let i = 0; i < f.label.length; i++) {
                    len += (f.label.charCodeAt(i) > 255) ? 2 : 1;
                }
                const width = f.excelWidth ? parseInt(f.excelWidth) : Math.min(Math.max(len + 2, 12), 50);
                
                return {
                    header: f.label.replace(/\s*\(必填\)/g, ''),
                    key: f.dataKey,
                    width: width
                };
            });
            worksheet.columns = columns;

            // 2. 處理資料並填入
            const rows = groupData.map(row => {
                const rowObj = {};
                outputFields.forEach(f => {
                    let cellValue = row[f.dataKey] || '';
                    if (f.type === 'department') {
                        const deptId = row[f.dataKey];
                        if (deptId) cellValue = getDeptDisplayName(deptId, false, outputYear) || deptId;
                    } else if (f.type === 'college') {
                         const collegeId = row[f.dataKey];
                         if (collegeId) cellValue = getCollegeDisplayName(collegeId, false) || collegeId;
                    }
                    rowObj[f.dataKey] = cellValue;
                });
                return rowObj;
            });
            worksheet.addRows(rows);

            // 3. 定義樣式
            const fontStyle = { name: 'Microsoft JhengHei', size: 11 };
            const headerFont = { name: 'Microsoft JhengHei', size: 12, bold: true, color: { argb: 'FFFFFFFF' } };
            const thinBorder = { style: 'thin', color: { argb: 'FFB2B2B2' } };
            const borderStyle = { top: thinBorder, left: thinBorder, bottom: thinBorder, right: thinBorder };
            
            // 4. 設定所有儲存格樣式 (含標頭)
            const safeEndRow = Math.max(rows.length + 100, 100); // 確保樣式涵蓋到下方空白區

            // 針對每一列、每一格設定基本樣式
            for (let r = 1; r <= safeEndRow; r++) {
                // 確保 Row 物件存在
                const row = worksheet.getRow(r);
                
                outputFields.forEach((field, idx) => {
                    const cell = row.getCell(idx + 1);
                    
                    cell.border = borderStyle;
                    cell.alignment = { vertical: 'middle', wrapText: true };
                    
                    if (r === 1) {
                        cell.font = headerFont;
                        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + getCategoryColor(field.category) } };
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    } else {
                        cell.font = fontStyle;
                        if (field._isMapped && r <= rows.length + 1) { // 只有資料區才顯示灰底
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
                        } else {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFFF' } };
                        }
                    }
                });
            }

            // 5. ★★★ 關鍵修正：使用 dataValidations.add 進行批次範圍設定 ★★★
            // 這種寫法對應 Excel 內部的 <dataValidations> 標籤，比單一儲存格設定更穩定
            
            outputFields.forEach((field, idx) => {
                if ((field.type === 'single_select' || field.type === 'list') && 
                    field.options && field.options.length > 0) {
                    
                    // 1. 取得欄位英文字母 (例如 A, B, AA)
                    const colLetter = worksheet.getColumn(idx + 1).letter;
                    
                    // 2. 定義套用範圍 (從第 2 列到 safeEndRow)
                    const range = `${colLetter}2:${colLetter}${safeEndRow}`;
                    
                    // 3. 處理選項字串 (轉義雙引號)
                    const safeOptions = field.options.map(o => o.toString().replace(/"/g, '""').trim()).join(',');
                    
                    if (safeOptions.length < 255) {
                        // 4. 準備規則物件
                        const rule = {
                            type: 'list',
                            allowBlank: true,
                            showErrorMessage: true,
                            errorTitle: '輸入限制',
                            error: '請從下拉選單中選擇有效項目',
                            formulas: [`"${safeOptions}"`] // 標準寫法: 雙引號包字串
                        };

                        // ★ 相容性修正：同時寫入 formulae 屬性 (針對部分舊版 ExcelJS 或特定環境)
                        rule.formulae = rule.formulas;

                        // 5. 加入驗證規則到 Worksheet
                        worksheet.dataValidations.add(range, rule);
                        
                        console.log(`[Excel] 範圍下拉設定成功: ${range} => "${safeOptions}"`);
                    } else {
                        // 字串過長，略過 (改為提示)
                        console.warn(`[Excel] 欄位 [${field.label}] 選項過長，略過下拉`);
                    }
                }
            });

            // 產生 Buffer
            const buffer = await workbook.xlsx.writeBuffer();
            return buffer;
        }

        async function downloadBatch(groupName) {
            const groupData = groupName === 'all' ? Object.values(currentConsolidatedResults).flat() : currentConsolidatedResults[groupName];
            if (!groupData || groupData.length === 0) return;

            // 準備欄位設定
            const allOutputFields = getFieldsToExport().map(f => ({
                ...f,
                _isMapped: !!(currentMapping[f.id] && currentMapping[f.id].excelHeader)
            }));
            
            const outputYear = currentConsolidationYear || activeYearId || '';

            try {
                // 1. 呼叫新的核心引擎取得 Buffer (您的 Log 就是從這裡印出來的)
                const buffer = await createExcelBuffer(groupName, groupData, allOutputFields, outputYear);
                
                // 2. ★★★ 關鍵：必須使用 Blob + saveAs 來下載，不能用 XLSX.writeFile ★★★
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const filename = `【${currentConsolidationYear}學年度修課】校庫填報清單-${groupName === 'all' ? '總表' : groupName}.xlsx`;
                
                // 使用 FileSaver.js 的 saveAs
                saveAs(blob, filename);
                
            } catch (e) {
                console.error(e);
                showMsg('error', '匯出失敗', '產生 Excel 檔案時發生錯誤：' + e.message);
            }
        }
        
        async function downloadAllGroupsZip() {
            if (!currentConsolidatedResults || Object.keys(currentConsolidatedResults).length === 0) {
                 return showMsg('info', '無資料', '目前沒有可供下載的彙整名單。');
            }

            const btn = document.getElementById('btn-batch-download-all-results-main');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner border-slate-500 border-t-white"></div> 打包中...';

            const zip = new JSZip();
            
            const allOutputFields = getFieldsToExport().map(f => ({
                ...f,
                _isMapped: !!(currentMapping[f.id] && currentMapping[f.id].excelHeader)
            }));
            const outputYear = currentConsolidationYear || activeYearId || '';

            try {
                for (const groupName in currentConsolidatedResults) {
                    const groupData = currentConsolidatedResults[groupName];
                    
                    // ★★★ 改用 ExcelJS 生成 Buffer ★★★
                    const buffer = await createExcelBuffer(groupName, groupData, allOutputFields, outputYear);
                    
                    const filename = `【${currentConsolidationYear}學年度修課】校庫填報清單-${groupName}.xlsx`;
                    zip.file(filename, buffer, { binary: true });
                }
                
                // 產生 ZIP
                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, `${currentConsolidationYear}_全系實習彙整名單.zip`);
                showMsg('success', '打包完成', '全系實習名單已打包成 ZIP 檔案開始下載。');

            } catch (e) {
                console.error(e);
                showMsg('error', '打包失敗', `建立 ZIP 檔案時發生錯誤：${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-archive"></i> 全系批次下載 (打包ZIP)';
            }
        }


        // --- Alliance Modal Logic (Multi-Group Support) ---
        // Q2: Ensure openAllianceModal uses current year data
        function openAllianceModal() {
            if (!activeYearId) {
                 return showMsg('info', '無效操作', '請先在「學年度模組配置」中選擇一個學年度。');
            }
            // Use the globally loaded departmentData for the unique list of departments
            uniqueCourseDepts = [];
            departmentData.forEach(college => {
                college.departments.forEach(deptId => {
                    // Use the full name for grouping/mapping display (based on current active year)
                    uniqueCourseDepts.push(getDeptDisplayName(deptId, false, activeYearId)); 
                });
            });
            uniqueCourseDepts = [...new Set(uniqueCourseDepts)].sort();

            renderAllianceRules();
            document.getElementById('alliance-modal').classList.remove('hidden');
        }
        
        // Q2: Render Alliance Rules using yearTemplateData
        function renderAllianceRules() {
            const container = document.getElementById('alliance-rules-container');
            // Q2: Use the alliance data stored in the current year's template data
            const allianceConfig = yearTemplateData.allianceModeDepts || { groups: [], groupingBasis: 'course_dept', unmatchedHandling: 'use_primary' };
            const allianceGroups = allianceConfig.groups || []; 

            // Set the configuration dropdowns
            document.getElementById('alliance-grouping-basis').value = allianceConfig.groupingBasis || 'course_dept';
            document.getElementById('alliance-unmatched-handling').value = allianceConfig.unmatchedHandling || 'use_primary';

            if (uniqueCourseDepts.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400">目前無法取得學系清單，請至「系所清單管理」設定。</div>';
                return;
            }

            let groupsHtml = allianceGroups.map((group, groupIndex) => {
                const deptCheckboxes = uniqueCourseDepts.map(dept => {
                    const isChecked = group.depts.includes(dept);
                    return `
                        <label class="flex items-center p-2 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-primary transition">
                            <input type="checkbox" data-dept="${dept}" ${isChecked ? 'checked' : ''} class="custom-checkbox mr-3 alliance-dept-check" data-group-index="${groupIndex}">
                            <span class="text-sm font-bold text-slate-700">${dept}</span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="logic-card p-4 relative bg-white border border-slate-200 rounded-xl space-y-3 shadow-sm" data-group-index="${groupIndex}">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <input type="text" value="${group.name}" data-group-index="${groupIndex}" oninput="updateAllianceGroupName(${groupIndex}, this.value)" class="text-base font-bold text-slate-800 bg-transparent border-b border-slate-300 focus:outline-none focus:border-primary w-2/3">
                            <button onclick="removeAllianceGroup(${groupIndex})" class="text-slate-400 hover:text-danger p-1"><i class="fas fa-trash-alt"></i> 刪除聯盟</button>
                        </div>
                        <p class="text-sm font-bold text-primary flex items-center gap-1"><i class="fas fa-users text-sm"></i> 聯盟學系清單：</p>
                        <div class="grid grid-cols-2 gap-3 alliance-checkboxes-group" data-group-index="${groupIndex}">
                            ${deptCheckboxes}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="mb-4 flex justify-end">
                    <button onclick="addAllianceGroup()" class="btn-create py-2.5 px-4 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2"><i class="fas fa-users-cog"></i> 新增聯盟分組</button>
                </div>
                ${groupsHtml}
                ${allianceGroups.length === 0 ? '<div class="p-8 text-center text-slate-400 border border-dashed rounded-lg border-slate-300">點擊上方按鈕新增第一個聯盟分組</div>' : ''}
            `;
        }

        // Q2: Add Alliance Group to yearTemplateData
        function addAllianceGroup() {
            if (!yearTemplateData.allianceModeDepts.groups) yearTemplateData.allianceModeDepts.groups = [];
            yearTemplateData.allianceModeDepts.groups.push({
                id: 'alliance_' + Date.now(),
                name: '新聯盟分組 ' + (yearTemplateData.allianceModeDepts.groups.length + 1),
                depts: []
            });
            renderAllianceRules();
            setUnsaved(true);
        }
        
        // Q2: Remove Alliance Group from yearTemplateData
        function removeAllianceGroup(index) {
            showMsg('confirm', '確認刪除聯盟？', '刪除後，該聯盟內的學系將恢復為依分組依據獨立分組。', null, () => {
                yearTemplateData.allianceModeDepts.groups.splice(index, 1);
                renderAllianceRules();
                setUnsaved(true);
            });
        }
        
        // Q2: Update Alliance Group Name in yearTemplateData
        function updateAllianceGroupName(index, newName) {
            if (yearTemplateData.allianceModeDepts.groups[index]) {
                yearTemplateData.allianceModeDepts.groups[index].name = newName;
            }
        }
        
        // Q2: Save Alliance Rules into yearTemplateData
        function saveAllianceRules() {
            const groupsContainer = document.getElementById('alliance-rules-container');
            const newGroups = [];
            const deptToGroupMap = new Map();
            let overlapDetected = false;

            // 1. Get global configuration
            const groupingBasis = document.getElementById('alliance-grouping-basis').value;
            const unmatchedHandling = document.getElementById('alliance-unmatched-handling').value;
            
            yearTemplateData.allianceModeDepts.groupingBasis = groupingBasis;
            yearTemplateData.allianceModeDepts.unmatchedHandling = unmatchedHandling;
            
            const originalGroups = yearTemplateData.allianceModeDepts.groups;

            // 2. Process all alliance groups
            groupsContainer.querySelectorAll('.logic-card[data-group-index]').forEach(groupEl => {
                const nameInput = groupEl.querySelector('input[type="text"]');
                const groupIndex = parseInt(groupEl.dataset.groupIndex); 
                
                // Find the original group object using the index
                const group = originalGroups.find((_, i) => i === groupIndex) || { id: 'alliance_' + Date.now() }; 
                
                const checkedDepts = Array.from(groupEl.querySelectorAll('.alliance-dept-check:checked'))
                    .map(cb => cb.dataset.dept);
                
                
                checkedDepts.forEach(dept => {
                    if (deptToGroupMap.has(dept)) {
                        overlapDetected = true;
                    }
                    deptToGroupMap.set(dept, nameInput.value.trim());
                });
                
                group.name = nameInput.value.trim();
                group.depts = checkedDepts;
                newGroups.push(group);
            });
            
            if (overlapDetected) {
                 showMsg('error', '儲存失敗', '偵測到學系重複出現在不同的聯盟分組中，請修正後再儲存。');
                 return;
            }

            yearTemplateData.allianceModeDepts.groups = newGroups.filter(g => g.depts.length > 0); 
            
            setUnsaved(true);
            document.getElementById('alliance-modal').classList.add('hidden');
            showMsg('success', '儲存成功', `已儲存 ${yearTemplateData.allianceModeDepts.groups.length} 個聯盟分組到 ${activeYearId} 學年度模組。`);
        }

        // --- Logic Summary & Conflict Detection ---
        function openLogicSummary(type) {
            activeLogicEdit = null; 
            renderLogicList(type);
            document.getElementById('logic-modal').classList.remove('hidden');
        }

        function renderLogicList(type) {
            const list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            const fieldMap = new Map(list.map(f => [f.id, f.label]));
            const fieldOptions = new Map(list.filter(f=>f.type==='single_select' && f.options).map(f => [f.id, f.options]));
            
            const conflicts = [];
            const checkDep = (fId, depId, ruleType, triggerVal) => {
                if(!depId) return false;
                let isValid = true;
                if(fId === depId) { conflicts.push(`🔴 <b>鬼打牆</b>：欄位 [${fieldMap.get(fId)}] 不能依賴自己，這會造成當機。`); isValid = false; }
                else if(!fieldMap.has(depId)) { conflicts.push(`🔴 <b>找不到源頭</b>：規則依賴 [${depId}]，但該欄位已消失。`); isValid = false; }
                else if(triggerVal && fieldOptions.has(depId)) {
                    if(!fieldOptions.get(depId).includes(triggerVal)) { conflicts.push(`🟠 <b>條件無效</b>：[${fieldMap.get(depId)}] 沒有選項 '${triggerVal}'，規則永遠不會觸發。`); isValid = false; }
                }
                return isValid;
            };

            const visited = new Set(); const recursionStack = new Set();
            const detectCycle = (currId, startId, path) => {
                if(recursionStack.has(currId)) { if(currId === startId) conflicts.push(`🔴 <b>邏輯死結</b>：${path.join(' -> ')} -> ${startId}，會導致系統崩潰。`); return; }
                if(visited.has(currId)) return; visited.add(currId); recursionStack.add(currId);
                const f = list.find(x => x.id === currId);
                if(f && f.visibilityRule && f.visibilityRule.dep) detectCycle(f.visibilityRule.dep, startId, [...path, f.visibilityRule.dep]);
                recursionStack.delete(currId);
            };

            let visHtml = '', optHtml = '', visCount = 0, optCount = 0;

            list.forEach((f, fIdx) => {
                if(f.visibilityRule && f.visibilityRule.dep) {
                    visCount++;
                    const isValid = checkDep(f.id, f.visibilityRule.dep, 'Vis', f.visibilityRule.val);
                    detectCycle(f.id, f.id, [f.id]);
                    visHtml += renderLogicRow(f, f.visibilityRule, 'vis', fIdx, type, fieldMap, fieldOptions, null, isValid);
                }
                const rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                if(rules.length > 0) {
                    rules.forEach((r, rIdx) => {
                        optCount++;
                        const isValid = checkDep(f.id, r.dep, 'Opt', r.val);
                        optHtml += renderLogicRow(f, r, 'opt', fIdx, type, fieldMap, fieldOptions, rIdx, isValid);
                    });
                }
            });

            document.getElementById('vis-list').innerHTML = visHtml || '<div class="text-center text-slate-400 py-4">無設定</div>';
            document.getElementById('opt-list').innerHTML = optHtml || '<div class="text-center text-slate-400 py-4">無設定</div>';
            document.getElementById('vis-count').innerText = visCount;
            document.getElementById('opt-count').innerText = optCount;

            const cEl = document.getElementById('logic-conflicts');
            if(conflicts.length > 0) { cEl.classList.remove('hidden'); document.getElementById('conflict-list').innerHTML = [...new Set(conflicts)].map(c => `<li>${c}</li>`).join(''); } else cEl.classList.add('hidden');
        }

        function renderLogicRow(field, rule, type, fIdx, listType, fieldMap, fieldOptions, ruleIdx = null, isValid = true) {
            const isEditing = activeLogicEdit && activeLogicEdit.id === field.id && activeLogicEdit.type === type && activeLogicEdit.ruleIdx === ruleIdx;
            
            let statusHtml = '<span class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i> 邏輯檢測通過</span>';
            const depName = fieldMap.get(rule.dep) || rule.dep;
            const depValid = fieldMap.has(rule.dep);
            const valValid = !depValid || !fieldOptions.has(rule.dep) || fieldOptions.get(rule.dep).includes(rule.val);
            
            if(!depValid) statusHtml = '<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-circle"></i> 錯誤：找不到依賴對象</span>';
            else if(!valValid) statusHtml = `<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-triangle"></i> 錯誤：[${depName}] 沒有選項 '${rule.val}'</span>`;

            if(isEditing) {
                let depOpts = '<option value="">請選擇...</option>';
                fieldMap.forEach((label, id) => { if(id !== field.id) depOpts += `<option value="${id}" ${id===rule.dep?'selected':''}>${label} (${id})</option>`; });
                let valInput = fieldOptions.has(rule.dep) ? `<select id="edit-val" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"><option value="">請選擇...</option>` + fieldOptions.get(rule.dep).map(o => `<option value="${o}" ${o===rule.val?'selected':''}>${o}</option>`).join('') + `</select>` : `<input id="edit-val" value="${rule.val}" class="w-full border border-slate-300 rounded p-1.5 text-sm focus:ring-2 focus:ring-primary outline-none" placeholder="輸入值">`;

                let actionSelect = '';
                if(type === 'vis') {
                    actionSelect = `<div><label class="text-[10px] text-slate-500 font-bold block mb-1">動作 (Action)</label><select id="edit-action" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"><option value="show" ${rule.action!=='hide'?'selected':''}>顯示 (Show)</option><option value="hide" ${rule.action==='hide'?'selected':''}>隱藏 (Hide)</option></select></div>`;
                }

                return `<div class="bg-white border border-slate-200 border-l-4 border-l-primary rounded-lg p-4 mb-3 shadow-sm">
                    <div class="flex justify-between items-center mb-4"><span class="font-bold text-slate-800">編輯規則 (${field.label})</span><div class="text-right">${statusHtml}</div></div>
                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-[10px] text-slate-500 font-bold block mb-1">依賴對象 (決定者)</label><select id="edit-dep" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none" onchange="updateLogicEditState('${field.id}','${type}',${fIdx},'${listType}',${ruleIdx}, this.value)">${depOpts}</select></div><div><label class="text-[10px] font-bold text-slate-500 block mb-1">當內容是 (條件值)</label>${valInput}</div>${actionSelect}</div>
                    <div class="flex justify-end gap-2"><button onclick="cancelLogicEdit('${listType}')" class="px-3 py-1.5 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50 font-bold text-slate-600 transition">取消</button><button onclick="saveLogicEdit('${field.id}', '${type}', ${fIdx}, '${listType}', ${ruleIdx})" class="px-3 py-1.5 bg-primary text-white rounded text-xs hover:bg-[#001e3d] shadow-sm font-bold transition">確認變更</button></div></div>`;
            } else {
                const displayVal = `<span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-mono text-xs font-bold">${rule.val}</span>`;
                const actionText = (type === 'vis' && rule.action === 'hide') ? '<span class="text-red-600 font-bold">隱藏</span>' : '<span class="text-primary font-bold">顯示</span>';
                const content = type === 'vis' ? `<span class="font-bold text-primary">${field.label}</span>：當 <span class="font-bold text-slate-700">${depName}</span> 是 ${displayVal} 時 ${actionText}` : `<span class="font-bold text-emerald-600">${field.label}</span> 連動規則：當 <span class="font-bold text-slate-700">${depName}</span> 是 ${displayVal}，顯示 [${rule.limitTo?.join(', ')}]`;
                
                const actionBtn = isValid ? '' : `<button onclick="promptEditChoice('${field.id}', '${rule.dep}', '${listType}', '${type}', ${ruleIdx}, '${rule.val}')" class="text-slate-300 hover:text-primary transition p-1.5 rounded-full hover:bg-slate-100" title="修正設定"><i class="fas fa-pencil-alt"></i></button>`;
                
                const warnIcon = (!isValid) ? '<i class="fas fa-exclamation-triangle text-red-500 mr-2 animate-pulse"></i>' : '<i class="fas fa-check-circle text-green-500 mr-2 opacity-50"></i>';
                return `<div class="p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex justify-between items-center group transition"><div class="text-sm flex items-center">${warnIcon} ${content}</div><button onclick="startLogicEdit('${field.id}', '${type}', ${ruleIdx}, '${listType}')" class="text-slate-300 hover:text-primary transition p-1.5 rounded-full hover:bg-slate-100" title="編輯設定"><i class="fas fa-pencil-alt"></i></button>${actionBtn}</div>`;
            }
        }

        function startLogicEdit(id, type, ruleIdx, listType) { activeLogicEdit = { id, type, ruleIdx }; renderLogicList(listType); }
        function cancelLogicEdit(listType) { activeLogicEdit = null; renderLogicList(listType); }
        function updateLogicEditState(id, type, fIdx, listType, ruleIdx, newDep) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule); rule.dep = newDep; renderLogicList(listType);
        }
        function saveLogicEdit(id, type, fIdx, listType, ruleIdx) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule);
            rule.dep = document.getElementById('edit-dep').value; rule.val = document.getElementById('edit-val').value;
            if(type === 'vis') rule.action = document.getElementById('edit-action').value;
            setUnsaved(true); activeLogicEdit = null; renderLogicList(listType);
        }

        function promptEditChoice(fId, depId, listType, type, ruleIdx, missingVal) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields;
            const f = list.find(x => x.id === fId);
            const dep = list.find(x => x.id === depId);
            
            document.getElementById('btn-edit-self').onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); startLogicEdit(fId, type, ruleIdx, listType); };
            
            const btnFix = document.getElementById('btn-fix-source');
            if(dep && missingVal) { btnFix.classList.remove('hidden'); btnFix.onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); showImpactModal(dep, missingVal, list); }; } else { btnFix.classList.add('hidden'); }
            document.getElementById('choice-modal').classList.remove('hidden');
        }

        function openAddrRules() {
            document.getElementById('addr-protected').value = configData.addressRules?.protected?.join(', ') || '';
            document.getElementById('addr-keywords').value = configData.addressRules?.keywords?.join(', ') || '';
            document.getElementById('addr-specials').value = configData.addressRules?.specials?.join(', ') || '';
            document.getElementById('addr-rules-modal').classList.remove('hidden');
        }
        function saveAddrRules() {
            configData.addressRules = {
                protected: document.getElementById('addr-protected').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x),
                keywords: document.getElementById('addr-keywords').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x),
                specials: document.getElementById('addr-specials').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x)
            };
            setUnsaved(true); document.getElementById('addr-rules-modal').classList.add('hidden'); showMsg('success', '成功', '地址規則已更新');
        }

        function showImpactModal(depField, newVal, contextList) {
            document.getElementById('imp-dep-name').innerText = depField.label; document.getElementById('imp-val').innerText = newVal;
            let count = 0;
            contextList.forEach(f => { if(f.visibilityRule?.dep === depField.id) count++; if(f.filterRules) f.filterRules.forEach(r => { if(r.dep === depField.id) count++; }); else if(f.filterRule?.dep === depField.id) count++; });
            document.getElementById('imp-count').innerText = count;
            document.getElementById('btn-confirm-fix').onclick = () => {
                if(!depField.options) depField.options = []; if(!depField.options.includes(newVal)) depField.options.push(newVal);
                document.getElementById('impact-modal').classList.add('hidden'); setUnsaved(true); renderLogicList(targetList); showMsg('success', '修復成功', `已將 '${newVal}' 加入 [${depField.label}] 的選項中。`);
            };
            document.getElementById('impact-modal').classList.remove('hidden');
        }

        function prepEditor(f = {}) {
            window.currentOptions = f.options || [];
            window.currentOptionDescs = f.optionDescriptions || {};
            window.currentRules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
            editingOptionIdx = -1;
            isOptionBatchMode = false;
            activeLogicEdit = null;

            document.getElementById('editor-title').innerText = isEditMode ? '編輯欄位' : '建立新欄位';
            document.getElementById('ed-orig-id').value = f.id || '';
            document.getElementById('ed-field-id').value = f.id || ''; document.getElementById('ed-field-id').readOnly = isEditMode && targetList !== 'global';
            document.getElementById('ed-label').value = f.label || '';
            document.getElementById('ed-desc').value = f.description || ''; 
            
            // Point 2 Fix: Use the field's category if editing, or the active view's category if adding new.
            const categoryToSelect = f.category || (!isEditMode && activeCatId !== 'all' && activeCatId !== 'uncategorized' ? activeCatId : '');
            
            document.getElementById('ed-required').checked = f.required || false;
            f.isSystem = f.isSystem || SYSTEM_FIELDS.some(sf => sf.id === f.id && sf.isSystem); // Inherit system flag if ID matches
            document.getElementById('ed-system').checked = f.isSystem || false; toggleSystemHint(f.isSystem);

            const catSel = document.getElementById('ed-category'); 
            catSel.innerHTML = '<option value="">未分類</option>';
            configData.templateCategories.forEach(c => {
                 catSel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            
            // Apply the determined category
            if(categoryToSelect) catSel.value = categoryToSelect;

            const typeSel = document.getElementById('ed-type'); typeSel.innerHTML = '';
            configData.fieldTypes.forEach(t => typeSel.innerHTML += `<option value="${t.key}" ${f.type===t.key?'selected':''}>${t.label}</option>`);
            if(!f.type) typeSel.value = 'text';

            const visToggle = document.getElementById('vis-toggle');
            const visSettings = document.getElementById('vis-settings');
            const visLabel = document.getElementById('vis-label');
            
            if(f.visibilityRule && f.visibilityRule.dep) {
                visToggle.checked = true; visSettings.classList.remove('hidden'); visLabel.innerText = "已啟用顯示條件"; visLabel.className = "ml-3 text-xs font-bold text-primary"; 
            } else {
                visToggle.checked = false; visSettings.classList.add('hidden'); visLabel.innerText = "總是顯示 (預設)"; visLabel.className = "ml-3 text-xs font-medium text-slate-600";
            }

            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const visDepSel = document.getElementById('ed-vis-dep'); visDepSel.innerHTML = '<option value="">請選擇...</option>';
            allFields.filter(x => x.id !== f.id).forEach(x => visDepSel.innerHTML += `<option value="${x.id}" ${f.visibilityRule?.dep===x.id?'selected':''}>${x.label} (${x.id})</option>`);
            document.getElementById('ed-vis-val').value = f.visibilityRule?.val || '';
            document.getElementById('ed-vis-action').value = f.visibilityRule?.action || 'show'

            document.getElementById('editor-modal').dataset.curr = JSON.stringify(f);
            document.getElementById('editor-modal').classList.remove('hidden');
            renderOpts();
        }

        function toggleVisSettings(checked) {
            const el = document.getElementById('vis-settings'), lbl = document.getElementById('vis-label');
            if(checked) { el.classList.remove('hidden'); lbl.innerText="已啟用顯示條件"; lbl.className="ml-3 text-xs font-bold text-primary"; }
            else { el.classList.add('hidden'); lbl.innerText="總是顯示 (預設)"; lbl.className="ml-3 text-xs font-medium text-slate-600"; }
        }

        function toggleSystemHint(checked) { 
            const req = document.getElementById('ed-required');
            if(checked) { req.checked = true; req.disabled = true; } else { req.disabled = false; }
        }

        function toggleAdvanced(id, checked) {
            const el = document.getElementById(id);
            if(checked) { el.classList.remove('hidden'); }
            else {
                const toggleId = id.replace('panel', 'toggle');
                if(el.querySelectorAll('input').length > 0) {
                    document.getElementById(toggleId).checked = true; 
                    showMsg('confirm', '確認關閉？', '關閉後將清除此區塊的設定，確定嗎？', null, () => {
                        document.getElementById(toggleId).checked = false;
                        el.classList.add('hidden'); 
                    });
                } else {
                    el.classList.add('hidden');
                }
            }
        }

        function toggleOptionMode() {
            isOptionBatchMode = !isOptionBatchMode;
            renderOpts();
        }

        function toggleOptDesc(checked) {
            renderOptionList();
        }

        function renderOpts() {
            const type = document.getElementById('ed-type').value;
            const container = document.getElementById('ed-opts-container');
            const f = JSON.parse(document.getElementById('editor-modal').dataset.curr || '{}');
            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join('');

            let html = '';
            
            // Disable option configuration for special types
            const isSpecialDeptType = type === 'college' || type === 'department';
            if (isSpecialDeptType) {
                 container.innerHTML = `
                    <div class="p-6 bg-indigo-50 border border-indigo-200 rounded-lg mt-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-info-circle text-indigo-700 text-lg"></i>
                            <h4 class="text-sm font-bold text-indigo-700">自動選項類型</h4>
                        </div>
                        <p class="text-xs text-indigo-600 mt-2">此類型（${type === 'college' ? '學院' : '學系'}）的選項由 <span class="font-mono font-bold">data_departments.json</span> 自動提供，無法在此編輯或設定連動規則。</p>
                    </div>
                `;
                 return;
            }

            
            if(type === 'single_select') {
                const hasRules = (f.filterRules && f.filterRules.length > 0) || !!f.filterRule;
                const hasDesc = f.optionDescriptions && Object.keys(f.optionDescriptions).length > 0;
                
                let optionEditorHtml = '';
                if(isOptionBatchMode) {
                    const textVal = (window.currentOptions || []).join('\n');
                    optionEditorHtml = `<div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"><div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><h4 class="text-sm font-bold text-slate-700">選項管理 (文字模式)</h4><button onclick="toggleOptionMode()" class="text-primary text-xs font-bold hover:underline"><i class="fas fa-list"></i> 切換列表模式</button></div><textarea id="ed-opt-textarea" class="w-full h-48 p-4 text-sm outline-none resize-none" placeholder="請輸入選項，一行一個..." oninput="syncBatchOptions()">${textVal}</textarea><div class="p-2 bg-slate-50 text-[10px] text-slate-400 text-right">每行代表一個選項，切換回列表模式可設定說明</div></div>`;
                } else {
                    optionEditorHtml = `<div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-col gap-3">
                            <div class="flex justify-between items-center">
                                <div class="flex gap-4 items-center"><h4 class="text-sm font-bold text-slate-700">選項管理</h4><button onclick="toggleOptionMode()" class="text-primary text-xs font-bold hover:underline"><i class="fas fa-edit"></i> 切換文字模式</button></div>
                                <label class="flex items-center cursor-pointer hover:text-primary transition"><input type="checkbox" id="ed-opt-desc-toggle" class="custom-checkbox mr-2" ${hasDesc?'checked':''} onchange="toggleOptDesc(this.checked)"><span class="text-xs font-bold text-slate-600">啟用選項說明</span></label>
                            </div>
                            <div class="flex gap-2 mt-1"><div class="relative flex-grow"><i class="fas fa-plus absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i><input id="ed-new-opt" class="w-full pl-8 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none transition bg-white" placeholder="輸入新選項名稱..." onkeydown="if(event.key==='Enter') addOption()"></div><button onclick="addOption()" class="bg-primary hover:bg-[#001e3d] text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm flex-shrink-0">新增</button></div>
                        </div>
                        <table class="w-full opt-table"><thead><tr><th class="w-12 text-center">序</th><th>選項內容</th><th id="th-desc" class="hidden">說明文字</th><th class="w-32 text-right">操作</th></tr></thead><tbody id="ed-opt-list-body"></tbody></table>
                    </div>`;
                }

                html = `
                <div class="space-y-6">
                    <div>${optionEditorHtml}</div>
                    
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg border">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-random"></i> 進階屬性設定 (Advanced)</h4><p class="text-[11px] text-slate-400 mt-1">設定連動邏輯與其他進階選項。</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-logic-toggle" class="sr-only peer" ${hasRules?'checked':''} onchange="toggleAdvanced('adv-logic-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                        </div>
                        <div id="adv-logic-panel" class="${hasRules?'':'hidden'} bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex justify-between items-center mb-4"><h4 class="text-sm font-bold text-slate-700 flex items-center gap-2">連動規則設定</h4><button onclick="addRule()" class="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1 rounded hover:bg-indigo-50 transition font-bold">+ 新增規則</button></div>
                            <div id="rule-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>`;
                
                let rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                setTimeout(() => { 
                    if(!window.currentOptions || window.currentOptions.length === 0 && f.options) window.currentOptions = f.options || [];
                    if(Object.keys(window.currentOptionDescs).length === 0 && f.optionDescriptions) window.currentOptionDescs = f.optionDescriptions || {};
                    window.currentRules = rules; 
                    if(!isOptionBatchMode) renderOptionList(); 
                    renderRules(rules, depOpts); 
                }, 0);

            } else if (type === 'text') {
                const hasMaxLen = !!f.maxLen;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-sliders-h"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-text-toggle" class="sr-only peer" ${hasMaxLen?'checked':''} onchange="toggleAdvanced('adv-text-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-text-panel" class="${hasMaxLen?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200">
                        <label class="text-sm font-bold text-slate-700 mb-1 block">字元上限 (Max Length)</label>
                        <input type="number" id="ed-maxlen" class="w-full border border-slate-300 rounded p-2 text-sm" value="${f.maxLen||''}" placeholder="例如: 20">
                        <p class="text-[10px] text-slate-400 mt-1">(中英數符號皆算 1 字)</p>
                    </div>
                </div>`;

            } else if (type === 'address') { // v30.0: Address Type UI (Refined)
                const hasAddrSet = f.latinToEng || f.toHalf || f.forceTai || f.smartFormat;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> 智慧地址處理 (Smart Address)</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-addr-toggle" class="sr-only peer" ${hasAddrSet?'checked':''} onchange="toggleAdvanced('adv-addr-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-addr-panel" class="${hasAddrSet?'':'hidden'} p-5 bg-white rounded-lg border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-latin-to-eng" ${f.latinToEng?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔠 拉丁文轉英文 (é->e)</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-to-half" ${f.toHalf?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔠 自動全形轉半形 (Ａ->A)</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-force-tai" ${f.forceTai?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🇹🇼 強制「台」轉「臺」</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-smart-fmt" ${f.smartFormat?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔢 智慧路名數字轉換</span></label>
                        </div>
                    </div>
                </div>`;

            } else if (type === 'number') {
                const hasNumSet = f.calcMode === 'average' || f.decimal > 0 || f.keepZero;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-calculator"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-num-toggle" class="sr-only peer" ${hasNumSet?'checked':''} onchange="toggleAdvanced('adv-num-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-num-panel" class="${hasNumSet?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-sm font-bold text-slate-700 mb-1 block">數值模式</label><select id="ed-mode" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="copy">一般/複製</option><option value="average" ${f.calcMode==='average'?'selected':''}>自動平均</option></select></div>
                            <div><label class="text-sm font-bold text-slate-700 mb-1 block">小數位數</label><input type="number" id="ed-dec" class="w-full border border-slate-300 rounded p-2 text-sm" value="${f.decimal||0}"></div>
                        </div>
                        <div><label class="flex items-center text-sm font-bold text-slate-700 cursor-pointer"><input type="checkbox" id="ed-keepZero" ${f.keepZero?'checked':''} class="custom-checkbox mr-2"> 保留前導零 (00123)</label></div>
                    </div>
                </div>`;

            } else if (type === 'date') {
                const hasDateSet = f.inputFormat || f.outputFormat || f.precision;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-calendar-alt"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-date-toggle" class="sr-only peer" ${hasDateSet?'checked':''} onchange="toggleAdvanced('adv-date-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-date-panel" class="${hasDateSet?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200 grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">填報顯示</label><select id="ed-date-in" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="ROC" ${f.inputFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.inputFormat==='West'?'selected':''}>西元</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">檔案輸出</label><select id="ed-date-out" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="ROC" ${f.outputFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.outputFormat==='West'?'selected':''}>西元</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">日期精度</label><select id="ed-date-prec" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="YMD" ${f.precision==='YMD'?'selected':''}>年/月/日 (完整)</option><option value="YM" ${f.precision==='YM'?'selected':''}>年/月</option><option value="Y" ${f.precision==='Y'?'selected':''}>僅年份</option><option value="M" ${f.precision==='M'?'selected':''}>僅月份</option><option value="D" ${f.precision==='D'?'selected':''}>僅日期</option></select></div>
                    </div>
                </div>`;
            } else {
                html = '<div class="text-center text-sm text-slate-400 py-10">此類型無需額外設定</div>';
            }
            container.innerHTML = html;
        }

        function renderOptionList() {
            const tbody = document.getElementById('ed-opt-list-body'); if(!tbody) return;
            const showDesc = document.getElementById('ed-opt-desc-toggle')?.checked;
            const thDesc = document.getElementById('th-desc');
            if(thDesc) thDesc.classList.toggle('hidden', !showDesc);

            tbody.innerHTML = window.currentOptions.map((opt, idx) => {
                const isEditing = editingOptionIdx === idx;
                const valHtml = isEditing ? `<input id="edit-opt-${idx}" value="${opt}" class="w-full border border-indigo-300 rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-200">` : `<span class="text-slate-700 font-medium">${opt}</span>`;
                
                let descHtml = '';
                if(showDesc) {
                    const descVal = window.currentOptionDescs[opt] || '';
                    descHtml = isEditing 
                        ? `<td><input id="edit-desc-${idx}" value="${descVal}" class="w-full border border-indigo-300 rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-200" placeholder="說明..."></td>`
                        : `<td class="text-xs text-slate-500">${descVal}</td>`;
                }

                const actions = isEditing 
                    ? `<button onclick="saveOption(${idx})" class="text-success hover:text-emerald-600 mr-2"><i class="fas fa-check"></i></button><button onclick="cancelEditOption()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>`
                    : `<button onclick="moveOption(${idx},-1)" class="text-slate-300 hover:text-primary mr-1" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveOption(${idx},1)" class="text-slate-300 hover:text-primary mr-2" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="editOption(${idx})" class="text-slate-300 hover:text-primary mr-2"><i class="fas fa-pencil-alt"></i></button><button onclick="removeOption(${idx})" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button>`;
                return `<tr><td class="text-center text-slate-400 font-mono text-xs">${idx+1}</td><td>${valHtml}</td>${descHtml}<td class="text-right">${actions}</td></tr>`;
            }).join('');
            updateRuleCheckboxes(); 
        }
        function addOption() { const inp = document.getElementById('ed-new-opt'); const val = inp.value.trim(); if(val) { window.currentOptions.push(val); renderOptionList(); inp.value = ''; inp.focus(); showMsg('success', '成功', '選項已新增'); } }
        function removeOption(idx) { showMsg('confirm', '刪除選項？', '確定刪除此選項嗎？', null, () => { window.currentOptions.splice(idx, 1); renderOptionList(); showMsg('success', '成功', '選項已刪除'); }); }
        function moveOption(idx, dir) { if(idx+dir < 0 || idx+dir >= window.currentOptions.length) return; [window.currentOptions[idx], window.currentOptions[idx+dir]] = [window.currentOptions[idx+dir], window.currentOptions[idx]]; renderOptionList(); }
        function editOption(idx) { editingOptionIdx = idx; renderOptionList(); setTimeout(() => document.getElementById(`edit-opt-${idx}`).focus(), 50); }
        function saveOption(idx) { 
            const oldVal = window.currentOptions[idx];
            const newVal = document.getElementById(`edit-opt-${idx}`).value.trim(); 
            const descInput = document.getElementById(`edit-desc-${idx}`);
            if(descInput) { window.currentOptionDescs[newVal] = descInput.value.trim(); if(oldVal !== newVal) delete window.currentOptionDescs[oldVal]; } 
            else if (oldVal !== newVal && window.currentOptionDescs[oldVal]) { window.currentOptionDescs[newVal] = window.currentOptionDescs[oldVal]; delete window.currentOptionDescs[oldVal]; }
            if(newVal) window.currentOptions[idx] = newVal; 
            editingOptionIdx = -1; renderOptionList(); 
        }
        function cancelEditOption() { editingOptionIdx = -1; renderOptionList(); }
        function syncBatchOptions() {
            const text = document.getElementById('ed-opt-textarea').value;
            window.currentOptions = text.split('\n').map(x => x.trim()).filter(x => x);
            updateRuleCheckboxes();
        }
        function initSortable() { /* Not needed */ }

        function renderRules(rules, depOpts) {
            const list = document.getElementById('rule-list'); list.innerHTML = '';
            if(rules.length === 0) { list.innerHTML = '<div class="text-center text-xs text-slate-400 py-2 border border-dashed border-slate-300 rounded">尚無規則，請點擊新增。</div>'; return; }
            rules.forEach((r, idx) => {
                const row = document.createElement('div'); row.className = 'logic-card p-4 relative bg-white';
                row.innerHTML = `<button onclick="removeRule(${idx})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-[10px] font-bold text-slate-500 uppercase">依賴對象 (決定者)</label><select onchange="updateRule(${idx}, 'dep', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs bg-slate-50"><option value="">請選擇...</option>${depOpts}</select></div><div><label class="text-[10px] font-bold text-slate-500 uppercase">當內容是 (條件值)</label><input oninput="updateRule(${idx}, 'val', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs" placeholder="輸入觸發值" value="${r.val||''}"></div></div><div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">僅顯示下列選項 (Check to Show)</label><div class="flex flex-wrap gap-2" id="chk-container-${idx}"></div></div>`;
                list.appendChild(row); row.querySelector('select').value = r.dep || ''; updateRuleCheckboxes(idx, r.limitTo);
            });
        }

        function updateRuleCheckboxes(ruleIdx = null, selected = []) {
            const opts = window.currentOptions || [];
            const renderSet = (containerId, currentSel) => {
                const c = document.getElementById(containerId); if(!c) return;
                c.innerHTML = opts.map(o => `<label class="inline-flex items-center bg-slate-50 px-2 py-1 rounded border border-slate-200 text-xs cursor-pointer select-none hover:border-primary"><input type="checkbox" class="mr-1 accent-primary" ${currentSel.includes(o)?'checked':''} onchange="updateRuleLimit(${ruleIdx}, '${o}', this.checked)"> ${o}</label>`).join('');
            };
            if(ruleIdx !== null) renderSet(`chk-container-${ruleIdx}`, selected);
            else { const list = document.getElementById('rule-list'); if(list && window.currentRules) window.currentRules.forEach((r, i) => renderSet(`chk-container-${i}`, r.limitTo || [])); }
        }

        window.addRule = function() { window.currentRules.push({ dep: "", val: "", limitTo: [] }); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.removeRule = function(idx) { window.currentRules.splice(idx, 1); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.updateRule = function(idx, key, val) { window.currentRules[idx][key] = val; };
        window.updateRuleLimit = function(idx, opt, checked) { let arr = window.currentRules[idx].limitTo || []; if(checked) { if(!arr.includes(opt)) arr.push(opt); } else { arr = arr.filter(x => x !== opt); } window.currentRules[idx].limitTo = arr; };

        function saveField() {
            const id = document.getElementById('ed-field-id').value.trim(); const label = document.getElementById('ed-label').value.trim();
            if(!id || !label) return showMsg('error','錯誤','ID 與名稱為必填');
            
            let f = {};
            if(isEditMode) f = (targetList==='global'?configData.globalFields:yearTemplateData.fields).find(x=>x.id===document.getElementById('ed-orig-id').value);
            
            f.id = id; f.label = label; f.type = document.getElementById('ed-type').value; f.category = document.getElementById('ed-category').value || undefined;
            f.description = document.getElementById('ed-desc').value.trim(); 
            f.required = document.getElementById('ed-required').checked; f.isSystem = document.getElementById('ed-system').checked;

            if(document.getElementById('vis-toggle').checked) { f.visibilityRule = { dep: document.getElementById('ed-vis-dep').value, val: document.getElementById('ed-vis-val').value, action: document.getElementById('ed-vis-action').value }; } else { delete f.visibilityRule; }
            
            
            // Handle special types: college and department should not have manual options/rules
            if (f.type === 'college' || f.type === 'department') {
                delete f.options;
                delete f.optionDescriptions;
                delete f.filterRule;
                delete f.filterRules;
            } else if(f.type === 'single_select') {
                f.options = window.currentOptions;
                if(Object.keys(window.currentOptionDescs).length > 0) f.optionDescriptions = window.currentOptionDescs; else delete f.optionDescriptions;

                if(document.getElementById('adv-logic-toggle').checked && window.currentRules.length > 0) {
                    const validRules = window.currentRules.filter(r => r.dep && r.val);
                    if(validRules.length === 1) { f.filterRule = validRules[0]; delete f.filterRules; } 
                    else if(validRules.length > 1) { f.filterRules = validRules; delete f.filterRule; } 
                    else { delete f.filterRule; delete f.filterRules; }
                } else { delete f.filterRule; delete f.filterRules; }
            }
            
            if(f.type === 'number') { if(document.getElementById('adv-num-toggle').checked) { f.calcMode=document.getElementById('ed-mode').value; f.decimal=parseInt(document.getElementById('ed-dec').value)||0; f.keepZero=document.getElementById('ed-keepZero').checked; } else { delete f.calcMode; delete f.decimal; delete f.keepZero; } }
            if(f.type === 'date') { if(document.getElementById('adv-date-toggle').checked) { f.inputFormat = document.getElementById('ed-date-in').value; f.outputFormat = document.getElementById('ed-date-out').value; f.precision = document.getElementById('ed-date-prec').value; } else { delete f.inputFormat; delete f.outputFormat; delete f.precision; } delete f.dateFormat; }
            if(f.type === 'text') { 
                if(document.getElementById('adv-text-toggle').checked) { 
                    f.maxLen = parseInt(document.getElementById('ed-maxlen').value) || 0; 
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                } else { delete f.maxLen; delete f.forceTai; } 
            }
            if(f.type === 'address') { 
                if(document.getElementById('adv-addr-toggle').checked) {
                    f.latinToEng = document.getElementById('ed-latin-to-eng').checked; 
                    delete f.blockJa; 
                    f.toHalf = document.getElementById('ed-to-half').checked;
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                    f.smartFormat = document.getElementById('ed-smart-fmt').checked;
                } else { delete f.latinToEng; delete f.blockJa; delete f.toHalf; delete f.forceTai; delete f.smartFormat; }
            }

            if(!isEditMode && targetList==='global') { f.order = configData.globalFields.length; configData.globalFields.push(f); }

            document.getElementById('editor-modal').classList.add('hidden');
            targetList==='global'?renderGlobalList():renderYearFields(); setUnsaved(true);
            showMsg('info', '暫存成功', '設定已暫存，請記得按「儲存設定」發布。');
        }

        // --- Picker, Types, Save Config ---
        function openFieldPicker() {
            const list = document.getElementById('picker-list'); list.innerHTML = ''; document.getElementById('picker-select-all').checked=false;
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));
            if(available.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400">已加入所有模板欄位</div>';
            else available.forEach(f => list.innerHTML += `<label class="flex items-center p-3 border rounded-lg hover:border-primary cursor-pointer hover:bg-indigo-50 mb-2"><input type="checkbox" value="${f.id}" class="picker-checkbox custom-checkbox mr-3"><div class="flex-grow flex justify-between"><span class="font-bold text-sm text-slate-700">${f.label}</span><span class="text-xs text-slate-400 font-mono">${f.id}</span></div></label>`);
            document.getElementById('picker-modal').classList.remove('hidden');
        }
        function togglePickerAll(cb) { document.querySelectorAll('.picker-checkbox').forEach(c => c.checked = cb.checked); }
        function addSelectedFields() {
            const ids = Array.from(document.querySelectorAll('.picker-checkbox:checked')).map(c=>c.value);
            const map = {}; configData.globalFields.forEach(f=>map[f.id]=f.order); ids.sort((a,b)=>map[a]-map[b]);
            ids.forEach(id=>{ const t=configData.globalFields.find(x=>x.id===id); if(t) yearTemplateData.fields.push(JSON.parse(JSON.stringify(t))); });
            renderYearFields(); setUnsaved(true); document.getElementById('picker-modal').classList.add('hidden');
            showMsg('success', '成功', '欄位已加入');
        }
        
        function openTypeManager(){switchView('types');renderTypeManagerPage();}
        function renderTypeManagerPage(){const el=document.getElementById('type-list-page');el.innerHTML='';configData.fieldTypes.forEach(t=>el.innerHTML+=`<tr class="hover:bg-slate-50"><td class="px-6 py-3 font-mono text-xs text-primary font-bold">${t.key}</td><td class="px-6 py-3 text-xs font-bold">${t.label}</td><td class="px-6 py-3 text-right"><button onclick="editCustomTypePage('${t.key}')" class="text-slate-300 hover:text-primary mr-2"><i class="fas fa-pen"></i></button><button onclick="delCustomTypePage('${t.key}')" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`);}
        
        // FIX 5: Fix editCustomTypePage to pass required info to showMsg
        function editCustomTypePage(key) {
            const t = configData.fieldTypes.find(x => x.key === key); 
            if(!t || ['text', 'number', 'date', 'single_select', 'list', 'address', 'college', 'department'].includes(key)) {
                return showMsg('error', '錯誤', '系統內建類型無法編輯');
            }
            showMsg('prompt', '編輯類型', `請輸入類型代碼為 [${key}] 的新的顯示名稱`, {label: '顯示名稱', value: t.label}, (newLabel) => {
                if(newLabel && newLabel !== t.label) { t.label = newLabel; setUnsaved(true); renderTypeManagerPage(); showMsg('success', '成功', '類型名稱已更新'); }
            });
        }
        // END FIX 5

        function addCustomTypePage(){const k=document.getElementById('new-type-key-page').value.trim(),l=document.getElementById('new-type-label-page').value.trim();if(!k||!l)return;if(configData.fieldTypes.some(t=>t.key===k))return showMsg('error','錯誤','Key 已存在');configData.fieldTypes.push({key:k,label:l});setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已新增'); }
        function delCustomTypePage(k){showMsg('confirm', '刪除類型？', '已使用此類型的欄位可能會顯示異常。', null,()=>{configData.fieldTypes=configData.fieldTypes.filter(t=>t.key!==k);setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已刪除'); });}

        async function saveConfig() { configSha = await uploadFile(ghConfig.path, configData, configSha); }
        
        // --- FIXED: Ensure saveDepartmentData is called unconditionally if data exists ---
        async function saveAll() {
            const btn=document.getElementById('btn-save');btn.disabled=true;btn.innerHTML='<div class="spinner"></div>';
            try { 
                let deptDataChanged = unsavedChanges; // Use existing flag for dept changes
                
                // 1. Save Main Config
                await saveConfig(); 
                
                // 2. Save Dept Master Data
                await saveDeptMasterData();
                
                // 3. Save Dept Grouping Data (Always attempt save if data is present, relying on Git SHA for change detection)
                if (departmentData.length > 0 && deptDataChanged) {
                    await saveDepartmentData();
                }
                
                // 4. Save active Year Template
                if(activeYearId){
                    const p=`hedb/year_templates/year_${activeYearId}_templates.json`;
                    const c=await apiFetch(p);
                    await uploadFile(p,yearTemplateData,c.status===200?c.sha:null);
                } 
                
                setUnsaved(false); 
                showMsg('success', '儲存成功', '所有設定已更新至 GitHub'); 
            }
            catch(e){showMsg('error', '儲存失敗', e.message);} 
            finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-upload-alt"></i> 儲存設定';}
        }
        // --- END FIXED ---

        // --- FIXED/REINFORCED apiFetch function (Critical for Q1) ---
        async function apiFetch(path) {
            const token = sessionStorage.getItem('gh_token') || ghConfig.token;
            if (!token) throw new Error("Missing GitHub token.");

            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}?t=${Date.now()}`;
            
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            };
            
            let r;
            try {
                r = await fetch(url, { headers: headers });
            } catch (networkError) {
                // Catch network issues like CORS or offline
                throw new Error(`網路連線錯誤: ${networkError.message}`);
            }

            if (!r.ok) {
                // Throw error for bad HTTP status codes
                let errorMsg = `HTTP 錯誤碼: ${r.status}`;
                if (r.status === 401) errorMsg = "認證失敗: Access Token 錯誤或權限不足";
                if (r.status === 404) return { status: 404 }; // Handle 404 gracefully
                if (r.status === 403) errorMsg = "禁止訪問: 權限不足或超出速率限制";
                throw new Error(errorMsg);
            }

            const d = await r.json();

            if (Array.isArray(d)) {
                return { status: 200, data: d };
            }

            // Decode content (for single file fetching)
            if (d.content) {
                try {
                    const c = decodeURIComponent(escape(window.atob(d.content.replace(/\n/g, ""))));
                    return { status: 200, data: JSON.parse(c), sha: d.sha };
                } catch (decodeError) {
                    throw new Error("設定檔解析錯誤，可能不是有效的 JSON 格式。");
                }
            }
            
            return { status: 200, data: d, sha: d.sha }; // Fallback for other valid responses
        }
        // --- END FIXED/REINFORCED apiFetch function ---


        async function uploadFile(path,data,sha){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'PUT',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Update',content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),sha:sha})});if(!r.ok)throw new Error(r.status);const d=await r.json();return d.content.sha;}
        async function deleteFile(path,sha){await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'DELETE',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Del',sha:sha})});}

        function switchView(v) {
            ['years','fields','types','internship', 'departments'].forEach(x => { document.getElementById(`view-${x}`).classList.toggle('hidden', v!==x); document.getElementById(`view-${x}`).classList.toggle(v!=='years'?'flex':'flex', v===x); document.getElementById(`nav-${x}`).classList.toggle('active', v===x); });
            if(v==='fields')renderGlobalList(); if(v==='types')renderTypeManagerPage(); if(v==='departments') renderDepartmentView();
        }
        window.onload = init;
    </script>
</body>
</html>
