<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±ç®¡ç†å¾Œå° (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC'
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #002E5D 0%, #0f172a 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-stylish { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); background: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .nav-btn.active { border-bottom: 3px solid #002E5D; color: #002E5D; font-weight: bold; background: #f1f5f9; }
        .nav-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover:not(.active) { color: #002E5D; background: #f8fafc; }

        /* v4.0 Style */
        .year-add-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; }
        .year-add-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .list-item { padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; background-color: #ffffff; color: #64748b; border: 1px solid transparent; }
        .list-item:hover { background-color: #f1f5f9; }
        .list-item.active { background-color: #EEF2FF; color: #002E5D; font-weight: bold; border: 1px solid #e0e7ff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .list-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; background-color: #002E5D; border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }

        .btn-manage { background-color: #002E5D; color: white; }
        .btn-manage:hover { background-color: #001e3d; }
        .btn-create { background-color: #219653; color: white; }
        .btn-create:hover { background-color: #1e874b; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-warning:hover { background-color: #D97706; }

        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        .data-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #f8fafc; }

        .custom-checkbox { height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #cbd5e1; color: #002E5D; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox:focus { ring: 2px solid #002E5D; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .logic-card { background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 0.75rem; transition: all 0.2s; }
        .logic-card:hover { border-color: #CBD5E1; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-background">

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg"><i class="fas fa-university"></i></div>
                <h1 class="text-2xl font-bold text-primary tracking-wide">æ±æµ·å¤§å­¸å¯¦ç¿’å¹³å°</h1>
                <p class="text-slate-500 text-sm mt-2 font-medium">ç³»çµ±ç®¡ç†å¾Œå° (System Admin)</p>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                <div class="relative"><i class="fas fa-key input-icon"></i><input type="password" id="gh-token" class="input-stylish" placeholder="Access Token"><button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary p-1"><i class="fas fa-eye" id="token-eye"></i></button></div>
                <div class="pt-4"><button onclick="connectGitHub()" id="btn-connect" class="w-full btn-manage font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><span>ç™»å…¥ç³»çµ±</span><i class="fas fa-arrow-right"></i></button><div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div></div>
            </div>
        </div>
    </div>

    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <div class="flex items-center gap-3"><div class="w-8 h-8 bg-primary text-white rounded flex items-center justify-center text-sm shadow"><i class="fas fa-tools"></i></div><h1 class="font-bold text-lg tracking-wide text-primary">ç³»çµ±é…ç½®ä¸­å¿ƒ</h1></div>
            <div class="flex items-center gap-3">
                <div id="unsaved-badge" class="hidden px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold border border-amber-200 flex items-center gap-1 animate-pulse"><i class="fas fa-pen"></i> æœªå„²å­˜</div>
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100"><i class="fas fa-check-circle mr-1"></i> å„²å­˜æˆåŠŸ</span>
                <button onclick="saveAll()" id="btn-save" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all"><i class="fas fa-cloud-upload-alt"></i> å„²å­˜è¨­å®š</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> ç™»å‡º</button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200 px-6 flex-shrink-0 z-20">
            <div class="flex gap-6">
                <button onclick="switchView('years')" id="nav-years" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 active"><i class="fas fa-calendar-alt"></i> å­¸å¹´åº¦æ¨¡çµ„é…ç½®</button>
                <button onclick="switchView('fields')" id="nav-fields" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-layer-group"></i> æ¬„ä½æ¨¡æ¿åº«</button>
                <button onclick="switchView('types')" id="nav-types" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-tags"></i> æ¬„ä½é¡å‹ç®¡ç†</button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden bg-slate-50">
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openYearModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-plus text-lg"></i> æ–°å¢å­¸å¹´åº¦</div></div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">å­¸å¹´åº¦åˆ—è¡¨</div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-year-title">...</span><span id="default-badge" class="hidden text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">é è¨­å¹´åº¦</span></h2><p class="text-xs text-slate-400 mt-1">æ­¤å­¸å¹´åº¦çš„æ¬„ä½é…ç½® (ç¨ç«‹æ¨¡çµ„)</p></div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-white transition select-none mr-2"><input type="checkbox" id="is-default-year" class="custom-checkbox" onchange="toggleDefaultYear()"> è¨­ç‚ºé è¨­</label>
                                <button onclick="renameCurrentYear()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2.5 rounded-lg transition" title="é‡æ–°å‘½å"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentYear()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2.5 rounded-lg transition" title="åˆªé™¤å­¸å¹´åº¦"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ul text-primary"></i> æ¬„ä½åˆ—è¡¨</h3>
                                    <div class="flex items-center gap-2 ml-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm"><i class="fas fa-filter text-slate-400 text-xs"></i><select id="year-filter-cat" onchange="renderYearFields()" class="text-sm text-slate-600 outline-none bg-transparent cursor-pointer hover:text-primary"><option value="all">é¡¯ç¤ºæ‰€æœ‰åˆ†é¡</option></select></div>
                                    <button onclick="openLogicSummary('year')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-project-diagram"></i> é‚è¼¯ç¸½è¦½èˆ‡è¡çªæª¢æ¸¬</button>
                                    <button onclick="deleteSelectedYearFields()" class="bg-danger hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-trash-alt"></i> åˆªé™¤é¸å–é …ç›®</button>
                                </div>
                                <button onclick="openFieldPicker()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> å¾æ¨¡æ¿è¤‡è£½åŠ å…¥</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleYearAll(this)" class="custom-checkbox"></th><th class="w-16 text-center">æ’åº</th><th>æ¬„ä½åç¨±</th><th class="w-24">åˆ†é¡</th><th class="w-24">é¡å‹</th><th class="w-40 text-right">æ“ä½œ</th></tr></thead><tbody id="year-field-list"></tbody></table></div></div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-calendar-alt"></i></div><p>è«‹å¾å·¦å´é¸æ“‡æˆ–æ–°å¢ä¸€å€‹å­¸å¹´åº¦æ¨¡çµ„</p></div>
                </section>
            </div>

            <div id="view-fields" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openCategoryModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-folder-plus text-lg"></i> æ–°å¢æ¨¡æ¿åˆ†é¡</div></div>
                    <div id="template-cat-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                        <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-cat-title">å…¨éƒ¨æ¬„ä½</span></h2><p class="text-xs text-slate-400 mt-1">ç®¡ç†å¯ä¾›å­¸å¹´åº¦å¼•ç”¨çš„æ¬„ä½åŸå‹ã€‚</p></div>
                        <div class="flex items-center gap-3">
                            <button onclick="openLogicSummary('global')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold mr-2"><i class="fas fa-project-diagram"></i> é‚è¼¯ç¸½è¦½èˆ‡è¡çªæª¢æ¸¬</button>
                            <div id="cat-actions" class="hidden border-r border-slate-200 pr-3 mr-1 flex gap-1"><button onclick="renameCurrentCat()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2 rounded-lg transition" title="é‡æ–°å‘½å"><i class="fas fa-pen"></i></button><button onclick="deleteCurrentCat()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2 rounded-lg transition" title="åˆªé™¤åˆ†é¡"><i class="fas fa-trash-alt"></i></button></div>
                            <button onclick="addNewGlobalField()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> å»ºç«‹æ–°æ¨¡æ¿</button>
                        </div>
                    </div>
                    <div class="flex-grow p-8 overflow-hidden flex flex-col"><div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-16 text-center">åºè™Ÿ</th><th>æ¬„ä½åç¨± (ID)</th><th class="w-24">é¡å‹</th><th class="w-48">å±¬æ€§</th><th class="w-40 text-right">æ“ä½œ</th></tr></thead><tbody id="global-field-list"></tbody></table></div></div></div>
                </section>
            </div>

            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full"><div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8"><div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100"><div><h2 class="text-2xl font-bold text-slate-800">æ¬„ä½é¡å‹ç®¡ç†</h2><p class="text-sm text-slate-500 mt-1">å®šç¾©ç³»çµ±æ”¯æ´çš„è¼¸å…¥é¡å‹ (å¦‚ Text, Number...)</p></div></div><div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">ä»£ç¢¼ (Key)</th><th class="px-6 py-3">é¡¯ç¤ºåç¨± (Label)</th><th class="px-6 py-3 text-right">æ“ä½œ</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div><div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> æ–°å¢è‡ªè¨‚é¡å‹</h4><div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">ä»£ç¢¼ (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">é¡¯ç¤ºåç¨±</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">æ–°å¢</button></div></div></div></div></div>
            </div>
        </main>
    </div>

    <div id="msg-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4 transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm" id="msg-icon"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="msg-title"></h3><p class="text-sm text-slate-500 mb-6 leading-relaxed" id="msg-desc"></p>
            <div id="msg-input-area" class="hidden mb-6 text-left"><label class="block text-xs font-bold text-slate-400 uppercase mb-1" id="msg-input-label"></label><input type="text" id="msg-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none text-slate-700"><div id="msg-select-area" class="hidden mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">è¤‡è£½ä¾†æº</label><select id="msg-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select></div></div>
            <div class="flex gap-3 justify-center" id="msg-btns"></div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> <span id="editor-title">ç·¨è¼¯æ¬„ä½å±¬æ€§</span></h3>
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="flex flex-grow overflow-hidden">
                <div class="w-80 bg-slate-50 border-r border-slate-200 flex-shrink-0 overflow-y-auto custom-scroll p-6 space-y-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">åŸºæœ¬è¨­å®š</h4>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">æ¬„ä½ ID <span class="text-red-500">*</span></label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono text-blue-600 focus:ring-primary outline-none" placeholder="e.g. f_name"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">é¡¯ç¤ºåç¨± <span class="text-red-500">*</span></label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. å­¸ç”Ÿå§“å"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">æ‰€å±¬åˆ†é¡</label><select id="ed-category" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none"></select></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">æ¬„ä½é¡å‹</label><select id="ed-type" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none" onchange="renderOpts()"></select></div>
                    <div class="pt-2 space-y-3">
                        <div><label class="flex items-center text-sm cursor-pointer mb-1"><input type="checkbox" id="ed-system" class="custom-checkbox mr-2" onchange="toggleSystemHint(this.checked)"> <span class="font-bold text-slate-700">ğŸš« ç³»çµ±è‡ªå‹•å¸¶å…¥ (å”¯è®€/åŒ¯å…¥)</span></label><p id="sys-hint" class="hidden text-[10px] text-amber-600 pl-6 leading-tight">æ­¤æ¬„ä½å°æ‡‰åŒ¯å…¥æª”æ¡ˆï¼Œä½¿ç”¨è€…ç„¡æ³•ç·¨è¼¯ã€‚å»ºè­°å‹¾é¸ã€å¿…å¡«ã€ç¢ºä¿è³‡æ–™å®Œæ•´ã€‚</p></div>
                        <label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="ed-required" class="custom-checkbox mr-2"> <span class="font-bold text-slate-700">å¿…å¡«é …ç›®</span></label>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll bg-white">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-eye"></i> æ¬„ä½é¡¯ç¤ºæ§åˆ¶ (Visibility)</h4><p class="text-[11px] text-slate-400 mt-1">æ§åˆ¶æ­¤æ¬„ä½åœ¨ä»€éº¼æƒ…æ³ä¸‹æ‰é¡¯ç¤ºã€‚</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="vis-toggle" class="sr-only peer" onchange="toggleVisSettings(this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600" id="vis-label">ç¸½æ˜¯é¡¯ç¤º</span></label>
                        </div>
                        <div id="vis-settings" class="hidden bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex items-center gap-2 text-xs text-slate-500 mb-2"><i class="fas fa-info-circle"></i> ç•¶ä»¥ä¸‹æ¢ä»¶æˆç«‹æ™‚ï¼Œé¡¯ç¤ºæ­¤æ¬„ä½ï¼š</div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">ä¾è³´å°è±¡ (æ±ºå®šè€…)</label><select id="ed-vis-dep" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"></select></div><div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">ç•¶å…§å®¹æ˜¯ (æ¢ä»¶å€¼)</label><input id="ed-vis-val" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="è¼¸å…¥è§¸ç™¼å€¼"></div></div>
                        </div>
                    </div>
                    <div id="ed-opts-container" class="p-8"></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">å–æ¶ˆ</button>
                <button onclick="saveField()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition">ç¢ºèªæš«å­˜</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[80vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-project-diagram text-primary"></i> é‚è¼¯ç¸½è¦½èˆ‡è¡çªæª¢æ¸¬</h3>
                <button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-6 bg-slate-50">
                <div id="logic-conflicts" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="text-red-700 font-bold flex items-center gap-2 mb-2"><i class="fas fa-exclamation-triangle"></i> ç™¼ç¾é‚è¼¯å•é¡Œ</h4><ul id="conflict-list" class="list-disc list-inside text-sm text-red-600 space-y-2"></ul></div>
                <div class="space-y-6">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-eye text-indigo-500 mr-2"></i> é¡¯ç¤ºæ¢ä»¶ (Visibility)</span><span id="vis-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="vis-list" class="space-y-3"></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-list-ul text-emerald-500 mr-2"></i> é¸é …é€£å‹• (Option Logic)</span><span id="opt-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="opt-list" class="space-y-3"></div></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end"><button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm shadow">é—œé–‰è¦–çª—</button></div>
        </div>
    </div>

    <div id="choice-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300">
            <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-tools"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">è«‹é¸æ“‡ä¿®æ­£æ–¹å¼</h3><p class="text-sm text-slate-500 mb-6">æ‚¨æƒ³è¦ä¿®æ”¹ç›®å‰çš„ã€Œè¦å‰‡è¨­å®šã€ï¼Œé‚„æ˜¯è£œé½Šã€Œæºé ­é¸é …ã€ï¼Ÿ</p>
            <div class="flex flex-col gap-3">
                <button id="btn-edit-self" class="w-full py-3 rounded-lg border border-indigo-200 text-indigo-700 font-bold hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i class="fas fa-sliders-h"></i> ä¿®æ”¹è¦å‰‡è¨­å®š</button>
                <button id="btn-fix-source" class="w-full py-3 rounded-lg border border-emerald-200 text-emerald-700 font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> è£œé½Šæºé ­é¸é … (è‡ªå‹•ä¿®å¾©)</button>
            </div>
            <button onclick="document.getElementById('choice-modal').classList.add('hidden')" class="mt-4 text-xs text-slate-400 hover:text-slate-600 underline">å–æ¶ˆ</button>
        </div>
    </div>

    <div id="impact-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="flex items-center gap-3 mb-4 text-amber-600"><i class="fas fa-exclamation-triangle text-2xl"></i><h3 class="text-lg font-bold text-slate-800">ç¢ºèªè®Šæ›´æºé ­çµæ§‹</h3></div>
            <p class="text-sm text-slate-600 mb-4 leading-relaxed">æ‚¨å³å°‡åœ¨æºé ­æ¬„ä½ <span id="imp-dep-name" class="font-bold text-primary"></span> ä¸­æ–°å¢é¸é … <span id="imp-val" class="font-bold text-emerald-600 bg-emerald-50 px-1 rounded"></span>ã€‚</p>
            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-500 mb-6"><p class="font-bold mb-1">å½±éŸ¿ç¯„åœè©•ä¼°ï¼š</p><p>æ­¤æ¬„ä½ç›®å‰è¢« <span id="imp-count" class="font-bold text-primary">0</span> å€‹è¦å‰‡å¼•ç”¨ã€‚æ–°å¢é¸é …é€šå¸¸æ˜¯å®‰å…¨çš„ï¼Œä½†è«‹ç¢ºä¿é€™ç¬¦åˆæ‚¨çš„è³‡æ–™å®šç¾©ã€‚</p></div>
            <div class="flex justify-end gap-3"><button onclick="document.getElementById('impact-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button><button id="btn-confirm-fix" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 text-sm">ç¢ºèªæ–°å¢ä¸¦ä¿®å¾©</button></div>
        </div>
    </div>

    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="text-lg font-bold text-slate-800">å¾æ¨¡æ¿è¤‡è£½æ¬„ä½</h3><button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button></div><div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200"><label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer"><input type="checkbox" id="picker-select-all" class="custom-checkbox mr-2" onchange="togglePickerAll(this)"> å…¨é¸ / å–æ¶ˆå…¨é¸</label></div><div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div><div class="mt-4 pt-2 border-t border-slate-100 flex justify-end"><button onclick="addSelectedFields()" class="w-full btn-create font-bold py-2.5 rounded-lg shadow">ç¢ºèªè¤‡è£½é¸å–æ¬„ä½</button></div></div></div>
    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800"><i class="fas fa-exchange-alt text-primary mr-2"></i>ç§»å‹•é †åº</h3><p class="text-sm text-slate-500 mt-1">å°‡ <span id="move-target-name" class="font-bold text-primary"></span> ç§»å‹•è‡³ï¼š</p></div><div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-h-60 overflow-y-auto custom-scroll"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('move-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button><button onclick="saveMove()" class="px-4 py-2 btn-manage rounded-lg font-bold shadow-md text-sm">ç¢ºèªç§»å‹•</button></div></div></div>

    <script>
        let ghConfig = { user: '', repo: '', path: 'hedb/config.json', token: '' };
        let configData = { globalFields: [], academicYears: [], templateCategories: [], fieldTypes: [] }; 
        let yearTemplateData = { fields: [] }; 
        let activeYearId = null, activeCatId = 'all', isEditMode = false, moveSrcIndex = -1, moveType = '', targetList = 'global', unsavedChanges = false, configSha = null, activeLogicEdit = null;

        const SYSTEM_DEFAULT_TYPES = [
            {key:'text', label:'æ–‡å­—'}, {key:'number', label:'æ•¸å­—'}, {key:'date', label:'æ—¥æœŸ'}, {key:'single_select', label:'å–®é¸'}, {key:'list', label:'æ¢åˆ—å¼'}
        ];

        function init() {
            if(localStorage.getItem('gh_creds_v10')) localStorage.removeItem('gh_creds_v10');
            const saved = localStorage.getItem('gh_creds_safe');
            if(saved) { const c = JSON.parse(saved); document.getElementById('gh-user').value = c.user || ''; document.getElementById('gh-repo').value = c.repo || ''; }
            window.addEventListener('beforeunload', (e) => { if (unsavedChanges) { e.preventDefault(); e.returnValue = ''; } });
        }
        function setUnsaved(val) { unsavedChanges = val; document.getElementById('unsaved-badge').classList.toggle('hidden', !val); }

        async function connectGitHub() {
            const btn = document.getElementById('btn-connect'), msg = document.getElementById('login-msg'), user = document.getElementById('gh-user').value.trim(), repo = document.getElementById('gh-repo').value.trim(), token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) { msg.style.opacity='1'; msg.innerText='è«‹å¡«å¯«å®Œæ•´è³‡è¨Š'; return; }
            btn.innerHTML = '<div class="spinner"></div> é€£ç·šä¸­...'; btn.disabled = true; ghConfig = { user, repo, path: 'hedb/config.json', token };
            try {
                const res = await apiFetch(ghConfig.path);
                if(res.status === 404) { configData = { globalFields: [], academicYears: [], templateCategories: [], fieldTypes: [] }; configSha = null; } 
                else { configData = res.data; configSha = res.sha; if(!configData.templateCategories) configData.templateCategories = []; if(!configData.fieldTypes) configData.fieldTypes = []; const uniqueTypes = new Map(); [...SYSTEM_DEFAULT_TYPES, ...configData.fieldTypes].forEach(t => uniqueTypes.set(t.key, t)); configData.fieldTypes = Array.from(uniqueTypes.values()); }
                localStorage.setItem('gh_creds_safe', JSON.stringify({ user, repo })); sessionStorage.setItem('gh_token', token);
                document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-interface').classList.remove('hidden'); document.getElementById('admin-interface').style.opacity = '1';
                await syncYearsFromFiles(); renderYearList(); if(configData.academicYears.length > 0) selectYear(configData.academicYears[0].year); renderTemplateCats(); renderTypeManagerPage(); 
            } catch (err) { console.error(err); msg.style.opacity='1'; msg.innerText='é€£ç·šå¤±æ•—: ' + err.message; } finally { btn.innerHTML = 'ç™»å…¥ç³»çµ±'; btn.disabled = false; }
        }

        async function syncYearsFromFiles() { try { const dirRes = await apiFetch('hedb/year_templates'); if(dirRes.status !== 200 || !Array.isArray(dirRes.data)) return; const fileYears = dirRes.data.filter(f => f.name.match(/^year_(.+)_templates\.json$/)).map(f => f.name.match(/^year_(.+)_templates\.json$/)[1]); let changed = false; fileYears.forEach(y => { if(!configData.academicYears.some(cy => cy.year === y)) { configData.academicYears.push({ year: y, isDefault: false }); changed = true; } }); if(changed) { configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); setUnsaved(true); showMsg('info', 'åŒæ­¥å®Œæˆ', 'ç³»çµ±å·²è‡ªå‹•åµæ¸¬åˆ°æª”æ¡ˆåº«ä¸­çš„å­¸å¹´åº¦æ¨¡çµ„ä¸¦åŠ å…¥åˆ—è¡¨ï¼Œè«‹è¨˜å¾—å„²å­˜è¨­å®šã€‚'); } } catch(e) {} }
        function toggleToken() { const t = document.getElementById('gh-token'), i = document.getElementById('token-eye'); t.type = t.type === 'password' ? 'text' : 'password'; i.className = t.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash'; }
        function logout() { showMsg('confirm', 'ç¢ºå®šç™»å‡ºï¼Ÿ', 'æœªå„²å­˜çš„è®Šæ›´å°‡æœƒéºå¤±ã€‚', null, () => { localStorage.removeItem('gh_creds_safe'); sessionStorage.removeItem('gh_token'); location.reload(); }); }

        function showMsg(type, title, desc, inputConfig = null, onConfirm = null) {
            const modal = document.getElementById('msg-modal'), icon = document.getElementById('msg-icon'), btns = document.getElementById('msg-btns'), inputArea = document.getElementById('msg-input-area');
            document.getElementById('msg-title').innerText = title; document.getElementById('msg-desc').innerText = desc;
            inputArea.classList.add('hidden'); document.getElementById('msg-select-area').classList.add('hidden');
            let iconClass = '', iconHtml = '';
            if(type === 'success') { iconClass = 'bg-emerald-100 text-emerald-600'; iconHtml = '<i class="fas fa-check"></i>'; }
            else if(type === 'error') { iconClass = 'bg-red-100 text-red-600'; iconHtml = '<i class="fas fa-times"></i>'; }
            else if(type === 'info') { iconClass = 'bg-blue-100 text-blue-600'; iconHtml = '<i class="fas fa-info"></i>'; }
            else if(type === 'confirm' || type === 'prompt') { iconClass = 'bg-amber-100 text-amber-600'; iconHtml = '<i class="fas fa-question"></i>'; }
            icon.className = `w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm ${iconClass}`; icon.innerHTML = iconHtml;
            if(type === 'prompt' && inputConfig) { inputArea.classList.remove('hidden'); document.getElementById('msg-input-label').innerText = inputConfig.label || 'åç¨±'; const inp = document.getElementById('msg-input'); inp.value = inputConfig.value || ''; if(inputConfig.showSelect) { document.getElementById('msg-select-area').classList.remove('hidden'); const sel = document.getElementById('msg-select'); sel.innerHTML = '<option value="">ä¸è¤‡è£½ (ç©ºç™½)</option>'; configData.academicYears.forEach(y => sel.innerHTML += `<option value="${y.year}">è¤‡è£½ ${y.year}</option>`); } setTimeout(() => inp.focus(), 50); }
            btns.innerHTML = '';
            const cancelBtn = document.createElement('button'); cancelBtn.className = 'px-5 py-2.5 rounded-lg border border-slate-300 font-bold text-slate-600 hover:bg-slate-50 transition text-sm'; cancelBtn.innerText = type === 'success' || type === 'info' ? 'é—œé–‰' : 'å–æ¶ˆ'; cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); }; btns.appendChild(cancelBtn);
            if(type === 'confirm' || type === 'prompt') { const okBtn = document.createElement('button'); okBtn.className = `px-5 py-2.5 rounded-lg font-bold text-white shadow-md transition text-sm ${type==='prompt' ? 'bg-primary' : 'bg-danger'}`; okBtn.innerText = 'ç¢ºèª'; okBtn.onclick = async () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); if(onConfirm) { if(type === 'prompt') await onConfirm(document.getElementById('msg-input').value.trim(), document.getElementById('msg-select').value); else await onConfirm(); } }; btns.appendChild(okBtn); }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.add('opacity-100'); document.getElementById('msg-panel').classList.remove('scale-95'); document.getElementById('msg-panel').classList.add('scale-100'); }, 10);
        }

        // --- Core Functions ---
        function renderYearList() { const el = document.getElementById('year-list'); el.innerHTML = ''; configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); configData.academicYears.forEach(y => { const div = document.createElement('div'); div.className = `list-item ${activeYearId===y.year?'active':''}`; div.onclick = () => selectYear(y.year); div.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold text-sm">${y.year} å­¸å¹´åº¦</span>${y.isDefault?'<span class="text-[10px] bg-secondary text-white px-1.5 rounded font-bold ml-2">Def</span>':''}</div>`; el.appendChild(div); }); }
        function openYearModal() { showMsg('prompt', 'æ–°å¢å­¸å¹´åº¦', 'è«‹è¼¸å…¥å­¸å¹´åº¦ä¸¦é¸æ“‡æ˜¯å¦è¤‡è£½æ¨¡æ¿', {label: 'å­¸å¹´åº¦ (å¦‚: 114)', showSelect: true}, async (year, copyFrom) => { if(!year || configData.academicYears.some(y => y.year === year)) return showMsg('error','éŒ¯èª¤','å­¸å¹´åº¦å·²å­˜åœ¨'); try { let initialData = { fields: [] }; if (copyFrom) { const res = await apiFetch(`hedb/year_templates/year_${copyFrom}_templates.json`); if (res.status === 200) initialData = res.data; } const path = `hedb/year_templates/year_${year}_templates.json`; const check = await apiFetch(path); await uploadFile(path, initialData, check.status===200?check.sha:null); configData.academicYears.push({ year, isDefault: false }); await saveConfig(); setUnsaved(false); renderYearList(); selectYear(year); showMsg('success', 'æˆåŠŸ', 'å­¸å¹´åº¦æ¨¡çµ„å·²å»ºç«‹'); } catch(e) { showMsg('error','å¤±æ•—',e.message); } }); }
        function renameCurrentYear() { if(!activeYearId) return; showMsg('prompt', 'é‡æ–°å‘½åå­¸å¹´åº¦', 'è«‹è¼¸å…¥æ–°åç¨±ï¼Œé€™å°‡æœƒæ¬ç§»è¨­å®šæª”ã€‚', {label: 'æ–°åç¨±', value: activeYearId}, async (newYear) => { if(!newYear || newYear === activeYearId || configData.academicYears.some(y=>y.year===newYear)) return; try { const oldPath = `hedb/year_templates/year_${activeYearId}_templates.json`; const newPath = `hedb/year_templates/year_${newYear}_templates.json`; const res = await apiFetch(oldPath); const checkNew = await apiFetch(newPath); await uploadFile(newPath, res.status===200?res.data:{fields:[]}, checkNew.status===200?checkNew.sha:null); if(res.status===200) await deleteFile(oldPath, res.sha); const y = configData.academicYears.find(y=>y.year===activeYearId); y.year = newYear; await saveConfig(); activeYearId = newYear; renderYearList(); selectYear(newYear); showMsg('success','æˆåŠŸ','å­¸å¹´åº¦å·²é‡æ–°å‘½å'); } catch(e) { showMsg('error','å¤±æ•—',e.message); } }); }
        async function selectYear(year) { activeYearId = year; renderYearList(); document.getElementById('current-year-title').innerText = `${year} å­¸å¹´åº¦`; const yConf = configData.academicYears.find(y => y.year === year); document.getElementById('is-default-year').checked = yConf.isDefault || false; document.getElementById('default-badge').classList.toggle('hidden', !yConf.isDefault); document.getElementById('year-empty-state').classList.add('hidden'); document.getElementById('year-config-panel').classList.remove('hidden'); document.getElementById('year-config-panel').classList.add('flex'); updateYearFilterOptions(); document.getElementById('year-filter-cat').value = 'all'; document.getElementById('year-field-list').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>è®€å–è¨­å®šä¸­...</td></tr>`; try { const res = await apiFetch(`hedb/year_templates/year_${year}_templates.json`); yearTemplateData = res.status===404?{fields:[]}:res.data; renderYearFields(); } catch(e) { document.getElementById('year-field-list').innerHTML = `<tr><td colspan="6" class="p-4 text-red-500 text-center">è®€å–å¤±æ•—: ${e.message}</td></tr>`; } }
        function updateYearFilterOptions() { const sel = document.getElementById('year-filter-cat'), val = sel.value; sel.innerHTML = '<option value="all">æ‰€æœ‰åˆ†é¡</option>'; configData.templateCategories.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`); sel.innerHTML += '<option value="uncategorized">æœªåˆ†é¡</option>'; sel.value = val; }
        function deleteCurrentYear() { showMsg('confirm', 'ç¢ºèªåˆªé™¤å­¸å¹´åº¦ï¼Ÿ', `é€™å°‡æœƒåˆªé™¤ ${activeYearId} å­¸å¹´åº¦ï¼Œç„¡æ³•å¾©åŸã€‚`, null, async () => { try { const path = `hedb/year_templates/year_${activeYearId}_templates.json`; const check = await apiFetch(path); if(check.status===200) await deleteFile(path, check.sha); configData.academicYears = configData.academicYears.filter(y => y.year !== activeYearId); await saveConfig(); activeYearId = null; setUnsaved(false); document.getElementById('year-config-panel').classList.add('hidden'); document.getElementById('year-empty-state').classList.remove('hidden'); renderYearList(); showMsg('success','æˆåŠŸ','å­¸å¹´åº¦å·²åˆªé™¤'); } catch(e) { showMsg('error','å¤±æ•—',e.message); } }); }
        function renderYearFields() { const listEl = document.getElementById('year-field-list'), filter = document.getElementById('year-filter-cat')?.value || 'all'; listEl.innerHTML = ''; yearTemplateData.fields.forEach((f, idx) => { if(filter !== 'all' && ((filter==='uncategorized'&&f.category) || (filter!=='uncategorized'&&f.category!==filter))) return; const catName = configData.templateCategories.find(c => c.id === f.category)?.name || 'æœªåˆ†é¡'; const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; const btns = filter === 'all' ? `<button onclick="moveField(${idx},-1,'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${idx},1,'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400"><i class="fas fa-arrow-down"></i></button><button onclick="openMoveModal(${idx},'year')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 hover:text-primary transition mr-1"><i class="fas fa-exchange-alt"></i></button>` : ''; listEl.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100 transition"><td class="text-center py-3"><input type="checkbox" class="year-check custom-checkbox" value="${idx}"></td><td class="text-center font-mono text-xs text-slate-400">${idx+1}</td><td class="font-bold text-slate-700 text-sm">${f.label}<br><span class="text-[10px] text-slate-400 font-mono">${f.id}</span></td><td class="text-xs text-slate-500">${catName}</td><td class="text-xs text-slate-500">${typeName}</td><td class="text-right py-3 pr-4"><div class="flex justify-end gap-1">${btns}<button onclick="editField('${f.id}','year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-primary transition"><i class="fas fa-pen"></i></button><button onclick="removeYearField(${idx})" class="p-1.5 hover:bg-red-100 rounded text-slate-400 hover:text-danger transition"><i class="fas fa-trash-alt"></i></button></div></td></tr>`; }); if(listEl.innerHTML==='') listEl.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">å°šæœªåŠ å…¥æ¬„ä½</td></tr>'; }
        function removeYearField(idx) { showMsg('confirm', 'ç§»é™¤æ¬„ä½ï¼Ÿ', 'ç¢ºå®šè¦å¾æ­¤å­¸å¹´åº¦ç§»é™¤æ­¤æ¬„ä½ï¼Ÿ', null, () => { yearTemplateData.fields.splice(idx, 1); renderYearFields(); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'æ¬„ä½å·²ç§»é™¤'); }); }
        function toggleYearAll(el) { document.querySelectorAll('.year-check').forEach(c => c.checked = el.checked); }
        function deleteSelectedYearFields() { const chk = Array.from(document.querySelectorAll('.year-check:checked')).map(c=>parseInt(c.value)); if(chk.length) showMsg('confirm', 'æ‰¹æ¬¡åˆªé™¤', `ç¢ºå®šç§»é™¤é¸å–çš„ ${chk.length} å€‹æ¬„ä½ï¼Ÿ`, null, () => { chk.sort((a,b)=>b-a).forEach(i => yearTemplateData.fields.splice(i,1)); renderYearFields(); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'å·²ç§»é™¤é¸å–é …ç›®'); }); }
        function toggleDefaultYear() { const chk = document.getElementById('is-default-year').checked; configData.academicYears.forEach(y => y.isDefault = false); const curr = configData.academicYears.find(y => y.year === activeYearId); if(curr) curr.isDefault = chk; document.getElementById('default-badge').classList.toggle('hidden', !chk); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'é è¨­å­¸å¹´åº¦å·²æ›´æ–°'); }

        function renderTemplateCats() { const el = document.getElementById('template-cat-list'); el.innerHTML = `<div class="list-item ${activeCatId==='all'?'active':''}" onclick="selectCat('all')"><span class="font-bold text-sm">å…¨éƒ¨æ¬„ä½</span></div>`; configData.templateCategories.forEach(c => el.innerHTML += `<div class="list-item ${activeCatId===c.id?'active':''}" onclick="selectCat('${c.id}')"><span class="font-bold text-sm">${c.name}</span></div>`); el.innerHTML += `<div class="list-item ${activeCatId==='uncategorized'?'active':''}" onclick="selectCat('uncategorized')"><span class="text-sm">æœªåˆ†é¡</span></div>`; updateYearFilterOptions(); }
        function openCategoryModal() { showMsg('prompt', 'æ–°å¢æ¨¡æ¿åˆ†é¡', 'è«‹è¼¸å…¥åˆ†é¡åç¨±', {label: 'åç¨±'}, (v)=>{if(v){configData.templateCategories.push({id:'cat_'+Date.now(),name:v});renderTemplateCats();setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'åˆ†é¡å·²å»ºç«‹'); }}); }
        function renameCurrentCat() { const c=configData.templateCategories.find(x=>x.id===activeCatId); if(c) showMsg('prompt', 'é‡æ–°å‘½ååˆ†é¡', 'è«‹è¼¸å…¥æ–°åç¨±', {label: 'åç¨±',value:c.name},(v)=>{if(v){c.name=v;renderTemplateCats();setUnsaved(true);document.getElementById('current-cat-title').innerText=v; showMsg('success', 'æˆåŠŸ', 'åˆ†é¡å·²é‡æ–°å‘½å'); }}); }
        function deleteCurrentCat() { showMsg('confirm', 'åˆªé™¤åˆ†é¡ï¼Ÿ', 'åˆ†é¡ä¸‹çš„æ¬„ä½å°‡è®Šç‚ºã€Œæœªåˆ†é¡ã€ã€‚', null,()=>{ configData.templateCategories=configData.templateCategories.filter(c=>c.id!==activeCatId); configData.globalFields.forEach(f=>{if(f.category===activeCatId)delete f.category}); selectCat('all'); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'åˆ†é¡å·²åˆªé™¤'); }); }
        function selectCat(id) { activeCatId=id; renderTemplateCats(); document.getElementById('current-cat-title').innerText=id==='all'?'å…¨éƒ¨æ¬„ä½':id==='uncategorized'?'æœªåˆ†é¡':configData.templateCategories.find(c=>c.id===id).name; document.getElementById('cat-actions').classList.toggle('hidden', id==='all'||id==='uncategorized'); renderGlobalList(); }
        function renderGlobalList() { const el = document.getElementById('global-field-list'); let list = configData.globalFields; if(activeCatId==='uncategorized') list=list.filter(f=>!f.category); else if(activeCatId!=='all') list=list.filter(f=>f.category===activeCatId); list.sort((a,b)=>a.order-b.order); el.innerHTML = list.map((f,i)=> { const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; return `<tr class="hover:bg-slate-50 border-b border-slate-100 transition"><td class="text-center font-mono text-xs text-slate-400 py-3">${i+1}</td><td class="font-bold text-slate-700 text-sm">${f.label}<br><span class="text-[10px] text-slate-400 font-mono">${f.id}</span></td><td class="text-xs text-primary font-mono">${typeName}</td><td class="text-xs text-slate-400">${f.required?'<span class="text-red-500 bg-red-50 px-1 rounded">å¿…å¡«</span>':''}</td><td class="text-right flex justify-end gap-1 py-3 pr-4"><button onclick="moveField(${i},-1,'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${i},1,'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400"><i class="fas fa-arrow-down"></i></button><button onclick="editField('${f.id}','global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-primary transition mr-1"><i class="fas fa-pen"></i></button><button onclick="delGlobalField('${f.id}')" class="p-1.5 hover:bg-red-100 rounded text-slate-400 hover:text-danger transition"><i class="fas fa-trash-alt"></i></button></td></tr>`; }).join(''); }
        function addNewGlobalField() { isEditMode=false;targetList='global';prepEditor(); }
        function editField(id, type) { isEditMode=true;targetList=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; prepEditor(list.find(f=>f.id===id)); }
        function delGlobalField(id) { showMsg('confirm', 'åˆªé™¤æ¨¡æ¿ï¼Ÿ', 'ç¢ºå®šåˆªé™¤æ­¤æ¨¡æ¿ï¼Ÿ', null,()=>{configData.globalFields=configData.globalFields.filter(f=>f.id!==id);renderGlobalList();setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'æ¨¡æ¿å·²åˆªé™¤'); }); }
        function moveField(idx,dir,type) { const list=type==='global'?configData.globalFields:yearTemplateData.fields; if(list[idx+dir]){[list[idx],list[idx+dir]]=[list[idx+dir],list[idx]]; if(type==='global')list.forEach((f,i)=>f.order=i+1); type==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'æ’åºå·²æ›´æ–°'); } }
        function openMoveModal(idx,type) { moveSrcIndex=idx;moveType=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; const sel=document.getElementById('move-select'); sel.innerHTML=''; list.forEach((f,i)=>sel.innerHTML+=`<option value="${i}" ${i===idx?'selected':''}>${i+1}. ${f.label}</option>`); document.getElementById('move-target-name').innerText=list[idx].label; document.getElementById('move-modal').classList.remove('hidden'); }
        function saveMove() { const t=parseInt(document.getElementById('move-select').value); if(t!==moveSrcIndex){ const list=moveType==='global'?configData.globalFields:yearTemplateData.fields; list.splice(t,0,list.splice(moveSrcIndex,1)[0]); if(moveType==='global')list.forEach((f,i)=>f.order=i+1); moveType==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); showMsg('success', 'æˆåŠŸ', 'æ’åºå·²æ›´æ–°'); } document.getElementById('move-modal').classList.add('hidden'); }

        // --- Logic Summary & Conflict Detection ---
        function openLogicSummary(type) {
            activeLogicEdit = null; 
            renderLogicList(type);
            document.getElementById('logic-modal').classList.remove('hidden');
        }

        function renderLogicList(type) {
            const list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            const fieldMap = new Map(list.map(f => [f.id, f.label]));
            const fieldOptions = new Map(list.filter(f=>f.type==='single_select' && f.options).map(f => [f.id, f.options]));
            
            const conflicts = [];
            const checkDep = (fId, depId, ruleType, triggerVal) => {
                if(!depId) return false;
                let isValid = true;
                if(fId === depId) { conflicts.push(`ğŸ”´ <b>é¬¼æ‰“ç‰†è¨­å®š (å¾ªç’°)</b>ï¼šæ¬„ä½ [${fieldMap.get(fId)}] ä¸èƒ½ä¾è³´è‡ªå·±ï¼Œé€™æœƒé€ æˆç•¶æ©Ÿã€‚`); isValid = false; }
                else if(!fieldMap.has(depId)) { conflicts.push(`ğŸ”´ <b>æ‰¾ä¸åˆ°æºé ­</b>ï¼šè¦å‰‡ä¾è³´ [${depId}]ï¼Œä½†è©²æ¬„ä½å·²æ¶ˆå¤±ã€‚`); isValid = false; }
                else if(triggerVal && fieldOptions.has(depId)) {
                    if(!fieldOptions.get(depId).includes(triggerVal)) { conflicts.push(`ğŸŸ  <b>æ¢ä»¶ç„¡æ•ˆ</b>ï¼š[${fieldMap.get(depId)}] æ²’æœ‰é¸é … '${triggerVal}'ï¼Œè¦å‰‡æ°¸é ä¸æœƒè§¸ç™¼ã€‚`); isValid = false; }
                }
                return isValid;
            };

            const visited = new Set(); const recursionStack = new Set();
            const detectCycle = (currId, startId, path) => {
                if(recursionStack.has(currId)) { if(currId === startId) conflicts.push(`ğŸ”´ <b>é¬¼æ‰“ç‰†è¨­å®š (å¾ªç’°)</b>ï¼š${path.join(' -> ')} -> ${startId}ï¼Œæœƒå°è‡´ç³»çµ±å´©æ½°ã€‚`); return; }
                if(visited.has(currId)) return; visited.add(currId); recursionStack.add(currId);
                const f = list.find(x => x.id === currId);
                if(f && f.visibilityRule && f.visibilityRule.dep) detectCycle(f.visibilityRule.dep, startId, [...path, f.visibilityRule.dep]);
                recursionStack.delete(currId);
            };

            let visHtml = '', optHtml = '', visCount = 0, optCount = 0;

            list.forEach((f, fIdx) => {
                if(f.visibilityRule && f.visibilityRule.dep) {
                    visCount++;
                    const isValid = checkDep(f.id, f.visibilityRule.dep, 'Vis', f.visibilityRule.val);
                    detectCycle(f.id, f.id, [f.id]);
                    visHtml += renderLogicRow(f, f.visibilityRule, 'vis', fIdx, type, fieldMap, fieldOptions, null, isValid);
                }
                const rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                if(rules.length > 0) {
                    rules.forEach((r, rIdx) => {
                        optCount++;
                        const isValid = checkDep(f.id, r.dep, 'Opt', r.val);
                        optHtml += renderLogicRow(f, r, 'opt', fIdx, type, fieldMap, fieldOptions, rIdx, isValid);
                    });
                }
            });

            document.getElementById('vis-list').innerHTML = visHtml || '<div class="text-center text-slate-400 py-4">ç„¡è¨­å®š</div>';
            document.getElementById('opt-list').innerHTML = optHtml || '<div class="text-center text-slate-400 py-4">ç„¡è¨­å®š</div>';
            document.getElementById('vis-count').innerText = visCount;
            document.getElementById('opt-count').innerText = optCount;

            const cEl = document.getElementById('logic-conflicts');
            if(conflicts.length > 0) { cEl.classList.remove('hidden'); document.getElementById('conflict-list').innerHTML = [...new Set(conflicts)].map(c => `<li>${c}</li>`).join(''); } else cEl.classList.add('hidden');
        }

        function renderLogicRow(field, rule, type, fIdx, listType, fieldMap, fieldOptions, ruleIdx = null, isValid = true) {
            const isEditing = activeLogicEdit && activeLogicEdit.id === field.id && activeLogicEdit.type === type && activeLogicEdit.ruleIdx === ruleIdx;
            
            let statusHtml = '<span class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i> æª¢æ¸¬é€šéï¼šè¨­å®šæ­£ç¢º</span>';
            const depName = fieldMap.get(rule.dep) || rule.dep;
            const depValid = fieldMap.has(rule.dep);
            const valValid = !depValid || !fieldOptions.has(rule.dep) || fieldOptions.get(rule.dep).includes(rule.val);
            
            if(!depValid) statusHtml = '<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-circle"></i> éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ä¾è³´å°è±¡</span>';
            else if(!valValid) statusHtml = `<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-triangle"></i> éŒ¯èª¤ï¼š[${depName}] æ²’æœ‰é¸é … '${rule.val}'</span>`;

            if(isEditing) {
                let depOpts = '<option value="">è«‹é¸æ“‡...</option>';
                fieldMap.forEach((label, id) => { if(id !== field.id) depOpts += `<option value="${id}" ${id===rule.dep?'selected':''}>${label} (${id})</option>`; });
                let valInput = fieldOptions.has(rule.dep) ? `<select id="edit-val" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"><option value="">è«‹é¸æ“‡...</option>` + fieldOptions.get(rule.dep).map(o => `<option value="${o}" ${o===rule.val?'selected':''}>${o}</option>`).join('') + `</select>` : `<input id="edit-val" value="${rule.val}" class="w-full border border-slate-300 rounded p-1.5 text-sm focus:ring-2 focus:ring-primary outline-none" placeholder="è¼¸å…¥å€¼">`;

                return `<div class="bg-white border border-slate-200 border-l-4 border-l-primary rounded-lg p-4 mb-3 shadow-sm">
                    <div class="flex justify-between items-center mb-4"><span class="font-bold text-slate-800">ç·¨è¼¯è¦å‰‡ (${field.label})</span><div class="text-right">${statusHtml}</div></div>
                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-[10px] text-slate-500 font-bold block mb-1">ä¾è³´å°è±¡ (æ±ºå®šè€…)</label><select id="edit-dep" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none" onchange="updateLogicEditState('${field.id}','${type}',${fIdx},'${listType}',${ruleIdx}, this.value)">${depOpts}</select></div><div><label class="text-[10px] text-slate-500 font-bold block mb-1">ç•¶å…§å®¹æ˜¯ (æ¢ä»¶å€¼)</label>${valInput}</div></div>
                    <div class="flex justify-end gap-2"><button onclick="cancelLogicEdit('${listType}')" class="px-3 py-1.5 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50 font-bold text-slate-600 transition">å–æ¶ˆ</button><button onclick="saveLogicEdit('${field.id}', '${type}', ${fIdx}, '${listType}', ${ruleIdx})" class="px-3 py-1.5 bg-primary text-white rounded text-xs hover:bg-[#001e3d] shadow-sm font-bold transition">ç¢ºèªè®Šæ›´</button></div></div>`;
            } else {
                const displayVal = `<span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-mono text-xs font-bold">${rule.val}</span>`;
                const content = type === 'vis' ? `<span class="font-bold text-primary">${field.label}</span> é¡¯ç¤ºæ¢ä»¶ï¼šç•¶ <span class="font-bold text-slate-700">${depName}</span> æ˜¯ ${displayVal}` : `<span class="font-bold text-emerald-600">${field.label}</span> é€£å‹•è¦å‰‡ï¼šç•¶ <span class="font-bold text-slate-700">${depName}</span> æ˜¯ ${displayVal}ï¼Œé¡¯ç¤º [${rule.limitTo?.join(', ')}]`;
                
                const actionBtn = isValid ? '' : `<button onclick="promptEditChoice('${field.id}', '${rule.dep}', '${listType}', '${rule.val}')" class="text-slate-300 hover:text-primary transition p-1.5 rounded-full hover:bg-slate-100" title="ä¿®æ­£è¨­å®š"><i class="fas fa-pencil-alt"></i></button>`;
                
                const warnIcon = (!isValid) ? '<i class="fas fa-exclamation-triangle text-red-500 mr-2 animate-pulse"></i>' : '<i class="fas fa-check-circle text-green-500 mr-2 opacity-50"></i>';
                return `<div class="p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex justify-between items-center group transition"><div class="text-sm flex items-center">${warnIcon} ${content}</div>${actionBtn}</div>`;
            }
        }

        function startLogicEdit(id, type, ruleIdx, listType) { activeLogicEdit = { id, type, ruleIdx }; renderLogicList(listType); }
        function cancelLogicEdit(listType) { activeLogicEdit = null; renderLogicList(listType); }
        function updateLogicEditState(id, type, fIdx, listType, ruleIdx, newDep) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule); rule.dep = newDep; renderLogicList(listType);
        }
        function saveLogicEdit(id, type, fIdx, listType, ruleIdx) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule);
            rule.dep = document.getElementById('edit-dep').value; rule.val = document.getElementById('edit-val').value;
            setUnsaved(true); activeLogicEdit = null; renderLogicList(listType);
        }

        function promptEditChoice(fId, depId, type, missingVal) {
            const list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            const f = list.find(x => x.id === fId);
            const dep = list.find(x => x.id === depId);
            
            document.getElementById('btn-edit-self').onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); startLogicEdit(fId, f.visibilityRule?.dep === depId ? 'vis' : 'opt', null, type); };
            
            const btnFix = document.getElementById('btn-fix-source');
            if(dep && missingVal) {
                btnFix.classList.remove('hidden');
                btnFix.onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); showImpactModal(dep, missingVal, list); };
            } else { btnFix.classList.add('hidden'); }

            document.getElementById('choice-modal').classList.remove('hidden');
        }

        function showImpactModal(depField, newVal, contextList) {
            document.getElementById('imp-dep-name').innerText = depField.label;
            document.getElementById('imp-val').innerText = newVal;
            
            let count = 0;
            contextList.forEach(f => {
                if(f.visibilityRule?.dep === depField.id) count++;
                if(f.filterRules) f.filterRules.forEach(r => { if(r.dep === depField.id) count++; });
                else if(f.filterRule?.dep === depField.id) count++;
            });
            document.getElementById('imp-count').innerText = count;

            document.getElementById('btn-confirm-fix').onclick = () => {
                if(!depField.options) depField.options = [];
                if(!depField.options.includes(newVal)) depField.options.push(newVal);
                document.getElementById('impact-modal').classList.add('hidden');
                setUnsaved(true);
                renderLogicList(targetList); 
                showMsg('success', 'ä¿®å¾©æˆåŠŸ', `å·²å°‡ '${newVal}' åŠ å…¥ [${depField.label}] çš„é¸é …ä¸­ã€‚`);
            };
            document.getElementById('impact-modal').classList.remove('hidden');
        }

        // --- Editor Logic ---
        function prepEditor(f = {}) {
            document.getElementById('editor-title').innerText = isEditMode ? 'ç·¨è¼¯æ¬„ä½' : 'å»ºç«‹æ–°æ¬„ä½';
            document.getElementById('ed-orig-id').value = f.id || '';
            document.getElementById('ed-field-id').value = f.id || ''; document.getElementById('ed-field-id').readOnly = isEditMode && targetList !== 'global';
            document.getElementById('ed-label').value = f.label || '';
            document.getElementById('ed-required').checked = f.required || false;
            document.getElementById('ed-system').checked = f.isSystem || false; toggleSystemHint(f.isSystem);

            const catSel = document.getElementById('ed-category'); catSel.innerHTML = '<option value="">æœªåˆ†é¡</option>';
            configData.templateCategories.forEach(c => catSel.innerHTML += `<option value="${c.id}" ${f.category===c.id?'selected':''}>${c.name}</option>`);

            const typeSel = document.getElementById('ed-type'); typeSel.innerHTML = '';
            configData.fieldTypes.forEach(t => typeSel.innerHTML += `<option value="${t.key}" ${f.type===t.key?'selected':''}>${t.label}</option>`);
            if(!f.type) typeSel.value = 'text';

            const visToggle = document.getElementById('vis-toggle');
            const visSettings = document.getElementById('vis-settings');
            const visLabel = document.getElementById('vis-label');
            
            if(f.visibilityRule && f.visibilityRule.dep) {
                visToggle.checked = true; visSettings.classList.remove('hidden'); visLabel.innerText = "å·²å•Ÿç”¨é¡¯ç¤ºæ¢ä»¶"; visLabel.className = "ml-3 text-xs font-bold text-primary"; 
            } else {
                visToggle.checked = false; visSettings.classList.add('hidden'); visLabel.innerText = "ç¸½æ˜¯é¡¯ç¤º (é è¨­)"; visLabel.className = "ml-3 text-xs font-medium text-slate-600";
            }

            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const visDepSel = document.getElementById('ed-vis-dep'); visDepSel.innerHTML = '<option value="">è«‹é¸æ“‡...</option>';
            allFields.filter(x => x.id !== f.id).forEach(x => visDepSel.innerHTML += `<option value="${x.id}" ${f.visibilityRule?.dep===x.id?'selected':''}>${x.label} (${x.id})</option>`);
            document.getElementById('ed-vis-val').value = f.visibilityRule?.val || '';

            document.getElementById('editor-modal').dataset.curr = JSON.stringify(f);
            document.getElementById('editor-modal').classList.remove('hidden');
            renderOpts();
        }

        function toggleVisSettings(checked) {
            const el = document.getElementById('vis-settings'), lbl = document.getElementById('vis-label');
            if(checked) { el.classList.remove('hidden'); lbl.innerText="å·²å•Ÿç”¨é¡¯ç¤ºæ¢ä»¶"; lbl.className="ml-3 text-xs font-bold text-primary"; }
            else { el.classList.add('hidden'); lbl.innerText="ç¸½æ˜¯é¡¯ç¤º (é è¨­)"; lbl.className="ml-3 text-xs font-medium text-slate-600"; }
        }

        function toggleSystemHint(checked) { document.getElementById('sys-hint').classList.toggle('hidden', !checked); }

        function renderOpts() {
            const type = document.getElementById('ed-type').value;
            const container = document.getElementById('ed-opts-container');
            const f = JSON.parse(document.getElementById('editor-modal').dataset.curr || '{}');
            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join('');

            let html = '';
            if(type === 'single_select') {
                const optsText = f.options ? f.options.join(',') : '';
                html = `
                <div class="space-y-6">
                    <div><h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">1. è¨­å®šé¸é …æ¸…å–®</h4><textarea id="ed-opt-list" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-primary outline-none" rows="3" placeholder="ä¾‹å¦‚: æ˜¯,å¦,ä¸ç¢ºå®š" oninput="updateRuleCheckboxes()">${optsText}</textarea><p class="text-[10px] text-slate-400 mt-1">é¸é …é–“è«‹ç”¨åŠå½¢é€—è™Ÿåˆ†éš”ã€‚</p></div>
                    <div class="bg-indigo-50/50 rounded-xl p-5 border border-indigo-100"><div class="flex justify-between items-center mb-4"><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-random"></i> 2. é¸é …é€£å‹•é‚è¼¯ (Logic Rules)</h4><button onclick="addRule()" class="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1 rounded hover:bg-indigo-50 transition font-bold">+ æ–°å¢è¦å‰‡</button></div><p class="text-[11px] text-slate-500 mb-4">è¨­å®šç•¶å…¶ä»–æ¬„ä½çš„å€¼æ”¹è®Šæ™‚ï¼Œæ­¤æ¬„ä½æ‡‰è©²é¡¯ç¤ºå“ªäº›é¸é …ã€‚</p><div id="rule-list" class="space-y-3"></div></div>
                </div>`;
                
                let rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                setTimeout(() => { renderRules(rules, depOpts); window.currentRules = rules; }, 0);

            } else if (type === 'number') {
                html = `<div class="grid grid-cols-2 gap-4"><div><label class="text-sm font-bold text-slate-700 mb-1 block">æ•¸å€¼æ¨¡å¼</label><select id="ed-mode" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="copy">ä¸€èˆ¬/è¤‡è£½</option><option value="average" ${f.calcMode==='average'?'selected':''}>è‡ªå‹•å¹³å‡</option></select></div><div><label class="text-sm font-bold text-slate-700 mb-1 block">å°æ•¸ä½æ•¸</label><input type="number" id="ed-dec" class="w-full border border-slate-300 rounded p-2 text-sm" value="${f.decimal||0}"></div></div><div class="mt-3"><label class="flex items-center text-sm font-bold text-slate-700 cursor-pointer"><input type="checkbox" id="ed-keepZero" ${f.keepZero?'checked':''} class="custom-checkbox mr-2"> ä¿ç•™å‰å°é›¶ (00123)</label></div>`;
            } else if (type === 'date') {
                html = `<div><label class="text-sm font-bold text-slate-700 mb-1 block">æ—¥æœŸæ ¼å¼</label><select id="ed-fmt" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="ROC" ${f.dateFormat==='ROC'?'selected':''}>æ°‘åœ‹ (113/01/01)</option><option value="West" ${f.dateFormat==='West'?'selected':''}>è¥¿å…ƒ (2024-01-01)</option></select></div>`;
            } else {
                html = '<div class="text-center text-sm text-slate-400 py-10">æ­¤é¡å‹ç„¡éœ€é¡å¤–è¨­å®š</div>';
            }
            container.innerHTML = html;
        }

        function renderRules(rules, depOpts) {
            const list = document.getElementById('rule-list'); list.innerHTML = '';
            if(rules.length === 0) { list.innerHTML = '<div class="text-center text-xs text-slate-400 py-2 border border-dashed border-slate-300 rounded">å°šç„¡è¦å‰‡ï¼Œè«‹é»æ“Šæ–°å¢ã€‚</div>'; return; }
            rules.forEach((r, idx) => {
                const row = document.createElement('div'); row.className = 'logic-card p-4 relative bg-white';
                row.innerHTML = `
                    <button onclick="removeRule(${idx})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">ä¾è³´å°è±¡ (æ±ºå®šè€…)</label><select onchange="updateRule(${idx}, 'dep', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs bg-slate-50"><option value="">è«‹é¸æ“‡...</option>${depOpts}</select></div>
                        <div><label class="text-[10px] font-bold text-slate-500 uppercase">ç•¶å…§å®¹æ˜¯ (æ¢ä»¶å€¼)</label><input oninput="updateRule(${idx}, 'val', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs" placeholder="è¼¸å…¥è§¸ç™¼å€¼" value="${r.val||''}"></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">åƒ…é¡¯ç¤ºä¸‹åˆ—é¸é … (Check to Show)</label><div class="flex flex-wrap gap-2" id="chk-container-${idx}"></div></div>`;
                list.appendChild(row); row.querySelector('select').value = r.dep || ''; updateRuleCheckboxes(idx, r.limitTo);
            });
        }

        function updateRuleCheckboxes(ruleIdx = null, selected = []) {
            const raw = document.getElementById('ed-opt-list').value; const opts = raw.split(',').map(s=>s.trim()).filter(s=>s);
            const renderSet = (containerId, currentSel) => {
                const c = document.getElementById(containerId); if(!c) return;
                c.innerHTML = opts.map(o => `<label class="inline-flex items-center bg-slate-50 px-2 py-1 rounded border border-slate-200 text-xs cursor-pointer select-none hover:border-primary"><input type="checkbox" class="mr-1 accent-primary" ${currentSel.includes(o)?'checked':''} onchange="updateRuleLimit(${ruleIdx}, '${o}', this.checked)"> ${o}</label>`).join('');
            };
            if(ruleIdx !== null) renderSet(`chk-container-${ruleIdx}`, selected);
            else { const list = document.getElementById('rule-list'); if(list && window.currentRules) window.currentRules.forEach((r, i) => renderSet(`chk-container-${i}`, r.limitTo || [])); }
        }

        window.addRule = function() {
            window.currentRules.push({ dep: "", val: "", limitTo: [] });
            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join('');
            renderRules(window.currentRules, depOpts);
        };
        window.removeRule = function(idx) {
            window.currentRules.splice(idx, 1);
            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join('');
            renderRules(window.currentRules, depOpts);
        };
        window.updateRule = function(idx, key, val) { window.currentRules[idx][key] = val; };
        window.updateRuleLimit = function(idx, opt, checked) {
            let arr = window.currentRules[idx].limitTo || [];
            if(checked) { if(!arr.includes(opt)) arr.push(opt); } else { arr = arr.filter(x => x !== opt); }
            window.currentRules[idx].limitTo = arr;
        };

        function saveField() {
            const id = document.getElementById('ed-field-id').value.trim(); const label = document.getElementById('ed-label').value.trim();
            if(!id || !label) return showMsg('error','éŒ¯èª¤','è«‹è¼¸å…¥ ID èˆ‡åç¨±');
            
            let f = {};
            if(isEditMode) f = (targetList==='global'?configData.globalFields:yearTemplateData.fields).find(x=>x.id===document.getElementById('ed-orig-id').value);
            
            f.id = id; f.label = label; f.type = document.getElementById('ed-type').value; f.category = document.getElementById('ed-category').value;
            f.required = document.getElementById('ed-required').checked; f.isSystem = document.getElementById('ed-system').checked;

            if(document.getElementById('vis-toggle').checked) {
                f.visibilityRule = { dep: document.getElementById('ed-vis-dep').value, val: document.getElementById('ed-vis-val').value };
            } else { delete f.visibilityRule; }

            if(f.type === 'single_select') {
                f.options = document.getElementById('ed-opt-list').value.split(',').map(s=>s.trim()).filter(s=>s);
                if(window.currentRules && window.currentRules.length > 0) {
                    const validRules = window.currentRules.filter(r => r.dep && r.val);
                    if(validRules.length === 1) { f.filterRule = validRules[0]; delete f.filterRules; } 
                    else if(validRules.length > 1) { f.filterRules = validRules; delete f.filterRule; } 
                    else { delete f.filterRule; delete f.filterRules; }
                } else { delete f.filterRule; delete f.filterRules; }
            }
            if(f.type === 'number') { f.calcMode=document.getElementById('ed-mode').value; f.decimal=parseInt(document.getElementById('ed-dec').value)||0; f.keepZero=document.getElementById('ed-keepZero').checked; }
            if(f.type === 'date') { f.dateFormat=document.getElementById('ed-fmt').value; }

            if(!isEditMode && targetList==='global') { f.order = configData.globalFields.length+1; configData.globalFields.push(f); }

            document.getElementById('editor-modal').classList.add('hidden');
            targetList==='global'?renderGlobalList():renderYearFields(); setUnsaved(true);
            showMsg('info', 'æš«å­˜æˆåŠŸ', 'è¨­å®šå·²æš«å­˜ï¼Œè«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜è¨­å®šã€ç™¼å¸ƒã€‚');
        }

        function openFieldPicker() {
            const list = document.getElementById('picker-list'); list.innerHTML = ''; document.getElementById('picker-select-all').checked=false;
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));
            if(available.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400">å·²åŠ å…¥æ‰€æœ‰æ¨¡æ¿æ¬„ä½</div>';
            else available.forEach(f => list.innerHTML += `<label class="flex items-center p-3 border rounded-lg hover:border-primary cursor-pointer hover:bg-indigo-50 mb-2"><input type="checkbox" value="${f.id}" class="picker-checkbox custom-checkbox mr-3"><div class="flex-grow flex justify-between"><span class="font-bold text-sm text-slate-700">${f.label}</span><span class="text-xs text-slate-400 font-mono">${f.id}</span></div></label>`);
            document.getElementById('picker-modal').classList.remove('hidden');
        }
        function togglePickerAll(cb) { document.querySelectorAll('.picker-checkbox').forEach(c => c.checked = cb.checked); }
        function addSelectedFields() {
            const ids = Array.from(document.querySelectorAll('.picker-checkbox:checked')).map(c=>c.value);
            const map = {}; configData.globalFields.forEach(f=>map[f.id]=f.order); ids.sort((a,b)=>map[a]-map[b]);
            ids.forEach(id=>{ const t=configData.globalFields.find(x=>x.id===id); if(t) yearTemplateData.fields.push(JSON.parse(JSON.stringify(t))); });
            renderYearFields(); setUnsaved(true); document.getElementById('picker-modal').classList.add('hidden');
            showMsg('success', 'æˆåŠŸ', 'æ¬„ä½å·²åŠ å…¥');
        }
        
        function openTypeManager(){switchView('types');renderTypeManagerPage();}
        function renderTypeManagerPage(){const el=document.getElementById('type-list-page');el.innerHTML='';configData.fieldTypes.forEach(t=>el.innerHTML+=`<tr class="hover:bg-slate-50"><td class="px-6 py-3 font-mono text-xs text-primary font-bold">${t.key}</td><td class="px-6 py-3 text-xs font-bold">${t.label}</td><td class="px-6 py-3 text-right"><button onclick="delCustomTypePage('${t.key}')" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`);}
        function addCustomTypePage(){const k=document.getElementById('new-type-key-page').value.trim(),l=document.getElementById('new-type-label-page').value.trim();if(!k||!l)return;if(configData.fieldTypes.some(t=>t.key===k))return showMsg('error','éŒ¯èª¤','Key å·²å­˜åœ¨');configData.fieldTypes.push({key:k,label:l});setUnsaved(true);renderTypeManagerPage(); showMsg('success', 'æˆåŠŸ', 'é¡å‹å·²æ–°å¢'); }
        function delCustomTypePage(k){showMsg('confirm', 'åˆªé™¤é¡å‹ï¼Ÿ', 'å·²ä½¿ç”¨æ­¤é¡å‹çš„æ¬„ä½å¯èƒ½æœƒé¡¯ç¤ºç•°å¸¸ã€‚', null,()=>{configData.fieldTypes=configData.fieldTypes.filter(t=>t.key!==k);setUnsaved(true);renderTypeManagerPage(); showMsg('success', 'æˆåŠŸ', 'é¡å‹å·²åˆªé™¤'); });}

        async function saveConfig() { configSha = await uploadFile(ghConfig.path, configData, configSha); }
        async function saveAll() {
            const btn=document.getElementById('btn-save');btn.disabled=true;btn.innerHTML='<div class="spinner"></div>';
            try { await saveConfig(); if(activeYearId){const p=`hedb/year_templates/year_${activeYearId}_templates.json`;const c=await apiFetch(p);await uploadFile(p,yearTemplateData,c.status===200?c.sha:null);} setUnsaved(false); showMsg('success', 'å„²å­˜æˆåŠŸ', 'æ‰€æœ‰è¨­å®šå·²æ›´æ–°è‡³ GitHub'); }
            catch(e){showMsg('error', 'å„²å­˜å¤±æ•—', e.message);} finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-upload-alt"></i> å„²å­˜è¨­å®š';}
        }

        async function apiFetch(path){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}?t=${Date.now()}`,{headers:{'Authorization':`token ${ghConfig.token}`,'Accept':'application/vnd.github.v3+json'}});if(r.status===404)return{status:404};const d=await r.json();if(Array.isArray(d))return{status:200,data:d};const c=decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));return{status:200,data:JSON.parse(c),sha:d.sha};}
        async function uploadFile(path,data,sha){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'PUT',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Update',content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),sha:sha})});if(!r.ok)throw new Error(r.status);const d=await r.json();return d.content.sha;}
        async function deleteFile(path,sha){await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'DELETE',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Del',sha:sha})});}

        function switchView(v) {
            ['years','fields','types'].forEach(x => { document.getElementById(`view-${x}`).classList.toggle('hidden', v!==x); document.getElementById(`view-${x}`).classList.toggle(x==='types'||x==='fields'?'flex':'flex', v===x); document.getElementById(`nav-${x}`).classList.toggle('active', v===x); });
            if(v==='fields')renderGlobalList(); if(v==='types')renderTypeManagerPage();
        }
        window.onload = init;
    </script>
</body>
</html>
