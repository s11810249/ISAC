<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理後台 (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC',
                        indigo: { 600: '#4F46E5', 700: '#4338CA' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #002E5D 0%, #0f172a 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-stylish { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); background: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .nav-btn.active { border-bottom: 3px solid #002E5D; color: #002E5D; font-weight: bold; background: #f1f5f9; }
        .nav-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover:not(.active) { color: #002E5D; background: #f8fafc; }

        .year-add-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.875rem; }
        .year-add-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .list-item { padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; position: relative; background-color: #ffffff; color: #64748b; border: 1px solid transparent; }
        .list-item:hover { background-color: #f1f5f9; }
        .list-item.active { background-color: #EEF2FF; color: #002E5D; font-weight: bold; border: 1px solid #e0e7ff; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        .btn-manage { background-color: #002E5D; color: white; }
        .btn-manage:hover { background-color: #001e3d; }
        .btn-create { background-color: #219653; color: white; }
        .btn-create:hover { background-color: #1e874b; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-warning { background-color: #F59E0B; color: white; }
        .btn-warning:hover { background-color: #D97706; }

        .data-table th { 
            background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 0.75rem 1rem; 
            font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 20; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        .data-table td { 
            padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; 
            vertical-align: middle;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #f8fafc; }
        
        .action-cell-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            height: 100%;
        }

        .custom-checkbox { height: 1.25rem; width: 1.25rem; border-radius: 0.25rem; border: 2px solid #cbd5e1; color: #002E5D; cursor: pointer; transition: all 0.2s; }
        .custom-checkbox:focus { ring: 2px solid #002E5D; }

        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .logic-card { background: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 0.75rem; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .logic-card:hover { border-color: #94A3B8; box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.08); transform: translateY(-1px); }
        
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .opt-table th { background-color: #f1f5f9; padding: 8px 12px; font-size: 11px; color: #64748b; font-weight: bold; text-align: left; border-bottom: 1px solid #e2e8f0; text-transform: uppercase; letter-spacing: 0.05em; }
        .opt-table td { padding: 6px 12px; font-size: 13px; border-bottom: 1px solid #f8fafc; vertical-align: middle; }
        .opt-table tr:last-child td { border-bottom: none; }
        .opt-table tr:hover td { background-color: #f8fafc; }
        .sortable-ghost { opacity: 0.4; background-color: #e2e8f0; }
        
        .badge-warning { display: inline-block; padding: 2px 8px; background-color: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 9999px; color: #94a3b8; font-size: 11px; font-weight: bold; white-space: nowrap; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-background">

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg"><i class="fas fa-university"></i></div>
                <h1 class="text-2xl font-bold text-primary tracking-wide">東海大學實習平台</h1>
                <p class="text-slate-500 text-sm mt-2 font-medium">系統管理後台 (System Admin)</p>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                <div class="relative"><i class="fas fa-key input-icon"></i><input type="password" id="gh-token" class="input-stylish" placeholder="Access Token"><button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary p-1"><i class="fas fa-eye" id="token-eye"></i></button></div>
                <div class="pt-4"><button onclick="connectGitHub()" id="btn-connect" class="w-full btn-manage font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><span>登入系統</span><i class="fas fa-arrow-right"></i></button><div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div></div>
            </div>
        </div>
    </div>

    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <div class="flex items-center gap-3"><div class="w-8 h-8 bg-primary text-white rounded flex items-center justify-center text-sm shadow"><i class="fas fa-tools"></i></div><h1 class="font-bold text-lg tracking-wide text-primary">系統配置中心</h1></div>
            <div class="flex items-center gap-3">
                <div id="unsaved-badge" class="hidden px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold border border-amber-200 flex items-center gap-1 animate-pulse"><i class="fas fa-pen"></i> 未儲存</div>
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100"><i class="fas fa-check-circle mr-1"></i> 儲存成功</span>
                <button onclick="saveAll()" id="btn-save" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all"><i class="fas fa-cloud-upload-alt"></i> 儲存設定</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> 登出</button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200 px-6 flex-shrink-0 z-20">
            <div class="flex gap-6">
                <button onclick="switchView('years')" id="nav-years" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 active"><i class="fas fa-calendar-alt"></i> 學年度模組配置</button>
                <button onclick="switchView('fields')" id="nav-fields" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-layer-group"></i> 欄位模板庫</button>
                <button onclick="switchView('types')" id="nav-types" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-tags"></i> 欄位類型管理</button>
                <button onclick="switchView('internship')" id="nav-internship" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-users"></i> 實習學生名單彙整</button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden bg-slate-50">
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openYearModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-plus text-lg"></i> 新增學年度</div></div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">學年度列表</div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-year-title">...</span><span id="default-badge" class="hidden text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">預設年度</span></h2><p class="text-xs text-slate-400 mt-1">此學年度的欄位配置 (獨立模組)</p></div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-white transition select-none mr-2"><input type="checkbox" id="is-default-year" class="custom-checkbox" onchange="toggleDefaultYear()"> 設為預設</label>
                                <button onclick="renameCurrentYear()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2.5 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentYear()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2.5 rounded-lg transition" title="刪除學年度"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ul text-primary"></i> 欄位列表</h3>
                                    <div class="flex items-center gap-2 ml-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm"><i class="fas fa-filter text-slate-400 text-xs"></i><select id="year-filter-cat" onchange="renderYearFields()" class="text-sm text-slate-600 outline-none bg-transparent cursor-pointer hover:text-primary"><option value="all">顯示所有分類</option></select></div>
                                    <button onclick="openLogicSummary('year')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                                    <div id="year-batch-controls" class="hidden">
                                        <button onclick="openBatchModal('year')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="year-batch-count">0</span>)</button>
                                    </div>
                                </div>
                                <button onclick="openFieldPicker()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> 從模板複製加入</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleYearAll(this); updateBatchControlVisibility('year')" class="custom-checkbox"></th><th class="w-16 text-center">排序</th><th class="w-1/4 text-center">欄位名稱 (ID)</th><th class="w-24 text-center">分類</th><th class="w-24 text-center">類型</th><th class="w-24 text-center">屬性</th><th class="w-40 text-center">操作</th></tr></thead><tbody id="year-field-list"></tbody></table></div></div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400"><div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-calendar-alt"></i></div><p>請從左側選擇或新增一個學年度模組</p></div>
                </section>
            </div>

            <div id="view-fields" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white"><div onclick="openCategoryModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success"><i class="fas fa-folder-plus text-lg"></i> 新增模板分類</div></div>
                    <div id="template-cat-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50 list-none"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                        <div><h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-cat-title">全部欄位</span></h2><p class="text-xs text-slate-400 mt-1">管理可供學年度引用的欄位原型。</p></div>
                        <div class="flex items-center gap-3">
                            <button onclick="openLogicSummary('global')" class="btn-warning text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold mr-2"><i class="fas fa-project-diagram"></i> 邏輯總覽與衝突檢測</button>
                            <div id="global-batch-controls" class="hidden">
                                <button onclick="openBatchModal('global')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold"><i class="fas fa-tasks"></i> 批次處理 (<span id="global-batch-count">0</span>)</button>
                            </div>
                            <div id="cat-actions" class="hidden border-r border-slate-200 pr-3 mr-1 flex gap-1"><button onclick="renameCurrentCat()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button><button onclick="deleteCurrentCat()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2 rounded-lg transition" title="刪除分類"><i class="fas fa-trash-alt"></i></button></div>
                            <button onclick="addNewGlobalField()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 建立新模板</button>
                        </div>
                    </div>
                    <div class="flex-grow p-8 overflow-hidden flex flex-col"><div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm"><div class="overflow-y-auto custom-scroll flex-grow"><table class="w-full data-table"><thead class="sticky top-0 bg-slate-50 z-10 shadow-sm"><tr><th class="w-12 text-center"><input type="checkbox" onchange="toggleGlobalAll(this); updateBatchControlVisibility('global')" class="custom-checkbox"></th><th class="w-16 text-center">序號</th><th class="w-1/4 text-center">欄位名稱 (ID)</th><th class="w-24 text-center">類型</th><th class="w-48 text-center">屬性</th><th class="w-40 text-center">操作</th></tr></thead><tbody id="global-field-list"></tbody></table></div></div></div>
                </section>
            </div>

            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>

            <div id="view-internship" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <label for="student-list-file" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-file-upload text-lg"></i> 上傳註課組清單
                        </label>
                        <input type="file" id="student-list-file" onchange="handleFileUpload(event)" class="hidden">
                        <p id="file-status" class="text-xs text-slate-400 mt-2 text-center">請上傳 .xlsx 或 .csv</p>
                    </div>
                    
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">名單分組列表</div>
                    <div id="internship-group-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll list-none">
                         <div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup('all')"><span class="font-bold text-sm">全部 (總表單)</span></div>
                         <div class="p-8 text-center text-slate-400 text-xs hidden" id="group-list-empty-state">請先上傳名單並完成彙整</div>
                    </div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="internship-config-panel" class="flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center flex-shrink-0">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <span id="current-internship-group-title">實習學生名單彙整中心</span>
                                </h2>
                                <p class="text-xs text-slate-400 mt-1">
                                    <span id="group-detail-subtitle">請上傳名單並進行匹配</span>
                                </p>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="downloadAllGroupsZip()" id="btn-batch-download-all-results-main" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all hidden"><i class="fas fa-file-archive"></i> 全系批次下載 (打包ZIP)</button>
                                <button onclick="openAllianceModal()" id="btn-alliance-config" disabled class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-sitemap"></i> 設定系所分組/聯盟</button>
                            </div>
                        </div>
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            
                            <div id="results-display-area" class="flex-grow bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col">
                                <div id="results-empty-state" class="p-8 text-center text-slate-400">
                                    <div class="w-16 h-16 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-2xl mx-auto"><i class="fas fa-table"></i></div>
                                    請上傳名單，並在彈出視窗中完成欄位匹配。
                                </div>
                                <div id="results-table-container" class="hidden flex-grow overflow-y-auto custom-scroll">
                                    <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center sticky top-0 z-10">
                                        <h4 class="text-sm font-bold text-slate-700">共 <span id="current-group-record-count">0</span> 筆紀錄</h4>
                                        <button onclick="downloadBatch(currentSelectedGroup)" class="btn-create py-1.5 px-4 rounded-lg text-xs font-bold shadow-sm"><i class="fas fa-file-excel mr-1"></i> 下載此分組名單</button>
                                    </div>
                                    <table class="w-full data-table">
                                        <thead class="sticky top-0 bg-white">
                                            <tr id="results-table-headers"></tr>
                                        </thead>
                                        <tbody id="results-table-body"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div><h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2><p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p></div>
                            <button onclick="openAddrRules()" class="bg-white border border-slate-300 text-slate-600 hover:text-primary hover:border-primary px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2"><i class="fas fa-cog"></i> 設定地址正規化規則</button>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead><tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody></table></div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm"><h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4><div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end"><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div><div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div></div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="mapping-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-random text-primary"></i> 欄位匹配與彙整設定</h3>
                <button onclick="document.getElementById('mapping-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-white">
                <div class="mb-6">
                    <label class="block text-sm font-bold text-slate-700 mb-2">① 選擇學年度模組</label> 
                    <select id="consolidation-year-select" onchange="fetchCurrentTemplateFields()" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div class="mb-2 flex justify-between items-end">
                    <label class="block text-sm font-bold text-slate-700">② 欄位匹配 (系統欄位 → 上傳清單欄位)</label>
                    <p class="text-xs text-slate-500">請確保所有**必填**系統欄位皆匹配到上傳清單中的正確 Excel 欄位名稱。</p>
                </div>
                
                <div id="mapping-fields-container" class="space-y-3 grid grid-cols-2 gap-x-6 gap-y-3 p-4 bg-slate-50 rounded-lg border border-slate-200">
                    </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('mapping-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="processUploadedFile()" class="px-6 py-2 btn-create rounded-lg font-bold text-sm shadow hover:shadow-lg transition flex items-center gap-2"><i class="fas fa-cogs"></i> 開始彙整名單</button>
            </div>
        </div>
    </div>

    <div id="msg-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4 transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm" id="msg-icon"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="msg-title"></h3><p class="text-sm text-slate-500 mb-6 leading-relaxed" id="msg-desc"></p>
            <div id="msg-input-area" class="hidden mb-6 text-left"><label class="block text-xs font-bold text-slate-400 uppercase mb-1" id="msg-input-label"></label><input type="text" id="msg-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none text-slate-700"><div id="msg-select-area" class="hidden mt-3"><label class="block text-xs font-bold text-slate-400 uppercase mb-1">複製來源</label><select id="msg-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select></div></div>
            <div class="flex gap-3 justify-center" id="msg-btns"></div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-5xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sliders-h text-primary"></i> <span id="editor-title">編輯欄位屬性</span></h3>
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="flex flex-grow overflow-hidden">
                <div class="w-80 bg-slate-50 border-r border-slate-200 flex-shrink-0 overflow-y-auto custom-scroll p-6 space-y-5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">基本設定</h4>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位 ID <span class="text-red-500">*</span></label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono text-blue-600 focus:ring-primary outline-none" placeholder="e.g. f_name"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">顯示名稱 <span class="text-red-500">*</span></label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none" placeholder="e.g. 學生姓名"></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位說明 (Help Text)</label><textarea id="ed-desc" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-primary outline-none resize-none h-20" placeholder="例如: 請填寫學生所屬學院..."></textarea><p class="text-[10px] text-slate-400 mt-1">此說明僅顯示於填報介面提示，不會匯出至 Excel。</p></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">所屬分類</label><select id="ed-category" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none"></select></div>
                    <div><label class="text-xs font-bold text-slate-600 mb-1 block">欄位類型</label><select id="ed-type" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-primary outline-none" onchange="renderOpts()"></select></div>
                    <div class="pt-2 space-y-3">
                        <div>
                            <label class="flex items-center text-sm cursor-pointer mb-1"><input type="checkbox" id="ed-system" class="custom-checkbox mr-2" onchange="toggleSystemHint(this.checked)"> <span class="font-bold text-slate-700">系統自動帶入 (唯讀/匯入)</span></label>
                            <p id="sys-hint" class="text-[10px] text-amber-600 pl-6 leading-tight">此欄位對應匯入檔案，使用者無法編輯。建議勾選『必填』確保資料完整。</p>
                        </div>
                        <label class="flex items-center text-sm cursor-pointer"><input type="checkbox" id="ed-required" class="custom-checkbox mr-2"> <span class="font-bold text-slate-700">必填項目</span></label>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto custom-scroll bg-white">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-eye"></i> 欄位顯示控制 (Visibility)</h4><p class="text-[11px] text-slate-400 mt-1">控制此欄位在什麼情況下才顯示。</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="vis-toggle" class="sr-only peer" onchange="toggleVisSettings(this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600" id="vis-label">總是顯示</span></label>
                        </div>
                        <div id="vis-settings" class="hidden bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex items-center gap-2 text-xs text-slate-500 mb-2"><i class="fas fa-info-circle"></i> 當以下條件成立時，執行動作：</div>
                            <div class="grid grid-cols-3 gap-4">
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">依賴對象 (決定者)</label><select id="ed-vis-dep" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"></select></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">當內容是 (條件值)</label><input id="ed-vis-val" class="w-full border border-slate-300 rounded p-2 text-sm" placeholder="輸入觸發值"></div>
                                <div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">動作 (Action)</label><select id="ed-vis-action" class="w-full border border-slate-300 rounded p-2 text-sm bg-white"><option value="show">顯示 (Show)</option><option value="hide">隱藏 (Hide)</option></select></div>
                            </div>
                        </div>
                    </div>
                    <div id="ed-opts-container" class="p-8"></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm transition">取消</button>
                <button onclick="saveField()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow hover:shadow-lg transition">確認暫存</button>
            </div>
        </div>
    </div>

    <div id="logic-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[80vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-project-diagram text-primary"></i> 邏輯總覽與衝突檢測</h3>
                <button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll p-8 bg-slate-50">
                <div id="logic-conflicts" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-lg"><h4 class="text-red-700 font-bold flex items-center gap-2 mb-2"><i class="fas fa-exclamation-triangle"></i> 發現邏輯問題</h4><ul id="conflict-list" class="list-disc list-inside text-sm text-red-600 space-y-2"></ul></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-eye text-indigo-500 mr-2"></i> 顯示條件 (Visibility)</span><span id="vis-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="vis-list" class="space-y-4"></div></div>
                    <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center justify-between"><span><i class="fas fa-list-ul text-emerald-500 mr-2"></i> 選項連動 (Option Logic)</span><span id="opt-count" class="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-500">0</span></h4><div id="opt-list" class="space-y-4"></div></div>
                </div>
            </div>
            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end"><button onclick="document.getElementById('logic-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm shadow">關閉視窗</button></div>
        </div>
    </div>

    <div id="addr-rules-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-map-marker-alt text-primary"></i> 地址正規化規則設定</h3>
                <button onclick="document.getElementById('addr-rules-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">保護名單 (Whitelist)</label>
                    <p class="text-xs text-slate-500 mb-2">下列詞彙中的中文數字不會被轉換 (例如：五權路)。請用逗號分隔。</p>
                    <textarea id="addr-protected" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">識別關鍵字 (Keywords)</label>
                    <p class="text-xs text-slate-500 mb-2">當中文數字出現在這些字之前，將強制轉為阿拉伯數字 (例如：五段 -> 5段)。</p>
                    <textarea id="addr-keywords" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-700 mb-1 block">特定路名模式 (Specific Patterns)</label>
                    <p class="text-xs text-slate-500 mb-2">遇到這些詞（如：東南西北、區、道）開頭或接續的數字，將強制轉為阿拉伯數字。</p>
                    <textarea id="addr-specials" class="w-full border border-slate-300 rounded-lg p-3 text-sm focus:ring-primary outline-none h-24 resize-none"></textarea>
                </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAddrRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存規則</button>
            </div>
        </div>
    </div>

    <div id="choice-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300"><div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-tools"></i></div><h3 class="text-lg font-bold text-slate-800 mb-2">請選擇修正方式</h3><p class="text-sm text-slate-500 mb-6">您想要修改目前的「規則設定」，還是補齊「源頭選項」？</p><div class="flex flex-col gap-3"><button id="btn-edit-self" class="w-full py-3 rounded-lg border border-indigo-200 text-indigo-700 font-bold hover:bg-indigo-50 transition flex items-center justify-center gap-2"><i class="fas fa-sliders-h"></i> 修改規則設定</button><button id="btn-fix-source" class="w-full py-3 rounded-lg border border-emerald-200 text-emerald-700 font-bold hover:bg-emerald-50 transition flex items-center justify-center gap-2"><i class="fas fa-plus-circle"></i> 補齊源頭選項 (自動修復)</button></div><button onclick="document.getElementById('choice-modal').classList.add('hidden')" class="mt-4 text-xs text-slate-400 hover:text-slate-600 underline">取消</button></div></div>
    <div id="impact-modal" class="fixed inset-0 z-[90] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="flex items-center gap-3 mb-4 text-amber-600"><i class="fas fa-exclamation-triangle text-2xl"></i><h3 class="text-lg font-bold text-slate-800">確認變更源頭結構</h3></div><p class="text-sm text-slate-600 mb-4 leading-relaxed">您即將在源頭欄位 <span id="imp-dep-name" class="font-bold text-primary"></span> 中新增選項 <span id="imp-val" class="font-bold text-emerald-600 bg-emerald-50 px-1 rounded"></span>。</p><div class="bg-slate-50 p-3 rounded-lg border border-slate-200 text-xs text-slate-500 mb-6"><p class="font-bold mb-1">影響範圍評估：</p><p>此欄位目前被 <span id="imp-count" class="font-bold text-primary">0</span> 個規則引用。新增選項通常是安全的，但請確保這符合您的資料定義。</p></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('impact-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button id="btn-confirm-fix" class="px-4 py-2 bg-emerald-600 text-white rounded-lg font-bold shadow-md hover:bg-emerald-700 text-sm">確認新增並修復</button></div></div></div>
    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]"><div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="text-lg font-bold text-slate-800">從模板複製欄位</h3><button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button></div><div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200"><label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer"><input type="checkbox" id="picker-select-all" class="custom-checkbox mr-2" onchange="togglePickerAll(this)"> 全選 / 取消全選</label></div><div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div><div class="mt-4 pt-2 border-t border-slate-100 flex justify-end"><button onclick="addSelectedFields()" class="w-full btn-create font-bold py-2.5 rounded-lg shadow">確認複製選取欄位</button></div></div></div>
    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-overlay p-4"><div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800">移動順序</h3><p class="text-sm text-slate-500 mt-1">將 <span id="move-target-name" class="font-bold text-primary"></span> 移動至：</p></div><div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-h-60 overflow-y-auto custom-scroll"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('move-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button><button onclick="saveMove()" class="px-4 py-2 btn-manage rounded-lg font-bold shadow-md text-sm">確認移動</button></div></div></div>
    <div id="batch-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-tasks text-indigo-600"></i> 欄位批次處理</h3>
                <button onclick="document.getElementById('batch-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="space-y-4">
                <p class="text-sm text-slate-600">您已選取 <span id="batch-count" class="font-bold text-primary">0</span> 個欄位進行批次處理。</p>
                
                <div class="space-y-3">
                    <label class="text-sm font-bold text-slate-700 mb-1 block">請選擇要執行的動作</label>
                    <select id="batch-action-select" onchange="toggleBatchActionSettings(this.value)" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none">
                        <option value="">請選擇...</option>
                        <option value="category">變更所屬分類</option>
                        <option value="delete">刪除選取項目</option>
                    </select>
                </div>
                
                <div id="batch-category-group" class="hidden space-y-3">
                    <label class="text-sm font-bold text-slate-700 block">新分類</label>
                    <select id="batch-category-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
                
                <div id="batch-delete-confirm" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-700 font-bold flex items-center gap-2"><i class="fas fa-exclamation-triangle"></i> 確認刪除</p>
                    <p class="text-xs text-red-600 mt-1">此操作不可復原，請謹慎確認。</p>
                </div>
            </div>
            <div class="mt-6 pt-3 border-t border-slate-100 flex justify-end gap-3">
                <button onclick="executeBatchAction()" id="btn-execute-batch" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold shadow-md hover:bg-indigo-700 text-sm flex items-center gap-2" disabled><i class="fas fa-check"></i> 確認執行</button>
            </div>
        </div>
    </div>
    <div id="alliance-modal" class="fixed inset-0 z-[85] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6 flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-sitemap text-primary"></i> 系所分組/聯盟設定</h3>
                <button onclick="document.getElementById('alliance-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto custom-scroll space-y-4 p-1">
                <p class="text-sm text-slate-600">在此設定多組系所聯盟。若「開課學系」屬於任一聯盟，且「學生所屬學系」也在**同一聯盟**中，則該紀錄會以**聯盟名稱**分組；否則以**開課學系**分組。聯盟間的學系不應重複。</p>
                <div id="alliance-rules-container" class="space-y-4">
                    </div>
            </div>
            <div class="mt-4 pt-3 border-t border-slate-100 flex justify-end">
                <button onclick="saveAllianceRules()" class="px-6 py-2 btn-manage rounded-lg font-bold text-sm shadow">儲存聯盟設定</button>
            </div>
        </div>
    </div>
    <script>
        let ghConfig = { user: '', repo: '', path: 'hedb/config.json', token: '' };
        let configData = { 
            globalFields: [], 
            academicYears: [], 
            templateCategories: [], 
            fieldTypes: [], 
            addressRules: { protected: [], keywords: [], specials: [] },
            allianceModeDepts: [] // This property will now store an array of alliance group objects
        }; 
        let yearTemplateData = { fields: [] }; 
        let activeYearId = null, activeCatId = 'all', isEditMode = false, moveSrcIndex = -1, moveType = '', targetList = 'global', unsavedChanges = false, configSha = null, activeLogicEdit = null;
        let currentOptions = [], currentRules = [], currentOptionDescs = {};
        let editingOptionIdx = -1; let isOptionBatchMode = false;
        let activeBatchListType = '';

        // NEW: Internship Consolidation Data
        let currentConsolidationYear = null;
        let currentFileHeaders = [];
        let currentMapping = {};
        let currentStudentData = null; 
        let currentConsolidatedResults = null;
        let uniqueCourseDepts = []; 
        let currentTemplateFields = [];
        let currentSelectedGroup = null; // Track selected group in the sidebar
        
        // R3: Define SYSTEM_FIELDS and their output order
        const SYSTEM_FIELDS = [
            { id: 'school_year', label: '學年', required: true, isSystem: true, order: 1, example: '114' },
            { id: 'semester', label: '學期', required: true, isSystem: true, order: 2, example: '1' },
            { id: 'student_id', label: '學號', required: true, isSystem: true, order: 3, example: '12345678' },
            { id: 'student_name', label: '姓名', required: true, isSystem: true, order: 4, example: '王小明' },
            { id: 'student_college', label: '學院', required: true, isSystem: true, order: 5, example: '管理學院' }, 
            { id: 'student_dept', label: '學系', required: true, isSystem: true, order: 6, example: '資管系' },      
            { id: 'course_id', label: '選課代號', required: true, isSystem: true, order: 7, example: '8099' },
            { id: 'course_name', label: '課程名稱', required: true, isSystem: true, order: 8, example: '校外實習' }, 
            { id: 'internship_attr', label: '實習課程屬性', required: false, isSystem: true, order: 9, example: '必選' },
            { id: 'internship_credit', label: '實習學分數', required: true, isSystem: true, order: 10, example: '3' }, 
            { id: 'course_system', label: '開課學制', required: true, isSystem: true, order: 11, example: '日間部' }, 
            { id: 'course_college', label: '開課學院', required: true, isSystem: true, order: 12, example: '管理學院' }, 
            { id: 'course_dept', label: '開課學系', required: true, isSystem: true, order: 13, example: '國貿系' },
            { id: 'student_grade', label: '學生年級', required: true, isSystem: true, order: 14, example: '四年級' },
            { id: 'student_gender', label: '性別', required: false, isSystem: true, order: 15, example: '男' },
            { id: 'student_nationality', label: '實習生國籍', required: false, isSystem: true, order: 16, example: '中華民國' }
        ];

        // R3: Define preview field display order (Used for sorting output fields)
        const PREVIEW_FIELD_IDS = ['semester', 'course_college', 'course_dept', 'course_id', 'course_name', 'internship_attr', 'internship_credit', 'student_id', 'student_name', 'student_college', 'student_dept'];
        
        const REQUIRED_FIELD_IDS = SYSTEM_FIELDS.filter(f => f.required).map(f => f.id);
        
        // END NEW: Internship Consolidation Data

        const SYSTEM_DEFAULT_TYPES = [
            {key:'text', label:'文字'}, {key:'number', label:'數字'}, {key:'date', label:'日期'}, {key:'single_select', label:'單選'}, {key:'list', label:'條列式'},
            {key:'address', label:'地址'} 
        ];

        function init() {
            if(localStorage.getItem('gh_creds_v10')) localStorage.removeItem('gh_creds_v10');
            const saved = localStorage.getItem('gh_creds_safe');
            if(saved) { const c = JSON.parse(saved); document.getElementById('gh-user').value = c.user || ''; document.getElementById('gh-repo').value = c.repo || ''; }
            window.addEventListener('beforeunload', (e) => { if (unsavedChanges) { e.preventDefault(); e.returnValue = ''; } });
            document.getElementById('student-list-file').addEventListener('change', handleFileUpload);
        }
        function setUnsaved(val) { unsavedChanges = val; document.getElementById('unsaved-badge').classList.toggle('hidden', !val); }

        async function connectGitHub() {
            const btn = document.getElementById('btn-connect'), msg = document.getElementById('login-msg'), user = document.getElementById('gh-user').value.trim(), repo = document.getElementById('gh-repo').value.trim(), token = document.getElementById('gh-token').value.trim();
            if(!user || !repo || !token) { msg.style.opacity='1'; msg.innerText='請填寫完整資訊'; return; }
            btn.innerHTML = '<div class="spinner"></div> 連線中...'; btn.disabled = true; ghConfig = { user, repo, path: 'hedb/config.json', token };
            try {
                const res = await apiFetch(ghConfig.path);
                if(res.status === 404) { configData = { globalFields: [], academicYears: [], templateCategories: [], fieldTypes: [], addressRules: { protected: [], keywords: [], specials: [] }, allianceModeDepts: [] }; configSha = null; } 
                else { 
                    configData = res.data; configSha = res.sha; 
                    if(!configData.templateCategories) configData.templateCategories = []; 
                    if(!configData.fieldTypes) configData.fieldTypes = []; 
                    if(!configData.addressRules) configData.addressRules = { protected: ['五權', '三民', '三多', '一心', '二聖', '七賢', '八德', '九如', '十全'], keywords: ['段', '路', '街', '巷', '弄', '號', '樓', '鄰', '之'], specials: ['東', '南', '西', '北', '區', '道'] };
                    if(!configData.addressRules.specials) configData.addressRules.specials = ['東', '南', '西', '北', '區', '道'];
                    
                    // R1: Handle conversion from old simple array of strings to new array of objects
                    if (!configData.allianceModeDepts || Array.isArray(configData.allianceModeDepts) && (configData.allianceModeDepts.length === 0 || typeof configData.allianceModeDepts[0] === 'string')) {
                        // Clear old/missing format to force new object array structure
                        configData.allianceModeDepts = []; 
                    }
                    
                    const uniqueTypes = new Map(); [...SYSTEM_DEFAULT_TYPES, ...configData.fieldTypes].forEach(t => uniqueTypes.set(t.key, t)); configData.fieldTypes = Array.from(uniqueTypes.values()); 
                }
                
                configData.templateCategories.forEach((c, i) => { if (c.order === undefined) c.order = i; });

                localStorage.setItem('gh_creds_safe', JSON.stringify({ user, repo })); sessionStorage.setItem('gh_token', token);
                document.getElementById('login-screen').classList.add('hidden'); document.getElementById('admin-interface').classList.remove('hidden'); document.getElementById('admin-interface').style.opacity = '1';
                await syncYearsFromFiles(); renderYearList(); if(configData.academicYears.length > 0) selectYear(configData.academicYears[0].year); renderTemplateCats(); renderTypeManagerPage(); renderInternshipView(); 
            } catch (err) { 
                console.error(err); msg.style.opacity='1'; msg.innerText = err.message.includes('401') ? '登入失敗：Access Token 錯誤' : '連線失敗'; 
            } finally { btn.innerHTML = '登入系統'; btn.disabled = false; }
        }

        async function syncYearsFromFiles() { try { const dirRes = await apiFetch('hedb/year_templates'); if(dirRes.status !== 200 || !Array.isArray(dirRes.data)) return; const fileYears = dirRes.data.filter(f => f.name.match(/^year_(.+)_templates\.json$/)).map(f => f.name.match(/^year_(.+)_templates\.json$/)[1]); let changed = false; fileYears.forEach(y => { if(!configData.academicYears.some(cy => cy.year === y)) { configData.academicYears.push({ year: y, isDefault: false }); changed = true; } }); if(changed) { configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); setUnsaved(true); showMsg('info', '同步完成', '系統已自動偵測到檔案庫中的學年度模組。'); } } catch(e) {} }
        function toggleToken() { const t = document.getElementById('gh-token'), i = document.getElementById('token-eye'); t.type = t.type === 'password' ? 'text' : 'password'; i.className = t.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash'; }
        function logout() { showMsg('confirm', '確定登出？', '未儲存的變更將會遺失。', null, () => { localStorage.removeItem('gh_creds_safe'); sessionStorage.removeItem('gh_token'); location.reload(); }); }

        function showMsg(type, title, desc, inputConfig = null, onConfirm = null) {
            const modal = document.getElementById('msg-modal'), icon = document.getElementById('msg-icon'), btns = document.getElementById('msg-btns'), inputArea = document.getElementById('msg-input-area');
            document.getElementById('msg-title').innerText = title; document.getElementById('msg-desc').innerText = desc;
            inputArea.classList.add('hidden'); document.getElementById('msg-select-area').classList.add('hidden');
            let iconClass = '', iconHtml = '';
            if(type === 'success') { iconClass = 'bg-emerald-100 text-emerald-600'; iconHtml = '<i class="fas fa-check"></i>'; }
            else if(type === 'error') { iconClass = 'bg-red-100 text-red-600'; iconHtml = '<i class="fas fa-times"></i>'; }
            else if(type === 'info') { iconClass = 'bg-blue-100 text-blue-600'; iconHtml = '<i class="fas fa-info"></i>'; }
            else if(type === 'confirm' || type === 'prompt') { iconClass = 'bg-amber-100 text-amber-600'; iconHtml = '<i class="fas fa-question"></i>'; }
            icon.className = `w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm ${iconClass}`; icon.innerHTML = iconHtml;
            if(type === 'prompt' && inputConfig) { inputArea.classList.remove('hidden'); document.getElementById('msg-input-label').innerText = inputConfig.label || '名稱'; const inp = document.getElementById('msg-input'); inp.value = inputConfig.value || ''; if(inputConfig.showSelect) { document.getElementById('msg-select-area').classList.remove('hidden'); const sel = document.getElementById('msg-select'); sel.innerHTML = '<option value="">不複製 (空白)</option>'; configData.academicYears.forEach(y => sel.innerHTML += `<option value="${y.year}">複製 ${y.year}</option>`); } setTimeout(() => inp.focus(), 50); }
            btns.innerHTML = '';
            const cancelBtn = document.createElement('button'); cancelBtn.className = 'px-5 py-2.5 rounded-lg border border-slate-300 font-bold text-slate-600 hover:bg-slate-50 transition text-sm'; cancelBtn.innerText = type === 'success' || type === 'info' ? '關閉' : '取消'; cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); }; btns.appendChild(cancelBtn);
            if(type === 'confirm' || type === 'prompt') { const okBtn = document.createElement('button'); okBtn.className = `px-5 py-2.5 rounded-lg font-bold text-white shadow-md transition text-sm ${type==='prompt' ? 'bg-primary' : 'bg-danger'}`; okBtn.innerText = '確認'; okBtn.onclick = async () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); if(onConfirm) { if(type === 'prompt') await onConfirm(document.getElementById('msg-input').value.trim(), document.getElementById('msg-select').value); else await onConfirm(); } }; btns.appendChild(okBtn); }
            modal.classList.remove('hidden'); setTimeout(() => { modal.classList.add('opacity-100'); document.getElementById('msg-panel').classList.remove('scale-95'); document.getElementById('msg-panel').classList.add('scale-100'); }, 10);
        }

        // --- Utility function for Batch Controls visibility ---
        function updateBatchControlVisibility(type) {
            const checkboxClass = type === 'global' ? '.global-check' : '.year-check';
            const controlContainer = document.getElementById(type + '-batch-controls');
            const countSpan = document.getElementById(type + '-batch-count');
            const checkedCount = document.querySelectorAll(checkboxClass + ':checked').length;

            if (checkedCount > 0) {
                controlContainer.classList.remove('hidden');
                if (countSpan) countSpan.innerText = checkedCount;
            } else {
                controlContainer.classList.add('hidden');
            }
        }

        // --- Core Functions ---
        function renderYearList() { const el = document.getElementById('year-list'); el.innerHTML = ''; configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); configData.academicYears.forEach(y => { const div = document.createElement('div'); div.className = `list-item ${activeYearId===y.year?'active':''}`; div.onclick = () => selectYear(y.year); div.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold text-sm">${y.year} 學年度</span>${y.isDefault?'<span class="text-[10px] bg-secondary text-white px-1.5 rounded font-bold ml-2">Def</span>':''}</div>`; el.appendChild(div); }); }
        function openYearModal() { showMsg('prompt', '新增學年度', '請輸入學年度並選擇是否複製模板', {label: '學年度 (如: 114)', showSelect: true}, async (year, copyFrom) => { if(!year || configData.academicYears.some(y => y.year === year)) return showMsg('error','錯誤','學年度已存在'); try { let initialData = { fields: [] }; if (copyFrom) { const res = await apiFetch(`hedb/year_templates/year_${copyFrom}_templates.json`); if (res.status === 200) initialData = res.data; } const path = `hedb/year_templates/year_${year}_templates.json`; const check = await apiFetch(path); await uploadFile(path, initialData, check.status===200?check.sha:null); configData.academicYears.push({ year, isDefault: false }); await saveConfig(); setUnsaved(false); renderYearList(); selectYear(year); showMsg('success', '成功', '學年度模組已建立'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        function renameCurrentYear() { if(!activeYearId) return; showMsg('prompt', '重新命名學年度', '請輸入新名稱，這將會搬移設定檔。', {label: '新名稱', value: activeYearId}, async (newYear) => { if(!newYear || newYear === activeYearId || configData.academicYears.some(y=>y.year===newYear)) return; try { const oldPath = `hedb/year_templates/year_${activeYearId}_templates.json`; const newPath = `hedb/year_templates/year_${newYear}_templates.json`; const res = await apiFetch(oldPath); const checkNew = await apiFetch(newPath); await uploadFile(newPath, res.status===200?res.data:{fields:[]}, checkNew.status===200?checkNew.sha:null); if(res.status===200) await deleteFile(oldPath, res.sha); const y = configData.academicYears.find(y=>y.year===activeYearId); y.year = newYear; await saveConfig(); activeYearId = newYear; renderYearList(); selectYear(newYear); showMsg('success','成功','學年度已重新命名'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        async function selectYear(year) { activeYearId = year; renderYearList(); document.getElementById('current-year-title').innerText = `${year} 學年度`; const yConf = configData.academicYears.find(y => y.year === year); document.getElementById('is-default-year').checked = yConf.isDefault || false; document.getElementById('default-badge').classList.toggle('hidden', !yConf.isDefault); document.getElementById('year-empty-state').classList.add('hidden'); document.getElementById('year-config-panel').classList.remove('hidden'); document.getElementById('year-config-panel').classList.add('flex'); updateYearFilterOptions(); document.getElementById('year-filter-cat').value = 'all'; document.getElementById('year-field-list').innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>讀取設定中...</td></tr>`; try { const res = await apiFetch(`hedb/year_templates/year_${year}_templates.json`); yearTemplateData = res.status===404?{fields:[]}:res.data; renderYearFields(); } catch(e) { document.getElementById('year-field-list').innerHTML = `<tr><td colspan="7" class="p-4 text-red-500 text-center">讀取失敗: ${e.message}</td></tr>`; } }
        function updateYearFilterOptions() { const sel = document.getElementById('year-filter-cat'), val = sel.value; sel.innerHTML = '<option value="all">所有分類</option>'; configData.templateCategories.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`); sel.innerHTML += '<option value="uncategorized">未分類</option>'; sel.value = val; }
        function deleteCurrentYear() { showMsg('confirm', '確認刪除學年度？', `這將會刪除 ${activeYearId} 學年度，無法復原。`, null, async () => { try { const path = `hedb/year_templates/year_${activeYearId}_templates.json`; const check = await apiFetch(path); if(check.status===200) await deleteFile(path, check.sha); configData.academicYears = configData.academicYears.filter(y => y.year !== activeYearId); await saveConfig(); activeYearId = null; setUnsaved(false); document.getElementById('year-config-panel').classList.add('hidden'); document.getElementById('year-empty-state').classList.remove('hidden'); renderYearList(); showMsg('success','成功','學年度已刪除'); } catch(e) { showMsg('error','失敗',e.message); } }); }
        
        function renderYearFields() { 
            const listEl = document.getElementById('year-field-list'), filter = document.getElementById('year-filter-cat')?.value || 'all'; 
            listEl.innerHTML = ''; 
            yearTemplateData.fields.forEach((f, idx) => { 
                if(filter !== 'all' && ((filter==='uncategorized'&&f.category) || (filter!=='uncategorized'&&f.category!==filter))) return; 
                const catName = configData.templateCategories.find(c => c.id === f.category)?.name || '未分類'; 
                const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; 
                
                let attributes = [];
                if (f.required) attributes.push('<span class="text-red-500 bg-red-50 px-1 rounded text-[10px] font-bold">必填</span>');
                if (f.isSystem) attributes.push('<span class="text-blue-500 bg-blue-50 px-1 rounded text-[10px] font-bold">系統</span>');
                const attributeText = attributes.join(' ');
                
                const isFiltered = filter !== 'all';
                const btns = !isFiltered 
                    ? `<button onclick="moveField(${idx},-1,'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${idx},1,'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="openMoveModal(${idx},'year')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 text-primary mr-1" title="移動至..."><i class="fas fa-exchange-alt"></i></button>` 
                    : '';
                
                const actionBtns = `<button onclick="editField('${f.id}','year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="編輯"><i class="fas fa-pen"></i></button><button onclick="removeYearField(${idx})" class="p-1.5 hover:bg-red-100 rounded text-slate-400 text-danger" title="刪除"><i class="fas fa-trash-alt"></i></button>`; 
                
                listEl.innerHTML += `<tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="w-12 text-center py-3"><input type="checkbox" onchange="updateBatchControlVisibility('year')" class="year-check custom-checkbox" value="${idx}"></td>
                    <td class="w-16 text-center font-mono text-xs text-slate-400 py-3">${idx+1}</td>
                    <td class="w-1/4 text-left font-bold text-slate-700 text-sm py-3">
                        <div class="flex flex-col items-start justify-center h-full gap-0.5">
                            <div class="flex items-center gap-2"><span>${f.label}</span>${f.description ? `<i class="fas fa-info-circle text-slate-300 hover:text-primary" title="${f.description}"></i>` : ''}</div>
                            <span class="text-[10px] text-slate-400 font-mono block">${f.id}</span>
                        </div>
                    </td>
                    <td class="w-24 text-center text-xs text-slate-500 py-3">${catName}</td>
                    <td class="w-24 text-center text-xs text-slate-500 py-3">${typeName}</td>
                    <td class="w-24 text-center text-xs text-slate-400 py-3">${attributeText}</td>
                    <td class="w-40 text-center py-3">
                        <div class="action-cell-content">
                            ${btns}${actionBtns}
                        </div>
                    </td>
                </tr>`; 
            }); 
            if(listEl.innerHTML==='') listEl.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">尚未加入欄位</td></tr>'; 
            const emptyRow = document.querySelector('#year-field-list tr td[colspan]');
            if (emptyRow) emptyRow.setAttribute('colspan', '7');
            updateBatchControlVisibility('year'); 
        }
        function removeYearField(idx) { showMsg('confirm', '移除欄位？', '確定要從此學年度移除此欄位？', null, () => { yearTemplateData.fields.splice(idx, 1); renderYearFields(); setUnsaved(true); showMsg('success', '成功', '欄位已移除'); }); }
        function toggleYearAll(el) { document.querySelectorAll('.year-check').forEach(c => c.checked = el.checked); }
        function deleteSelectedYearFields() { const chk = Array.from(document.querySelectorAll('.year-check:checked')).map(c=>parseInt(c.value)); if(chk.length) showMsg('confirm', '批次刪除', `確定移除選取的 ${chk.length} 個欄位？`, null, () => { chk.sort((a,b)=>b-a).forEach(i => yearTemplateData.fields.splice(i,1)); renderYearFields(); setUnsaved(true); showMsg('success', '成功', '已移除選取項目'); }); }
        function toggleDefaultYear() { const chk = document.getElementById('is-default-year').checked; configData.academicYears.forEach(y => y.isDefault = false); const curr = configData.academicYears.find(y => y.year === activeYearId); if(curr) curr.isDefault = chk; document.getElementById('default-badge').classList.toggle('hidden', !chk); setUnsaved(true); showMsg('success', '成功', '預設學年度已更新'); }

        function moveCategory(id, dir) {
            const list = configData.templateCategories;
            const idx = list.findIndex(c => c.id === id);
            if (idx === -1 || idx + dir < 0 || idx + dir >= list.length) return;
            
            [list[idx], list[idx + dir]] = [list[idx + dir], list[idx]];
            
            list.forEach((c, i) => c.order = i);
            
            renderTemplateCats();
            setUnsaved(true);
        }

        function renderTemplateCats() { 
            const el = document.getElementById('template-cat-list'); 
            configData.templateCategories.sort((a,b) => a.order - b.order);
            
            el.innerHTML = `<div class="list-item ${activeCatId==='all'?'active':''}" onclick="selectCat('all')"><span class="font-bold text-sm">全部欄位</span></div>`; 
            
            configData.templateCategories.forEach(c => {
                const isActive = activeCatId===c.id;
                const upBtn = `<button onclick="moveCategory('${c.id}', -1)" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button>`;
                const downBtn = `<button onclick="moveCategory('${c.id}', 1)" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button>`;
                
                const itemHtml = `
                    <div class="flex items-center justify-between w-full">
                        <span class="font-bold text-sm flex-grow">${c.name}</span>
                        <div class="flex items-center gap-1">
                            ${upBtn}
                            ${downBtn}
                        </div>
                    </div>
                `;

                el.innerHTML += `<div class="list-item ${isActive?'active':''}" onclick="selectCat('${c.id}')" data-id="${c.id}">${itemHtml}</div>`;
            }); 
            
            el.innerHTML += `<div class="list-item ${activeCatId==='uncategorized'?'active':''}" onclick="selectCat('uncategorized')"><span class="text-sm">未分類</span></div>`; 
            
            updateYearFilterOptions(); 
        }
        
        function openCategoryModal() { showMsg('prompt', '新增模板分類', '請輸入分類名稱', {label: '名稱'}, (v)=>{if(v){configData.templateCategories.push({id:'cat_'+Date.now(),name:v, order: configData.templateCategories.length});renderTemplateCats();setUnsaved(true); showMsg('success', '成功', '分類已建立'); }}); }
        function renameCurrentCat() { const c=configData.templateCategories.find(x=>x.id===activeCatId); if(c) showMsg('prompt', '重新命名分類', {label: '名稱',value:c.name},(v)=>{if(v){c.name=v;renderTemplateCats();setUnsaved(true);document.getElementById('current-cat-title').innerText=v; showMsg('success', '成功', '分類已重新命名'); }}); }
        function deleteCurrentCat() { showMsg('confirm', '刪除分類？', '分類下的欄位將變為「未分類」。', null,()=>{ configData.templateCategories=configData.templateCategories.filter(c=>c.id!==activeCatId); configData.globalFields.forEach(f=>{if(f.category===activeCatId)delete f.category}); selectCat('all'); setUnsaved(true); showMsg('success', '成功', '分類已刪除'); }); }
        function selectCat(id) { activeCatId=id; renderTemplateCats(); document.getElementById('current-cat-title').innerText=id==='all'?'全部欄位':id==='uncategorized'?'未分類':configData.templateCategories.find(c=>c.id===id).name; document.getElementById('cat-actions').classList.toggle('hidden', id==='all'||id==='uncategorized'); renderGlobalList(); }
        
        function renderGlobalList() { 
            const el = document.getElementById('global-field-list'); 
            let list = configData.globalFields; 
            
            if(activeCatId==='uncategorized') list=list.filter(f=>!f.category); 
            else if(activeCatId!=='all') list=list.filter(f=>f.category===activeCatId); 
            
            list.sort((a,b)=>a.order-b.order); 
            
            el.innerHTML = list.map((f,i)=> { 
                const typeName = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type; 
                
                const isFiltered = activeCatId !== 'all'; 
                const btns = !isFiltered 
                    ? `<button onclick="moveField(${i},-1,'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveField(${i},1,'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="openMoveModal(${i},'global')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 text-primary mr-1" title="移動至..."><i class="fas fa-exchange-alt"></i></button>` 
                    : ''; 
                
                const actionBtns = `<button onclick="editField('${f.id}','global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400" title="編輯"><i class="fas fa-pen"></i></button><button onclick="delGlobalField('${f.id}')" class="p-1.5 hover:bg-red-100 rounded text-slate-400 text-danger" title="刪除"><i class="fas fa-trash-alt"></i></button>`;
                
                let attributes = [];
                if (f.required) attributes.push('<span class="text-red-500 bg-red-50 px-1 rounded text-[10px] font-bold">必填</span>');
                if (f.isSystem) attributes.push('<span class="text-blue-500 bg-blue-50 px-1 rounded text-[10px] font-bold">系統</span>');
                const attributeText = attributes.join(' ');

                return `<tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="w-12 text-center py-3"><input type="checkbox" onchange="updateBatchControlVisibility('global')" class="global-check custom-checkbox" value="${f.id}"></td>
                    <td class="w-16 text-center font-mono text-xs text-slate-400 py-3">${i+1}</td>
                    <td class="w-1/4 text-left font-bold text-slate-700 text-sm py-3">
                        <div class="flex flex-col items-start justify-center h-full gap-0.5">
                            <div class="flex items-center gap-2"><span>${f.label}</span>${f.description ? `<i class="fas fa-info-circle text-slate-300 hover:text-primary" title="${f.description}"></i>` : ''}</div>
                            <span class="text-[10px] text-slate-400 font-mono block">${f.id}</span>
                        </div>
                    </td>
                    <td class="w-24 text-center text-xs text-primary font-mono py-3">${typeName}</td>
                    <td class="w-48 text-center text-xs text-slate-400 py-3">${attributeText}</td>
                    <td class="w-40 text-center py-3">
                        <div class="action-cell-content">
                            ${btns}${actionBtns}
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
            updateBatchControlVisibility('global'); 
        }
        function addNewGlobalField() { isEditMode=false;targetList='global';prepEditor(); }
        function editField(id, type) { isEditMode=true;targetList=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; prepEditor(list.find(f=>f.id===id)); }
        function delGlobalField(id) { showMsg('confirm', '刪除模板？', '確定刪除此模板？', null,()=>{configData.globalFields=configData.globalFields.filter(f=>f.id!==id);renderGlobalList();setUnsaved(true); showMsg('success', '成功', '模板已刪除'); }); }
        
        function moveField(idx,dir,type) { const list=type==='global'?configData.globalFields:yearTemplateData.fields; if(list[idx+dir]){[list[idx],list[idx+dir]]=[list[idx+dir],list[idx]]; if(type==='global')list.forEach((f,i)=>f.order=i); type==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); /* Silent Sort */ } }
        function openMoveModal(idx,type) { moveSrcIndex=idx;moveType=type;const list=type==='global'?configData.globalFields:yearTemplateData.fields; const sel=document.getElementById('move-select'); sel.innerHTML=''; list.forEach((f,i)=>sel.innerHTML+=`<option value="${i}" ${i===idx?'selected':''}>${i+1}. ${f.label}</option>`); document.getElementById('move-target-name').innerText=list[idx].label; document.getElementById('move-modal').classList.remove('hidden'); }
        function saveMove() { const t=parseInt(document.getElementById('move-select').value); if(t!==moveSrcIndex){ const list=moveType==='global'?configData.globalFields:yearTemplateData.fields; list.splice(t,0,list.splice(moveSrcIndex,1)[0]); if(moveType==='global')list.forEach((f,i)=>f.order=i); moveType==='global'?renderGlobalList():renderYearFields(); setUnsaved(true); /* Silent Sort */ } document.getElementById('move-modal').classList.add('hidden'); }

        // --- Batch Modal Logic ---
        function toggleGlobalAll(el) { document.querySelectorAll('.global-check').forEach(c => c.checked = el.checked); }
        
        function openBatchModal(type) {
            activeBatchListType = type;
            const checkboxClass = type === 'global' ? '.global-check' : '.year-check';
            const checkedElements = Array.from(document.querySelectorAll(checkboxClass + ':checked'));
            
            if (checkedElements.length === 0) return;

            document.getElementById('batch-count').innerText = checkedElements.length;
            
            const catSelect = document.getElementById('batch-category-select');
            catSelect.innerHTML = '<option value="">請選擇新分類 (維持不變)</option><option value="uncategorized">未分類</option>';
            configData.templateCategories.sort((a,b) => a.order - b.order).forEach(c => {
                catSelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });

            document.getElementById('batch-action-select').value = '';
            toggleBatchActionSettings('');
            document.getElementById('batch-modal').classList.remove('hidden');
        }
        
        function toggleBatchActionSettings(action) {
            const catGroup = document.getElementById('batch-category-group');
            const deleteConfirm = document.getElementById('batch-delete-confirm');
            const executeBtn = document.getElementById('btn-execute-batch');
            
            catGroup.classList.add('hidden');
            deleteConfirm.classList.add('hidden');
            executeBtn.disabled = true;

            if (action === 'category') {
                catGroup.classList.remove('hidden');
                document.getElementById('batch-category-select').onchange = (e) => {
                    executeBtn.disabled = !e.target.value;
                };
                document.getElementById('batch-category-select').onchange();
            } else if (action === 'delete') {
                deleteConfirm.classList.remove('hidden');
                executeBtn.disabled = false;
            }
        }

        function executeBatchAction() {
            const action = document.getElementById('batch-action-select').value;
            const list = activeBatchListType === 'global' ? configData.globalFields : yearTemplateData.fields;
            const checkboxClass = activeBatchListType === 'global' ? '.global-check' : '.year-check';
            const checkedElements = Array.from(document.querySelectorAll(checkboxClass + ':checked'));
            const checkedValues = checkedElements.map(c => activeBatchListType === 'global' ? c.value : parseInt(c.value)); 

            if (checkedElements.length === 0 || !action || (action === 'category' && !document.getElementById('batch-category-select').value)) {
                document.getElementById('batch-modal').classList.add('hidden');
                return;
            }
            
            let successMsg = '';

            if (action === 'category') {
                const newCatId = document.getElementById('batch-category-select').value;
                const newCatText = document.getElementById('batch-category-select').options[document.getElementById('batch-category-select').selectedIndex].text;
                
                checkedElements.forEach(c => {
                    const item = activeBatchListType === 'global' 
                        ? list.find(f => f.id === c.value) 
                        : list[parseInt(c.value)];
                    
                    if (item) {
                        if (newCatId === 'uncategorized') {
                            delete item.category;
                        } else if (newCatId) { 
                            item.category = newCatId;
                        }
                    }
                });

                successMsg = `已將選取的 ${checkedElements.length} 個欄位變更/設定為 ${newCatText}。`;

            } else if (action === 'delete') {
                if (activeBatchListType === 'global') {
                    configData.globalFields = configData.globalFields.filter(f => !checkedValues.includes(f.id));
                    configData.globalFields.sort((a,b) => a.order - b.order).forEach((f,i) => f.order = i);
                } else { 
                    checkedValues.sort((a,b) => b - a).forEach(index => {
                        yearTemplateData.fields.splice(index, 1);
                    });
                }
                successMsg = `已成功刪除選取的 ${checkedElements.length} 個欄位。`;
            }

            document.querySelectorAll(checkboxClass).forEach(c => c.checked = false);
            
            setUnsaved(true);
            activeBatchListType === 'global' ? renderGlobalList() : renderYearFields();
            updateBatchControlVisibility(activeBatchListType);
            
            document.getElementById('batch-modal').classList.add('hidden');
            showMsg('success', action === 'delete' ? '刪除成功' : '批次成功', successMsg);
        }

        // --- Internship Consolidation Logic (Updated) ---
        
        async function fetchCurrentTemplateFields() {
            if (!currentConsolidationYear) return;
            const res = await apiFetch(`hedb/year_templates/year_${currentConsolidationYear}_templates.json`);
            currentTemplateFields = res.status === 200 ? res.data.fields : [];
        }

        function renderInternshipView() {
            // R3: Renders the year selector and resets the UI state
            const selectEl = document.getElementById('consolidation-year-select');
            selectEl.innerHTML = configData.academicYears.map(y => `<option value="${y.year}">${y.year} 學年度模組</option>`).join(''); 
            
            currentSelectedGroup = null; 

            if (configData.academicYears.length > 0) {
                currentConsolidationYear = selectEl.value;
                fetchCurrentTemplateFields(); 
            } 

            // Set initial state
            document.getElementById('current-internship-group-title').innerText = '實習學生名單彙整中心';
            document.getElementById('group-detail-subtitle').innerText = '請上傳名單並進行匹配';
            document.getElementById('mapping-panel').classList.add('hidden');
            document.getElementById('results-table-container').classList.add('hidden');
            document.getElementById('results-empty-state').classList.remove('hidden');
            document.getElementById('btn-batch-download-all-results-main').classList.add('hidden');
            document.getElementById('btn-process-list').disabled = true;

            document.getElementById('internship-group-list').innerHTML = '<div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup(\'all\')"><span class="font-bold text-sm">全部 (總表單)</span></div>' + 
                                                                         '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state">請先上傳名單並完成彙整</div>';
            document.getElementById('group-all-item').classList.add('active');
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('file-status').innerText = '檔案讀取中...';
            document.getElementById('mapping-fields-container').innerHTML = '';
            document.getElementById('mapping-panel').classList.add('hidden');
            document.getElementById('results-empty-state').classList.remove('hidden');
            document.getElementById('results-table-container').classList.add('hidden');
            document.getElementById('btn-batch-download-all-results-main').classList.add('hidden');
            document.getElementById('internship-group-list').innerHTML = '<div class="list-item" id="group-all-item" onclick="selectConsolidatedGroup(\'all\')"><span class="font-bold text-sm">全部 (總表單)</span></div>' +
                                                                         '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>讀取檔案中...</div>';
            currentStudentData = null;
            currentFileHeaders = [];
            uniqueCourseDepts = [];
            currentSelectedGroup = null;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    if (typeof XLSX === 'undefined') throw new Error("XLSX 函式庫未定義。"); 
                    const workbook = XLSX.read(data, { type: 'array' }); 
                    
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false, defval: "" });
                    if (sheetData.length === 0) throw new Error("檔案內容為空");
                    
                    currentFileHeaders = sheetData[0].filter(h => h !== undefined && h !== null && h.toString().trim() !== ""); 

                    currentStudentData = XLSX.utils.sheet_to_json(worksheet, { raw: true, defval: "" });
                    currentStudentData = currentStudentData.filter(row => Object.keys(row).length > 0); 
                    
                    const courseDeptLabel = SYSTEM_FIELDS.find(f => f.id === 'course_dept').label;
                    const courseDeptHeaderKey = currentFileHeaders.find(h => h && h.toString().includes(courseDeptLabel));

                    if (courseDeptHeaderKey) {
                        const departments = currentStudentData.map(row => (row[courseDeptHeaderKey] || '').toString().trim()).filter(d => d);
                        uniqueCourseDepts = [...new Set(departments)].sort();
                    } 

                    document.getElementById('file-status').innerText = `已讀取檔案: ${file.name} (${currentFileHeaders.length} 欄, ${currentStudentData.length} 筆資料). 請進行匹配。`;
                    
                    // 3. File upload successful: Trigger mapping setup
                    // This re-renders mapping panel and enables buttons
                    promptMappingSetup();
                    document.getElementById('btn-process-list').disabled = false;


                } catch (e) {
                    showMsg('error', '檔案讀取失敗', `請確認檔案格式為有效的 XLSX/CSV。錯誤: ${e.message}`);
                    document.getElementById('student-list-file').value = null; 
                    document.getElementById('file-status').innerText = '讀取失敗，請重新上傳。';
                }
            };
            reader.onerror = function(e) {
                 showMsg('error', '檔案讀取錯誤', '無法讀取檔案內容。');
            };
            reader.readAsArrayBuffer(file);
        }
        
        function promptMappingSetup() {
            const selectEl = document.getElementById('consolidation-year-select');
            
            // Re-render year options
            selectEl.innerHTML = configData.academicYears.map(y => `<option value="${y.year}">${y.year} 學年度模組</option>`).join('');
            
            // Auto-select default year if available
            const defaultYear = configData.academicYears.find(y => y.isDefault)?.year || configData.academicYears[0]?.year;
            if (defaultYear) {
                selectEl.value = defaultYear;
                currentConsolidationYear = defaultYear;
                fetchCurrentTemplateFields();
            }

            renderMappingPanel();
            
            // 修改 3: 開啟彈跳視窗
            document.getElementById('mapping-modal').classList.remove('hidden');
            
            document.getElementById('btn-alliance-config').disabled = false;
            document.getElementById('btn-alliance-config').className = "btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all";
        }
        
        function renderMappingPanel() {
            if (!currentFileHeaders || currentFileHeaders.length === 0) return;

            const container = document.getElementById('mapping-fields-container');
            container.innerHTML = '';
            currentMapping = {};
            
            const excelHeaderOptions = ['<option value="">-- 請選擇 Excel 欄位 --</option>', ...currentFileHeaders.map(h => `<option value="${h}">${h}</option>`)].join('');

            SYSTEM_FIELDS.forEach(sysField => {
                const isRequired = sysField.required ? '<span class="text-red-500">*</span>' : '';
                const sysLabel = sysField.label;
                
                const autoMatchedHeader = currentFileHeaders.find(h => h && h.toString().includes(sysLabel));
                
                if (autoMatchedHeader) {
                    currentMapping[sysField.id] = autoMatchedHeader;
                } else {
                    currentMapping[sysField.id] = '';
                }

                container.innerHTML += `
                    <div class="flex items-center gap-4">
                        <span class="w-1/2 font-bold text-slate-800 text-sm truncate" title="${sysLabel} (${sysField.id})">${sysLabel} ${isRequired}</span>
                        <i class="fas fa-arrow-right text-slate-400 text-xs flex-shrink-0"></i>
                        <select data-field-id="${sysField.id}" onchange="updateMapping(this.dataset.fieldId, this.value)" class="w-1/2 border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-primary outline-none">
                            ${excelHeaderOptions}
                        </select>
                    </div>
                `;
            });
            
            setTimeout(() => {
                document.querySelectorAll('#mapping-fields-container select').forEach(select => {
                    const fieldId = select.dataset.fieldId;
                    if (currentMapping[fieldId]) {
                         select.value = currentMapping[fieldId];
                    }
                });
            }, 0);

            // Mapping panel is now inside the modal, so we just ensure content is ready
        }

        function updateMapping(fieldId, excelHeader) {
            currentMapping[fieldId] = excelHeader;
        }

        async function processUploadedFile() {
            if (!currentStudentData) return showMsg('error', '錯誤', '請先上傳名單檔案。');
            currentConsolidationYear = document.getElementById('consolidation-year-select').value;
            if (!currentConsolidationYear) return showMsg('error', '錯誤', '請先選擇要套用的學年度模組。');
            
            await fetchCurrentTemplateFields();

            const mappedKeys = Object.keys(currentMapping).filter(k => currentMapping[k]);
            
            const missingRequired = REQUIRED_FIELD_IDS.filter(id => !mappedKeys.includes(id));
            if (missingRequired.length > 0) {
                const missingLabels = missingRequired.map(id => SYSTEM_FIELDS.find(f => f.id === id).label);
                return showMsg('error', '錯誤', `請匹配以下必填系統欄位：${missingLabels.join('、')}。`);
            }
            
            // Close the mapping modal
            document.getElementById('mapping-modal').classList.add('hidden');
            
            // Show processing status
            document.getElementById('group-list-empty-state').innerHTML = '<div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>彙整中...';


            const mappedData = currentStudentData.map(row => {
                const newRow = {};
                
                SYSTEM_FIELDS.forEach(sysField => {
                    const fileHeader = currentMapping[sysField.id];
                    if (fileHeader) { 
                        newRow[sysField.id] = (row[fileHeader] || '').toString().trim();
                    } else if (SYSTEM_FIELDS.find(f => f.id === sysField.id)) {
                        newRow[sysField.id] = '';
                    }
                });
                
                currentTemplateFields.forEach(tf => {
                    if (!newRow[tf.id]) { 
                         newRow[tf.id] = '';
                    }
                });

                return newRow;
            }).filter(row => row.student_id && row.course_dept); 

            if (mappedData.length === 0) {
                document.getElementById('group-list-empty-state').innerHTML = '無可彙整名單';
                return showMsg('info', '無有效資料', '檔案中沒有符合條件的有效記錄。請檢查欄位和資料。');
            }
            
            const groupedData = {};
            const allianceGroups = configData.allianceModeDepts || []; 

            mappedData.forEach(record => {
                const courseDept = record.course_dept;
                const studentDept = record.student_dept;

                let finalGroupingKey;
                let foundAlliance = null;
                
                for (const group of allianceGroups) {
                    if (group.depts.includes(courseDept)) {
                        foundAlliance = group;
                        break;
                    }
                }

                if (foundAlliance) {
                    if (foundAlliance.depts.includes(studentDept)) {
                        finalGroupingKey = foundAlliance.name; 
                    } else {
                        finalGroupingKey = courseDept;
                    }
                } else {
                    finalGroupingKey = courseDept;
                }
                
                if (!groupedData[finalGroupingKey]) {
                    groupedData[finalGroupingKey] = [];
                }
                groupedData[finalGroupingKey].push(record);
            });

            currentConsolidatedResults = {};
            for (const groupName in groupedData) {
                groupedData[groupName].sort((a, b) => {
                    if (a.student_id !== b.student_id) return a.student_id.localeCompare(b.student_id);
                    if (a.semester !== b.semester) return a.semester.localeCompare(b.semester);
                    if (a.course_dept !== b.course_dept) return a.course_dept.localeCompare(b.course_dept); 
                    return a.course_id.localeCompare(b.course_id); 
                });
                currentConsolidatedResults[groupName] = groupedData[groupName];
            }
            
            document.getElementById('total-records').innerText = mappedData.length; 
            document.getElementById('btn-batch-download-all-results-main').classList.remove('hidden');
            renderInternshipSidebar();
            
            // Auto select "All"
            selectConsolidatedGroup('all'); 

            showMsg('success', '彙整完成', '名單已成功分組與排序，請查看側邊欄結果。');
        }

        function renderInternshipSidebar() {
            const el = document.getElementById('internship-group-list');
            el.innerHTML = '';
            
            if (!currentConsolidatedResults || Object.keys(currentConsolidatedResults).length === 0) {
                el.innerHTML = '<div class="list-item active" id="group-all-item" onclick="selectConsolidatedGroup(\'all\')"><span class="font-bold text-sm">全部 (總表單)</span></div>' + 
                               '<div class="p-8 text-center text-slate-400 text-xs" id="group-list-empty-state">無可彙整名單</div>';
                return;
            }

            const totalRecords = Object.values(currentConsolidatedResults).reduce((sum, group) => sum + group.length, 0);
            const sortedGroupNames = Object.keys(currentConsolidatedResults).sort();

            el.innerHTML = '<div class="list-item" id="group-all-item" onclick="selectConsolidatedGroup(\'all\')"><span class="font-bold text-sm">全部 (總表單)</span><span class="text-xs bg-primary/10 text-primary px-1.5 py-0.5 rounded ml-2">'+totalRecords+'</span></div>';
            document.getElementById('group-list-empty-state').classList.add('hidden');

            sortedGroupNames.forEach(groupName => {
                const count = currentConsolidatedResults[groupName].length;
                const isActive = currentSelectedGroup === groupName;
                
                const div = document.createElement('div');
                div.className = `list-item ${isActive ? 'active' : ''}`;
                div.onclick = () => selectConsolidatedGroup(groupName);
                div.innerHTML = `<div class="flex items-center justify-between"><span class="font-bold text-sm truncate">${groupName}</span><span class="text-xs bg-primary/10 text-primary px-1.5 py-0.5 rounded">${count}</span></div>`;
                el.appendChild(div);
            });
            
            if(currentSelectedGroup) {
                document.querySelectorAll('#internship-group-list .list-item').forEach(item => {
                    item.classList.remove('active');
                    if(item.querySelector('span')?.innerText.includes(currentSelectedGroup) || (currentSelectedGroup === 'all' && item.id === 'group-all-item')) {
                        item.classList.add('active');
                    }
                });
            }
        }
        
        function selectConsolidatedGroup(groupName) {
            currentSelectedGroup = groupName;
            renderInternshipSidebar();
            
            const isAll = groupName === 'all';
            let dataToShow = isAll ? [] : currentConsolidatedResults[groupName];
            
            if (isAll) {
                Object.values(currentConsolidatedResults).forEach(group => {
                    dataToShow = dataToShow.concat(group);
                });
            }

            if (isAll) {
                document.getElementById('current-internship-group-title').innerText = `實習學生名單彙整中心：【全部 (總表單)】`;
                document.getElementById('group-detail-subtitle').innerText = `共 ${dataToShow.length} 筆紀錄`;
            } else {
                document.getElementById('current-internship-group-title').innerText = `實習學生名單彙整中心：【${groupName}】`;
                document.getElementById('group-detail-subtitle').innerText = `共 ${dataToShow.length} 筆紀錄`;
            }

            renderConsolidatedTable(dataToShow);
        }
        
        function renderConsolidatedTable(dataToShow) {
            const tableContainer = document.getElementById('results-table-container');
            const emptyState = document.getElementById('results-empty-state');
            const headersRow = document.getElementById('results-table-headers');
            const tbody = document.getElementById('results-table-body');
            
            if (!dataToShow || dataToShow.length === 0) {
                 tableContainer.classList.add('hidden');
                 emptyState.classList.remove('hidden');
                 document.getElementById('current-group-record-count').innerText = 0;
                 return;
            }

            emptyState.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            const allOutputFieldsMap = new Map();
            SYSTEM_FIELDS.forEach(f => allOutputFieldsMap.set(f.id, f));
            currentTemplateFields.forEach(f => allOutputFieldsMap.set(f.id, f));
            
            const allOutputFields = Array.from(allOutputFieldsMap.values());
            allOutputFields.sort((a, b) => a.order - b.order); 

            const headers = allOutputFields.map(f => `<th class="text-center">${f.label.replace(/\s*\(必填\)/g, '')}</th>`).join('');
            
            headersRow.innerHTML = `<th>#</th>${headers}`;
            document.getElementById('current-group-record-count').innerText = dataToShow.length;
            
            const rows = dataToShow.map((row, idx) => {
                const cells = allOutputFields.map(f => `
                    <td class="text-center py-2 text-xs">
                        ${row[f.id] || '<span class="text-slate-300">-</span>'}
                    </td>
                `).join('');
                
                return `
                    <tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                        <td class="w-12 text-center py-3 text-xs font-mono text-slate-400">${idx + 1}</td>
                        ${cells}
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }

        // --- Download Logic (with Field Order) ---
        function downloadBatch(groupName) {
            const groupData = groupName === 'all' ? Object.values(currentConsolidatedResults).flat() : currentConsolidatedResults[groupName];
            if (!groupData || groupData.length === 0) return;

            const allOutputFieldsMap = new Map();
            SYSTEM_FIELDS.forEach(f => allOutputFieldsMap.set(f.id, f));
            currentTemplateFields.forEach(f => allOutputFieldsMap.set(f.id, f));
            const allOutputFields = Array.from(allOutputFieldsMap.values());
            allOutputFields.sort((a, b) => a.order - b.order); // Sort by defined order

            const headers = allOutputFields.map(f => f.id);
            const headerLabels = allOutputFields.map(f => f.label.replace(/\s*\(必填\)/g, ''));
            
            const data = groupData.map(row => headers.map(header => row[header] || ''));
            
            const wsData = [headerLabels, ...data];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, groupName === 'all' ? '總表單' : groupName);
            
            const filename = `【${currentConsolidationYear}學年度修課】校庫填報清單-${groupName === 'all' ? '總表單' : groupName}.xlsx`;
            XLSX.writeFile(wb, filename);
        }
        
        function downloadAllGroupsZip() {
            if (!currentConsolidatedResults || Object.keys(currentConsolidatedResults).length === 0) {
                 return showMsg('info', '無資料', '目前沒有可供下載的彙整名單。');
            }

            const btn = document.getElementById('btn-batch-download-all-results-main');
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner border-slate-500 border-t-white"></div> 打包中...';

            const zip = new JSZip();
            const allOutputFieldsMap = new Map();
            SYSTEM_FIELDS.forEach(f => allOutputFieldsMap.set(f.id, f));
            currentTemplateFields.forEach(f => allOutputFieldsMap.set(f.id, f));
            const allOutputFields = Array.from(allOutputFieldsMap.values());
            allOutputFields.sort((a, b) => a.order - b.order); 
            
            const headers = allOutputFields.map(f => f.id);
            const headerLabels = allOutputFields.map(f => f.label.replace(/\s*\(必填\)/g, ''));

            for (const groupName in currentConsolidatedResults) {
                const groupData = currentConsolidatedResults[groupName];
                
                const data = groupData.map(row => headers.map(header => row[header] || ''));
                const wsData = [headerLabels, ...data];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, groupName);
                
                const wopts = { bookType: 'xlsx', type: 'binary' };
                const wbout = XLSX.write(wb, wopts);
                const s2ab = (s) => {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return view;
                };
                
                const filename = `【${currentConsolidationYear}學年度修課】校庫填報清單-${groupName}.xlsx`;
                zip.file(filename, s2ab(wbout), { binary: true });
            }
            
            zip.generateAsync({ type: "blob" })
               .then(function(content) {
                   saveAs(content, `${currentConsolidationYear}_全系實習彙整名單.zip`);
                   showMsg('success', '打包完成', '全系實習名單已打包成 ZIP 檔案開始下載。');
               })
               .catch(err => {
                   showMsg('error', '打包失敗', `建立 ZIP 檔案時發生錯誤：${err.message}`);
               })
               .finally(() => {
                   btn.disabled = false;
                   btn.innerHTML = '<i class="fas fa-file-archive"></i> 全系批次下載 (打包ZIP)';
               });
        }


        // --- Alliance Modal Logic (Multi-Group Support) ---
        function openAllianceModal() {
            const requiredDeptFieldsMapped = REQUIRED_FIELD_IDS.filter(id => id === 'course_dept' || id === 'student_dept').every(id => currentMapping[id]);
            
            // 由於AllianceModal不再依賴Mapping面板，只需確保有學系清單即可
            if (!uniqueCourseDepts || uniqueCourseDepts.length === 0) {
                // 從 departments.json 中提取所有學系
                fetchDepartmentsForAlliance();
            }

            renderAllianceRules();
            document.getElementById('alliance-modal').classList.remove('hidden');
        }
        
        async function fetchDepartmentsForAlliance() {
             try {
                const res = await apiFetch('s11810249/isac/ISAC-fce6c62ab32db11a35b571ad2927c576ce180c96/data_departments.json');
                if (res.status === 200 && res.data.departments) {
                    const allDepts = [];
                    res.data.departments.forEach(college => {
                        college.departments.forEach(dept => {
                            if (dept.name && dept.name !== college.name) {
                                allDepts.push(dept.name);
                            }
                        });
                    });
                    uniqueCourseDepts = [...new Set(allDepts)].sort();
                    renderAllianceRules(); 
                }
            } catch (e) {
                showMsg('error', '讀取系所清單失敗', '無法從 departments.json 讀取系所清單以供聯盟設定。');
            }
        }


        function renderAllianceRules() {
            const container = document.getElementById('alliance-rules-container');
            const allianceGroups = configData.allianceModeDepts || []; 
            
            if (uniqueCourseDepts.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-slate-400">目前無法取得學系清單，請確認 departments.json 檔案是否存在。</div>';
                return;
            }

            let groupsHtml = allianceGroups.map((group, groupIndex) => {
                const deptCheckboxes = uniqueCourseDepts.map(dept => {
                    const isChecked = group.depts.includes(dept);
                    return `
                        <label class="flex items-center p-2 bg-white border border-slate-200 rounded-lg cursor-pointer hover:border-primary transition">
                            <input type="checkbox" data-dept="${dept}" ${isChecked ? 'checked' : ''} class="custom-checkbox mr-3 alliance-dept-check" data-group-index="${groupIndex}">
                            <span class="text-sm font-bold text-slate-700">${dept}</span>
                        </label>
                    `;
                }).join('');

                return `
                    <div class="logic-card p-4 relative bg-slate-50 space-y-3" data-group-index="${groupIndex}">
                        <div class="flex justify-between items-center border-b pb-2 mb-3">
                            <input type="text" value="${group.name}" data-group-index="${groupIndex}" oninput="updateAllianceGroupName(${groupIndex}, this.value)" class="text-base font-bold text-slate-800 bg-transparent border-b border-slate-300 focus:outline-none focus:border-primary w-2/3">
                            <button onclick="removeAllianceGroup(${groupIndex})" class="text-slate-400 hover:text-danger p-1"><i class="fas fa-trash-alt"></i> 刪除聯盟</button>
                        </div>
                        <p class="text-sm text-primary font-bold">聯盟學系清單：</p>
                        <div class="grid grid-cols-2 gap-3 alliance-checkboxes-group" data-group-index="${groupIndex}">
                            ${deptCheckboxes}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `
                <div class="mb-4 flex justify-end">
                    <button onclick="addAllianceGroup()" class="btn-create py-2.5 px-4 rounded-lg text-sm font-bold shadow-sm flex items-center gap-2"><i class="fas fa-users-cog"></i> 新增聯盟分組</button>
                </div>
                ${groupsHtml}
                ${allianceGroups.length === 0 ? '<div class="p-8 text-center text-slate-400 border border-dashed rounded-lg border-slate-300">點擊上方按鈕新增第一個聯盟分組</div>' : ''}
            `;
        }

        function addAllianceGroup() {
            if (!configData.allianceModeDepts) configData.allianceModeDepts = [];
            configData.allianceModeDepts.push({
                id: 'alliance_' + Date.now(),
                name: '新聯盟分組 ' + (configData.allianceModeDepts.length + 1),
                depts: []
            });
            renderAllianceRules();
            setUnsaved(true);
        }
        
        function removeAllianceGroup(index) {
            showMsg('confirm', '確認刪除聯盟？', '刪除後，該聯盟內的學系將恢復為依開課學系獨立分組。', null, () => {
                configData.allianceModeDepts.splice(index, 1);
                renderAllianceRules();
                setUnsaved(true);
            });
        }
        
        function updateAllianceGroupName(index, newName) {
            if (configData.allianceModeDepts[index]) {
                configData.allianceModeDepts[index].name = newName;
            }
        }
        
        function saveAllianceRules() {
            const newGroups = [];
            const deptToGroupMap = new Map();
            let overlapDetected = false;

            document.querySelectorAll('.logic-card[data-group-index]').forEach(groupEl => {
                const nameInput = groupEl.querySelector('input[type="text"]');
                const groupIndex = parseInt(groupEl.dataset.group-index);
                const group = configData.allianceModeDepts.find((_, i) => i === groupIndex) || { id: 'alliance_' + Date.now() }; 
                
                const checkedDepts = Array.from(groupEl.querySelectorAll('.alliance-dept-check:checked'))
                    .map(cb => cb.dataset.dept);
                
                
                checkedDepts.forEach(dept => {
                    if (deptToGroupMap.has(dept)) {
                        overlapDetected = true;
                    }
                    deptToGroupMap.set(dept, nameInput.value.trim());
                });
                
                group.name = nameInput.value.trim();
                group.depts = checkedDepts;
                newGroups.push(group);
            });
            
            if (overlapDetected) {
                 showMsg('error', '儲存失敗', '偵測到學系重複出現在不同的聯盟分組中，請修正後再儲存。');
                 return;
            }

            configData.allianceModeDepts = newGroups.filter(g => g.depts.length > 0); 
            
            setUnsaved(true);
            document.getElementById('alliance-modal').classList.add('hidden');
            showMsg('success', '儲存成功', `已設定 ${configData.allianceModeDepts.length} 個聯盟分組。`);
        }

        // --- Logic Summary & Conflict Detection ---
        function openLogicSummary(type) {
            activeLogicEdit = null; 
            renderLogicList(type);
            document.getElementById('logic-modal').classList.remove('hidden');
        }

        function renderLogicList(type) {
            const list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            const fieldMap = new Map(list.map(f => [f.id, f.label]));
            const fieldOptions = new Map(list.filter(f=>f.type==='single_select' && f.options).map(f => [f.id, f.options]));
            
            const conflicts = [];
            const checkDep = (fId, depId, ruleType, triggerVal) => {
                if(!depId) return false;
                let isValid = true;
                if(fId === depId) { conflicts.push(`🔴 <b>鬼打牆</b>：欄位 [${fieldMap.get(fId)}] 不能依賴自己，這會造成當機。`); isValid = false; }
                else if(!fieldMap.has(depId)) { conflicts.push(`🔴 <b>找不到源頭</b>：規則依賴 [${depId}]，但該欄位已消失。`); isValid = false; }
                else if(triggerVal && fieldOptions.has(depId)) {
                    if(!fieldOptions.get(depId).includes(triggerVal)) { conflicts.push(`🟠 <b>條件無效</b>：[${fieldMap.get(depId)}] 沒有選項 '${triggerVal}'，規則永遠不會觸發。`); isValid = false; }
                }
                return isValid;
            };

            const visited = new Set(); const recursionStack = new Set();
            const detectCycle = (currId, startId, path) => {
                if(recursionStack.has(currId)) { if(currId === startId) conflicts.push(`🔴 <b>邏輯死結</b>：${path.join(' -> ')} -> ${startId}，會導致系統崩潰。`); return; }
                if(visited.has(currId)) return; visited.add(currId); recursionStack.add(currId);
                const f = list.find(x => x.id === currId);
                if(f && f.visibilityRule && f.visibilityRule.dep) detectCycle(f.visibilityRule.dep, startId, [...path, f.visibilityRule.dep]);
                recursionStack.delete(currId);
            };

            let visHtml = '', optHtml = '', visCount = 0, optCount = 0;

            list.forEach((f, fIdx) => {
                if(f.visibilityRule && f.visibilityRule.dep) {
                    visCount++;
                    const isValid = checkDep(f.id, f.visibilityRule.dep, 'Vis', f.visibilityRule.val);
                    detectCycle(f.id, f.id, [f.id]);
                    visHtml += renderLogicRow(f, f.visibilityRule, 'vis', fIdx, type, fieldMap, fieldOptions, null, isValid);
                }
                const rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                if(rules.length > 0) {
                    rules.forEach((r, rIdx) => {
                        optCount++;
                        const isValid = checkDep(f.id, r.dep, 'Opt', r.val);
                        optHtml += renderLogicRow(f, r, 'opt', fIdx, type, fieldMap, fieldOptions, rIdx, isValid);
                    });
                }
            });

            document.getElementById('vis-list').innerHTML = visHtml || '<div class="text-center text-slate-400 py-4">無設定</div>';
            document.getElementById('opt-list').innerHTML = optHtml || '<div class="text-center text-slate-400 py-4">無設定</div>';
            document.getElementById('vis-count').innerText = visCount;
            document.getElementById('opt-count').innerText = optCount;

            const cEl = document.getElementById('logic-conflicts');
            if(conflicts.length > 0) { cEl.classList.remove('hidden'); document.getElementById('conflict-list').innerHTML = [...new Set(conflicts)].map(c => `<li>${c}</li>`).join(''); } else cEl.classList.add('hidden');
        }

        function renderLogicRow(field, rule, type, fIdx, listType, fieldMap, fieldOptions, ruleIdx = null, isValid = true) {
            const isEditing = activeLogicEdit && activeLogicEdit.id === field.id && activeLogicEdit.type === type && activeLogicEdit.ruleIdx === ruleIdx;
            
            let statusHtml = '<span class="text-green-600 font-bold text-xs"><i class="fas fa-check-circle"></i> 邏輯檢測通過</span>';
            const depName = fieldMap.get(rule.dep) || rule.dep;
            const depValid = fieldMap.has(rule.dep);
            const valValid = !depValid || !fieldOptions.has(rule.dep) || fieldOptions.get(rule.dep).includes(rule.val);
            
            if(!depValid) statusHtml = '<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-circle"></i> 錯誤：找不到依賴對象</span>';
            else if(!valValid) statusHtml = `<span class="text-red-600 font-bold text-xs"><i class="fas fa-exclamation-triangle"></i> 錯誤：[${depName}] 沒有選項 '${rule.val}'</span>`;

            if(isEditing) {
                let depOpts = '<option value="">請選擇...</option>';
                fieldMap.forEach((label, id) => { if(id !== field.id) depOpts += `<option value="${id}" ${id===rule.dep?'selected':''}>${label} (${id})</option>`; });
                let valInput = fieldOptions.has(rule.dep) ? `<select id="edit-val" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"><option value="">請選擇...</option>` + fieldOptions.get(rule.dep).map(o => `<option value="${o}" ${o===rule.val?'selected':''}>${o}</option>`).join('') + `</select>` : `<input id="edit-val" value="${rule.val}" class="w-full border border-slate-300 rounded p-1.5 text-sm focus:ring-2 focus:ring-primary outline-none" placeholder="輸入值">`;

                let actionSelect = '';
                if(type === 'vis') {
                    actionSelect = `<div><label class="text-[10px] text-slate-500 font-bold block mb-1">動作 (Action)</label><select id="edit-action" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"><option value="show" ${rule.action!=='hide'?'selected':''}>顯示 (Show)</option><option value="hide" ${rule.action==='hide'?'selected':''}>隱藏 (Hide)</option></select></div>`;
                }

                return `<div class="bg-white border border-slate-200 border-l-4 border-l-primary rounded-lg p-4 mb-3 shadow-sm">
                    <div class="flex justify-between items-center mb-4"><span class="font-bold text-slate-800">編輯規則 (${field.label})</span><div class="text-right">${statusHtml}</div></div>
                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-[10px] text-slate-500 font-bold block mb-1">依賴對象 (決定者)</label><select id="edit-dep" class="w-full border border-slate-300 rounded p-1.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none" onchange="updateLogicEditState('${field.id}','${type}',${fIdx},'${listType}',${ruleIdx}, this.value)">${depOpts}</select></div><div><label class="text-[10px] text-slate-500 font-bold block mb-1">當內容是 (條件值)</label>${valInput}</div>${actionSelect}</div>
                    <div class="flex justify-end gap-2"><button onclick="cancelLogicEdit('${listType}')" class="px-3 py-1.5 bg-white border border-slate-300 rounded text-xs hover:bg-slate-50 font-bold text-slate-600 transition">取消</button><button onclick="saveLogicEdit('${field.id}', '${type}', ${fIdx}, '${listType}', ${ruleIdx})" class="px-3 py-1.5 bg-primary text-white rounded text-xs hover:bg-[#001e3d] shadow-sm font-bold transition">確認變更</button></div></div>`;
            } else {
                const displayVal = `<span class="bg-slate-100 px-1.5 py-0.5 rounded text-slate-600 font-mono text-xs font-bold">${rule.val}</span>`;
                const actionText = (type === 'vis' && rule.action === 'hide') ? '<span class="text-red-600 font-bold">隱藏</span>' : '<span class="text-primary font-bold">顯示</span>';
                const content = type === 'vis' ? `<span class="font-bold text-primary">${field.label}</span>：當 <span class="font-bold text-slate-700">${depName}</span> 是 ${displayVal} 時 ${actionText}` : `<span class="font-bold text-emerald-600">${field.label}</span> 連動規則：當 <span class="font-bold text-slate-700">${depName}</span> 是 ${displayVal}，顯示 [${rule.limitTo?.join(', ')}]`;
                
                const actionBtn = isValid ? '' : `<button onclick="promptEditChoice('${field.id}', '${rule.dep}', '${listType}', '${type}', ${ruleIdx}, '${rule.val}')" class="text-slate-300 hover:text-primary transition p-1.5 rounded-full hover:bg-slate-100" title="修正設定"><i class="fas fa-pencil-alt"></i></button>`;
                
                const warnIcon = (!isValid) ? '<i class="fas fa-exclamation-triangle text-red-500 mr-2 animate-pulse"></i>' : '<i class="fas fa-check-circle text-green-500 mr-2 opacity-50"></i>';
                return `<div class="p-3 border-b border-slate-100 last:border-0 hover:bg-slate-50 flex justify-between items-center group transition"><div class="text-sm flex items-center">${warnIcon} ${content}</div>${actionBtn}</div>`;
            }
        }

        function startLogicEdit(id, type, ruleIdx, listType) { activeLogicEdit = { id, type, ruleIdx }; renderLogicList(listType); }
        function cancelLogicEdit(listType) { activeLogicEdit = null; renderLogicList(listType); }
        function updateLogicEditState(id, type, fIdx, listType, ruleIdx, newDep) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule); rule.dep = newDep; renderLogicList(listType);
        }
        function saveLogicEdit(id, type, fIdx, listType, ruleIdx) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields; const f = list[fIdx];
            const rule = type === 'vis' ? f.visibilityRule : (f.filterRules ? f.filterRules[ruleIdx] : f.filterRule);
            rule.dep = document.getElementById('edit-dep').value; rule.val = document.getElementById('edit-val').value;
            if(type === 'vis') rule.action = document.getElementById('edit-action').value;
            setUnsaved(true); activeLogicEdit = null; renderLogicList(listType);
        }

        function promptEditChoice(fId, depId, listType, type, ruleIdx, missingVal) {
            const list = listType === 'global' ? configData.globalFields : yearTemplateData.fields;
            const f = list.find(x => x.id === fId);
            const dep = list.find(x => x.id === depId);
            
            document.getElementById('btn-edit-self').onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); startLogicEdit(fId, type, ruleIdx, listType); };
            
            const btnFix = document.getElementById('btn-fix-source');
            if(dep && missingVal) { btnFix.classList.remove('hidden'); btnFix.onclick = () => { document.getElementById('choice-modal').classList.add('hidden'); showImpactModal(dep, missingVal, list); }; } else { btnFix.classList.add('hidden'); }
            document.getElementById('choice-modal').classList.remove('hidden');
        }

        function openAddrRules() {
            document.getElementById('addr-protected').value = configData.addressRules?.protected?.join(', ') || '';
            document.getElementById('addr-keywords').value = configData.addressRules?.keywords?.join(', ') || '';
            document.getElementById('addr-specials').value = configData.addressRules?.specials?.join(', ') || '';
            document.getElementById('addr-rules-modal').classList.remove('hidden');
        }
        function saveAddrRules() {
            configData.addressRules = {
                protected: document.getElementById('addr-protected').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x),
                keywords: document.getElementById('addr-keywords').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x),
                specials: document.getElementById('addr-specials').value.split(/[,，\n]+/).map(x=>x.trim()).filter(x=>x)
            };
            setUnsaved(true); document.getElementById('addr-rules-modal').classList.add('hidden'); showMsg('success', '成功', '地址規則已更新');
        }

        function showImpactModal(depField, newVal, contextList) {
            document.getElementById('imp-dep-name').innerText = depField.label; document.getElementById('imp-val').innerText = newVal;
            let count = 0;
            contextList.forEach(f => { if(f.visibilityRule?.dep === depField.id) count++; if(f.filterRules) f.filterRules.forEach(r => { if(r.dep === depField.id) count++; }); else if(f.filterRule?.dep === depField.id) count++; });
            document.getElementById('imp-count').innerText = count;
            document.getElementById('btn-confirm-fix').onclick = () => {
                if(!depField.options) depField.options = []; if(!depField.options.includes(newVal)) depField.options.push(newVal);
                document.getElementById('impact-modal').classList.add('hidden'); setUnsaved(true); renderLogicList(targetList); showMsg('success', '修復成功', `已將 '${newVal}' 加入 [${depField.label}] 的選項中。`);
            };
            document.getElementById('impact-modal').classList.remove('hidden');
        }

        function prepEditor(f = {}) {
            window.currentOptions = f.options || [];
            window.currentOptionDescs = f.optionDescriptions || {};
            window.currentRules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
            editingOptionIdx = -1;
            isOptionBatchMode = false;
            activeLogicEdit = null;

            document.getElementById('editor-title').innerText = isEditMode ? '編輯欄位' : '建立新欄位';
            document.getElementById('ed-orig-id').value = f.id || '';
            document.getElementById('ed-field-id').value = f.id || ''; document.getElementById('ed-field-id').readOnly = isEditMode && targetList !== 'global';
            document.getElementById('ed-label').value = f.label || '';
            document.getElementById('ed-desc').value = f.description || ''; 
            f.category = f.category || activeCatId === 'uncategorized' ? '' : activeCatId === 'all' ? '' : activeCatId;
            document.getElementById('ed-required').checked = f.required || false;
            document.getElementById('ed-system').checked = f.isSystem || false; toggleSystemHint(f.isSystem);

            const catSel = document.getElementById('ed-category'); catSel.innerHTML = '<option value="">未分類</option>';
            configData.templateCategories.forEach(c => catSel.innerHTML += `<option value="${c.id}" ${f.category===c.id?'selected':''}>${c.name}</option>`);
            
            if(f.category) catSel.value = f.category;

            const typeSel = document.getElementById('ed-type'); typeSel.innerHTML = '';
            configData.fieldTypes.forEach(t => typeSel.innerHTML += `<option value="${t.key}" ${f.type===t.key?'selected':''}>${t.label}</option>`);
            if(!f.type) typeSel.value = 'text';

            const visToggle = document.getElementById('vis-toggle');
            const visSettings = document.getElementById('vis-settings');
            const visLabel = document.getElementById('vis-label');
            
            if(f.visibilityRule && f.visibilityRule.dep) {
                visToggle.checked = true; visSettings.classList.remove('hidden'); visLabel.innerText = "已啟用顯示條件"; visLabel.className = "ml-3 text-xs font-bold text-primary"; 
            } else {
                visToggle.checked = false; visSettings.classList.add('hidden'); visLabel.innerText = "總是顯示 (預設)"; visLabel.className = "ml-3 text-xs font-medium text-slate-600";
            }

            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const visDepSel = document.getElementById('ed-vis-dep'); visDepSel.innerHTML = '<option value="">請選擇...</option>';
            allFields.filter(x => x.id !== f.id).forEach(x => visDepSel.innerHTML += `<option value="${x.id}" ${f.visibilityRule?.dep===x.id?'selected':''}>${x.label} (${x.id})</option>`);
            document.getElementById('ed-vis-val').value = f.visibilityRule?.val || '';
            document.getElementById('ed-vis-action').value = f.visibilityRule?.action || 'show';

            document.getElementById('editor-modal').dataset.curr = JSON.stringify(f);
            document.getElementById('editor-modal').classList.remove('hidden');
            renderOpts();
        }

        function toggleVisSettings(checked) {
            const el = document.getElementById('vis-settings'), lbl = document.getElementById('vis-label');
            if(checked) { el.classList.remove('hidden'); lbl.innerText="已啟用顯示條件"; lbl.className="ml-3 text-xs font-bold text-primary"; }
            else { el.classList.add('hidden'); lbl.innerText="總是顯示 (預設)"; lbl.className="ml-3 text-xs font-medium text-slate-600"; }
        }

        function toggleSystemHint(checked) { 
            const req = document.getElementById('ed-required');
            if(checked) { req.checked = true; req.disabled = true; } else { req.disabled = false; }
        }

        function toggleAdvanced(id, checked) {
            const el = document.getElementById(id);
            if(checked) { el.classList.remove('hidden'); }
            else {
                const toggleId = id.replace('panel', 'toggle');
                if(el.querySelectorAll('input').length > 0) {
                    document.getElementById(toggleId).checked = true; 
                    showMsg('confirm', '確認關閉？', '關閉後將清除此區塊的設定，確定嗎？', null, () => {
                        document.getElementById(toggleId).checked = false;
                        el.classList.add('hidden'); 
                    });
                } else {
                    el.classList.add('hidden');
                }
            }
        }

        function toggleOptionMode() {
            isOptionBatchMode = !isOptionBatchMode;
            renderOpts();
        }

        function toggleOptDesc(checked) {
            renderOptionList();
        }

        function renderOpts() {
            const type = document.getElementById('ed-type').value;
            const container = document.getElementById('ed-opts-container');
            const f = JSON.parse(document.getElementById('editor-modal').dataset.curr || '{}');
            const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields;
            const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join('');

            let html = '';
            
            if(type === 'single_select') {
                const hasRules = (f.filterRules && f.filterRules.length > 0) || !!f.filterRule;
                const hasDesc = f.optionDescriptions && Object.keys(f.optionDescriptions).length > 0;
                
                let optionEditorHtml = '';
                if(isOptionBatchMode) {
                    const textVal = (window.currentOptions || []).join('\n');
                    optionEditorHtml = `<div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm"><div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center"><h4 class="text-sm font-bold text-slate-700">選項管理 (文字模式)</h4><button onclick="toggleOptionMode()" class="text-primary text-xs font-bold hover:underline"><i class="fas fa-list"></i> 切換列表模式</button></div><textarea id="ed-opt-textarea" class="w-full h-48 p-4 text-sm outline-none resize-none" placeholder="請輸入選項，一行一個..." oninput="syncBatchOptions()">${textVal}</textarea><div class="p-2 bg-slate-50 text-[10px] text-slate-400 text-right">每行代表一個選項，切換回列表模式可設定說明</div></div>`;
                } else {
                    optionEditorHtml = `<div class="bg-white border border-slate-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-col gap-3">
                            <div class="flex justify-between items-center">
                                <div class="flex gap-4 items-center"><h4 class="text-sm font-bold text-slate-700">選項管理</h4><button onclick="toggleOptionMode()" class="text-primary text-xs font-bold hover:underline"><i class="fas fa-edit"></i> 切換文字模式</button></div>
                                <label class="flex items-center cursor-pointer hover:text-primary transition"><input type="checkbox" id="ed-opt-desc-toggle" class="custom-checkbox mr-2" ${hasDesc?'checked':''} onchange="toggleOptDesc(this.checked)"><span class="text-xs font-bold text-slate-600">啟用選項說明</span></label>
                            </div>
                            <div class="flex gap-2 mt-1"><div class="relative flex-grow"><i class="fas fa-plus absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i><input id="ed-new-opt" class="w-full pl-8 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none transition bg-white" placeholder="輸入新選項名稱..." onkeydown="if(event.key==='Enter') addOption()"></div><button onclick="addOption()" class="bg-primary hover:bg-[#001e3d] text-white px-4 py-2 rounded-lg text-sm font-bold transition shadow-sm flex-shrink-0">新增</button></div>
                        </div>
                        <table class="w-full opt-table"><thead><tr><th class="w-12 text-center">序</th><th>選項內容</th><th id="th-desc" class="hidden">說明文字</th><th class="w-32 text-right">操作</th></tr></thead><tbody id="ed-opt-list-body"></tbody></table>
                    </div>`;
                }

                html = `
                <div class="space-y-6">
                    <div>${optionEditorHtml}</div>
                    
                    <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg border">
                        <div class="flex justify-between items-start mb-3">
                            <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-random"></i> 進階屬性設定 (Advanced)</h4><p class="text-[11px] text-slate-400 mt-1">設定連動邏輯與其他進階選項。</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-logic-toggle" class="sr-only peer" ${hasRules?'checked':''} onchange="toggleAdvanced('adv-logic-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                        </div>
                        <div id="adv-logic-panel" class="${hasRules?'':'hidden'} bg-white border border-indigo-100 rounded-lg p-4 shadow-sm animate-fade-in">
                            <div class="flex justify-between items-center mb-4"><h4 class="text-sm font-bold text-slate-700 flex items-center gap-2">連動規則設定</h4><button onclick="addRule()" class="text-xs bg-white border border-indigo-200 text-indigo-600 px-3 py-1 rounded hover:bg-indigo-50 transition font-bold">+ 新增規則</button></div>
                            <div id="rule-list" class="space-y-3"></div>
                        </div>
                    </div>
                </div>`;
                
                let rules = f.filterRules || (f.filterRule ? [f.filterRule] : []);
                setTimeout(() => { 
                    if(!window.currentOptions || window.currentOptions.length === 0 && f.options) window.currentOptions = f.options || [];
                    if(Object.keys(window.currentOptionDescs).length === 0 && f.optionDescriptions) window.currentOptionDescs = f.optionDescriptions || {};
                    window.currentRules = rules; 
                    if(!isOptionBatchMode) renderOptionList(); 
                    renderRules(rules, depOpts); 
                }, 0);

            } else if (type === 'text') {
                const hasMaxLen = !!f.maxLen;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-sliders-h"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-text-toggle" class="sr-only peer" ${hasMaxLen?'checked':''} onchange="toggleAdvanced('adv-text-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-text-panel" class="${hasMaxLen?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200">
                        <label class="text-sm font-bold text-slate-700 mb-1 block">字元上限 (Max Length)</label>
                        <input type="number" id="ed-maxlen" class="w-full border border-slate-300 rounded p-2 text-sm" value="${f.maxLen||''}" placeholder="例如: 20">
                        <p class="text-[10px] text-slate-400 mt-1">(中英數符號皆算 1 字)</p>
                    </div>
                </div>`;

            } else if (type === 'address') { // v30.0: Address Type UI (Refined)
                const hasAddrSet = f.latinToEng || f.toHalf || f.forceTai || f.smartFormat;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-map-marker-alt"></i> 智慧地址處理 (Smart Address)</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-addr-toggle" class="sr-only peer" ${hasAddrSet?'checked':''} onchange="toggleAdvanced('adv-addr-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-addr-panel" class="${hasAddrSet?'':'hidden'} p-5 bg-white rounded-lg border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-latin-to-eng" ${f.latinToEng?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔠 拉丁文轉英文 (é->e)</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-to-half" ${f.toHalf?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔠 自動全形轉半形 (Ａ->A)</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-force-tai" ${f.forceTai?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🇹🇼 強制「台」轉「臺」</span></label>
                            <label class="flex items-center cursor-pointer p-2 border rounded hover:bg-slate-50"><input type="checkbox" id="ed-smart-fmt" ${f.smartFormat?'checked':''} class="custom-checkbox mr-3"><span class="text-sm font-bold text-slate-700">🔢 智慧路名數字轉換</span></label>
                        </div>
                    </div>
                </div>`;

            } else if (type === 'number') {
                const hasNumSet = f.calcMode === 'average' || f.decimal > 0 || f.keepZero;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-calculator"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-num-toggle" class="sr-only peer" ${hasNumSet?'checked':''} onchange="toggleAdvanced('adv-num-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-num-panel" class="${hasNumSet?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-sm font-bold text-slate-700 mb-1 block">數值模式</label><select id="ed-mode" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="copy">一般/複製</option><option value="average" ${f.calcMode==='average'?'selected':''}>自動平均</option></select></div>
                            <div><label class="text-sm font-bold text-slate-700 mb-1 block">小數位數</label><input type="number" id="ed-dec" class="w-full border border-slate-300 rounded p-2 text-sm" value="${f.decimal||0}"></div>
                        </div>
                        <div><label class="flex items-center text-sm font-bold text-slate-700 cursor-pointer"><input type="checkbox" id="ed-keepZero" ${f.keepZero?'checked':''} class="custom-checkbox mr-2"> 保留前導零 (00123)</label></div>
                    </div>
                </div>`;

            } else if (type === 'date') {
                const hasDateSet = f.inputFormat || f.outputFormat || f.precision;
                html = `
                <div class="p-6 border-b border-slate-100 bg-slate-50/30 rounded-lg mt-4 border">
                    <div class="flex justify-between items-start mb-3">
                        <div><h4 class="text-sm font-bold text-primary flex items-center gap-2"><i class="fas fa-calendar-alt"></i> 進階屬性設定</h4></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="adv-date-toggle" class="sr-only peer" ${hasDateSet?'checked':''} onchange="toggleAdvanced('adv-date-panel', this.checked)"><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#002E5D]"></div><span class="ml-3 text-xs font-medium text-slate-600">啟用設定</span></label>
                    </div>
                    <div id="adv-date-panel" class="${hasDateSet?'':'hidden'} p-4 bg-white rounded-lg border border-slate-200 grid grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">填報顯示</label><select id="ed-date-in" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="ROC" ${f.inputFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.inputFormat==='West'?'selected':''}>西元</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">檔案輸出</label><select id="ed-date-out" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="ROC" ${f.outputFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.outputFormat==='West'?'selected':''}>西元</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-500 block mb-1">日期精度</label><select id="ed-date-prec" class="w-full border border-slate-300 rounded p-2 text-sm"><option value="YMD" ${f.precision==='YMD'?'selected':''}>年/月/日 (完整)</option><option value="YM" ${f.precision==='YM'?'selected':''}>年/月</option><option value="Y" ${f.precision==='Y'?'selected':''}>僅年份</option><option value="M" ${f.precision==='M'?'selected':''}>僅月份</option><option value="D" ${f.precision==='D'?'selected':''}>僅日期</option></select></div>
                    </div>
                </div>`;
            } else {
                html = '<div class="text-center text-sm text-slate-400 py-10">此類型無需額外設定</div>';
            }
            container.innerHTML = html;
        }

        function renderOptionList() {
            const tbody = document.getElementById('ed-opt-list-body'); if(!tbody) return;
            const showDesc = document.getElementById('ed-opt-desc-toggle')?.checked;
            const thDesc = document.getElementById('th-desc');
            if(thDesc) thDesc.classList.toggle('hidden', !showDesc);

            tbody.innerHTML = window.currentOptions.map((opt, idx) => {
                const isEditing = editingOptionIdx === idx;
                const valHtml = isEditing ? `<input id="edit-opt-${idx}" value="${opt}" class="w-full border border-indigo-300 rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-200">` : `<span class="text-slate-700 font-medium">${opt}</span>`;
                
                let descHtml = '';
                if(showDesc) {
                    const descVal = window.currentOptionDescs[opt] || '';
                    descHtml = isEditing 
                        ? `<td><input id="edit-desc-${idx}" value="${descVal}" class="w-full border border-indigo-300 rounded px-2 py-1 text-sm outline-none focus:ring-2 focus:ring-indigo-200" placeholder="說明..."></td>`
                        : `<td class="text-xs text-slate-500">${descVal}</td>`;
                }

                const actions = isEditing 
                    ? `<button onclick="saveOption(${idx})" class="text-success hover:text-emerald-600 mr-2"><i class="fas fa-check"></i></button><button onclick="cancelEditOption()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>`
                    : `<button onclick="moveOption(${idx},-1)" class="text-slate-300 hover:text-primary mr-1" title="上移"><i class="fas fa-arrow-up"></i></button><button onclick="moveOption(${idx},1)" class="text-slate-300 hover:text-primary mr-2" title="下移"><i class="fas fa-arrow-down"></i></button><button onclick="editOption(${idx})" class="text-slate-300 hover:text-primary mr-2"><i class="fas fa-pencil-alt"></i></button><button onclick="removeOption(${idx})" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button>`;
                return `<tr><td class="text-center text-slate-400 font-mono text-xs">${idx+1}</td><td>${valHtml}</td>${descHtml}<td class="text-right">${actions}</td></tr>`;
            }).join('');
            updateRuleCheckboxes(); 
        }
        function addOption() { const inp = document.getElementById('ed-new-opt'); const val = inp.value.trim(); if(val) { window.currentOptions.push(val); renderOptionList(); inp.value = ''; inp.focus(); showMsg('success', '成功', '選項已新增'); } }
        function removeOption(idx) { showMsg('confirm', '刪除選項？', '確定刪除此選項嗎？', null, () => { window.currentOptions.splice(idx, 1); renderOptionList(); showMsg('success', '成功', '選項已刪除'); }); }
        function moveOption(idx, dir) { if(idx+dir < 0 || idx+dir >= window.currentOptions.length) return; [window.currentOptions[idx], window.currentOptions[idx+dir]] = [window.currentOptions[idx+dir], window.currentOptions[idx]]; renderOptionList(); }
        function editOption(idx) { editingOptionIdx = idx; renderOptionList(); setTimeout(() => document.getElementById(`edit-opt-${idx}`).focus(), 50); }
        function saveOption(idx) { 
            const oldVal = window.currentOptions[idx];
            const newVal = document.getElementById(`edit-opt-${idx}`).value.trim(); 
            const descInput = document.getElementById(`edit-desc-${idx}`);
            if(descInput) { window.currentOptionDescs[newVal] = descInput.value.trim(); if(oldVal !== newVal) delete window.currentOptionDescs[oldVal]; } 
            else if (oldVal !== newVal && window.currentOptionDescs[oldVal]) { window.currentOptionDescs[newVal] = window.currentOptionDescs[oldVal]; delete window.currentOptionDescs[oldVal]; }
            if(newVal) window.currentOptions[idx] = newVal; 
            editingOptionIdx = -1; renderOptionList(); 
        }
        function cancelEditOption() { editingOptionIdx = -1; renderOptionList(); }
        function syncBatchOptions() {
            const text = document.getElementById('ed-opt-textarea').value;
            window.currentOptions = text.split('\n').map(x => x.trim()).filter(x => x);
            updateRuleCheckboxes();
        }
        function initSortable() { /* Not needed */ }

        function renderRules(rules, depOpts) {
            const list = document.getElementById('rule-list'); list.innerHTML = '';
            if(rules.length === 0) { list.innerHTML = '<div class="text-center text-xs text-slate-400 py-2 border border-dashed border-slate-300 rounded">尚無規則，請點擊新增。</div>'; return; }
            rules.forEach((r, idx) => {
                const row = document.createElement('div'); row.className = 'logic-card p-4 relative bg-white';
                row.innerHTML = `<button onclick="removeRule(${idx})" class="absolute top-2 right-2 text-slate-300 hover:text-red-500 transition"><i class="fas fa-times"></i></button><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="text-[10px] font-bold text-slate-500 uppercase">依賴對象 (決定者)</label><select onchange="updateRule(${idx}, 'dep', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs bg-slate-50"><option value="">請選擇...</option>${depOpts}</select></div><div><label class="text-[10px] font-bold text-slate-500 uppercase">當內容是 (條件值)</label><input oninput="updateRule(${idx}, 'val', this.value)" class="w-full border border-slate-300 rounded p-1.5 text-xs" placeholder="輸入觸發值" value="${r.val||''}"></div></div><div><label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">僅顯示下列選項 (Check to Show)</label><div class="flex flex-wrap gap-2" id="chk-container-${idx}"></div></div>`;
                list.appendChild(row); row.querySelector('select').value = r.dep || ''; updateRuleCheckboxes(idx, r.limitTo);
            });
        }

        function updateRuleCheckboxes(ruleIdx = null, selected = []) {
            const opts = window.currentOptions || [];
            const renderSet = (containerId, currentSel) => {
                const c = document.getElementById(containerId); if(!c) return;
                c.innerHTML = opts.map(o => `<label class="inline-flex items-center bg-slate-50 px-2 py-1 rounded border border-slate-200 text-xs cursor-pointer select-none hover:border-primary"><input type="checkbox" class="mr-1 accent-primary" ${currentSel.includes(o)?'checked':''} onchange="updateRuleLimit(${ruleIdx}, '${o}', this.checked)"> ${o}</label>`).join('');
            };
            if(ruleIdx !== null) renderSet(`chk-container-${ruleIdx}`, selected);
            else { const list = document.getElementById('rule-list'); if(list && window.currentRules) window.currentRules.forEach((r, i) => renderSet(`chk-container-${i}`, r.limitTo || [])); }
        }

        window.addRule = function() { window.currentRules.push({ dep: "", val: "", limitTo: [] }); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.removeRule = function(idx) { window.currentRules.splice(idx, 1); const allFields = targetList==='global' ? configData.globalFields : yearTemplateData.fields; const depOpts = allFields.filter(x => x.id !== document.getElementById('ed-field-id').value).map(x => `<option value="${x.id}">${x.label} (${x.id})</option>`).join(''); renderRules(window.currentRules, depOpts); };
        window.updateRule = function(idx, key, val) { window.currentRules[idx][key] = val; };
        window.updateRuleLimit = function(idx, opt, checked) { let arr = window.currentRules[idx].limitTo || []; if(checked) { if(!arr.includes(opt)) arr.push(opt); } else { arr = arr.filter(x => x !== opt); } window.currentRules[idx].limitTo = arr; };

        function saveField() {
            const id = document.getElementById('ed-field-id').value.trim(); const label = document.getElementById('ed-label').value.trim();
            if(!id || !label) return showMsg('error','錯誤','ID 與名稱為必填');
            
            let f = {};
            if(isEditMode) f = (targetList==='global'?configData.globalFields:yearTemplateData.fields).find(x=>x.id===document.getElementById('ed-orig-id').value);
            
            f.id = id; f.label = label; f.type = document.getElementById('ed-type').value; f.category = document.getElementById('ed-category').value || undefined;
            f.description = document.getElementById('ed-desc').value.trim(); 
            f.required = document.getElementById('ed-required').checked; f.isSystem = document.getElementById('ed-system').checked;

            if(document.getElementById('vis-toggle').checked) { f.visibilityRule = { dep: document.getElementById('ed-vis-dep').value, val: document.getElementById('ed-vis-val').value, action: document.getElementById('ed-vis-action').value }; } else { delete f.visibilityRule; }

            if(f.type === 'single_select') {
                f.options = window.currentOptions;
                if(Object.keys(window.currentOptionDescs).length > 0) f.optionDescriptions = window.currentOptionDescs; else delete f.optionDescriptions;

                if(document.getElementById('adv-logic-toggle').checked && window.currentRules.length > 0) {
                    const validRules = window.currentRules.filter(r => r.dep && r.val);
                    if(validRules.length === 1) { f.filterRule = validRules[0]; delete f.filterRules; } 
                    else if(validRules.length > 1) { f.filterRules = validRules; delete f.filterRule; } 
                    else { delete f.filterRule; delete f.filterRules; }
                } else { delete f.filterRule; delete f.filterRules; }
            }
            
            if(f.type === 'number') { if(document.getElementById('adv-num-toggle').checked) { f.calcMode=document.getElementById('ed-mode').value; f.decimal=parseInt(document.getElementById('ed-dec').value)||0; f.keepZero=document.getElementById('ed-keepZero').checked; } else { delete f.calcMode; delete f.decimal; delete f.keepZero; } }
            if(f.type === 'date') { if(document.getElementById('adv-date-toggle').checked) { f.inputFormat = document.getElementById('ed-date-in').value; f.outputFormat = document.getElementById('ed-date-out').value; f.precision = document.getElementById('ed-date-prec').value; } else { delete f.inputFormat; delete f.outputFormat; delete f.precision; } delete f.dateFormat; }
            if(f.type === 'text') { 
                if(document.getElementById('adv-text-toggle').checked) { 
                    f.maxLen = parseInt(document.getElementById('ed-maxlen').value) || 0; 
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                } else { delete f.maxLen; delete f.forceTai; } 
            }
            if(f.type === 'address') { 
                if(document.getElementById('adv-addr-toggle').checked) {
                    f.latinToEng = document.getElementById('ed-latin-to-eng').checked; 
                    delete f.blockJa; 
                    f.toHalf = document.getElementById('ed-to-half').checked;
                    f.forceTai = document.getElementById('ed-force-tai').checked;
                    f.smartFormat = document.getElementById('ed-smart-fmt').checked;
                } else { delete f.latinToEng; delete f.blockJa; delete f.toHalf; delete f.forceTai; delete f.smartFormat; }
            }

            if(!isEditMode && targetList==='global') { f.order = configData.globalFields.length; configData.globalFields.push(f); }

            document.getElementById('editor-modal').classList.add('hidden');
            targetList==='global'?renderGlobalList():renderYearFields(); setUnsaved(true);
            showMsg('info', '暫存成功', '設定已暫存，請記得按「儲存設定」發布。');
        }

        // --- Picker, Types, Save Config ---
        function openFieldPicker() {
            const list = document.getElementById('picker-list'); list.innerHTML = ''; document.getElementById('picker-select-all').checked=false;
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));
            if(available.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400">已加入所有模板欄位</div>';
            else available.forEach(f => list.innerHTML += `<label class="flex items-center p-3 border rounded-lg hover:border-primary cursor-pointer hover:bg-indigo-50 mb-2"><input type="checkbox" value="${f.id}" class="picker-checkbox custom-checkbox mr-3"><div class="flex-grow flex justify-between"><span class="font-bold text-sm text-slate-700">${f.label}</span><span class="text-xs text-slate-400 font-mono">${f.id}</span></div></label>`);
            document.getElementById('picker-modal').classList.remove('hidden');
        }
        function togglePickerAll(cb) { document.querySelectorAll('.picker-checkbox').forEach(c => c.checked = cb.checked); }
        function addSelectedFields() {
            const ids = Array.from(document.querySelectorAll('.picker-checkbox:checked')).map(c=>c.value);
            const map = {}; configData.globalFields.forEach(f=>map[f.id]=f.order); ids.sort((a,b)=>map[a]-map[b]);
            ids.forEach(id=>{ const t=configData.globalFields.find(x=>x.id===id); if(t) yearTemplateData.fields.push(JSON.parse(JSON.stringify(t))); });
            renderYearFields(); setUnsaved(true); document.getElementById('picker-modal').classList.add('hidden');
            showMsg('success', '成功', '欄位已加入');
        }
        
        function openTypeManager(){switchView('types');renderTypeManagerPage();}
        function renderTypeManagerPage(){const el=document.getElementById('type-list-page');el.innerHTML='';configData.fieldTypes.forEach(t=>el.innerHTML+=`<tr class="hover:bg-slate-50"><td class="px-6 py-3 font-mono text-xs text-primary font-bold">${t.key}</td><td class="px-6 py-3 text-xs font-bold">${t.label}</td><td class="px-6 py-3 text-right"><button onclick="editCustomTypePage('${t.key}')" class="text-slate-300 hover:text-primary mr-2"><i class="fas fa-pen"></i></button><button onclick="delCustomTypePage('${t.key}')" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`);}
        
        function editCustomTypePage(key) {
            const t = configData.fieldTypes.find(x => x.key === key); if(!t) return;
            showMsg('prompt', '編輯類型', '請輸入新的顯示名稱', {label: '顯示名稱', value: t.label}, (newLabel) => {
                if(newLabel && newLabel !== t.label) { t.label = newLabel; setUnsaved(true); renderTypeManagerPage(); showMsg('success', '成功', '類型名稱已更新'); }
            });
        }

        function addCustomTypePage(){const k=document.getElementById('new-type-key-page').value.trim(),l=document.getElementById('new-type-label-page').value.trim();if(!k||!l)return;if(configData.fieldTypes.some(t=>t.key===k))return showMsg('error','錯誤','Key 已存在');configData.fieldTypes.push({key:k,label:l});setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已新增'); }
        function delCustomTypePage(k){showMsg('confirm', '刪除類型？', '已使用此類型的欄位可能會顯示異常。', null,()=>{configData.fieldTypes=configData.fieldTypes.filter(t=>t.key!==k);setUnsaved(true);renderTypeManagerPage(); showMsg('success', '成功', '類型已刪除'); });}

        async function saveConfig() { configSha = await uploadFile(ghConfig.path, configData, configSha); }
        async function saveAll() {
            const btn=document.getElementById('btn-save');btn.disabled=true;btn.innerHTML='<div class="spinner"></div>';
            try { await saveConfig(); if(activeYearId){const p=`hedb/year_templates/year_${activeYearId}_templates.json`;const c=await apiFetch(p);await uploadFile(p,yearTemplateData,c.status===200?c.sha:null);} setUnsaved(false); showMsg('success', '儲存成功', '所有設定已更新至 GitHub'); }
            catch(e){showMsg('error', '儲存失敗', e.message);} finally{btn.disabled=false;btn.innerHTML='<i class="fas fa-cloud-upload-alt"></i> 儲存設定';}
        }

        async function apiFetch(path){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}?t=${Date.now()}`,{headers:{'Authorization':`token ${ghConfig.token}`,'Accept':'application/vnd.github.v3+json'}});if(r.status===404)return{status:404};const d=await r.json();if(Array.isArray(d))return{status:200,data:d};const c=decodeURIComponent(escape(window.atob(d.content.replace(/\n/g,""))));return{status:200,data:JSON.parse(c),sha:d.sha};}
        async function uploadFile(path,data,sha){const r=await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'PUT',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Update',content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),sha:sha})});if(!r.ok)throw new Error(r.status);const d=await r.json();return d.content.sha;}
        async function deleteFile(path,sha){await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`,{method:'DELETE',headers:{'Authorization':`token ${ghConfig.token}`,'Content-Type':'application/json'},body:JSON.stringify({message:'Del',sha:sha})});}

        function switchView(v) {
            ['years','fields','types','internship'].forEach(x => { document.getElementById(`view-${x}`).classList.toggle('hidden', v!==x); document.getElementById(`view-${x}`).classList.toggle(v!=='years'?'flex':'flex', v===x); document.getElementById(`nav-${x}`).classList.toggle('active', v===x); });
            if(v==='fields')renderGlobalList(); if(v==='types')renderTypeManagerPage();
        }
        window.onload = init;
    </script>
</body>
</html>
