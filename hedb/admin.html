<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理後台 (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', // 東海藍
                        secondary: '#C6A87C', // 榮耀金
                        success: '#219653',
                        danger: '#DC2626',
                        surface: '#ffffff',
                        background: '#F8FAFC'
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #002E5D 0%, #0f172a 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .input-stylish { width: 100%; background: #f8fafc; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); background: #fff; }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .nav-btn.active { border-bottom: 3px solid #002E5D; color: #002E5D; font-weight: bold; background: #f1f5f9; }
        .nav-btn { border-bottom: 3px solid transparent; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover:not(.active) { color: #002E5D; background: #f8fafc; }

        .year-add-btn {
            border: 2px dashed #bbf7d0;
            color: #219653;
            background-color: #f0fdf4;
            transition: all 0.2s;
            border-radius: 0.75rem;
            text-align: center;
            padding: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        .year-add-btn:hover {
            border-color: #219653;
            background-color: #dcfce7;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .list-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background-color: #ffffff;
            color: #64748b;
            border: 1px solid transparent;
        }
        .list-item:hover {
            background-color: #f1f5f9;
        }
        .list-item.active {
            background-color: #EEF2FF;
            color: #002E5D;
            font-weight: bold;
            border: 1px solid #e0e7ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .list-item.active::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0; width: 6px;
            background-color: #002E5D;
            border-top-left-radius: 0.5rem;
            border-bottom-left-radius: 0.5rem;
        }

        .btn-manage { background-color: #002E5D; color: white; }
        .btn-manage:hover { background-color: #001e3d; }
        .btn-create { background-color: #219653; color: white; }
        .btn-create:hover { background-color: #1e874b; }
        .btn-danger { background-color: #DC2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }

        .data-table th { background-color: #f8fafc; color: #64748b; font-weight: bold; padding: 0.75rem 1rem; text-align: left; font-size: 0.75rem; text-transform: uppercase; border-bottom: 1px solid #e2e8f0; }
        .data-table td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; vertical-align: middle; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background-color: #f8fafc; }

        .custom-checkbox {
            height: 1.25rem; width: 1.25rem; 
            border-radius: 0.25rem; 
            border: 2px solid #cbd5e1; 
            color: #002E5D;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:focus { ring: 2px solid #002E5D; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-background">

    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-primary text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg"><i class="fas fa-university"></i></div>
                <h1 class="text-2xl font-bold text-primary tracking-wide">東海大學實習平台</h1>
                <p class="text-slate-500 text-sm mt-2 font-medium">系統管理後台 (System Admin)</p>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                <div class="relative">
                    <i class="fas fa-key input-icon"></i><input type="password" id="gh-token" class="input-stylish" placeholder="Access Token">
                    <button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-primary p-1"><i class="fas fa-eye" id="token-eye"></i></button>
                </div>
                <div class="pt-4">
                    <button onclick="connectGitHub()" id="btn-connect" class="w-full btn-manage font-bold py-3 rounded-lg shadow-md transition flex justify-center items-center gap-2"><span>登入系統</span><i class="fas fa-arrow-right"></i></button>
                    <div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 bg-white border-b border-slate-200 flex items-center justify-between px-6 shadow-sm z-30">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-primary text-white rounded flex items-center justify-center text-sm shadow"><i class="fas fa-tools"></i></div>
                <h1 class="font-bold text-lg tracking-wide text-primary">系統配置中心</h1>
            </div>
            <div class="flex items-center gap-3">
                <div id="unsaved-badge" class="hidden px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-xs font-bold border border-amber-200 flex items-center gap-1 animate-pulse"><i class="fas fa-pen"></i> 未儲存</div>
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100"><i class="fas fa-check-circle mr-1"></i> 儲存成功</span>
                <button onclick="saveAll()" id="btn-save" class="btn-manage font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm transform active:scale-95 transition-all"><i class="fas fa-cloud-upload-alt"></i> 儲存設定</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> 登出</button>
            </div>
        </header>

        <nav class="bg-white border-b border-slate-200 px-6 flex-shrink-0 z-20">
            <div class="flex gap-6">
                <button onclick="switchView('years')" id="nav-years" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 active"><i class="fas fa-calendar-alt"></i> 學年度模組配置</button>
                <button onclick="switchView('fields')" id="nav-fields" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-layer-group"></i> 欄位模板庫</button>
                <button onclick="switchView('types')" id="nav-types" class="nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2"><i class="fas fa-tags"></i> 欄位類型管理</button>
            </div>
        </nav>

        <main class="flex-grow relative overflow-hidden bg-slate-50">
            
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <div onclick="openYearModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-plus text-lg"></i> 新增學年度
                        </div>
                    </div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">學年度列表</div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-3 space-y-2 custom-scroll"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-year-title">...</span><span id="default-badge" class="hidden text-xs bg-secondary text-white px-2 py-0.5 rounded shadow-sm">預設年度</span></h2>
                                <p class="text-xs text-slate-400 mt-1">此學年度的欄位配置 (獨立模組)</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200 hover:bg-white transition select-none mr-2">
                                    <input type="checkbox" id="is-default-year" class="custom-checkbox" onchange="toggleDefaultYear()"> 設為預設
                                </label>
                                <button onclick="renameCurrentYear()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2.5 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentYear()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2.5 rounded-lg transition" title="刪除學年度"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        
                        <div class="flex-grow p-8 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-4">
                                    <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-list-ul text-primary"></i> 欄位列表</h3>
                                    <div class="flex items-center gap-2 ml-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm">
                                        <i class="fas fa-filter text-slate-400 text-xs"></i>
                                        <select id="year-filter-cat" onchange="renderYearFields()" class="text-sm text-slate-600 outline-none bg-transparent cursor-pointer hover:text-primary">
                                            <option value="all">顯示所有分類</option>
                                        </select>
                                    </div>
                                    <button onclick="deleteSelectedYearFields()" class="bg-danger hover:bg-red-700 text-white text-xs px-3 py-1.5 rounded-full shadow-sm transition flex items-center gap-1 font-bold ml-2"><i class="fas fa-trash-alt"></i> 刪除選取項目</button>
                                </div>
                                <button onclick="openFieldPicker()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> 從模板複製加入</button>
                            </div>
                            
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                                <div class="overflow-y-auto custom-scroll flex-grow">
                                    <table class="w-full data-table">
                                        <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                                            <tr>
                                                <th class="w-12 text-center"><input type="checkbox" onchange="toggleYearAll(this)" class="custom-checkbox"></th>
                                                <th class="w-16 text-center">排序</th>
                                                <th>欄位名稱</th>
                                                <th class="w-24">分類</th>
                                                <th class="w-24">類型</th>
                                                <th class="w-40 text-right">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="year-field-list"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <div class="w-20 h-20 bg-slate-200 rounded-full flex items-center justify-center mb-4 text-3xl text-slate-400"><i class="fas fa-calendar-alt"></i></div>
                        <p>請從左側選擇或新增一個學年度模組</p>
                    </div>
                </section>
            </div>

            <div id="view-fields" class="w-full h-full hidden flex">
                <aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-10 flex-shrink-0">
                    <div class="p-5 border-b border-slate-100 bg-white">
                        <div onclick="openCategoryModal()" class="year-add-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                            <i class="fas fa-folder-plus text-lg"></i> 新增模板分類
                        </div>
                    </div>
                    <div class="p-2 bg-slate-50 text-xs font-bold text-slate-400 uppercase tracking-wider pl-5 py-2">分類列表</div>
                    <div id="template-cat-list" class="flex-grow overflow-y-auto p-3 space-y-1 custom-scroll bg-slate-50"></div>
                </aside>
                <section class="flex-grow flex flex-col">
                    <div class="bg-white px-8 py-5 border-b border-slate-200 shadow-sm flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><span id="current-cat-title">全部欄位</span></h2>
                            <p class="text-xs text-slate-400 mt-1">管理可供學年度引用的欄位原型。</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="cat-actions" class="hidden border-r border-slate-200 pr-3 mr-1 flex gap-1">
                                <button onclick="renameCurrentCat()" class="text-slate-400 hover:text-primary hover:bg-blue-50 p-2 rounded-lg transition" title="重新命名"><i class="fas fa-pen"></i></button>
                                <button onclick="deleteCurrentCat()" class="text-slate-400 hover:text-danger hover:bg-red-50 p-2 rounded-lg transition" title="刪除分類"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <button onclick="addNewGlobalField()" class="btn-create px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-plus"></i> 建立新模板</button>
                        </div>
                    </div>
                    <div class="flex-grow p-8 overflow-hidden flex flex-col">
                        <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                            <div class="overflow-y-auto custom-scroll flex-grow">
                                <table class="w-full data-table">
                                    <thead class="sticky top-0 bg-slate-50 z-10 shadow-sm">
                                        <tr>
                                            <th class="w-16 text-center">序號</th>
                                            <th>欄位名稱 (ID)</th>
                                            <th class="w-24">類型</th>
                                            <th class="w-48">屬性</th>
                                            <th class="w-40 text-right">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="global-field-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <div id="view-types" class="w-full h-full hidden flex-col p-8 bg-slate-50 overflow-y-auto custom-scroll">
                <div class="max-w-4xl mx-auto w-full">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-8">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b border-slate-100">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">欄位類型管理</h2>
                                <p class="text-sm text-slate-500 mt-1">定義系統支援的輸入類型 (如 Text, Number...)</p>
                            </div>
                        </div>
                        <div class="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden mb-6">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-slate-100 text-slate-500 font-bold text-xs uppercase"><tr><th class="px-6 py-3">代碼 (Key)</th><th class="px-6 py-3">顯示名稱 (Label)</th><th class="px-6 py-3 text-right">操作</th></tr></thead>
                                <tbody id="type-list-page" class="divide-y divide-slate-200 bg-white"></tbody>
                            </table>
                        </div>
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100 shadow-sm">
                            <h4 class="text-sm font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-plus-circle"></i> 新增自訂類型</h4>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">代碼 (HTML Type)</label><input id="new-type-key-page" placeholder="e.g. email" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm font-mono focus:ring-2 focus:ring-primary outline-none"></div>
                                <div class="md:col-span-2"><label class="block text-xs font-bold text-indigo-600 mb-1">顯示名稱</label><input id="new-type-label-page" placeholder="e.g. Email Address" class="w-full border border-indigo-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none"></div>
                                <div class="md:col-span-1"><button onclick="addCustomTypePage()" class="w-full btn-create py-2.5 rounded-lg font-bold text-sm shadow-sm">新增</button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="msg-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform scale-95 transition-transform duration-300" id="msg-panel">
            <div class="w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm" id="msg-icon"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2" id="msg-title"></h3>
            <p class="text-sm text-slate-500 mb-6 leading-relaxed" id="msg-desc"></p>
            <div id="msg-input-area" class="hidden mb-6 text-left">
                <label class="block text-xs font-bold text-slate-400 uppercase mb-1" id="msg-input-label"></label>
                <input type="text" id="msg-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-primary outline-none text-slate-700">
                <div id="msg-select-area" class="hidden mt-3">
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">複製來源</label>
                    <select id="msg-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none"></select>
                </div>
            </div>
            <div class="flex gap-3 justify-center" id="msg-btns"></div>
        </div>
    </div>

    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-800 mb-4" id="editor-title">編輯欄位屬性</h3>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="space-y-4 max-h-[70vh] overflow-y-auto custom-scroll pr-2">
                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">ID (Unique)</label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded p-2 text-sm font-mono text-blue-600 focus:ring-primary"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">名稱</label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded p-2 text-sm focus:ring-primary"></div>
                <div id="ed-category-container"><label class="text-xs font-bold text-slate-500 uppercase block mb-1">分類</label><select id="ed-category" class="w-full border border-slate-300 rounded p-2 text-sm bg-white focus:ring-primary"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">類型</label><select id="ed-type" class="w-full border border-slate-300 rounded p-2 text-sm bg-white focus:ring-primary" onchange="renderOpts()"></select></div>
                    <div class="pt-6 space-y-2"><label class="flex items-center text-sm"><input type="checkbox" id="ed-required" class="custom-checkbox mr-2"> 必填</label><label class="flex items-center text-sm"><input type="checkbox" id="ed-system" class="custom-checkbox mr-2"> 系統預設</label></div>
                </div>
                <div id="ed-opts" class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm space-y-3"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button>
                <button onclick="saveField()" class="px-4 py-2 btn-manage rounded-lg font-bold text-sm shadow">暫存設定</button>
            </div>
        </div>
    </div>

    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="text-lg font-bold text-slate-800">從模板複製欄位</h3><button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button></div>
            <div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200"><label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer"><input type="checkbox" id="picker-select-all" class="custom-checkbox mr-2" onchange="togglePickerAll(this)"> 全選 / 取消全選</label></div>
            <div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div>
            <div class="mt-4 pt-2 border-t border-slate-100 flex justify-end"><button onclick="addSelectedFields()" class="w-full btn-create font-bold py-2.5 rounded-lg shadow transition">確認複製選取欄位</button></div>
        </div>
    </div>

    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300"><div class="mb-4"><h3 class="text-lg font-bold text-slate-800"><i class="fas fa-exchange-alt text-primary mr-2"></i>移動順序</h3><p class="text-sm text-slate-500 mt-1">將 <span id="move-target-name" class="font-bold text-primary"></span> 移動至：</p></div><div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-primary outline-none max-h-60 overflow-y-auto custom-scroll"></select></div><div class="flex justify-end gap-3"><button onclick="document.getElementById('move-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition text-sm">取消</button><button onclick="saveMove()" class="px-4 py-2 btn-manage rounded-lg font-bold shadow-md transition text-sm">確認移動</button></div></div>
    </div>

    <script>
        let ghConfig = { user: '', repo: '', path: 'hedb/config.json', token: '' };
        let configData = { globalFields: [], academicYears: [], templateCategories: [], fieldTypes: [] }; 
        let yearTemplateData = { fields: [] }; 
        let activeYearId = null;
        let activeCatId = 'all';
        let isEditMode = false;
        let moveSrcIndex = -1; let moveType = '';
        let targetList = 'global'; 
        let unsavedChanges = false;
        let configSha = null;

        const SYSTEM_DEFAULT_TYPES = [
            {key:'text', label:'文字'}, {key:'number', label:'數字'}, 
            {key:'date', label:'日期'}, {key:'single_select', label:'單選'}, 
            {key:'list', label:'條列式'}
        ];

        function init() {
            const saved = localStorage.getItem('gh_creds_v10');
            if(saved) {
                const c = JSON.parse(saved);
                document.getElementById('gh-user').value = c.user;
                document.getElementById('gh-repo').value = c.repo;
                document.getElementById('gh-token').value = c.token;
            }
            window.addEventListener('beforeunload', (e) => {
                if (unsavedChanges) { e.preventDefault(); e.returnValue = ''; }
            });
        }

        function setUnsaved(val) {
            unsavedChanges = val;
            const badge = document.getElementById('unsaved-badge');
            if(val) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        }

        async function connectGitHub() {
            const btn = document.getElementById('btn-connect');
            const msg = document.getElementById('login-msg');
            const user = document.getElementById('gh-user').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();

            if(!user || !repo || !token) { msg.style.opacity='1'; msg.innerText='請填寫完整資訊'; return; }

            btn.innerHTML = '<div class="spinner"></div> 連線中...'; btn.disabled = true;
            ghConfig = { user, repo, path: 'hedb/config.json', token };

            try {
                const res = await apiFetch(ghConfig.path);
                if(res.status === 404) {
                    configData = { globalFields: [], academicYears: [], templateCategories: [], fieldTypes: [] };
                    configSha = null;
                } else {
                    configData = res.data;
                    configSha = res.sha; 
                    if(!configData.templateCategories) configData.templateCategories = [];
                    if(!configData.fieldTypes || configData.fieldTypes.length === 0) configData.fieldTypes = JSON.parse(JSON.stringify(SYSTEM_DEFAULT_TYPES));
                    
                    const uniqueTypes = new Map();
                    [...SYSTEM_DEFAULT_TYPES, ...configData.fieldTypes].forEach(t => uniqueTypes.set(t.key, t));
                    configData.fieldTypes = Array.from(uniqueTypes.values());
                }

                localStorage.setItem('gh_creds_v10', JSON.stringify(ghConfig));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-interface').classList.remove('hidden');
                document.getElementById('admin-interface').style.opacity = '1';
                
                await syncYearsFromFiles();
                renderYearList();
                if(configData.academicYears.length > 0) selectYear(configData.academicYears[0].year);
                renderTemplateCats();
                renderTypeManagerPage(); 

            } catch (err) {
                console.error(err);
                msg.style.opacity='1'; msg.innerText='連線失敗: ' + err.message;
            } finally {
                btn.innerHTML = '登入系統'; btn.disabled = false;
            }
        }

        async function syncYearsFromFiles() {
            try {
                const dirRes = await apiFetch('hedb/year_templates');
                if(dirRes.status !== 200 || !Array.isArray(dirRes.data)) return;
                
                const fileYears = dirRes.data
                    .filter(f => f.name.match(/^year_(.+)_templates\.json$/))
                    .map(f => f.name.match(/^year_(.+)_templates\.json$/)[1]);
                
                let changed = false;
                fileYears.forEach(y => {
                    if(!configData.academicYears.some(cy => cy.year === y)) {
                        configData.academicYears.push({ year: y, isDefault: false });
                        changed = true;
                    }
                });

                if(changed) {
                    configData.academicYears.sort((a,b) => b.year.localeCompare(a.year)); 
                    setUnsaved(true);
                    showMsg('info', '同步完成', '系統已自動偵測到檔案庫中的學年度模組並加入列表，請記得儲存設定。');
                }
            } catch(e) { console.error("Sync failed", e); }
        }

        function toggleToken() {
            const t = document.getElementById('gh-token');
            const i = document.getElementById('token-eye');
            t.type = t.type === 'password' ? 'text' : 'password';
            i.className = t.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        }
        function logout() { showMsg('confirm', '確定登出？', '未儲存的變更將會遺失。', null, () => { localStorage.removeItem('gh_creds_v10'); location.reload(); }); }

        function showMsg(type, title, desc, inputConfig = null, onConfirm = null) {
            const modal = document.getElementById('msg-modal');
            const icon = document.getElementById('msg-icon');
            const btns = document.getElementById('msg-btns');
            const inputArea = document.getElementById('msg-input-area');
            
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-desc').innerText = desc;
            inputArea.classList.add('hidden');
            document.getElementById('msg-select-area').classList.add('hidden');

            let iconClass = '', iconHtml = '';
            if(type === 'success') { iconClass = 'bg-emerald-100 text-emerald-600'; iconHtml = '<i class="fas fa-check"></i>'; }
            else if(type === 'error') { iconClass = 'bg-red-100 text-red-600'; iconHtml = '<i class="fas fa-times"></i>'; }
            else if(type === 'info') { iconClass = 'bg-blue-100 text-blue-600'; iconHtml = '<i class="fas fa-info"></i>'; }
            else if(type === 'confirm' || type === 'prompt') { iconClass = 'bg-amber-100 text-amber-600'; iconHtml = '<i class="fas fa-question"></i>'; }
            
            icon.className = `w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl shadow-sm ${iconClass}`;
            icon.innerHTML = iconHtml;

            if(type === 'prompt' && inputConfig) {
                inputArea.classList.remove('hidden');
                document.getElementById('msg-input-label').innerText = inputConfig.label || '名稱';
                const inp = document.getElementById('msg-input');
                inp.value = inputConfig.value || '';
                
                if(inputConfig.showSelect) {
                    document.getElementById('msg-select-area').classList.remove('hidden');
                    const sel = document.getElementById('msg-select');
                    sel.innerHTML = '<option value="">不複製 (空白)</option>';
                    configData.academicYears.forEach(y => sel.innerHTML += `<option value="${y.year}">複製 ${y.year}</option>`);
                }
                setTimeout(() => inp.focus(), 50);
            }

            btns.innerHTML = '';
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'px-5 py-2.5 rounded-lg border border-slate-300 font-bold text-slate-600 hover:bg-slate-50 transition text-sm';
            cancelBtn.innerText = type === 'success' || type === 'info' ? '關閉' : '取消';
            cancelBtn.onclick = () => { modal.classList.add('hidden'); modal.classList.remove('opacity-100'); };
            btns.appendChild(cancelBtn);

            if(type === 'confirm' || type === 'prompt') {
                const okBtn = document.createElement('button');
                okBtn.className = `px-5 py-2.5 rounded-lg font-bold text-white shadow-md transition text-sm ${type==='prompt' ? 'bg-primary hover:bg-sky-900' : 'bg-danger hover:bg-red-700'}`;
                okBtn.innerText = '確認';
                // 修正：先關閉視窗，再執行 callback，避免 callback 內部開啟新視窗被立即關閉
                okBtn.onclick = async () => {
                    modal.classList.add('hidden'); 
                    modal.classList.remove('opacity-100');
                    if(onConfirm) {
                        if(type === 'prompt') {
                            const val = document.getElementById('msg-input').value.trim();
                            const selVal = document.getElementById('msg-select').value;
                            await onConfirm(val, selVal);
                        } else {
                            await onConfirm();
                        }
                    }
                };
                btns.appendChild(okBtn);
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.add('opacity-100'); document.getElementById('msg-panel').classList.remove('scale-95'); document.getElementById('msg-panel').classList.add('scale-100'); }, 10);
        }

        // --- Year Management ---
        function renderYearList() {
            const el = document.getElementById('year-list'); el.innerHTML = '';
            configData.academicYears.sort((a,b) => b.year.localeCompare(a.year));
            configData.academicYears.forEach(y => {
                const div = document.createElement('div');
                div.className = `list-item ${activeYearId===y.year?'active':''}`;
                div.onclick = () => selectYear(y.year);
                div.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold text-sm">${y.year} 學年度</span>${y.isDefault?'<span class="text-[10px] bg-secondary text-white px-1.5 rounded font-bold ml-2">Def</span>':''}</div>`;
                el.appendChild(div);
            });
        }

        function openYearModal() {
            showMsg('prompt', '新增學年度', '請輸入學年度並選擇是否複製模板', {label: '學年度 (如: 114)', showSelect: true}, async (year, copyFrom) => {
                if(!year) return;
                if(configData.academicYears.some(y => y.year === year)) { showMsg('error', '錯誤', '學年度已存在'); return; }

                const path = `hedb/year_templates/year_${year}_templates.json`;
                let initialData = { fields: [] };

                try {
                    if (copyFrom) {
                        const sourcePath = `hedb/year_templates/year_${copyFrom}_templates.json`;
                        const res = await apiFetch(sourcePath);
                        if (res.status === 200) initialData = res.data; 
                    }
                    
                    const check = await apiFetch(path);
                    const sha = check.status === 200 ? check.sha : null;
                    
                    await uploadFile(path, initialData, sha); 
                    
                    configData.academicYears.push({ year, isDefault: false });
                    await saveConfig(); 
                    
                    setUnsaved(false); renderYearList(); selectYear(year); showMsg('success', '成功', '學年度模組已建立');
                } catch(e) { showMsg('error', '失敗', e.message); }
            });
        }

        function renameCurrentYear() {
            if(!activeYearId) return;
            showMsg('prompt', '重新命名學年度', '請輸入新名稱，這將會搬移設定檔。', {label: '新名稱', value: activeYearId}, async (newYear) => {
                if(!newYear || newYear === activeYearId) return;
                if(configData.academicYears.some(y => y.year === newYear)) { showMsg('error', '錯誤', '名稱已存在'); return; }
                try {
                    const oldPath = `hedb/year_templates/year_${activeYearId}_templates.json`;
                    const newPath = `hedb/year_templates/year_${newYear}_templates.json`;
                    const res = await apiFetch(oldPath);
                    const content = res.status === 200 ? res.data : { fields: [] };
                    
                    const checkNew = await apiFetch(newPath);
                    const newSha = checkNew.status === 200 ? checkNew.sha : null;
                    
                    await uploadFile(newPath, content, newSha); 
                    
                    if (res.status === 200) await deleteFile(oldPath, res.sha);

                    const yConf = configData.academicYears.find(y => y.year === activeYearId);
                    yConf.year = newYear; 
                    
                    await saveConfig(); 

                    activeYearId = newYear; renderYearList(); selectYear(newYear); showMsg('success', '成功', '學年度已重新命名');
                } catch(err) { showMsg('error', '失敗', err.message); }
            });
        }

        async function selectYear(year) {
            activeYearId = year;
            renderYearList();
            const yConf = configData.academicYears.find(y => y.year === year);
            document.getElementById('current-year-title').innerText = `${year} 學年度`;
            document.getElementById('is-default-year').checked = yConf.isDefault || false;
            document.getElementById('default-badge').classList.toggle('hidden', !yConf.isDefault);
            document.getElementById('year-empty-state').classList.add('hidden');
            document.getElementById('year-config-panel').classList.remove('hidden');
            document.getElementById('year-config-panel').classList.add('flex');

            // 載入時重置篩選器
            updateYearFilterOptions();
            document.getElementById('year-filter-cat').value = 'all';

            const path = `hedb/year_templates/year_${year}_templates.json`;
            document.getElementById('year-field-list').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400"><div class="spinner border-slate-300 border-t-primary mx-auto mb-2"></div>讀取設定中...</td></tr>`;
            
            try {
                const res = await apiFetch(path);
                yearTemplateData = res.status === 404 ? { fields: [] } : res.data;
                renderYearFields();
            } catch(e) {
                document.getElementById('year-field-list').innerHTML = `<tr><td colspan="6" class="p-4 text-red-500 text-center">讀取失敗: ${e.message}</td></tr>`;
            }
        }

        // 修正：學年度區篩選器更新
        function updateYearFilterOptions() {
            const sel = document.getElementById('year-filter-cat');
            const currentVal = sel.value;
            sel.innerHTML = '<option value="all">所有分類</option>';
            configData.templateCategories.forEach(c => {
                sel.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
            sel.innerHTML += '<option value="uncategorized">未分類</option>';
            sel.value = currentVal; // 保持目前選擇
        }

        function deleteCurrentYear() {
            showMsg('confirm', '確認刪除學年度？', `這將會刪除 ${activeYearId} 學年度，無法復原。`, null, async () => {
                const path = `hedb/year_templates/year_${activeYearId}_templates.json`;
                try {
                    const check = await apiFetch(path);
                    if(check.status === 200) await deleteFile(path, check.sha);
                    
                    configData.academicYears = configData.academicYears.filter(y => y.year !== activeYearId);
                    await saveConfig(); 

                    activeYearId = null; setUnsaved(false);
                    document.getElementById('year-config-panel').classList.add('hidden');
                    document.getElementById('year-empty-state').classList.remove('hidden');
                    renderYearList(); showMsg('success', '成功', '學年度已刪除');
                } catch(e) { showMsg('error', '失敗', e.message); }
            });
        }

        function renderYearFields() {
            const listEl = document.getElementById('year-field-list');
            const filterCat = document.getElementById('year-filter-cat')?.value || 'all';
            listEl.innerHTML = '';
            
            if(!yearTemplateData.fields || yearTemplateData.fields.length === 0) {
                listEl.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400">尚未加入欄位</td></tr>`;
                return;
            }

            // 修正：支援篩選邏輯，並保留原始 index
            yearTemplateData.fields.forEach((f, idx) => {
                // 篩選檢查
                if(filterCat !== 'all') {
                    if(filterCat === 'uncategorized' && f.category) return;
                    if(filterCat !== 'uncategorized' && f.category !== filterCat) return;
                }

                const catName = f.category ? (configData.templateCategories.find(c => c.id === f.category)?.name || '未分類') : '未分類';
                const typeLabel = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type;
                
                // 篩選狀態下隱藏排序按鈕，避免混亂
                const sortBtns = filterCat === 'all' ? `
                    <button onclick="moveField(${idx}, -1, 'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition"><i class="fas fa-arrow-up"></i></button>
                    <button onclick="moveField(${idx}, 1, 'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition"><i class="fas fa-arrow-down"></i></button>
                    <button onclick="openMoveModal(${idx}, 'year')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 hover:text-primary transition mr-1"><i class="fas fa-exchange-alt"></i></button>
                ` : `<span class="text-xs text-slate-300 mr-2">(篩選中無法排序)</span>`;

                listEl.innerHTML += `
                <tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="text-center py-3"><input type="checkbox" class="year-check custom-checkbox" value="${idx}"></td>
                    <td class="text-center font-mono text-xs text-slate-400">${idx+1}</td>
                    <td class="font-bold text-slate-700 text-sm">${f.label}<br><span class="text-[10px] text-slate-400 font-mono">${f.id}</span></td>
                    <td class="text-xs text-slate-500">${catName}</td>
                    <td class="text-xs text-slate-500">${typeLabel}</td>
                    <td class="text-right py-3 pr-4">
                        <div class="flex items-center justify-end gap-1">
                            ${sortBtns}
                            <button onclick="editField('${f.id}', 'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-primary transition"><i class="fas fa-pen"></i></button>
                            <button onclick="removeYearField(${idx})" class="p-1.5 hover:bg-red-100 rounded text-slate-400 hover:text-danger transition"><i class="fas fa-trash-alt"></i></button>
                        </div>
                    </td>
                </tr>`;
            });
        }

        function removeYearField(idx) {
            showMsg('confirm', '移除欄位？', '確定要從此學年度移除此欄位？', null, () => {
                yearTemplateData.fields.splice(idx, 1); renderYearFields(); setUnsaved(true); showMsg('success', '成功', '欄位已移除');
            });
        }

        function toggleYearAll(el) { document.querySelectorAll('.year-check').forEach(c => c.checked = el.checked); }

        function deleteSelectedYearFields() {
            const checked = Array.from(document.querySelectorAll('.year-check:checked')).map(c => parseInt(c.value));
            if(checked.length === 0) return;
            showMsg('confirm', '批次刪除', `確定移除選取的 ${checked.length} 個欄位？`, null, () => {
                checked.sort((a,b) => b - a).forEach(idx => yearTemplateData.fields.splice(idx, 1));
                renderYearFields(); setUnsaved(true); showMsg('success', '成功', '已移除選取項目');
            });
        }

        function toggleDefaultYear() {
            const isChecked = document.getElementById('is-default-year').checked;
            configData.academicYears.forEach(y => y.isDefault = false);
            const curr = configData.academicYears.find(y => y.year === activeYearId);
            if(curr) curr.isDefault = isChecked;
            document.getElementById('default-badge').classList.toggle('hidden', !isChecked);
            setUnsaved(true);
            showMsg('success', '成功', '預設學年度已更新');
        }

        // --- Template Categories ---
        function renderTemplateCats() {
            const el = document.getElementById('template-cat-list'); el.innerHTML = '';
            el.innerHTML += `<div class="list-item ${activeCatId==='all'?'active':''}" onclick="selectCat('all')"><span class="font-bold text-sm">全部欄位</span></div>`;
            configData.templateCategories.forEach(c => {
                el.innerHTML += `<div class="list-item ${activeCatId===c.id?'active':''}" onclick="selectCat('${c.id}')"><span class="font-bold text-sm">${c.name}</span></div>`;
            });
            el.innerHTML += `<div class="list-item ${activeCatId==='uncategorized'?'active':''}" onclick="selectCat('uncategorized')"><span class="text-sm">未分類</span></div>`;
            
            // 同步更新學年度區的篩選清單
            updateYearFilterOptions();
        }

        function openCategoryModal() {
            showMsg('prompt', '新增模板分類', '請輸入分類名稱', {label: '名稱'}, (val) => {
                if(val) { configData.templateCategories.push({ id: 'cat_'+Date.now(), name: val }); renderTemplateCats(); setUnsaved(true); showMsg('success', '成功', '分類已建立'); }
            });
        }

        function renameCurrentCat() {
            if(activeCatId==='all'||activeCatId==='uncategorized') return;
            const c = configData.templateCategories.find(x => x.id === activeCatId);
            showMsg('prompt', '重新命名分類', '請輸入新名稱', {label: '名稱', value: c.name}, (val) => {
                if(val) { c.name = val; renderTemplateCats(); setUnsaved(true); document.getElementById('current-cat-title').innerText = val; showMsg('success', '成功', '分類已重新命名'); }
            });
        }

        function deleteCurrentCat() {
            if(activeCatId==='all'||activeCatId==='uncategorized') return;
            showMsg('confirm', '刪除分類？', '分類下的欄位將變為「未分類」。', null, () => {
                configData.templateCategories = configData.templateCategories.filter(c => c.id !== activeCatId);
                configData.globalFields.forEach(f => { if(f.category === activeCatId) delete f.category; });
                selectCat('all'); setUnsaved(true); showMsg('success', '成功', '分類已刪除');
            });
        }

        function selectCat(id) {
            activeCatId = id; renderTemplateCats();
            const name = id === 'all' ? '全部欄位' : id === 'uncategorized' ? '未分類' : configData.templateCategories.find(c=>c.id===id).name;
            document.getElementById('current-cat-title').innerText = name;
            document.getElementById('cat-actions').classList.toggle('hidden', id === 'all' || id === 'uncategorized');
            renderGlobalList();
        }

        // --- Custom Type Management ---
        function openTypeManager() { switchView('types'); renderTypeManagerPage(); } 
        function renderTypeManagerPage() {
            const list = document.getElementById('type-list-page');
            list.innerHTML = '';
            configData.fieldTypes.forEach((t, i) => {
                list.innerHTML += `<tr class="hover:bg-slate-50 transition"><td class="px-4 py-3 font-mono text-xs text-primary font-bold">${t.key}</td><td class="px-4 py-3 text-xs font-bold text-slate-700">${t.label}</td><td class="px-4 py-3 text-right"><button onclick="delCustomTypePage('${t.key}')" class="text-slate-300 hover:text-danger"><i class="fas fa-trash-alt"></i></button></td></tr>`;
            });
        }

        function addCustomTypePage() {
            const key = document.getElementById('new-type-key-page').value.trim();
            const label = document.getElementById('new-type-label-page').value.trim();
            if(!key || !label) return;
            if(configData.fieldTypes.some(t=>t.key===key)) { showMsg('error', '錯誤', 'Key 已存在'); return; }
            configData.fieldTypes.push({key, label}); setUnsaved(true); renderTypeManagerPage(); showMsg('success', '成功', '類型已新增');
        }
        function delCustomTypePage(key) { showMsg('confirm', '刪除類型？', '已使用此類型的欄位可能會顯示異常。', null, () => { configData.fieldTypes = configData.fieldTypes.filter(t => t.key !== key); setUnsaved(true); renderTypeManagerPage(); showMsg('success', '成功', '類型已刪除'); }); }

        function updateTypeSelect() {
            const sel = document.getElementById('ed-type'); sel.innerHTML = '';
            configData.fieldTypes.forEach(t => sel.innerHTML += `<option value="${t.key}">${t.label}</option>`);
        }

        // --- Global Fields ---
        function renderGlobalList() {
            const el = document.getElementById('global-field-list');
            let list = configData.globalFields;
            if(activeCatId === 'uncategorized') list = list.filter(f => !f.category);
            else if(activeCatId !== 'all') list = list.filter(f => f.category === activeCatId);
            list.sort((a,b) => a.order - b.order);
            
            el.innerHTML = list.map((f, i) => {
                const typeLabel = configData.fieldTypes.find(t=>t.key===f.type)?.label || f.type;
                return `
                <tr class="hover:bg-slate-50 border-b border-slate-100 transition">
                    <td class="text-center font-mono text-xs text-slate-400 py-3">${i+1}</td>
                    <td class="font-bold text-slate-700 text-sm">${f.label}<br><span class="text-[10px] text-slate-400 font-mono">${f.id}</span></td>
                    <td class="text-xs text-primary font-mono">${typeLabel}</td>
                    <td class="text-xs text-slate-400">${f.required?'<span class="text-red-500 bg-red-50 px-1 rounded">必填</span>':''}</td>
                    <td class="text-right flex justify-end gap-1 py-3 pr-4">
                        <button onclick="moveField(${i}, -1, 'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition"><i class="fas fa-arrow-up"></i></button>
                        <button onclick="moveField(${i}, 1, 'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition"><i class="fas fa-arrow-down"></i></button>
                        <button onclick="openMoveModal(${i}, 'global')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 hover:text-primary transition mr-1"><i class="fas fa-exchange-alt"></i></button>
                        <button onclick="editField('${f.id}', 'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-primary transition mr-1"><i class="fas fa-pen"></i></button>
                        <button onclick="delGlobalField('${f.id}')" class="p-1.5 hover:bg-red-100 rounded text-slate-400 hover:text-danger transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                </tr>
            `}).join('');
        }

        function addNewGlobalField() {
            isEditMode = false; targetList = 'global';
            document.getElementById('editor-title').innerText = '建立新欄位模板';
            document.getElementById('ed-orig-id').value = '';
            document.getElementById('ed-field-id').value = ''; document.getElementById('ed-label').value = '';
            const idField = document.getElementById('ed-field-id'); idField.readOnly = false; idField.classList.remove('bg-gray-100', 'text-gray-500');
            updateTypeSelect(); document.getElementById('ed-type').value = 'text';
            document.getElementById('editor-modal').dataset.curr = '{}';
            
            const catSel = document.getElementById('ed-category');
            catSel.innerHTML = '<option value="">未分類</option>';
            configData.templateCategories.forEach(c => catSel.innerHTML += `<option value="${c.id}" ${activeCatId===c.id?'selected':''}>${c.name}</option>`);
            document.getElementById('ed-category-container').classList.remove('hidden');
            
            renderOpts(); document.getElementById('editor-modal').classList.remove('hidden');
        }

        function editField(id, type) {
            isEditMode = true; targetList = type; updateTypeSelect();
            let f;
            if (type === 'global') {
                f = configData.globalFields.find(c => c.id === id);
                document.getElementById('editor-title').innerText = '編輯欄位模板';
                document.getElementById('ed-field-id').readOnly = false; 
            } else {
                f = yearTemplateData.fields.find(c => c.id === id);
                document.getElementById('editor-title').innerText = `編輯欄位 (${activeYearId} 學年度)`;
                document.getElementById('ed-field-id').readOnly = true; 
            }
            
            // 修正：無論是 Global 或 Year，都允許編輯分類
            const catSel = document.getElementById('ed-category');
            catSel.innerHTML = '<option value="">未分類</option>';
            configData.templateCategories.forEach(c => catSel.innerHTML += `<option value="${c.id}" ${f.category===c.id?'selected':''}>${c.name}</option>`);
            document.getElementById('ed-category-container').classList.remove('hidden');

            document.getElementById('ed-orig-id').value = f.id;
            document.getElementById('ed-field-id').value = f.id; 
            document.getElementById('ed-label').value = f.label;
            document.getElementById('ed-type').value = f.type;
            document.getElementById('ed-required').checked = f.required || false;
            document.getElementById('ed-system').checked = f.isSystem || false;
            document.getElementById('editor-modal').dataset.curr = JSON.stringify(f);
            renderOpts(); document.getElementById('editor-modal').classList.remove('hidden');
        }

        function saveField() {
            const newId = document.getElementById('ed-field-id').value.trim();
            const label = document.getElementById('ed-label').value.trim();
            const type = document.getElementById('ed-type').value;
            const origId = document.getElementById('ed-orig-id').value;

            if(!newId || !label) { showMsg('error', '錯誤', '請輸入 ID 與名稱'); return; }
            if(!/^[a-zA-Z0-9_]+$/.test(newId)) { showMsg('error', '錯誤', 'ID 格式錯誤 (僅限英數底線)'); return; }
            
            if (targetList === 'global') {
                const exists = configData.globalFields.some(c => c.id === newId);
                if ((!isEditMode && exists) || (isEditMode && newId !== origId && exists)) { showMsg('error', '錯誤', 'ID 已存在'); return; }
            }

            let f = {};
            if (isEditMode) {
                if (targetList === 'global') f = configData.globalFields.find(c => c.id === origId);
                else f = yearTemplateData.fields.find(c => c.id === origId);
            }

            f.id = newId; f.label = label; f.type = type;
            f.required = document.getElementById('ed-required').checked;
            f.isSystem = document.getElementById('ed-system').checked;
            // 修正：儲存分類
            f.category = document.getElementById('ed-category').value;

            if(type === 'single_select') {
                f.options = document.getElementById('ed-opt-list').value.split(',').map(x=>x.trim()).filter(x=>x);
                const d=document.getElementById('ed-dep').value, v=document.getElementById('ed-val').value, l=document.getElementById('ed-lim').value;
                if(d&&v&&l) f.filterRule = {dep:d, val:v, limitTo:l.split(',').map(x=>x.trim())}; else delete f.filterRule;
            }
            if(type === 'number') { f.calcMode = document.getElementById('ed-mode').value; f.decimal = parseInt(document.getElementById('ed-dec').value)||0; f.keepZero = document.getElementById('ed-keepZero').checked; }
            if(type === 'date') f.dateFormat = document.getElementById('ed-fmt').value;

            if (targetList === 'global' && !isEditMode) { 
                f.order = configData.globalFields.length + 1; 
                configData.globalFields.push(f); 
            }
            
            setUnsaved(true);
            document.getElementById('editor-modal').classList.add('hidden');
            if (targetList === 'global') renderGlobalList(); else renderYearFields();
            showMsg('info', '暫存成功', '設定已暫存，請記得按「儲存設定」發布。');
        }

        function delGlobalField(id) {
            showMsg('confirm', '刪除模板？', '確定刪除此模板？', null, () => {
                configData.globalFields = configData.globalFields.filter(f => f.id !== id);
                renderGlobalList(); setUnsaved(true); showMsg('success', '成功', '模板已刪除');
            });
        }

        function moveField(idx, dir, type) {
            let list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            if(idx+dir < 0 || idx+dir >= list.length) return;
            [list[idx], list[idx+dir]] = [list[idx+dir], list[idx]];
            if (type === 'global') { list.forEach((f, i) => f.order = i+1); renderGlobalList(); } else renderYearFields();
            setUnsaved(true); showMsg('success', '成功', '排序已更新');
        }

        function openMoveModal(idx, type) {
            moveSrcIndex = idx; moveType = type; const select = document.getElementById('move-select'); select.innerHTML = '';
            let list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            document.getElementById('move-target-name').innerText = list[idx].label;
            list.forEach((item, i) => { select.innerHTML += `<option value="${i}" ${i===idx?'selected':''}>${i+1}. ${item.label} ${i===idx?'(目前)':''}</option>`; });
            document.getElementById('move-modal').classList.remove('hidden');
        }

        function saveMove() {
            const targetIdx = parseInt(document.getElementById('move-select').value);
            if (targetIdx !== moveSrcIndex) {
                if (moveType === 'global') {
                    const item = configData.globalFields.splice(moveSrcIndex, 1)[0];
                    configData.globalFields.splice(targetIdx, 0, item);
                    configData.globalFields.forEach((f, i) => f.order = i + 1);
                    renderGlobalList();
                } else {
                    const item = yearTemplateData.fields.splice(moveSrcIndex, 1)[0];
                    yearTemplateData.fields.splice(targetIdx, 0, item);
                    renderYearFields();
                }
                setUnsaved(true); showMsg('success', '成功', '排序已更新');
            }
            document.getElementById('move-modal').classList.add('hidden');
        }

        // --- Picker ---
        function openFieldPicker() {
            const list = document.getElementById('picker-list'); list.innerHTML = '';
            document.getElementById('picker-select-all').checked = false;
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));
            if(available.length === 0) list.innerHTML = '<div class="p-4 text-center text-gray-400">已加入所有模板欄位</div>';
            else available.forEach(f => list.innerHTML += `<label class="flex items-center p-3 border rounded-lg hover:border-primary cursor-pointer hover:bg-indigo-50 mb-2"><input type="checkbox" value="${f.id}" class="picker-checkbox custom-checkbox mr-3"><div class="flex-grow flex justify-between"><span class="font-bold text-sm text-slate-700">${f.label}</span><span class="text-xs text-slate-400 font-mono">${f.id}</span></div></label>`);
            document.getElementById('picker-modal').classList.remove('hidden');
        }
        function togglePickerAll(cb) { document.querySelectorAll('.picker-checkbox').forEach(el => el.checked = cb.checked); }
        
        function addSelectedFields() {
            const checkboxes = document.querySelectorAll('.picker-checkbox:checked');
            if (checkboxes.length === 0) { document.getElementById('picker-modal').classList.add('hidden'); return; }
            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            const orderMap = {}; configData.globalFields.forEach(f => orderMap[f.id] = f.order);
            selectedIds.sort((a, b) => orderMap[a] - orderMap[b]);
            
            selectedIds.forEach(id => { 
                const t = configData.globalFields.find(gf => gf.id === id); 
                if (t) yearTemplateData.fields.push(JSON.parse(JSON.stringify(t))); 
            });
            
            renderYearFields(); 
            setUnsaved(true);
            document.getElementById('picker-modal').classList.add('hidden');
            showMsg('success', '成功', '欄位已加入');
        }

        function renderOpts() {
            const type = document.getElementById('ed-type').value; const container = document.getElementById('ed-opts');
            const f = JSON.parse(document.getElementById('editor-modal').dataset.curr || '{}');
            let html = '';
            if(type === 'single_select') html = `<div><label class="text-xs font-bold text-slate-500 uppercase">選項</label><textarea id="ed-opt-list" class="w-full border border-slate-300 rounded p-2 text-sm mt-1" rows="3">${f.options?.join(',')||''}</textarea></div><div class="mt-2 pt-2 border-t"><label class="text-xs text-indigo-500 font-bold">連動</label><div class="grid grid-cols-2 gap-2 mt-1"><input id="ed-dep" placeholder="依賴ID" class="w-full border p-2 rounded text-xs" value="${f.filterRule?.dep||''}"><input id="ed-val" placeholder="值" class="w-full border p-2 rounded text-xs" value="${f.filterRule?.val||''}"></div><input id="ed-lim" placeholder="限制選項" class="w-full border p-2 rounded text-xs mt-1" value="${f.filterRule?.limitTo?.join(',')||''}"></div>`;
            else if(type === 'number') html = `<div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-slate-500">模式</label><select id="ed-mode" class="w-full border rounded p-2 bg-white text-sm"><option value="copy">複製</option><option value="average" ${f.calcMode==='average'?'selected':''}>平均</option></select></div><div><label class="text-xs font-bold text-slate-500">小數</label><input type="number" id="ed-dec" class="w-full border rounded p-2 text-sm" value="${f.decimal||0}"></div></div><div class="mt-2"><label class="flex items-center text-sm"><input type="checkbox" id="ed-keepZero" ${f.keepZero?'checked':''} class="mr-2 custom-checkbox"> 保留0</label></div>`;
            else if(type === 'date') html = `<div><label class="text-xs font-bold text-slate-500">格式</label><select id="ed-fmt" class="w-full border rounded p-2 bg-white text-sm"><option value="ROC" ${f.dateFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.dateFormat==='West'?'selected':''}>西元</option></select></div>`;
            container.innerHTML = html || '<div class="text-center text-xs text-slate-400">無額外設定</div>';
        }

        async function saveConfig() {
            const newSha = await uploadFile(ghConfig.path, configData, configSha);
            configSha = newSha;
        }

        async function saveAll() {
            const btn = document.getElementById('btn-save'); btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>';
            try {
                await saveConfig();
                
                if(activeYearId) {
                    const path = `hedb/year_templates/year_${activeYearId}_templates.json`;
                    const check = await apiFetch(path);
                    const sha = check.status === 200 ? check.sha : null;
                    await uploadFile(path, yearTemplateData, sha);
                }
                
                setUnsaved(false); showMsg('success', '儲存成功', '所有設定已更新至 GitHub');
            } catch(e) { showMsg('error', '儲存失敗', e.message); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 儲存設定'; }
        }

        async function apiFetch(path) { 
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}?t=${new Date().getTime()}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } }); 
            if(res.status === 404) return { status: 404 }; 
            const data = await res.json(); 
            if (Array.isArray(data)) {
                return { status: 200, data: data, sha: null };
            }
            const content = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, "")))); 
            return { status: 200, data: JSON.parse(content), sha: data.sha }; 
        }

        async function uploadFile(path, contentObj, sha = null) { 
            const body = { 
                message: "Update config via Admin Panel", 
                content: btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2)))) 
            };
            if (sha) body.sha = sha; 
            const res = await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`, { 
                method: 'PUT', 
                headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, 
                body: JSON.stringify(body) 
            }); 
            if(!res.ok) throw new Error("Upload failed: " + res.status + " " + res.statusText); 
            
            const data = await res.json();
            return data.content ? data.content.sha : null;
        }

        async function deleteFile(path, sha) { 
            if (!sha) { try { const check = await apiFetch(path); if(check.status===200) sha = check.sha; } catch(e){} }
            if(!sha) return; 
            await fetch(`https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`, { method: 'DELETE', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ message: "Delete file", sha: sha }) }); 
        }
        
        function switchView(view) {
            document.getElementById('view-years').classList.toggle('hidden', view !== 'years');
            document.getElementById('view-fields').classList.toggle('hidden', view !== 'fields');
            document.getElementById('view-types').classList.toggle('hidden', view !== 'types');
            
            document.getElementById('view-fields').classList.toggle('flex', view === 'fields');
            document.getElementById('view-types').classList.toggle('flex', view === 'types');

            document.getElementById('nav-years').className = `nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 ${view==='years'?'active':''}`;
            document.getElementById('nav-fields').className = `nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 ${view==='fields'?'active':''}`;
            document.getElementById('nav-types').className = `nav-btn py-3 px-2 text-sm font-medium flex items-center gap-2 ${view==='types'?'active':''}`;
            
            if(view === 'fields') renderGlobalList();
            if(view === 'types') renderTypeManagerPage();
        }

        window.onload = init;
    </script>
</body>
</html>
