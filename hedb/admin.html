<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系統管理後台 (GitHub API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#4f46e5', surface: '#ffffff', background: '#f1f5f9' },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>
    <style>
        .login-bg { background: linear-gradient(135deg, #e0e7ff 0%, #f3f4f6 100%); }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
        .input-stylish { width: 100%; background: rgba(255,255,255,0.9); border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.75rem 1rem 0.75rem 2.5rem; transition: all 0.2s; font-size: 0.95rem; }
        .input-stylish:focus { border-color: #6366f1; outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }
        .input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #94a3b8; }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scroll::-webkit-scrollbar { width: 6px; } .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .year-item.active { background-color: #e0e7ff; color: #4338ca; border-left: 4px solid #4338ca; }
        .year-item { border-left: 4px solid transparent; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700 bg-slate-50">

    <!-- 1. 登入介面 -->
    <div id="login-screen" class="fixed inset-0 z-[100] login-bg flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 rounded-2xl shadow-2xl relative z-10 animate-fade-in">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-4 shadow-lg transform rotate-3"><i class="fas fa-sliders-h"></i></div>
                <h1 class="text-2xl font-bold text-slate-800 tracking-wide">後台管理系統</h1>
                <p class="text-slate-500 text-sm mt-2">GitHub API 連線模式</p>
            </div>
            <div class="space-y-5">
                <div class="relative"><i class="fas fa-user input-icon"></i><input type="text" id="gh-user" class="input-stylish" placeholder="GitHub Username"></div>
                <div class="relative"><i class="fas fa-folder-open input-icon"></i><input type="text" id="gh-repo" class="input-stylish" placeholder="Repository Name"></div>
                <div class="relative">
                    <i class="fas fa-key input-icon"></i><input type="password" id="gh-token" class="input-stylish" placeholder="Access Token">
                    <button onclick="toggleToken()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-indigo-600 p-1"><i class="fas fa-eye" id="token-eye"></i></button>
                </div>
                <div class="pt-4">
                    <button onclick="connectGitHub()" id="btn-connect" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition flex justify-center items-center gap-2"><span>登入系統</span><i class="fas fa-arrow-right"></i></button>
                    <div id="login-msg" class="text-center mt-4 h-5 text-sm font-medium text-red-500 opacity-0 transition-opacity"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. 主介面 -->
    <div id="admin-interface" class="hidden h-full flex flex-col bg-slate-50 opacity-0 transition-opacity duration-500">
        <header class="h-16 flex-shrink-0 border-b border-slate-200 flex items-center justify-between px-6 bg-white shadow-sm z-20">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-600 text-white rounded flex items-center justify-center text-sm shadow"><i class="fas fa-tools"></i></div>
                    <h1 class="font-bold text-lg tracking-wide text-slate-800">系統配置</h1>
                </div>
                <div class="flex bg-slate-100 p-1 rounded-lg">
                    <button onclick="switchView('years')" id="tab-years" class="px-4 py-1.5 rounded-md text-sm font-bold shadow-sm bg-white text-indigo-600 transition-all">學年度模組</button>
                    <button onclick="switchView('fields')" id="tab-fields" class="px-4 py-1.5 rounded-md text-sm font-medium text-slate-500 hover:text-slate-700 transition-all">欄位模板</button>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="status-msg" class="text-sm text-emerald-600 font-medium hidden bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100"><i class="fas fa-check-circle mr-1"></i> 儲存成功</span>
                <button onclick="saveAll()" id="btn-save" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 text-sm"><i class="fas fa-cloud-upload-alt"></i> 儲存設定</button>
                <div class="w-px h-6 bg-slate-200 mx-2"></div>
                <button onclick="logout()" class="text-sm text-slate-500 hover:text-red-600 transition flex items-center gap-1"><i class="fas fa-sign-out-alt"></i> 登出</button>
            </div>
        </header>

        <div class="flex-grow overflow-hidden relative">
            <!-- View 1: 學年度模組 (Year Modules) -->
            <div id="view-years" class="w-full h-full flex">
                <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-10">
                    <div class="p-4 border-b border-slate-100 bg-slate-50">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">學年度列表</h2>
                        <button onclick="openYearModal()" class="w-full py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-500 text-sm font-bold hover:border-indigo-400 hover:text-indigo-600 transition flex items-center justify-center gap-2"><i class="fas fa-plus"></i> 新增學年度</button>
                    </div>
                    <div id="year-list" class="flex-grow overflow-y-auto p-2 space-y-1 custom-scroll"></div>
                </aside>
                <section class="flex-grow flex flex-col bg-slate-50/50">
                    <div id="year-config-panel" class="hidden flex-col h-full">
                        <div class="bg-white px-6 py-4 border-b border-slate-200 shadow-sm flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <span id="current-year-title">...</span>
                                    <span id="default-badge" class="hidden text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full font-bold border border-amber-200">Default</span>
                                </h2>
                                <p class="text-xs text-slate-400 mt-1">此模組設定獨立於欄位模板，修改不會影響其他年度。</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="flex items-center gap-2 cursor-pointer text-sm text-slate-600 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                                    <input type="checkbox" id="is-default-year" class="w-4 h-4 text-amber-500 rounded focus:ring-amber-500" onchange="toggleDefaultYear()">
                                    設為預設
                                </label>
                                <button onclick="deleteCurrentYear()" class="text-red-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition" title="刪除"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                        <div class="flex-grow p-6 overflow-hidden flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="font-bold text-slate-700 flex items-center gap-2"><i class="fas fa-cubes text-indigo-500"></i> 此學年度使用欄位 (獨立設定)</h3>
                                <button onclick="openFieldPicker()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow font-bold text-sm flex items-center gap-2"><i class="fas fa-copy"></i> 從模板複製欄位</button>
                            </div>
                            <div class="bg-white rounded-xl border border-slate-200 flex-grow overflow-hidden flex flex-col shadow-sm">
                                <div class="grid grid-cols-12 bg-slate-50 p-3 text-xs font-bold text-slate-500 border-b border-slate-200 uppercase tracking-wider">
                                    <div class="col-span-1 text-center">排序</div><div class="col-span-5">欄位名稱</div><div class="col-span-2">類型</div><div class="col-span-2">ID</div><div class="col-span-2 text-right">操作</div>
                                </div>
                                <div id="year-field-list" class="divide-y divide-slate-100 overflow-y-auto custom-scroll flex-grow"></div>
                            </div>
                        </div>
                    </div>
                    <div id="year-empty-state" class="flex flex-col items-center justify-center h-full text-slate-400">
                        <i class="fas fa-arrow-left text-3xl mb-4"></i><p>請選擇或新增一個學年度模組</p>
                    </div>
                </section>
            </div>

            <!-- View 2: 欄位模板 (Field Templates) -->
            <div id="view-fields" class="w-full h-full hidden flex-col p-6 overflow-y-auto custom-scroll">
                <div class="max-w-6xl mx-auto w-full">
                    <div class="flex justify-between items-center mb-6">
                        <div><h2 class="text-xl font-bold text-slate-800">欄位模板庫 (Template Library)</h2><p class="text-sm text-slate-500 mt-1">在此定義欄位原型，供學年度模組複製使用。</p></div>
                        <button onclick="addNewGlobalField()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg font-bold shadow flex items-center gap-2 text-sm"><i class="fas fa-plus"></i> 建立新模板</button>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="grid grid-cols-12 bg-slate-50 p-3 text-xs font-bold text-slate-500 border-b border-slate-200 uppercase tracking-wider">
                            <div class="col-span-1 text-center">序號</div><div class="col-span-4">欄位名稱 (ID)</div><div class="col-span-2">類型</div><div class="col-span-3">屬性</div><div class="col-span-2 text-right">操作</div>
                        </div>
                        <div id="global-field-list" class="divide-y divide-slate-100 min-h-[150px]"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- 1. 確認視窗 -->
    <div id="confirm-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center animate-fade-in">
            <div class="w-12 h-12 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 text-xl"><i class="fas fa-exclamation-triangle"></i></div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">確認刪除？</h3>
            <p class="text-sm text-slate-500 mb-6" id="confirm-desc">此動作無法復原。</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeConfirm()" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-slate-50 transition text-sm">取消</button>
                <button id="confirm-btn-action" class="px-4 py-2 bg-red-500 text-white rounded-lg font-bold hover:bg-red-600 transition shadow-md text-sm">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- 2. 輸入學年度 -->
    <div id="year-input-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 animate-fade-in">
            <h3 class="text-lg font-bold text-slate-800 mb-4">新增學年度模組</h3>
            <div class="space-y-4 mb-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">學年度 (例如: 114)</label><input type="text" id="new-year-input" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-indigo-500 outline-none font-mono" placeholder="114" onkeydown="if(event.key==='Enter') confirmAddYear()"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">複製舊年度設定</label><select id="copy-template-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"><option value="">不複製 (建立空白模組)</option></select></div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('year-input-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">取消</button>
                <button onclick="confirmAddYear()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 text-sm">新增</button>
            </div>
        </div>
    </div>

    <!-- 3. 欄位編輯器 -->
    <div id="editor-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <h3 class="text-xl font-bold text-slate-800 mb-4">編輯欄位屬性</h3>
            <input type="hidden" id="ed-id"> <input type="hidden" id="ed-orig-id">
            <div class="space-y-4 max-h-[70vh] overflow-y-auto custom-scroll pr-2">
                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">ID (Unique)</label><input type="text" id="ed-field-id" class="w-full border border-slate-300 rounded p-2 text-sm font-mono text-blue-600"></div>
                <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">名稱</label><input type="text" id="ed-label" class="w-full border border-slate-300 rounded p-2 text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-500 uppercase block mb-1">類型</label><select id="ed-type" class="w-full border border-slate-300 rounded p-2 text-sm bg-white" onchange="renderOpts()"><option value="text">文字</option><option value="number">數字</option><option value="date">日期</option><option value="single_select">單選</option><option value="list">條列式</option></select></div>
                    <div class="pt-6 space-y-2"><label class="flex items-center text-sm"><input type="checkbox" id="ed-required" class="mr-2"> 必填</label><label class="flex items-center text-sm"><input type="checkbox" id="ed-system" class="mr-2"> 系統預設</label></div>
                </div>
                <div id="ed-opts" class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm space-y-3"></div>
            </div>
            <div class="mt-6 flex justify-end gap-3 pt-4 border-t border-slate-100">
                <button onclick="document.getElementById('editor-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg text-sm">取消</button>
                <button onclick="saveGlobalField()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 text-sm">暫存</button>
            </div>
        </div>
    </div>

    <!-- 4. 欄位選取 (Batch Add - Copy Logic) -->
    <div id="picker-modal" class="fixed inset-0 z-[55] hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl p-6 flex flex-col max-h-[80vh]">
            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
                <h3 class="text-lg font-bold text-slate-800">從模板複製欄位</h3>
                <button onclick="document.getElementById('picker-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div class="bg-slate-50 p-2 rounded mb-2 border border-slate-200">
                <label class="flex items-center text-sm font-bold text-slate-600 cursor-pointer">
                    <input type="checkbox" id="picker-select-all" class="w-4 h-4 text-indigo-600 rounded mr-2" onchange="togglePickerAll(this)"> 全選 / 取消全選
                </label>
            </div>
            <div id="picker-list" class="flex-grow overflow-y-auto custom-scroll space-y-2 p-1"></div>
            <div class="mt-4 pt-2 border-t border-slate-100 flex justify-end">
                <button onclick="addSelectedFields()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2.5 rounded-lg shadow transition">確認複製選取欄位</button>
            </div>
        </div>
    </div>

    <!-- 5. 移動 Modal -->
    <div id="move-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300">
            <div class="mb-4"><h3 class="text-lg font-bold text-slate-800"><i class="fas fa-exchange-alt text-indigo-500 mr-2"></i>移動順序</h3><p class="text-sm text-slate-500 mt-1">將 <span id="move-target-name" class="font-bold text-indigo-600"></span> 移動至：</p></div>
            <div class="mb-6"><select id="move-select" class="w-full border border-slate-300 rounded-lg p-2.5 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none max-h-60 overflow-y-auto custom-scroll"></select></div>
            <div class="flex justify-end gap-3"><button onclick="closeMoveModal()" class="px-4 py-2 text-slate-500 font-bold hover:bg-slate-100 rounded-lg transition text-sm">取消</button><button onclick="saveMove()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 shadow-md transition text-sm">確認移動</button></div>
        </div>
    </div>

    <script>
        // --- GitHub API & Data State ---
        let ghConfig = { user: '', repo: '', path: 'hedb/config.json', token: '' };
        let configData = { globalFields: [], academicYears: [] }; // globalFields = Templates
        let yearTemplateData = { fields: [] }; // Current Module (Stores Objects now!)
        let activeYearId = null;
        let isEditMode = false;
        let moveSrcIndex = -1; let moveType = '';

        // --- 1. Init & Login ---
        function init() {
            const saved = localStorage.getItem('gh_creds_v3');
            if(saved) {
                const c = JSON.parse(saved);
                document.getElementById('gh-user').value = c.user;
                document.getElementById('gh-repo').value = c.repo;
                document.getElementById('gh-token').value = c.token;
            }
        }

        async function connectGitHub() {
            const btn = document.getElementById('btn-connect');
            const msg = document.getElementById('login-msg');
            const user = document.getElementById('gh-user').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();

            if(!user || !repo || !token) { msg.style.opacity='1'; msg.innerText='請填寫完整資訊'; return; }

            btn.innerHTML = '<div class="spinner"></div> 連線中...'; btn.disabled = true;
            ghConfig = { user, repo, path: 'hedb/config.json', token };

            try {
                const res = await apiFetch(ghConfig.path);
                if(res.status === 404) {
                    configData = { globalFields: [], academicYears: [] };
                } else {
                    configData = res.data;
                    if(Array.isArray(configData)) configData = { globalFields: configData, academicYears: [] };
                }

                localStorage.setItem('gh_creds_v3', JSON.stringify(ghConfig));
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-interface').classList.remove('hidden');
                document.getElementById('admin-interface').style.opacity = '1';
                
                renderYearList();
                if(configData.academicYears.length > 0) selectYear(configData.academicYears[0].year);

            } catch (err) {
                console.error(err);
                msg.style.opacity='1'; msg.innerText='連線失敗: ' + err.message;
            } finally {
                btn.innerHTML = '登入系統'; btn.disabled = false;
            }
        }

        function toggleToken() {
            const t = document.getElementById('gh-token');
            const i = document.getElementById('token-eye');
            t.type = t.type === 'password' ? 'text' : 'password';
            i.className = t.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
        }
        function logout() { localStorage.removeItem('gh_creds_v3'); location.reload(); }

        // --- 2. Year Module Management ---
        function renderYearList() {
            const el = document.getElementById('year-list'); el.innerHTML = '';
            configData.academicYears.forEach(y => {
                const div = document.createElement('div');
                div.className = `year-item p-3 rounded-lg cursor-pointer transition hover:bg-slate-100 flex justify-between items-center ${activeYearId===y.year?'active':''}`;
                div.onclick = () => selectYear(y.year);
                div.innerHTML = `<span class="font-bold text-sm">${y.year} 學年度</span>${y.isDefault?'<span class="text-[10px] bg-amber-100 text-amber-600 px-1.5 rounded font-bold">Def</span>':''}`;
                el.appendChild(div);
            });
        }

        function openYearModal() {
            document.getElementById('new-year-input').value = '';
            const sel = document.getElementById('copy-template-select');
            sel.innerHTML = '<option value="">不複製 (建立空白模組)</option>';
            configData.academicYears.forEach(y => {
                sel.innerHTML += `<option value="${y.year}">複製 ${y.year} 學年度設定</option>`;
            });
            document.getElementById('year-input-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('new-year-input').focus(), 50); 
        }

        async function confirmAddYear() {
            const year = document.getElementById('new-year-input').value.trim();
            const copyFrom = document.getElementById('copy-template-select').value;
            
            if(!year) return;
            if(configData.academicYears.some(y => y.year === year)) { alert("學年度已存在"); return; }

            document.getElementById('year-input-modal').classList.add('hidden');
            
            const path = `year_templates/year_${year}_templates.json`;
            let initialData = { fields: [] }; 

            try {
                if (copyFrom) {
                    // Copy existing module data (Full snapshot)
                    const sourcePath = `year_templates/year_${copyFrom}_templates.json`;
                    const res = await apiFetch(sourcePath);
                    if (res.status === 200) {
                        initialData = res.data; 
                    }
                }

                await uploadFile(path, initialData);
                configData.academicYears.push({ year, isDefault: false });
                await uploadFile(ghConfig.path, configData); 
                
                renderYearList();
                selectYear(year);
                showStatus('學年度模組已建立');
            } catch(e) {
                alert("建立失敗: " + e.message);
            }
        }

        async function selectYear(year) {
            activeYearId = year;
            renderYearList();
            const yConf = configData.academicYears.find(y => y.year === year);
            
            document.getElementById('current-year-title').innerText = `${year} 學年度 - 欄位管理`;
            document.getElementById('is-default-year').checked = yConf.isDefault || false;
            document.getElementById('default-badge').classList.toggle('hidden', !yConf.isDefault);
            
            document.getElementById('year-empty-state').classList.add('hidden');
            document.getElementById('year-config-panel').classList.remove('hidden');
            document.getElementById('year-config-panel').classList.add('flex');

            const path = `year_templates/year_${year}_templates.json`;
            document.getElementById('year-field-list').innerHTML = '<div class="p-8 text-center text-slate-400"><div class="spinner border-slate-300 border-t-indigo-500 mx-auto mb-2"></div>讀取設定中...</div>';
            
            try {
                const res = await apiFetch(path);
                if(res.status === 404) {
                    yearTemplateData = { fields: [] }; 
                } else {
                    yearTemplateData = res.data;
                }
                renderYearFields();
            } catch(e) {
                document.getElementById('year-field-list').innerHTML = `<div class="p-4 text-red-500 text-center">讀取失敗: ${e.message}</div>`;
            }
        }

        function deleteCurrentYear() {
            showConfirm('確認刪除學年度？', `這將會刪除 ${activeYearId} 學年度及其設定檔，無法復原。`, async () => {
                const path = `year_templates/year_${activeYearId}_templates.json`;
                try {
                    await deleteFile(path); 
                    configData.academicYears = configData.academicYears.filter(y => y.year !== activeYearId);
                    await uploadFile(ghConfig.path, configData); 
                    
                    activeYearId = null;
                    document.getElementById('year-config-panel').classList.add('hidden');
                    document.getElementById('year-empty-state').classList.remove('hidden');
                    renderYearList();
                    showStatus('刪除成功');
                } catch(e) { alert("刪除失敗: " + e.message); }
            });
        }

        // --- 3. Year Fields Logic (Snapshot Mode) ---
        function renderYearFields() {
            const listEl = document.getElementById('year-field-list');
            listEl.innerHTML = '';
            
            if(!yearTemplateData.fields || yearTemplateData.fields.length === 0) {
                listEl.innerHTML = '<div class="p-8 text-center text-slate-400">尚未加入欄位</div>';
                return;
            }

            yearTemplateData.fields.forEach((f, idx) => {
                // Here f is the FULL OBJECT, not just ID.
                const row = document.createElement('div');
                row.className = "grid grid-cols-12 p-3 items-center hover:bg-slate-50 border-b border-slate-100 bg-white group";
                row.innerHTML = `
                    <div class="col-span-1 text-center font-mono text-xs text-slate-400">${idx+1}</div>
                    <div class="col-span-5 font-bold text-slate-700 text-sm">${f.label}</div>
                    <div class="col-span-2 text-xs text-slate-500">${f.type}</div>
                    <div class="col-span-2 text-xs font-mono text-slate-400">${f.id}</div>
                    <div class="col-span-2 text-right flex justify-end gap-1">
                        <button onclick="moveField(${idx}, -1, 'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition" title="上移"><i class="fas fa-arrow-up"></i></button>
                        <button onclick="moveField(${idx}, 1, 'year')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition" title="下移"><i class="fas fa-arrow-down"></i></button>
                        <button onclick="openMoveModal(${idx}, 'year')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 hover:text-indigo-600 transition mr-2" title="指定移動"><i class="fas fa-exchange-alt"></i></button>
                        <button onclick="removeYearField(${idx})" class="text-slate-300 hover:text-red-500 p-1.5 transition"><i class="fas fa-times"></i></button>
                    </div>
                `;
                listEl.appendChild(row);
            });
        }

        // --- Batch Add Fields (Logic Change: Copy Object) ---
        function openFieldPicker() {
            const list = document.getElementById('picker-list');
            list.innerHTML = '';
            document.getElementById('picker-select-all').checked = false;
            
            // Check existing IDs in current year module
            const activeIds = new Set(yearTemplateData.fields.map(f => f.id));
            
            // Source: Global Templates
            configData.globalFields.sort((a,b) => a.order - b.order);
            const available = configData.globalFields.filter(f => !activeIds.has(f.id));

            if(available.length === 0) {
                list.innerHTML = '<div class="p-4 text-center text-gray-400">已加入所有模板欄位</div>';
            } else {
                available.forEach(f => {
                    const item = document.createElement('label');
                    item.className = "flex items-center p-3 border border-slate-200 rounded-lg hover:border-indigo-500 cursor-pointer hover:bg-indigo-50 transition mb-2";
                    item.innerHTML = `
                        <input type="checkbox" value="${f.id}" class="picker-checkbox w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 mr-3">
                        <div class="flex-grow flex justify-between">
                            <span class="font-bold text-sm text-slate-700">${f.label}</span>
                            <span class="text-xs text-slate-400 font-mono">${f.id}</span>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            document.getElementById('picker-modal').classList.remove('hidden');
        }

        function togglePickerAll(cb) {
            document.querySelectorAll('.picker-checkbox').forEach(el => el.checked = cb.checked);
        }

        function addSelectedFields() {
            const checkboxes = document.querySelectorAll('.picker-checkbox:checked');
            if (checkboxes.length === 0) {
                document.getElementById('picker-modal').classList.add('hidden');
                return;
            }

            const selectedIds = Array.from(checkboxes).map(cb => cb.value);
            
            // Sort by Template Order
            const orderMap = {};
            configData.globalFields.forEach(f => orderMap[f.id] = f.order);
            selectedIds.sort((a, b) => orderMap[a] - orderMap[b]);

            // CORE LOGIC CHANGE: Deep Copy from Template to Module
            selectedIds.forEach(id => {
                const template = configData.globalFields.find(gf => gf.id === id);
                if (template) {
                    // Deep copy to ensure independence
                    yearTemplateData.fields.push(JSON.parse(JSON.stringify(template)));
                }
            });

            renderYearFields();
            document.getElementById('picker-modal').classList.add('hidden');
        }

        function removeYearField(idx) {
            // Remove by Index
            yearTemplateData.fields.splice(idx, 1);
            renderYearFields();
        }

        function toggleDefaultYear() {
            const isChecked = document.getElementById('is-default-year').checked;
            configData.academicYears.forEach(y => y.isDefault = false);
            const curr = configData.academicYears.find(y => y.year === activeYearId);
            if(curr) curr.isDefault = isChecked;
            renderYearList();
            selectYear(activeYearId);
        }

        // --- 4. Global Fields Logic ---
        function renderGlobalList() {
            const el = document.getElementById('global-field-list');
            configData.globalFields.sort((a,b) => a.order - b.order);
            el.innerHTML = configData.globalFields.map((f, i) => `
                <div class="grid grid-cols-12 p-3 items-center hover:bg-slate-50 border-b border-slate-100 last:border-0 group">
                    <div class="col-span-1 text-center font-mono text-xs text-slate-400">${i+1}</div>
                    <div class="col-span-4"><div class="font-bold text-slate-700 text-sm">${f.label}</div><div class="text-[10px] text-slate-400 font-mono">${f.id}</div></div>
                    <div class="col-span-2 text-xs text-indigo-500 font-mono">${f.type}</div>
                    <div class="col-span-3 text-xs flex gap-1">${f.required?'<span class="text-red-500 bg-red-50 px-1 rounded">必填</span>':''}</div>
                    <div class="col-span-2 text-right flex justify-end gap-1">
                        <button onclick="moveField(${i}, -1, 'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition" title="上移"><i class="fas fa-arrow-up"></i></button>
                        <button onclick="moveField(${i}, 1, 'global')" class="p-1.5 hover:bg-slate-200 rounded text-slate-400 hover:text-slate-600 transition" title="下移"><i class="fas fa-arrow-down"></i></button>
                        <button onclick="openMoveModal(${i}, 'global')" class="p-1.5 hover:bg-indigo-100 rounded text-slate-400 hover:text-indigo-600 transition mr-2" title="指定移動"><i class="fas fa-exchange-alt"></i></button>
                        <button onclick="editGlobalField('${f.id}')" class="px-2 py-1 bg-white border text-slate-500 rounded text-xs hover:text-indigo-600">編輯</button>
                        <button onclick="delGlobalField('${f.id}')" class="px-2 py-1 bg-white border text-slate-500 rounded text-xs hover:text-red-600 ml-1">刪除</button>
                    </div>
                </div>
            `).join('');
        }

        function addNewGlobalField() {
            isEditMode = false;
            document.getElementById('ed-orig-id').value = '';
            document.getElementById('ed-field-id').value = ''; document.getElementById('ed-label').value = '';
            document.getElementById('ed-type').value = 'text';
            document.getElementById('editor-modal').dataset.curr = '{}';
            renderOpts();
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function editGlobalField(id) {
            isEditMode = true;
            const f = configData.globalFields.find(c => c.id === id);
            document.getElementById('ed-orig-id').value = f.id;
            document.getElementById('ed-field-id').value = f.id; 
            document.getElementById('ed-label').value = f.label;
            document.getElementById('ed-type').value = f.type;
            document.getElementById('ed-required').checked = f.required || false;
            document.getElementById('ed-system').checked = f.isSystem || false;
            document.getElementById('editor-modal').dataset.curr = JSON.stringify(f);
            renderOpts();
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        function saveGlobalField() {
            const newId = document.getElementById('ed-field-id').value.trim();
            const label = document.getElementById('ed-label').value.trim();
            const type = document.getElementById('ed-type').value;
            const origId = document.getElementById('ed-orig-id').value;

            if(!newId || !label) { alert("請輸入完整資訊"); return; }
            if(!/^[a-zA-Z0-9_]+$/.test(newId)) { alert("ID 格式錯誤"); return; }
            
            const exists = configData.globalFields.some(c => c.id === newId);
            if ((!isEditMode && exists) || (isEditMode && newId !== origId && exists)) { alert("ID 已存在"); return; }

            let f = isEditMode ? configData.globalFields.find(c => c.id === origId) : {};
            f.id = newId; f.label = label; f.type = type;
            f.required = document.getElementById('ed-required').checked;
            f.isSystem = document.getElementById('ed-system').checked;
            
            if(type === 'single_select') {
                f.options = document.getElementById('ed-opt-list').value.split(',').map(x=>x.trim()).filter(x=>x);
                const d=document.getElementById('ed-dep').value, v=document.getElementById('ed-val').value, l=document.getElementById('ed-lim').value;
                if(d&&v&&l) f.filterRule = {dep:d, val:v, limitTo:l.split(',').map(x=>x.trim())}; else delete f.filterRule;
            }
            if(type === 'number') { f.calcMode = document.getElementById('ed-mode').value; f.decimal = parseInt(document.getElementById('ed-dec').value)||0; f.keepZero = document.getElementById('ed-keepZero').checked; }
            if(type === 'date') f.dateFormat = document.getElementById('ed-fmt').value;

            if(!isEditMode) { f.order = configData.globalFields.length + 1; configData.globalFields.push(f); }
            
            document.getElementById('editor-modal').classList.add('hidden');
            renderGlobalList();
        }

        function delGlobalField(id) {
            showConfirm('刪除模板？', '確定刪除此模板？這不會影響已建立的學年度模組。', () => {
                configData.globalFields = configData.globalFields.filter(f => f.id !== id);
                renderGlobalList();
            });
        }

        // --- Shared Moving Logic ---
        function moveField(idx, dir, type) {
            let list = type === 'global' ? configData.globalFields : yearTemplateData.fields;
            if(idx+dir < 0 || idx+dir >= list.length) return;
            
            [list[idx], list[idx+dir]] = [list[idx+dir], list[idx]];
            
            if (type === 'global') {
                list.forEach((f, i) => f.order = i+1);
                renderGlobalList();
            } else {
                renderYearFields();
            }
        }

        function openMoveModal(idx, type) {
            moveSrcIndex = idx;
            moveType = type;
            const select = document.getElementById('move-select');
            select.innerHTML = '';
            
            let list = [];
            let targetLabel = '';

            if (type === 'global') {
                configData.globalFields.sort((a,b) => a.order - b.order);
                list = configData.globalFields;
                targetLabel = list[idx].label;
            } else {
                list = yearTemplateData.fields; // These are objects now
                targetLabel = list[idx].label;
            }

            document.getElementById('move-target-name').innerText = targetLabel;

            list.forEach((item, i) => {
                const option = document.createElement('option');
                option.value = i;
                let label = `${i + 1}. ${item.label}`;
                if (i === idx) {
                    label += " (目前位置)";
                    option.selected = true;
                }
                option.text = label;
                select.appendChild(option);
            });
            
            const modal = document.getElementById('move-modal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('scale-95');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        }

        function saveMove() {
            const targetIdx = parseInt(document.getElementById('move-select').value);
            if (targetIdx !== moveSrcIndex) {
                if (moveType === 'global') {
                    const item = configData.globalFields.splice(moveSrcIndex, 1)[0];
                    configData.globalFields.splice(targetIdx, 0, item);
                    configData.globalFields.forEach((f, i) => f.order = i + 1);
                    renderGlobalList();
                } else {
                    const item = yearTemplateData.fields.splice(moveSrcIndex, 1)[0];
                    yearTemplateData.fields.splice(targetIdx, 0, item);
                    renderYearFields();
                }
            }
            closeMoveModal();
        }

        function closeMoveModal() {
            const modal = document.getElementById('move-modal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // --- Helpers ---
        function renderOpts() {
            const type = document.getElementById('ed-type').value;
            const container = document.getElementById('ed-opts');
            const f = JSON.parse(document.getElementById('editor-modal').dataset.curr || '{}');
            let html = '';
            if(type === 'single_select') {
                html = `<div><label class="text-xs font-bold text-slate-500 uppercase">選項</label><textarea id="ed-opt-list" class="w-full border border-slate-300 rounded p-2 text-sm mt-1" rows="3">${f.options?.join(',')||''}</textarea></div>
                        <div class="mt-2 pt-2 border-t"><label class="text-xs text-indigo-500 font-bold">連動</label><div class="grid grid-cols-2 gap-2 mt-1"><input id="ed-dep" placeholder="依賴ID" class="w-full border p-2 rounded text-xs" value="${f.filterRule?.dep||''}"><input id="ed-val" placeholder="值" class="w-full border p-2 rounded text-xs" value="${f.filterRule?.val||''}"></div><input id="ed-lim" placeholder="限制選項" class="w-full border p-2 rounded text-xs mt-1" value="${f.filterRule?.limitTo?.join(',')||''}"></div>`;
            } else if(type === 'number') {
                html = `<div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold text-slate-500">模式</label><select id="ed-mode" class="w-full border rounded p-2 bg-white text-sm"><option value="copy">複製</option><option value="average" ${f.calcMode==='average'?'selected':''}>平均</option></select></div><div><label class="text-xs font-bold text-slate-500">小數</label><input type="number" id="ed-dec" class="w-full border rounded p-2 text-sm" value="${f.decimal||0}"></div></div><div class="mt-2"><label class="flex items-center text-sm"><input type="checkbox" id="ed-keepZero" ${f.keepZero?'checked':''} class="mr-2"> 保留0</label></div>`;
            } else if(type === 'date') {
                html = `<div><label class="text-xs font-bold text-slate-500">格式</label><select id="ed-fmt" class="w-full border rounded p-2 bg-white text-sm"><option value="ROC" ${f.dateFormat==='ROC'?'selected':''}>民國</option><option value="West" ${f.dateFormat==='West'?'selected':''}>西元</option></select></div>`;
            }
            container.innerHTML = html || '<div class="text-center text-xs text-slate-400">無額外設定</div>';
        }

        function showConfirm(title, desc, callback) {
            document.getElementById('confirm-title').innerText = title;
            document.getElementById('confirm-desc').innerText = desc;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-btn-action').onclick = () => {
                callback(); closeConfirm();
            };
        }
        function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden'); }

        async function saveAll() {
            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.innerHTML = '<div class="spinner w-4 h-4 border-2 border-white/30 border-t-white mr-2"></div> 儲存中...';
            try {
                await uploadFile(ghConfig.path, configData);
                if(activeYearId) {
                    const path = `year_templates/year_${activeYearId}_templates.json`;
                    await uploadFile(path, yearTemplateData);
                }
                showStatus('儲存成功');
            } catch(e) { alert("儲存失敗: " + e.message); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> 儲存設定'; }
        }

        function showStatus(msg) {
            const s = document.getElementById('status-msg');
            s.innerHTML = `<i class="fas fa-check-circle mr-1"></i> ${msg}`;
            s.classList.remove('hidden');
            setTimeout(() => s.classList.add('hidden'), 2000);
        }

        // --- GitHub Utils ---
        async function apiFetch(path) {
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`;
            const res = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' } });
            if(res.status === 404) return { status: 404 };
            if(!res.ok) throw new Error(res.statusText);
            const data = await res.json();
            const content = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
            return { status: 200, data: JSON.parse(content), sha: data.sha };
        }

        async function uploadFile(path, contentObj) {
            let sha = null;
            try { const check = await apiFetch(path); if(check.status===200) sha = check.sha; } catch(e){}
            const contentBase64 = window.btoa(unescape(encodeURIComponent(JSON.stringify(contentObj, null, 2))));
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`;
            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Update config", content: contentBase64, sha: sha })
            });
            if(!res.ok) throw new Error("Upload failed");
        }

        async function deleteFile(path) {
            let sha = null;
            try { const check = await apiFetch(path); if(check.status===200) sha = check.sha; } catch(e){}
            if(!sha) return; 
            const url = `https://api.github.com/repos/${ghConfig.user}/${ghConfig.repo}/contents/${path}`;
            await fetch(url, {
                method: 'DELETE',
                headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: "Delete file", sha: sha })
            });
        }

        function switchView(view) {
            document.getElementById('view-years').classList.toggle('hidden', view !== 'years');
            document.getElementById('view-fields').classList.toggle('hidden', view !== 'fields');
            document.getElementById('view-fields').classList.toggle('flex', view === 'fields');
            document.getElementById('tab-years').className = view === 'years' ? "px-4 py-1.5 rounded-md shadow-sm bg-white text-indigo-600 font-bold" : "px-4 py-1.5 rounded-md text-slate-500 hover:text-slate-700";
            document.getElementById('tab-fields').className = view === 'fields' ? "px-4 py-1.5 rounded-md shadow-sm bg-white text-indigo-600 font-bold" : "px-4 py-1.5 rounded-md text-slate-500 hover:text-slate-700";
            if(view === 'fields') renderGlobalList();
        }

        window.onload = init;
    </script>
</body>
</html>
