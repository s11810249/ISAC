<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東海大學學生校外實習校庫填報輔助系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#002E5D', secondary: '#C6A87C', success: '#219653', danger: '#DC2626', surface: '#ffffff', background: '#F8FAFC',
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        :root {
            --base-size: 16px; 
        }
        
        html { font-size: var(--base-size); }
        body { font-size: 1rem; } 
        
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; } 
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .input-stylish { width: 100%; border: 1px solid #e2e8f0; border-radius: 0.375rem; padding: 0.4rem 0.75rem; font-size: 1em; transition: all 0.2s; background-color: #fff; line-height: 1.5; min-height: 2.5em; }
        .input-stylish:focus { border-color: #002E5D; outline: none; box-shadow: 0 0 0 3px rgba(0, 46, 93, 0.1); }
        .input-stylish:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; border-color: #e2e8f0; }
        
        textarea.input-stylish { height: auto; min-height: 2.5em; padding-top: 0.4rem; padding-bottom: 0.4rem; }

        /* Sidebar Transition */
        aside { transition: width 0.3s ease; position: relative; }
        aside.collapsed { width: 0 !important; overflow: hidden; }
        
        /* New Full-Height Sidebar Toggle */
        #sidebar-toggle-strip {
            position: absolute;
            left: 20rem; /* Matches sidebar width */
            top: 0;
            bottom: 0;
            width: 12px;
            background: #f1f5f9;
            border-right: 1px solid #e2e8f0;
            border-left: 1px solid #fff;
            cursor: pointer;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: left 0.3s ease, background-color 0.2s;
        }
        #sidebar-toggle-strip:hover { background-color: #e2e8f0; }
        #sidebar-toggle-strip i { font-size: 10px; color: #94a3b8; transition: transform 0.3s; }
        
        /* When collapsed */
        aside.collapsed + #sidebar-toggle-strip { left: 0; border-left: none; }
        aside.collapsed + #sidebar-toggle-strip i { transform: rotate(180deg); }

        /* Left Sidebar Items */
        .student-item { cursor: pointer; border-left: 3px solid transparent; transition: all 0.2s; }
        .student-item:hover { background-color: #f8fafc; }
        .student-item.active { background-color: #eff6ff; border-left-color: #002E5D; }
        .student-item.active .student-name { color: #002E5D; font-weight: bold; }

        /* Import Button (Admin Style) */
        .import-btn { border: 2px dashed #bbf7d0; color: #219653; background-color: #f0fdf4; transition: all 0.2s; border-radius: 0.75rem; text-align: center; padding: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9em; width: 100%; }
        .import-btn:hover { border-color: #219653; background-color: #dcfce7; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* Course Card in Settings Tab */
        .course-card { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 0.75rem; 
            transition: all 0.2s; position: relative; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .course-card:hover { border-color: #002E5D; background-color: #f0f9ff; }
        .course-card.selected { border-color: #002E5D; background-color: #eff6ff; }

        .field-group { transition: all 0.3s ease; margin-bottom: 0.5rem; }
        /* 鎖定時的視覺樣式 */
        .field-locked label { color: #94a3b8; }
        .field-locked .input-stylish { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; }
        .field-locked select.date-select { background-color: #f8fafc; color: #cbd5e1; border-color: #f1f5f9; pointer-events: none; }
        .field-locked .date-toggle-btn { display: none; }
        
        .spinner { border: 3px solid rgba(0,46,93,0.1); border-radius: 50%; border-top: 3px solid #002E5D; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Tab System */
        .tab-btn { 
            padding: 0.75rem 1.5rem; font-size: 1em; font-weight: 600; color: #64748b; 
            border-bottom: 3px solid transparent; transition: all 0.2s; cursor: pointer; 
            display: flex; align-items: center; gap: 0.5rem; white-space: nowrap;
        }
        .tab-btn:hover { color: #002E5D; background-color: #f8fafc; }
        .tab-btn.active { color: #002E5D; border-bottom-color: #002E5D; background-color: #fff; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Excel Preview Table */
        .excel-table { border-collapse: separate; border-spacing: 0; width: 100%; font-size: 0.9em; }
        .excel-table th, .excel-table td { border-right: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9; padding: 0; box-sizing: border-box; }
        
        .excel-table th { 
            background-color: #f8fafc; color: #475569; font-weight: bold; text-align: center; 
            padding: 8px 10px; font-size: 0.95em; position: sticky; top: 0; z-index: 40;
            border-bottom: 2px solid #94a3b8;
        }

        .excel-table td { height: 40px; position: relative; vertical-align: middle; }

        /* Form Section Title */
        .form-section-title {
            font-size: 1.1em; font-weight: 700; color: #002E5D; margin-top: 1.5rem; margin-bottom: 1rem;
            padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.5rem;
        }
        .form-section-title:first-child { margin-top: 0; }
        .form-section-title::before { content: ''; display: block; width: 4px; height: 1.2em; background-color: #C6A87C; border-radius: 2px; }

        /* Tooltip Style */
        .tooltip-container { position: relative; display: inline-block; margin-left: 0.5rem; }
        .tooltip-icon { color: #94a3b8; cursor: help; transition: color 0.2s; }
        .tooltip-icon:hover { color: #002E5D; }
        .tooltip-text { 
            visibility: hidden; width: 200px; background-color: #334155; color: #fff; text-align: left; 
            border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; 
            margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.85em; font-weight: normal; line-height: 1.4;
            pointer-events: none; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tooltip-text::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #334155 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

        /* Modal Overlay */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }

        /* Custom ROC Date Picker Styles */
        .date-picker-wrapper { position: relative; width: 100%; height: 100%;}
        .date-input-group { position: relative; display: flex; align-items: center; width: 100%; height: 100%; }
        .date-picker-trigger {
            position: absolute; right: 8px; color: #64748b; cursor: pointer; padding: 4px;
            border-radius: 4px; transition: color 0.2s;
        }
        .date-picker-trigger:hover { color: #002E5D; background-color: #f1f5f9; }
        
        .calendar-popover {
            position: absolute; top: 100%; left: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e2e8f0; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 280px; z-index: 50; display: none; padding: 12px; font-size: 0.9em;
        }
        .calendar-popover.active { display: block; animation: fadeIn 0.1s ease-out; }
        
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cal-btn { padding: 4px 8px; border-radius: 4px; hover: bg-slate-100; cursor: pointer; color: #64748b; }
        .cal-btn:hover { background-color: #f1f5f9; color: #002E5D; }
        .cal-title { font-weight: bold; color: #334155; cursor: pointer; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .cal-day-header { font-size: 0.75em; color: #94a3b8; padding: 4px 0; }
        .cal-day { padding: 6px 0; cursor: pointer; border-radius: 4px; color: #334155; }
        .cal-day:hover:not(.empty) { background-color: #f1f5f9; color: #002E5D; }
        .cal-day.selected { background-color: #002E5D; color: #fff; }
        .cal-day.empty { pointer-events: none; }
        .cal-day.today { border: 1px solid #002E5D; font-weight: bold; }

        /* Filter Styles */
        .filter-select { font-size: 0.85em; padding: 0.25rem 0.5rem; border-radius: 0.25rem; border: 1px solid #e2e8f0; background-color: #fff; width: 100%; }
        
        /* Confirmation Modal */
        .confirm-modal-content { 
            background: white; padding: 2rem; border-radius: 1rem; width: 90%; max-width: 400px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            text-align: center;
        }

        /* Grid Input Styles - reused from global grid but for local student grid */
        .grid-input { 
            width: 100%; height: 100%; min-height: 34px;
            border: none; background: transparent; padding: 4px 8px; 
            font-size: 14px; line-height: 1.25; color: #334155;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box; vertical-align: top; display: block;        
        }
        
        textarea.grid-input {
            white-space: pre-wrap; word-break: break-all; overflow: hidden; resize: none; padding-top: 6px;
        }
        
        select.grid-input { 
            appearance: none; -webkit-appearance: none; width: 100%; height: 100%; border: none;
            background-color: transparent; cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat; background-size: 16px; background-position: right 8px center; 
            padding-right: 30px !important; padding-left: 8px;
            text-align: center; text-align-last: center; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            font-size: 14px; color: #334155;
        }
        select.grid-input:-moz-focusring { color: transparent; text-shadow: 0 0 0 #000; }

        .grid-input:disabled { color: #cbd5e1; cursor: not-allowed; background-color: transparent !important; }
        .grid-input:focus { outline: none; box-shadow: inset 0 0 0 2px #002E5D; background-color: #ffffff; z-index: 10; }

        .cell-read-only {
            width: 100%; height: 100%; min-height: 34px; display: flex; align-items: center; justify-content: center; 
            padding: 4px 8px; color: #64748b; white-space: nowrap; text-align: center; line-height: 1.25;
        }

        /* Sticky Columns for Student Grid */
        th.sticky-col { position: sticky; left: 0; background-color: #f8fafc !important; z-index: 50 !important; border-bottom: 2px solid #94a3b8 !important; }
        td.sticky-col { position: sticky; left: 0; background-color: #fff !important; z-index: 30 !important; }
        .sticky-border-right { border-right: 2px solid #94a3b8 !important; box-shadow: 4px 0 6px -3px rgba(0,0,0,0.1); clip-path: inset(0 -15px 0 0); }

        /* Row Colors */
        tr.row-group-normal { background-color: #ffffff; }
        tr.row-group-alt { background-color: #f8fafc; }
        tr.row-group-normal:hover, tr.row-group-alt:hover { background-color: #eff6ff !important; }
        tr.row-group-normal:hover td, tr.row-group-alt:hover td { background-color: #eff6ff !important; }

        /* View Toggle Buttons */
        .view-toggle-btn { @apply px-3 py-1.5 rounded-md text-xs font-bold transition; }
        .view-toggle-btn.active { @apply bg-white text-primary shadow-sm; }
        .view-toggle-btn.inactive { @apply text-slate-500 hover:text-slate-700; }

    </style> 
</head>
<body class="h-screen flex flex-col bg-background text-slate-700 overflow-hidden">

    <header class="h-16 bg-white border-b border-slate-200 flex items-center px-6 shadow-sm z-30 flex-shrink-0 justify-between">
        <div class="flex items-center gap-4">
            <div class="bg-primary p-1.5 rounded-lg shadow-sm">
                <img src="files/svg/THU-Logo.svg" class="h-8 w-auto" alt="Logo">
            </div>
            <div>
                <h1 class="font-bold text-lg text-primary tracking-wide">東海大學學生校外實習校庫填報輔助系統</h1>
                <p class="text-[10px] text-slate-400">Department Data Entry System</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            
            <div class="relative group mr-2">
                <button class="flex items-center gap-2 text-slate-600 hover:text-primary font-bold text-sm px-3 py-2 rounded-lg hover:bg-slate-100 transition">
                    <i class="fas fa-toolbox"></i> 輔助工具 <i class="fas fa-chevron-down text-[10px] opacity-50"></i>
                </button>
                
                <div class="absolute right-0 top-full mt-1 w-56 bg-white border border-slate-200 rounded-xl shadow-xl hidden group-hover:block z-50 p-1">
                    <div class="text-[10px] font-bold text-slate-400 px-3 py-2 uppercase tracking-wider">批次處理</div>
                    
                    <button onclick="toolAutoFill()" class="w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary rounded-lg transition flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center"><i class="fas fa-magic"></i></div>
                        <span>智慧填入預設值</span>
                    </button>
                    
                    <button onclick="toolCheckData()" class="w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary rounded-lg transition flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center"><i class="fas fa-check-double"></i></div>
                        <span>資料完整性檢查</span>
                    </button>

                    <div class="border-t border-slate-100 my-1"></div>
                    
                    <div class="text-[10px] font-bold text-slate-400 px-3 py-2 uppercase tracking-wider">分析</div>
                    <button onclick="toolStats()" class="w-full text-left px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-primary rounded-lg transition flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center"><i class="fas fa-chart-pie"></i></div>
                        <span>目前填報統計</span>
                    </button>
                </div>
            </div>
            <div class="h-6 w-px bg-slate-200 mx-1"></div>
            <button onclick="exportData()" class="bg-success text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700 transition shadow-sm flex items-center gap-2">
                <i class="fas fa-file-export"></i> 匯出結果
            </button>
            <button onclick="document.getElementById('info-modal').classList.remove('hidden')" class="ml-3 text-slate-400 hover:text-primary transition" title="系統與隱私聲明">
                <i class="fas fa-info-circle text-xl"></i>
            </button>
        </div>
    </header>

    <div class="flex-grow flex overflow-hidden relative">
        
        <aside id="sidebar" class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm flex-shrink-0 relative">
            <div class="p-4 pb-0 bg-slate-50">
                <label class="import-btn shadow-sm text-success border-green-200 bg-green-50 hover:bg-green-100 hover:border-success hover:text-success">
                    <i class="fas fa-file-import text-lg"></i> 匯入學生名單 (Excel)
                    <input type="file" id="file-upload" class="hidden" accept=".xlsx, .csv" onchange="handleFileUpload(event)">
                </label>
            </div>

            <div class="p-4 border-b border-slate-100 bg-slate-50 space-y-3">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="search-input" oninput="filterStudentList()" placeholder="搜尋姓名或學號..." class="w-full pl-9 pr-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <select id="filter-course-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部開課系</option>
                    </select>
                    <select id="filter-student-dept" onchange="filterStudentList()" class="filter-select">
                        <option value="">全部學生系</option>
                    </select>
                    <select id="filter-status" onchange="filterStudentList()" class="filter-select col-span-2">
                        <option value="">全部填報進度</option>
                        <option value="pending">未開始</option>
                        <option value="completed">已填報</option>
                    </select>
                </div>

                <div class="flex justify-between items-center text-xs text-slate-500">
                    <div>總計: <span id="student-count" class="font-bold text-slate-700">0</span> 人</div>
                    <div class="flex gap-1">
                        <button onclick="toggleSort('id')" class="hover:text-primary p-1 rounded transition" title="依學號排序" id="sort-id-btn">
                            <i class="fas fa-sort-numeric-down"></i>
                        </button>
                        <button onclick="toggleSort('name')" class="hover:text-primary p-1 rounded transition" title="依姓名排序" id="sort-name-btn">
                            <i class="fas fa-sort-alpha-down"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="student-list" class="flex-grow overflow-y-auto custom-scroll p-2 space-y-1">
                <div class="p-8 text-center text-slate-400 text-sm">
                    <i class="fas fa-arrow-up mb-2 text-xl block"></i>
                    請先從上方匯入 Excel 名單
                </div>
            </div>
        </aside>

        <div id="sidebar-toggle-strip" onclick="toggleSidebar()" title="收合/展開側邊欄">
            <i class="fas fa-chevron-left text-slate-400"></i>
        </div>

        <main class="flex-grow bg-slate-50 overflow-hidden relative flex flex-col" id="main-content">
            
            <div id="form-empty-state" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-50 text-slate-400">
                <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mb-4 text-3xl shadow-sm border border-slate-100">
                    <i class="fas fa-user-edit text-slate-300"></i>
                </div>
                <p>請從左側選擇一位學生開始填報</p>
            </div>

            <div id="form-container" class="hidden flex flex-col h-full w-full">
                
                <div class="bg-white px-6 py-4 border-b border-slate-200 shadow-sm flex-shrink-0 flex justify-between items-center z-20">
                    <div class="flex gap-4 items-center">
                        <div class="w-12 h-12 rounded-full bg-primary/10 text-primary flex items-center justify-center text-xl font-bold">
                            <span id="header-avatar">?</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <span id="header-name">學生姓名</span>
                                <span id="header-id" class="text-sm font-mono text-slate-500 bg-slate-100 px-2 py-0.5 rounded">ID</span>
                            </h2>
                            <p class="text-sm text-slate-500 flex gap-3 mt-0.5">
                                <span id="header-dept"><i class="fas fa-graduation-cap mr-1"></i>系所</span>
                            </p>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <button onclick="setStudentView('form')" id="btn-std-form" class="view-toggle-btn active">
                                <i class="fas fa-list-alt mr-1"></i> 表單模式
                            </button>
                            <button onclick="setStudentView('grid')" id="btn-std-grid" class="view-toggle-btn inactive">
                                <i class="fas fa-table mr-1"></i> 總表模式
                            </button>
                        </div>

                        <span id="header-status" class="inline-block px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500">未填報</span>
                    </div>
                </div>

                <div id="view-form" class="flex flex-col flex-grow overflow-hidden">
                    <div class="bg-white border-b border-slate-200 px-6 flex gap-2 z-10 overflow-x-auto custom-scroll flex-shrink-0" id="tabs-container">
                        <button class="tab-btn active" data-tab="settings" onclick="switchTab('settings')"><i class="fas fa-cog"></i> 歸戶設定</button>
                    </div>

                    <div class="flex-grow overflow-y-auto custom-scroll p-6 pb-24 relative">
                        
                        <div id="tab-settings" class="tab-content active max-w-7xl mx-auto">
                            <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-6">
                                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex justify-between items-center">
                                    <div>
                                        <h3 class="font-bold text-indigo-800 text-lg flex items-center gap-2"><i class="fas fa-layer-group"></i> 實習歸戶設定</h3>
                                        <p class="text-xs text-indigo-600 mt-1">請勾選同一實習機構的課程，合併建立為一份填報單。</p>
                                    </div>
                                    <button onclick="createApplication()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition flex items-center gap-2">
                                        <i class="fas fa-plus"></i> 建立實習填報單
                                    </button>
                                </div>
                                
                                <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2 pb-2 border-b border-slate-200">
                                            <span class="w-2 h-2 rounded-full bg-slate-400"></span> 尚未歸戶的課程 (請勾選)
                                        </h4>
                                        <div id="settings-course-list" class="space-y-2"></div>
                                    </div>
                                    
                                    <div class="bg-indigo-50/50 p-4 rounded-lg border border-indigo-100">
                                        <h4 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2 pb-2 border-b border-indigo-200">
                                            <span class="w-2 h-2 rounded-full bg-success"></span> 已建立的填報單
                                        </h4>
                                        <div id="app-management-list" class="space-y-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="dynamic-tabs-area"></div>
                    </div>
                </div>

                <div id="view-grid" class="hidden flex-col flex-grow overflow-hidden bg-white">
                    <div class="px-6 py-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 class="font-bold text-slate-700 text-sm"><i class="fas fa-th text-primary"></i> 個人總表編輯</h2>
                            <div class="flex items-center gap-2 text-xs text-slate-500 bg-white border border-slate-200 rounded px-2 py-1">
                                <span>已勾選: <span id="std-grid-count" class="font-bold text-primary">0</span></span>
                                <button onclick="executeStudentGridMerge()" id="btn-std-grid-merge" disabled class="ml-2 px-2 py-0.5 rounded bg-slate-100 text-slate-400 font-bold disabled:cursor-not-allowed enabled:bg-primary enabled:text-white enabled:hover:bg-indigo-700 transition">
                                    合併為實習歸戶
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-slate-400">
                            <i class="fas fa-info-circle"></i> 修改後將自動儲存
                        </div>
                    </div>

                    <div class="flex-grow overflow-auto custom-scroll relative pb-24">
                        <table class="excel-table w-full relative">
                            <thead class="sticky top-0 z-20 bg-slate-100 shadow-sm" id="std-grid-thead"></thead>
                            <tbody id="std-grid-tbody"></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="preview-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-7xl rounded-2xl shadow-2xl overflow-hidden flex flex-col transform scale-95 transition-transform duration-300 h-[85vh]">
            
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 flex-shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fas fa-table text-primary"></i> 學生資料預覽</h3>
                    <p class="text-xs text-slate-500 mt-1">包含所有課程（已歸戶與未歸戶）的完整資料</p>
                </div>
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600 w-8 h-8 rounded-full hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-times"></i></button>
            </div>

            <div class="px-6 py-2 bg-slate-100 border-b border-slate-200 flex flex-wrap gap-2 text-xs" id="preview-column-toggles">
                </div>

            <div class="flex-grow overflow-auto custom-scroll p-0 relative">
                <table class="excel-table w-full relative">
                    <thead class="sticky top-0 z-10"><tr id="modal-preview-head"></tr></thead>
                    <tbody id="modal-preview-body"></tbody>
                </table>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50/50 flex justify-end gap-3 flex-shrink-0">
                <button onclick="document.getElementById('preview-modal').classList.add('hidden')" class="px-5 py-2 btn-manage rounded-lg font-bold text-sm bg-slate-800 text-white shadow hover:bg-slate-900">關閉</button>
            </div>
        </div>
    </div>
    
    <div id="confirm-modal" class="fixed inset-0 z-[140] hidden flex items-center justify-center modal-overlay p-4">
        <div class="confirm-modal-content">
            <div class="mb-4 text-red-500">
                <i class="fas fa-exclamation-triangle text-4xl"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2" id="confirm-title">確認刪除？</h3>
            <p class="text-sm text-slate-600 mb-6" id="confirm-message">此操作無法復原。</p>
            <div class="flex justify-center gap-3">
                <button id="confirm-cancel-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-slate-500 bg-slate-100 hover:bg-slate-200 transition">取消</button>
                <button id="confirm-ok-btn" class="px-5 py-2 rounded-lg font-bold text-sm text-white bg-red-600 hover:bg-red-700 shadow transition">確認</button>
            </div>
        </div>
    </div>
    
    <div id="merge-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 rounded-t-xl flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <i class="fas fa-random text-primary"></i> 暫存資料歸戶確認
                    </h3>
                    <p class="text-xs text-slate-500 mt-1">系統偵測到未歸戶的資料，請選擇如何處理：</p>
                </div>
                <button onclick="closeMergeModal()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-grow overflow-y-auto custom-scroll p-6 bg-slate-50/50">
                <div id="merge-list-container" class="space-y-4"></div>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-white rounded-b-xl flex justify-between items-center">
                <button onclick="discardAndSwitch()" class="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold transition">
                    <i class="fas fa-trash-alt mr-1"></i> 放棄資料並切換
                </button>
                <div class="flex gap-3">
                    <button onclick="closeMergeModal()" class="px-5 py-2 rounded-lg font-bold text-sm text-slate-500 bg-slate-100 hover:bg-slate-200">
                        回到表格修改
                    </button>
                    <button onclick="processMergeAndSwitch()" class="px-5 py-2 rounded-lg font-bold text-sm text-white bg-primary hover:opacity-90 shadow-lg">
                        確認歸戶並切換 <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-5 right-5 z-[200] flex flex-col gap-3 pointer-events-none transition-all duration-300">
        </div>
    
    <div id="info-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden flex flex-col">
            <div class="px-6 py-4 bg-primary text-white flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-shield-alt"></i> 系統使用與隱私聲明
                </h3>
                <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="text-white/80 hover:text-white transition"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4 text-sm text-slate-700">
                <div class="flex gap-3">
                    <div class="text-2xl text-blue-500"><i class="fas fa-laptop-code"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800">純前端運作</h4>
                        <p class="text-slate-500 mt-1">本系統所有運算皆在您的瀏覽器內完成，<span class="text-red-500 font-bold">不會</span>將任何學生個資上傳至外部伺服器或資料庫，請安心使用。</p>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <div class="text-2xl text-orange-500"><i class="fas fa-save"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800">資料暫存機制</h4>
                        <p class="text-slate-500 mt-1">資料僅暫存於記憶體中。若您<span class="font-bold">重新整理網頁</span>或<span class="font-bold">關閉瀏覽器</span>，所有未匯出的進度將會<span class="text-red-500 font-bold">永久遺失</span>。</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="text-2xl text-emerald-500"><i class="fas fa-file-excel"></i></div>
                    <div>
                        <h4 class="font-bold text-slate-800">資料保管責任</h4>
                        <p class="text-slate-500 mt-1">匯出的 Excel 檔案包含敏感個資，請妥善保管。若使用公用電腦，請務必在使用後刪除下載的檔案。</p>
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                <button onclick="document.getElementById('info-modal').classList.add('hidden')" class="bg-primary hover:bg-sky-900 text-white px-6 py-2 rounded-lg font-bold shadow transition">
                    我已了解，開始使用
                </button>
            </div>
        </div>
    </div>

    <footer class="bg-white border-t border-slate-200 py-3 px-6 text-center text-[10px] text-slate-400 flex-shrink-0 z-50 fixed bottom-0 w-full">
    <p class="font-bold">Copyright © <span id="copyright-year">2025</span> 東海大學實習與學生成就中心 Internship and Student Achievement Center, Tunghai University. All Rights Reserved.</p>
    <p class="mt-0.5 font-medium opacity-80">網頁製作：張博堯 | Assisted by Google Gemini</p>
    </footer>
    
    <div id="distribute-modal" class="fixed inset-0 z-[160] hidden flex items-center justify-center modal-overlay p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 border-b border-slate-100 bg-indigo-50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-indigo-800 flex items-center gap-2">
                    <i class="fas fa-calculator"></i> <span id="dist-modal-title">自動分配總時數</span>
                </h3>
                <button onclick="document.getElementById('distribute-modal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 text-blue-800 text-sm p-3 rounded-lg border border-blue-100 mb-4">
                    <i class="fas fa-info-circle mr-1"></i> 請輸入此歸戶的「總數」，系統將依據課程權重（如學分）自動換算並填入。
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1">請輸入總數 (Total)</label>
                    <div class="flex gap-2">
                        <input type="number" id="dist-total-input" class="input-stylish text-lg font-bold text-indigo-600" placeholder="例如: 500">
                        <div class="flex items-center text-sm text-slate-500 bg-slate-100 px-3 rounded border border-slate-200" id="dist-weight-info">
                            總權重: 0
                        </div>
                    </div>
                </div>

                <div class="border rounded-lg border-slate-200 overflow-hidden">
                    <div class="bg-slate-50 px-3 py-2 text-xs font-bold text-slate-500 border-b border-slate-200">分配預覽</div>
                    <div id="dist-preview-list" class="max-h-40 overflow-y-auto p-0 text-sm divide-y divide-slate-100">
                        </div>
                </div>
            </div>

            <div class="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">
                <button onclick="document.getElementById('distribute-modal').classList.add('hidden')" class="px-4 py-2 rounded-lg font-bold text-sm text-slate-500 hover:bg-slate-200 transition">取消</button>
                <button onclick="confirmDistribution()" class="px-6 py-2 rounded-lg font-bold text-sm text-white bg-indigo-600 hover:bg-indigo-700 shadow-lg transition">
                    確認套用
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global State ---
        let globalConfig = {};       
        let currentYearConfig = {};  
        let departmentData = [];     
        let deptMasterData = {};     
        
        let allRawData = [];         
        let groupedStudents = {};    
        let currentStudentId = null; 
        let activeYear = "";         
        let hasUnsavedChanges = false; 

        // Local Grid State
        let studentGridSelection = new Set();
        let currentViewMode = 'form'; // 'form' or 'grid'

        let changeLogs = []; 
        let sortConfig = { key: 'id', direction: 'asc' }; 

        const CORE_FIELDS = ['school_year', 'semester', 'student_id', 'student_name', 'student_dept', 'course_name', 'course_id'];

        // Custom Confirm Helper
        function showConfirm(title, message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirm-modal');
                const titleEl = document.getElementById('confirm-title');
                const msgEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel-btn');
                const okBtn = document.getElementById('confirm-ok-btn');

                titleEl.innerText = title;
                msgEl.innerText = message;
                modal.classList.remove('hidden');

                const close = (result) => {
                    modal.classList.add('hidden');
                    cancelBtn.onclick = null;
                    okBtn.onclick = null;
                    resolve(result);
                };

                cancelBtn.onclick = () => close(false);
                okBtn.onclick = () => close(true);
            });
        }
        
        // --- Helper: Get Text Width ---
        function getTextWidth(text, font = "bold 14px 'Noto Sans TC'") {
            const canvas = getTextWidth.canvas || (getTextWidth.canvas = document.createElement("canvas"));
            const context = canvas.getContext("2d");
            context.font = font;
            const metrics = context.measureText(text);
            return metrics.width;
        }

        // --- View Switching Logic ---
        function setStudentView(mode) {
            if (mode === currentViewMode) return;
            currentViewMode = mode;
            
            // UI Toggle
            document.getElementById('btn-std-form').className = mode === 'form' ? 'view-toggle-btn active' : 'view-toggle-btn inactive';
            document.getElementById('btn-std-grid').className = mode === 'grid' ? 'view-toggle-btn active' : 'view-toggle-btn inactive';
            
            // Container Toggle
            if (mode === 'form') {
                document.getElementById('view-form').classList.remove('hidden');
                document.getElementById('view-form').classList.add('flex');
                document.getElementById('view-grid').classList.add('hidden');
                document.getElementById('view-grid').classList.remove('flex');
                // Refresh tabs in case data changed
                if(currentStudentId) renderTabs(groupedStudents[currentStudentId]);
            } else {
                document.getElementById('view-form').classList.add('hidden');
                document.getElementById('view-form').classList.remove('flex');
                document.getElementById('view-grid').classList.remove('hidden');
                document.getElementById('view-grid').classList.add('flex');
                if(currentStudentId) renderStudentGrid();
            }
        }

        function renderStudentGrid() {
            const student = groupedStudents[currentStudentId];
            if (!student) return;

            const thead = document.getElementById('std-grid-thead');
            const tbody = document.getElementById('std-grid-tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const fields = currentYearConfig.fields || [];
            
            // Prepare Columns (Reuse logic but keep simpler)
            // Add checkbox column
            const allColumns = fields.filter(f => !['course_id', '_internal_id'].includes(f.id));
            const freezeLimit = 2; // Fixed freeze count for name/course info

            // 1. Render Header
            let trHead = document.createElement('tr');
            
            // Checkbox Header
            let thCheck = document.createElement('th');
            thCheck.className = "sticky-col text-center px-2 py-2";
            thCheck.style.width = "40px";
            thCheck.style.left = "0px";
            thCheck.innerHTML = `<input type="checkbox" onchange="toggleAllStudentGrid(this)" class="w-4 h-4 rounded text-primary focus:ring-primary cursor-pointer">`;
            trHead.appendChild(thCheck);

            let currentLeft = 40; // Start after checkbox

            allColumns.forEach((col, index) => {
                const th = document.createElement('th');
                th.className = "bg-slate-100 text-slate-600 px-2 py-2 text-sm font-bold whitespace-nowrap select-none border-r border-slate-200";
                
                // Estimate width
                let w = Math.max(getTextWidth(col.label) + 40, 100);
                if (col.excelWidth) w = col.excelWidth * 7; 
                th.style.minWidth = w + "px";
                th.style.maxWidth = w + "px";

                if (index < freezeLimit) {
                    th.classList.add('sticky-col');
                    th.style.left = currentLeft + "px";
                    currentLeft += w;
                    if(index === freezeLimit - 1) th.classList.add('sticky-border-right');
                }
                
                th.innerHTML = col.label;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);

            // 2. Render Body
            student.courses.forEach((course, idx) => {
                const appId = course._app_id;
                let appData = {};
                if(appId) {
                    const app = student.applications.find(a => a.id === appId);
                    if(app) appData = app.formData;
                }

                const tr = document.createElement('tr');
                tr.className = "row-group-normal transition border-b border-slate-100 group hover:bg-blue-50";
                tr.dataset.cid = course._internal_id;
                tr.dataset.sid = student.id;

                // Checkbox Cell
                const tdCheck = document.createElement('td');
                tdCheck.className = "sticky-col text-center border-r border-slate-200 bg-white";
                tdCheck.style.left = "0px";
                const isChecked = studentGridSelection.has(course._internal_id);
                tdCheck.innerHTML = `<input type="checkbox" class="std-grid-chk w-4 h-4 rounded text-primary focus:ring-primary cursor-pointer" value="${course._internal_id}" ${isChecked?'checked':''} onchange="updateStudentGridSelection(this)">`;
                tr.appendChild(tdCheck);

                currentLeft = 40;

                allColumns.forEach((f, cIdx) => {
                    const td = document.createElement('td');
                    td.className = "border-r border-slate-200 p-0 relative";
                    
                    let w = Math.max(getTextWidth(f.label) + 40, 100);
                    if (f.excelWidth) w = f.excelWidth * 7;
                    td.style.minWidth = w + "px";
                    td.style.maxWidth = w + "px";

                    if (cIdx < freezeLimit) {
                        td.classList.add('sticky-col');
                        td.style.left = currentLeft + "px";
                        currentLeft += w;
                        if(cIdx === freezeLimit - 1) td.classList.add('sticky-border-right');
                    }

                    // Value Logic
                    let val = "";
                    if (f.calcMode === 'average' || f.calcMode === 'weighted') {
                        val = course[f.id]; 
                    } else if (appId && appData[f.id] !== undefined) {
                        val = appData[f.id]; 
                    } else {
                        val = course[f.id];
                        if ((!val) && f.id === 'student_id') val = student.id;
                        if ((!val) && f.id === 'student_name') val = student.name;
                        if ((!val) && f.id === 'student_dept') val = student.dept;
                    }

                    const isReadOnly = f.isSystem || f.category === 'sys_student_info' || f.category === 'sys_course_info';
                    
                    if (isReadOnly) {
                        td.innerHTML = `<div class="cell-read-only bg-slate-50 text-slate-500">${val||''}</div>`;
                    } else {
                        let input;
                        if (f.type === 'single_select' || f.type === 'list') {
                            input = document.createElement('select');
                            input.innerHTML = `<option value=""></option>` + (f.options||[]).map(o => `<option value="${o}" ${o==val?'selected':''}>${o}</option>`).join('');
                            input.className = "grid-input";
                        } else {
                            input = document.createElement('input');
                            input.type = 'text';
                            input.className = "grid-input";
                            if (f.type === 'date') {
                                input.placeholder = f.inputFormat === 'ROC' ? "yyy/mm/dd" : "yyyy/mm/dd";
                                input.addEventListener('change', (e) => {
                                    let v = e.target.value.trim().replace(/[^\d]/g, '');
                                    if (f.inputFormat === 'ROC' && v.length >= 6) {
                                        if (v.length === 7) e.target.value = `${v.substring(0,3)}/${v.substring(3,5)}/${v.substring(5,7)}`;
                                        else if (v.length === 6) e.target.value = `${v.substring(0,2)}/${v.substring(2,4)}/${v.substring(4,6)}`;
                                    }
                                    handleGridChange(e.target, student, course, f);
                                });
                            }
                        }

                        // App Linked Indicator
                        if (appId && !['average','weighted'].includes(f.calcMode)) {
                            // Shared value
                            input.classList.add(`app-input-${appId}-${f.id}`);
                        }
                        
                        input.value = val || "";
                        input.dataset.field = f.id;
                        
                        if (f.type !== 'date') {
                            input.onchange = (e) => handleGridChange(e.target, student, course, f);
                        }
                        td.appendChild(input);
                    }
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
                updateRowLogic(tr, appId ? appData : course, !appId);
            });
        }

        // --- Student Grid Selection ---
        function updateStudentGridSelection(chk) {
            if(chk.checked) studentGridSelection.add(chk.value);
            else studentGridSelection.delete(chk.value);
            updateGridToolbar();
        }

        function toggleAllStudentGrid(mainChk) {
            const chks = document.querySelectorAll('.std-grid-chk');
            chks.forEach(c => {
                c.checked = mainChk.checked;
                if(mainChk.checked) studentGridSelection.add(c.value);
                else studentGridSelection.delete(c.value);
            });
            updateGridToolbar();
        }

        function updateGridToolbar() {
            document.getElementById('std-grid-count').innerText = studentGridSelection.size;
            document.getElementById('btn-std-grid-merge').disabled = studentGridSelection.size < 2;
        }

        async function executeStudentGridMerge() {
            if (studentGridSelection.size < 2) return;
            
            const student = groupedStudents[currentStudentId];
            const selectedCourses = student.courses.filter(c => studentGridSelection.has(c._internal_id));
            
            const confirm = await showConfirm('確認歸戶', `確定將這 ${selectedCourses.length} 筆課程合併為同一份實習紀錄嗎？\n(數值欄位將自動加總)`);
            if (!confirm) return;

            const newAppId = 'app_grid_' + Date.now();
            const firstC = selectedCourses[0];
            const initData = {};

            // Prioritize existing data
            if (firstC._app_id) {
                const existApp = student.applications.find(a => a.id === firstC._app_id);
                if (existApp) Object.assign(initData, existApp.formData);
            } else {
                (currentYearConfig.fields||[]).forEach(f => {
                    if (firstC[f.id]) initData[f.id] = firstC[f.id];
                });
            }

            // Calculations
            (currentYearConfig.fields||[]).forEach(f => {
                if (f.type === 'number') {
                    let sum = 0; let hasVal = false;
                    selectedCourses.forEach(c => {
                        const v = parseFloat(c[f.id]);
                        if(!isNaN(v)) { sum += v; hasVal = true; }
                    });
                    if (hasVal) {
                        initData[f.id] = f.decimal ? sum.toFixed(f.decimal) : Math.round(sum).toString();
                    }
                }
            });

            const newApp = { id: newAppId, courseIds: Array.from(studentGridSelection), formData: initData };
            
            // Remove old app links
            selectedCourses.forEach(c => c._app_id = newAppId);
            
            student.applications.push(newApp);
            hasUnsavedChanges = true;
            studentGridSelection.clear();
            updateGridToolbar();
            
            // Refresh View
            renderStudentGrid();
            showToast('success', '歸戶完成');
            logChange('StudentGridMerge', newAppId, '', `Merged ${selectedCourses.length} items`, student.id);
        }

        // --- Reuse Grid Logic ---
        function handleGridChange(inputEl, student, course, fieldDef) {
            // Logic is identical to previous handleGridChange, just scoped
            if (fieldDef.type === 'address') {
                if (fieldDef.toHalf || fieldDef.forceTai || fieldDef.latinToEng || fieldDef.smartFormat) {
                    processAddress(inputEl, fieldDef);
                }
            }
            const newVal = inputEl.value;
            inputEl.title = newVal;
            
            const appId = course._app_id;
            hasUnsavedChanges = true;

            if (appId) {
                const app = student.applications.find(a => a.id === appId);
                if (app) {
                    if (fieldDef.calcMode === 'average' || fieldDef.calcMode === 'weighted') {
                        course[fieldDef.id] = newVal;
                        const linkedCourses = student.courses.filter(c => app.courseIds.includes(c._internal_id));
                        
                        if (fieldDef.calcMode === 'weighted') {
                            // Weighted Logic... (Simplified for brevity, reuse logic from previous file)
                            let currentTotal = 0; let totalWeight = 0; const wKey = fieldDef.weightField;
                            linkedCourses.forEach(c => {
                                const v = parseFloat(c[fieldDef.id])||0; 
                                const w = parseFloat(getCourseValue(c, [wKey]))||0;
                                currentTotal+=v; totalWeight+=w;
                            });
                            if(totalWeight > 0) {
                                linkedCourses.forEach(c => {
                                    const w = parseFloat(getCourseValue(c, [wKey]))||0;
                                    const ratio = w / totalWeight;
                                    const distVal = currentTotal * ratio;
                                    c[fieldDef.id] = fieldDef.decimal ? distVal.toFixed(fieldDef.decimal) : Math.round(distVal).toString();
                                    
                                    // Update DOM
                                    const row = document.querySelector(`tr[data-cid="${c._internal_id}"] input[data-field="${fieldDef.id}"]`);
                                    if(row) row.value = c[fieldDef.id];
                                });
                            }
                            app.formData[fieldDef.id] = fieldDef.decimal ? currentTotal.toFixed(fieldDef.decimal) : Math.round(currentTotal).toString();
                        } else {
                            let sum = 0;
                            linkedCourses.forEach(c => { const v=parseFloat(c[fieldDef.id]); if(!isNaN(v)) sum+=v; });
                            app.formData[fieldDef.id] = fieldDef.decimal ? sum.toFixed(fieldDef.decimal) : Math.round(sum).toString();
                        }
                    } else {
                        app.formData[fieldDef.id] = newVal;
                        // Sync inputs
                        document.querySelectorAll(`.app-input-${appId}-${fieldDef.id}`).forEach(el => {
                            if(el !== inputEl) el.value = newVal;
                        });
                    }
                    
                    // Trigger Logic Check
                    const allRows = document.getElementById('std-grid-tbody').querySelectorAll('tr');
                    allRows.forEach(tr => {
                        const cid = tr.dataset.cid;
                        if (app.courseIds.includes(cid)) updateRowLogic(tr, app.formData, false);
                    });
                }
            } else {
                course[fieldDef.id] = newVal;
                const tr = inputEl.closest('tr');
                if (tr) updateRowLogic(tr, course, true);
                if (newVal && newVal.trim() !== "") tryAutoMerge(student, course);
            }
        }

        // --- Rest of Initialization & Helper Functions (Reuse from provided code) ---
        // (Include processUploadedData, handleFileUpload, etc. similar to original logic but remove global grid parts)
        
        window.onload = async function() {
            try {
                window.onbeforeunload = function (e) {
                    if (allRawData.length > 0 || hasUnsavedChanges) {
                        const msg = "您有未儲存的資料，確定要離開嗎？";
                        e.returnValue = msg;
                        return msg;
                    }
                };

                const [cfgRes, deptRes, masterRes] = await Promise.all([
                    fetch('config.json').then(r => r.ok ? r.json() : {}),
                    fetch('data_departments.json').then(r => r.ok ? r.json() : []),
                    fetch('data_dept_master.json').then(r => r.ok ? r.json() : {})
                ]);

                globalConfig = cfgRes;
                departmentData = deptRes;
                deptMasterData = masterRes;

                updateFooterYear();
                document.getElementById('info-modal').classList.remove('hidden');
                
            } catch (e) {
                console.error("Init failed", e);
                showToast('error', '系統初始化失敗');
            }
        };

        function updateFooterYear() {
            const startYear = 2025;
            const currentYear = new Date().getFullYear();
            const yearSpan = document.getElementById('copyright-year');
            if (yearSpan) {
                yearSpan.innerText = currentYear > startYear ? `${startYear}-${currentYear}` : `${startYear}`;
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
        }

        async function changeYear(year) {
            if(!year) return;
            activeYear = year;
            showToast('info', `載入 ${year} 學年度設定...`);
            try {
                const res = await fetch(`year_templates/year_${year}_templates.json?t=${Date.now()}`);
                if (!res.ok) throw new Error("Template not found");
                currentYearConfig = await res.json();
                if (currentStudentId) selectStudent(currentStudentId); 
                showToast('success', `已切換至 ${year} 學年度`);
            } catch (e) {
                console.error(e);
                showToast('error', `無法讀取 ${year} 學年度模板`);
            }
        }

        // (Include handleFileUpload, processUploadedData, renderStudentList, selectStudent, renderTabs, switchTab, renderSettingsTab, createApplication, deleteApplication, createApplicationContent, renderFields, evaluateLogic, openPreviewModal, exportData, logChange, showToast, toolAutoFill, toolCheckData, toolStats, createRocDatePicker, processAddress, cnToNum, getCourseValue, tryAutoMerge, checkForRawData, clearRawData, openMergeModal, closeMergeModal, discardAndSwitch, processMergeAndSwitch, updateRowLogic, executeSwitchToApp)
        // Ensure switchViewMode is removed and replaced by student view logic.
        
        // ... (Remaining Logic reuse from previous context) ...
        
        // Add minimal implementation of omitted functions for completeness in snippet:
        function filterStudentList() { renderStudentList(); }
        function toggleSort(key) {
            if (sortConfig.key === key) sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            else { sortConfig.key = key; sortConfig.direction = 'asc'; }
            renderStudentList();
        }
        
        // [IMPORTANT]: Paste the rest of the logic functions (handleFileUpload, processUploadedData, etc.) from the previous file content here to make it fully functional.
        // I will include the critical modified ones.
        
        async function handleFileUpload(event) {
            if(allRawData.length > 0) {
                const confirmOverwrite = await showConfirm('確認覆蓋？', '確定要匯入新檔案嗎？這將會清除目前的資料與歸戶設定。');
                if(!confirmOverwrite) { event.target.value = ''; return; }
            }
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(e.target.result);
                    const mainSheet = workbook.getWorksheet(1); // Simplification
                    const jsonData = [];
                    const headers = [];
                    mainSheet.getRow(1).eachCell((cell, colNumber) => headers[colNumber] = cell.value);
                    mainSheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            const rowData = {};
                            row.eachCell((cell, colNumber) => rowData[headers[colNumber]] = cell.value);
                            if(Object.keys(rowData).length>0) jsonData.push(rowData);
                        }
                    });
                    
                    // Logic to load saved apps...
                    // Call processUploadedData...
                    await processUploadedData(jsonData, []); // Simplified call
                    event.target.value = ''; 
                } catch (err) { console.error(err); showToast('error', `讀取失敗: ${err.message}`); }
            };
            reader.readAsArrayBuffer(file);
        }

        async function processUploadedData(data, savedApps=[]) {
            allRawData = data;
            groupedStudents = {};
            // Year detection logic...
            if (data.length > 0) {
                const firstRow = data[0];
                const detectedYear = firstRow['school_year'] || firstRow['academic_year'] || firstRow['學年'];
                if(detectedYear) await changeYear(detectedYear.toString().trim());
            }

            const courseCounters = {}; 
            allRawData.forEach((row, idx) => {
                const sid = row['student_id'] || row['學號'];
                const sname = row['student_name'] || row['姓名'];
                const sdept = row['student_dept'] || row['系所'];
                if (!sid) return;
                if (!groupedStudents[sid]) groupedStudents[sid] = { id: sid, name: sname||'未知', dept: sdept||'', courses: [], applications: [] };
                
                const rYear = row['school_year']||row['學年'];
                const rSem = row['semester']||row['學期'];
                const rCode = row['course_code']||row['選課代號'];
                if (rYear && rSem && rCode) {
                     const baseKey = `${sid}_${rYear}${rSem}_${rCode}`;
                     if (!courseCounters[baseKey]) courseCounters[baseKey] = 0;
                     courseCounters[baseKey]++;
                     row._internal_id = `${rYear}${rSem}_${rCode}_${courseCounters[baseKey]}`;
                } else row._internal_id = `temp_c_${idx}`;
                
                row._app_id = null; 
                groupedStudents[sid].courses.push(row);
            });
            
            renderStudentList();
            hasUnsavedChanges = false;
        }

        // Paste other existing helper functions here...
        // renderStudentList, selectStudent, renderTabs, switchTab, renderSettingsTab, createApplication, etc.
        // Ensure "selectStudent" calls "setStudentView(currentViewMode)"
        
        // Overwriting selectStudent to respect view mode
        /* function selectStudent(sid) {
            currentStudentId = sid;
            renderStudentList(); 
            const student = groupedStudents[sid];
            document.getElementById('form-empty-state').classList.add('hidden');
            document.getElementById('form-container').classList.remove('hidden');
            
            document.getElementById('header-name').innerText = student.name;
            document.getElementById('header-id').innerText = student.id;
            document.getElementById('header-dept').innerHTML = `<i class="fas fa-graduation-cap mr-1"></i>${student.dept}`;
            document.getElementById('header-avatar').innerText = student.name[0] || '?';
            
            const appCount = student.applications.length;
            const statusEl = document.getElementById('header-status');
            statusEl.innerText = appCount > 0 ? `已建立 ${appCount} 筆歸戶` : '未填報';
            statusEl.className = `inline-block px-3 py-1 rounded-full text-xs font-bold ${appCount > 0 ? 'bg-green-100 text-success' : 'bg-slate-100 text-slate-500'}`;

            // Reset Grid Selection
            studentGridSelection.clear();
            updateGridToolbar();

            // Render Views
            renderTabs(student);
            if (appCount > 0) switchTab(student.applications[0].id);
            else switchTab('settings');
            renderSettingsTab(student);
            
            // Trigger View Refresh
            const mode = currentViewMode;
            currentViewMode = null; // force refresh
            setStudentView(mode);
        }
        */
        // --- 補上缺失的工具函式 ---

        // 記錄變更 (Audit Log)
        function logChange(field, appId, oldVal, newVal, studentId) {
            if(oldVal === newVal) return;
            changeLogs.push({
                time: new Date().toISOString(),
                field: field,
                old: oldVal,
                new: newVal,
                student: studentId,
                app: appId
            });
        }

        // 顯示提示訊息 (Toast)
        let toastTimeout;
        function showToast(type, msg) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const el = document.createElement('div');
            let colorClass = 'bg-slate-800'; 
            let iconClass = 'fa-info-circle';
            
            if (type === 'success') {
                colorClass = 'bg-emerald-600';
                iconClass = 'fa-check-circle';
            } else if (type === 'error') {
                colorClass = 'bg-red-600';
                iconClass = 'fa-exclamation-circle';
            } else if (type === 'warning') {
                colorClass = 'bg-orange-500';
                iconClass = 'fa-exclamation-triangle';
            } else if (type === 'info') {
                colorClass = 'bg-sky-600';
                iconClass = 'fa-info-circle';
            }

            el.className = `${colorClass} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] transform transition-all duration-300 translate-y-10 opacity-0 pointer-events-auto`;
            
            el.innerHTML = `
                <i class="fas ${iconClass} text-lg"></i> 
                <span class="font-bold text-sm tracking-wide">${msg}</span>
                <button class="ml-auto hover:text-slate-200 focus:outline-none p-1 transition-colors"><i class="fas fa-times"></i></button>
            `;

            const close = () => {
                el.classList.add('opacity-0', 'translate-y-10');
                el.classList.remove('mb-2'); 
                setTimeout(() => { if (el.parentElement) el.remove(); }, 300);
            };

            el.querySelector('button').onclick = close;
            container.appendChild(el);

            requestAnimationFrame(() => {
                el.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(close, 3000);
        }
        
        // 隱藏提示 (相容性保留)
        function hideToast() {
            // 空函式，新版邏輯已整合至 showToast
        }

        // 匯出資料
        async function exportData() {
            if(Object.keys(groupedStudents).length === 0) return showToast('error', '無資料可匯出');

            const workbook = new ExcelJS.Workbook();
            const ws = workbook.addWorksheet('填報資料');

            const headers = [];
            if (currentYearConfig.fields) {
                currentYearConfig.fields.sort((a,b)=>(a.order||0)-(b.order||0)).forEach(f => headers.push({key: f.id, header: f.label}));
            }
            ws.columns = headers;

            const headerRow = ws.getRow(1);
            headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF002E5D' } };

            Object.values(groupedStudents).forEach(s => {
                s.applications.forEach(app => {
                    const courses = s.courses.filter(c => app.courseIds.includes(c._internal_id));
                    const courseCount = courses.length;

                    courses.forEach((c, idx) => {
                        const row = {};
                        headers.forEach(h => {
                            let val = app.formData[h.key];
                            const fieldDef = currentYearConfig.fields?.find(f => f.id === h.key);
                            
                            if (fieldDef && fieldDef.calcMode === 'average' && val && !isNaN(val)) {
                                const totalVal = parseFloat(val);
                                const baseVal = Math.floor(totalVal / courseCount);
                                const remainder = totalVal % courseCount;
                                if (idx === courses.length - 1) val = (baseVal + remainder).toFixed(fieldDef.decimal || 0);
                                else val = baseVal.toFixed(fieldDef.decimal || 0);
                            }

                            if (val === undefined || val === "") val = c[h.key] || c[h.header] || "";
                            
                            if (fieldDef && fieldDef.type === 'date' && fieldDef.outputFormat === 'ROC' && val && val.includes('-')) {
                                 const parts = val.split('-');
                                 if (parts.length === 3) {
                                     const roc = parseInt(parts[0]) - 1911;
                                     val = `${roc}${parts[1]}${parts[2]}`; 
                                 }
                            }

                            row[h.key] = val;
                        });
                        ws.addRow(row);
                    });
                });

                const unassigned = s.courses.filter(c => !c._app_id);
                unassigned.forEach(c => {
                    const row = {};
                    headers.forEach(h => row[h.key] = c[h.key] || c[h.header] || "");
                    ws.addRow(row);
                });
            });

            if (currentYearConfig.fields) {
                currentYearConfig.fields.forEach((f, i) => {
                    const col = ws.getColumn(i + 1);
                    if (f.excelWidth) col.width = f.excelWidth;
                    
                    if (f.type === 'single_select' && f.options && f.options.length > 0) {
                         const char = col.letter;
                         const listStr = f.options.join(',');
                         if(listStr.length < 255) {
                             ws.dataValidations.add(`${char}2:${char}9999`, {
                                 type: 'list',
                                 allowBlank: true,
                                 formulae: [`"${listStr}"`]
                             });
                         }
                    }
                });
            }

            const conSheet = workbook.addWorksheet('_Consolidation_Data', {state: 'hidden'});
            conSheet.columns = [{header: 'App_ID', key: 'id'}, {header: 'Student_ID', key: 'sid'}, {header: 'Course_IDs', key: 'cids'}, {header: 'Form_Data', key: 'data'}];
            Object.values(groupedStudents).forEach(s => {
                s.applications.forEach(app => {
                    conSheet.addRow({ id: app.id, sid: s.id, cids: app.courseIds.join(','), data: JSON.stringify(app.formData) });
                });
            });

            const logSheet = workbook.addWorksheet('_Audit_Log', {state: 'hidden'});
            changeLogs.forEach(l => logSheet.addRow(l));

            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            saveAs(blob, `實習填報_${activeYear}_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('success', '匯出成功');
            hasUnsavedChanges = false;
        }
    </script>
</body>
</html>
