<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>載入中...</title>
    <!-- 外部資源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        thuBlue: '#002E5D',
                        thuLightBlue: '#eef6fc',
                        thuGold: '#C6A87C',
                    },
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定義樣式 */
        .hero-bg {
            background: linear-gradient(135deg, #002E5D 0%, #001a35 100%);
            position: relative;
            overflow: hidden;
        }
        .hero-bg::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px; z-index: 1;
        }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-y: hidden !important; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        
        .preview-banner { animation: slideDown 0.5s ease-out forwards; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-700 flex flex-col min-h-screen pb-16">

    <!-- 隱藏功能：測試模式上傳入口 -->
    <input type="file" id="debug-file-input" accept=".xlsx" class="hidden" />

    <!-- 隱藏功能：預覽模式警告橫幅 -->
    <div id="preview-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white z-[100] px-4 py-2 text-center shadow-md text-sm font-bold preview-banner">
        <i class="fas fa-wrench mr-2"></i> 目前為「測試預覽模式」 - 顯示內容來自您上傳的檔案，非網站實際內容。
        <button onclick="location.reload()" class="ml-4 underline hover:text-red-200">關閉預覽 (重新整理)</button>
    </div>

    <!-- Sticky Header -->
    <nav id="sticky-header" class="fixed top-0 left-0 w-full bg-thuBlue/95 backdrop-blur-sm shadow-lg z-40 transition-all duration-500 ease-in-out -translate-y-full opacity-0 flex items-center h-16 px-4 sm:px-8">
        <div class="w-full max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="nav-logo" src="" alt="Logo" class="h-8 w-auto hidden">
                <div class="text-white leading-none flex flex-col justify-center">
                    <span class="font-bold text-lg tracking-widest" id="nav-title"></span>
                </div>
            </div>
            <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 text-white hover:text-thuGold transition-colors text-sm font-medium">
                <i class="fa-solid fa-house"></i> <span class="hidden sm:inline">東海大學首頁</span>
            </a>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-bg text-white pb-32 pt-24 relative">
        <div class="absolute top-6 right-6 z-30">
            <a href="https://www.thu.edu.tw/" target="_blank" class="flex items-center gap-2 px-4 py-2 bg-white/10 text-white border border-white/20 rounded-full hover:bg-white hover:text-thuBlue transition-all duration-300 font-medium backdrop-blur-sm shadow-sm">
                <i class="fa-solid fa-house"></i> 東海大學首頁
            </a>
        </div>
        
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
             <div class="absolute -top-20 -right-20 w-96 h-96 bg-thuGold opacity-10 rounded-full blur-3xl"></div>
             <div class="absolute top-40 -left-20 w-72 h-72 bg-blue-400 opacity-10 rounded-full blur-3xl"></div>
        </div>

        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10 text-center flex flex-col items-center justify-center min-h-[40vh]">
            <div class="flex flex-col md:flex-row items-center justify-center gap-8 md:gap-12 mb-8 animate-fade-in-up group cursor-default">
                <img id="hero-logo" src="" alt="Logo" class="h-20 w-auto drop-shadow-lg opacity-90 transition-all duration-500 ease-out group-hover:opacity-100 group-hover:scale-110 group-hover:drop-shadow-[0_0_15px_rgba(255,255,255,0.6)] hidden">
                <div class="text-center flex flex-col justify-center items-center h-20">
                    <h1 class="text-3xl md:text-5xl font-bold tracking-widest leading-none drop-shadow-xl mb-1 transition-all duration-500 ease-out group-hover:scale-110 group-hover:tracking-[0.15em] group-hover:drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]">
                        <span id="hero-title-1"></span><span class="text-thuGold transition-colors duration-300 group-hover:text-white" id="hero-title-2"></span>
                    </h1>
                    <p id="hero-eng-title" class="text-base text-blue-200 tracking-wide font-light hidden md:block opacity-90 transition-all duration-500 group-hover:text-white group-hover:tracking-widest group-hover:drop-shadow-[0_0_5px_rgba(255,255,255,0.8)]"></p>
                </div>
            </div>
            
            <p id="hero-subtitle" class="text-lg md:text-xl text-blue-100/80 font-light mb-8 max-w-2xl mx-auto leading-relaxed animate-fade-in-up" style="animation-delay: 0.2s; opacity: 0;"></p>
            
            <div class="flex flex-col sm:flex-row items-center justify-center gap-5 mb-10 animate-fade-in-up w-full sm:w-auto" style="animation-delay: 0.4s; opacity: 0;">
                <button onclick="toggleModal('origin-modal')" class="group relative px-8 py-3.5 bg-thuGold hover:bg-[#b58f2a] text-white font-bold rounded-full transition-all duration-300 shadow-lg hover:shadow-orange-500/20 hover:-translate-y-1 overflow-hidden w-full sm:w-60">
                    <div class="absolute inset-0 w-full h-full bg-white/20 group-hover:translate-x-full transition-transform duration-500 -skew-x-12 -ml-4"></div>
                    <span class="relative flex items-center justify-center gap-2 text-lg"><i class="fas fa-feather-alt"></i> <span>查看計畫緣起</span></span>
                </button>
                <a href="https://aca.thu.edu.tw/web/isac/page.php?scid=112&sid=103" target="_blank" class="px-8 py-3.5 bg-white/5 hover:bg-white/10 text-white border border-white/20 backdrop-blur-sm font-medium rounded-full transition-all duration-300 hover:-translate-y-1 flex items-center justify-center gap-2 hover:border-white/40 w-full sm:w-60">
                    <i class="fa-solid fa-link text-blue-300"></i> 實習中心網頁
                </a>
            </div>

            <!-- 最新公告欄 -->
            <div id="news-container" class="w-full max-w-3xl mx-auto bg-white/10 backdrop-blur-md rounded-xl border border-white/20 p-5 text-left animate-fade-in-up hidden" style="animation-delay: 0.6s; opacity: 0;">
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-white/10">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-bullhorn text-thuGold animate-pulse"></i>
                        <span class="font-bold text-white text-base tracking-wide">最新公告</span>
                    </div>
                    <button id="view-more-news-btn" onclick="openAllNewsModal()" class="hidden text-xs bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-full transition-colors flex items-center gap-1 border border-white/10">
                        查看所有 <i class="fas fa-chevron-right text-[10px]"></i>
                    </button>
                </div>
                <ul id="news-list" class="space-y-3 text-sm text-blue-50">
                    <!-- JS 動態填入前 3 筆 -->
                </ul>
            </div>

        </div>
    </div>

    <!-- Main Content Area -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 -mt-20 relative z-20 pb-20 flex-grow">
        <div id="cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full text-center py-10 text-white">
                <i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i>
                <p>正在讀取設定檔 (site_data.xlsx)...</p>
            </div>
        </div>
    </main>

    <!-- Fixed Footer -->
    <footer id="footer-trigger" style="position: fixed; bottom: 0; left: 0; width: 100%; z-index: 50; background-color: #1f2937; color: #9ca3af; text-align: center; padding: 1rem 0; font-size: 0.75rem; border-top: 3px solid #C6A87C;">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center justify-center gap-1">
                <p id="footer-copyright" class="font-bold text-white tracking-wide text-[10px]"></p>
                <p class="text-[9px] text-gray-500">網頁製作：張博堯 | Assisted by Google Gemini</p>
            </div>
        </div>
    </footer>

    <!-- Chatbot Button -->
    <div class="fixed bottom-20 right-8 z-40 flex flex-col items-end">
        <div class="bg-white text-gray-800 px-4 py-2 rounded-2xl shadow-lg border border-gray-100 text-sm font-bold mb-2 animate-bounce origin-bottom-right relative cursor-pointer" onclick="toggleModal('contact-modal')">
            需要協助嗎？
            <div class="absolute -bottom-1.5 right-6 w-3 h-3 bg-white transform rotate-45 border-r border-b border-gray-100"></div>
        </div>
        <button onclick="toggleModal('contact-modal')" class="w-14 h-14 bg-thuBlue hover:bg-blue-800 text-white rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 hover:scale-110 hover:rotate-12 group focus:outline-none focus:ring-4 focus:ring-blue-300 border-2 border-white">
            <i class="fas fa-headset text-2xl group-hover:animate-pulse"></i>
        </button>
    </div>

    <!-- Modal 1: 計畫緣起 -->
    <div id="origin-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('origin-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-2xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-200 sticky top-0 bg-white">
                <div class="flex items-center gap-2"><i class="fas fa-feather-alt text-thuGold text-xl"></i><p class="text-2xl font-bold text-thuBlue" id="modal-origin-title">計畫緣起</p></div>
                <div class="cursor-pointer z-50" onclick="toggleModal('origin-modal')"><i class="fas fa-times text-gray-500 hover:text-gray-800 text-xl transition"></i></div>
            </div>
            <div class="px-8 py-6 text-left"><div id="modal-origin-content" class="prose prose-blue max-w-none text-gray-600 space-y-4"></div></div>
            <div class="flex justify-end pt-4 pb-6 px-6 bg-gray-50 rounded-b-xl border-t border-gray-100">
                <button onclick="toggleModal('origin-modal')" class="bg-thuBlue hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300">關閉視窗</button>
            </div>
        </div>
    </div>

    <!-- Modal 2: 聯絡資訊 -->
    <div id="contact-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('contact-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-5xl mx-auto rounded-2xl shadow-2xl z-50 flex flex-col max-h-[90vh]">
            <div class="flex-none flex justify-between items-center py-5 px-8 border-b border-gray-200 bg-white rounded-t-2xl z-10">
                <div class="flex items-center gap-3"><i class="fas fa-address-book text-thuGold text-2xl"></i><p class="text-2xl font-bold text-thuBlue">聯絡資訊</p></div>
                <div class="cursor-pointer z-50" onclick="toggleModal('contact-modal')"><i class="fas fa-times text-gray-500 hover:text-gray-800 text-2xl transition"></i></div>
            </div>
            <div class="flex-grow overflow-y-auto px-8 py-8 bg-gray-50">
                <div class="mb-6 text-center bg-blue-50 border border-blue-100 rounded-xl p-5">
                    <p class="text-gray-700 font-medium text-base"><i class="fas fa-info-circle text-thuBlue mr-2"></i>如果您在操作上有任何問題，歡迎聯繫實習與學生成就中心或相關承辦人員。</p>
                </div>
                <div id="contacts-container" class="flex flex-col gap-6"></div>
            </div>
            <div class="flex-none flex justify-end py-5 px-8 bg-white border-t border-gray-100 rounded-b-2xl z-10">
                <button onclick="toggleModal('contact-modal')" class="bg-thuBlue hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg transition duration-300 text-base shadow-md">關閉</button>
            </div>
        </div>
    </div>

    <!-- Modal 3: 單一公告詳情 -->
    <div id="news-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('news-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center py-4 px-6 border-b border-gray-200 sticky top-0 bg-white">
                <div class="flex items-center gap-2">
                    <i class="fas fa-bullhorn text-thuGold text-xl"></i>
                    <p class="text-xl font-bold text-thuBlue">公告詳情</p>
                </div>
                <div class="cursor-pointer z-50" onclick="toggleModal('news-modal')"><i class="fas fa-times text-gray-500 hover:text-gray-800 text-xl transition"></i></div>
            </div>
            <div class="px-8 py-6 text-left">
                <div class="mb-4">
                    <span id="modal-news-date" class="text-sm text-gray-500 font-mono"></span>
                    <h2 id="modal-news-title" class="text-2xl font-bold text-gray-800 mt-1"></h2>
                </div>
                <hr class="border-gray-200 mb-4">
                <div id="modal-news-content" class="prose prose-blue max-w-none text-gray-600 space-y-4 leading-relaxed"></div>
            </div>
            <div class="flex justify-end pt-4 pb-6 px-6 bg-gray-50 rounded-b-xl border-t border-gray-100">
                <button onclick="toggleModal('news-modal')" class="bg-thuBlue hover:bg-blue-800 text-white font-bold py-2 px-6 rounded-lg transition duration-300">關閉</button>
            </div>
        </div>
    </div>

    <!-- Modal 4: 所有公告列表 (含搜尋/篩選/分頁) -->
    <div id="all-news-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-[100]">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('all-news-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-4xl mx-auto rounded-xl shadow-2xl z-50 flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="flex-none flex justify-between items-center py-5 px-8 border-b border-gray-200 bg-white rounded-t-xl z-10">
                <div class="flex items-center gap-3">
                    <i class="fas fa-list-ul text-thuGold text-2xl"></i>
                    <p class="text-2xl font-bold text-thuBlue">所有公告</p>
                </div>
                <div class="cursor-pointer z-50" onclick="toggleModal('all-news-modal')"><i class="fas fa-times text-gray-500 hover:text-gray-800 text-2xl transition"></i></div>
            </div>
            
            <!-- 工具列：搜尋 & 篩選 -->
            <div class="flex-none px-8 pt-6 pb-2 bg-gray-50">
                <div class="flex flex-col sm:flex-row gap-3">
                    <!-- 搜尋 -->
                    <div class="relative flex-grow">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="news-search" placeholder="搜尋公告標題..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-thuBlue focus:border-transparent outline-none text-sm transition-all" oninput="renderAllNewsUI()">
                    </div>
                    <!-- 篩選 -->
                    <select id="news-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-thuBlue focus:border-transparent outline-none text-sm bg-white text-gray-600 min-w-[120px] cursor-pointer" onchange="renderAllNewsUI()">
                        <option value="all">所有類型</option>
                        <!-- JS 會動態加入其他選項 -->
                    </select>
                </div>
            </div>

            <!-- 列表內容 -->
            <div class="flex-grow overflow-y-auto px-8 py-2 bg-gray-50 min-h-[300px]">
                <ul id="all-news-list" class="space-y-2">
                    <!-- JS 動態生成 -->
                </ul>
                <!-- 無資料提示 -->
                <div id="no-news-msg" class="hidden text-center py-10 text-gray-400">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <p>沒有符合條件的公告</p>
                </div>
            </div>

            <!-- 分頁 & Footer -->
            <div class="flex-none bg-white border-t border-gray-100 rounded-b-xl z-10">
                <!-- 分頁器 -->
                <div id="news-pagination" class="flex justify-center items-center gap-2 py-3 border-b border-gray-50">
                    <!-- JS 動態生成分頁按鈕 -->
                </div>
                <div class="flex justify-end py-4 px-8">
                    <button onclick="toggleModal('all-news-modal')" class="bg-thuBlue hover:bg-blue-800 text-white font-bold py-2 px-8 rounded-lg transition duration-300">關閉</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* 內建公告 (預設值) - 增加 Type 欄位範例 */
        let siteNews = [
            { Date: "2025-03-01", Title: "【重要】113學年度暑期實習申請說明會開放報名", Link: "https://aca.thu.edu.tw", IsNew: true, Type: "重要公告" },
            { Date: "2025-02-28", Title: "教育部學海築夢計畫開始徵件 (點擊看詳情)", Link: "", Content: "<p>教育部為鼓勵國內公私立大專校院選送學生赴國外...</p>", IsNew: false, Type: "計畫申請" },
            { Date: "2025-02-20", Title: "最新實習機構名單更新公告 (3月份)", Link: "#", IsNew: false, Type: "一般公告" },
            { Date: "2025-02-15", Title: "2025年企業實習博覽會攤位圖下載", Link: "#", IsNew: false, Type: "活動訊息" },
            { Date: "2025-02-10", Title: "系統維護通知：2/12 00:00-02:00 暫停服務", Link: "#", IsNew: false, Type: "系統公告" }
        ];

        // ... Color Mappings ...
        const colorMap = { 'thu': { border: 'border-thuBlue', icon: 'bg-thuBlue', text: 'text-thuBlue', hoverText: 'group-hover:text-thuBlue' }, 'gold': { border: 'border-thuGold', icon: 'bg-thuGold', text: 'text-thuGold', hoverText: 'group-hover:text-thuGold', isGradient: true }, 'blue': { border: 'border-blue-500', icon: 'bg-blue-500', text: 'text-blue-600', hoverText: 'group-hover:text-blue-800' }, 'purple': { border: 'border-purple-500', icon: 'bg-purple-500', text: 'text-purple-600', hoverText: 'group-hover:text-purple-800' }, 'orange': { border: 'border-orange-500', icon: 'bg-orange-500', text: 'text-orange-600', hoverText: 'group-hover:text-orange-800' }, 'green': { border: 'border-green-500', icon: 'bg-green-500', text: 'text-green-600', hoverText: 'group-hover:text-green-800' }, 'red': { border: 'border-red-500', icon: 'bg-red-500', text: 'text-red-600', hoverText: 'group-hover:text-red-800' }, 'teal': { border: 'border-teal-500', icon: 'bg-teal-500', text: 'text-teal-600', hoverText: 'group-hover:text-teal-800' }, 'indigo': { border: 'border-indigo-500', icon: 'bg-indigo-500', text: 'text-indigo-600', hoverText: 'group-hover:text-indigo-800' }, 'cyan': { border: 'border-cyan-500', icon: 'bg-cyan-500', text: 'text-cyan-600', hoverText: 'group-hover:text-cyan-800' }, 'rose': { border: 'border-rose-500', icon: 'bg-rose-500', text: 'text-rose-600', hoverText: 'group-hover:text-rose-800' } };
        const contactColorMap = { 'thu': { bg: 'bg-blue-50', text: 'text-thuBlue', badge: 'bg-gray-100 text-gray-600', border: 'hover:border-thuBlue' }, 'gold': { bg: 'bg-yellow-50', text: 'text-yellow-700', badge: 'bg-yellow-100 text-yellow-800', border: 'hover:border-yellow-500' }, 'purple': { bg: 'bg-purple-50', text: 'text-purple-600', badge: 'bg-purple-100 text-purple-800', border: 'hover:border-purple-500' }, 'orange': { bg: 'bg-orange-50', text: 'text-orange-600', badge: 'bg-orange-100 text-orange-800', border: 'hover:border-orange-500' }, 'blue': { bg: 'bg-blue-50', text: 'text-blue-600', badge: 'bg-blue-100 text-blue-800', border: 'hover:border-blue-500' }, 'default': { bg: 'bg-gray-50', text: 'text-gray-600', badge: 'bg-gray-200 text-gray-700', border: 'hover:border-gray-400' } };

        // Trigger Logic
        let pKeyPressCount = 0, pKeyTimer = null;
        document.addEventListener('keydown', function(e) {
            if (e.key === 'p' || e.key === 'P') {
                pKeyPressCount++;
                if (pKeyTimer) clearTimeout(pKeyTimer);
                pKeyTimer = setTimeout(() => { pKeyPressCount = 0; }, 2000);
                if (pKeyPressCount === 5) { pKeyPressCount = 0; document.getElementById('debug-file-input').click(); }
            } else { pKeyPressCount = 0; }
        });

        document.getElementById('debug-file-input').addEventListener('change', async function(e) {
            const file = e.target.files[0]; if (!file) return;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                processWorkbook(workbook);
                document.getElementById('preview-banner').classList.remove('hidden');
                document.getElementById('sticky-header').classList.add('top-[36px]');
                alert("✅ 預覽模式已啟動！");
            } catch (error) { alert("❌ 檔案讀取失敗"); console.error(error); }
            e.target.value = '';
        });

        // Init
        document.addEventListener('DOMContentLoaded', async function() {
            renderNews(siteNews); // Render initial (hero) news
            try {
                const response = await fetch('./site_data.xlsx');
                if (!response.ok) throw new Error("Excel not found");
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                processWorkbook(workbook);
            } catch (error) {
                console.warn("Using default data due to:", error);
                if(typeof defaultSettings !== 'undefined') renderSettings(defaultSettings, true);
                if(typeof defaultCards !== 'undefined') renderCards(defaultCards);
                if(typeof defaultContacts !== 'undefined') renderContacts(defaultContacts);
            }
        });

        function processWorkbook(workbook) {
            renderSettings(XLSX.utils.sheet_to_json(workbook.Sheets['Settings']));
            if (workbook.Sheets['News']) {
                siteNews = XLSX.utils.sheet_to_json(workbook.Sheets['News']); 
                renderNews(siteNews);
            }
            renderCards(XLSX.utils.sheet_to_json(workbook.Sheets['Cards']));
            renderContacts(XLSX.utils.sheet_to_json(workbook.Sheets['Contacts']));
        }

        // ... renderSettings, renderCards, renderContacts ...
        function renderSettings(data, isDirectObject = false) {
            const settings = isDirectObject ? data : {};
            if (!isDirectObject) data.forEach(row => { settings[row.Key] = row.Value; });
            const setText = (id, val) => { if(document.getElementById(id)) document.getElementById(id).innerText = val || ''; };
            const setHTML = (id, val) => { if(document.getElementById(id)) document.getElementById(id).innerHTML = val || ''; };
            document.title = settings['SiteTitle'];
            setText('nav-title', settings['SiteTitle']);
            setText('hero-eng-title', settings['SiteEngTitle']);
            setHTML('hero-subtitle', settings['HeroSubtitle']);
            setText('footer-copyright', settings['Copyright']);
            setText('modal-origin-title', settings['OriginTitle']);
            setHTML('modal-origin-content', settings['OriginContent']);
            const fullTitle = settings['SiteTitle'] || "";
            if (fullTitle.includes("協作平台")) {
                setText('hero-title-1', fullTitle.split("協作平台")[0]);
                setText('hero-title-2', "協作平台");
            } else { setText('hero-title-1', fullTitle); }
            if (settings['LogoUrl']) {
                document.querySelectorAll('img[alt="Logo"]').forEach(img => { img.src = settings['LogoUrl']; img.classList.remove('hidden'); });
            }
        }

        function renderCards(data) {
            const container = document.getElementById('cards-container'); container.innerHTML = ''; 
            data.forEach(item => {
                const colorKey = (item.Type || 'thu').toLowerCase();
                const theme = colorMap[colorKey] || colorMap['thu'];
                const bgClass = theme.isGradient ? 'bg-gradient-to-br from-white to-blue-50' : 'bg-white';
                const badgeHtml = item.Badge ? `<div class="absolute top-0 right-0 ${theme.icon} text-white text-[10px] font-bold px-2 py-0.5 rounded-bl-lg">${item.Badge}</div>` : '';
                container.innerHTML += `
                <a href="${item.Link}" ${item.Link && item.Link.startsWith('http') ? 'target="_blank"' : ''} class="group flex flex-col h-full ${bgClass} rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden transform hover:-translate-y-2 border-t-4 ${theme.border} relative">
                    ${badgeHtml}
                    <div class="p-8 flex-grow">
                        <div class="w-16 h-16 ${theme.icon} text-white rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:scale-110 transition-transform duration-300"><i class="fas ${item.Icon}"></i></div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-3 ${theme.hoverText} transition-colors">${item.Title}</h3>
                        <p class="text-gray-500 leading-relaxed">${item.Description}</p>
                    </div>
                    <div class="bg-white/50 px-8 py-4 border-t border-gray-100 flex justify-between items-center">
                        <span class="text-sm font-medium ${theme.text}">${theme.isGradient ? '立即使用' : '查看詳情'}</span>
                        <i class="fas fa-arrow-right ${theme.text} opacity-0 group-hover:opacity-100 transform translate-x-[-10px] group-hover:translate-x-0 transition-all"></i>
                    </div>
                </a>`;
            });
        }

        function renderContacts(data) {
            const container = document.getElementById('contacts-container'); container.innerHTML = '';
            const office = data.find(d => d.Type === 'office');
            const staff = data.filter(d => d.Type !== 'office');
            if (office) {
                container.innerHTML += `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200 hover:border-green-500 transition-colors flex flex-col md:flex-row items-center justify-between gap-5 mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-full bg-green-50 text-green-600 flex items-center justify-center font-bold text-2xl shrink-0"><i class="fas fa-building"></i></div>
                        <div class="text-center md:text-left"><h4 class="text-xl font-bold text-gray-800">${office.Name}</h4><span class="text-sm bg-green-100 text-green-800 px-2.5 py-1 rounded-md mt-1 inline-block">${office.Title}</span></div>
                    </div>
                    <div class="flex flex-col md:items-end text-center md:text-right">
                        <div class="flex items-center gap-2 mb-1 justify-center md:justify-end"><i class="fas fa-envelope text-gray-400 text-lg"></i><a href="mailto:${office.Email}" class="text-thuBlue font-bold text-xl hover:underline">${office.Email}</a></div>
                        <p class="text-sm text-gray-500">${office.Description || ''}</p>
                    </div>
                </div>`;
            }
            let staffHtml = '<div class="grid grid-cols-1 md:grid-cols-3 gap-5">';
            staff.forEach(p => {
                const colorKey = (p.Type || 'blue').toLowerCase();
                const c = contactColorMap[colorKey] || contactColorMap['default'];
                staffHtml += `
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 ${c.border} transition-colors flex flex-col h-full">
                    <div class="flex items-center gap-3 mb-5 border-b border-gray-100 pb-4">
                        <div class="w-12 h-12 rounded-full ${c.bg} ${c.text} flex items-center justify-center font-bold text-xl shrink-0">${p.Name.charAt(0)}</div>
                        <div class="min-w-0"><h4 class="text-lg font-bold text-gray-800 truncate">${p.Name}</h4><span class="text-sm ${c.badge} px-2 py-0.5 rounded mt-1 inline-block">${p.Title}</span></div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 flex-grow">
                        <div class="flex items-start gap-2"><i class="fas fa-tasks mt-1 text-thuGold w-3"></i>
                            <div><p class="font-medium text-gray-700 mb-0.5">負責業務：</p><ul class="list-disc list-inside text-gray-500 space-y-0.5 pl-0.5">${p.Description ? p.Description.split('\n').map(i => `<li>${i}</li>`).join('') : ''}</ul></div>
                        </div>
                    </div>
                    <div class="mt-5 pt-3 border-t border-gray-100 space-y-2 text-sm">
                        <div class="flex items-center gap-2"><i class="fas fa-phone-alt text-gray-400 w-3"></i><a href="tel:${p.Phone}" class="text-thuBlue font-medium hover:underline">${p.Phone}</a></div>
                        <div class="flex items-center gap-2"><i class="fas fa-envelope text-gray-400 w-3"></i><a href="mailto:${p.Email}" class="text-thuBlue font-medium hover:underline truncate">${p.Email}</a></div>
                    </div>
                </div>`;
            });
            staffHtml += '</div>'; container.innerHTML += staffHtml;
        }

        // === NEWS LOGIC (Hero & All News Modal) ===
        let currentNewsPage = 1;
        const newsPerPage = 5;
        let filteredNews = []; // Stores current filtered/searched results

        function renderNews(data) {
            siteNews = data;
            // 1. Update Hero News (Max 3)
            const heroList = document.getElementById('news-list');
            const heroContainer = document.getElementById('news-container');
            const moreBtn = document.getElementById('view-more-news-btn');
            heroList.innerHTML = '';
            
            if (!data || data.length === 0) {
                heroContainer.classList.add('hidden');
            } else {
                heroContainer.classList.remove('hidden');
                // Show More button if > 3
                if (data.length > 3) moreBtn.classList.remove('hidden');
                else moreBtn.classList.add('hidden');

                // Render only first 3
                data.slice(0, 3).forEach((item, index) => {
                    const isNew = item.IsNew === true || item.IsNew === 'TRUE' || item.IsNew === 'true';
                    const newBadge = isNew ? '<span class="bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded ml-2 align-middle">NEW</span>' : '';
                    
                    // Type Badge (Optional)
                    const typeBadge = item.Type ? `<span class="text-xs text-blue-300 border border-blue-300/30 px-1.5 py-0.5 rounded mr-2">${item.Type}</span>` : '';

                    // Date Logic
                    let dateStr = item.Date;
                    if (typeof dateStr === 'number') { const d = new Date((dateStr - (25567 + 2))*86400*1000); dateStr = d.toISOString().split('T')[0]; }

                    // Link Logic
                    const hasLink = item.Link && item.Link.trim() !== '';
                    const href = hasLink ? item.Link : 'javascript:void(0)';
                    const target = hasLink ? 'target="_blank"' : '';
                    const onClick = hasLink ? '' : `onclick="openNewsModal(${index})"`;
                    const cursorClass = 'cursor-pointer';

                    heroList.innerHTML += `
                    <li class="flex items-start gap-3 hover:bg-white/5 p-1 rounded transition-colors">
                        <div class="flex-shrink-0 mt-0.5 text-thuGold font-mono whitespace-nowrap">${dateStr}</div>
                        <div class="flex-grow min-w-0">
                            ${typeBadge}
                            <a href="${href}" ${target} ${onClick} class="hover:text-white hover:underline transition-colors leading-relaxed ${cursorClass} truncate block">
                                ${item.Title} ${newBadge}
                            </a>
                        </div>
                    </li>`;
                });
            }
            
            // 2. Initialize "All News" filters
            initNewsFilters();
        }

        function initNewsFilters() {
            const types = [...new Set(siteNews.map(n => n.Type || '一般公告'))];
            const select = document.getElementById('news-filter');
            // Keep first option 'all'
            select.innerHTML = '<option value="all">所有類型</option>';
            types.forEach(t => {
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        // Render the UI inside the "All News" Modal (Search + Filter + Pagination)
        function renderAllNewsUI() {
            const search = document.getElementById('news-search').value.toLowerCase();
            const type = document.getElementById('news-filter').value;
            
            // 1. Filter Data
            filteredNews = siteNews.filter(item => {
                const matchSearch = item.Title.toLowerCase().includes(search);
                const matchType = type === 'all' || (item.Type || '一般公告') === type;
                return matchSearch && matchType;
            });

            // 2. Calculate Pagination
            const totalPages = Math.ceil(filteredNews.length / newsPerPage);
            if (currentNewsPage > totalPages) currentNewsPage = 1; // Reset if out of bounds
            
            const start = (currentNewsPage - 1) * newsPerPage;
            const end = start + newsPerPage;
            const pageItems = filteredNews.slice(start, end);

            // 3. Render List
            const list = document.getElementById('all-news-list');
            const noMsg = document.getElementById('no-news-msg');
            list.innerHTML = '';

            if (pageItems.length === 0) {
                noMsg.classList.remove('hidden');
            } else {
                noMsg.classList.add('hidden');
                pageItems.forEach(item => {
                    let dateStr = item.Date;
                    if (typeof dateStr === 'number') { const d = new Date((dateStr - (25567 + 2))*86400*1000); dateStr = d.toISOString().split('T')[0]; }
                    
                    // Type Badge Style
                    const typeTag = item.Type ? `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full mr-2">${item.Type}</span>` : '';

                    const hasLink = item.Link && item.Link.trim() !== '';
                    // Original index is needed for modal lookup if we want to open details
                    // But here we can pass the object or find index in original array. 
                    // To simplify, find index in original siteNews
                    const originalIndex = siteNews.indexOf(item);
                    
                    const href = hasLink ? item.Link : 'javascript:void(0)';
                    const target = hasLink ? 'target="_blank"' : '';
                    const onClick = hasLink ? '' : `onclick="openNewsModal(${originalIndex});"`; // Keep All News open or close? Usually detail opens on top.

                    list.innerHTML += `
                    <li class="border-b border-gray-100 pb-3 last:border-0">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-3">
                            <div class="flex items-center gap-2 shrink-0">
                                <span class="text-gray-400 font-mono text-sm">${dateStr}</span>
                                ${typeTag}
                            </div>
                            <a href="${href}" ${target} ${onClick} class="text-gray-700 hover:text-thuBlue hover:underline font-medium cursor-pointer block truncate">
                                ${item.Title}
                            </a>
                        </div>
                    </li>`;
                });
            }

            // 4. Render Pagination Buttons
            const pag = document.getElementById('news-pagination');
            pag.innerHTML = '';
            if (totalPages > 1) {
                // Prev
                pag.innerHTML += `<button onclick="changePage(${currentNewsPage - 1})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 disabled:opacity-50" ${currentNewsPage === 1 ? 'disabled' : ''}><i class="fas fa-chevron-left text-gray-500"></i></button>`;
                // Page Numbers
                for (let i = 1; i <= totalPages; i++) {
                    const activeClass = i === currentNewsPage ? 'bg-thuBlue text-white' : 'bg-white text-gray-600 hover:bg-gray-100';
                    pag.innerHTML += `<button onclick="changePage(${i})" class="w-8 h-8 flex items-center justify-center rounded-full text-sm font-bold transition-colors ${activeClass}">${i}</button>`;
                }
                // Next
                pag.innerHTML += `<button onclick="changePage(${currentNewsPage + 1})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 disabled:opacity-50" ${currentNewsPage === totalPages ? 'disabled' : ''}><i class="fas fa-chevron-right text-gray-500"></i></button>`;
            }
        }

        window.changePage = function(page) {
            currentNewsPage = page;
            renderAllNewsUI();
        }

        window.openAllNewsModal = function() {
            currentNewsPage = 1;
            // Clear search
            document.getElementById('news-search').value = '';
            document.getElementById('news-filter').value = 'all';
            renderAllNewsUI();
            toggleModal('all-news-modal');
        }

        window.openNewsModal = function(index) {
            const item = siteNews[index];
            if (!item) return;
            
            let dateStr = item.Date;
            if (typeof dateStr === 'number') { const d = new Date((dateStr - (25567 + 2))*86400*1000); dateStr = d.toISOString().split('T')[0]; }

            document.getElementById('modal-news-date').innerText = dateStr;
            document.getElementById('modal-news-title').innerText = item.Title;
            // If using filter, badge helps context
            const typeBadge = item.Type ? `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mb-2">${item.Type}</span><br>` : '';
            document.getElementById('modal-news-content').innerHTML = typeBadge + (item.Content || "無詳細內容");
            
            // Ensure All News modal is hidden if opening from there? 
            // Or just open on top (z-index handles it). Current Z-index: all-news 100, news-modal 100. 
            // To be safe, let's increase news-modal z-index or assume browser handles stacking order (latest on top).
            // Let's force news-modal higher z-index via style if needed, but standard stacking usually works.
            // Actually, let's close 'all-news-modal' if it's open, or keep it? Keeping it is better UX for "back".
            // Since we used same class .modal, z-index is same. The one opened later is on top.
            
            toggleModal('news-modal');
        };

        function toggleModal(id) {
            const m = document.getElementById(id); 
            m.classList.toggle('opacity-0'); 
            m.classList.toggle('pointer-events-none'); 
            // Only toggle body class if opening/closing the *last* modal to avoid scroll issues
            // Simplification: just toggle.
            document.querySelector('body').classList.toggle('modal-active');
        }
        // ... keydown & scroll ...
        document.onkeydown = function(evt) { if((evt.key==="Escape"||evt.keyCode===27)) document.querySelectorAll('.modal:not(.opacity-0)').forEach(m=>toggleModal(m.id)); };
        window.addEventListener('scroll', () => { 
            const h=document.getElementById('sticky-header'); 
            const b=document.getElementById('preview-banner');
            let offset = 0; if (b && !b.classList.contains('hidden')) offset = b.offsetHeight;
            if(window.scrollY>200){ h.classList.remove('-translate-y-full','opacity-0'); h.classList.add('translate-y-0','opacity-100'); h.style.top = offset + 'px'; } 
            else { h.classList.add('-translate-y-full','opacity-0'); h.classList.remove('translate-y-0','opacity-100'); }
        });
    </script>
</body>
</html>
