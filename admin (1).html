<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶²ç«™ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { thuBlue: '#002E5D', thuGold: '#C6A87C' } }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-thuBlue z-[9999] flex flex-col items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-8 text-center relative">
             <button onclick="toggleHelp()" class="absolute top-5 right-5 text-gray-400 hover:text-thuBlue transition" title="å¦‚ä½•è¨­å®š?"><i class="fas fa-question-circle text-xl"></i></button>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">ç®¡ç†å“¡ç™»å…¥</h2>
            <p class="text-sm text-gray-500 mb-6">è«‹è¼¸å…¥ GitHub é€£ç·šè³‡è¨Š</p>
            <div class="space-y-3 text-left">
                <input type="text" id="gh-owner" class="w-full p-3 border rounded bg-gray-50" placeholder="GitHub å¸³è™Ÿ (Owner)">
                <input type="text" id="gh-repo" class="w-full p-3 border rounded bg-gray-50" placeholder="å°ˆæ¡ˆåç¨± (Repo)">
                <input type="password" id="gh-token" class="w-full p-3 border rounded bg-gray-50" placeholder="GitHub Token">
                <button onclick="login()" class="w-full bg-thuGold text-white font-bold py-3 rounded hover:bg-yellow-600 transition">ç™»å…¥ç³»çµ±</button>
            </div>
             <div id="login-help" class="hidden mt-6 text-left text-xs text-gray-600 bg-blue-50 p-4 rounded-lg border border-blue-100">
                <h4 class="font-bold text-thuBlue mb-2 text-sm"><i class="fas fa-info-circle mr-1"></i> å¦‚ä½•å–å¾—é‡‘é‘°?</h4>
                <ol class="list-decimal list-inside space-y-1.5">
                    <li>GitHub > Settings > Developer settings</li>
                    <li>Personal access tokens > Fine-grained tokens</li>
                    <li>Generate new token (æ¬Šé™é¸ Contents: Read and write)</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden max-w-7xl mx-auto p-6">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-8 bg-white p-5 rounded-xl shadow-sm sticky top-0 z-40 border-b border-gray-100">
            <h1 class="text-2xl font-bold text-thuBlue flex items-center gap-2"><i class="fas fa-cogs"></i> ç¶²ç«™å…§å®¹ç®¡ç†</h1>
            <div class="flex gap-3">
                <button onclick="saveToGitHub()" id="btn-save" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow flex items-center gap-2 transition transform active:scale-95">
                    <i class="fas fa-cloud-upload-alt"></i> å„²å­˜ç™¼å¸ƒ
                </button>
                <button onclick="logout()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg font-bold transition">ç™»å‡º</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-2 mb-6 border-b border-gray-200 overflow-x-auto">
            <button onclick="switchTab('home')" id="tab-home" class="px-6 py-3 font-bold text-thuBlue border-b-4 border-thuBlue bg-white rounded-t-lg transition whitespace-nowrap">é¦–é å¡ç‰‡</button>
            <button onclick="switchTab('pages')" id="tab-pages" class="px-6 py-3 font-bold text-gray-500 hover:text-thuBlue transition whitespace-nowrap">åˆ†é å…§å®¹</button>
            <button onclick="switchTab('news')" id="tab-news" class="px-6 py-3 font-bold text-gray-500 hover:text-thuBlue transition whitespace-nowrap">æœ€æ–°æ¶ˆæ¯</button>
        </div>

        <!-- 1. é¦–é å¡ç‰‡ç®¡ç† -->
        <div id="view-home" class="view-section">
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-500"><i class="fas fa-info-circle mr-1"></i> è«‹ç·¨è¼¯é¦–é çš„åŠŸèƒ½æ–¹å¡Šï¼Œå¯è‡ªç”±æ‹–æ›³æ’åºæˆ–å¢æ¸›ã€‚</p>
                <button onclick="addCard()" class="bg-blue-50 text-blue-600 hover:bg-blue-100 px-4 py-2 rounded-lg font-bold transition flex items-center gap-2 shadow-sm border border-blue-100">
                    <i class="fas fa-plus-circle"></i> æ–°å¢å¡ç‰‡
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5" id="cards-editor">
                <!-- JS ç”Ÿæˆå¡ç‰‡ç·¨è¼¯å™¨ -->
            </div>
        </div>

        <!-- 2. åˆ†é å…§å®¹ç®¡ç† -->
        <div id="view-pages" class="view-section hidden">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="bg-white p-4 rounded-xl shadow-sm h-fit border border-gray-100">
                    <h3 class="font-bold text-gray-700 mb-3 px-2">é¸æ“‡é é¢</h3>
                    <ul id="page-list" class="space-y-1"></ul>
                </div>
                <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex justify-between mb-6 border-b pb-4 items-center">
                        <div>
                            <h3 class="font-bold text-xl text-thuBlue" id="current-page-name">è«‹é¸æ“‡å·¦å´é é¢</h3>
                            <p class="text-xs text-gray-400 mt-1" id="current-page-desc"></p>
                        </div>
                        <button onclick="addItem()" class="text-sm bg-blue-50 text-blue-600 px-4 py-2 rounded-lg hover:bg-blue-100 font-bold transition shadow-sm">+ æ–°å¢é€£çµé …ç›®</button>
                    </div>
                    <div id="items-editor" class="space-y-3">
                        <p class="text-gray-400 text-center py-20 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">ğŸ‘ˆ è«‹å¾å·¦å´é¸æ“‡è¦ç·¨è¼¯çš„é é¢</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. æœ€æ–°æ¶ˆæ¯ç®¡ç† -->
        <div id="view-news" class="view-section hidden">
             <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg text-gray-800">JSON ç·¨è¼¯å™¨</h3>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded font-mono">news.json</span>
                </div>
                <textarea id="news-json-editor" class="w-full h-[500px] font-mono text-sm p-4 border rounded bg-gray-50 focus:ring-2 focus:ring-thuBlue outline-none resize-y leading-relaxed"></textarea>
                <p class="text-xs text-gray-400 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i> æ­¤è™•ç›´æ¥ç·¨è¼¯è³‡æ–™åº«çµæ§‹ï¼Œè«‹å°å¿ƒç¬¦è™Ÿæ ¼å¼ã€‚</p>
            </div>
        </div>

    </div>

    <script>
        let fullData = null;
        let currentSha = null;
        let currentPageId = null;
        
        function toggleHelp() { document.getElementById('login-help').classList.toggle('hidden'); }
        
        async function login() {
            const owner = document.getElementById('gh-owner').value.trim();
            const repo = document.getElementById('gh-repo').value.trim();
            const token = document.getElementById('gh-token').value.trim();
            if(!owner || !repo || !token) return alert("è«‹å¡«å¯«å®Œæ•´");

            try {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/site_data.json?t=${Date.now()}`;
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                if(!res.ok) throw new Error("é€£ç·šå¤±æ•—");
                const data = await res.json();
                currentSha = data.sha;
                // Handle UTF-8 decoding correctly
                fullData = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0))));

                localStorage.setItem('gh_config', JSON.stringify({ owner, repo, token }));
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                renderAll();
            } catch (e) { alert("éŒ¯èª¤: " + e.message); }
        }

        const savedConfig = JSON.parse(localStorage.getItem('gh_config'));
        if(savedConfig) {
            document.getElementById('gh-owner').value = savedConfig.owner;
            document.getElementById('gh-repo').value = savedConfig.repo;
            document.getElementById('gh-token').value = savedConfig.token;
        }

        function logout() {
            if(confirm("ç¢ºå®šç™»å‡º?")) { localStorage.removeItem('gh_config'); location.reload(); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
            ['home', 'pages', 'news'].forEach(t => {
                const btn = document.getElementById('tab-' + t);
                btn.className = (t === tab) ? 
                    "px-6 py-3 font-bold text-thuBlue border-b-4 border-thuBlue bg-white rounded-t-lg transition whitespace-nowrap shadow-sm" : 
                    "px-6 py-3 font-bold text-gray-500 hover:text-thuBlue transition whitespace-nowrap";
            });
        }

        function renderAll() {
            renderHomeCards();
            renderPageList();
            document.getElementById('news-json-editor').value = JSON.stringify(fullData.news || [], null, 4);
        }

        // --- Home Cards ---
        function renderHomeCards() {
            const container = document.getElementById('cards-editor');
            container.innerHTML = '';
            if(!fullData.homeCards) fullData.homeCards = [];
            
            fullData.homeCards.forEach((card, index) => {
                container.innerHTML += `
                <div class="border border-gray-200 rounded-xl p-5 bg-white shadow-sm hover:shadow-md transition relative group">
                    <div class="absolute top-3 right-3 flex gap-2">
                        <button onclick="deleteCard(${index})" class="text-gray-300 hover:text-red-500 transition p-1" title="åˆªé™¤"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="bg-gray-100 text-gray-500 text-xs font-bold px-2 py-1 rounded">#${index+1}</span>
                    </div>
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 gap-3">
                            <div class="col-span-2">
                                <label class="block text-xs font-bold text-gray-400 mb-1">æ¨™é¡Œ (Title)</label>
                                <input type="text" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-thuBlue outline-none transition" value="${card.title || ''}" onchange="updateCard(${index}, 'title', this.value)">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold text-gray-400 mb-1">æ¨™ç±¤ (Badge)</label>
                                <input type="text" class="w-full p-2 border rounded text-sm text-center text-red-500 font-bold focus:ring-2 focus:ring-thuBlue outline-none transition" value="${card.badge || ''}" onchange="updateCard(${index}, 'badge', this.value)" placeholder="é¸å¡«">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">æè¿° (Desc)</label>
                            <textarea class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-thuBlue outline-none resize-none transition" rows="2" onchange="updateCard(${index}, 'desc', this.value)">${card.desc || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-bold text-gray-400 mb-1">åœ–ç¤º (Icon)</label>
                                <div class="relative">
                                    <i class="fas ${card.icon} absolute left-3 top-2.5 text-gray-400"></i>
                                    <input type="text" class="w-full pl-9 p-2 border rounded text-sm font-mono focus:ring-2 focus:ring-thuBlue outline-none transition" value="${card.icon || ''}" onchange="updateCard(${index}, 'icon', this.value)">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-400 mb-1">é¡è‰² (Type)</label>
                                <select class="w-full p-2 border rounded text-sm bg-white focus:ring-2 focus:ring-thuBlue outline-none transition cursor-pointer" onchange="updateCard(${index}, 'type', this.value)">
                                    ${generateColorOptions(card.type)}
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">é€£çµ (Link)</label>
                            <input type="text" class="w-full p-2 border rounded text-sm text-blue-600 focus:ring-2 focus:ring-thuBlue outline-none transition" value="${card.link || ''}" onchange="updateCard(${index}, 'link', this.value)">
                        </div>
                    </div>
                </div>`;
            });
        }

        function generateColorOptions(selected) {
            const colors = [
                {v:'blue', n:'æ¨™æº–è—'}, {v:'gold', n:'å·¥å…·é‡‘'}, {v:'thu', n:'æ±æµ·è—'}, 
                {v:'red', n:'è­¦ç¤ºç´…'}, {v:'green', n:'æˆåŠŸç¶ '}, {v:'purple', n:'ç´«è‰²'}, 
                {v:'orange', n:'æ©˜è‰²'}, {v:'teal', n:'è—ç¶ '}, {v:'rose', n:'ç«ç‘°ç´…'}, {v:'slate', n:'ç°å²©'}
            ];
            return colors.map(c => `<option value="${c.v}" ${selected === c.v ? 'selected' : ''}>${c.n}</option>`).join('');
        }
        
        window.updateCard = (i, f, v) => { fullData.homeCards[i][f] = v; };
        window.addCard = () => {
            fullData.homeCards.push({ title: "æ–°å¡ç‰‡", desc: "è«‹è¼¸å…¥æè¿°", link: "#", icon: "fa-star", badge: "", type: "blue" });
            renderHomeCards();
        };
        window.deleteCard = (i) => { if(confirm("åˆªé™¤æ­¤å¡ç‰‡?")) { fullData.homeCards.splice(i, 1); renderHomeCards(); } };

        // --- Pages ---
        function renderPageList() {
            const list = document.getElementById('page-list'); list.innerHTML = '';
            if(!fullData.pages) fullData.pages = {};
            Object.keys(fullData.pages).forEach(key => {
                const page = fullData.pages[key];
                const active = (currentPageId === key) ? 'bg-thuBlue text-white shadow-md transform scale-105' : 'hover:bg-blue-50 text-gray-700';
                list.innerHTML += `<li><button onclick="selectPage('${key}')" class="w-full text-left px-4 py-3 rounded-lg font-medium transition duration-200 ${active}">${page.title}</button></li>`;
            });
        }
        window.selectPage = (id) => { currentPageId = id; renderPageList(); document.getElementById('current-page-name').innerText = fullData.pages[id].title; document.getElementById('current-page-desc').innerText = fullData.pages[id].subtitle || ""; renderPageItems(); }
        function renderPageItems() {
            const container = document.getElementById('items-editor'); container.innerHTML = '';
            const items = fullData.pages[currentPageId].items || [];
            if(items.length === 0) container.innerHTML = '<div class="text-center text-gray-400 py-10 border-2 border-dashed border-gray-200 rounded-xl bg-gray-50">æ­¤é é¢å°šç„¡å…§å®¹ï¼Œè«‹é»æ“Šå³ä¸Šè§’æ–°å¢</div>';
            
            items.forEach((item, index) => {
                container.innerHTML += `
                <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-center bg-white p-4 rounded-lg border border-gray-200 shadow-sm hover:shadow-md transition group">
                    <div class="flex items-center gap-2 w-full sm:w-auto">
                        <span class="text-xs text-gray-400 font-mono w-6 text-center">${index+1}</span>
                        <input type="text" class="w-24 p-2 border rounded text-sm text-center focus:ring-2 focus:ring-thuBlue outline-none" value="${item.tag || ''}" onchange="updateItem(${index}, 'tag', this.value)" placeholder="æ¨™ç±¤">
                    </div>
                    <div class="flex-1 w-full sm:w-auto space-y-2 sm:space-y-0 sm:flex sm:gap-3">
                        <input type="text" class="w-full p-2 border rounded text-sm font-bold focus:ring-2 focus:ring-thuBlue outline-none" value="${item.title}" onchange="updateItem(${index}, 'title', this.value)" placeholder="æ¨™é¡Œ">
                        <input type="text" class="w-full p-2 border rounded text-sm text-gray-500 focus:ring-2 focus:ring-thuBlue outline-none font-mono" value="${item.url}" onchange="updateItem(${index}, 'url', this.value)" placeholder="é€£çµ">
                    </div>
                    <button onclick="deleteItem(${index})" class="text-gray-300 hover:text-red-500 px-2 transition sm:self-center self-end"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            });
        }
        window.updateItem = (i, f, v) => { fullData.pages[currentPageId].items[i][f] = v; };
        window.addItem = () => { if(!currentPageId) return alert("è«‹å…ˆé¸æ“‡é é¢"); if(!fullData.pages[currentPageId].items) fullData.pages[currentPageId].items=[]; fullData.pages[currentPageId].items.push({ title: "æ–°é …ç›®", url: "#", tag: "New" }); renderPageItems(); };
        window.deleteItem = (i) => { if(confirm("åˆªé™¤?")) { fullData.pages[currentPageId].items.splice(i, 1); renderPageItems(); } };

        // 3. Save
        async function saveToGitHub() {
            try {
                fullData.news = JSON.parse(document.getElementById('news-json-editor').value);
            } catch(e) { return alert("æœ€æ–°æ¶ˆæ¯ JSON æ ¼å¼éŒ¯èª¤"); }

            const btn = document.getElementById('btn-save');
            const originalText = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';

            const { owner, repo, token } = JSON.parse(localStorage.getItem('gh_config'));
            // Use text encoder for proper UTF-8 base64
            const contentBase64 = btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(fullData, null, 2))));

            try {
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/site_data.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Update via Admin Panel", content: contentBase64, sha: currentSha })
                });
                if(res.ok) {
                    const data = await res.json(); currentSha = data.content.sha;
                    alert("âœ… ç™¼å¸ƒæˆåŠŸï¼è«‹ç­‰å¾…ç´„ 1 åˆ†é˜è®“ GitHub Pages æ›´æ–°ã€‚");
                } else throw new Error("API Error");
            } catch (e) { alert("âŒ å¤±æ•—: " + e.message); } 
            finally { btn.disabled = false; btn.innerHTML = originalText; }
        }
    </script>
</body>
</html>
